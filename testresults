==================================== ERRORS ====================================
_______ ERROR at setup of TestJobsIntegration.test_job_data_persistence ________

fixturedef = <FixtureDef argname='auth_headers' scope='function' baseid='tests'>
request = <SubRequest 'auth_headers' for <Coroutine test_job_data_persistence>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:321: in _async_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:317: in setup
    res = await fixture_function(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <httpx.AsyncClient object at 0x7288c1413c20>

    @pytest.fixture
    async def auth_headers(client) -> dict[str, str]:
        """
        Create authentication headers for testing protected endpoints.
    
        Args:
            client: The HTTP client for making requests
    
        Returns:
            Dictionary with Authorization header
        """
        import uuid
        import string
        import random
    
        # Generate a more username-friendly unique identifier
        # Use only lowercase letters and numbers, starting with a letter
        unique_base = str(uuid.uuid4()).replace('-', '')[:8]
        # Ensure it starts with a letter and only contains alphanumeric characters
        safe_id = 'user' + ''.join(c for c in unique_base if c.isalnum()).lower()
    
        user_data = {
            "username": safe_id,
            "email": f"{safe_id}@example.com",
            "password": "SecureP@ssw0rd!",
            "full_name": f"Test User {safe_id}",
        }
    
        response = await client.post("/api/v1/auth/register", json=user_data)
>       assert response.status_code == 201
E       assert 400 == 201
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/conftest.py:381: AssertionError
------------------------------ Captured log setup ------------------------------
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T16:45:42.631123Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35muser5fbb7012@example...[0m [36merror[0m=[35m400: Username format is invalid or contains prohibited patterns[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35muser5fbb7012[0m
_____________ ERROR at setup of TestJobsUnit.test_get_job_success ______________

fixturedef = <FixtureDef argname='auth_headers' scope='function' baseid='tests'>
request = <SubRequest 'auth_headers' for <Coroutine test_get_job_success>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:321: in _async_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:317: in setup
    res = await fixture_function(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <httpx.AsyncClient object at 0x7288aaab20c0>

    @pytest.fixture
    async def auth_headers(client) -> dict[str, str]:
        """
        Create authentication headers for testing protected endpoints.
    
        Args:
            client: The HTTP client for making requests
    
        Returns:
            Dictionary with Authorization header
        """
        import uuid
        import string
        import random
    
        # Generate a more username-friendly unique identifier
        # Use only lowercase letters and numbers, starting with a letter
        unique_base = str(uuid.uuid4()).replace('-', '')[:8]
        # Ensure it starts with a letter and only contains alphanumeric characters
        safe_id = 'user' + ''.join(c for c in unique_base if c.isalnum()).lower()
    
        user_data = {
            "username": safe_id,
            "email": f"{safe_id}@example.com",
            "password": "SecureP@ssw0rd!",
            "full_name": f"Test User {safe_id}",
        }
    
        response = await client.post("/api/v1/auth/register", json=user_data)
>       assert response.status_code == 201
E       assert 400 == 201
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/conftest.py:381: AssertionError
------------------------------ Captured log setup ------------------------------
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T16:45:57.959467Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35muser208d456e@example...[0m [36merror[0m=[35m400: Username format is invalid or contains prohibited patterns[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35muser208d456e[0m
=================================== FAILURES ===================================
___________ TestABTestingIntegration.test_ab_test_complete_lifecycle ___________

self = <tests.test_ab_testing_integration.TestABTestingIntegration object at 0x728b10c085c0>
client = <httpx.AsyncClient object at 0x72896b5c81a0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REJaWEE3MjlBRFJYRTQ4R0QyNEJNUCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMTF9.NZoe4gl1AoNA1CNnt_zsW2ysZCZziO2MldiLRL4Fr34'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x728968e406e0>

    @pytest.mark.integration
    async def test_ab_test_complete_lifecycle(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complete AB test lifecycle from creation to completion."""
        # Create test
        test_data = {
            "name": "Integration Test AB Test",
            "description": "Complete lifecycle test",
            "test_type": "prompt",
            "allocation_strategy": "equal",
            "variants": [
                {
                    "name": "control",
                    "description": "Control variant",
                    "configuration": {"param_a": "value1"},
                    "weight": 1.0
                },
                {
                    "name": "variant_a",
                    "description": "Test variant A",
                    "configuration": {"param_a": "value2"},
                    "weight": 1.0
                }
            ],
            "metrics": ["response_time", "user_satisfaction"],
            "duration_days": 7,
            "min_sample_size": 100,
            "confidence_level": 0.95,
            "traffic_percentage": 100.0
        }
    
>       create_response = await client.post("/api/v1/ab-tests/", json=test_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_integration.py:42: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-230' coro=<TestABTestingIntegration.test_ab_test_complete_lifecycle() running at /home/yam/chatter/tests/test_ab_testing_integration.py:42> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REJaWEE3MjlBRFJYRTQ4R0QyNEJNUCIsImVtYWlsIjoidXNlcjYzMmRiOTg5QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNjMyZGI5ODkiLCJqdGkiOiJmZGNmNjU1MC03NjYxLTQ4MDgtOTkxOS1kOWFmODIzODMxNTgiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDExLCJzZXNzaW9uX2lkIjoiMDNhMzEyYjUtYTYyMi00NWExLWJiMzMtNGM0NzJmNWIxYzEyIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMTF9.NZoe4gl1AoNA1CNnt_zsW2ysZCZziO2MldiLRL4Fr34
____________ TestABTestingIntegration.test_ab_test_list_and_filter _____________

self = <tests.test_ab_testing_integration.TestABTestingIntegration object at 0x728b10de7770>
client = <httpx.AsyncClient object at 0x728980f17410>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REJaWU5aU05ZVjFNUEdaNjVXOFZOUSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMTN9.VaTHpdk2GmrTteEWNXDM1pd1OqXdz6tdUEsBPIlNHZI'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72896b5c87a0>

    @pytest.mark.integration
    async def test_ab_test_list_and_filter(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test AB test listing and filtering functionality."""
        # Create multiple tests
        test_names = ["Test 1", "Test 2", "Test 3"]
        created_tests = []
    
        for name in test_names:
            test_data = {
                "name": name,
                "description": f"Description for {name}",
                "variants": [
                    {"name": "control", "allocation": 50},
                    {"name": "variant", "allocation": 50}
                ]
            }
    
>           response = await client.post("/api/v1/ab-tests/", json=test_data, headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_integration.py:95: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-243' coro=<TestABTestingIntegration.test_ab_test_list_and_filter() running at /home/yam/chatter/tests/test_ab_testing_integration.py:95> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REJaWU5aU05ZVjFNUEdaNjVXOFZOUSIsImVtYWlsIjoidXNlcmQ0OTQ2OWI0QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZDQ5NDY5YjQiLCJqdGkiOiI1ZDA4NzAxYy1hYzUxLTQ5YjMtODg0YS04NDE4ODU2NTQ1ZGYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDEzLCJzZXNzaW9uX2lkIjoiY2Q4YzUyNGMtYjczNS00MTgxLWI2NTAtYmE5MzVlNDRiNDU4IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMTN9.VaTHpdk2GmrTteEWNXDM1pd1OqXdz6tdUEsBPIlNHZI
____________ TestABTestingIntegration.test_ab_test_update_workflow _____________

self = <tests.test_ab_testing_integration.TestABTestingIntegration object at 0x728b10de6c60>
client = <httpx.AsyncClient object at 0x72896b513500>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REJaWlpBQTFaWFdXWlc4SzEyNlNLMyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMTR9.LB9Y_qbd5n5IAsPZVXOWHm6ZSF5kTguK9MTYfEOmVFM'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x728980f176e0>

    @pytest.mark.integration
    async def test_ab_test_update_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test AB test update functionality."""
        # Create test
        original_data = {
            "name": "Original Test Name",
            "description": "Original description",
            "variants": [
                {"name": "control", "allocation": 50},
                {"name": "variant_a", "allocation": 50}
            ]
        }
    
>       create_response = await client.post("/api/v1/ab-tests/", json=original_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_integration.py:130: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-256' coro=<TestABTestingIntegration.test_ab_test_update_workflow() running at /home/yam/chatter/tests/test_ab_testing_integration.py:130> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REJaWlpBQTFaWFdXWlc4SzEyNlNLMyIsImVtYWlsIjoidXNlcjA2MTM2M2ZlQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMDYxMzYzZmUiLCJqdGkiOiI5OThkZTU2OC0xZDQwLTQzMDAtYTU0MS1kZGJiNzczNGZiZjUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDE0LCJzZXNzaW9uX2lkIjoiMTRhY2QwMzgtYmY3NS00Yzg2LWJkZGEtZGVmNjRiYjlkNWI0IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMTR9.LB9Y_qbd5n5IAsPZVXOWHm6ZSF5kTguK9MTYfEOmVFM
________ TestABTestingIntegration.test_ab_test_metrics_and_performance _________

self = <tests.test_ab_testing_integration.TestABTestingIntegration object at 0x728b10c089e0>
client = <httpx.AsyncClient object at 0x728968c09fd0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwMU1FUENSOEVTUkM0NVRCRTJBQiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMTZ9.NShn39rutWxU_VRE1x3jjVBoaiO966I60VwAEtk4fHI'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72896a916390>

    @pytest.mark.integration
    async def test_ab_test_metrics_and_performance(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test AB test metrics and performance tracking."""
        # Create and start test
        test_data = {
            "name": "Metrics Test",
            "description": "Test for metrics tracking",
            "variants": [
                {"name": "control", "allocation": 50},
                {"name": "variant_a", "allocation": 50}
            ],
            "target_metric": "click_through_rate"
        }
    
>       create_response = await client.post("/api/v1/ab-tests/", json=test_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_integration.py:174: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-269' coro=<TestABTestingIntegration.test_ab_test_metrics_and_performance() running at /home/yam/chatter/tests/test_ab_testing_integration.py:174> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwMU1FUENSOEVTUkM0NVRCRTJBQiIsImVtYWlsIjoidXNlcmYwOTkxZDAxQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZjA5OTFkMDEiLCJqdGkiOiI5NGZlZjBhYS05MjFmLTQwMzctYjJlMy05YmIyOWMzOTVhZDkiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDE2LCJzZXNzaW9uX2lkIjoiYWNhMTJlODUtODhlZi00ZGJhLWJkYTUtNTg5ZDdiNjI0ZDI1IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMTZ9.NShn39rutWxU_VRE1x3jjVBoaiO966I60VwAEtk4fHI
____________ TestABTestingIntegration.test_ab_test_error_scenarios _____________

self = <tests.test_ab_testing_integration.TestABTestingIntegration object at 0x728b10c08ad0>
client = <httpx.AsyncClient object at 0x72895bd38a40>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwMlpGMTI0QjY0TVhGOVk4UkQ4ViIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMTd9.oE23PbTWxVeTh5ue-eMDXG8ASxu7pHUD9ueXN_xCnNA'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72895b25b500>

    @pytest.mark.integration
    async def test_ab_test_error_scenarios(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test AB test error handling scenarios."""
        # Test non-existent test operations
        nonexistent_id = "nonexistent-test-id"
    
        operations = [
            ("GET", f"/api/v1/ab-tests/{nonexistent_id}"),
            ("PUT", f"/api/v1/ab-tests/{nonexistent_id}"),
            ("DELETE", f"/api/v1/ab-tests/{nonexistent_id}"),
            ("POST", f"/api/v1/ab-tests/{nonexistent_id}/start"),
            ("POST", f"/api/v1/ab-tests/{nonexistent_id}/pause"),
            ("POST", f"/api/v1/ab-tests/{nonexistent_id}/complete"),
            ("GET", f"/api/v1/ab-tests/{nonexistent_id}/results"),
            ("GET", f"/api/v1/ab-tests/{nonexistent_id}/metrics"),
        ]
    
        for method, url in operations:
            if method == "GET":
>               response = await client.get(url, headers=auth_headers)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_integration.py:226: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-282' coro=<TestABTestingIntegration.test_ab_test_error_scenarios() running at /home/yam/chatter/tests/test_ab_testing_integration.py:226> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwMlpGMTI0QjY0TVhGOVk4UkQ4ViIsImVtYWlsIjoidXNlcmNkNjM5ZWE5QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyY2Q2MzllYTkiLCJqdGkiOiIxYWYzMmI5MS0wY2I5LTRjYmMtODM1Ni04Mjc0NzIzNzk2YWYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDE3LCJzZXNzaW9uX2lkIjoiZWMzOTc2ZTMtOTgyMS00ZDNlLTk4ZmItZDYxMTgwMjk0NDM0IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMTd9.oE23PbTWxVeTh5ue-eMDXG8ASxu7pHUD9ueXN_xCnNA
____________ TestABTestingIntegration.test_ab_test_state_validation ____________

self = <tests.test_ab_testing_integration.TestABTestingIntegration object at 0x728b10c08e90>
client = <httpx.AsyncClient object at 0x728968907380>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwNE1IOUJRRDBXV0RGMVRQSjhESiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMTl9.foIgyLdUsG2wyg8awSV7KO5q_1KhoPPd_PXbAmJB2cc'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72895bd5f110>

    @pytest.mark.integration
    async def test_ab_test_state_validation(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test AB test state transition validation."""
        # Create test
        test_data = {
            "name": "State Validation Test",
            "description": "Test state transitions",
            "variants": [
                {"name": "control", "allocation": 50},
                {"name": "variant_a", "allocation": 50}
            ]
        }
    
>       create_response = await client.post("/api/v1/ab-tests/", json=test_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_integration.py:249: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-295' coro=<TestABTestingIntegration.test_ab_test_state_validation() running at /home/yam/chatter/tests/test_ab_testing_integration.py:249> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwNE1IOUJRRDBXV0RGMVRQSjhESiIsImVtYWlsIjoidXNlcjg5ZjcyZDI4QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyODlmNzJkMjgiLCJqdGkiOiI3ZGI5MWY3Mi1jODQ1LTRiM2EtYmRjZC0xN2ZlYzYwZTE5MDUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDE5LCJzZXNzaW9uX2lkIjoiOWM5MzRhYzEtNzQ4NC00YjM0LWE4ZDktYWUxODIxNGEzY2Y2IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMTl9.foIgyLdUsG2wyg8awSV7KO5q_1KhoPPd_PXbAmJB2cc
_________ TestABTestingIntegration.test_ab_test_concurrent_operations __________

self = <tests.test_ab_testing_integration.TestABTestingIntegration object at 0x728b10c09250>
client = <httpx.AsyncClient object at 0x72895b189be0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwNlRGR1NFTTBIVzNBQ1pUVDk2USIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMjF9.Pwtc42FMXOQAx_fh-cgo_m8LeYAQzxDYWQ4stw3j7-4'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7289688d6600>

    @pytest.mark.integration
    async def test_ab_test_concurrent_operations(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test concurrent AB test operations."""
        # Create multiple tests concurrently
        test_data_list = [
            {
                "name": f"Concurrent Test {i}",
                "description": f"Concurrent test {i}",
                "variants": [
                    {"name": "control", "allocation": 50},
                    {"name": "variant", "allocation": 50}
                ]
            }
            for i in range(5)
        ]
    
        # Create tasks for concurrent test creation
        create_tasks = [
            asyncio.create_task(client.post("/api/v1/ab-tests/", json=test_data, headers=auth_headers))
            for test_data in test_data_list
        ]
    
        # Wait for all creations
>       create_responses = await asyncio.gather(*create_tasks)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_integration.py:301: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-309' coro=<AsyncClient.post() running at /home/yam/.local/lib/python3.12/site-packages/httpx/_client.py:1859> cb=[gather.<locals>._done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:767]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwNlRGR1NFTTBIVzNBQ1pUVDk2USIsImVtYWlsIjoidXNlcjU3MmM1OTVlQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNTcyYzU5NWUiLCJqdGkiOiJmNjRiYmFlMS1mM2FiLTQxNDktYjkwYS05ZWM4MGU1OWY2OWMiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDIxLCJzZXNzaW9uX2lkIjoiYzBkODIzMmItM2Y1OC00MzRlLWE3YTUtM2U3MTFlNWU1ZTcxIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMjF9.Pwtc42FMXOQAx_fh-cgo_m8LeYAQzxDYWQ4stw3j7-4
____________ TestABTestingIntegration.test_ab_test_data_persistence ____________

self = <tests.test_ab_testing_integration.TestABTestingIntegration object at 0x728b10c09610>
client = <httpx.AsyncClient object at 0x72895b741a60>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwODhGSE1WOVY4NlBYMVlRREdFMSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMjN9.mJdzMUOwpXlNX83QU9GVqSOpW0E0EI21-r4c7thjbCw'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72895b1f7980>

    @pytest.mark.integration
    async def test_ab_test_data_persistence(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test AB test data persistence across operations."""
        # Create test with specific data
        original_test_data = {
            "name": "Persistence Test",
            "description": "Testing data persistence",
            "variants": [
                {"name": "control", "allocation": 40},
                {"name": "variant_a", "allocation": 30},
                {"name": "variant_b", "allocation": 30}
            ],
            "target_metric": "conversion_rate",
            "success_criteria": {
                "min_improvement": 15.0,
                "confidence_level": 95.0
            },
            "metadata": {
                "experiment_type": "feature_flag",
                "team": "product",
                "priority": "high"
            }
        }
    
        # Create test
>       create_response = await client.post("/api/v1/ab-tests/", json=original_test_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_integration.py:359: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-326' coro=<TestABTestingIntegration.test_ab_test_data_persistence() running at /home/yam/chatter/tests/test_ab_testing_integration.py:359> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwODhGSE1WOVY4NlBYMVlRREdFMSIsImVtYWlsIjoidXNlcjkxNjM4NjU4QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOTE2Mzg2NTgiLCJqdGkiOiJkN2VmNjUyMS1hZGIxLTRjYjMtODBiNi1iZjBjNDIxYzQxMWUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDIzLCJzZXNzaW9uX2lkIjoiOTUyN2M5ZWYtNTFjMS00ODM2LTlkYzYtNmYwYzMxYWRkNDJhIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMjN9.mJdzMUOwpXlNX83QU9GVqSOpW0E0EI21-r4c7thjbCw
_____________ TestABTestingUnit.test_create_ab_test_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895b8bd2e0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895b8bd2e0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac7615160>
client = <httpx.AsyncClient object at 0x72895b8bc590>

    @pytest.mark.unit
    async def test_create_ab_test_requires_auth(self, client: AsyncClient):
        """Test that creating AB test requires authentication."""
        test_data = {
            "name": "Test AB Test",
            "description": "Test description",
            "variants": [
                {"name": "control", "allocation": 50},
                {"name": "variant_a", "allocation": 50}
            ]
        }
    
>       response = await client.post("/api/v1/ab-tests/", json=test_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:25: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895b8bd2e0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:40:24.629485Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m61266a39-b4aa-470f-b478-43368f471496[0m [36mstatus_code[0m=[35m401[0m
______________ TestABTestingUnit.test_list_ab_tests_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895ab27f80>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895ab27f80>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac76147d0>
client = <httpx.AsyncClient object at 0x72895ab27230>

    @pytest.mark.unit
    async def test_list_ab_tests_requires_auth(self, client: AsyncClient):
        """Test that listing AB tests requires authentication."""
>       response = await client.get("/api/v1/ab-tests/")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:31: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895ab27f80>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:40:25.617389Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m6b47bea9-74ba-4598-ae87-5c469f2885b9[0m [36mstatus_code[0m=[35m401[0m
_______________ TestABTestingUnit.test_get_ab_test_requires_auth _______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728969fa6480>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728969fa6480>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac7614b90>
client = <httpx.AsyncClient object at 0x728969fa56a0>

    @pytest.mark.unit
    async def test_get_ab_test_requires_auth(self, client: AsyncClient):
        """Test that getting specific AB test requires authentication."""
>       response = await client.get("/api/v1/ab-tests/test-id")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:37: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728969fa6480>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:40:26.579808Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m24b75d27-5c67-4d16-9962-96f729190573[0m [36mstatus_code[0m=[35m401[0m
_____________ TestABTestingUnit.test_update_ab_test_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728968331d30>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728968331d30>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac7614fe0>
client = <httpx.AsyncClient object at 0x728968330fb0>

    @pytest.mark.unit
    async def test_update_ab_test_requires_auth(self, client: AsyncClient):
        """Test that updating AB test requires authentication."""
>       response = await client.put("/api/v1/ab-tests/test-id", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:43: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1896: in put
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728968331d30>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:40:27.508939Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m911d3926-094a-4650-9f87-0fbdee6928bf[0m [36mstatus_code[0m=[35m401[0m
_____________ TestABTestingUnit.test_delete_ab_test_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289686409e0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289686409e0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac76153d0>
client = <httpx.AsyncClient object at 0x7289686b3e30>

    @pytest.mark.unit
    async def test_delete_ab_test_requires_auth(self, client: AsyncClient):
        """Test that deleting AB test requires authentication."""
>       response = await client.delete("/api/v1/ab-tests/test-id")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:49: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1966: in delete
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289686409e0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:40:28.380564Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m3f2e188f-3900-4e99-aa21-01a0ce228c8d[0m [36mstatus_code[0m=[35m401[0m
______________ TestABTestingUnit.test_start_ab_test_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895b61fa10>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895b61fa10>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac76157c0>
client = <httpx.AsyncClient object at 0x72895b61ed80>

    @pytest.mark.unit
    async def test_start_ab_test_requires_auth(self, client: AsyncClient):
        """Test that starting AB test requires authentication."""
>       response = await client.post("/api/v1/ab-tests/test-id/start")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:55: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895b61fa10>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:40:29.283969Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m8e7715ca-fa2a-47a5-a915-e8d3a46dd0a9[0m [36mstatus_code[0m=[35m401[0m
______________ TestABTestingUnit.test_pause_ab_test_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895a760c80>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895a760c80>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac7615b80>
client = <httpx.AsyncClient object at 0x72895a761160>

    @pytest.mark.unit
    async def test_pause_ab_test_requires_auth(self, client: AsyncClient):
        """Test that pausing AB test requires authentication."""
>       response = await client.post("/api/v1/ab-tests/test-id/pause")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:61: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895a760c80>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:40:30.520532Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m45167fb5-91a3-4c40-ac41-496456287185[0m [36mstatus_code[0m=[35m401[0m
____________ TestABTestingUnit.test_complete_ab_test_requires_auth _____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728969fa4860>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728969fa4860>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac7615f40>
client = <httpx.AsyncClient object at 0x728969fa71d0>

    @pytest.mark.unit
    async def test_complete_ab_test_requires_auth(self, client: AsyncClient):
        """Test that completing AB test requires authentication."""
>       response = await client.post("/api/v1/ab-tests/test-id/complete")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:67: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728969fa4860>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:40:31.444059Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mea17cf08-552a-40b3-8ace-fe0f616e744b[0m [36mstatus_code[0m=[35m401[0m
_______________ TestABTestingUnit.test_get_results_requires_auth _______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728969fe3d10>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728969fe3d10>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac7616300>
client = <httpx.AsyncClient object at 0x728969fe3170>

    @pytest.mark.unit
    async def test_get_results_requires_auth(self, client: AsyncClient):
        """Test that getting results requires authentication."""
>       response = await client.get("/api/v1/ab-tests/test-id/results")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:73: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728969fe3d10>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:40:32.332400Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m29ddaceb-f23e-4678-b86b-14ce90ea186f[0m [36mstatus_code[0m=[35m401[0m
_______________ TestABTestingUnit.test_get_metrics_requires_auth _______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895a572a50>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895a572a50>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac76166c0>
client = <httpx.AsyncClient object at 0x72895a571e20>

    @pytest.mark.unit
    async def test_get_metrics_requires_auth(self, client: AsyncClient):
        """Test that getting metrics requires authentication."""
>       response = await client.get("/api/v1/ab-tests/test-id/metrics")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:79: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895a572a50>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:40:33.173114Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mb43ee3fc-9987-48e0-ac6b-0ad32407c3a8[0m [36mstatus_code[0m=[35m401[0m
________________ TestABTestingUnit.test_create_ab_test_success _________________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac7616a80>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='125934489692992'>
client = <httpx.AsyncClient object at 0x72895a624b30>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwSzRKUDlDRFRSNUJGMTZLR0ZCQSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMzR9.PjBiN-aQ_0AZdOf5XBr0hGr7kxQkSOHEuXFgQzv63qY'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_create_ab_test_success(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test successful AB test creation."""
        # Mock the manager
        mock_manager = AsyncMock()
    
        from chatter.schemas.ab_testing import TestVariant
        from chatter.services.ab_testing import TestType, VariantAllocation, MetricType
        from datetime import datetime, UTC
    
        # Create proper test variants
        test_variants = [
            TestVariant(
                name="control",
                description="Control variant",
                configuration={},
                weight=1.0
            ),
            TestVariant(
                name="variant_a",
                description="Variant A",
                configuration={},
                weight=1.0
            )
        ]
    
        mock_manager.create_test.return_value = ABTestResponse(
            id="test-123",
            name="Test AB Test",
            description="Test description",
            test_type=TestType.PROMPT,
            status=TestStatus.DRAFT,
            allocation_strategy=VariantAllocation.EQUAL,
            variants=test_variants,
            metrics=[MetricType.CUSTOM],
            duration_days=30,
            min_sample_size=100,
            confidence_level=0.95,
            traffic_percentage=100.0,
            tags=[],
            metadata={},
            created_by="testuser",
            created_at=datetime.now(UTC),
            updated_at=datetime.now(UTC)
        )
        mock_get_manager.return_value = mock_manager
    
        test_data = {
            "name": "Test AB Test",
            "description": "Test description",
            "variants": [
                {"name": "control", "allocation": 50},
                {"name": "variant_a", "allocation": 50}
            ]
        }
    
>       response = await client.post("/api/v1/ab-tests/", json=test_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:139: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-459' coro=<TestABTestingUnit.test_create_ab_test_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwSzRKUDlDRFRSNUJGMTZLR0ZCQSIsImVtYWlsIjoidXNlcmZmMjA0ZDNlQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZmYyMDRkM2UiLCJqdGkiOiIzODZiZjM4NS0wYmVhLTRhZjAtODBiOC04YzhjYTJhOTFlNDUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDM0LCJzZXNzaW9uX2lkIjoiN2YxNjI1NWEtMDM1Yy00YjZiLTkzY2MtNTE0MTkyYWQxNjY2IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMzR9.PjBiN-aQ_0AZdOf5XBr0hGr7kxQkSOHEuXFgQzv63qY
______________ TestABTestingUnit.test_create_ab_test_invalid_data ______________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac7616e70>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='125934483335184'>
client = <httpx.AsyncClient object at 0x72896824eb10>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwTVQ3TkhaOUdaQzFLQkJDU1ZOUiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMzV9.OpaXc0vamrwv_G0yoNl74dNbPOXPEEG8D7Ro943__1k'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_create_ab_test_invalid_data(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test AB test creation with invalid data."""
        # Missing required fields
        test_data = {
            "name": "Test AB Test"
            # Missing description and variants
        }
    
>       response = await client.post("/api/v1/ab-tests/", json=test_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-472' coro=<TestABTestingUnit.test_create_ab_test_invalid_data() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwTVQ3TkhaOUdaQzFLQkJDU1ZOUiIsImVtYWlsIjoidXNlcjY1MDkwYzhkQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNjUwOTBjOGQiLCJqdGkiOiI2NjY4YTJlOS1jNzEwLTRiOWEtOTk3NS1jMzAzZWMxYThmNWQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDM1LCJzZXNzaW9uX2lkIjoiZDkzNjJhNzMtZjEyNC00MmM2LWFiMjEtYTRjZTY2NDNhMDMzIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMzV9.OpaXc0vamrwv_G0yoNl74dNbPOXPEEG8D7Ro943__1k
___________ TestABTestingUnit.test_create_ab_test_invalid_allocation ___________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac7617230>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='125934253514896'>
client = <httpx.AsyncClient object at 0x72895a720d70>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwUDRNQjI3VjlGRzc0QjVOODhWQyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMzd9.vP0IjcFbCd3NHrOCIuUAcXwSpnzatrrOlTPMPpbGKwI'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_create_ab_test_invalid_allocation(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test AB test creation with invalid allocation percentages."""
        test_data = {
            "name": "Test AB Test",
            "description": "Test description",
            "variants": [
                {"name": "control", "allocation": 60},
                {"name": "variant_a", "allocation": 50}  # Total = 110%
            ]
        }
    
        # Mock manager to raise validation error
        mock_manager = AsyncMock()
        mock_manager.create_test.side_effect = ValueError("Invalid allocation percentages")
        mock_get_manager.return_value = mock_manager
    
>       response = await client.post("/api/v1/ab-tests/", json=test_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:178: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-485' coro=<TestABTestingUnit.test_create_ab_test_invalid_allocation() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwUDRNQjI3VjlGRzc0QjVOODhWQyIsImVtYWlsIjoidXNlcmI1MTJhYjA4QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYjUxMmFiMDgiLCJqdGkiOiI3ZmI3MTkzMy1jZTBiLTRkYjktYWNmYy1iOGRkYTM1YzhmMmIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDM3LCJzZXNzaW9uX2lkIjoiODI4ZDRkNmEtODFkZi00YTc4LWI2YzEtNzI0MmViNmFhYzlmIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMzd9.vP0IjcFbCd3NHrOCIuUAcXwSpnzatrrOlTPMPpbGKwI
_________________ TestABTestingUnit.test_list_ab_tests_success _________________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac76175f0>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='125934516051920'>
client = <httpx.AsyncClient object at 0x72896a180740>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwUUYyWDNLWE5ZRTBQRzIzMDVDMSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMzh9.8zpeXt9rnr7jsjG-Wy1o0jvrl3vjTspxAQiyVBydiC8'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_list_ab_tests_success(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test successful AB test listing."""
        mock_manager = AsyncMock()
        mock_manager.list_tests.return_value = {
            "tests": [
                {
                    "id": "test-1",
                    "name": "Test 1",
                    "status": "running",
                    "created_at": "2024-01-01T12:00:00Z"
                },
                {
                    "id": "test-2",
                    "name": "Test 2",
                    "status": "draft",
                    "created_at": "2024-01-01T13:00:00Z"
                }
            ],
            "total": 2,
            "page": 1,
            "per_page": 10
        }
        mock_get_manager.return_value = mock_manager
    
>       response = await client.get("/api/v1/ab-tests/", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:207: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-498' coro=<TestABTestingUnit.test_list_ab_tests_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwUUYyWDNLWE5ZRTBQRzIzMDVDMSIsImVtYWlsIjoidXNlcjIyMDU4M2RhQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMjIwNTgzZGEiLCJqdGkiOiI4ZjM1NmRiYi1hMzQ4LTQzNWUtYTkzMS1hMTc0NGZjOTA5OWMiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDM4LCJzZXNzaW9uX2lkIjoiMzBlZDNkNTAtMGU2My00ODU4LTkwMjQtMzMwYmJmNWFhNmIwIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyMzh9.8zpeXt9rnr7jsjG-Wy1o0jvrl3vjTspxAQiyVBydiC8
__________________ TestABTestingUnit.test_get_ab_test_success __________________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac7616b70>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='125934516445376'>
client = <httpx.AsyncClient object at 0x72896a26d430>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwUzlHUk0yS0M1UFZCMFIzTU5BUiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDB9.6L5v1dICFOTrPmL1bO3hFHcBGg9LBOrlQmwDgKetdN8'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_get_ab_test_success(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test successful AB test retrieval."""
        mock_manager = AsyncMock()
>       mock_test = ABTestResponse(
            id="test-123",
            name="Test AB Test",
            description="Test description",
            status=TestStatus.RUNNING,
            created_by="testuser",
            variants=[{"name": "control", "allocation": 50}],
            created_at="2024-01-01T12:00:00Z",
            updated_at="2024-01-01T12:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 11 validation errors for ABTestResponse
E       test_type
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       allocation_strategy
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.description
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.configuration
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metrics
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       duration_days
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       min_sample_size
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       confidence_level
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       traffic_percentage
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       tags
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metadata
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_ab_testing_unit.py:219: ValidationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwUzlHUk0yS0M1UFZCMFIzTU5BUiIsImVtYWlsIjoidXNlcmIwODVmZjljQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYjA4NWZmOWMiLCJqdGkiOiI3MDQwMzM1OS00M2JmLTQxMmUtODk0NC0wYzMzZjJiZTNiOTQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDQwLCJzZXNzaW9uX2lkIjoiOGE5MDMxZTktNjZlNy00ZDk0LWI1N2EtODEwNzE3MzE5Nzk0IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDB9.6L5v1dICFOTrPmL1bO3hFHcBGg9LBOrlQmwDgKetdN8
_________________ TestABTestingUnit.test_get_ab_test_not_found _________________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac7616060>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='125934517337216'>
client = <httpx.AsyncClient object at 0x72896a2ba810>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwVDRWTkE0QjIzNDdOQzRINVdTRCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDF9.XxqTUlu4LRF1WqOodwgQiXT0MWD5XngHiZ_SybPxpCE'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_get_ab_test_not_found(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test AB test retrieval for non-existent test."""
        mock_manager = AsyncMock()
        mock_manager.get_test.return_value = None
        mock_get_manager.return_value = mock_manager
    
>       response = await client.get("/api/v1/ab-tests/nonexistent", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:248: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-524' coro=<TestABTestingUnit.test_get_ab_test_not_found() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwVDRWTkE0QjIzNDdOQzRINVdTRCIsImVtYWlsIjoidXNlcjRhZmEwNTk3QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNGFmYTA1OTciLCJqdGkiOiJmOTQwMjI4NC0zNGMxLTQ4NDAtYTRkZC1kOGY2MzMyZDQyZmEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDQxLCJzZXNzaW9uX2lkIjoiMzM1NzlmM2MtYmNmZC00YzBjLTk4YjktZTVjZDFhOGFlZGFhIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDF9.XxqTUlu4LRF1WqOodwgQiXT0MWD5XngHiZ_SybPxpCE
_________________ TestABTestingUnit.test_start_ab_test_success _________________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac76153a0>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='125934260577264'>
client = <httpx.AsyncClient object at 0x72895addd040>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwVko2SENBNVEyNTlQWEZIWjU3TiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDJ9.UCjajs8ZbgBW5MofxuftTSWQGLe4eJM72aPj2fj01jc'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_start_ab_test_success(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test successful AB test start."""
        mock_manager = AsyncMock()
>       mock_test = ABTestResponse(
            id="test-123",
            name="Test AB Test",
            description="Test description",
            status=TestStatus.DRAFT,
            created_by="testuser",
            variants=[{"name": "control", "allocation": 50}],
            created_at="2024-01-01T12:00:00Z",
            updated_at="2024-01-01T12:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 11 validation errors for ABTestResponse
E       test_type
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       allocation_strategy
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.description
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.configuration
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metrics
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       duration_days
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       min_sample_size
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       confidence_level
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       traffic_percentage
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       tags
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metadata
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_ab_testing_unit.py:256: ValidationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwVko2SENBNVEyNTlQWEZIWjU3TiIsImVtYWlsIjoidXNlcjJhNzY2NjBiQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMmE3NjY2MGIiLCJqdGkiOiJhYjBhNjJmOC0yZjc4LTQ1MmMtYjIzNS05NDQxMzNkOWFjMDciLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDQyLCJzZXNzaW9uX2lkIjoiNGEwNDI3ZWEtYjA3MC00NGVhLTk2OTgtZWM0ZGQ4OTRiZDY3IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDJ9.UCjajs8ZbgBW5MofxuftTSWQGLe4eJM72aPj2fj01jc
_____________ TestABTestingUnit.test_start_ab_test_invalid_status ______________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac76155b0>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='125934261474544'>
client = <httpx.AsyncClient object at 0x72895aeb82c0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwV0NZS1k5WjVXVjVRQk5DQ0ZNSyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDN9.Wp2xgJbPduDatsG6jpvjFBV90fWl9syFuQ1r9I7b7UI'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_start_ab_test_invalid_status(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test starting AB test with invalid status."""
        mock_manager = AsyncMock()
>       mock_test = ABTestResponse(
            id="test-123",
            name="Test AB Test",
            description="Test description",
            status=TestStatus.RUNNING,  # Already running
            created_by="testuser",
            variants=[{"name": "control", "allocation": 50}],
            created_at="2024-01-01T12:00:00Z",
            updated_at="2024-01-01T12:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 11 validation errors for ABTestResponse
E       test_type
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       allocation_strategy
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.description
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.configuration
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metrics
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       duration_days
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       min_sample_size
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       confidence_level
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       traffic_percentage
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       tags
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metadata
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_ab_testing_unit.py:282: ValidationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwV0NZS1k5WjVXVjVRQk5DQ0ZNSyIsImVtYWlsIjoidXNlcmEzOTAwNTk0QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYTM5MDA1OTQiLCJqdGkiOiIyZWE2MmYzNi05YWYxLTRiYTItOGI4My05MTZlYzk2M2Q2ODMiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDQzLCJzZXNzaW9uX2lkIjoiMWE1NzI2NzEtN2UzYS00NzA0LThiNzUtMmU5YzlkOWMwYzdlIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDN9.Wp2xgJbPduDatsG6jpvjFBV90fWl9syFuQ1r9I7b7UI
_____________ TestABTestingUnit.test_delete_running_test_forbidden _____________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac7617a10>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='125934250157760'>
client = <httpx.AsyncClient object at 0x72895a3ed280>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwWDdZMkdUUTZTWlJKRlZQUk5BUiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDR9.yMw2Oq3DvF4k6keUgdR8_VQEchUic6AX9ifblVUO-bc'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_delete_running_test_forbidden(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test that deleting running test is forbidden."""
        mock_manager = AsyncMock()
>       mock_test = ABTestResponse(
            id="test-123",
            name="Test AB Test",
            description="Test description",
            status=TestStatus.RUNNING,  # Running test
            created_by="testuser",
            variants=[{"name": "control", "allocation": 50}],
            created_at="2024-01-01T12:00:00Z",
            updated_at="2024-01-01T12:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 11 validation errors for ABTestResponse
E       test_type
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       allocation_strategy
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.description
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.configuration
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metrics
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       duration_days
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       min_sample_size
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       confidence_level
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       traffic_percentage
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       tags
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metadata
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_ab_testing_unit.py:303: ValidationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwWDdZMkdUUTZTWlJKRlZQUk5BUiIsImVtYWlsIjoidXNlcmZlNDJkNTI1QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZmU0MmQ1MjUiLCJqdGkiOiJiOTU0Yjg3Yy1jODI4LTQ3NGQtYTAwMC1kZDY0ZjAxZDZhMzEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDQ0LCJzZXNzaW9uX2lkIjoiMGYxZjU3ZWMtNjIwOC00YjMyLWI3NjctOGEyMWI0M2RjOGQ4IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDR9.yMw2Oq3DvF4k6keUgdR8_VQEchUic6AX9ifblVUO-bc
___________ TestABTestingUnit.test_access_other_user_test_forbidden ____________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac76540e0>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='125934224502528'>
client = <httpx.AsyncClient object at 0x728958b75a90>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwWTJWWEZBNTdDU0Y3VzRRN1ZLUiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDV9.fiAqzuCAnm0rmDyMvCgKQsF03pewGqkmQMxm1h6KY4o'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_access_other_user_test_forbidden(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test that accessing other user's test is forbidden."""
        mock_manager = AsyncMock()
>       mock_test = ABTestResponse(
            id="test-123",
            name="Test AB Test",
            description="Test description",
            status=TestStatus.DRAFT,
            created_by="otheruser",  # Different user
            variants=[{"name": "control", "allocation": 50}],
            created_at="2024-01-01T12:00:00Z",
            updated_at="2024-01-01T12:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 11 validation errors for ABTestResponse
E       test_type
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       allocation_strategy
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.description
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.configuration
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metrics
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       duration_days
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       min_sample_size
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       confidence_level
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       traffic_percentage
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       tags
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metadata
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_ab_testing_unit.py:324: ValidationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwWTJWWEZBNTdDU0Y3VzRRN1ZLUiIsImVtYWlsIjoidXNlcmRkODA3YTMzQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZGQ4MDdhMzMiLCJqdGkiOiI5YjUzMTk2OS0zMDBmLTQyOGItYTlhYS0yZGI1ZGZlMWRlODAiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDQ1LCJzZXNzaW9uX2lkIjoiYmJlYmVkOWYtOWMxNS00ZGQyLThiMjgtZjg2MzAxYjA4MDc2IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDV9.fiAqzuCAnm0rmDyMvCgKQsF03pewGqkmQMxm1h6KY4o
__________________ TestABTestingUnit.test_get_results_success __________________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac76541d0>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='125934221373136'>
client = <httpx.AsyncClient object at 0x728958879ac0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwWVk5MDk0Vk1KSDlOUjNCS1pSNyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDZ9.l4pvDsxT2nxCRxWmQUDjXdFwJn-BptMHos55CCDBo6s'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_get_results_success(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test successful results retrieval."""
        mock_manager = AsyncMock()
>       mock_test = ABTestResponse(
            id="test-123",
            name="Test AB Test",
            description="Test description",
            status=TestStatus.COMPLETED,
            created_by="testuser",
            variants=[{"name": "control", "allocation": 50}],
            created_at="2024-01-01T12:00:00Z",
            updated_at="2024-01-01T12:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 11 validation errors for ABTestResponse
E       test_type
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       allocation_strategy
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.description
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.configuration
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metrics
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       duration_days
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       min_sample_size
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       confidence_level
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       traffic_percentage
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       tags
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metadata
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_ab_testing_unit.py:345: ValidationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwWVk5MDk0Vk1KSDlOUjNCS1pSNyIsImVtYWlsIjoidXNlcjY5OTdiOWMzQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNjk5N2I5YzMiLCJqdGkiOiIzOGEzNWJiMC1lODNjLTRmNjItOGFiNC03ODRlYmFiYTAzNjkiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDQ2LCJzZXNzaW9uX2lkIjoiOGQ5NTRkOTItYWE3MS00ZjdkLWFmYTgtOGRkYTI2MDljZWQxIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDZ9.l4pvDsxT2nxCRxWmQUDjXdFwJn-BptMHos55CCDBo6s
__________________ TestABTestingUnit.test_get_metrics_success __________________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x728ac7654590>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='125934246343312'>
client = <httpx.AsyncClient object at 0x72895a049eb0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwWlNGNzhWQko5QkRWQkVKRlJHSyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDd9.1ot_xkSZqZdhO9xe8LJWvKqiGjlUpsVKinJw3zlIG4U'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_get_metrics_success(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test successful metrics retrieval."""
        mock_manager = AsyncMock()
>       mock_test = ABTestResponse(
            id="test-123",
            name="Test AB Test",
            description="Test description",
            status=TestStatus.RUNNING,
            created_by="testuser",
            variants=[{"name": "control", "allocation": 50}],
            created_at="2024-01-01T12:00:00Z",
            updated_at="2024-01-01T12:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 11 validation errors for ABTestResponse
E       test_type
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       allocation_strategy
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.description
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.configuration
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metrics
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       duration_days
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       min_sample_size
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       confidence_level
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       traffic_percentage
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       tags
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metadata
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_ab_testing_unit.py:382: ValidationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMwWlNGNzhWQko5QkRWQkVKRlJHSyIsImVtYWlsIjoidXNlcjU4Y2JhNjE3QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNThjYmE2MTciLCJqdGkiOiJjYjJiMDk4Yi04MmUyLTRlMWMtYWQwNS0xZjliNTJjNDNlYjYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDQ3LCJzZXNzaW9uX2lkIjoiZDQyMzI3ODAtNzQ2NS00Njc0LTk1MWEtODBlZGUxZGMzZDY5IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDd9.1ot_xkSZqZdhO9xe8LJWvKqiGjlUpsVKinJw3zlIG4U
_____________ TestAgentsIntegration.test_agent_complete_lifecycle ______________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x728ac76555b0>
client = <httpx.AsyncClient object at 0x72895936a270>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxMEtaMURHUkVUNkZKNjQwNVZUSiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDh9.3DRNEwbYsjfEEuFOOHr6900ei5S-vihK_AlnFYvyvS4'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72895a078500>

    @pytest.mark.integration
    async def test_agent_complete_lifecycle(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complete agent lifecycle from creation to deletion."""
        # Create agent
        agent_data = {
            "name": "Integration Test Agent",
            "description": "Agent for integration testing",
            "agent_type": "chat",
            "configuration": {
                "model": "gpt-3.5-turbo",
                "temperature": 0.7,
                "max_tokens": 1000,
                "system_prompt": "You are a helpful assistant for testing."
            },
            "capabilities": ["text_generation", "conversation"],
            "metadata": {
                "test_mode": True,
                "environment": "integration"
            }
        }
    
>       create_response = await client.post("/api/v1/agents/", json=agent_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:33: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-615' coro=<TestAgentsIntegration.test_agent_complete_lifecycle() running at /home/yam/chatter/tests/test_agents_integration.py:33> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxMEtaMURHUkVUNkZKNjQwNVZUSiIsImVtYWlsIjoidXNlcjAzY2UyNzlkQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMDNjZTI3OWQiLCJqdGkiOiJkZTIyMDM3Yi0wOTk1LTRkYmItOGNjMC1lMmUyMTk5ZTBjYmUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDQ4LCJzZXNzaW9uX2lkIjoiOGY1MzM5Y2UtNGFhOS00MmQxLWIxMzgtODcxZTA3MzM1MzM3IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDh9.3DRNEwbYsjfEEuFOOHr6900ei5S-vihK_AlnFYvyvS4
______________ TestAgentsIntegration.test_agents_list_and_filter _______________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x728ac76558e0>
client = <httpx.AsyncClient object at 0x728959069040>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxMVpTVE05SjdZNTRQSzk5RjhTMyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDl9.bRZxh11lmXiLN1Tj34oWDKBSp2MjsKC2FboXNBN2nh0'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x728959353950>

    @pytest.mark.integration
    async def test_agents_list_and_filter(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test agent listing and filtering functionality."""
        # Create agents with different types
        agents_to_create = [
            {
                "name": "Chat Agent",
                "description": "Agent for chat interactions",
                "agent_type": "chat",
                "configuration": {"model": "gpt-3.5-turbo"}
            },
            {
                "name": "Assistant Agent",
                "description": "General assistant agent",
                "agent_type": "assistant",
                "configuration": {"model": "gpt-4"}
            },
            {
                "name": "Code Agent",
                "description": "Agent for code assistance",
                "agent_type": "coding",
                "configuration": {"model": "gpt-4", "temperature": 0.2}
            }
        ]
    
        created_agent_ids = []
    
        for agent_data in agents_to_create:
>           response = await client.post("/api/v1/agents/", json=agent_data, headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:123: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-628' coro=<TestAgentsIntegration.test_agents_list_and_filter() running at /home/yam/chatter/tests/test_agents_integration.py:123> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxMVpTVE05SjdZNTRQSzk5RjhTMyIsImVtYWlsIjoidXNlcmMxZTMxNzY4QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYzFlMzE3NjgiLCJqdGkiOiI5NjY1ODU0MS0xMzJhLTRhOGQtOWM4OS04NTdjY2NjY2U0NWYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDQ5LCJzZXNzaW9uX2lkIjoiMWU4M2UwYzUtYmZlNC00OTg0LTkyZDYtYWQyMTUxMWIzYzUwIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNDl9.bRZxh11lmXiLN1Tj34oWDKBSp2MjsKC2FboXNBN2nh0
_____________ TestAgentsIntegration.test_agent_templates_workflow ______________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x728ac7617ec0>
client = <httpx.AsyncClient object at 0x7289588a7bf0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxM1FQQTJQMDRCTTlTUDMzS0ZCNSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNTF9.ShOPUjakZ884Qsox_H0fqJEieLqVW-a8xIAlKPC47PE'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72895a079b20>

    @pytest.mark.integration
    async def test_agent_templates_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test agent templates functionality."""
        # Get available templates
>       templates_response = await client.get("/api/v1/agents/templates", headers=auth_headers)
                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-641' coro=<TestAgentsIntegration.test_agent_templates_workflow() running at /home/yam/chatter/tests/test_agents_integration.py:157> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxM1FQQTJQMDRCTTlTUDMzS0ZCNSIsImVtYWlsIjoidXNlcjE3NTEwYTRiQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMTc1MTBhNGIiLCJqdGkiOiJiYjg3ODc0Ni01MWE5LTQ2MTEtODhhZi1jNDhhNzIxOGU0NDYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDUxLCJzZXNzaW9uX2lkIjoiMjI3ZThmNDAtY2E2Zi00NDM3LWFiMGUtODUyZWI0ODRjOTBlIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNTF9.ShOPUjakZ884Qsox_H0fqJEieLqVW-a8xIAlKPC47PE
_______________ TestAgentsIntegration.test_bulk_agent_operations _______________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x728ac7617710>
client = <httpx.AsyncClient object at 0x72895bb905f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxNTJLU0JUU1BQTjVOSjFIVjRYRCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNTJ9.tg8Hw_MaSgENzHKvUuZC4Jz_xb5doikcSkA_9DoBknM'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x728958de3d70>

    @pytest.mark.integration
    async def test_bulk_agent_operations(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test bulk agent operations."""
        # Bulk create agents
        bulk_create_data = {
            "agents": [
                {
                    "name": "Bulk Agent 1",
                    "description": "First bulk created agent",
                    "agent_type": "chat",
                    "configuration": {"model": "gpt-3.5-turbo"}
                },
                {
                    "name": "Bulk Agent 2",
                    "description": "Second bulk created agent",
                    "agent_type": "assistant",
                    "configuration": {"model": "gpt-4"}
                },
                {
                    "name": "Bulk Agent 3",
                    "description": "Third bulk created agent",
                    "agent_type": "coding",
                    "configuration": {"model": "gpt-4", "temperature": 0.1}
                }
            ]
        }
    
>       bulk_create_response = await client.post("/api/v1/agents/bulk", json=bulk_create_data, headers=auth_headers)
                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:217: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-654' coro=<TestAgentsIntegration.test_bulk_agent_operations() running at /home/yam/chatter/tests/test_agents_integration.py:217> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxNTJLU0JUU1BQTjVOSjFIVjRYRCIsImVtYWlsIjoidXNlcjBhZTllYWU0QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMGFlOWVhZTQiLCJqdGkiOiIxNjYzYTQzNC1kNGNjLTQwM2UtYmU4OC1lY2Q3ZGUxMDdlMzIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDUyLCJzZXNzaW9uX2lkIjoiOGU1YThlZDctMDM2Zi00MWJmLWIyNTktMjU3NzYwZDE1NTlkIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNTJ9.tg8Hw_MaSgENzHKvUuZC4Jz_xb5doikcSkA_9DoBknM
____________ TestAgentsIntegration.test_agent_testing_functionality ____________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x728ac7655ca0>
client = <httpx.AsyncClient object at 0x728969d738c0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxNkNTQVZXU0JQV1dONjJHWjhIOCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNTN9.cY1Od2QTJEFLgRfGu9leUhYuuq0zonClBPMTOo88xVM'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72895bb57740>

    @pytest.mark.integration
    async def test_agent_testing_functionality(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test agent testing functionality end-to-end."""
        # Create a test agent
        agent_data = {
            "name": "Testing Agent",
            "description": "Agent for testing functionality",
            "agent_type": "chat",
            "configuration": {
                "model": "gpt-3.5-turbo",
                "temperature": 0.7,
                "system_prompt": "You are a test assistant. Always respond helpfully."
            }
        }
    
>       create_response = await client.post("/api/v1/agents/", json=agent_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:256: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-667' coro=<TestAgentsIntegration.test_agent_testing_functionality() running at /home/yam/chatter/tests/test_agents_integration.py:256> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxNkNTQVZXU0JQV1dONjJHWjhIOCIsImVtYWlsIjoidXNlcjFiMWFmN2MwQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMWIxYWY3YzAiLCJqdGkiOiIwMzJkZDZkNi00ZmU0LTQ2YTctODc5OC03YmEwMjdiMzM0NTIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDUzLCJzZXNzaW9uX2lkIjoiNWE0ZmVkZWUtNjgxOC00NjVmLTg2ZGEtZjMzMDAyODM4MzgyIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNTN9.cY1Od2QTJEFLgRfGu9leUhYuuq0zonClBPMTOo88xVM
______________ TestAgentsIntegration.test_agent_health_monitoring ______________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x728ac7655820>
client = <httpx.AsyncClient object at 0x72895b66eff0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxODU3MkI1SldLSDBORUZQWjI4SiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNTV9.Xuk4gydU4rJKTYVRPIU0QXUW0MtHR8Clxw0szxx0OkY'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x728969d75f10>

    @pytest.mark.integration
    async def test_agent_health_monitoring(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test agent health monitoring functionality."""
        # Create agent for health testing
        agent_data = {
            "name": "Health Monitor Agent",
            "description": "Agent for health monitoring tests",
            "agent_type": "chat",
            "configuration": {"model": "gpt-3.5-turbo"}
        }
    
>       create_response = await client.post("/api/v1/agents/", json=agent_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:304: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-680' coro=<TestAgentsIntegration.test_agent_health_monitoring() running at /home/yam/chatter/tests/test_agents_integration.py:304> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxODU3MkI1SldLSDBORUZQWjI4SiIsImVtYWlsIjoidXNlcjdiOTQ3ZDM0QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyN2I5NDdkMzQiLCJqdGkiOiJmMWJiOWRiYy03MWNhLTQyMmQtOGZmMy1iZWQ5Y2IzNjU3ZTQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDU1LCJzZXNzaW9uX2lkIjoiNzY5MDUwOTUtNzNkMy00NTVlLWE1MTMtZTg4N2M5NTJiOWQ3IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNTV9.Xuk4gydU4rJKTYVRPIU0QXUW0MtHR8Clxw0szxx0OkY
_______________ TestAgentsIntegration.test_agent_error_scenarios _______________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x728ac7654140>
client = <httpx.AsyncClient object at 0x72896a26d520>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxOUgzQTRBTlBYNlIyMFpQWlM5SiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNTd9.bAmKKu0MGeMFe6VSmwXd3GcF8FmxWB0b5p5Lf54K80U'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72895b645940>

    @pytest.mark.integration
    async def test_agent_error_scenarios(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test agent error handling scenarios."""
        # Test non-existent agent operations
        nonexistent_id = "nonexistent-agent-id"
    
        operations = [
            ("GET", f"/api/v1/agents/{nonexistent_id}"),
            ("PUT", f"/api/v1/agents/{nonexistent_id}"),
            ("DELETE", f"/api/v1/agents/{nonexistent_id}"),
            ("POST", f"/api/v1/agents/{nonexistent_id}/test"),
            ("GET", f"/api/v1/agents/{nonexistent_id}/health"),
        ]
    
        for method, url in operations:
            if method == "GET":
>               response = await client.get(url, headers=auth_headers)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:347: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-693' coro=<TestAgentsIntegration.test_agent_error_scenarios() running at /home/yam/chatter/tests/test_agents_integration.py:347> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxOUgzQTRBTlBYNlIyMFpQWlM5SiIsImVtYWlsIjoidXNlcmI5MjM5NTJmQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYjkyMzk1MmYiLCJqdGkiOiIxM2ZmMGYxNC1jZTM1LTQ4NzgtYjA4MC1kNmZjMDQ3NzY2ZmQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDU3LCJzZXNzaW9uX2lkIjoiOTk4OGZiN2YtNGY2Yy00MGUxLTkzMWQtY2FkNmRmN2FjNGI4IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNTd9.bAmKKu0MGeMFe6VSmwXd3GcF8FmxWB0b5p5Lf54K80U
_______________ TestAgentsIntegration.test_agent_data_validation _______________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x728ac76563c0>
client = <httpx.AsyncClient object at 0x7289590c34d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxQVZaUEhZUzlEQVc3VENCQ0tTMCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNTh9.H5e1iVav9rGAl0mgh7ontFEOw2xSKuGuOS5yHMqO3wo'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72895b7d7e00>

    @pytest.mark.integration
    async def test_agent_data_validation(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test agent data validation in integration environment."""
        # Test invalid agent type
        invalid_type_data = {
            "name": "Invalid Type Agent",
            "description": "Agent with invalid type",
            "agent_type": "invalid_type_xyz",
            "configuration": {"model": "gpt-3.5-turbo"}
        }
    
>       response = await client.post("/api/v1/agents/", json=invalid_type_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:369: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-706' coro=<TestAgentsIntegration.test_agent_data_validation() running at /home/yam/chatter/tests/test_agents_integration.py:369> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxQVZaUEhZUzlEQVc3VENCQ0tTMCIsImVtYWlsIjoidXNlcmMzNmVkZmJjQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYzM2ZWRmYmMiLCJqdGkiOiIwOTZkOTUyZC0xMDlkLTRhNDQtYTllNC00MDI2MTRiZjBkZTgiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDU4LCJzZXNzaW9uX2lkIjoiMzRiMjA1OGEtYTZlZS00OWJjLTk3YTktYjYzZWI1MGQ5N2RhIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNTh9.H5e1iVav9rGAl0mgh7ontFEOw2xSKuGuOS5yHMqO3wo
____________ TestAgentsIntegration.test_concurrent_agent_operations ____________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x728ac7656780>
client = <httpx.AsyncClient object at 0x728958e95880>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxQ01BQ0NWR05BMFBNQzBKNlcyWiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNjB9.0hdNssE0Gu2TGRsELoeZSpVs3uG4Db9Qr3ETRPbr3uI'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x728969dd2d50>

    @pytest.mark.integration
    async def test_concurrent_agent_operations(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test concurrent agent operations."""
        # Create multiple agents concurrently
        agent_data_list = [
            {
                "name": f"Concurrent Agent {i}",
                "description": f"Agent created concurrently {i}",
                "agent_type": "chat",
                "configuration": {
                    "model": "gpt-3.5-turbo",
                    "temperature": 0.5 + (i * 0.1)
                }
            }
            for i in range(5)
        ]
    
        # Create tasks for concurrent agent creation
        create_tasks = [
            asyncio.create_task(client.post("/api/v1/agents/", json=agent_data, headers=auth_headers))
            for agent_data in agent_data_list
        ]
    
        # Wait for all creations
>       create_responses = await asyncio.gather(*create_tasks)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:417: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-720' coro=<AsyncClient.post() running at /home/yam/.local/lib/python3.12/site-packages/httpx/_client.py:1859> cb=[gather.<locals>._done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:767]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxQ01BQ0NWR05BMFBNQzBKNlcyWiIsImVtYWlsIjoidXNlcmI5ODkxNmY0QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYjk4OTE2ZjQiLCJqdGkiOiI3YWU1NzUyNi0yMWRhLTQzMTQtOTYxNC1jZTI2NGJmZjQ1ZGEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDYwLCJzZXNzaW9uX2lkIjoiNjYyMjJjOGYtNDBmOS00ODYyLWJhMzItZTNhOTBhNjA2ZmI2IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNjB9.0hdNssE0Gu2TGRsELoeZSpVs3uG4Db9Qr3ETRPbr3uI
____________ TestAgentsIntegration.test_agent_complex_configuration ____________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x728ac7656b40>
client = <httpx.AsyncClient object at 0x72895a145f70>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxRFpNVzdUNTU5QzRGRjY2VDJQMSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNjF9.QvONHQjWdXpkJ88Ffj0IixSfeg89C39EzskknCnUKgA'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x728959c36180>

    @pytest.mark.integration
    async def test_agent_complex_configuration(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test agents with complex configurations."""
        # Create agent with complex configuration
        complex_agent_data = {
            "name": "Complex Configuration Agent",
            "description": "Agent with advanced configuration options",
            "agent_type": "assistant",
            "configuration": {
                "model": "gpt-4",
                "temperature": 0.8,
                "max_tokens": 2048,
                "top_p": 0.9,
                "frequency_penalty": 0.1,
                "presence_penalty": 0.2,
                "system_prompt": "You are an expert AI assistant with advanced capabilities. Provide detailed and accurate responses.",
                "custom_parameters": {
                    "response_format": "detailed",
                    "context_window": 4096,
                    "safety_level": "moderate"
                }
            },
            "capabilities": [
                "text_generation",
                "conversation",
                "analysis",
                "summarization"
            ],
            "metadata": {
                "version": "1.0",
                "created_for": "integration_testing",
                "features": {
                    "streaming": True,
                    "function_calling": False,
                    "multi_turn": True
                }
            }
        }
    
        # Create agent
>       create_response = await client.post("/api/v1/agents/", json=complex_agent_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:497: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-737' coro=<TestAgentsIntegration.test_agent_complex_configuration() running at /home/yam/chatter/tests/test_agents_integration.py:497> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxRFpNVzdUNTU5QzRGRjY2VDJQMSIsImVtYWlsIjoidXNlcmYyNmZkMDYyQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZjI2ZmQwNjIiLCJqdGkiOiI3ZTg0YWNkYi05ZmJlLTQwNWQtODVlNi0yOTc1MDBhZmMwZWIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDYxLCJzZXNzaW9uX2lkIjoiN2IyMzVhNGYtM2YyYS00MmJhLTkyNTktYjJkNjA4NjkzZDExIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNjF9.QvONHQjWdXpkJ88Ffj0IixSfeg89C39EzskknCnUKgA
________________ TestAgentsUnit.test_create_agent_requires_auth ________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895b345a60>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895b345a60>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_agents_unit.TestAgentsUnit object at 0x728ac76568a0>
client = <httpx.AsyncClient object at 0x72895b344e00>

    @pytest.mark.unit
    async def test_create_agent_requires_auth(self, client: AsyncClient):
        """Test that creating agent requires authentication."""
        agent_data = {
            "name": "Test Agent",
            "description": "Test agent description",
            "agent_type": "chat"
        }
    
>       response = await client.post("/api/v1/agents/", json=agent_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:20: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895b345a60>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:41:02.888555Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m5a337b6d-39cd-4179-8bfc-d236c1156aeb[0m [36mstatus_code[0m=[35m401[0m
________________ TestAgentsUnit.test_list_agents_requires_auth _________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72894b244ad0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72894b244ad0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_agents_unit.TestAgentsUnit object at 0x728ac7617d40>
client = <httpx.AsyncClient object at 0x72894b26fec0>

    @pytest.mark.unit
    async def test_list_agents_requires_auth(self, client: AsyncClient):
        """Test that listing agents requires authentication."""
>       response = await client.get("/api/v1/agents/")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:26: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72894b244ad0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:41:04.211037Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mb6d02d42-8e9e-4838-8c68-51da04cbe97f[0m [36mstatus_code[0m=[35m401[0m
____________ TestAgentsUnit.test_get_agent_templates_requires_auth _____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72894bef3650>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72894bef3650>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_agents_unit.TestAgentsUnit object at 0x728ac7648800>
client = <httpx.AsyncClient object at 0x72894bef2b10>

    @pytest.mark.unit
    async def test_get_agent_templates_requires_auth(self, client: AsyncClient):
        """Test that getting agent templates requires authentication."""
>       response = await client.get("/api/v1/agents/templates")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:32: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72894bef3650>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:41:05.088235Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35ma1c9119c-6c11-4f3a-b632-3e8f796b2c59[0m [36mstatus_code[0m=[35m401[0m
_________________ TestAgentsUnit.test_get_agent_requires_auth __________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72896a436660>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72896a436660>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_agents_unit.TestAgentsUnit object at 0x728ac7648bc0>
client = <httpx.AsyncClient object at 0x72896a435a60>

    @pytest.mark.unit
    async def test_get_agent_requires_auth(self, client: AsyncClient):
        """Test that getting specific agent requires authentication."""
>       response = await client.get("/api/v1/agents/agent-id")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:38: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72896a436660>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:41:05.954519Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m33e657d7-dce1-4c69-90b6-7a0ee1b47b18[0m [36mstatus_code[0m=[35m401[0m
________________ TestAgentsUnit.test_update_agent_requires_auth ________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72894bca9700>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72894bca9700>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_agents_unit.TestAgentsUnit object at 0x728ac7648f80>
client = <httpx.AsyncClient object at 0x72894bca89b0>

    @pytest.mark.unit
    async def test_update_agent_requires_auth(self, client: AsyncClient):
        """Test that updating agent requires authentication."""
>       response = await client.put("/api/v1/agents/agent-id", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:44: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1896: in put
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72894bca9700>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:41:06.802586Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m8bd2fcd8-6fe1-4cf9-ab9e-2477b9ca68b0[0m [36mstatus_code[0m=[35m401[0m
________________ TestAgentsUnit.test_delete_agent_requires_auth ________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895831f710>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895831f710>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_agents_unit.TestAgentsUnit object at 0x728ac7649340>
client = <httpx.AsyncClient object at 0x72895831e9f0>

    @pytest.mark.unit
    async def test_delete_agent_requires_auth(self, client: AsyncClient):
        """Test that deleting agent requires authentication."""
>       response = await client.delete("/api/v1/agents/agent-id")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:50: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1966: in delete
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895831f710>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:41:07.664075Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m77918c89-2516-41a5-b412-8dc85e1b1d5d[0m [36mstatus_code[0m=[35m401[0m
_________________ TestAgentsUnit.test_test_agent_requires_auth _________________

self = <tests.test_agents_unit.TestAgentsUnit object at 0x728ac7649700>
client = <httpx.AsyncClient object at 0x72896b01d550>

    @pytest.mark.unit
    async def test_test_agent_requires_auth(self, client: AsyncClient):
        """Test that testing agent requires authentication."""
        response = await client.post("/api/v1/agents/agent-id/test", json={})
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_agents_unit.py:57: AssertionError
______________ TestAgentsUnit.test_get_agent_health_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895848ef90>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895848ef90>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_agents_unit.TestAgentsUnit object at 0x728ac7649ac0>
client = <httpx.AsyncClient object at 0x72895848e2a0>

    @pytest.mark.unit
    async def test_get_agent_health_requires_auth(self, client: AsyncClient):
        """Test that getting agent health requires authentication."""
>       response = await client.get("/api/v1/agents/agent-id/health")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:62: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72895848ef90>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:41:09.165610Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m63cdb5e8-27c1-408b-9269-c69a80e8708f[0m [36mstatus_code[0m=[35m401[0m
_____________ TestAgentsUnit.test_bulk_create_agents_requires_auth _____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72896b11da90>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72896b11da90>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_agents_unit.TestAgentsUnit object at 0x728ac7649e80>
client = <httpx.AsyncClient object at 0x72896b11ccb0>

    @pytest.mark.unit
    async def test_bulk_create_agents_requires_auth(self, client: AsyncClient):
        """Test that bulk creating agents requires authentication."""
>       response = await client.post("/api/v1/agents/bulk", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:68: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72896b11da90>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:41:10.032857Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m3af0beee-effc-4a1c-a13e-78926b1889ff[0m [36mstatus_code[0m=[35m401[0m
_____________ TestAgentsUnit.test_bulk_delete_agents_requires_auth _____________

self = <tests.test_agents_unit.TestAgentsUnit object at 0x728ac764a240>
client = <httpx.AsyncClient object at 0x72896b253890>

    @pytest.mark.unit
    async def test_bulk_delete_agents_requires_auth(self, client: AsyncClient):
        """Test that bulk deleting agents requires authentication."""
        import json
>       response = await client.delete(
            "/api/v1/agents/bulk",
            content=json.dumps({"agent_ids": ["test-id"]}),
            headers={"Content-Type": "application/json"}
        )
E       TypeError: AsyncClient.delete() got an unexpected keyword argument 'content'

tests/test_agents_unit.py:75: TypeError
___________________ TestAgentsUnit.test_create_agent_success ___________________

self = <Coroutine test_create_agent_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x728ac76577d0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxUjk2OUExQkhCSlA2QlBZNFE2MyIsImVtYWlsIjoidXNlcmJmZTdjNDc5QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYmZlN2M0NzkiLCJqdGkiOiIyZTIyMjIxMi1jNWZjLTQ4YTMtYjIwZS0wYTY4ZWQ0YTFjMmYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDcyLCJzZXNzaW9uX2lkIjoiZWIwMmJhNGEtN2VlOC00ZDVmLTgwNTEtNDYxOTUxNmNjNDIzIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNzJ9.kZUQJFP61P4nc5doVkV1OaRQqucbP6K8VON_c28ThGo
________________ TestAgentsUnit.test_create_agent_invalid_data _________________

self = <tests.test_agents_unit.TestAgentsUnit object at 0x728ac764a9f0>
client = <httpx.AsyncClient object at 0x728958c95a00>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxUzhCWFZQVzRBMTJEU1M3UVFEMyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNzN9.TBnOJMJqzIfQOV2L4rlair5Z-iqfNnyVHPr7s36Jics'}

    @pytest.mark.unit
    async def test_create_agent_invalid_data(self, client: AsyncClient, auth_headers: dict):
        """Test agent creation with invalid data."""
        # Missing required fields
        agent_data = {
            "description": "Test agent description"
            # Missing name and agent_type
        }
    
>       response = await client.post("/api/v1/agents/", json=agent_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:129: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-883' coro=<TestAgentsUnit.test_create_agent_invalid_data() running at /home/yam/chatter/tests/test_agents_unit.py:129> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxUzhCWFZQVzRBMTJEU1M3UVFEMyIsImVtYWlsIjoidXNlcjkzMzM1ZDFlQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOTMzMzVkMWUiLCJqdGkiOiIyYmUzZWYzZi04MWQzLTRhMDAtYjMxZi0xZmY1YTBjMjFjMDQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDczLCJzZXNzaW9uX2lkIjoiZGJlMDhhNTctOTc0Yy00ZTZhLTgwYzctYjE4Y2RiN2Y0M2JmIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNzN9.TBnOJMJqzIfQOV2L4rlair5Z-iqfNnyVHPr7s36Jics
___________________ TestAgentsUnit.test_list_agents_success ____________________

self = <Coroutine test_list_agents_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x728ac7657920>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxVEpFU1NCRENBNUFINVNTNjVWNiIsImVtYWlsIjoidXNlcmI2MmY2MWE2QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYjYyZjYxYTYiLCJqdGkiOiJhMTQ3NmQxOS1lN2JhLTQ1YmYtODNmZi00MTg3ODFhZTY1YTkiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDc0LCJzZXNzaW9uX2lkIjoiZGE5MzA0MmQtZGRhZC00MzNhLTlmMmQtNDdkMTA2NGQxMTQ3IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNzR9.LIznBdFZ7tkltDEtRBc_T1pO8neWbn-j0Ts2YO5tdYw
_______________ TestAgentsUnit.test_get_agent_templates_success ________________

self = <Coroutine test_get_agent_templates_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x728ac7657a10>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxVkgzRlg5UFBRTTNYVDNBS1BLTSIsImVtYWlsIjoidXNlcjdiZTViYWM5QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyN2JlNWJhYzkiLCJqdGkiOiIyZGNkZGRlOS04M2IwLTRmYzgtOGU4ZC00NzJmYWU3OWJjMWQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDc1LCJzZXNzaW9uX2lkIjoiYjhlZTJjZDQtMDI2NC00ZTg2LTk5MTAtMzI1NDZiYWM3ZGZlIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNzV9._Ew8hCGJqtWESWu85HZknlv2ocB7DrY_95-ld-QnTV8
____________________ TestAgentsUnit.test_get_agent_success _____________________

self = <Coroutine test_get_agent_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x728ac7657b30>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxV0dDQ0tENEVYTTA4R0FTNzcyMiIsImVtYWlsIjoidXNlcmRkNmQzM2JjQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZGQ2ZDMzYmMiLCJqdGkiOiJkNGFkZjBlNS1lYzYxLTQ1NjAtOTU3OC1iZjJkMmIxZjE0NzEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDc2LCJzZXNzaW9uX2lkIjoiMGZhYjFkYzItOTllOS00MjM1LTlkZjgtNzRkODRjMjM2NGM5IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNzZ9.RnQkT9o7hYc3F-wwuI_HIwcN4NYJKakfJmg26Uiaptc
___________________ TestAgentsUnit.test_get_agent_not_found ____________________

self = <Coroutine test_get_agent_not_found>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x728ac7657c50>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxWEZBUURDNVhLRlg4SkFYQlZaUCIsImVtYWlsIjoidXNlcmE3YTk3MWIyQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYTdhOTcxYjIiLCJqdGkiOiIzNjY4MTdmYy0xZTA1LTRlMzMtODIxYi04OGRkZTA0N2MyOTciLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDc3LCJzZXNzaW9uX2lkIjoiZGU5MjBjMWUtYTEwYi00NzVhLWE2MzQtYjYwZjM2ZmUzZTAxIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNzd9.u0RNniIKumQz_0MIBy8w9gvHLb_XMVVpWLQeXATAmuY
___________________ TestAgentsUnit.test_update_agent_success ___________________

self = <Coroutine test_update_agent_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x728ac7657d70>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxWURaNVJISjhGNk5ITUo1WjZNSiIsImVtYWlsIjoidXNlcjdlZDZiZWE3QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyN2VkNmJlYTciLCJqdGkiOiJmMDQ3NjQzZC1iNzdlLTQ3ZGMtODI4YS04OWJjMWU1NjBiNGYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDc4LCJzZXNzaW9uX2lkIjoiYmM4NjljMjQtOTdhZS00Mzk2LWJlNzYtNDI3MWJmNWQwOGRlIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNzh9.743ZBJD4Ud0aGYsU3WdAL6P5LFKPONXiMY3WRnO8xA4
___________________ TestAgentsUnit.test_delete_agent_success ___________________

self = <Coroutine test_delete_agent_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x728ac7657e90>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMxWkQzODAxRVJXNjhBQUIwNFRTOCIsImVtYWlsIjoidXNlcjkyNDgzMTg4QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOTI0ODMxODgiLCJqdGkiOiJiZTY1ODM1Ni0yOWNhLTRiYzUtYjc4Zi1jYjU0Mzc0NDNiODUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDc5LCJzZXNzaW9uX2lkIjoiYTk4YTFkYjItYjYzOC00NmE3LWEwYjktMjk5Y2MyZDQ3ZDBiIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyNzl9.Ykks6Y8tPDexARuBecC7mnIMRT0hDkybxop8ZyHQbCg
____________________ TestAgentsUnit.test_test_agent_success ____________________

self = <Coroutine test_test_agent_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x728ac7657fb0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyMENWMzMwNDlEU1c0NzBLRFo2MyIsImVtYWlsIjoidXNlcjFmOWU3ZmUxQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMWY5ZTdmZTEiLCJqdGkiOiI1ZThmMjRkYi0yOTI5LTQyMDAtYTg1Yi00MGYyZjkyN2NiNTQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDgwLCJzZXNzaW9uX2lkIjoiOWRiYzgxMTUtZTM1Ny00MDc2LWJkYjEtZjAxNjczOWE2Nzc1IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyODB9.g3fUhkt-NoM6dqYWRyewqUBX9hOSvV_r1PCKmvOQRM4
_________________ TestAgentsUnit.test_get_agent_health_success _________________

self = <Coroutine test_get_agent_health_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x728ac7648110>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyMUc3NUVQNko3RjhZWVNSR05SRiIsImVtYWlsIjoidXNlcmEwODZiZTc2QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYTA4NmJlNzYiLCJqdGkiOiJlNWM3Zjk5Yi03MGQzLTQ3MmUtOWZkMy01YzgxNTdkMWI4NWQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDgxLCJzZXNzaW9uX2lkIjoiMDI0MTMxNjEtMDFiZi00ZDhiLWEyNjktMzdhYjc0N2FlZTlmIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyODF9.qsvhnLPu2h4zPdU2TAbTPf0RJw42SH7Fb4WySG5rPOM
________________ TestAgentsUnit.test_bulk_create_agents_success ________________

self = <Coroutine test_bulk_create_agents_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x728ac7648230>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyMkpSNjgxTTNYWlhBMUVOME5YVCIsImVtYWlsIjoidXNlcjIyZDNiZmRmQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMjJkM2JmZGYiLCJqdGkiOiJhMzNmYmRjNy1hNDNlLTQ2NTctOTM1ZC01NzU2NDdjMWJjMjEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDgyLCJzZXNzaW9uX2lkIjoiNzI5NGU3ZjEtMTAxMC00ZmQ5LTgzM2EtMDUwMTZmMTI2NDEzIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyODJ9.nLqpRYyGDn9ErxLQ6lFWvxg2buMYYhZj0sSnFWIsFPo
________________ TestAgentsUnit.test_bulk_delete_agents_success ________________

self = <Coroutine test_bulk_delete_agents_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x728ac7648350>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyM0hSR0gwUlJQVlhDNlFYNjVYQyIsImVtYWlsIjoidXNlcjhkZTRkMjBiQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOGRlNGQyMGIiLCJqdGkiOiI2MTM1YzhiYy03OWJmLTQ0ZTAtYjM2Zi0yZWI4ODljMmNlZmQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDgzLCJzZXNzaW9uX2lkIjoiOTkxZjVlZjQtM2FlYy00YmJiLTllN2YtYjY4NzlkYjgxYWIyIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyODN9.yG6Lv-svVe2CTb4GUYt3Q99vFn_DH0CB0BohL21McKk
_______________ TestAgentsUnit.test_agent_service_error_handling _______________

self = <Coroutine test_agent_service_error_handling>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x728ac7648470>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyNTJIVlI5U0IzUVFYUzA5S0pQOSIsImVtYWlsIjoidXNlcjk4MDEwMzFhQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOTgwMTAzMWEiLCJqdGkiOiIyYTQ1ZWQ2ZS1jMjM2LTQ3ZWMtYmJkNi00ODdjMDllNDk1NGQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDg1LCJzZXNzaW9uX2lkIjoiNjdiMmFjMjQtMzY2MC00YjAzLWJmNDMtYjE5NzFmYmZkM2UzIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyODV9.KRQa9k8YIY_1eCe1RM6JEsTV5zpEkpALih72WBI4_2Q
_________________ TestAgentsUnit.test_list_agents_with_filters _________________

self = <Coroutine test_list_agents_with_filters>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x728ac7648590>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyNjJaQjc0R0RXMEJDQVY3NjRRNSIsImVtYWlsIjoidXNlcmU0Y2UxOTQ4QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZTRjZTE5NDgiLCJqdGkiOiJhMWMyYzU5My00ZGVkLTRhNTUtOTQyMy1jM2RhZWViZTVjOTgiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDg2LCJzZXNzaW9uX2lkIjoiYTIwMjQzOGMtYzZlNy00NGJiLWFmODgtMThjZTgyYjdmZWE4IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyODZ9.oSlvQ5bk5LQH24aZGws8_P7-hoh5D36Vfrntpqj4gd0
______________ TestAgentsUnit.test_agent_test_with_invalid_input _______________

self = <Coroutine test_agent_test_with_invalid_input>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x728ac76486b0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyNzhRWkJZOFZNMEg3NVBLRVRNMiIsImVtYWlsIjoidXNlcjc4ZDE0OGYzQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNzhkMTQ4ZjMiLCJqdGkiOiJhZmVjMjZlMC1kODU5LTRmYTMtYmJmZS1lN2U4OTBmMDMzOTMiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDg3LCJzZXNzaW9uX2lkIjoiYWI2M2IyNGMtYjFiMy00ZmI4LWEyNGMtMjQ4NzcyZjk0YzAxIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyODd9.8Sjq_-MncaXQwlnTQSygTCqezc8qm2dQMZojvxSODwc
__________ TestAnalyticsIntegration.test_analytics_dashboard_workflow __________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x728ac764b320>
client = <httpx.AsyncClient object at 0x72895911bad0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyOEUzTktNMzlXWEVCM1dIMzA2RCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyODh9.1fZJyAvDCaev7nnYUd1WD9hc1KOr_-6aFDEGPeUytNU'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72894a421c40>

    @pytest.mark.integration
    async def test_analytics_dashboard_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complete analytics dashboard workflow."""
        # Get dashboard data
>       dashboard_response = await client.get("/api/v1/analytics/dashboard", headers=auth_headers)
                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:16: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1065' coro=<TestAnalyticsIntegration.test_analytics_dashboard_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:16> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyOEUzTktNMzlXWEVCM1dIMzA2RCIsImVtYWlsIjoidXNlcjllNjIwODUzQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOWU2MjA4NTMiLCJqdGkiOiI1ZGM1OTJlNC02Mzk0LTRiZDQtODZlOS1iNTZiOTRkNzNmMTIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDg4LCJzZXNzaW9uX2lkIjoiMjg2Nzk2YzAtNzRmZC00YjNjLWExOWEtZmRjZjY4YjQ2MTc1IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyODh9.1fZJyAvDCaev7nnYUd1WD9hc1KOr_-6aFDEGPeUytNU
________ TestAnalyticsIntegration.test_conversation_analytics_workflow _________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x728ac7650dd0>
client = <httpx.AsyncClient object at 0x7289582f4f80>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyOVkzOFNGWVNGWTRBM1ZYSDNEQiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyOTB9.2A0PT_iqcbRJ3UZdzHpMlOPbAllufkrkRZTd4sXEg1c'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72896ab970b0>

    @pytest.mark.integration
    async def test_conversation_analytics_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test conversation analytics workflow."""
        # Get conversation stats
>       stats_response = await client.get("/api/v1/analytics/conversations", headers=auth_headers)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:31: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1078' coro=<TestAnalyticsIntegration.test_conversation_analytics_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:31> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyOVkzOFNGWVNGWTRBM1ZYSDNEQiIsImVtYWlsIjoidXNlcjkyMWIzZGI2QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOTIxYjNkYjYiLCJqdGkiOiIxYWQ4NjNkZS0zMWI4LTRlNzEtYmY3OS03OTRmOTAwNDE1NjEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDkwLCJzZXNzaW9uX2lkIjoiYWRkYTUwMTEtMzk3Zi00NGM2LTkwNDUtN2IwNDU2MDViNDY0IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyOTB9.2A0PT_iqcbRJ3UZdzHpMlOPbAllufkrkRZTd4sXEg1c
_____________ TestAnalyticsIntegration.test_usage_metrics_workflow _____________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x728ac7650c50>
client = <httpx.AsyncClient object at 0x72894b7ed940>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyQjk2VzIzM1ZTQzQ1UFJXQUU0RiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyOTF9.XU6jSjOoGdMGUUB7ivNzkwYKAIUfyImC5niJ-rguiQA'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72894ba5a810>

    @pytest.mark.integration
    async def test_usage_metrics_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test usage metrics workflow."""
        # Get usage metrics
>       usage_response = await client.get("/api/v1/analytics/usage", headers=auth_headers)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:54: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1091' coro=<TestAnalyticsIntegration.test_usage_metrics_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:54> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyQjk2VzIzM1ZTQzQ1UFJXQUU0RiIsImVtYWlsIjoidXNlcmM5ZTE0YWQyQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYzllMTRhZDIiLCJqdGkiOiI3MmQwOTc0ZS01NjAzLTQwN2MtYjJlMS02Njg1NWMwM2NjZmQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDkxLCJzZXNzaW9uX2lkIjoiZjc0MDU3YmEtM2Y0ZS00YzFhLWJmZjUtNmIwOTViYmM0MWI5IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyOTF9.XU6jSjOoGdMGUUB7ivNzkwYKAIUfyImC5niJ-rguiQA
__________ TestAnalyticsIntegration.test_performance_metrics_workflow __________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x728ac7651970>
client = <httpx.AsyncClient object at 0x72894b940e00>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyQ0tWMENBUENDOFpTRzVXSDVDNCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyOTN9.TcNTshEYuZ-eRpufz-d9mfNdfaJ9DpbM-L2NxyNQEGA'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72894ba59ac0>

    @pytest.mark.integration
    async def test_performance_metrics_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test performance metrics workflow."""
        # Get performance metrics
>       perf_response = await client.get("/api/v1/analytics/performance", headers=auth_headers)
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:77: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1104' coro=<TestAnalyticsIntegration.test_performance_metrics_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:77> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyQ0tWMENBUENDOFpTRzVXSDVDNCIsImVtYWlsIjoidXNlcjljNTQwNzRmQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOWM1NDA3NGYiLCJqdGkiOiIxZGM5YzA2Ni03YTA0LTRiNmYtODRmZC0wMWU0MTYzOTY1ZjkiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDkzLCJzZXNzaW9uX2lkIjoiN2I3MmIyYjYtNzU2NC00ODU1LTk3YmItOTg0ODkyNzhiMGFlIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyOTN9.TcNTshEYuZ-eRpufz-d9mfNdfaJ9DpbM-L2NxyNQEGA
__________ TestAnalyticsIntegration.test_document_analytics_workflow ___________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x728ac7651d30>
client = <httpx.AsyncClient object at 0x72896af6c1d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyRUZSU0FNTTdWMk5NVEVBR1Y1MSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyOTR9.sYIKzGLQ8JBrglqjg3lEQyD1elz_JHuBu47eGvfYFZ0'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72894ad9a180>

    @pytest.mark.integration
    async def test_document_analytics_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test document analytics workflow."""
        # Get document analytics
>       doc_response = await client.get("/api/v1/analytics/documents", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:100: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1117' coro=<TestAnalyticsIntegration.test_document_analytics_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:100> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyRUZSU0FNTTdWMk5NVEVBR1Y1MSIsImVtYWlsIjoidXNlcmYzMmVhYzk2QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZjMyZWFjOTYiLCJqdGkiOiJjMWIzNGEzZi0wYjU1LTQ3ZDUtOTBhZS0yMGVmOGE4ZGZkNGQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDk0LCJzZXNzaW9uX2lkIjoiZTBhMDRkZDItMGRlYi00YzYzLTk3NGUtMDMxYTdlMzhhY2Y4IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyOTR9.sYIKzGLQ8JBrglqjg3lEQyD1elz_JHuBu47eGvfYFZ0
___________ TestAnalyticsIntegration.test_system_analytics_workflow ____________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x728ac76520f0>
client = <httpx.AsyncClient object at 0x72894b07bfe0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyRlNNOUpCNVZQMFlKMzNHNkVGSCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyOTZ9.hrTwjI0stIpAoX3BoPZl6xH0IOLtPBmPvDV0CJ-QPNE'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72894aac5d90>

    @pytest.mark.integration
    async def test_system_analytics_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test system analytics workflow."""
        # Get system analytics
>       system_response = await client.get("/api/v1/analytics/system", headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:122: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1130' coro=<TestAnalyticsIntegration.test_system_analytics_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:122> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyRlNNOUpCNVZQMFlKMzNHNkVGSCIsImVtYWlsIjoidXNlcjY1N2RjMWQ3QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNjU3ZGMxZDciLCJqdGkiOiJhNDg4ZDAwNy04Y2EyLTQ2NmEtYmEyNi0wYjhiZTdkNDA4NmQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDk2LCJzZXNzaW9uX2lkIjoiYmQ1ZTM0ZWQtNGNiMS00M2JiLWE2YjMtMDZhYTgyMDQ2YzJkIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyOTZ9.hrTwjI0stIpAoX3BoPZl6xH0IOLtPBmPvDV0CJ-QPNE
____________ TestAnalyticsIntegration.test_user_analytics_workflow _____________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x728ac76524b0>
client = <httpx.AsyncClient object at 0x72894a4a1d90>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMySDRFNUU5SlRNNDhFNVE5NTM4UCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyOTd9.UR6bAmjiSsLmRJSs28Oc0y0-10KmJ7r6ga2_-NaYRws'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7289498bb440>

    @pytest.mark.integration
    async def test_user_analytics_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test user analytics workflow."""
        # Test with a sample user ID
        user_id = "test-user-123"
    
        # Get user analytics
>       user_response = await client.get(f"/api/v1/analytics/users/{user_id}", headers=auth_headers)
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:147: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1143' coro=<TestAnalyticsIntegration.test_user_analytics_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:147> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMySDRFNUU5SlRNNDhFNVE5NTM4UCIsImVtYWlsIjoidXNlcjNiMjFkOTc0QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyM2IyMWQ5NzQiLCJqdGkiOiJjZTJhMmEwYy0zNzg3LTQ1YWQtOTY1MC0wYWM5NmVkNGUxNTAiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDk3LCJzZXNzaW9uX2lkIjoiZDdjYjNiMDItMDgzYS00NGY4LThlMmUtMmI1NTViOGRhYzhlIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyOTd9.UR6bAmjiSsLmRJSs28Oc0y0-10KmJ7r6ga2_-NaYRws
___________ TestAnalyticsIntegration.test_analytics_export_workflow ____________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x728ac7652870>
client = <httpx.AsyncClient object at 0x72894a65f860>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMySzE0MkNWSENNUDREUjNDRUFRWiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyOTl9.7dKkTGRnMTLGJhmIhvvwMXagbRbaBGsArmJEur4H2hE'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72896b20f5c0>

    @pytest.mark.integration
    async def test_analytics_export_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test analytics export workflow."""
        # Request analytics export
        export_data = {
            "date_range": {
                "start": "2024-01-01",
                "end": "2024-01-31"
            },
            "format": "json",
            "include_types": ["conversations", "usage"]
        }
    
>       export_response = await client.post("/api/v1/analytics/export", json=export_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:179: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1156' coro=<TestAnalyticsIntegration.test_analytics_export_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:179> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMySzE0MkNWSENNUDREUjNDRUFRWiIsImVtYWlsIjoidXNlcjBlZTRmNTIzQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMGVlNGY1MjMiLCJqdGkiOiIyYWRhNWUyZC1hY2U4LTQyYmEtYjg4Ni1mODYwZWM4M2Q0NTIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNDk5LCJzZXNzaW9uX2lkIjoiOWIwZmRjOGYtMTlhYi00NDhiLWFmZTctYWYyNTQwMjFhOWU3IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIyOTl9.7dKkTGRnMTLGJhmIhvvwMXagbRbaBGsArmJEur4H2hE
_____________ TestAnalyticsIntegration.test_analytics_health_check _____________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x728ac7652c30>
client = <httpx.AsyncClient object at 0x72894bdc4d40>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyTUJHWDMwQzNBR1M0TTJGQkZRQSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMDB9.ogd_9ZKom-2-2esySX2tMOm1n7KZR74ONkzUkHKLlzo'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72894b63e960>

    @pytest.mark.integration
    async def test_analytics_health_check(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test analytics health check."""
        # Get analytics health
>       health_response = await client.get("/api/v1/analytics/health", headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:197: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1169' coro=<TestAnalyticsIntegration.test_analytics_health_check() running at /home/yam/chatter/tests/test_analytics_integration.py:197> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyTUJHWDMwQzNBR1M0TTJGQkZRQSIsImVtYWlsIjoidXNlcjlhNmY4NjljQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOWE2Zjg2OWMiLCJqdGkiOiIzZGNkNDhlOS0zZTFkLTQyYzktYWMwMS0wNTNlNDRmOWZjYTkiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTAwLCJzZXNzaW9uX2lkIjoiNWM5ZTQ0YzktYzUxZi00MWY3LWFjYjEtMDg4YzliZGQyODhjIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMDB9.ogd_9ZKom-2-2esySX2tMOm1n7KZR74ONkzUkHKLlzo
____________ TestAnalyticsIntegration.test_metrics_summary_workflow ____________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x728ac7652ff0>
client = <httpx.AsyncClient object at 0x72894b0af7a0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyTlFGQ1JLTkFBRUtYMjM3NjVFNiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMDJ9.SWfOohHYxKLAegp6wOCrMBXN0oKAfElE2qV65IuIqk4'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72894afa4980>

    @pytest.mark.integration
    async def test_metrics_summary_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test metrics summary workflow."""
        # Get metrics summary
>       summary_response = await client.get("/api/v1/analytics/metrics/summary", headers=auth_headers)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:211: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1182' coro=<TestAnalyticsIntegration.test_metrics_summary_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:211> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyTlFGQ1JLTkFBRUtYMjM3NjVFNiIsImVtYWlsIjoidXNlcmIwOWRmNzEzQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYjA5ZGY3MTMiLCJqdGkiOiIzNWRiNDliYS00YWQ4LTRiNDEtOTZhNC02MGNiZmQ0MzQ1ZGIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTAyLCJzZXNzaW9uX2lkIjoiNDdmMDE4MGQtYzUyYi00NTQzLWFiNWItYTFjYWFlYjk2YzkzIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMDJ9.SWfOohHYxKLAegp6wOCrMBXN0oKAfElE2qV65IuIqk4
_________ TestAnalyticsIntegration.test_toolserver_analytics_workflow __________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x728ac76533b0>
client = <httpx.AsyncClient object at 0x72894a32a2d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyUTJYQzRNN1FCNU5QQTVQNjVRRCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMDN9.xwvshg_cNpLWsLVvHvnpZT3PL6S-cR8yvBEsMEfNgRA'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x728959136e10>

    @pytest.mark.integration
    async def test_toolserver_analytics_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test toolserver analytics workflow."""
        # Get toolserver analytics
>       toolserver_response = await client.get("/api/v1/analytics/toolservers", headers=auth_headers)
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:231: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1195' coro=<TestAnalyticsIntegration.test_toolserver_analytics_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:231> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyUTJYQzRNN1FCNU5QQTVQNjVRRCIsImVtYWlsIjoidXNlcjYxOTU1ZjUyQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNjE5NTVmNTIiLCJqdGkiOiJmYTJmMDEyMC1hMDI5LTQ1MGItOGQzNi0xN2M0NDEzNmFkOGQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTAzLCJzZXNzaW9uX2lkIjoiMGZmYTcyNzItNGU0Yy00YmNhLWEyYTQtODQ2NDQxZTkwYWNjIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMDN9.xwvshg_cNpLWsLVvHvnpZT3PL6S-cR8yvBEsMEfNgRA
_________ TestAnalyticsIntegration.test_concurrent_analytics_requests __________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x728ac7653770>
client = <httpx.AsyncClient object at 0x728949894b00>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyUkRDUDJTTjkzMTNCWFdFRjNNNiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMDV9.mShEdILWvE2zLGcYy_w7fx6BHrvoLnd9oulDVZquBIk'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72894a367ec0>

    @pytest.mark.integration
    async def test_concurrent_analytics_requests(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test concurrent analytics requests."""
        # Create concurrent requests to different analytics endpoints
        endpoints = [
            "/api/v1/analytics/conversations",
            "/api/v1/analytics/usage",
            "/api/v1/analytics/performance",
            "/api/v1/analytics/system",
            "/api/v1/analytics/health"
        ]
    
        # Create tasks for concurrent requests
        tasks = [
            asyncio.create_task(client.get(endpoint, headers=auth_headers))
            for endpoint in endpoints
        ]
    
        # Wait for all requests
>       responses = await asyncio.gather(*tasks)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:261: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1209' coro=<AsyncClient.get() running at /home/yam/.local/lib/python3.12/site-packages/httpx/_client.py:1768> cb=[gather.<locals>._done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:767]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyUkRDUDJTTjkzMTNCWFdFRjNNNiIsImVtYWlsIjoidXNlcmYyYTZhNDEzQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZjJhNmE0MTMiLCJqdGkiOiIxMjdkODI2MC02NDFhLTRjNGUtYTQyZS1jZTJiYmE0ZDdkNTUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTA1LCJzZXNzaW9uX2lkIjoiNTI1MGRhM2ItNTQ2ZC00ZmY5LTg2MDItNTFmZWQ4YmU4MmRmIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMDV9.mShEdILWvE2zLGcYy_w7fx6BHrvoLnd9oulDVZquBIk
___________ TestAnalyticsIntegration.test_analytics_data_consistency ___________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x728ac7649e50>
client = <httpx.AsyncClient object at 0x72894a6f3c50>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyVEM1TUo5MzU1RDgzWlo5RURCWCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMDd9.8Br0JLmMCEOciY1wwY1dQ5-uRRvbMgNvo4Kcl4ro6nQ'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72894ac2fa10>

    @pytest.mark.integration
    async def test_analytics_data_consistency(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test analytics data consistency across endpoints."""
        # Get data from multiple endpoints
>       dashboard_response = await client.get("/api/v1/analytics/dashboard", headers=auth_headers)
                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:271: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1226' coro=<TestAnalyticsIntegration.test_analytics_data_consistency() running at /home/yam/chatter/tests/test_analytics_integration.py:271> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyVEM1TUo5MzU1RDgzWlo5RURCWCIsImVtYWlsIjoidXNlcjJmZGM5MjljQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMmZkYzkyOWMiLCJqdGkiOiI2ZGU2YThiYi00Y2U2LTQzNzMtOTFlMC0yZDlkNzliMmY2NzYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTA3LCJzZXNzaW9uX2lkIjoiMmFhOTY0YWUtZWI3Mi00MWIyLThlZmItOWY2NThmYTdkODkwIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMDd9.8Br0JLmMCEOciY1wwY1dQ5-uRRvbMgNvo4Kcl4ro6nQ
____________ TestAnalyticsIntegration.test_analytics_error_handling ____________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x728ac7653bf0>
client = <httpx.AsyncClient object at 0x728948ac2a80>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyVlI1Mzg2MjkwWTlBNTZLUkNDQSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMDh9.7VEihgb2bV2qjqVAJG08vur0MhkKF1B1wfFyIOn1MiQ'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72894a6619a0>

    @pytest.mark.integration
    async def test_analytics_error_handling(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test analytics error handling scenarios."""
        # Test with invalid parameters where applicable
    
        # Invalid user ID format
>       invalid_user_response = await client.get("/api/v1/analytics/users/invalid-user-format", headers=auth_headers)
                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:300: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1239' coro=<TestAnalyticsIntegration.test_analytics_error_handling() running at /home/yam/chatter/tests/test_analytics_integration.py:300> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyVlI1Mzg2MjkwWTlBNTZLUkNDQSIsImVtYWlsIjoidXNlcjk3NGMzNmIxQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOTc0YzM2YjEiLCJqdGkiOiI0M2RjNjc3OC1kZTJhLTRmMTYtOTY0Ni03ZjBjOTUzYjRjYzYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTA4LCJzZXNzaW9uX2lkIjoiOTJjOTgyNjktM2FhMy00MzU0LThkMGMtZTk3N2ZiNTUxMzZhIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMDh9.7VEihgb2bV2qjqVAJG08vur0MhkKF1B1wfFyIOn1MiQ
_______ TestAnalyticsIntegration.test_analytics_pagination_and_filtering _______

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x728ac7652f30>
client = <httpx.AsyncClient object at 0x728949971850>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyWDJKSzRGVzBNSzVTS1EzREM4QSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMDl9.tYcxu4wdh_EEOlxJzZ3a_2KJ50kFj7FBHERzdPNCIEo'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x728948a26f90>

    @pytest.mark.integration
    async def test_analytics_pagination_and_filtering(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test analytics endpoints that support pagination and filtering."""
        # Test with query parameters where supported
    
        # Test date range filtering on usage metrics
>       usage_with_params = await client.get(
            "/api/v1/analytics/usage?start_date=2024-01-01&end_date=2024-01-31",
            headers=auth_headers
        )

tests/test_analytics_integration.py:321: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1252' coro=<TestAnalyticsIntegration.test_analytics_pagination_and_filtering() running at /home/yam/chatter/tests/test_analytics_integration.py:321> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyWDJKSzRGVzBNSzVTS1EzREM4QSIsImVtYWlsIjoidXNlcjc1N2E1YzJhQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNzU3YTVjMmEiLCJqdGkiOiJjMWI3M2JiYS1kNGJiLTRlMWEtYjkwMS0xMTA5OWIxOWY4NGYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTA5LCJzZXNzaW9uX2lkIjoiMjE5ZDhkNTItMDMyNy00YWI4LThmNTEtNGI1YmQ5YWYzMWVjIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMDl9.tYcxu4wdh_EEOlxJzZ3a_2KJ50kFj7FBHERzdPNCIEo
______ TestAnalyticsIntegration.test_analytics_response_format_validation ______

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x728ac7652420>
client = <httpx.AsyncClient object at 0x728948bf04d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyWUNZODVUQTZXMFhGR0JaQk5OVCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMTF9.vC5415bJ4Jo5UUZCutuNdmVKoIDAigPDKy3T-niQnD4'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72894998f800>

    @pytest.mark.integration
    async def test_analytics_response_format_validation(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test that analytics responses follow expected format."""
        endpoints_to_test = [
            "/api/v1/analytics/conversations",
            "/api/v1/analytics/usage",
            "/api/v1/analytics/dashboard"
        ]
    
        for endpoint in endpoints_to_test:
>           response = await client.get(endpoint, headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:347: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1265' coro=<TestAnalyticsIntegration.test_analytics_response_format_validation() running at /home/yam/chatter/tests/test_analytics_integration.py:347> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMyWUNZODVUQTZXMFhGR0JaQk5OVCIsImVtYWlsIjoidXNlcjEyMTkzOGM1QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMTIxOTM4YzUiLCJqdGkiOiI4NzI2N2RjZi1mMjQ1LTRhODQtODViNy04YzVhYTJkMzk5NDkiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTExLCJzZXNzaW9uX2lkIjoiMGZlYmM4NTEtNGU5YS00ZmVkLTkwMDUtYmI5MzNkMjFkZTZkIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMTF9.vC5415bJ4Jo5UUZCutuNdmVKoIDAigPDKy3T-niQnD4
_________ TestAnalyticsUnit.test_get_conversation_stats_requires_auth __________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728947e6fce0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728947e6fce0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac73851f0>
client = <httpx.AsyncClient object at 0x728947e6f0b0>

    @pytest.mark.unit
    async def test_get_conversation_stats_requires_auth(self, client: AsyncClient):
        """Test that getting conversation stats requires authentication."""
>       response = await client.get("/api/v1/analytics/conversations")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:14: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728947e6fce0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:41:52.438701Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mb39d4445-a053-469d-a081-8354ef3a5797[0m [36mstatus_code[0m=[35m401[0m
____________ TestAnalyticsUnit.test_get_usage_metrics_requires_auth ____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728948fa6660>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728948fa6660>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac73854f0>
client = <httpx.AsyncClient object at 0x728948fa5a30>

    @pytest.mark.unit
    async def test_get_usage_metrics_requires_auth(self, client: AsyncClient):
        """Test that getting usage metrics requires authentication."""
>       response = await client.get("/api/v1/analytics/usage")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:20: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728948fa6660>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:41:53.558800Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m1ce8ab3f-bb01-4a34-a906-0a2dfc2bbf28[0m [36mstatus_code[0m=[35m401[0m
_________ TestAnalyticsUnit.test_get_performance_metrics_requires_auth _________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728948e25f10>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728948e25f10>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac7385910>
client = <httpx.AsyncClient object at 0x728947e6e300>

    @pytest.mark.unit
    async def test_get_performance_metrics_requires_auth(self, client: AsyncClient):
        """Test that getting performance metrics requires authentication."""
>       response = await client.get("/api/v1/analytics/performance")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:26: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728948e25f10>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:41:55.263836Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m2f96a944-d33a-443c-9fac-7adb18346ea9[0m [36mstatus_code[0m=[35m401[0m
_________ TestAnalyticsUnit.test_get_document_analytics_requires_auth __________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289491134d0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289491134d0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac7652b70>
client = <httpx.AsyncClient object at 0x728949112780>

    @pytest.mark.unit
    async def test_get_document_analytics_requires_auth(self, client: AsyncClient):
        """Test that getting document analytics requires authentication."""
>       response = await client.get("/api/v1/analytics/documents")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:32: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289491134d0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:41:56.476799Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m4c98a398-24b5-4500-8883-9644446ff833[0m [36mstatus_code[0m=[35m401[0m
__________ TestAnalyticsUnit.test_get_system_analytics_requires_auth ___________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728947b01ee0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728947b01ee0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac73851c0>
client = <httpx.AsyncClient object at 0x728947b01280>

    @pytest.mark.unit
    async def test_get_system_analytics_requires_auth(self, client: AsyncClient):
        """Test that getting system analytics requires authentication."""
>       response = await client.get("/api/v1/analytics/system")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:38: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728947b01ee0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:41:57.578391Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35md925e61b-02c4-477b-9b2d-012ddd7ccebc[0m [36mstatus_code[0m=[35m401[0m
______________ TestAnalyticsUnit.test_get_dashboard_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728947f94aa0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728947f94aa0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac7385670>
client = <httpx.AsyncClient object at 0x728947fdfda0>

    @pytest.mark.unit
    async def test_get_dashboard_requires_auth(self, client: AsyncClient):
        """Test that getting dashboard requires authentication."""
>       response = await client.get("/api/v1/analytics/dashboard")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:44: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728947f94aa0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:41:58.686017Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m34bbd910-7d31-422e-85b7-bf1200d340b4[0m [36mstatus_code[0m=[35m401[0m
________ TestAnalyticsUnit.test_get_toolserver_analytics_requires_auth _________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289485475f0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289485475f0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac73860c0>
client = <httpx.AsyncClient object at 0x728948546900>

    @pytest.mark.unit
    async def test_get_toolserver_analytics_requires_auth(self, client: AsyncClient):
        """Test that getting toolserver analytics requires authentication."""
>       response = await client.get("/api/v1/analytics/toolservers")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:50: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289485475f0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:41:59.537618Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m76aee594-269b-4d44-8df2-f5acd72d1ec9[0m [36mstatus_code[0m=[35m401[0m
___________ TestAnalyticsUnit.test_get_user_analytics_requires_auth ____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728948986210>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728948986210>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac7386480>
client = <httpx.AsyncClient object at 0x728948985460>

    @pytest.mark.unit
    async def test_get_user_analytics_requires_auth(self, client: AsyncClient):
        """Test that getting user analytics requires authentication."""
>       response = await client.get("/api/v1/analytics/users/user-123")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:56: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728948986210>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:42:00.415438Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m51d21047-f240-414a-8c22-99c49599f178[0m [36mstatus_code[0m=[35m401[0m
____________ TestAnalyticsUnit.test_export_analytics_requires_auth _____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728959660e30>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728959660e30>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac7386840>
client = <httpx.AsyncClient object at 0x728959660050>

    @pytest.mark.unit
    async def test_export_analytics_requires_auth(self, client: AsyncClient):
        """Test that exporting analytics requires authentication."""
>       response = await client.post("/api/v1/analytics/export", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:62: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728959660e30>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:42:01.325024Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m16e9cb19-8b4c-46fe-97a4-6df6096f4ff0[0m [36mstatus_code[0m=[35m401[0m
_______________ TestAnalyticsUnit.test_get_health_requires_auth ________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289594a7920>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289594a7920>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac7386c00>
client = <httpx.AsyncClient object at 0x7289594a6c30>

    @pytest.mark.unit
    async def test_get_health_requires_auth(self, client: AsyncClient):
        """Test that getting analytics health requires authentication."""
>       response = await client.get("/api/v1/analytics/health")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:68: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289594a7920>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:42:02.167577Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m43b1d388-262e-4ea8-b016-e72e006edb55[0m [36mstatus_code[0m=[35m401[0m
___________ TestAnalyticsUnit.test_get_metrics_summary_requires_auth ___________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728947396480>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728947396480>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac7386fc0>
client = <httpx.AsyncClient object at 0x728947395760>

    @pytest.mark.unit
    async def test_get_metrics_summary_requires_auth(self, client: AsyncClient):
        """Test that getting metrics summary requires authentication."""
>       response = await client.get("/api/v1/analytics/metrics/summary")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728947396480>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:42:03.033491Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mefcd588b-03a9-471c-b378-5c7ba10e14da[0m [36mstatus_code[0m=[35m401[0m
____________ TestAnalyticsUnit.test_get_conversation_stats_success _____________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac7387380>
mock_analytics_service = <MagicMock name='AnalyticsService' id='125933961191424'>
client = <httpx.AsyncClient object at 0x7289599f3bc0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzQVhTNkE5M0tINkVKTU5KUjk4QSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMjR9.Seuywxm4BdJGNsqn5V49tjS_PvO6rBSre3TwVUcUmrQ'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_get_conversation_stats_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful conversation stats retrieval."""
        # Mock analytics service
        mock_service = AsyncMock()
        mock_stats = {
            "total_conversations": 150,
            "active_conversations": 12,
            "conversations_today": 8,
            "average_messages_per_conversation": 4.5,
            "conversations_by_hour": [1, 2, 0, 3, 5, 2, 4, 1, 0, 2, 3, 6],
            "top_conversation_topics": [
                {"topic": "technical_support", "count": 45},
                {"topic": "general_inquiry", "count": 38}
            ]
        }
        mock_service.get_conversation_stats.return_value = mock_stats
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/conversations", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:97: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1410' coro=<TestAnalyticsUnit.test_get_conversation_stats_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzQVhTNkE5M0tINkVKTU5KUjk4QSIsImVtYWlsIjoidXNlcjFkNGIzODk3QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMWQ0YjM4OTciLCJqdGkiOiJiNmIzODA3MC1hMTgyLTQ5YWMtYTk1Ny1jZmQwNWExZGFiNTMiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTI0LCJzZXNzaW9uX2lkIjoiMWM5MTVhOTktNWM0OS00NTcxLWE1OGUtOWUwZmFmZGYzNTZlIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMjR9.Seuywxm4BdJGNsqn5V49tjS_PvO6rBSre3TwVUcUmrQ
_______________ TestAnalyticsUnit.test_get_usage_metrics_success _______________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac7387770>
mock_analytics_service = <MagicMock name='AnalyticsService' id='125933987590080'>
client = <httpx.AsyncClient object at 0x72894a9875f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzQ1dSMFpXRUFCWEFOWk42NDc5NCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMjZ9.iGjWE5FVJHZKkMVJ-d1uTNXfN5kG7_Mepk8EkRjp-d8'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_get_usage_metrics_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful usage metrics retrieval."""
        mock_service = AsyncMock()
        mock_metrics = {
            "api_calls_today": 1250,
            "api_calls_this_week": 8500,
            "api_calls_this_month": 35000,
            "tokens_used_today": 125000,
            "tokens_used_this_week": 850000,
            "tokens_used_this_month": 3500000,
            "top_endpoints": [
                {"endpoint": "/chat/completions", "calls": 500},
                {"endpoint": "/documents/process", "calls": 300}
            ],
            "usage_by_hour": [10, 15, 8, 25, 35, 42, 38, 28, 20, 18, 25, 30]
        }
        mock_service.get_usage_metrics.return_value = mock_metrics
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/usage", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:127: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1423' coro=<TestAnalyticsUnit.test_get_usage_metrics_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzQ1dSMFpXRUFCWEFOWk42NDc5NCIsImVtYWlsIjoidXNlcmY1NmE2NjM2QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZjU2YTY2MzYiLCJqdGkiOiIzYWJiOGYwYi03ZTg4LTQ0ZjktYjlhNC1hYjlhOWZjMmE4YmEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTI2LCJzZXNzaW9uX2lkIjoiY2ZlNzk3YWMtNzllMi00NWMwLWI4ZTItOTA3NTZlMThlOTMzIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMjZ9.iGjWE5FVJHZKkMVJ-d1uTNXfN5kG7_Mepk8EkRjp-d8
____________ TestAnalyticsUnit.test_get_performance_metrics_success ____________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac7387b30>
mock_analytics_service = <MagicMock name='AnalyticsService' id='125933932243728'>
client = <httpx.AsyncClient object at 0x7289474bd010>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzRTczNEVENTNNNUJYVkZRNlhGTSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMjd9.w1qg-uFmM1baLwxfFD45BeHLe06bDfuZ8SUs_gZPlnA'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_get_performance_metrics_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful performance metrics retrieval."""
        mock_service = AsyncMock()
        mock_metrics = {
            "average_response_time": 245.6,
            "p95_response_time": 450.2,
            "p99_response_time": 850.1,
            "error_rate": 0.02,
            "successful_requests": 9850,
            "failed_requests": 150,
            "response_times_by_hour": [200, 210, 195, 220, 250, 240, 235, 225, 215, 205, 230, 245],
            "slowest_endpoints": [
                {"endpoint": "/documents/process", "avg_time": 1250.5},
                {"endpoint": "/chat/completions", "avg_time": 180.3}
            ]
        }
        mock_service.get_performance_metrics.return_value = mock_metrics
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/performance", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1436' coro=<TestAnalyticsUnit.test_get_performance_metrics_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzRTczNEVENTNNNUJYVkZRNlhGTSIsImVtYWlsIjoidXNlcjlhMzk5ZDFjQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOWEzOTlkMWMiLCJqdGkiOiI4N2YyZGMxZi1kZDMzLTRjN2UtODNmZS1mMmYyYmE1NDU2M2MiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTI3LCJzZXNzaW9uX2lkIjoiMjgxNmQzYjAtNDJkZC00NjY3LTk1MzQtZWYyZGQxZjhmN2ZjIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMjd9.w1qg-uFmM1baLwxfFD45BeHLe06bDfuZ8SUs_gZPlnA
____________ TestAnalyticsUnit.test_get_document_analytics_success _____________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac73ac200>
mock_analytics_service = <MagicMock name='AnalyticsService' id='125933939244736'>
client = <httpx.AsyncClient object at 0x728947b6ba70>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzRkhHUjZUMVZXRkVRWFdFWkMwUSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMjh9.h9b26EbO08AFoYCJ9pDOGKKK7UuOnRMoF-NsRTNxrRA'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_get_document_analytics_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful document analytics retrieval."""
        mock_service = AsyncMock()
        mock_analytics = {
            "total_documents": 450,
            "documents_processed_today": 25,
            "processing_success_rate": 0.95,
            "average_processing_time": 2.4,
            "documents_by_type": {
                "pdf": 200,
                "docx": 150,
                "txt": 100
            },
            "processing_status_breakdown": {
                "completed": 425,
                "processing": 15,
                "failed": 10
            }
        }
        mock_service.get_document_analytics.return_value = mock_analytics
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/documents", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:189: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1449' coro=<TestAnalyticsUnit.test_get_document_analytics_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzRkhHUjZUMVZXRkVRWFdFWkMwUSIsImVtYWlsIjoidXNlcmFmNmM3NmJkQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYWY2Yzc2YmQiLCJqdGkiOiI4YjcyYmU1Zi05YWZmLTQxNDktYTcwZC1kN2E4YjhmMjQxZjciLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTI4LCJzZXNzaW9uX2lkIjoiMGFhYTI2NDItZWY5YS00NGUzLThkYWMtMGIxZjBhYzVhNGUwIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMjh9.h9b26EbO08AFoYCJ9pDOGKKK7UuOnRMoF-NsRTNxrRA
_____________ TestAnalyticsUnit.test_get_system_analytics_success ______________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac73ac2f0>
mock_analytics_service = <MagicMock name='AnalyticsService' id='125933938823808'>
client = <httpx.AsyncClient object at 0x728948cdd8e0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzR1ZWQlFDMVNLNDhUSzJSSEIyWSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMzB9.Vto3JraWAKoklgWeqqvayicz8EmlyqRtRY0q4ZvaBfk'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_get_system_analytics_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful system analytics retrieval."""
        mock_service = AsyncMock()
        mock_analytics = {
            "uptime_seconds": 3600000,
            "memory_usage_mb": 1024,
            "cpu_usage_percent": 25.5,
            "disk_usage_percent": 45.2,
            "active_connections": 150,
            "database_connections": 25,
            "cache_hit_rate": 0.85,
            "system_health": "healthy"
        }
        mock_service.get_system_analytics.return_value = mock_analytics
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/system", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:215: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1462' coro=<TestAnalyticsUnit.test_get_system_analytics_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzR1ZWQlFDMVNLNDhUSzJSSEIyWSIsImVtYWlsIjoidXNlcjJkMTBkNWFlQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMmQxMGQ1YWUiLCJqdGkiOiJiZGQ4OWIzNC04ZWZmLTQ4OWYtYjM3MC0zYTk1YjE4ZjllOGMiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTMwLCJzZXNzaW9uX2lkIjoiMjkxNjc5MzYtNzY1Ni00ZDYwLTlhMGUtZDRhYjFlMjIwMGZjIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMzB9.Vto3JraWAKoklgWeqqvayicz8EmlyqRtRY0q4ZvaBfk
_________________ TestAnalyticsUnit.test_get_dashboard_success _________________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac73ac6b0>
mock_analytics_service = <MagicMock name='AnalyticsService' id='125934239070592'>
client = <httpx.AsyncClient object at 0x72895995a690>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzSlRXS0RXNDdORlE2UkswNDFHOSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMzJ9.3S4yqm-xJSHBMyYlVyzSUNcjGjqPI_RnzLRxHBkUMAs'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_get_dashboard_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful dashboard data retrieval."""
        mock_service = AsyncMock()
        mock_dashboard = {
            "summary": {
                "total_users": 125,
                "active_users": 45,
                "total_conversations": 350,
                "api_calls_today": 1250
            },
            "recent_activity": [
                {"timestamp": "2024-01-01T12:00:00Z", "event": "User login", "user": "user1"},
                {"timestamp": "2024-01-01T11:55:00Z", "event": "Document processed", "user": "user2"}
            ],
            "alerts": [
                {"level": "warning", "message": "High API usage detected", "timestamp": "2024-01-01T12:05:00Z"}
            ]
        }
        mock_service.get_dashboard_data.return_value = mock_dashboard
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/dashboard", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:246: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1475' coro=<TestAnalyticsUnit.test_get_dashboard_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzSlRXS0RXNDdORlE2UkswNDFHOSIsImVtYWlsIjoidXNlcmE1Zjk5MWQ2QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYTVmOTkxZDYiLCJqdGkiOiIxMGY1MGE3Zi00MmVmLTRhNTYtYTE3OS01ZjQwOGI0OGQwMmYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTMyLCJzZXNzaW9uX2lkIjoiZDE0OWU1MmUtMjNiZS00YzZmLWEzMGQtNWExZTcxNzExYjY0IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMzJ9.3S4yqm-xJSHBMyYlVyzSUNcjGjqPI_RnzLRxHBkUMAs
______________ TestAnalyticsUnit.test_get_user_analytics_success _______________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac7387e30>
mock_analytics_service = <MagicMock name='AnalyticsService' id='125934236352048'>
client = <httpx.AsyncClient object at 0x7289596c3e90>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzTTVIUFhGTVAyMVBCWjVWRksyVCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMzN9.SZ6Ry61T9zvhgjuJYK9LXf3B3ohXiTO4wpF6mDCelAo'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_get_user_analytics_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful user analytics retrieval."""
        mock_service = AsyncMock()
        mock_user_analytics = {
            "user_id": "user-123",
            "conversations_count": 25,
            "messages_sent": 150,
            "documents_uploaded": 8,
            "api_calls_made": 500,
            "tokens_used": 50000,
            "activity_by_day": {
                "2024-01-01": 10,
                "2024-01-02": 15,
                "2024-01-03": 8
            }
        }
        mock_service.get_user_analytics.return_value = mock_user_analytics
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/users/user-123", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:275: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1488' coro=<TestAnalyticsUnit.test_get_user_analytics_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzTTVIUFhGTVAyMVBCWjVWRksyVCIsImVtYWlsIjoidXNlcmE4ZDkwMzQxQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYThkOTAzNDEiLCJqdGkiOiJmZTcyNGViYS0yM2IwLTQ0MGQtYjVjMy1lZjY5YmU3ZjdlMWIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTMzLCJzZXNzaW9uX2lkIjoiZTIwY2QwYWMtNTFlOS00ODkxLWI3N2MtNjhlYTY2NmE3MWE0IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMzN9.SZ6Ry61T9zvhgjuJYK9LXf3B3ohXiTO4wpF6mDCelAo
_______________ TestAnalyticsUnit.test_export_analytics_success ________________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac73878c0>
mock_analytics_service = <MagicMock name='AnalyticsService' id='125933952707488'>
client = <httpx.AsyncClient object at 0x728948841850>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzTkY3NzNSWTJTNTM1UDZHRTBTMCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMzR9.f75cK960A4sQwtb2nnFLz_3TkUo2B_5RiPmT_Crxjho'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_export_analytics_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful analytics export."""
        mock_service = AsyncMock()
        mock_export_result = {
            "export_id": "export-123",
            "status": "completed",
            "download_url": "https://example.com/download/export-123",
            "format": "csv",
            "records_count": 1000
        }
        mock_service.export_analytics.return_value = mock_export_result
        mock_analytics_service.return_value = mock_service
    
        export_data = {
            "date_range": {
                "start": "2024-01-01",
                "end": "2024-01-31"
            },
            "format": "csv",
            "include_types": ["conversations", "usage", "performance"]
        }
    
>       response = await client.post("/api/v1/analytics/export", json=export_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:307: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1501' coro=<TestAnalyticsUnit.test_export_analytics_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzTkY3NzNSWTJTNTM1UDZHRTBTMCIsImVtYWlsIjoidXNlcmUwN2ZhMGY5QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZTA3ZmEwZjkiLCJqdGkiOiIyMzRiNjdmZC0xYmU2LTQ2NTgtOWU2ZC03MmE0ZmYwYjRiMDIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTM0LCJzZXNzaW9uX2lkIjoiNGExNzZkN2UtZGY2OS00NjNhLTg4ODctNDMzNDhmNzZhMjVmIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMzR9.f75cK960A4sQwtb2nnFLz_3TkUo2B_5RiPmT_Crxjho
___________ TestAnalyticsUnit.test_analytics_service_error_handling ____________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac7386cf0>
mock_analytics_service = <MagicMock name='AnalyticsService' id='125933968521168'>
client = <httpx.AsyncClient object at 0x728949757470>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzUFMxWFpHV002RTNQUVJTVzhYTSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMzZ9.mFDx5iGLqGAjgIBmmfkfzO0tWTSF_Av-IG7y8lxGbAQ'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_analytics_service_error_handling(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test analytics service error handling."""
        mock_service = AsyncMock()
        mock_service.get_conversation_stats.side_effect = Exception("Analytics service error")
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/conversations", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:323: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1514' coro=<TestAnalyticsUnit.test_analytics_service_error_handling() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzUFMxWFpHV002RTNQUVJTVzhYTSIsImVtYWlsIjoidXNlcjA2YTg0NTA0QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMDZhODQ1MDQiLCJqdGkiOiIxMTE2NjhiYi1kMDYyLTQ4ZWMtOGU5YS1lMDkyODdmNWNjYWUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTM2LCJzZXNzaW9uX2lkIjoiYTkzMThlNmQtNGNiNS00YzZkLWFjZDEtNTJlMTE5MWUzMTRkIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMzZ9.mFDx5iGLqGAjgIBmmfkfzO0tWTSF_Av-IG7y8lxGbAQ
________________ TestAnalyticsUnit.test_invalid_user_id_format _________________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac7653830>
client = <httpx.AsyncClient object at 0x728949690d10>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzUjNKVzU3WEdXNlA0MEVNWVg4NyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMzd9.mFVtI0Ft_Cr9NOmo830kYsJHLGg0gs6YKjZ3UErQcJ0'}

    @pytest.mark.unit
    async def test_invalid_user_id_format(self, client: AsyncClient, auth_headers: dict):
        """Test user analytics with invalid user ID format."""
        # This would depend on validation logic in the API
>       response = await client.get("/api/v1/analytics/users/invalid-user-id", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:330: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1527' coro=<TestAnalyticsUnit.test_invalid_user_id_format() running at /home/yam/chatter/tests/test_analytics_unit.py:330> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzUjNKVzU3WEdXNlA0MEVNWVg4NyIsImVtYWlsIjoidXNlcjJjZjQ0NzQyQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMmNmNDQ3NDIiLCJqdGkiOiI3OWU3MDFjNi1iNjkzLTRlNTItYWI3Zi1lMmYyMzYzNTU4YjUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTM3LCJzZXNzaW9uX2lkIjoiNzAzYWRiOWQtZDcyYy00N2M3LThkMTMtN2Y4YmE0ZjNiODA5IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMzd9.mFVtI0Ft_Cr9NOmo830kYsJHLGg0gs6YKjZ3UErQcJ0
______________ TestAnalyticsUnit.test_get_metrics_summary_success ______________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac73acdd0>
mock_analytics_service = <MagicMock name='AnalyticsService' id='125933935491168'>
client = <httpx.AsyncClient object at 0x7289477d7590>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzVDRHR1AzQTE3WlozNzM5OVFLUCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMzl9.jQyGBXFhs4fgFPM8Is9g-hXMtbNB6kUGO-DMXYIgsSo'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_get_metrics_summary_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful metrics summary retrieval."""
        mock_service = AsyncMock()
        mock_summary = {
            "timestamp": "2024-01-01T12:00:00Z",
            "api_calls": 1250,
            "error_rate": 0.02,
            "avg_response_time": 245.6,
            "active_users": 45,
            "system_health": "healthy",
            "alerts_count": 2
        }
        mock_service.get_metrics_summary.return_value = mock_summary
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/metrics/summary", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:351: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1540' coro=<TestAnalyticsUnit.test_get_metrics_summary_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzVDRHR1AzQTE3WlozNzM5OVFLUCIsImVtYWlsIjoidXNlcjc5MjU2OGVlQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNzkyNTY4ZWUiLCJqdGkiOiJiMDBmMTQ1My05M2JmLTQxMTUtYjA5Ni1lMWFkMDliZTU1MTQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTM5LCJzZXNzaW9uX2lkIjoiOTY4YjhlODMtYzE5YS00Y2YyLWE3ZTItNDQ5ODY3ZDQ1OWEwIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzMzl9.jQyGBXFhs4fgFPM8Is9g-hXMtbNB6kUGO-DMXYIgsSo
__________________ TestAnalyticsUnit.test_get_health_success ___________________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x728ac73ace00>
mock_analytics_service = <MagicMock name='AnalyticsService' id='125933930062016'>
client = <httpx.AsyncClient object at 0x7289472a8d10>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzVkg4TUtTWU5XUlQ2UVYzRkFHTSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzNDF9.gy9cPyWHskee60VlDqn0RLNzziCy-y7VV5ad6a5hFTw'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_get_health_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful analytics health check."""
        mock_service = AsyncMock()
        mock_health = {
            "status": "healthy",
            "services": {
                "database": "healthy",
                "cache": "healthy",
                "analytics_engine": "healthy"
            },
            "last_updated": "2024-01-01T12:00:00Z"
        }
        mock_service.get_health_status.return_value = mock_health
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/health", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:376: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1553' coro=<TestAnalyticsUnit.test_get_health_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REMzVkg4TUtTWU5XUlQ2UVYzRkFHTSIsImVtYWlsIjoidXNlcmZlNGZkZTc5QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZmU0ZmRlNzkiLCJqdGkiOiI0ODk3NjgwZS1lYTAxLTQzZTktYjAzOC1mZWM3NTI1ZGQxOWUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTQxLCJzZXNzaW9uX2lkIjoiZTA3Njg4ZDQtZTk0MS00NDZmLTlhNDQtZmE4ZDA4NTJiODc4IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzNDF9.gy9cPyWHskee60VlDqn0RLNzziCy-y7VV5ad6a5hFTw
__________________ TestAuthIntegration.test_api_key_workflow ___________________

self = <tests.test_auth_integration.TestAuthIntegration object at 0x72898480a990>
client = <httpx.AsyncClient object at 0x72894612ec90>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}

    @pytest.mark.integration
    async def test_api_key_workflow(self, client: AsyncClient, test_user_data: dict):
        """Test API key creation and usage workflow."""
        # Register user
        register_response = await client.post("/api/v1/auth/register", json=test_user_data)
        register_data = register_response.json()
    
        access_token = register_data["access_token"]
        auth_headers = {"Authorization": f"Bearer {access_token}"}
    
        # Create API key
        api_key_data = {"name": "Test API Key"}
        api_key_response = await client.post(
            "/api/v1/auth/api-key",
            json=api_key_data,
            headers=auth_headers
        )
        assert api_key_response.status_code == 200
    
        api_key_response_data = api_key_response.json()
        assert "api_key" in api_key_response_data
        assert api_key_response_data["api_key_name"] == api_key_data["name"]
    
        # List API keys
>       list_response = await client.get("/api/v1/auth/api-keys", headers=auth_headers)
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_integration.py:190: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

current_user = <User(id=01K4DC444SG576WGFT9QRPYF55, email=alice@example.com, username=alice)>
auth_service = <chatter.core.auth.AuthService object at 0x72894616b9b0>

    @router.get("/api-keys", response_model=list[APIKeyResponse])
    async def list_api_keys(
        current_user: User = Depends(get_current_user),
        auth_service: AuthService = Depends(get_auth_service),
    ) -> list[APIKeyResponse]:
        """List user's API keys.
    
        Args:
            current_user: Current authenticated user
            auth_service: Authentication service
    
        Returns:
            List of API keys
        """
        api_keys = await auth_service.list_api_keys(current_user.id)
>       return [APIKeyResponse.model_validate(key) for key in api_keys]
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pydantic_core._pydantic_core.ValidationError: 3 validation errors for APIKeyResponse
E       id
E         Field required [type=missing, input_value={'name': 'Test API Key', ...None, 'is_active': True}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       api_key
E         Field required [type=missing, input_value={'name': 'Test API Key', ...None, 'is_active': True}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       api_key_name
E         Field required [type=missing, input_value={'name': 'Test API Key', ...None, 'is_active': True}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

chatter/api/auth.py:443: ValidationError
---------------------------- Captured log teardown -----------------------------
ERROR    sqlalchemy.pool.impl.NullPool:base.py:376 Exception closing connection <AdaptedConnection <asyncpg.connection.Connection object at 0x728945d528a0>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 374, in _close_connection
    self._dialect.do_close(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 720, in do_close
    dbapi_connection.close()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 898, in close
    self.await_(self._connection.close())
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1657' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.finalizer.<locals>.async_finalizer() running at /home/yam/.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:281> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181]> got Future <Future pending> attached to a different loop
________ TestEnhancedPasswordSecurity.test_password_entropy_calculation ________

self = <tests.test_auth_security_comprehensive.TestEnhancedPasswordSecurity object at 0x728984829640>

    @pytest.mark.security
    def test_password_entropy_calculation(self):
        """Test password entropy calculation."""
        # Weak password
        weak_entropy = calculate_password_entropy("123456")
        assert weak_entropy < 30
    
        # Medium password
        medium_entropy = calculate_password_entropy("Password123")
>       assert 30 <= medium_entropy < 50
E       assert 56.66343593148202 < 50

tests/test_auth_security_comprehensive.py:40: AssertionError
_________ TestEnhancedPasswordSecurity.test_personal_info_in_password __________

self = <tests.test_auth_security_comprehensive.TestEnhancedPasswordSecurity object at 0x72898480a5a0>

    @pytest.mark.security
    def test_personal_info_in_password(self):
        """Test personal information detection in passwords."""
        user_data = {
            "username": "johndoe",
            "email": "john.doe@example.com",
            "full_name": "John Doe"
        }
    
        assert contains_personal_info("johndoe123", user_data) is True
>       assert contains_personal_info("john123password", user_data) is True
E       AssertionError: assert False is True
E        +  where False = contains_personal_info('john123password', {'email': 'john.doe@example.com', 'full_name': 'John Doe', 'username': 'johndoe'})

tests/test_auth_security_comprehensive.py:81: AssertionError
________ TestAuthServiceSecurity.test_user_creation_security_validation ________

self = <tests.test_auth_security_comprehensive.TestAuthServiceSecurity object at 0x72898482a870>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7289453c7d40>

    @pytest.mark.security
    async def test_user_creation_security_validation(self, db_session: AsyncSession):
        """Test user creation with enhanced security validation."""
        auth_service = AuthService(db_session)
    
        # Test disposable email rejection
        import uuid
        unique_id = str(uuid.uuid4())[:8]
        with pytest.raises(Exception) as exc_info:
            await auth_service.create_user(UserCreate(
                username=f"testuser_{unique_id}",
                email="test@10minutemail.com",
                password="ValidPass123!",
                full_name="Test User"
            ))
        assert "disposable email" in str(exc_info.value).lower()
    
        # Test prohibited username rejection
        unique_id = str(uuid.uuid4())[:8]
        with pytest.raises(Exception) as exc_info:
            await auth_service.create_user(UserCreate(
                username="admin",
                email=f"test_{unique_id}@example.com",
                password="ValidPass123!",
                full_name="Test User"
            ))
        assert "prohibited" in str(exc_info.value).lower()
    
        # Test weak password rejection
        unique_id = str(uuid.uuid4())[:8]
        with pytest.raises(Exception) as exc_info:
            await auth_service.create_user(UserCreate(
                username=f"testuser_{unique_id}",
                email=f"test_{unique_id}@example.com",
                password="123456",
                full_name="Test User"
            ))
>       assert "security requirements" in str(exc_info.value).lower()
E       assert 'security requirements' in "1 validation error for usercreate\npassword\n  string should have at least 8 characters [type=string_too_short, input_value='123456', input_type=str]\n    for further information visit https://errors.pydantic.dev/2.11/v/string_too_short"
E        +  where "1 validation error for usercreate\npassword\n  string should have at least 8 characters [type=string_too_short, input_value='123456', input_type=str]\n    for further information visit https://errors.pydantic.dev/2.11/v/string_too_short" = <built-in method lower of str object at 0x7289450096b0>()
E        +    where <built-in method lower of str object at 0x7289450096b0> = "1 validation error for UserCreate\npassword\n  String should have at least 8 characters [type=string_too_short, input_value='123456', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.11/v/string_too_short".lower
E        +      where "1 validation error for UserCreate\npassword\n  String should have at least 8 characters [type=string_too_short, input_value='123456', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.11/v/string_too_short" = str(1 validation error for UserCreate\npassword\n  String should have at least 8 characters [type=string_too_short, input_value='123456', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.11/v/string_too_short)
E        +        where 1 validation error for UserCreate\npassword\n  String should have at least 8 characters [type=string_too_short, input_value='123456', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.11/v/string_too_short = <ExceptionInfo 1 validation error for UserCreate\npassword\n  String should have at least 8 characters [type=string_too_short, input_value='123456', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.11/v/string_too_short tblen=2>.value

tests/test_auth_security_comprehensive.py:258: AssertionError
_____________ TestAuthServiceSecurity.test_secure_api_key_creation _____________

self = <tests.test_auth_security_comprehensive.TestAuthServiceSecurity object at 0x72898482ae40>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x728944efc560>

    @pytest.mark.security
    async def test_secure_api_key_creation(self, db_session: AsyncSession):
        """Test secure API key creation."""
        auth_service = AuthService(db_session)
    
        # Create test user
        user_data = UserCreate(
            username="testuser",
            email="test@example.com",
            password="ValidPass123!",
            full_name="Test User"
        )
        user = await auth_service.create_user(user_data)
    
        # Create API key
        api_key = await auth_service.create_api_key(user.id, "Test Key")
    
        # Verify key format
        assert api_key.startswith("chatter_api_")
        assert len(api_key) > 50
    
        # Verify key works for authentication
        await db_session.refresh(user)
        found_user = await auth_service.get_user_by_api_key(api_key)
        assert found_user is not None
        assert found_user.id == user.id
    
        # Test duplicate key creation prevention
        with pytest.raises(Exception) as exc_info:
            await auth_service.create_api_key(user.id, "Another Key")
>       assert "already has an API key" in str(exc_info.value).lower()
E       AssertionError: assert 'already has an API key' in '409: user already has an api key. revoke existing key first.'
E        +  where '409: user already has an api key. revoke existing key first.' = <built-in method lower of str object at 0x7289460cd7d0>()
E        +    where <built-in method lower of str object at 0x7289460cd7d0> = '409: User already has an API key. Revoke existing key first.'.lower
E        +      where '409: User already has an API key. Revoke existing key first.' = str(ConflictProblem(status_code=409, detail='User already has an API key. Revoke existing key first.'))
E        +        where ConflictProblem(status_code=409, detail='User already has an API key. Revoke existing key first.') = <ExceptionInfo ConflictProblem(status_code=409, detail='User already has an API key. Revoke existing key first.') tblen=2>.value

tests/test_auth_security_comprehensive.py:340: AssertionError
_______ TestTokenSecurityIntegration.test_token_creation_security_claims _______

self = <tests.test_auth_security_comprehensive.TestTokenSecurityIntegration object at 0x72898482b5c0>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x728945098320>

    @pytest.mark.security
    async def test_token_creation_security_claims(self, db_session: AsyncSession):
        """Test token creation includes proper security claims."""
        auth_service = AuthService(db_session)
    
        # Create test user
        user_data = UserCreate(
            username="testuser",
            email="test@example.com",
            password="ValidPass123!",
            full_name="Test User"
        )
        user = await auth_service.create_user(user_data)
    
        # Create tokens
        tokens = auth_service.create_tokens(user)
    
        # Verify token structure
        assert "access_token" in tokens
        assert "refresh_token" in tokens
        assert "jti" in tokens
        assert "session_id" in tokens
    
        # Decode and verify claims
>       from chatter.utils.security import verify_token
E       ModuleNotFoundError: No module named 'chatter.utils.security'

tests/test_auth_security_comprehensive.py:395: ModuleNotFoundError
_____________ TestRateLimitingIntegration.test_login_rate_limiting _____________

self = <tests.test_auth_security_comprehensive.TestRateLimitingIntegration object at 0x72898482bc50>
client = <httpx.AsyncClient object at 0x72894521b230>

    @pytest.mark.security
    async def test_login_rate_limiting(self, client: AsyncClient):
        """Test login endpoint rate limiting."""
        login_data = {
            "username": "testuser",
            "password": "wrongpassword"
        }
    
        # Make multiple rapid requests
        responses = []
        for i in range(10):
            response = await client.post("/api/v1/auth/login", json=login_data)
            responses.append(response.status_code)
    
        # Should have some rate limited responses
        # (This test may need adjustment based on actual middleware setup)
        status_codes = set(responses)
>       assert len(status_codes) > 1  # Should have different status codes
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       assert 1 > 1
E        +  where 1 = len({401})

tests/test_auth_security_comprehensive.py:467: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  chatter.core.auth:auth.py:206 [2m2025-09-05T16:42:49.526570Z[0m [[33m[1mwarning  [0m] [1mAuthentication failed - user not found[0m [[34m[1mchatter.core.auth[0m] [36midentifier[0m=[35mtestuser[0m
WARNING  chatter.core.auth:auth.py:206 [2m2025-09-05T16:42:49.528735Z[0m [[33m[1mwarning  [0m] [1mAuthentication failed - user not found[0m [[34m[1mchatter.core.auth[0m] [36midentifier[0m=[35mtestuser[0m
WARNING  chatter.core.auth:auth.py:206 [2m2025-09-05T16:42:49.530578Z[0m [[33m[1mwarning  [0m] [1mAuthentication failed - user not found[0m [[34m[1mchatter.core.auth[0m] [36midentifier[0m=[35mtestuser[0m
WARNING  chatter.core.auth:auth.py:206 [2m2025-09-05T16:42:49.532205Z[0m [[33m[1mwarning  [0m] [1mAuthentication failed - user not found[0m [[34m[1mchatter.core.auth[0m] [36midentifier[0m=[35mtestuser[0m
WARNING  chatter.core.auth:auth.py:206 [2m2025-09-05T16:42:49.534031Z[0m [[33m[1mwarning  [0m] [1mAuthentication failed - user not found[0m [[34m[1mchatter.core.auth[0m] [36midentifier[0m=[35mtestuser[0m
WARNING  chatter.core.auth:auth.py:206 [2m2025-09-05T16:42:49.535717Z[0m [[33m[1mwarning  [0m] [1mAuthentication failed - user not found[0m [[34m[1mchatter.core.auth[0m] [36midentifier[0m=[35mtestuser[0m
WARNING  chatter.core.auth:auth.py:206 [2m2025-09-05T16:42:49.537499Z[0m [[33m[1mwarning  [0m] [1mAuthentication failed - user not found[0m [[34m[1mchatter.core.auth[0m] [36midentifier[0m=[35mtestuser[0m
WARNING  chatter.core.auth:auth.py:206 [2m2025-09-05T16:42:49.539362Z[0m [[33m[1mwarning  [0m] [1mAuthentication failed - user not found[0m [[34m[1mchatter.core.auth[0m] [36midentifier[0m=[35mtestuser[0m
WARNING  chatter.core.auth:auth.py:206 [2m2025-09-05T16:42:49.540989Z[0m [[33m[1mwarning  [0m] [1mAuthentication failed - user not found[0m [[34m[1mchatter.core.auth[0m] [36midentifier[0m=[35mtestuser[0m
WARNING  chatter.core.auth:auth.py:206 [2m2025-09-05T16:42:49.542782Z[0m [[33m[1mwarning  [0m] [1mAuthentication failed - user not found[0m [[34m[1mchatter.core.auth[0m] [36midentifier[0m=[35mtestuser[0m
---------------------------- Captured log teardown -----------------------------
ERROR    sqlalchemy.pool.impl.NullPool:base.py:376 Exception closing connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7289455d8140>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 374, in _close_connection
    self._dialect.do_close(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 720, in do_close
    dbapi_connection.close()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 898, in close
    self.await_(self._connection.close())
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1829' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.finalizer.<locals>.async_finalizer() running at /home/yam/.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:281> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181]> got Future <Future pending> attached to a different loop
__ TestCompleteAuthSecurityIntegration.test_complete_secure_registration_flow __

self = <tests.test_auth_security_integration.TestCompleteAuthSecurityIntegration object at 0x728984848cb0>
client = <httpx.AsyncClient object at 0x728944b625d0>

    @pytest.mark.integration
    @pytest.mark.security
    async def test_complete_secure_registration_flow(self, client: AsyncClient):
        """Test complete secure registration with all validations."""
        # Test 1: Try registration with disposable email (should fail)
        disposable_email_data = {
            "username": "testuser",
            "email": "test@10minutemail.com",
            "password": "ValidPass123!",
            "full_name": "Test User"
        }
    
        response = await client.post("/api/v1/auth/register", json=disposable_email_data)
        assert response.status_code == 400
        assert "disposable email" in response.json()["detail"].lower()
    
        # Test 2: Try registration with prohibited username (should fail)
        prohibited_username_data = {
            "username": "admin",
            "email": "test@example.com",
            "password": "ValidPass123!",
            "full_name": "Test User"
        }
    
        response = await client.post("/api/v1/auth/register", json=prohibited_username_data)
        assert response.status_code == 400
        assert "prohibited" in response.json()["detail"].lower()
    
        # Test 3: Try registration with weak password (should fail)
        weak_password_data = {
            "username": "testuser",
            "email": "test@example.com",
            "password": "123456",
            "full_name": "Test User"
        }
    
        response = await client.post("/api/v1/auth/register", json=weak_password_data)
>       assert response.status_code == 400
E       assert 422 == 400
E        +  where 422 = <Response [422 Unprocessable Entity]>.status_code

tests/test_auth_security_integration.py:57: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T16:42:55.214937Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mtest@10minutemail.co...[0m [36merror[0m=[35m400: Invalid email format or disposable email domain[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mtestuser[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T16:42:55.216241Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mtest@example.com[0m [36merror[0m=[35m400: Username format is invalid or contains prohibited patterns[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35madmin[0m
______ TestCompleteAuthSecurityIntegration.test_secure_api_key_management ______

self = <tests.test_auth_security_integration.TestCompleteAuthSecurityIntegration object at 0x728984849340>
client = <httpx.AsyncClient object at 0x7289465321e0>

    @pytest.mark.integration
    @pytest.mark.security
    async def test_secure_api_key_management(self, client: AsyncClient):
        """Test secure API key management with enhanced security."""
        # Register and login
        user_data = {
            "username": "apiuser",
            "email": "api@example.com",
            "password": "ValidPass123!",
            "full_name": "API User"
        }
    
        register_response = await client.post("/api/v1/auth/register", json=user_data)
        tokens = register_response.json()
        auth_headers = {"Authorization": f"Bearer {tokens['access_token']}"}
    
        # Create API key
        with patch('chatter.api.auth.log_api_key_created') as mock_created:
            api_key_response = await client.post(
                "/api/v1/auth/api-key",
                json={"name": "Test API Key"},
                headers=auth_headers
            )
            assert api_key_response.status_code == 200
            mock_created.assert_called_once()
    
        api_key_data = api_key_response.json()
        api_key = api_key_data["api_key"]
    
        # Verify secure API key format
        assert api_key.startswith("chatter_api_")
        assert len(api_key) > 50
    
        # Test API key authentication
        api_auth_headers = {"Authorization": f"Bearer {api_key}"}
        profile_response = await client.get("/api/v1/auth/me", headers=api_auth_headers)
>       assert profile_response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401 Unauthorized]>.status_code

tests/test_auth_security_integration.py:163: AssertionError
---------------------------- Captured log teardown -----------------------------
ERROR    sqlalchemy.pool.impl.NullPool:base.py:376 Exception closing connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7289455da7b0>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 374, in _close_connection
    self._dialect.do_close(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 720, in do_close
    dbapi_connection.close()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 898, in close
    self.await_(self._connection.close())
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1883' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.finalizer.<locals>.async_finalizer() running at /home/yam/.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:281> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181]> got Future <Future pending> attached to a different loop
_____ TestCompleteAuthSecurityIntegration.test_secure_password_change_flow _____

self = <tests.test_auth_security_integration.TestCompleteAuthSecurityIntegration object at 0x7289848496d0>
client = <httpx.AsyncClient object at 0x7289475a7b90>

    @pytest.mark.integration
    @pytest.mark.security
    async def test_secure_password_change_flow(self, client: AsyncClient):
        """Test secure password change with enhanced validation."""
        # Register user
        user_data = {
            "username": "passuser",
            "email": "pass@example.com",
            "password": "OldPass123!",
            "full_name": "Password User"
        }
    
        register_response = await client.post("/api/v1/auth/register", json=user_data)
        tokens = register_response.json()
>       auth_headers = {"Authorization": f"Bearer {tokens['access_token']}"}
                                                   ^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'access_token'

tests/test_auth_security_integration.py:195: KeyError
------------------------------ Captured log call -------------------------------
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T16:42:58.149544Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mpass@example.com[0m [36merror[0m=[35m400: Password should not contain personal information[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mpassuser[0m
_______ TestCompleteAuthSecurityIntegration.test_token_security_features _______

self = <tests.test_auth_security_integration.TestCompleteAuthSecurityIntegration object at 0x728984849a60>
client = <httpx.AsyncClient object at 0x728946f50920>

    @pytest.mark.integration
    @pytest.mark.security
    async def test_token_security_features(self, client: AsyncClient):
        """Test enhanced token security features."""
        # Register user
        user_data = {
            "username": "tokenuser",
            "email": "token@example.com",
            "password": "ValidPass123!",
            "full_name": "Token User"
        }
    
        register_response = await client.post("/api/v1/auth/register", json=user_data)
        tokens = register_response.json()
    
        # Verify token structure
>       assert "jti" in tokens
E       AssertionError: assert 'jti' in {'access_token': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM1MEg4OVA3V1BQNVczTjExM0JLRyIsImVtYWlsIjoidG9rZW5AZXhhbXBsZS5jb20iLCJ1c2VybmFtZSI6InRva2VudXNlciIsImp0aSI6IjlmM2RiN2MyLThlZGItNGQxZi1iMjM5LTgzOTY5Zjc3NzZhNCIsInR5cGUiOiJhY2Nlc3MiLCJpYXQiOjE3NTcwOTA1NzksInNlc3Npb25faWQiOiIzOGY2MGM0MS1jNzgyLTQxNzAtYTdlNC00MGM0Y2I5OWVhM2YiLCJwZXJtaXNzaW9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA5MjM3OX0.qKfaiUlu3gWqsZ58dJHh3t33UCcvnhAjxR9xTsst3Kk', 'expires_in': 1800, 'refresh_token': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM1MEg4OVA3V1BQNVczTjExM0JLRyIsImp0aSI6IjlmM2RiN2MyLThlZGItNGQxZi1iMjM5LTgzOTY5Zjc3NzZhNCIsInR5cGUiOiJyZWZyZXNoIiwiaWF0IjoxNzU3MDkwNTc5LCJzZXNzaW9uX2lkIjoiMzhmNjBjNDEtYzc4Mi00MTcwLWE3ZTQtNDBjNGNiOTllYTNmIiwiZXhwIjoxNzU3Njk1Mzc5fQ.2-CSOXVhEzbM-UgWZiaYE02yxKb-4I-zA650FU2rI8Q', 'token_type': 'bearer', ...}

tests/test_auth_security_integration.py:274: AssertionError
---------------------------- Captured log teardown -----------------------------
ERROR    sqlalchemy.pool.impl.NullPool:base.py:376 Exception closing connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7289455dbb60>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 374, in _close_connection
    self._dialect.do_close(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 720, in do_close
    dbapi_connection.close()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 898, in close
    self.await_(self._connection.close())
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1909' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.finalizer.<locals>.async_finalizer() running at /home/yam/.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:281> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181]> got Future <Future pending> attached to a different loop
__ TestCompleteAuthSecurityIntegration.test_comprehensive_security_validation __

self = <tests.test_auth_security_integration.TestCompleteAuthSecurityIntegration object at 0x728984848c80>
client = <httpx.AsyncClient object at 0x728928305c70>

    @pytest.mark.integration
    @pytest.mark.security
    async def test_comprehensive_security_validation(self, client: AsyncClient):
        """Test comprehensive security validation across all endpoints."""
        # Test various security scenarios
        security_tests = [
            {
                "name": "XSS in full_name",
                "data": {
                    "username": "xssuser",
                    "email": "xss@example.com",
                    "password": "ValidPass123!",
                    "full_name": "<script>alert('xss')</script>"
                },
                "should_succeed": True,  # Should be sanitized, not rejected
            },
            {
                "name": "SQL injection in username",
                "data": {
                    "username": "'; DROP TABLE users; --",
                    "email": "sql@example.com",
                    "password": "ValidPass123!",
                    "full_name": "SQL User"
                },
                "should_succeed": False,  # Should be rejected
            },
            {
                "name": "Extremely long fields",
                "data": {
                    "username": "a" * 1000,
                    "email": "long@example.com",
                    "password": "ValidPass123!",
                    "full_name": "b" * 10000
                },
                "should_succeed": False,  # Should be rejected
            },
            {
                "name": "Unicode and special characters",
                "data": {
                    "username": "unicode_用户",
                    "email": "unicode@example.com",
                    "password": "ValidPass123!",
                    "full_name": "Unicode 用户 👤"
                },
                "should_succeed": False,  # Username should be rejected
            }
        ]
    
        for test in security_tests:
            response = await client.post("/api/v1/auth/register", json=test["data"])
    
            if test["should_succeed"]:
                assert response.status_code in [201, 422], f"Test '{test['name']}' failed"
                if response.status_code == 201:
                    # Verify XSS was sanitized
                    if "script" in test["data"].get("full_name", ""):
                        user_data = response.json()["user"]
>                       assert "<script>" not in user_data.get("full_name", "")
E                       assert '<script>' not in "<script>ale...s')</script>"
E                         
E                         '<script>' is contained here:
E                           <script>alert('xss')</script>
E                         ? ++++++++

tests/test_auth_security_integration.py:433: AssertionError
---------------------------- Captured log teardown -----------------------------
ERROR    sqlalchemy.pool.impl.NullPool:base.py:376 Exception closing connection <AdaptedConnection <asyncpg.connection.Connection object at 0x72892b661130>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 374, in _close_connection
    self._dialect.do_close(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 720, in do_close
    dbapi_connection.close()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 898, in close
    self.await_(self._connection.close())
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1937' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.finalizer.<locals>.async_finalizer() running at /home/yam/.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:281> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181]> got Future <Future pending> attached to a different loop
_____ TestSecurityPerformanceIntegration.test_multiple_concurrent_requests _____

self = <tests.test_auth_security_integration.TestSecurityPerformanceIntegration object at 0x72898484a300>
client = <httpx.AsyncClient object at 0x728905d8b020>

    @pytest.mark.integration
    @pytest.mark.performance
    async def test_multiple_concurrent_requests(self, client: AsyncClient):
        """Test system handles multiple concurrent auth requests."""
        # Create multiple registration tasks
        tasks = []
        for i in range(10):
            user_data = {
                "username": f"concurrentuser{i}",
                "email": f"concurrent{i}@example.com",
                "password": "ValidPass123!",
                "full_name": f"Concurrent User {i}"
            }
            task = client.post("/api/v1/auth/register", json=user_data)
            tasks.append(task)
    
        # Execute all tasks concurrently
        import time
        start_time = time.time()
        responses = await asyncio.gather(*tasks, return_exceptions=True)
        total_time = time.time() - start_time
    
        # Check results
        successful_registrations = 0
        for response in responses:
            if hasattr(response, 'status_code') and response.status_code == 201:
                successful_registrations += 1
    
        # Should handle concurrent requests reasonably well
>       assert successful_registrations >= 8  # At least 80% success rate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       assert 1 >= 8

tests/test_auth_security_integration.py:516: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T16:43:02.456249Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent1@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser1[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T16:43:02.457747Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent2@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser2[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T16:43:02.458870Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent3@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser3[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T16:43:02.459960Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent4@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser4[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T16:43:02.461159Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent5@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser5[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T16:43:02.462253Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent6@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser6[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T16:43:02.463292Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent7@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser7[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T16:43:02.464319Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent8@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser8[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T16:43:02.465509Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent9@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser9[0m
---------------------------- Captured log teardown -----------------------------
ERROR    sqlalchemy.pool.impl.NullPool:base.py:376 Exception closing connection <AdaptedConnection <asyncpg.connection.Connection object at 0x728905dc8410>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 374, in _close_connection
    self._dialect.do_close(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 720, in do_close
    dbapi_connection.close()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 898, in close
    self.await_(self._connection.close())
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1975' coro=<_wrap_asyncgen_fixture.<locals>._asyncgen_fixture_wrapper.<locals>.finalizer.<locals>.async_finalizer() running at /home/yam/.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:281> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181]> got Future <Future pending> attached to a different loop
___________________ TestAuthUnitTests.test_get_current_user ____________________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x728984864980>
client = <httpx.AsyncClient object at 0x7288e5b41100>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM1QzBaVzZHODZBU05YQ0s0Uk04MiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzOTB9.r2Us0Eqqh8Ir1DWeUT7NZM-RXQzdt2GKAkpFMYbjGXc'}

    @pytest.mark.unit
    async def test_get_current_user(self, client: AsyncClient, auth_headers: dict):
        """Test getting current user information."""
>       response = await client.get("/api/v1/auth/me", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:144: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2098' coro=<TestAuthUnitTests.test_get_current_user() running at /home/yam/chatter/tests/test_auth_unit.py:144> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM1QzBaVzZHODZBU05YQ0s0Uk04MiIsImVtYWlsIjoidXNlcjU1MDExMzY5QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNTUwMTEzNjkiLCJqdGkiOiI3MzI3MDA4Zi0wYTE3LTQ1ZDYtOTNjNS1jOGE0NzI2OTEyMTQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTkwLCJzZXNzaW9uX2lkIjoiMGIwNzkzOTgtMWIwNy00NWY3LTg2OTgtYTQyY2NkYWY1YzZhIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzOTB9.r2Us0Eqqh8Ir1DWeUT7NZM-RXQzdt2GKAkpFMYbjGXc
_____________ TestAuthUnitTests.test_get_current_user_without_auth _____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c64d71d0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c64d71d0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x728984864d70>
client = <httpx.AsyncClient object at 0x7288c64d64e0>

    @pytest.mark.unit
    async def test_get_current_user_without_auth(self, client: AsyncClient):
        """Test getting current user without authentication."""
>       response = await client.get("/api/v1/auth/me")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:158: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c64d71d0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:43:12.084223Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m42b3b2e9-ff2d-4240-9c7e-a026429fdec7[0m [36mstatus_code[0m=[35m401[0m
____________________ TestAuthUnitTests.test_update_profile _____________________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x728984865c40>
client = <httpx.AsyncClient object at 0x728904250e30>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM1SE1ZNzNFOU5HNDMwUFpIRVJQQiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzOTZ9.d7wqU2gB7bEsIPa-NDmNav-C93_1XjJp91faoFTzzTA'}

    @pytest.mark.unit
    async def test_update_profile(self, client: AsyncClient, auth_headers: dict):
        """Test updating user profile."""
        update_data = {
            "full_name": "Updated Full Name",
            "email": "updated@example.com",
        }
    
>       response = await client.put("/api/v1/auth/me", json=update_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:212: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1896: in put
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2161' coro=<TestAuthUnitTests.test_update_profile() running at /home/yam/chatter/tests/test_auth_unit.py:212> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM1SE1ZNzNFOU5HNDMwUFpIRVJQQiIsImVtYWlsIjoidXNlcjlkZjFmMTFmQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOWRmMWYxMWYiLCJqdGkiOiI4MjA1NzkwOS1jMmQ3LTQ1ODItODdiOS1kZDlmN2VjZDJiOWEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTk2LCJzZXNzaW9uX2lkIjoiZGRmYzcxMzctZTZiZi00ZjA3LThkZjUtMmZiMjdjYjQ1YzhkIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzOTZ9.d7wqU2gB7bEsIPa-NDmNav-C93_1XjJp91faoFTzzTA
______________ TestAuthUnitTests.test_update_profile_without_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72890599c140>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72890599c140>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x728984866030>
client = <httpx.AsyncClient object at 0x728905947dd0>

    @pytest.mark.unit
    async def test_update_profile_without_auth(self, client: AsyncClient):
        """Test updating profile without authentication."""
        update_data = {
            "full_name": "Updated Full Name",
        }
    
>       response = await client.put("/api/v1/auth/me", json=update_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:226: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1896: in put
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72890599c140>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:43:17.742105Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m1bc87132-0946-417d-9ad6-2f19c7227dd8[0m [36mstatus_code[0m=[35m401[0m
____________________ TestAuthUnitTests.test_change_password ____________________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x7289848663c0>
client = <httpx.AsyncClient object at 0x728905ca7110>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM1S1dKTjFGRVBNOEdES0ZRMjlKNyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzOTh9.SDjSAhDpF9omzqvrsdVxxbR_EPEHAQfved4h4f87ZXw'}
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}

    @pytest.mark.unit
    async def test_change_password(self, client: AsyncClient, auth_headers: dict, test_user_data: dict):
        """Test changing user password."""
        password_data = {
            "current_password": test_user_data["password"],
            "new_password": "NewSecurePassword123!",
        }
    
>       response = await client.post("/api/v1/auth/change-password", json=password_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:237: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2186' coro=<TestAuthUnitTests.test_change_password() running at /home/yam/chatter/tests/test_auth_unit.py:237> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM1S1dKTjFGRVBNOEdES0ZRMjlKNyIsImVtYWlsIjoidXNlcjY1ZGM3NmU3QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNjVkYzc2ZTciLCJqdGkiOiI0M2MxMjAzNS0wZDc3LTQ5YzktODQ4Zi0xZTk2ODVmOTdlMTUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNTk4LCJzZXNzaW9uX2lkIjoiZTAwYjUxZGMtYmM4Mi00MmFiLTk3ZDMtNzk2YjZhMTkwNWE2IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTIzOTh9.SDjSAhDpF9omzqvrsdVxxbR_EPEHAQfved4h4f87ZXw
_____________ TestAuthUnitTests.test_change_password_wrong_current _____________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x7289848667e0>
client = <httpx.AsyncClient object at 0x7289453edbb0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM1TjdLMVpRU1NRVzBSODBCVDBXWiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MDB9.oaX14vdalFBa4W7L5tDKgksePUmkeKlaxS14AaNdET8'}

    @pytest.mark.unit
    async def test_change_password_wrong_current(self, client: AsyncClient, auth_headers: dict):
        """Test changing password with wrong current password."""
        password_data = {
            "current_password": "wrong_current_password",
            "new_password": "NewSecurePassword123!",
        }
    
>       response = await client.post("/api/v1/auth/change-password", json=password_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:252: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2199' coro=<TestAuthUnitTests.test_change_password_wrong_current() running at /home/yam/chatter/tests/test_auth_unit.py:252> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM1TjdLMVpRU1NRVzBSODBCVDBXWiIsImVtYWlsIjoidXNlcjQ0OTQyZDZkQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNDQ5NDJkNmQiLCJqdGkiOiJkYzQzODczYy04YTBkLTQ0MTMtODg5MC0wOGEwMWEzMjkxNDYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjAwLCJzZXNzaW9uX2lkIjoiZGFhZWNmMzQtOTg2Yy00ODg0LThkN2UtNDYxMTQ0YjNmZWFiIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MDB9.oaX14vdalFBa4W7L5tDKgksePUmkeKlaxS14AaNdET8
________________________ TestAuthUnitTests.test_logout _________________________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x728984866ba0>
client = <httpx.AsyncClient object at 0x728946f95b20>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM1UEtNNDdKNUVWWDgwOUZZUDdZNiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MDF9.PFoIxb1xVBQOSuWr2mgUWTxNCP2nZQuo9T-YXiO76q8'}

    @pytest.mark.unit
    async def test_logout(self, client: AsyncClient, auth_headers: dict):
        """Test user logout."""
>       response = await client.post("/api/v1/auth/logout", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:258: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2212' coro=<TestAuthUnitTests.test_logout() running at /home/yam/chatter/tests/test_auth_unit.py:258> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM1UEtNNDdKNUVWWDgwOUZZUDdZNiIsImVtYWlsIjoidXNlcjU3ODcxODI2QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNTc4NzE4MjYiLCJqdGkiOiJjNjkxYzE2Ny05ZDMzLTQ3YzQtYTE2MC01YzBkMTc0NTEzODEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjAxLCJzZXNzaW9uX2lkIjoiNjliODY2MjYtY2ZmOS00Njk5LTgzYjItOTEyN2Q5ODMxMGFjIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MDF9.PFoIxb1xVBQOSuWr2mgUWTxNCP2nZQuo9T-YXiO76q8
_____________________ TestCLICommands.test_health_command ______________________

self = <tests.test_cli.TestCLICommands object at 0x728984322ab0>
mock_asyncio_run = <MagicMock name='run' id='125933903507248'>

    @patch('chatter.cli.asyncio.run')
    def test_health_command(self, mock_asyncio_run):
        """Test health check command."""
        result = self.runner.invoke(app, ["health"])
>       assert result.exit_code == 0
E       assert 2 == 0
E        +  where 2 = <Result SystemExit(2)>.exit_code

tests/test_cli.py:283: AssertionError
__________________ TestHealthCheck.test_health_check_success ___________________

self = <tests.test_cli.TestHealthCheck object at 0x7289843380b0>
mock_get_client = <MagicMock name='get_api_client' id='125933926931520'>

    @pytest.mark.asyncio
    @patch('chatter.cli.get_api_client')
    async def test_health_check_success(self, mock_get_client):
        """Test successful health check."""
        mock_client = MagicMock()
        mock_client.request = AsyncMock(return_value={
            "status": "ok",
            "version": "1.0.0",
            "timestamp": "2024-01-01T00:00:00Z"
        })
        mock_client.close = AsyncMock()
        mock_get_client.return_value = mock_client
    
        with patch('chatter.cli.console') as mock_console:
>           await health_check()
                  ^^^^^^^^^^^^^^

tests/test_cli.py:318: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/cli.py:988: in health_check
    asyncio.run(_check())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

main = <coroutine object health_check.<locals>._check at 0x7289283c12f0>

    def run(main, *, debug=None, loop_factory=None):
        """Execute the coroutine and return the result.
    
        This function runs the passed coroutine, taking care of
        managing the asyncio event loop, finalizing asynchronous
        generators and closing the default executor.
    
        This function cannot be called when another asyncio event loop is
        running in the same thread.
    
        If debug is True, the event loop will be run in debug mode.
        If loop_factory is passed, it is used for new event loop creation.
    
        This function always creates a new event loop and closes it at the end.
        It should be used as a main entry point for asyncio programs, and should
        ideally only be called once.
    
        The executor is given a timeout duration of 5 minutes to shutdown.
        If the executor hasn't finished within that duration, a warning is
        emitted and the executor is closed.
    
        Example:
    
            async def main():
                await asyncio.sleep(1)
                print('hello')
    
            asyncio.run(main())
        """
        if events._get_running_loop() is not None:
            # fail fast with short traceback
>           raise RuntimeError(
                "asyncio.run() cannot be called from a running event loop")
E           RuntimeError: asyncio.run() cannot be called from a running event loop

/usr/lib64/python3.12/asyncio/runners.py:191: RuntimeError
__________________ TestHealthCheck.test_health_check_failure ___________________

self = <tests.test_cli.TestHealthCheck object at 0x728984338260>
mock_get_client = <MagicMock name='get_api_client' id='125933927131152'>

    @pytest.mark.asyncio
    @patch('chatter.cli.get_api_client')
    async def test_health_check_failure(self, mock_get_client):
        """Test health check failure."""
        mock_client = MagicMock()
        mock_client.request = AsyncMock(side_effect=Exception("Connection failed"))
        mock_client.close = AsyncMock()
        mock_get_client.return_value = mock_client
    
        # Should not raise exception, but handle gracefully
>       await health_check()
              ^^^^^^^^^^^^^^

tests/test_cli.py:333: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/cli.py:988: in health_check
    asyncio.run(_check())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

main = <coroutine object health_check.<locals>._check at 0x7289283c1d00>

    def run(main, *, debug=None, loop_factory=None):
        """Execute the coroutine and return the result.
    
        This function runs the passed coroutine, taking care of
        managing the asyncio event loop, finalizing asynchronous
        generators and closing the default executor.
    
        This function cannot be called when another asyncio event loop is
        running in the same thread.
    
        If debug is True, the event loop will be run in debug mode.
        If loop_factory is passed, it is used for new event loop creation.
    
        This function always creates a new event loop and closes it at the end.
        It should be used as a main entry point for asyncio programs, and should
        ideally only be called once.
    
        The executor is given a timeout duration of 5 minutes to shutdown.
        If the executor hasn't finished within that duration, a warning is
        emitted and the executor is closed.
    
        Example:
    
            async def main():
                await asyncio.sleep(1)
                print('hello')
    
            asyncio.run(main())
        """
        if events._get_running_loop() is not None:
            # fail fast with short traceback
>           raise RuntimeError(
                "asyncio.run() cannot be called from a running event loop")
E           RuntimeError: asyncio.run() cannot be called from a running event loop

/usr/lib64/python3.12/asyncio/runners.py:191: RuntimeError
__________________ TestDatabaseCommands.test_db_init_success ___________________

self = <tests.test_cli.TestDatabaseCommands object at 0x7289843384a0>
mock_check_db = <AsyncMock name='check_database_connection' id='125933928355200'>
mock_init_db = <MagicMock name='db_init' id='125933928364176'>

    @pytest.mark.asyncio
    @patch('chatter.cli.db_init')
    @patch('chatter.cli.check_database_connection')
    async def test_db_init_success(self, mock_check_db, mock_init_db):
        """Test successful database initialization."""
        mock_check_db.return_value = True
        mock_init_db.return_value = None
    
        with patch('chatter.cli.console') as mock_console:
>           await db_init()
                  ^^^^^^^^^

tests/test_cli.py:348: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/cli.py:677: in db_init
    asyncio.run(_init())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

main = <coroutine object db_init.<locals>._init at 0x728944f682b0>

    def run(main, *, debug=None, loop_factory=None):
        """Execute the coroutine and return the result.
    
        This function runs the passed coroutine, taking care of
        managing the asyncio event loop, finalizing asynchronous
        generators and closing the default executor.
    
        This function cannot be called when another asyncio event loop is
        running in the same thread.
    
        If debug is True, the event loop will be run in debug mode.
        If loop_factory is passed, it is used for new event loop creation.
    
        This function always creates a new event loop and closes it at the end.
        It should be used as a main entry point for asyncio programs, and should
        ideally only be called once.
    
        The executor is given a timeout duration of 5 minutes to shutdown.
        If the executor hasn't finished within that duration, a warning is
        emitted and the executor is closed.
    
        Example:
    
            async def main():
                await asyncio.sleep(1)
                print('hello')
    
            asyncio.run(main())
        """
        if events._get_running_loop() is not None:
            # fail fast with short traceback
>           raise RuntimeError(
                "asyncio.run() cannot be called from a running event loop")
E           RuntimeError: asyncio.run() cannot be called from a running event loop

/usr/lib64/python3.12/asyncio/runners.py:191: RuntimeError
_____________ TestDatabaseCommands.test_db_init_connection_failure _____________

self = <tests.test_cli.TestDatabaseCommands object at 0x7289843386e0>
mock_check_db = <AsyncMock name='check_database_connection' id='125933926860224'>
mock_init_db = <MagicMock name='db_init' id='125933926925232'>

    @pytest.mark.asyncio
    @patch('chatter.cli.db_init')
    @patch('chatter.cli.check_database_connection')
    async def test_db_init_connection_failure(self, mock_check_db, mock_init_db):
        """Test database initialization with connection failure."""
        mock_check_db.return_value = False
    
        with patch('chatter.cli.console') as mock_console:
>           await db_init()
                  ^^^^^^^^^

tests/test_cli.py:362: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/cli.py:677: in db_init
    asyncio.run(_init())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

main = <coroutine object db_init.<locals>._init at 0x728946245b10>

    def run(main, *, debug=None, loop_factory=None):
        """Execute the coroutine and return the result.
    
        This function runs the passed coroutine, taking care of
        managing the asyncio event loop, finalizing asynchronous
        generators and closing the default executor.
    
        This function cannot be called when another asyncio event loop is
        running in the same thread.
    
        If debug is True, the event loop will be run in debug mode.
        If loop_factory is passed, it is used for new event loop creation.
    
        This function always creates a new event loop and closes it at the end.
        It should be used as a main entry point for asyncio programs, and should
        ideally only be called once.
    
        The executor is given a timeout duration of 5 minutes to shutdown.
        If the executor hasn't finished within that duration, a warning is
        emitted and the executor is closed.
    
        Example:
    
            async def main():
                await asyncio.sleep(1)
                print('hello')
    
            asyncio.run(main())
        """
        if events._get_running_loop() is not None:
            # fail fast with short traceback
>           raise RuntimeError(
                "asyncio.run() cannot be called from a running event loop")
E           RuntimeError: asyncio.run() cannot be called from a running event loop

/usr/lib64/python3.12/asyncio/runners.py:191: RuntimeError
________________ TestDatabaseCommands.test_db_init_init_failure ________________

self = <tests.test_cli.TestDatabaseCommands object at 0x728984338920>
mock_check_db = <AsyncMock name='check_database_connection' id='125934221542560'>
mock_init_db = <MagicMock name='db_init' id='125933915278896'>

    @pytest.mark.asyncio
    @patch('chatter.cli.db_init')
    @patch('chatter.cli.check_database_connection')
    async def test_db_init_init_failure(self, mock_check_db, mock_init_db):
        """Test database initialization with init failure."""
        mock_check_db.return_value = True
        mock_init_db.side_effect = Exception("Init failed")
    
        with patch('chatter.cli.console') as mock_console:
>           await db_init()
                  ^^^^^^^^^

tests/test_cli.py:377: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/cli.py:677: in db_init
    asyncio.run(_init())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

main = <coroutine object db_init.<locals>._init at 0x72894508a5a0>

    def run(main, *, debug=None, loop_factory=None):
        """Execute the coroutine and return the result.
    
        This function runs the passed coroutine, taking care of
        managing the asyncio event loop, finalizing asynchronous
        generators and closing the default executor.
    
        This function cannot be called when another asyncio event loop is
        running in the same thread.
    
        If debug is True, the event loop will be run in debug mode.
        If loop_factory is passed, it is used for new event loop creation.
    
        This function always creates a new event loop and closes it at the end.
        It should be used as a main entry point for asyncio programs, and should
        ideally only be called once.
    
        The executor is given a timeout duration of 5 minutes to shutdown.
        If the executor hasn't finished within that duration, a warning is
        emitted and the executor is closed.
    
        Example:
    
            async def main():
                await asyncio.sleep(1)
                print('hello')
    
            asyncio.run(main())
        """
        if events._get_running_loop() is not None:
            # fail fast with short traceback
>           raise RuntimeError(
                "asyncio.run() cannot be called from a running event loop")
E           RuntimeError: asyncio.run() cannot be called from a running event loop

/usr/lib64/python3.12/asyncio/runners.py:191: RuntimeError
________ TestInteractivePromptCreation.test_interactive_prompt_creation ________

self = <tests.test_cli.TestInteractivePromptCreation object at 0x728984338ad0>
mock_get_client = <MagicMock name='get_api_client' id='125933929007584'>
mock_confirm = <MagicMock name='ask' id='125933888876816'>
mock_prompt = <MagicMock name='ask' id='125933894234048'>

    @pytest.mark.asyncio
    @patch('chatter.cli.Prompt.ask')
    @patch('chatter.cli.Confirm.ask')
    @patch('chatter.cli.get_api_client')
    async def test_interactive_prompt_creation(self, mock_get_client, mock_confirm, mock_prompt):
        """Test interactive prompt creation flow."""
        # Mock interactive input
        mock_prompt.side_effect = [
            "Test Prompt",        # name
            "Hello {name}",       # content
            "Test description",   # description
            "greeting",           # category
            "template",           # prompt_type
            "f-string",          # template_format
            "hello,greeting"      # tags
        ]
        mock_confirm.return_value = True  # public
    
        # Mock API client
        mock_client = MagicMock()
        mock_client.request = AsyncMock(return_value={
            "id": "test_id",
            "name": "Test Prompt",
            "status": "created"
        })
        mock_client.close = AsyncMock()
        mock_get_client.return_value = mock_client
    
        # This would normally be called through the CLI command
        # We're testing the underlying async function logic
        from chatter.cli import create_prompt
    
        runner = CliRunner()
        result = runner.invoke(app, [
            "prompts", "create",
            "--name", "Test Prompt",
            "--content", "Hello {name}",
            "--interactive"
        ])
    
        # Should complete without error
>       assert result.exit_code == 0
E       AssertionError: assert 1 == 0
E        +  where 1 = <Result RuntimeError('asyncio.run() cannot be called from a running event loop')>.exit_code

tests/test_cli.py:428: AssertionError
________________ TestCLIIntegration.test_full_prompt_lifecycle _________________

self = <tests.test_cli.TestCLIIntegration object at 0x728984339430>
mock_get_client = <MagicMock name='get_api_client' id='125933900654560'>

    @patch('chatter.cli.get_api_client')
    def test_full_prompt_lifecycle(self, mock_get_client):
        """Test complete prompt management lifecycle."""
        mock_client = MagicMock()
    
        # Mock different API responses for different commands
        def mock_request(method, endpoint, **kwargs):
            if endpoint == "/prompts" and method == "POST":
                return {"id": "new_prompt_id", "name": "Test Prompt"}
            elif endpoint == "/prompts" and method == "GET":
                return {
                    "prompts": [{
                        "id": "new_prompt_id",
                        "name": "Test Prompt",
                        "prompt_type": "template",
                        "category": "test"
                    }],
                    "total_count": 1
                }
            elif endpoint == "/prompts/new_prompt_id" and method == "DELETE":
                return {"status": "deleted"}
            return {}
    
        mock_client.request = AsyncMock(side_effect=mock_request)
        mock_client.close = AsyncMock()
        mock_get_client.return_value = mock_client
    
        # Create prompt
        result = self.runner.invoke(app, [
            "prompts", "create",
            "--name", "Test Prompt",
            "--content", "Hello {name}",
            "--category", "test"
        ])
>       assert result.exit_code == 0
E       assert 1 == 0
E        +  where 1 = <Result UnboundLocalError("cannot access local variable 'name' where it is not associated with a value")>.exit_code

tests/test_cli.py:532: AssertionError
_____________ TestCLIErrorScenarios.test_api_unavailable_scenarios _____________

self = <tests.test_cli.TestCLIErrorScenarios object at 0x728984339460>
mock_get_client = <MagicMock name='get_api_client' id='125933908394688'>

    @patch('chatter.cli.get_api_client')
    def test_api_unavailable_scenarios(self, mock_get_client):
        """Test CLI behavior when API is unavailable."""
        mock_client = MagicMock()
        mock_client.request = AsyncMock(side_effect=httpx.RequestError("Connection failed"))
        mock_client.close = AsyncMock()
        mock_get_client.return_value = mock_client
    
        result = self.runner.invoke(app, ["health"])
        # Should handle error gracefully
>       assert result.exit_code == 0  # Command should complete, even if API is down
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       assert 2 == 0
E        +  where 2 = <Result SystemExit(2)>.exit_code

tests/test_cli.py:601: AssertionError
_____ TestSecretManager.test_encrypt_with_different_managers_incompatible ______

self = <tests.test_crypto_utils.TestSecretManager object at 0x728984368e30>

    def test_encrypt_with_different_managers_incompatible(self):
        """Test that data encrypted with one manager can't be decrypted with another."""
        manager1 = SecretManager()
        manager2 = SecretManager()
    
        test_data = "secret data"
        encrypted = manager1.encrypt(test_data)
    
>       with pytest.raises(CryptoError, match="Failed to decrypt data"):
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       Failed: DID NOT RAISE <class 'chatter.utils.crypto.CryptoError'>

tests/test_crypto_utils.py:93: Failed
------------------------------ Captured log call -------------------------------
WARNING  chatter.utils.crypto:crypto.py:59 [2m2025-09-05T16:43:34.186978Z[0m [[33m[1mwarning  [0m] [1mUsing derived encryption key. Set CHATTER_ENCRYPTION_KEY in production.[0m [[34m[1mchatter.utils.crypto[0m] 
WARNING  chatter.utils.crypto:crypto.py:59 [2m2025-09-05T16:43:34.205248Z[0m [[33m[1mwarning  [0m] [1mUsing derived encryption key. Set CHATTER_ENCRYPTION_KEY in production.[0m [[34m[1mchatter.utils.crypto[0m]
___________ TestDataManagementIntegration.test_export_data_workflow ____________

self = <tests.test_data_management_integration.TestDataManagementIntegration object at 0x72898436a8d0>
client = <httpx.AsyncClient object at 0x728904106540>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2NDFYQ0hLR1lFUDg2WlFUUjhEViIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MTV9.go5ngzKsfOXl02QOGvQGjmrEbJX6ByteNpdNlWDeC6g'}

    @pytest.mark.integration
    async def test_export_data_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test complete data export workflow."""
        # Test export with valid data structure (even if service isn't fully configured)
        export_data = {
            "format": "json",
            "scope": "user",
            "include_documents": True,
            "include_conversations": True,
            "include_analytics": False,
            "date_range": {
                "start_date": "2024-01-01T00:00:00Z",
                "end_date": "2024-12-31T23:59:59Z"
            }
        }
    
        response = await client.post("/api/v1/data-management/export",
                                   headers=auth_headers, json=export_data)
    
        # Should start export successfully or handle gracefully
>       assert response.status_code in [202, 422, 500]  # 202 = Accepted, others = graceful failures
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       assert 404 in [202, 422, 500]
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_integration.py:30: AssertionError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2NDFYQ0hLR1lFUDg2WlFUUjhEViIsImVtYWlsIjoidXNlcjhiYTIyYjE0QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOGJhMjJiMTQiLCJqdGkiOiIxYmFhNDQ1Mi1iMDlmLTQyOTQtODRhOC03NGNiYTI3YTRjNzciLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjE1LCJzZXNzaW9uX2lkIjoiN2RiZjA0NjQtMTRjNC00Njc2LWI1MjMtM2Y5MTA5OWRiYmNlIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MTV9.go5ngzKsfOXl02QOGvQGjmrEbJX6ByteNpdNlWDeC6g
______________ TestDataManagementIntegration.test_backup_workflow ______________

self = <tests.test_data_management_integration.TestDataManagementIntegration object at 0x72898436ac00>
client = <httpx.AsyncClient object at 0x728904f90860>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2NFdXOUVKRFI0VlNSTUYxN1pZRyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MTZ9.hulHjAN-NNwJ1HqY3vSSmHPxl4-SYj74DfCtvy5v3Ag'}

    @pytest.mark.integration
    async def test_backup_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test backup creation and listing workflow."""
        # Test backup creation
        backup_data = {
            "name": "Test Backup",
            "description": "Integration test backup",
            "backup_type": "full",
            "encrypt": False,
            "compress": True
        }
    
        response = await client.post("/api/v1/data-management/backup",
                                   headers=auth_headers, json=backup_data)
    
        # Should start backup or handle gracefully
>       assert response.status_code in [202, 422, 500]
E       assert 404 in [202, 422, 500]
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_integration.py:55: AssertionError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2NFdXOUVKRFI0VlNSTUYxN1pZRyIsImVtYWlsIjoidXNlcjA2MDJlOWIxQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMDYwMmU5YjEiLCJqdGkiOiI1YTIwYTdmNC1mZDg4LTQwNDktOTczYi05MWI1YjYxOTBmNjMiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjE2LCJzZXNzaW9uX2lkIjoiNTY3N2I4ODgtZjM5YS00NWUzLThhOTQtZDkyYTEyOGRlZjNjIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MTZ9.hulHjAN-NNwJ1HqY3vSSmHPxl4-SYj74DfCtvy5v3Ag
__________ TestDataManagementIntegration.test_storage_stats_workflow ___________

self = <tests.test_data_management_integration.TestDataManagementIntegration object at 0x72898436b380>
client = <httpx.AsyncClient object at 0x7288c72b51c0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2NkpIOE5NRDI1REZRMllTVDhTTSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MTd9._S3CSRFKViOQ2SX2rgzeZ7su0FmpZafy6t4PjfrIW54'}

    @pytest.mark.integration
    async def test_storage_stats_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test storage statistics workflow."""
        response = await client.get("/api/v1/data-management/stats",
                                  headers=auth_headers)
    
>       assert response.status_code in [200, 500]  # Should work or fail gracefully
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       assert 404 in [200, 500]
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_integration.py:99: AssertionError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2NkpIOE5NRDI1REZRMllTVDhTTSIsImVtYWlsIjoidXNlcjVmMWI2M2I0QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNWYxYjYzYjQiLCJqdGkiOiJmMTc5YTBjYS02ZGI5LTRhNGMtYjZkYS1mMzQ0OTAzZjM3ZTgiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjE3LCJzZXNzaW9uX2lkIjoiMzNjODFmYTEtOTBmZi00Yzg0LWE4YzUtM2FmN2E4YjU5ZWYzIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MTd9._S3CSRFKViOQ2SX2rgzeZ7su0FmpZafy6t4PjfrIW54
______ TestDataManagementIntegration.test_bulk_delete_documents_workflow _______

self = <tests.test_data_management_integration.TestDataManagementIntegration object at 0x72898436b740>
client = <httpx.AsyncClient object at 0x7288e4196f30>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2N0UwRFQ3OTE4QlNKUTNHVjlKMiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MTh9.2vMu-VP0aKWj7EkjayZfQHv4kuLzAgDvU8B4IwvMli4'}

    @pytest.mark.integration
    async def test_bulk_delete_documents_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test bulk document deletion workflow."""
        # Test with empty list
        delete_data = {"document_ids": []}
    
        response = await client.post("/api/v1/data-management/bulk/delete-documents",
                                   headers=auth_headers, json=delete_data)
    
>       assert response.status_code in [200, 422, 500]
E       assert 404 in [200, 422, 500]
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_integration.py:118: AssertionError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2N0UwRFQ3OTE4QlNKUTNHVjlKMiIsImVtYWlsIjoidXNlcjJhMDViYzJhQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMmEwNWJjMmEiLCJqdGkiOiI4MTU0MDg3Yy01NjU3LTQxNDItOTFhNS03ZWQ3ZGZmMThjMzkiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjE4LCJzZXNzaW9uX2lkIjoiNTQ3Y2Q0ZjItYTY0Mi00YjY0LTg5NzctMzU3ODQ1YmM4NDI4IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MTh9.2vMu-VP0aKWj7EkjayZfQHv4kuLzAgDvU8B4IwvMli4
____ TestDataManagementIntegration.test_bulk_delete_conversations_workflow _____

self = <tests.test_data_management_integration.TestDataManagementIntegration object at 0x72898436bb00>
client = <httpx.AsyncClient object at 0x7288c75cd820>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2ODk5OEdYUzdXMDRBMUU4QzlXWSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MTl9.rFbr_ZT5NFT021N7dgUgVqpPk9y0KzEGwrInV9M1eGU'}

    @pytest.mark.integration
    async def test_bulk_delete_conversations_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test bulk conversation deletion workflow."""
        # Test with empty list
        delete_data = {"conversation_ids": []}
    
        response = await client.post("/api/v1/data-management/bulk/delete-conversations",
                                   headers=auth_headers, json=delete_data)
    
>       assert response.status_code in [200, 422, 500]
E       assert 404 in [200, 422, 500]
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_integration.py:148: AssertionError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2ODk5OEdYUzdXMDRBMUU4QzlXWSIsImVtYWlsIjoidXNlcjA0Yzg4OTNiQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMDRjODg5M2IiLCJqdGkiOiJlY2ZjMmRhYi1mZWYzLTQyZmMtYjI5MS0wMDM0MDk0YjViMzciLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjE5LCJzZXNzaW9uX2lkIjoiZWYyN2FlZTctMTViOS00NDg4LTgzNDQtMTZmNGQ4MTdhYzY0IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MTl9.rFbr_ZT5NFT021N7dgUgVqpPk9y0KzEGwrInV9M1eGU
_______ TestDataManagementIntegration.test_bulk_delete_prompts_workflow ________

self = <tests.test_data_management_integration.TestDataManagementIntegration object at 0x72898436bec0>
client = <httpx.AsyncClient object at 0x7288e443aea0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2OTVBWko3SDBXWEg3WUM2MkRFRiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MjB9.lLKOGD8_4fv2eL-nA2GfWUQyuqN5Xiw1Ypz9QHGq-HI'}

    @pytest.mark.integration
    async def test_bulk_delete_prompts_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test bulk prompt deletion workflow."""
        # Test with empty list
        delete_data = {"prompt_ids": []}
    
        response = await client.post("/api/v1/data-management/bulk/delete-prompts",
                                   headers=auth_headers, json=delete_data)
    
>       assert response.status_code in [200, 422, 500]
E       assert 404 in [200, 422, 500]
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_integration.py:164: AssertionError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2OTVBWko3SDBXWEg3WUM2MkRFRiIsImVtYWlsIjoidXNlcjFkMTMyMDM5QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMWQxMzIwMzkiLCJqdGkiOiJmOGQ5YWFjZi0zYjZjLTQwZjctYmUwMy1jZWQ1NDA3MWMzNGYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjIwLCJzZXNzaW9uX2lkIjoiOWVkMmE2MmUtYTZjZi00YmYzLTk1NGUtNmJjNTc1MGI2YTk2IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MjB9.lLKOGD8_4fv2eL-nA2GfWUQyuqN5Xiw1Ypz9QHGq-HI
____ TestDataManagementIntegration.test_data_management_permission_workflow ____

self = <tests.test_data_management_integration.TestDataManagementIntegration object at 0x72898436b710>
client = <httpx.AsyncClient object at 0x7288e4280a70>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2QTAzMk1NRDZWUjQ1VkE3WDNNRCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MjF9.hu9rFnw3eESCOO1xbqfr6-dyBwIGBd0plHQoX2P_ajE'}

    @pytest.mark.integration
    async def test_data_management_permission_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test data management permission and access control workflow."""
        # Test without authentication - all should return 401
        response = await client.get("/api/v1/data-management/stats")
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_integration.py:176: AssertionError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2QTAzMk1NRDZWUjQ1VkE3WDNNRCIsImVtYWlsIjoidXNlcjQzNWE2OGQwQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNDM1YTY4ZDAiLCJqdGkiOiI3YzNhMzY4NS0xOTQ4LTQwZTktYmQwOC02MzdjNDlhNmI0YTAiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjIxLCJzZXNzaW9uX2lkIjoiYzlmNjQ0OWYtODgxOS00ZGFkLTgxZTctNWNiOGNhNjhlZjRhIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MjF9.hu9rFnw3eESCOO1xbqfr6-dyBwIGBd0plHQoX2P_ajE
________ TestDataManagementIntegration.test_cross_api_data_consistency _________

self = <tests.test_data_management_integration.TestDataManagementIntegration object at 0x72898436a900>
client = <httpx.AsyncClient object at 0x7288c73171a0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2QVY0U1hCNDZEVDVLMFIxSFBTOSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MjJ9.QwWie5G_T2YA0yCbSmeJL9zL00dXfcSCFggBlLKFaSI'}

    @pytest.mark.integration
    async def test_cross_api_data_consistency(self, client: AsyncClient, auth_headers: dict):
        """Test data consistency between documents and data management APIs."""
        # Get document stats
>       doc_response = await client.get("/api/v1/documents/stats/overview",
                                      headers=auth_headers)

tests/test_data_management_integration.py:201: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2509' coro=<TestDataManagementIntegration.test_cross_api_data_consistency() running at /home/yam/chatter/tests/test_data_management_integration.py:201> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2QVY0U1hCNDZEVDVLMFIxSFBTOSIsImVtYWlsIjoidXNlcjkzNzFlYjkwQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOTM3MWViOTAiLCJqdGkiOiIzMzc0ZTg3ZC01ZWM4LTRmODktODFlNC0wMTZlNTM4YjBjM2UiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjIyLCJzZXNzaW9uX2lkIjoiYTU5ODU0MWYtZThmZS00NjgzLTljZTAtMmRlNzgwZjNhNzlhIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MjJ9.QwWie5G_T2YA0yCbSmeJL9zL00dXfcSCFggBlLKFaSI
___________ TestDataManagementUnit.test_export_data_endpoint_exists ____________

self = <tests.test_data_management_unit.TestDataManagementUnit object at 0x72898438c4a0>
client = <httpx.AsyncClient object at 0x7288c58b5040>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2Qzc1TTBYMzhQSDNHNU1OSE1CQyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MjN9.zMAv3A2POCyGaNe35Brasj0OnQ_V7KcNeBWXDWFR-iA'}

    @pytest.mark.unit
    async def test_export_data_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that export data endpoint exists and validates authentication."""
        # Test with missing auth header - should get 401
        response = await client.post("/api/v1/data-management/export", json={})
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_unit.py:15: AssertionError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2Qzc1TTBYMzhQSDNHNU1OSE1CQyIsImVtYWlsIjoidXNlcmM5MTZlOTIzQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYzkxNmU5MjMiLCJqdGkiOiIxY2U2YjhiZS03NWUzLTQxMjktOWJlOC0yMzViYTU5MTAyMWMiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjIzLCJzZXNzaW9uX2lkIjoiOGFiNzAxM2EtOTk3Zi00ZjYyLWI1YWMtMmQ0NjE1OTY0MGY3IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MjN9.zMAv3A2POCyGaNe35Brasj0OnQ_V7KcNeBWXDWFR-iA
__________ TestDataManagementUnit.test_create_backup_endpoint_exists ___________

self = <tests.test_data_management_unit.TestDataManagementUnit object at 0x72898438c7d0>
client = <httpx.AsyncClient object at 0x7288c4856ff0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2RDFZQjYzUktLWUgxV1NSOTAzUiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MjR9.Lb4XPZN70J-FukUZIHjNCEzwupD46yMYOERHEBreHzY'}

    @pytest.mark.unit
    async def test_create_backup_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that create backup endpoint exists."""
        # Test without auth - should get 401
        response = await client.post("/api/v1/data-management/backup", json={})
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_unit.py:27: AssertionError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2RDFZQjYzUktLWUgxV1NSOTAzUiIsImVtYWlsIjoidXNlcmI0YjVlMjg4QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYjRiNWUyODgiLCJqdGkiOiI0NDMzNTMzNy0yZGQxLTQyYTMtYWM5Yy04ZDc2MmVlMmFlMjQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjI0LCJzZXNzaW9uX2lkIjoiYzdhNzgxZjItZDM0My00ODRlLWEyM2MtNWU3YzgwNDQ5NDBkIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MjR9.Lb4XPZN70J-FukUZIHjNCEzwupD46yMYOERHEBreHzY
___________ TestDataManagementUnit.test_list_backups_endpoint_exists ___________

self = <tests.test_data_management_unit.TestDataManagementUnit object at 0x72898438cb90>
client = <httpx.AsyncClient object at 0x7288c4aa1310>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2RFhLMk42WkVFRUNQNVhFVEtKRyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MjV9.HRjJA-GNcojzs6kXYwv7DY4VASSXoRpmfCGTdhIVDus'}

    @pytest.mark.unit
    async def test_list_backups_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that list backups endpoint exists."""
        # Test without auth
        response = await client.get("/api/v1/data-management/backups")
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_unit.py:39: AssertionError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2RFhLMk42WkVFRUNQNVhFVEtKRyIsImVtYWlsIjoidXNlcjU1NzI2ZGUzQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNTU3MjZkZTMiLCJqdGkiOiJkNDJhNzdmZS05NTRhLTQ5YzMtYmE3My00NjRlOTc1ZjY2NDQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjI1LCJzZXNzaW9uX2lkIjoiYTlkYTNiMTgtMGU1MC00OGRlLTlkZDUtNzRlZGVkMjNiY2I4IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MjV9.HRjJA-GNcojzs6kXYwv7DY4VASSXoRpmfCGTdhIVDus
___________ TestDataManagementUnit.test_restore_data_endpoint_exists ___________

self = <tests.test_data_management_unit.TestDataManagementUnit object at 0x72898438cf50>
client = <httpx.AsyncClient object at 0x7288c71f2d50>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2RVJQWFQwWTNQS0dZRUZQVzhIOCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MjZ9.UyheSj1QesD9cj8kUYlA5hUSq8mdRfIn6OTJPmQxHVo'}

    @pytest.mark.unit
    async def test_restore_data_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that restore data endpoint exists."""
        # Test without auth
        response = await client.post("/api/v1/data-management/restore", json={})
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_unit.py:52: AssertionError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2RVJQWFQwWTNQS0dZRUZQVzhIOCIsImVtYWlsIjoidXNlcjU3ODQ0NzkwQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNTc4NDQ3OTAiLCJqdGkiOiJjMDEzNzE5Yi04Yzk2LTRiOTQtYjJiYi0yZjhlZjkyMGJkYTYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjI2LCJzZXNzaW9uX2lkIjoiYmI2Yjg1MDctNGM5YS00M2JlLWE0YzQtN2IyYzU3ZWMzN2MxIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MjZ9.UyheSj1QesD9cj8kUYlA5hUSq8mdRfIn6OTJPmQxHVo
________ TestDataManagementUnit.test_get_storage_stats_endpoint_exists _________

self = <tests.test_data_management_unit.TestDataManagementUnit object at 0x72898438d310>
client = <httpx.AsyncClient object at 0x7288c4f31670>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2RktKSFhWNjZRNlg4ODBBN1pOUiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0Mjd9.GkwhKMvjC4PXAPLlbVGWzrR_gCCU36oaHHcb0o4bo18'}

    @pytest.mark.unit
    async def test_get_storage_stats_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that get storage stats endpoint exists."""
        # Test without auth
        response = await client.get("/api/v1/data-management/stats")
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_unit.py:64: AssertionError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2RktKSFhWNjZRNlg4ODBBN1pOUiIsImVtYWlsIjoidXNlcmFhYzA1NzE0QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYWFjMDU3MTQiLCJqdGkiOiIxNGZhMDhjYi0yMWFkLTRkNWQtOWU2NC1jMzRlY2YzM2NjN2IiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjI3LCJzZXNzaW9uX2lkIjoiNDYwMGE3MDUtODQ5Ny00OTJiLWI0ZjgtMmEyZGVhNmEyZGVkIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0Mjd9.GkwhKMvjC4PXAPLlbVGWzrR_gCCU36oaHHcb0o4bo18
______ TestDataManagementUnit.test_bulk_delete_documents_endpoint_exists _______

self = <tests.test_data_management_unit.TestDataManagementUnit object at 0x72898438d6d0>
client = <httpx.AsyncClient object at 0x7288c50fb500>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2R0U1RjU0MEZSRUNIMURDQTM3UiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0Mjh9.pJ5mgDpHcBMH9FlIEXYFIegV31Wr93Mz-4CED5N778Y'}

    @pytest.mark.unit
    async def test_bulk_delete_documents_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that bulk delete documents endpoint exists."""
        # Test without auth
        response = await client.post("/api/v1/data-management/bulk/delete-documents", json={})
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_unit.py:77: AssertionError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2R0U1RjU0MEZSRUNIMURDQTM3UiIsImVtYWlsIjoidXNlcjI4NDE3ZTc4QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMjg0MTdlNzgiLCJqdGkiOiIxNTQwZDEyZS0yM2U2LTRjYWMtYWE4OS1mNDUwY2RiMzg3NmEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjI4LCJzZXNzaW9uX2lkIjoiYTgyOGIwNzAtYzE3OS00ZTJmLTgwNGUtM2Q5OGQzODljMGNkIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0Mjh9.pJ5mgDpHcBMH9FlIEXYFIegV31Wr93Mz-4CED5N778Y
____ TestDataManagementUnit.test_bulk_delete_conversations_endpoint_exists _____

self = <tests.test_data_management_unit.TestDataManagementUnit object at 0x72898438da90>
client = <httpx.AsyncClient object at 0x7288c68990a0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2SDlISkdSSzJSMzVTQTQxWFcwMiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0Mjh9.99pKJwiYWE3AL7iR-5j5kPHlsuMR9OSZ68u7PS7QR1w'}

    @pytest.mark.unit
    async def test_bulk_delete_conversations_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that bulk delete conversations endpoint exists."""
        # Test without auth
        response = await client.post("/api/v1/data-management/bulk/delete-conversations", json={})
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_unit.py:89: AssertionError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2SDlISkdSSzJSMzVTQTQxWFcwMiIsImVtYWlsIjoidXNlcjBmMmZkYzA2QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMGYyZmRjMDYiLCJqdGkiOiI4YjcyMDcxYy04NjZkLTQwZTItODExNy0xYjI2YjNjMTRhM2UiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjI4LCJzZXNzaW9uX2lkIjoiZmRjYTFmZGEtY2M4Zi00ODk2LWI4YjEtMGY1M2JmNWNmNTBjIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0Mjh9.99pKJwiYWE3AL7iR-5j5kPHlsuMR9OSZ68u7PS7QR1w
_______ TestDataManagementUnit.test_bulk_delete_prompts_endpoint_exists ________

self = <tests.test_data_management_unit.TestDataManagementUnit object at 0x72898438de50>
client = <httpx.AsyncClient object at 0x7288c5b67110>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2SjRaTUtDUks0SjBXVEI2WlJQSiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0Mjl9.T5wwVwZa4PP4pGUPRqVdy8u8YabNdAbe1DB0NBBtO7I'}

    @pytest.mark.unit
    async def test_bulk_delete_prompts_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that bulk delete prompts endpoint exists."""
        # Test without auth
        response = await client.post("/api/v1/data-management/bulk/delete-prompts", json={})
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_unit.py:101: AssertionError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2SjRaTUtDUks0SjBXVEI2WlJQSiIsImVtYWlsIjoidXNlcjllMTMwMzhmQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOWUxMzAzOGYiLCJqdGkiOiJhYzFkNmUzNi1iZmVjLTQ3ZTAtOGUwMy02MDAyMWYzMjM0MGEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjI5LCJzZXNzaW9uX2lkIjoiMGVlNDcxMjItMGY5Zi00NzU2LWFhYWItYWNjYTIwYmYzZTdkIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0Mjl9.T5wwVwZa4PP4pGUPRqVdy8u8YabNdAbe1DB0NBBtO7I
____________ TestDocumentsIntegration.test_document_upload_workflow ____________

self = <tests.test_documents_integration.TestDocumentsIntegration object at 0x7289843b6cf0>
client = <httpx.AsyncClient object at 0x7288c4e9deb0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2UzI5NUcwRjU5VENERjdITTNKTSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MzZ9.-RsSzZW5N4i06AaRnrtwvy_87Ueu9xTE9ncW8WLR5i0'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288c54f0350>

    @pytest.mark.integration
    async def test_document_upload_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complete document upload workflow."""
        # Create a test file
        test_content = b"This is a test document for testing purposes. It contains some text that can be chunked and processed."
        test_file = io.BytesIO(test_content)
    
        # Upload document
        files = {"file": ("test.txt", test_file, "text/plain")}
        data = {
            "title": "Test Document",
            "description": "A test document for integration testing",
            "tags": '["test", "integration"]',
            "chunk_size": 100,
            "chunk_overlap": 20,
            "is_public": False
        }
    
>       response = await client.post("/api/v1/documents/upload",
                                   headers=auth_headers, files=files, data=data)

tests/test_documents_integration.py:34: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2749' coro=<TestDocumentsIntegration.test_document_upload_workflow() running at /home/yam/chatter/tests/test_documents_integration.py:34> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2UzI5NUcwRjU5VENERjdITTNKTSIsImVtYWlsIjoidXNlcmEwMDM5OGYxQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYTAwMzk4ZjEiLCJqdGkiOiI0Y2E2Zjg2MC1hNTUyLTQ3M2UtYTFjYS1mOGMwY2U5ZWNlMjMiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjM2LCJzZXNzaW9uX2lkIjoiZTZiZDdlYmMtZjdiMC00YmQyLWI2NDktMTkwYTMxZTk2ZTFlIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0MzZ9.-RsSzZW5N4i06AaRnrtwvy_87Ueu9xTE9ncW8WLR5i0
_______ TestDocumentsIntegration.test_document_list_and_search_workflow ________

self = <tests.test_documents_integration.TestDocumentsIntegration object at 0x7289843b6480>
client = <httpx.AsyncClient object at 0x7288c6c1ec60>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2VkZQWDhCMUhRRTY5SEs0UzdOTSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0Mzl9.n0lmPCrLTnj6Z98NAEsAKnQFL-7lTYc84byEQ91Zv0I'}

    @pytest.mark.integration
    async def test_document_list_and_search_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test document listing and search workflow."""
        # Get initial document list
>       response = await client.get("/api/v1/documents", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_integration.py:63: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2762' coro=<TestDocumentsIntegration.test_document_list_and_search_workflow() running at /home/yam/chatter/tests/test_documents_integration.py:63> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2VkZQWDhCMUhRRTY5SEs0UzdOTSIsImVtYWlsIjoidXNlcjU4NGMwMzBmQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNTg0YzAzMGYiLCJqdGkiOiI5YWU5ZjA3Ni0wZWNmLTRhMDEtYWQ5MS03NjZhMThjZjlhMzkiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjM5LCJzZXNzaW9uX2lkIjoiNjU0MmY5ZTktZjMwZi00NjdkLWI0MTQtMzJhMjM5ZDEyNWRmIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0Mzl9.n0lmPCrLTnj6Z98NAEsAKnQFL-7lTYc84byEQ91Zv0I
_____________ TestDocumentsIntegration.test_document_crud_workflow _____________

self = <tests.test_documents_integration.TestDocumentsIntegration object at 0x7289843b5790>
client = <httpx.AsyncClient object at 0x7288c5533950>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2V1RCMU1HRFgzVEREQUhKNVhIQSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NDB9.VsKTptc-MoaaUyuDSGSNjx_UtxiBZ35Uvvl3z97L4ms'}

    @pytest.mark.integration
    async def test_document_crud_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test document CRUD operations workflow."""
        # Since we might not have actual documents, test the endpoints respond appropriately
        test_document_id = "nonexistent-document-id"
    
        # Test GET document
>       response = await client.get(f"/api/v1/documents/{test_document_id}",
                                  headers=auth_headers)

tests/test_documents_integration.py:88: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2775' coro=<TestDocumentsIntegration.test_document_crud_workflow() running at /home/yam/chatter/tests/test_documents_integration.py:88> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2V1RCMU1HRFgzVEREQUhKNVhIQSIsImVtYWlsIjoidXNlcjQzNWNhNTdhQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNDM1Y2E1N2EiLCJqdGkiOiJmNDM3MTE2OC03ZDc5LTRhNDctOGNhNS03NTE0OTE1YTc1ZTkiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjQwLCJzZXNzaW9uX2lkIjoiMDI5MTNmYzMtOTcwYy00Mzg1LWE4NjYtYzRiZTA5OTY4ZjcxIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NDB9.VsKTptc-MoaaUyuDSGSNjx_UtxiBZ35Uvvl3z97L4ms
____________ TestDocumentsIntegration.test_document_chunks_workflow ____________

self = <tests.test_documents_integration.TestDocumentsIntegration object at 0x7289843b4dd0>
client = <httpx.AsyncClient object at 0x7288c50469f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2WTZCMkYxNEtLTjBTOFc5VkJUWCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NDJ9.7pABK4Su4g2jcZoREOIoEPu3ntFQrh1NTvfxC2OevH8'}

    @pytest.mark.integration
    async def test_document_chunks_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test document chunks retrieval workflow."""
        test_document_id = "nonexistent-document-id"
    
        # Test get document chunks
>       response = await client.get(f"/api/v1/documents/{test_document_id}/chunks",
                                  headers=auth_headers)

tests/test_documents_integration.py:109: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2788' coro=<TestDocumentsIntegration.test_document_chunks_workflow() running at /home/yam/chatter/tests/test_documents_integration.py:109> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2WTZCMkYxNEtLTjBTOFc5VkJUWCIsImVtYWlsIjoidXNlcjU3OTljMjM1QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNTc5OWMyMzUiLCJqdGkiOiJmNTZkMWFjOC1iMjY0LTQ2MTUtODliMC02YjgyYjY0ZTczZmEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjQyLCJzZXNzaW9uX2lkIjoiYTQyYTZkNDgtN2Y2Zi00YzE5LWEyOGItM2NlNzczNWZlYjBhIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NDJ9.7pABK4Su4g2jcZoREOIoEPu3ntFQrh1NTvfxC2OevH8
__________ TestDocumentsIntegration.test_document_processing_workflow __________

self = <tests.test_documents_integration.TestDocumentsIntegration object at 0x7289843b6ed0>
client = <httpx.AsyncClient object at 0x7288c70dc1a0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2Wk1SSlkzR01LTjk0QjhSS1RUNCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NDN9.sEodQHdGQupnEtKFHukEsJkR-yS0X_C1UyNeHdW1b3o'}

    @pytest.mark.integration
    async def test_document_processing_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test document processing workflow."""
        test_document_id = "nonexistent-document-id"
    
        # Test process document
        process_data = {"force_reprocess": False}
>       response = await client.post(f"/api/v1/documents/{test_document_id}/process",
                                   headers=auth_headers, json=process_data)

tests/test_documents_integration.py:125: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2801' coro=<TestDocumentsIntegration.test_document_processing_workflow() running at /home/yam/chatter/tests/test_documents_integration.py:125> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM2Wk1SSlkzR01LTjk0QjhSS1RUNCIsImVtYWlsIjoidXNlcmVhMzMzZjlmQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZWEzMzNmOWYiLCJqdGkiOiI5NTgwZmUwNy04MmRkLTRjNGQtOTlhYi1lNDE4YTk0N2ZkYWUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjQzLCJzZXNzaW9uX2lkIjoiNzgyYmJkMTItNGQ5Ni00ZTJmLThjMTQtNjBmMDRkMWI2M2JmIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NDN9.sEodQHdGQupnEtKFHukEsJkR-yS0X_C1UyNeHdW1b3o
____________ TestDocumentsIntegration.test_document_stats_workflow _____________

self = <tests.test_documents_integration.TestDocumentsIntegration object at 0x7289843b7290>
client = <httpx.AsyncClient object at 0x7288c5aad1c0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3MFoxUzUyQjc2RkdNUlowMVBBWSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NDR9.B6C_FyOI2HrRxgrFfrpz1MPcEA6zPZobewplGKpnfgo'}

    @pytest.mark.integration
    async def test_document_stats_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test document statistics workflow."""
        # Test get document stats
>       response = await client.get("/api/v1/documents/stats/overview",
                                  headers=auth_headers)

tests/test_documents_integration.py:138: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2814' coro=<TestDocumentsIntegration.test_document_stats_workflow() running at /home/yam/chatter/tests/test_documents_integration.py:138> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3MFoxUzUyQjc2RkdNUlowMVBBWSIsImVtYWlsIjoidXNlcjBmMmFiOWVkQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMGYyYWI5ZWQiLCJqdGkiOiIwYTQ2ZTZlNS0zZDQ3LTQ4Y2QtOTkwMS02YzVhY2Q3MTMxYTMiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjQ0LCJzZXNzaW9uX2lkIjoiMWIwNGI5MTgtZDIxNi00NzkyLThhYzktYmM0NzE5M2FlOTkwIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NDR9.B6C_FyOI2HrRxgrFfrpz1MPcEA6zPZobewplGKpnfgo
___________ TestDocumentsIntegration.test_document_download_workflow ___________

self = <tests.test_documents_integration.TestDocumentsIntegration object at 0x7289843b7650>
client = <httpx.AsyncClient object at 0x7288c6b446e0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3MkE4NU5IMkJFM1lTUzRONDVENyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NDZ9.gj7fx8uYFmI9a_sC3qveQpZNALZJMXFpcFJUdh18w_8'}

    @pytest.mark.integration
    async def test_document_download_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test document download workflow."""
        test_document_id = "nonexistent-document-id"
    
        # Test download document
>       response = await client.get(f"/api/v1/documents/{test_document_id}/download",
                                  headers=auth_headers)

tests/test_documents_integration.py:156: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2827' coro=<TestDocumentsIntegration.test_document_download_workflow() running at /home/yam/chatter/tests/test_documents_integration.py:156> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3MkE4NU5IMkJFM1lTUzRONDVENyIsImVtYWlsIjoidXNlcjE5ZTkzZjFiQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMTllOTNmMWIiLCJqdGkiOiJhMjc1ZjIxZS00YWM3LTQwZGEtYmMyMS1hM2VkMWIzZjY0MTUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjQ2LCJzZXNzaW9uX2lkIjoiZGZhNTllZWMtZjA3YS00NzZhLWE4M2QtMWMyODljYmJjYzMwIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NDZ9.gj7fx8uYFmI9a_sC3qveQpZNALZJMXFpcFJUdh18w_8
__________ TestDocumentsIntegration.test_document_permission_workflow __________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c6609ee0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c6609ee0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_integration.TestDocumentsIntegration object at 0x7289843b7a10>
client = <httpx.AsyncClient object at 0x7288c6609670>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3NEpaRTdWSkMzRTdGUkJQNUZUNCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NDh9.1xoeXqzhlzXQ3JGtKEFux6uEETTG0-mBaWyVv27kLjc'}

    @pytest.mark.integration
    async def test_document_permission_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test document permission and access control workflow."""
        # This test verifies that authenticated requests work and unauthenticated don't
    
        # Test without authentication
>       response = await client.get("/api/v1/documents")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_integration.py:166: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c6609ee0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3NEpaRTdWSkMzRTdGUkJQNUZUNCIsImVtYWlsIjoidXNlcjc1MGMxZGE2QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNzUwYzFkYTYiLCJqdGkiOiI0YzUzMTI0OC0zY2E0LTQ0MmMtOGE4OC0xMTY0MmQ3ZmFlNGQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjQ4LCJzZXNzaW9uX2lkIjoiOWM3M2FhMWYtNTM0OS00MGUwLTg5MTUtOTBjNmU5Nzk3NGRjIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NDh9.1xoeXqzhlzXQ3JGtKEFux6uEETTG0-mBaWyVv27kLjc
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:44:08.694950Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m785d3b2a-f152-44ba-b580-101a61f49e22[0m [36mstatus_code[0m=[35m401[0m
____________ TestDocumentsUnit.test_upload_document_endpoint_exists ____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c723dac0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c723dac0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7289843d4440>
client = <httpx.AsyncClient object at 0x7288c723cc20>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3NU4wVlNGV0pKNTIwVDgzM0hONSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NDl9.e6jH_vgWZTjgEloqQc9_WeXzQFiqOzNOARlOieE6tIY'}

    @pytest.mark.unit
    async def test_upload_document_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that upload document endpoint exists and validates authentication."""
        # Test with missing auth header - should get 401
>       response = await client.post("/api/v1/documents/upload")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:15: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c723dac0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3NU4wVlNGV0pKNTIwVDgzM0hONSIsImVtYWlsIjoidXNlcmU1ZTlmZDljQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZTVlOWZkOWMiLCJqdGkiOiI4ZGRhNjU4Ny04MjEyLTQ5ZDktODcyMy0wZDhkNjdiODM4M2EiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjQ5LCJzZXNzaW9uX2lkIjoiYzZmZjAyNTYtMzI0Yy00Y2MzLThkZDgtNDQ4ZjNiODdhOGMxIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NDl9.e6jH_vgWZTjgEloqQc9_WeXzQFiqOzNOARlOieE6tIY
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:44:09.781812Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m5492b51c-2421-4741-a65b-50b6a6751933[0m [36mstatus_code[0m=[35m401[0m
____________ TestDocumentsUnit.test_list_documents_endpoint_exists _____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288e7fe9250>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288e7fe9250>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7289843d4770>
client = <httpx.AsyncClient object at 0x7288e7fe82c0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3NlBWTTU4QUhTQURRUlI0M1lNWiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTB9.8kEitjyk072Oztn4JPJFu8MY3a1YNVvja2gTcZzwwJw'}

    @pytest.mark.unit
    async def test_list_documents_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that list documents endpoint exists."""
        # Test without auth - should get 401
>       response = await client.get("/api/v1/documents")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:26: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288e7fe9250>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3NlBWTTU4QUhTQURRUlI0M1lNWiIsImVtYWlsIjoidXNlcjQ3MWQxZjVlQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNDcxZDFmNWUiLCJqdGkiOiIyMDg5OTljNy1iODRlLTQwNWItYWEzZi0yNWY3NDM4YTU2MWMiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjUwLCJzZXNzaW9uX2lkIjoiMmRiMzc4MWMtM2YyMS00MTkzLThlNWQtMzNjZjM3NGI0ZDFhIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTB9.8kEitjyk072Oztn4JPJFu8MY3a1YNVvja2gTcZzwwJw
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:44:10.863496Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m855edbb3-e648-456c-9746-7e01addf1b8f[0m [36mstatus_code[0m=[35m401[0m
___________ TestDocumentsUnit.test_search_documents_endpoint_exists ____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289686410d0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289686410d0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7289843d4b90>
client = <httpx.AsyncClient object at 0x728904127a70>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3N1JCOURRQ0VWME1QVksxVEVEOSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTF9.6ilkoxtI7Y46iirc0FHA33TB9MA6I8zmMNKNyq7K3Rg'}

    @pytest.mark.unit
    async def test_search_documents_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that search documents endpoint exists."""
        # Test without auth
>       response = await client.post("/api/v1/documents/search", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:38: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289686410d0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3N1JCOURRQ0VWME1QVksxVEVEOSIsImVtYWlsIjoidXNlcjU5YzhhYTkyQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNTljOGFhOTIiLCJqdGkiOiI5ZGNlY2VkMi0wMjE1LTQzOTctYmNhMS0wZmVjM2NlM2VlNDgiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjUxLCJzZXNzaW9uX2lkIjoiN2RiZWQxZmQtZWVhNS00YjQ3LWJiOTktYmM2YzRlMDUxOTE0IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTF9.6ilkoxtI7Y46iirc0FHA33TB9MA6I8zmMNKNyq7K3Rg
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:44:11.937212Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m810dedbe-cbcc-42a2-863c-45773aed3c1c[0m [36mstatus_code[0m=[35m401[0m
_____________ TestDocumentsUnit.test_get_document_endpoint_exists ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728944c2bb00>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728944c2bb00>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7289843d4f50>
client = <httpx.AsyncClient object at 0x728944c2a810>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3OFNQRk1INU01SENQUEZORUFSNyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTJ9.2YjAQ0Mzy_I1MDAIolaTlExz-0Kd3M0YebjUBAtPs_Q'}

    @pytest.mark.unit
    async def test_get_document_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that get document endpoint exists."""
        # Test without auth
>       response = await client.get("/api/v1/documents/nonexistent-id")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:50: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728944c2bb00>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3OFNQRk1INU01SENQUEZORUFSNyIsImVtYWlsIjoidXNlcjQ1MzUzMzA0QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNDUzNTMzMDQiLCJqdGkiOiJmZGI2NTBhNC03NDA1LTQ5ZWEtYTYyMy1kMmZmYmQ3OWUwOGQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjUyLCJzZXNzaW9uX2lkIjoiNzRkZWMxM2YtYWUzNC00OTM0LTkzNzMtNDEzNGNmMDUyNGY0IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTJ9.2YjAQ0Mzy_I1MDAIolaTlExz-0Kd3M0YebjUBAtPs_Q
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:44:13.001689Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m8bd2291c-3b01-4e26-8169-436cdab8ca91[0m [36mstatus_code[0m=[35m401[0m
____________ TestDocumentsUnit.test_delete_document_endpoint_exists ____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289401a4e60>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289401a4e60>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7289843b7950>
client = <httpx.AsyncClient object at 0x7289401a6600>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3OVYxS045TUpUNkFHV00zUEY2MiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTR9.k6ywF_SaXp1JuhWuJgcTm2b5V5cAxHC-ln58i9ja14E'}

    @pytest.mark.unit
    async def test_delete_document_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that delete document endpoint exists."""
        # Test without auth
>       response = await client.delete("/api/v1/documents/nonexistent-id")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:62: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1966: in delete
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7289401a4e60>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3OVYxS045TUpUNkFHV00zUEY2MiIsImVtYWlsIjoidXNlcmQ1ODg0MWY1QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZDU4ODQxZjUiLCJqdGkiOiJiM2Q1N2ZmMS1kYWQ1LTRkZWEtOTZlNS04NTNkMDdhNTMwODAiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjU0LCJzZXNzaW9uX2lkIjoiOGM2ODU0MTctNzI0NS00Yjk3LTkwYWMtNjk3YmEyODc4MDlhIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTR9.k6ywF_SaXp1JuhWuJgcTm2b5V5cAxHC-ln58i9ja14E
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:44:14.071660Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m24addb34-aa21-4e16-9cfe-ad5cd981ca78[0m [36mstatus_code[0m=[35m401[0m
____________ TestDocumentsUnit.test_update_document_endpoint_exists ____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288e7f736b0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288e7f736b0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7289843b7380>
client = <httpx.AsyncClient object at 0x7288e7f71e80>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3QVdBQlQ5SEtLRVFLMDBQS1NRMiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTV9.Ss-HQzg6hBPAssaMksmyOWHCRGs3mdIN8LyPCuWyegU'}

    @pytest.mark.unit
    async def test_update_document_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that update document endpoint exists."""
        # Test without auth
>       response = await client.put("/api/v1/documents/nonexistent-id", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1896: in put
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288e7f736b0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3QVdBQlQ5SEtLRVFLMDBQS1NRMiIsImVtYWlsIjoidXNlcjNhNjQ2YTc1QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyM2E2NDZhNzUiLCJqdGkiOiI1MmM5ZmEzMC05YzcyLTQzYWMtYmJhZC1kNGIyOWNkYWZiY2EiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjU1LCJzZXNzaW9uX2lkIjoiNjI3NzM3M2QtMTNmNS00N2IyLWIzM2MtYjE0M2UwY2M0YjhlIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTV9.Ss-HQzg6hBPAssaMksmyOWHCRGs3mdIN8LyPCuWyegU
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:44:15.137077Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m73d0ced1-86e6-466f-9034-8222e6d86f52[0m [36mstatus_code[0m=[35m401[0m
__________ TestDocumentsUnit.test_get_document_chunks_endpoint_exists __________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728904fa1190>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728904fa1190>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7289843d53d0>
client = <httpx.AsyncClient object at 0x728904fde990>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3Qlg1V0FBRDlIMUVIODVRQk5aOSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTZ9.XTvzc7QEGT0mBthvPwlSmOG_Z0hstd_p7uTtGwZV-A8'}

    @pytest.mark.unit
    async def test_get_document_chunks_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that get document chunks endpoint exists."""
        # Test without auth
>       response = await client.get("/api/v1/documents/nonexistent-id/chunks")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:86: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728904fa1190>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3Qlg1V0FBRDlIMUVIODVRQk5aOSIsImVtYWlsIjoidXNlcmM5NTMyYzJmQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYzk1MzJjMmYiLCJqdGkiOiJlNDJhZDdjZS0zY2E1LTQ4N2QtOTc0YS0xZTExNjc1ZDk2NGEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjU2LCJzZXNzaW9uX2lkIjoiN2VkNDY2ZmMtZmYyNy00Y2M2LWE1ODAtZmYzNGI5MDllN2I5IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTZ9.XTvzc7QEGT0mBthvPwlSmOG_Z0hstd_p7uTtGwZV-A8
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:44:16.185257Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m97499b3d-3154-4ec6-bc24-817e96b593ff[0m [36mstatus_code[0m=[35m401[0m
___________ TestDocumentsUnit.test_process_document_endpoint_exists ____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728904f2e330>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728904f2e330>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7289843d5010>
client = <httpx.AsyncClient object at 0x728904f2ed50>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3Q1lQQ1dUVEIzU1I1WDhDUE1LQSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTd9.T0RQtxWYHbr9yzmtmUDBJ4ZqeFNXHT8tPTJ_E1YTVkY'}

    @pytest.mark.unit
    async def test_process_document_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that process document endpoint exists."""
        # Test without auth
>       response = await client.post("/api/v1/documents/nonexistent-id/process", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:98: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728904f2e330>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3Q1lQQ1dUVEIzU1I1WDhDUE1LQSIsImVtYWlsIjoidXNlcjU2OTQyNWRhQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNTY5NDI1ZGEiLCJqdGkiOiIzZTVmMmRlNS04MzA4LTQwZGYtYjllOS0xNjg1NmY5ODViMjgiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjU3LCJzZXNzaW9uX2lkIjoiN2MwZTE3ZGEtM2FjZC00YjlhLWIxOTYtMDRmNDFiNzA4Mzc1IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTd9.T0RQtxWYHbr9yzmtmUDBJ4ZqeFNXHT8tPTJ_E1YTVkY
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:44:17.259413Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m816d42d9-f642-4f83-a40b-9ff9f4262741[0m [36mstatus_code[0m=[35m401[0m
__________ TestDocumentsUnit.test_get_document_stats_endpoint_exists ___________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288e7471cd0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288e7471cd0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7289843d44a0>
client = <httpx.AsyncClient object at 0x728946405460>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3RFpTNTYyOTlSWlk4VlBHWUFUMSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTh9.mWrNs5AuPp5rz_HGiw2aCU2_Kzp4UnZRvacTEWoh0iI'}

    @pytest.mark.unit
    async def test_get_document_stats_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that get document stats endpoint exists."""
        # Test without auth
>       response = await client.get("/api/v1/documents/stats/overview")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:110: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288e7471cd0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3RFpTNTYyOTlSWlk4VlBHWUFUMSIsImVtYWlsIjoidXNlcjFhNGJhOWFlQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMWE0YmE5YWUiLCJqdGkiOiJjNzgwNTMxMi01OTU1LTQ4MzItOTM4OC02N2NmMzc4YjZmMjQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjU4LCJzZXNzaW9uX2lkIjoiOTg0Mjk5Y2ItZGM5YS00YmY3LTkxZTktYmQ3MzQ3OTY4NmIxIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTh9.mWrNs5AuPp5rz_HGiw2aCU2_Kzp4UnZRvacTEWoh0iI
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:44:18.318456Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mb70fc496-fd67-457d-b3e1-9cd578b7579a[0m [36mstatus_code[0m=[35m401[0m
___________ TestDocumentsUnit.test_download_document_endpoint_exists ___________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288e5a6b590>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288e5a6b590>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7289843d58e0>
client = <httpx.AsyncClient object at 0x7288e5a6a690>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3RjFBWVNYQVhZWkVZUkdTVlBBVyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTl9.009XT1FNNCj8z00M5IvhxNi-Orz5IurW6S2eVZ5fv3Y'}

    @pytest.mark.unit
    async def test_download_document_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that download document endpoint exists."""
        # Test without auth
>       response = await client.get("/api/v1/documents/nonexistent-id/download")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:123: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288e5a6b590>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3RjFBWVNYQVhZWkVZUkdTVlBBVyIsImVtYWlsIjoidXNlcjJmMDM4NDJiQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMmYwMzg0MmIiLCJqdGkiOiJkZDZkNGIwZS1iYTc3LTQ5NWMtYTUzMi1hYzg2OWU1M2Y0NTgiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjU5LCJzZXNzaW9uX2lkIjoiZjFiY2JiZDItYzc2OS00YzdjLWJiZGQtNTA1YThmNmY1MDJlIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NTl9.009XT1FNNCj8z00M5IvhxNi-Orz5IurW6S2eVZ5fv3Y
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:44:19.392211Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35me0d0b14c-4003-4621-b734-1c13d3d0703f[0m [36mstatus_code[0m=[35m401[0m
______________ TestEventsIntegration.test_events_stream_workflow _______________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7289843d63f0>
client = <httpx.AsyncClient object at 0x7288c6d06630>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3RzJYWlg2TlFSNzc1SDRBRDFSWSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NjB9.b_FNpVOqFZnSEFMqNGWRH8zwBlSLx08Yikg9LTWop7U'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288e5a6ab40>

    @pytest.mark.integration
    async def test_events_stream_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complete events stream workflow."""
        # Test SSE stream connection
>       response = await client.get("/api/v1/events/stream", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_integration.py:18: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2983' coro=<TestEventsIntegration.test_events_stream_workflow() running at /home/yam/chatter/tests/test_events_integration.py:18> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3RzJYWlg2TlFSNzc1SDRBRDFSWSIsImVtYWlsIjoidXNlcmEzOTdjOGRmQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYTM5N2M4ZGYiLCJqdGkiOiI3MGUwOWU0Zi1hOWFmLTQ2OWItOTdiYi0zZWUzNWZjY2UxYTEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjYwLCJzZXNzaW9uX2lkIjoiZTVlMmIwZTktNjgwYS00YTBmLWJjNjUtNWFlYTdlMDRmNjFjIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NjB9.b_FNpVOqFZnSEFMqNGWRH8zwBlSLx08Yikg9LTWop7U
_____________ TestEventsIntegration.test_events_stats_real_service _____________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7289843d6720>
client = <httpx.AsyncClient object at 0x7288e74709b0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3SkZHOFRZOTY0RDdSQjBSUEJDWSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NjJ9.HiNTJr7_kSqMITG-6-bFgu3X3NBR8EjCJDtxOyKgHtI'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288e5af2330>

    @pytest.mark.integration
    async def test_events_stats_real_service(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test events stats with real SSE service."""
>       response = await client.get("/api/v1/events/stats", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_integration.py:29: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2996' coro=<TestEventsIntegration.test_events_stats_real_service() running at /home/yam/chatter/tests/test_events_integration.py:29> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3SkZHOFRZOTY0RDdSQjBSUEJDWSIsImVtYWlsIjoidXNlcjk2MjZjZTY4QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOTYyNmNlNjgiLCJqdGkiOiJiNjBhZjI0YS01ZDQyLTQ1YzItYWYyMC01Y2RmOGVmYTg0YTMiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjYyLCJzZXNzaW9uX2lkIjoiYjY5MjQyYmMtODdhZi00MmQ2LWE0NWYtMzM0YzdlMjNlN2YyIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NjJ9.HiNTJr7_kSqMITG-6-bFgu3X3NBR8EjCJDtxOyKgHtI
_______________ TestEventsIntegration.test_test_event_end_to_end _______________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7289843d6ae0>
client = <httpx.AsyncClient object at 0x728904e49040>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3TUI3N1ZRQVMxSkFOVFFOUVBYVCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NjR9.NRA8dCShyyhGd7TMt5xcTVgLpn90WiKX7kfkvM7VOhw'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288e5af23f0>

    @pytest.mark.integration
    async def test_test_event_end_to_end(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test sending test event end-to-end."""
        test_data = {
            "event_type": "integration.test",
            "data": {
                "message": "Integration test message",
                "test_id": "test-123",
                "timestamp": "2024-01-01T12:00:00Z"
            },
            "user_id": "integration-test-user"
        }
    
>       response = await client.post(
            "/api/v1/events/test-event",
            json=test_data,
            headers=auth_headers
        )

tests/test_events_integration.py:54: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3009' coro=<TestEventsIntegration.test_test_event_end_to_end() running at /home/yam/chatter/tests/test_events_integration.py:54> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3TUI3N1ZRQVMxSkFOVFFOUVBYVCIsImVtYWlsIjoidXNlcjc2MGNhMDViQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNzYwY2EwNWIiLCJqdGkiOiJhMDhjNzc3Mi1mZWY4LTRiNWUtOWNmMC0xZmUxYzYyNDVlYWIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjY0LCJzZXNzaW9uX2lkIjoiZGRjYjY2MDYtODUwYy00MmVmLTkyYjQtYTM0YWNlMmY1NTdiIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NjR9.NRA8dCShyyhGd7TMt5xcTVgLpn90WiKX7kfkvM7VOhw
_____________ TestEventsIntegration.test_broadcast_test_end_to_end _____________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7289843d6ea0>
client = <httpx.AsyncClient object at 0x7288e5e85130>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3TlhLUUo2R0VOS1A2SjVGUDE3WiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NjZ9.cvg6XtZ6D3b5bsh6OizQaxHuD4u1UHsMcrGUGDJekz0'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x728904ec3d10>

    @pytest.mark.integration
    async def test_broadcast_test_end_to_end(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test broadcast test event end-to-end."""
        test_data = {
            "event_type": "integration.broadcast",
            "data": {
                "message": "Integration broadcast message",
                "test_id": "broadcast-123"
            }
        }
    
>       response = await client.post(
            "/api/v1/events/broadcast-test",
            json=test_data,
            headers=auth_headers
        )

tests/test_events_integration.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3022' coro=<TestEventsIntegration.test_broadcast_test_end_to_end() running at /home/yam/chatter/tests/test_events_integration.py:78> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3TlhLUUo2R0VOS1A2SjVGUDE3WiIsImVtYWlsIjoidXNlcjhlYTUyMGE4QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOGVhNTIwYTgiLCJqdGkiOiJlZmUxNzdiYy00NmQ4LTQxYjYtYjc5ZS00ZWY3ZjY1NjJjNDAiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjY2LCJzZXNzaW9uX2lkIjoiOGRmZmM0MjYtZWEyMi00MzM0LWExNDUtMGI2M2YxYTgzN2FkIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NjZ9.cvg6XtZ6D3b5bsh6OizQaxHuD4u1UHsMcrGUGDJekz0
_____________ TestEventsIntegration.test_multiple_sse_connections ______________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7289843d7260>
client = <httpx.AsyncClient object at 0x7288e5bd2330>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3UUZQNlJDVFZSWlNaNVNXMDdNNCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0Njh9.ba8lRG3xOAvxXsrhXsxtTUnFUn4aVRbKT1fpAS4TPs4'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x728904ec3560>

    @pytest.mark.integration
    async def test_multiple_sse_connections(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test multiple SSE connections from same user."""
        # Create multiple concurrent SSE connection attempts
        tasks = []
        for i in range(3):
            task = asyncio.create_task(
                client.get("/api/v1/events/stream", headers=auth_headers)
            )
            tasks.append(task)
    
        # Wait for all connections with timeout
        try:
>           responses = await asyncio.wait_for(asyncio.gather(*tasks), timeout=10.0)
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_integration.py:103: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib64/python3.12/asyncio/tasks.py:520: in wait_for
    return await fut
           ^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3036' coro=<AsyncClient.get() running at /home/yam/.local/lib/python3.12/site-packages/httpx/_client.py:1768> cb=[gather.<locals>._done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:767]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3UUZQNlJDVFZSWlNaNVNXMDdNNCIsImVtYWlsIjoidXNlcmExMGZlMTQyQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYTEwZmUxNDIiLCJqdGkiOiIxNmVhOTJkYi01MzdmLTRmOTMtYjI0NS1mMDM2ZmY5ODg4YjYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjY4LCJzZXNzaW9uX2lkIjoiYmNlYWYxMzctYTFhOS00OWExLWJhYjktNThmMzQ1OTQ4MWI3IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0Njh9.ba8lRG3xOAvxXsrhXsxtTUnFUn4aVRbKT1fpAS4TPs4
___________ TestEventsIntegration.test_events_workflow_with_database ___________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7289843d7620>
client = <httpx.AsyncClient object at 0x7289041062d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3UzJBUk1GMzROMFQyNVFUOFpGQiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0Njl9.vX3X-EbGXNp43W12fL8SpZM3s_x05qfyfFk9moUO9j8'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288e7fa8320>

    @pytest.mark.integration
    async def test_events_workflow_with_database(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test events workflow with database persistence."""
        # First, get initial stats
>       stats_response = await client.get("/api/v1/events/stats", headers=auth_headers)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_integration.py:120: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3051' coro=<TestEventsIntegration.test_events_workflow_with_database() running at /home/yam/chatter/tests/test_events_integration.py:120> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3UzJBUk1GMzROMFQyNVFUOFpGQiIsImVtYWlsIjoidXNlcjRkNTNiYTA2QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNGQ1M2JhMDYiLCJqdGkiOiI4MmJiZTM2NS00N2FmLTQ2ODAtODRjMi04ZTE2MTA4ZmViZDQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjY5LCJzZXNzaW9uX2lkIjoiNGZjMzljMGUtMDA3Zi00YzRiLWE3YzktZmEzZGU3ZGE4NmQ5IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0Njl9.vX3X-EbGXNp43W12fL8SpZM3s_x05qfyfFk9moUO9j8
___________ TestEventsIntegration.test_event_validation_integration ____________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7289843d7740>
client = <httpx.AsyncClient object at 0x7288c6fb2030>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3VEdQNk1TMjhQVFdBTkdGSlk4NSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NzF9.iFGHJ4256EH1EKdasw3kssRP7wQ_orKzymDosDByJ2A'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x72895b8bfb60>

    @pytest.mark.integration
    async def test_event_validation_integration(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test event data validation in integration environment."""
        # Test valid event types
        valid_event_types = [
            "user.login",
            "user.logout",
            "message.sent",
            "system.alert",
            "custom.event"
        ]
    
        for event_type in valid_event_types:
            test_data = {
                "event_type": event_type,
                "data": {"valid": True, "type": event_type},
                "user_id": "validation-test-user"
            }
    
>           response = await client.post(
                "/api/v1/events/test-event",
                json=test_data,
                headers=auth_headers
            )

tests/test_events_integration.py:169: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3064' coro=<TestEventsIntegration.test_event_validation_integration() running at /home/yam/chatter/tests/test_events_integration.py:169> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3VEdQNk1TMjhQVFdBTkdGSlk4NSIsImVtYWlsIjoidXNlcjY5ODE5NzRkQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNjk4MTk3NGQiLCJqdGkiOiI3OTM4OTdjNC00YmEyLTQ2ZjItYTlhZS01MmIyYTZlODJlZWIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjcxLCJzZXNzaW9uX2lkIjoiMDNiMDk3NWQtOGI1NS00ODQxLWIzN2UtMjI0MWQ2OGRkMGU2IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NzF9.iFGHJ4256EH1EKdasw3kssRP7wQ_orKzymDosDByJ2A
_____________ TestEventsIntegration.test_event_data_serialization ______________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7289843d7320>
client = <httpx.AsyncClient object at 0x7288e58765d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3Vlc2TThRVlFEOVBBTThUTkFSUyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NzJ9.ywPGSMNOfU1A4Cd6CnL4VX2wp-UkeBHHw-lAAfWKd9M'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288c64ee6f0>

    @pytest.mark.integration
    async def test_event_data_serialization(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complex event data serialization."""
        complex_data = {
            "event_type": "complex.data.test",
            "data": {
                "nested_object": {
                    "level1": {
                        "level2": {"value": 42}
                    }
                },
                "array_data": [1, 2, 3, "string", {"nested": True}],
                "unicode_text": "Hello 世界 🌍",
                "numbers": {
                    "integer": 123,
                    "float": 45.67,
                    "negative": -89
                },
                "boolean_values": {
                    "true_val": True,
                    "false_val": False
                },
                "null_value": None
            },
            "user_id": "serialization-test-user"
        }
    
>       response = await client.post(
            "/api/v1/events/test-event",
            json=complex_data,
            headers=auth_headers
        )

tests/test_events_integration.py:203: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3077' coro=<TestEventsIntegration.test_event_data_serialization() running at /home/yam/chatter/tests/test_events_integration.py:203> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3Vlc2TThRVlFEOVBBTThUTkFSUyIsImVtYWlsIjoidXNlcjc3YzAwYzg3QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNzdjMDBjODciLCJqdGkiOiI4MDRkZTUxMi02Y2M4LTQwMWUtYWIyMS03YjVhZjk2NjUyOGQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjcyLCJzZXNzaW9uX2lkIjoiZWYxZTI0NzItMmM5My00MDNjLTk2M2QtYzllNWU3MjhlZTRjIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NzJ9.ywPGSMNOfU1A4Cd6CnL4VX2wp-UkeBHHw-lAAfWKd9M
____________ TestEventsIntegration.test_concurrent_event_operations ____________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7289843d6810>
client = <httpx.AsyncClient object at 0x7288c65306e0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3WDc3SERDOERGUlFaMDdNQ0ZONiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NzN9.IDzp8Cx5VlBAm0OPPBQpnN3Svb386QWwSJ37mbH4DAc'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288c762d5e0>

    @pytest.mark.integration
    async def test_concurrent_event_operations(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test concurrent event operations."""
        # Create concurrent tasks for different operations
        tasks = []
    
        # Add stats requests
        for i in range(2):
            task = asyncio.create_task(
                client.get("/api/v1/events/stats", headers=auth_headers)
            )
            tasks.append(task)
    
        # Add test events
        for i in range(3):
            test_data = {
                "event_type": f"concurrent.test.{i}",
                "data": {"concurrent_id": i, "test": "concurrent"},
                "user_id": f"concurrent-user-{i}"
            }
            task = asyncio.create_task(
                client.post("/api/v1/events/test-event", json=test_data, headers=auth_headers)
            )
            tasks.append(task)
    
        # Add broadcast tests
        for i in range(2):
            broadcast_data = {
                "event_type": f"concurrent.broadcast.{i}",
                "data": {"broadcast_id": i, "test": "concurrent"}
            }
            task = asyncio.create_task(
                client.post("/api/v1/events/broadcast-test", json=broadcast_data, headers=auth_headers)
            )
            tasks.append(task)
    
        # Wait for all operations to complete
>       responses = await asyncio.gather(*tasks)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_integration.py:251: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3091' coro=<AsyncClient.get() running at /home/yam/.local/lib/python3.12/site-packages/httpx/_client.py:1768> cb=[gather.<locals>._done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:767]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3WDc3SERDOERGUlFaMDdNQ0ZONiIsImVtYWlsIjoidXNlcjM5ODI2NGY5QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMzk4MjY0ZjkiLCJqdGkiOiJjNzIxZTk0Ni04MmVlLTQwNjgtYjY0YS1mMmRlNTgxMTExZWYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjczLCJzZXNzaW9uX2lkIjoiMzU3OGNiMDAtOTE2OS00MzE4LWExODctMDBkZTVlNjg1OWQ4IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NzN9.IDzp8Cx5VlBAm0OPPBQpnN3Svb386QWwSJ37mbH4DAc
______________ TestEventsIntegration.test_sse_connection_cleanup _______________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7289843d4500>
client = <httpx.AsyncClient object at 0x7288e42a56d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3WksxTk5HVlA2RFowOEpWSFhUUCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NzZ9.pyU3KpGz07KuAeGANvHEL29-xd1UEvhv43Ki9lyqvXc'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288c65af230>

    @pytest.mark.integration
    async def test_sse_connection_cleanup(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test SSE connection cleanup behavior."""
        # Get initial connection count
>       stats_response = await client.get("/api/v1/events/stats", headers=auth_headers)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_integration.py:261: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3110' coro=<TestEventsIntegration.test_sse_connection_cleanup() running at /home/yam/chatter/tests/test_events_integration.py:261> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM3WksxTk5HVlA2RFowOEpWSFhUUCIsImVtYWlsIjoidXNlcmYyODBhYzNhQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZjI4MGFjM2EiLCJqdGkiOiJkZGIwOGUyOC02ZjIxLTRjZjEtYjk0My0wYzlkZGIyMDM2YTQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjc2LCJzZXNzaW9uX2lkIjoiMzA1OWVjNTctNGQ2Zi00NTY0LWI2MzQtNzAxOTE1NWU5ODBiIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0NzZ9.pyU3KpGz07KuAeGANvHEL29-xd1UEvhv43Ki9lyqvXc
_______________ TestEventsUnit.test_events_stream_requires_auth ________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728905a20ef0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728905a20ef0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_events_unit.TestEventsUnit object at 0x7289843ecfb0>
client = <httpx.AsyncClient object at 0x728905a201a0>

    @pytest.mark.unit
    async def test_events_stream_requires_auth(self, client: AsyncClient):
        """Test that events stream requires authentication."""
>       response = await client.get("/api/v1/events/stream")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:18: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728905a20ef0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:44:37.529074Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35ma1faddc6-4dd2-4517-9a22-a235d4b8e26b[0m [36mstatus_code[0m=[35m401[0m
________________ TestEventsUnit.test_admin_stream_requires_auth ________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c65e3770>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c65e3770>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_events_unit.TestEventsUnit object at 0x7289843ed2b0>
client = <httpx.AsyncClient object at 0x7288c65e29f0>

    @pytest.mark.unit
    async def test_admin_stream_requires_auth(self, client: AsyncClient):
        """Test that admin events stream requires authentication."""
>       response = await client.get("/api/v1/events/admin/stream")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:24: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c65e3770>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:44:38.389350Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m3ac3775b-85f9-4230-809b-9db6279e0a9f[0m [36mstatus_code[0m=[35m401[0m
________________ TestEventsUnit.test_events_stats_requires_auth ________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288e59fa570>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288e59fa570>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_events_unit.TestEventsUnit object at 0x7289843ed6a0>
client = <httpx.AsyncClient object at 0x7288e59f9880>

    @pytest.mark.unit
    async def test_events_stats_requires_auth(self, client: AsyncClient):
        """Test that events stats endpoint requires authentication."""
>       response = await client.get("/api/v1/events/stats")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:30: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288e59fa570>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:44:39.265877Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m9f642336-bbb6-4bb9-93cb-6c2347effde2[0m [36mstatus_code[0m=[35m401[0m
_________________ TestEventsUnit.test_test_event_requires_auth _________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c525d2b0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c525d2b0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_events_unit.TestEventsUnit object at 0x7289843eda60>
client = <httpx.AsyncClient object at 0x7288c525c530>

    @pytest.mark.unit
    async def test_test_event_requires_auth(self, client: AsyncClient):
        """Test that test event endpoint requires authentication."""
>       response = await client.post("/api/v1/events/test-event")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:36: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c525d2b0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:44:40.158667Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mf3293b14-2c94-48bd-abce-6467480ef348[0m [36mstatus_code[0m=[35m401[0m
_______________ TestEventsUnit.test_broadcast_test_requires_auth _______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c770bfb0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c770bfb0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_events_unit.TestEventsUnit object at 0x7289843d6450>
client = <httpx.AsyncClient object at 0x7288c770b1a0>

    @pytest.mark.unit
    async def test_broadcast_test_requires_auth(self, client: AsyncClient):
        """Test that broadcast test endpoint requires authentication."""
>       response = await client.post("/api/v1/events/broadcast-test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:42: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c770bfb0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:44:41.029267Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m57e45f7d-8ad0-4263-8121-3db1f1d06652[0m [36mstatus_code[0m=[35m401[0m
___________________ TestEventsUnit.test_events_stats_success ___________________

self = <tests.test_events_unit.TestEventsUnit object at 0x7289843edbe0>
mock_sse_service = <MagicMock name='sse_service' id='125933410202016'>
client = <httpx.AsyncClient object at 0x7288c45260c0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4NTc1WlM4VkZISFhaU1lWUDZGUyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0ODJ9.xue6_kd294h0TOdBL4dEB_cxJXzHPYJXCXA7PlmbYfI'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_events_stats_success(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test events stats endpoint with mocked SSE service."""
        # Mock SSE service stats
        mock_sse_service.get_stats.return_value = {
            "active_connections": 5,
            "total_events_sent": 100,
            "events_per_second": 2.5,
            "connections_by_user": {
                "user1": 2,
                "user2": 3
            }
        }
    
>       response = await client.get("/api/v1/events/stats", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:60: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3183' coro=<TestEventsUnit.test_events_stats_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4NTc1WlM4VkZISFhaU1lWUDZGUyIsImVtYWlsIjoidXNlcmRhZGNlZWI3QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZGFkY2VlYjciLCJqdGkiOiJkODkwOTgwNy00MDQzLTQxMTQtYmUyMS1iZDNjNDczNTJmYTkiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjgyLCJzZXNzaW9uX2lkIjoiN2IyMDRlYzUtMzM0ZS00NjVmLWIyMjgtYThlYzZlODQ1MDMzIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0ODJ9.xue6_kd294h0TOdBL4dEB_cxJXzHPYJXCXA7PlmbYfI
____________________ TestEventsUnit.test_test_event_success ____________________

self = <tests.test_events_unit.TestEventsUnit object at 0x7289843ed790>
mock_sse_service = <MagicMock name='sse_service' id='125931730020272'>
client = <httpx.AsyncClient object at 0x7288c407b710>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4NlNaOTkxOFhFSFoyRUMxWkFIMiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0ODN9.OVrMUv0IMmUzJZwuIfObeYOqe37K2Mpm6Fbnf071gNA'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_test_event_success(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test test event endpoint success."""
        mock_sse_service.broadcast_to_user.return_value = True
    
        test_data = {
            "event_type": "test.message",
            "data": {"message": "Hello World"},
            "user_id": "test-user-123"
        }
    
>       response = await client.post(
            "/api/v1/events/test-event",
            json=test_data,
            headers=auth_headers
        )

tests/test_events_unit.py:81: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3196' coro=<TestEventsUnit.test_test_event_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4NlNaOTkxOFhFSFoyRUMxWkFIMiIsImVtYWlsIjoidXNlcjRhNTNmYTQ4QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNGE1M2ZhNDgiLCJqdGkiOiIyZTg0ZGQ4YS1jODAwLTQxMmMtOTA5OS00OGE1NDhhOTA1MWYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjgzLCJzZXNzaW9uX2lkIjoiNjhiNWVhMTEtZmYyOS00M2M3LWIyMDAtNjgxY2Q2MTNlYjMzIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0ODN9.OVrMUv0IMmUzJZwuIfObeYOqe37K2Mpm6Fbnf071gNA
__________________ TestEventsUnit.test_broadcast_test_success __________________

self = <tests.test_events_unit.TestEventsUnit object at 0x7289843ee090>
mock_sse_service = <MagicMock name='sse_service' id='125931732170032'>
client = <httpx.AsyncClient object at 0x7288c42a3fe0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4OENIUU4wV1Y4MlRNQkcwNzBNMCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0ODV9.t_teV8Q179np6P263zsLmvYysO7GT6iBvD26mZlP43M'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_broadcast_test_success(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test broadcast test endpoint success."""
        mock_sse_service.broadcast.return_value = True
    
        test_data = {
            "event_type": "broadcast.test",
            "data": {"message": "Broadcast message"}
        }
    
>       response = await client.post(
            "/api/v1/events/broadcast-test",
            json=test_data,
            headers=auth_headers
        )

tests/test_events_unit.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3209' coro=<TestEventsUnit.test_broadcast_test_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4OENIUU4wV1Y4MlRNQkcwNzBNMCIsImVtYWlsIjoidXNlcjk3OTg4NzlmQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOTc5ODg3OWYiLCJqdGkiOiJlZmYzMjgxOC01Y2M0LTRjZGItYTc2Yy0zMzkzOWQ3ZGIzZGUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjg1LCJzZXNzaW9uX2lkIjoiMmQ5YjJmZTAtN2FiMi00ZTQ5LTljN2YtOThjMTcyYWJjMDFiIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0ODV9.t_teV8Q179np6P263zsLmvYysO7GT6iBvD26mZlP43M
_________________ TestEventsUnit.test_test_event_invalid_data __________________

self = <tests.test_events_unit.TestEventsUnit object at 0x7289843ee450>
client = <httpx.AsyncClient object at 0x7288e7f702c0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4QjIyTVJNM1RYR0ROWkVTTTNGMCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0ODh9._-IEH_NEaYUJyUY5xJ3hM6NqcpUrNvSluEWau58oDW0'}

    @pytest.mark.unit
    async def test_test_event_invalid_data(self, client: AsyncClient, auth_headers: dict):
        """Test test event endpoint with invalid data."""
        # Missing required fields
        test_data = {
            "data": {"message": "Hello World"}
            # Missing event_type
        }
    
>       response = await client.post(
            "/api/v1/events/test-event",
            json=test_data,
            headers=auth_headers
        )

tests/test_events_unit.py:125: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3222' coro=<TestEventsUnit.test_test_event_invalid_data() running at /home/yam/chatter/tests/test_events_unit.py:125> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4QjIyTVJNM1RYR0ROWkVTTTNGMCIsImVtYWlsIjoidXNlcmU3NGNmNmUyQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZTc0Y2Y2ZTIiLCJqdGkiOiIwNGFhMmJhYy05YThhLTRjMDYtYTI4ZC0yMjZjYWMyM2Q0MzciLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjg4LCJzZXNzaW9uX2lkIjoiMjZlOGI2YTEtMWZkNy00ZWU5LWJkY2QtYjAwMGMyMmUxY2M3IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0ODh9._-IEH_NEaYUJyUY5xJ3hM6NqcpUrNvSluEWau58oDW0
_______________ TestEventsUnit.test_broadcast_test_invalid_data ________________

self = <tests.test_events_unit.TestEventsUnit object at 0x7289843ee810>
client = <httpx.AsyncClient object at 0x7288e5986ed0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4Q045WUJHQTZQRFdWTjlEVEhCUyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0ODl9.NraFNBQT18p1Na1MsOe1KZ9WWQiGWgUkjqcqz42ed_M'}

    @pytest.mark.unit
    async def test_broadcast_test_invalid_data(self, client: AsyncClient, auth_headers: dict):
        """Test broadcast test endpoint with invalid data."""
        # Missing required fields
        test_data = {
            "data": {"message": "Broadcast message"}
            # Missing event_type
        }
    
>       response = await client.post(
            "/api/v1/events/broadcast-test",
            json=test_data,
            headers=auth_headers
        )

tests/test_events_unit.py:141: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3235' coro=<TestEventsUnit.test_broadcast_test_invalid_data() running at /home/yam/chatter/tests/test_events_unit.py:141> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4Q045WUJHQTZQRFdWTjlEVEhCUyIsImVtYWlsIjoidXNlcjI5YjIxMGMwQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMjliMjEwYzAiLCJqdGkiOiIwYjQ4Nzk4Yy00YWZiLTQzZTUtOWRiMi01NTc5ODFmZmZiNGEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjg5LCJzZXNzaW9uX2lkIjoiZDgzYWYwZDUtNjYxMC00MmY1LTg5NDEtNWU2OTAzOTliZDM4IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0ODl9.NraFNBQT18p1Na1MsOe1KZ9WWQiGWgUkjqcqz42ed_M
_________________ TestEventsUnit.test_events_stream_rate_limit _________________

self = <tests.test_events_unit.TestEventsUnit object at 0x7289843eebd0>
mock_get_rate_limiter = <MagicMock name='get_unified_rate_limiter' id='125931748827184'>
client = <httpx.AsyncClient object at 0x7288c5278b90>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4RTdENFlDQkgwNTdLVlhWRFFWRyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0OTF9.DKT_BWx4DiZXo0ZjGk4ZJ0-FguQoVhbxCXSlPsH6I5w'}

    @pytest.mark.unit
    @patch('chatter.api.events.get_unified_rate_limiter')
    async def test_events_stream_rate_limit(self, mock_get_rate_limiter, client: AsyncClient, auth_headers: dict):
        """Test events stream rate limiting."""
        from chatter.utils.unified_rate_limiter import RateLimitExceeded
    
        # Mock rate limiter to raise exception
        mock_rate_limiter = AsyncMock()
        mock_rate_limiter.check_rate_limit.side_effect = RateLimitExceeded(
            message="Rate limit exceeded",
            limit=50,
            window=3600,
            remaining=0
        )
        mock_get_rate_limiter.return_value = mock_rate_limiter
    
>       response = await client.get("/api/v1/events/stream", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:164: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3248' coro=<TestEventsUnit.test_events_stream_rate_limit() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4RTdENFlDQkgwNTdLVlhWRFFWRyIsImVtYWlsIjoidXNlcmEzODM2NGQ4QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYTM4MzY0ZDgiLCJqdGkiOiIxYzUzNDgwYy0zZGIxLTQxZmYtYmU5ZS0wOTRiMTI0NGQyOGMiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjkxLCJzZXNzaW9uX2lkIjoiODc5MmRiYjgtNjdjNS00NDBlLWE0YWEtZjAzNDU1YWE1YmZmIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0OTF9.DKT_BWx4DiZXo0ZjGk4ZJ0-FguQoVhbxCXSlPsH6I5w
______________ TestEventsUnit.test_events_stream_connection_limit ______________

self = <tests.test_events_unit.TestEventsUnit object at 0x7289843eef90>
mock_sse_service = <MagicMock name='sse_service' id='125931787134320'>
client = <httpx.AsyncClient object at 0x7288c7701190>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4Rlg1RENDTkUyN003VFQ3NkoySiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0OTN9.KYhQxt4ZyflxSzDef7Zj9J2Vjwp0xTnNtHGcsCdh-HE'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_events_stream_connection_limit(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test events stream connection limit."""
        # Mock SSE service to raise connection limit error
        mock_sse_service.create_connection.side_effect = ValueError("Too many connections")
    
>       response = await client.get("/api/v1/events/stream", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:174: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3261' coro=<TestEventsUnit.test_events_stream_connection_limit() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4Rlg1RENDTkUyN003VFQ3NkoySiIsImVtYWlsIjoidXNlcjY4MjAyY2YzQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNjgyMDJjZjMiLCJqdGkiOiI2ZTViZDM0YS1kNjdjLTRmZGEtOTY5Mi1hYzEzZTQ2MTRlNzIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjkzLCJzZXNzaW9uX2lkIjoiNDdjOWIwNTQtYTFhYy00OGJlLWFlNWQtZmI1MjgzYzNjM2MwIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0OTN9.KYhQxt4ZyflxSzDef7Zj9J2Vjwp0xTnNtHGcsCdh-HE
____________ TestEventsUnit.test_events_stream_connection_not_found ____________

self = <tests.test_events_unit.TestEventsUnit object at 0x7289843ef350>
mock_sse_service = <MagicMock name='sse_service' id='125932322074272'>
client = <httpx.AsyncClient object at 0x7288e7529c70>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4SFhWRDRBOVMyNlBHQ01TVloxNCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0OTV9.tpsHzk9l4E_tlVdyvRIktANZSiZlRrO5s5xTG1O5vnQ'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_events_stream_connection_not_found(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test events stream when connection cannot be retrieved."""
        # Mock SSE service to return connection ID but fail on get_connection
        mock_sse_service.create_connection.return_value = "connection-123"
        mock_sse_service.get_connection.return_value = None
    
>       response = await client.get("/api/v1/events/stream", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:185: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3274' coro=<TestEventsUnit.test_events_stream_connection_not_found() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4SFhWRDRBOVMyNlBHQ01TVloxNCIsImVtYWlsIjoidXNlcmIzNGRkMGY5QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYjM0ZGQwZjkiLCJqdGkiOiI2Y2I4YWZjMy0zOThhLTRmYmItYjk5MC05Yjg3M2IxNTgzYmQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjk1LCJzZXNzaW9uX2lkIjoiNzM0NDk0ZDEtZTMzMS00ODAwLWI5MzItNzIxNDYzZDlhYTcxIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0OTV9.tpsHzk9l4E_tlVdyvRIktANZSiZlRrO5s5xTG1O5vnQ
_______________ TestEventsUnit.test_admin_stream_requires_admin ________________

self = <tests.test_events_unit.TestEventsUnit object at 0x7289843ef710>
mock_sse_service = <MagicMock name='sse_service' id='125931719501744'>
client = <httpx.AsyncClient object at 0x7288c23529f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4TTA5MUpZOVk5Q1YwWjg3SjJNVyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0OTd9.kFT-t3WLsS3SzY0Jr8efQA0WLik8E_ru3dzDlBk-CEI'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_admin_stream_requires_admin(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test that admin stream requires admin privileges."""
        # Regular user should get forbidden
>       response = await client.get("/api/v1/events/admin/stream", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:196: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3287' coro=<TestEventsUnit.test_admin_stream_requires_admin() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4TTA5MUpZOVk5Q1YwWjg3SjJNVyIsImVtYWlsIjoidXNlcjI2Y2E1YzBjQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMjZjYTVjMGMiLCJqdGkiOiJlZTA3MmVhOS0yZmI2LTQzNDEtOGZiOC00ODQxMmEwYzRlNjMiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjk3LCJzZXNzaW9uX2lkIjoiMmM2ZTNlYzMtM2NlYS00YmJjLThlM2EtOWU0NzVkYTUyYzRhIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0OTd9.kFT-t3WLsS3SzY0Jr8efQA0WLik8E_ru3dzDlBk-CEI
______________ TestEventsUnit.test_events_stats_sse_service_error ______________

self = <tests.test_events_unit.TestEventsUnit object at 0x7289843efad0>
mock_sse_service = <MagicMock name='sse_service' id='125931713932816'>
client = <httpx.AsyncClient object at 0x7288c3131bb0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4TkswSjVLOUdFUFpDR0E1QktSRiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0OTh9.cuYq3UWerEKsquAAv_F8j0QEVAFjcFp74xj9LUIYR2A'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_events_stats_sse_service_error(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test events stats when SSE service has an error."""
        mock_sse_service.get_stats.side_effect = Exception("SSE service error")
    
>       response = await client.get("/api/v1/events/stats", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:205: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3300' coro=<TestEventsUnit.test_events_stats_sse_service_error() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4TkswSjVLOUdFUFpDR0E1QktSRiIsImVtYWlsIjoidXNlcmM2YTQ3NWU4QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYzZhNDc1ZTgiLCJqdGkiOiIzZTg3NWFjNC05ZTM5LTQwNWQtYjdkYS01MGI2NzRkNTVkMWIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNjk4LCJzZXNzaW9uX2lkIjoiNmFiNTNmOTUtYWYxNi00NTk2LWIwNjktYWRlYmIwMzM3NGI5IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI0OTh9.cuYq3UWerEKsquAAv_F8j0QEVAFjcFp74xj9LUIYR2A
_______________ TestEventsUnit.test_test_event_sse_service_error _______________

self = <tests.test_events_unit.TestEventsUnit object at 0x7289842101a0>
mock_sse_service = <MagicMock name='sse_service' id='125931700498272'>
client = <httpx.AsyncClient object at 0x7288c2461ca0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4UTY3WDNZSlNLUjVBN1hYMDJGRSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1MDB9.JlBu0Uo22HHGI2PSsbtcLfdDBQl_U4JJYzkSFgkb8h4'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_test_event_sse_service_error(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test test event when SSE service has an error."""
        mock_sse_service.broadcast_to_user.side_effect = Exception("SSE service error")
    
        test_data = {
            "event_type": "test.message",
            "data": {"message": "Hello World"},
            "user_id": "test-user-123"
        }
    
>       response = await client.post(
            "/api/v1/events/test-event",
            json=test_data,
            headers=auth_headers
        )

tests/test_events_unit.py:220: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3313' coro=<TestEventsUnit.test_test_event_sse_service_error() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4UTY3WDNZSlNLUjVBN1hYMDJGRSIsImVtYWlsIjoidXNlcjdkYWE5NTA0QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyN2RhYTk1MDQiLCJqdGkiOiIyYTgwZTkyZC0wZDQ0LTQxY2UtYjJjMy1iZWU2NjVkZTdkOTciLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzAwLCJzZXNzaW9uX2lkIjoiYWZmODI4M2EtM2FlZC00NzdkLWEyYjMtMDczZTAxNzBlM2VhIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1MDB9.JlBu0Uo22HHGI2PSsbtcLfdDBQl_U4JJYzkSFgkb8h4
_____________ TestEventsUnit.test_broadcast_test_sse_service_error _____________

self = <tests.test_events_unit.TestEventsUnit object at 0x728984210290>
mock_sse_service = <MagicMock name='sse_service' id='125931691321264'>
client = <httpx.AsyncClient object at 0x7288c3257c50>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4U1A5MEpQN0RSWlhTUTFCMTNIRCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1MDN9.Oa2mXzU5y4UnqdWdWVal2gBMWvDNpiigXEqff-PpYv0'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_broadcast_test_sse_service_error(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test broadcast test when SSE service has an error."""
        mock_sse_service.broadcast.side_effect = Exception("SSE service error")
    
        test_data = {
            "event_type": "broadcast.test",
            "data": {"message": "Broadcast message"}
        }
    
>       response = await client.post(
            "/api/v1/events/broadcast-test",
            json=test_data,
            headers=auth_headers
        )

tests/test_events_unit.py:238: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3326' coro=<TestEventsUnit.test_broadcast_test_sse_service_error() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM4U1A5MEpQN0RSWlhTUTFCMTNIRCIsImVtYWlsIjoidXNlcjhmMDI4ODEwQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOGYwMjg4MTAiLCJqdGkiOiIyMzEzMGViMi0zN2MzLTQxMmYtYTAxMy05MGU0MmIyYzhhMDUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzAzLCJzZXNzaW9uX2lkIjoiZGQ2NThhOWItMTczMy00NDBhLWE3YTgtNGJkYTJhNTVmMGMzIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1MDN9.Oa2mXzU5y4UnqdWdWVal2gBMWvDNpiigXEqff-PpYv0
_________ TestHealthUnit.test_metrics_endpoint_with_monitoring_success _________

self = <tests.test_health_unit.TestHealthUnit object at 0x7289842133e0>
mock_get_monitoring = <AsyncMock name='get_monitoring_service' id='125931666382368'>
client = <httpx.AsyncClient object at 0x7288aaf86d80>

    @pytest.mark.unit
    @patch('chatter.core.monitoring.get_monitoring_service')
    async def test_metrics_endpoint_with_monitoring_success(self, mock_get_monitoring, client: AsyncClient):
        """Test metrics endpoint when monitoring service is available."""
        # Mock the monitoring service
        mock_service = AsyncMock()
        mock_service.get_system_health.return_value = {
            "status": "healthy",
            "checks_available": True,
            "cpu_usage": 15.2,
            "memory_usage": 45.8
        }
        mock_service.stats_by_endpoint = {
            "/healthz": {"requests": 100, "avg_response_time": 10.5},
            "/readyz": {"requests": 50, "avg_response_time": 25.3}
        }
        # Make get_monitoring_service async and return the mock service
        async def return_mock_service(*args, **kwargs):
            return mock_service
        mock_get_monitoring.side_effect = return_mock_service
    
        response = await client.get("/metrics")
        assert response.status_code == 200
    
        data = response.json()
>       assert data["health"]["status"] == "healthy"
E       AssertionError: assert 'unknown' == 'healthy'
E         
E         - healthy
E         + unknown

tests/test_health_unit.py:110: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  chatter.api.health:health.py:157 [2m2025-09-05T16:45:17.002619Z[0m [[33m[1mwarning  [0m] [1mFailed to get endpoint stats: 'coroutine' object is not iterable[0m [[34m[1mchatter.api.health[0m]
________ TestHealthUnit.test_correlation_trace_with_monitoring_success _________

self = <tests.test_health_unit.TestHealthUnit object at 0x728984213b60>
mock_get_monitoring = <AsyncMock name='get_monitoring_service' id='125931666382512'>
client = <httpx.AsyncClient object at 0x7288aa9014c0>

    @pytest.mark.unit
    @patch('chatter.core.monitoring.get_monitoring_service')
    async def test_correlation_trace_with_monitoring_success(self, mock_get_monitoring, client: AsyncClient):
        """Test correlation trace endpoint when monitoring service is available."""
        correlation_id = "test-correlation-123"
        mock_requests = [
            {"timestamp": "2024-01-01T12:00:00Z", "method": "GET", "path": "/healthz"},
            {"timestamp": "2024-01-01T12:00:01Z", "method": "GET", "path": "/readyz"}
        ]
    
        mock_service = AsyncMock()
        mock_service.get_correlation_trace.return_value = mock_requests
        mock_get_monitoring.return_value = mock_service
    
        response = await client.get(f"/trace/{correlation_id}")
>       assert response.status_code == 200
E       assert 500 == 200
E        +  where 500 = <Response [500 Internal Server Error]>.status_code

tests/test_health_unit.py:146: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    chatter.api.health:health.py:223 [2m2025-09-05T16:45:18.336704Z[0m [[31m[1merror    [0m] [1mFailed to get correlation trace for test-correlation-123: object of type 'coroutine' has no len()[0m [[34m[1mchatter.api.health[0m]
_________ TestHealthUnit.test_correlation_trace_with_monitoring_error __________

self = <tests.test_health_unit.TestHealthUnit object at 0x72898421c230>
mock_get_monitoring = <AsyncMock name='get_monitoring_service' id='125931301258400'>
client = <httpx.AsyncClient object at 0x7288aa7a4110>

    @pytest.mark.unit
    @patch('chatter.core.monitoring.get_monitoring_service')
    async def test_correlation_trace_with_monitoring_error(self, mock_get_monitoring, client: AsyncClient):
        """Test correlation trace endpoint when monitoring service raises an exception."""
        correlation_id = "test-correlation-123"
        mock_get_monitoring.side_effect = Exception("Monitoring service error")
    
        response = await client.get(f"/trace/{correlation_id}")
        assert response.status_code == 500  # Internal server error
    
        data = response.json()
        # InternalServerProblem sets type_suffix="internal-server-error"
>       assert "internal-server-error" in data["type"]
                                          ^^^^^^^^^^^^
E       KeyError: 'type'

tests/test_health_unit.py:165: KeyError
------------------------------ Captured log call -------------------------------
ERROR    chatter.api.health:health.py:223 [2m2025-09-05T16:45:19.013432Z[0m [[31m[1merror    [0m] [1mFailed to get correlation trace for test-correlation-123: Monitoring service error[0m [[34m[1mchatter.api.health[0m]
_______________ TestJobsIntegration.test_job_complete_lifecycle ________________

self = <tests.test_jobs_integration.TestJobsIntegration object at 0x72898421e480>
client = <httpx.AsyncClient object at 0x7288aa5a5550>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM5S1JLTVZRMlFGMlBGMDZDTVo5RiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1Mjl9.wq3M8t7yJ8AxUu9FFBk18qlNPVpkou2ZyxEcJw4rs8g'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288aa0d91c0>

    @pytest.mark.integration
    async def test_job_complete_lifecycle(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complete job lifecycle from creation to completion."""
        # Create a job
        job_data = {
            "name": "Integration Test Job",
            "function_name": "test_function",
            "args": ["test_arg"],
            "kwargs": {"test_key": "test_value"},
            "priority": "normal"
        }
    
>       create_response = await client.post("/api/v1/jobs/", json=job_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_integration.py:24: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3713' coro=<TestJobsIntegration.test_job_complete_lifecycle() running at /home/yam/chatter/tests/test_jobs_integration.py:24> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM5S1JLTVZRMlFGMlBGMDZDTVo5RiIsImVtYWlsIjoidXNlcmIzZjA5OWVmQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYjNmMDk5ZWYiLCJqdGkiOiI5MWY1MzYzNi04ODNhLTQzMzctYjAwYy03ODQxYWEzYjlhZTciLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzI5LCJzZXNzaW9uX2lkIjoiODhjMzNmM2YtMjg1Zi00MzdkLWI3ZWUtNWQ1NTgyYjZmZDYxIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1Mjl9.wq3M8t7yJ8AxUu9FFBk18qlNPVpkou2ZyxEcJw4rs8g
______________ TestJobsIntegration.test_job_listing_and_filtering ______________

self = <tests.test_jobs_integration.TestJobsIntegration object at 0x72898421e0f0>
client = <httpx.AsyncClient object at 0x7288aa9e5a00>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM5TjQ1REs4QkJEMEdERzVSOTVGVCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1MzF9.ozEKMZpGZr259282cgbO6MkgcRBK2QC0Se1kgmV4ke0'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288aa6229f0>

    @pytest.mark.integration
    async def test_job_listing_and_filtering(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test job listing and filtering functionality."""
        # Create multiple jobs with different statuses
        job_names = ["Job 1", "Job 2", "Job 3"]
        created_jobs = []
    
        for name in job_names:
            job_data = {
                "name": name,
                "function_name": "test_function",
                "args": [],
                "kwargs": {},
                "priority": "normal"
            }
    
>           response = await client.post("/api/v1/jobs/", json=job_data, headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_integration.py:64: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3726' coro=<TestJobsIntegration.test_job_listing_and_filtering() running at /home/yam/chatter/tests/test_jobs_integration.py:64> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM5TjQ1REs4QkJEMEdERzVSOTVGVCIsImVtYWlsIjoidXNlcjU3ZjE4N2E0QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNTdmMTg3YTQiLCJqdGkiOiJhNTcxYmRkNy05NzkzLTQ4YjgtOThiMi1mYjI1NmM4MzI4MGEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzMxLCJzZXNzaW9uX2lkIjoiNjM4YzBkYTctOGE1Ni00NjM5LTlkMGMtOWZhZTQwYTFmYmIzIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1MzF9.ozEKMZpGZr259282cgbO6MkgcRBK2QC0Se1kgmV4ke0
______________ TestJobsIntegration.test_job_cancellation_workflow ______________

self = <tests.test_jobs_integration.TestJobsIntegration object at 0x72898423c2f0>
client = <httpx.AsyncClient object at 0x7288aaaa4b30>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM5UEpNRUFXNzQ4Rk5IUUVNNFRFQyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1MzJ9.3PgxhBX-3pjKoE66I3wbkTqz0EMO_BZ12u6QAaYu1kY'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288aa623e30>

    @pytest.mark.integration
    async def test_job_cancellation_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test job cancellation workflow."""
        # Create a job
        job_data = {
            "name": "Cancellation Test Job",
            "function_name": "slow_test_function",  # Hypothetical slow function
            "args": [],
            "kwargs": {},
            "priority": "low"
        }
    
>       create_response = await client.post("/api/v1/jobs/", json=job_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_integration.py:103: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3739' coro=<TestJobsIntegration.test_job_cancellation_workflow() running at /home/yam/chatter/tests/test_jobs_integration.py:103> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM5UEpNRUFXNzQ4Rk5IUUVNNFRFQyIsImVtYWlsIjoidXNlcmRhNzZjYzM2QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZGE3NmNjMzYiLCJqdGkiOiJkNjc4NWM5ZC1jZTJjLTQyNmItYWRlMC0wYzIxNzBmYmQ5ZWUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzMyLCJzZXNzaW9uX2lkIjoiOWYyNTc5ZGEtMWM3MS00MmUyLWI1YWEtOTQ1NzdiOGE0MmY2IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1MzJ9.3PgxhBX-3pjKoE66I3wbkTqz0EMO_BZ12u6QAaYu1kY
_________________ TestJobsIntegration.test_job_error_scenarios _________________

self = <tests.test_jobs_integration.TestJobsIntegration object at 0x72898423c3e0>
client = <httpx.AsyncClient object at 0x7288c02856d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM5UVhLQ1MyUFJRWjA0UzNUWTI2WSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1MzR9.ultQznC1fkpKqk24CS6frNdkUTDlWnqLuMZkVIc82VQ'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288aacca6c0>

    @pytest.mark.integration
    async def test_job_error_scenarios(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test job error handling scenarios."""
        # Test non-existent job operations
        nonexistent_id = "550e8400-e29b-41d4-a716-446655440000"
    
        # Get non-existent job
>       get_response = await client.get(f"/api/v1/jobs/{nonexistent_id}", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_integration.py:127: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3752' coro=<TestJobsIntegration.test_job_error_scenarios() running at /home/yam/chatter/tests/test_jobs_integration.py:127> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM5UVhLQ1MyUFJRWjA0UzNUWTI2WSIsImVtYWlsIjoidXNlcjhhNTRiNzMwQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOGE1NGI3MzAiLCJqdGkiOiIwZDBjNjllNy01YzY4LTQzNGMtYjRhNS04MTM3NTdmZDZhN2UiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzM0LCJzZXNzaW9uX2lkIjoiYzJkZjQ1MzktOGQ1OS00ZDc0LTkzMjktYmEwZWNiOTk1ODRmIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1MzR9.ultQznC1fkpKqk24CS6frNdkUTDlWnqLuMZkVIc82VQ
______________ TestJobsIntegration.test_job_validation_scenarios _______________

self = <tests.test_jobs_integration.TestJobsIntegration object at 0x72898423c7a0>
client = <httpx.AsyncClient object at 0x7288c22c3d10>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM5UzdaSE1LREJSUU42WEtHTlFBMiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1MzV9.GlDBjEvx34QxwreX7riMg3tjN7HBnhDaDa-wgHvGoEo'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288c0163b30>

    @pytest.mark.integration
    async def test_job_validation_scenarios(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test job creation validation scenarios."""
        # Test invalid function name
        invalid_function_data = {
            "name": "Invalid Function Job",
            "function_name": "nonexistent_function_12345",
            "args": [],
            "kwargs": {}
        }
    
>       response = await client.post("/api/v1/jobs/", json=invalid_function_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_integration.py:156: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3765' coro=<TestJobsIntegration.test_job_validation_scenarios() running at /home/yam/chatter/tests/test_jobs_integration.py:156> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM5UzdaSE1LREJSUU42WEtHTlFBMiIsImVtYWlsIjoidXNlcmU3NDYxNzgxQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZTc0NjE3ODEiLCJqdGkiOiJhOWJiNzdhMS1iODQzLTRjOTMtOWNiZS0xMjQwZGQ1OTYwNDQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzM1LCJzZXNzaW9uX2lkIjoiYzU2NDhjYzMtZTc2OC00NDk4LTlmMmYtNGM4N2RkY2EyMWYyIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1MzV9.GlDBjEvx34QxwreX7riMg3tjN7HBnhDaDa-wgHvGoEo
_________________ TestJobsIntegration.test_job_stats_accuracy __________________

self = <tests.test_jobs_integration.TestJobsIntegration object at 0x72898423cb60>
client = <httpx.AsyncClient object at 0x7288c1f3aed0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM5VFIzOU5KUEpEVzJBRTJWU1hHMiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1MzZ9.8ospuxqse3NckgpbUW6KU9kTWkgUsIEBR_M3Ss8eMXE'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288c225e660>

    @pytest.mark.integration
    async def test_job_stats_accuracy(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test job statistics accuracy."""
        # Get initial stats
>       initial_response = await client.get("/api/v1/jobs/stats/overview", headers=auth_headers)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_integration.py:184: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3778' coro=<TestJobsIntegration.test_job_stats_accuracy() running at /home/yam/chatter/tests/test_jobs_integration.py:184> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM5VFIzOU5KUEpEVzJBRTJWU1hHMiIsImVtYWlsIjoidXNlcmE3MTVmZWNmQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYTcxNWZlY2YiLCJqdGkiOiJiZjQ2NDZjNS1mMTU5LTQ3NjItYmFkYS01YTYyYTA3ZmUyYjciLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzM2LCJzZXNzaW9uX2lkIjoiYTIxYjY2NzEtOTM1NC00MzU2LWEyNmItNjMzOTRlYWFmNzc5IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1MzZ9.8ospuxqse3NckgpbUW6KU9kTWkgUsIEBR_M3Ss8eMXE
______________ TestJobsIntegration.test_job_cleanup_functionality ______________

self = <tests.test_jobs_integration.TestJobsIntegration object at 0x72898423cf20>
client = <httpx.AsyncClient object at 0x7288c2e1c7a0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM5VzlOV0EzVlJCSlBCWFBLTU5NRiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1Mzh9.MEa6xMMYV7YlV4xrX5qnA56vRWS0k4hzt_HH8Uk6IBc'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288c64ee360>

    @pytest.mark.integration
    async def test_job_cleanup_functionality(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test job cleanup functionality."""
        # Get initial stats
>       initial_response = await client.get("/api/v1/jobs/stats/overview", headers=auth_headers)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_integration.py:226: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3791' coro=<TestJobsIntegration.test_job_cleanup_functionality() running at /home/yam/chatter/tests/test_jobs_integration.py:226> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM5VzlOV0EzVlJCSlBCWFBLTU5NRiIsImVtYWlsIjoidXNlcjIxMTRiMmQ5QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMjExNGIyZDkiLCJqdGkiOiI1MGVkMWM0OC00ZDAzLTQ5ZmYtYTFhYy0yYmQyYTdjNTNlNWYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzM4LCJzZXNzaW9uX2lkIjoiYjBmYmU3NzQtMTg5MS00MDJhLTgyZTgtYTY3MzQ1MWMwZmQyIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1Mzh9.MEa6xMMYV7YlV4xrX5qnA56vRWS0k4hzt_HH8Uk6IBc
______________ TestJobsIntegration.test_concurrent_job_operations ______________

self = <tests.test_jobs_integration.TestJobsIntegration object at 0x72898423d2e0>
client = <httpx.AsyncClient object at 0x7288aabd1f70>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM5WVlHNUdQVjNaSFo3U0EwVEFWWSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NDF9.AbGcEjuUPb4p_kXHcXWrxQEHaaIMVuWgYxnIyNAUoG0'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288a9f114f0>

    @pytest.mark.integration
    async def test_concurrent_job_operations(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test concurrent job operations."""
        # Create multiple jobs concurrently
        job_data_list = [
            {
                "name": f"Concurrent Job {i}",
                "function_name": "test_function",
                "args": [i],
                "kwargs": {"concurrent": True}
            }
            for i in range(5)
        ]
    
        # Create tasks for concurrent job creation
        create_tasks = [
            asyncio.create_task(client.post("/api/v1/jobs/", json=job_data, headers=auth_headers))
            for job_data in job_data_list
        ]
    
        # Wait for all creations
>       create_responses = await asyncio.gather(*create_tasks)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_integration.py:276: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3805' coro=<AsyncClient.post() running at /home/yam/.local/lib/python3.12/site-packages/httpx/_client.py:1859> cb=[gather.<locals>._done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:767]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0REM5WVlHNUdQVjNaSFo3U0EwVEFWWSIsImVtYWlsIjoidXNlcmQ1ZjAyZWU2QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZDVmMDJlZTYiLCJqdGkiOiI0Y2Y4NzcxNC1kMjRiLTRlY2MtYWY3ZS00MGYyMmM1YWI1YmUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzQxLCJzZXNzaW9uX2lkIjoiZGYxZWE2YmYtNTYwMy00YmIzLTliYjYtOTk5MmI2Yzg0ZDcxIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NDF9.AbGcEjuUPb4p_kXHcXWrxQEHaaIMVuWgYxnIyNAUoG0
__________________ TestJobsUnit.test_create_job_requires_auth __________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c3337d70>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c3337d70>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_jobs_unit.TestJobsUnit object at 0x72898423e780>
client = <httpx.AsyncClient object at 0x7288c3336b70>

    @pytest.mark.unit
    async def test_create_job_requires_auth(self, client: AsyncClient):
        """Test that creating job requires authentication."""
        job_data = {
            "name": "Test Job",
            "function_name": "test_function",
            "args": [],
            "kwargs": {}
        }
    
>       response = await client.post("/api/v1/jobs/", json=job_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:23: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c3337d70>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:45:43.585198Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m5ea60aa2-78d7-4154-92e6-121c72bb5f65[0m [36mstatus_code[0m=[35m401[0m
__________________ TestJobsUnit.test_list_jobs_requires_auth ___________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288a816fda0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288a816fda0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_jobs_unit.TestJobsUnit object at 0x72898423ea80>
client = <httpx.AsyncClient object at 0x7288a816f0b0>

    @pytest.mark.unit
    async def test_list_jobs_requires_auth(self, client: AsyncClient):
        """Test that listing jobs requires authentication."""
>       response = await client.get("/api/v1/jobs/")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:29: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288a816fda0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:45:44.680249Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m89e5df67-32c9-493e-bfa8-d6e3c7060389[0m [36mstatus_code[0m=[35m401[0m
___________________ TestJobsUnit.test_get_job_requires_auth ____________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c01ee990>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c01ee990>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_jobs_unit.TestJobsUnit object at 0x72898423eea0>
client = <httpx.AsyncClient object at 0x7288c01edcd0>

    @pytest.mark.unit
    async def test_get_job_requires_auth(self, client: AsyncClient):
        """Test that getting specific job requires authentication."""
        job_id = "550e8400-e29b-41d4-a716-446655440000"
>       response = await client.get(f"/api/v1/jobs/{job_id}")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:36: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c01ee990>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:45:45.727038Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m1dbbcefb-baf3-436f-8c2b-49820bfe9b3c[0m [36mstatus_code[0m=[35m401[0m
__________________ TestJobsUnit.test_cancel_job_requires_auth __________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288aaa8e540>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288aaa8e540>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_jobs_unit.TestJobsUnit object at 0x72898423f260>
client = <httpx.AsyncClient object at 0x7288aaa8d8b0>

    @pytest.mark.unit
    async def test_cancel_job_requires_auth(self, client: AsyncClient):
        """Test that canceling job requires authentication."""
        job_id = "550e8400-e29b-41d4-a716-446655440000"
>       response = await client.post(f"/api/v1/jobs/{job_id}/cancel")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:43: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288aaa8e540>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:45:46.591737Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mb73d428b-5365-419c-89d3-4c6eabc7c32a[0m [36mstatus_code[0m=[35m401[0m
________________ TestJobsUnit.test_get_job_stats_requires_auth _________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c2ee5280>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c2ee5280>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_jobs_unit.TestJobsUnit object at 0x72898423f620>
client = <httpx.AsyncClient object at 0x7288c2ee46e0>

    @pytest.mark.unit
    async def test_get_job_stats_requires_auth(self, client: AsyncClient):
        """Test that getting job stats requires authentication."""
>       response = await client.get("/api/v1/jobs/stats/overview")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:49: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288c2ee5280>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:45:47.465608Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mcb530125-22f7-45f6-a8c0-a7df7bf16599[0m [36mstatus_code[0m=[35m401[0m
_________________ TestJobsUnit.test_cleanup_jobs_requires_auth _________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288aa5275f0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288aa5275f0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_jobs_unit.TestJobsUnit object at 0x72898423f9e0>
client = <httpx.AsyncClient object at 0x7288aa526990>

    @pytest.mark.unit
    async def test_cleanup_jobs_requires_auth(self, client: AsyncClient):
        """Test that cleanup jobs requires authentication."""
>       response = await client.post("/api/v1/jobs/cleanup")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:55: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288aa5275f0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:45:48.396434Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mf2804605-b343-4c3e-b3fc-55f51ff2a0cb[0m [36mstatus_code[0m=[35m401[0m
_____________________ TestJobsUnit.test_create_job_success _____________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7289842640e0>
mock_job_queue = <MagicMock name='job_queue' id='125931704689408'>
client = <httpx.AsyncClient object at 0x7288c1dd4e90>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBNzBIR1BYQ1ozQUNGMUVaNERUNyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NDl9.H0eCwywhJA5tSypKbISTexCSbm5C4oLdI1JoJ-nKQe0'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_create_job_success(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test successful job creation."""
        # Mock job queue
        mock_job = MagicMock()
        mock_job.id = "job-123"
        mock_job.name = "Test Job"
        mock_job.function_name = "test_function"
        mock_job.status = JobStatus.PENDING
        mock_job.priority = JobPriority.NORMAL
        mock_job.created_at = "2024-01-01T12:00:00Z"
        mock_job.created_by = "testuser"
    
        mock_job_queue.has_handler.return_value = True
        mock_job_queue.submit.return_value = mock_job
    
        job_data = {
            "name": "Test Job",
            "function_name": "test_function",
            "args": ["arg1", "arg2"],
            "kwargs": {"key1": "value1"},
            "priority": "normal"
        }
    
>       response = await client.post("/api/v1/jobs/", json=job_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:83: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3906' coro=<TestJobsUnit.test_create_job_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBNzBIR1BYQ1ozQUNGMUVaNERUNyIsImVtYWlsIjoidXNlcmM2YzM0ZjM1QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYzZjMzRmMzUiLCJqdGkiOiIxYjZkOGMzZS1mNzBiLTQ2NDYtOWZjNS1lYWIwZmY4ZjhhN2QiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzQ5LCJzZXNzaW9uX2lkIjoiOWRhZTAyYTMtZmFlNC00MWE0LWEwM2MtZTEwZDAzZTgzZDE1IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NDl9.H0eCwywhJA5tSypKbISTexCSbm5C4oLdI1JoJ-nKQe0
________________ TestJobsUnit.test_create_job_invalid_function _________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7289842641d0>
mock_job_queue = <MagicMock name='job_queue' id='125931705201632'>
client = <httpx.AsyncClient object at 0x7288c2c66870>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBOERDR1dQOFBZRkRURDgxQUtRViIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NTB9.ZtLyNdv8CRreLW7c1lybFwifHDusRO6GK3rkdvTAfNc'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_create_job_invalid_function(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test job creation with invalid function name."""
        mock_job_queue.has_handler.return_value = False
    
        job_data = {
            "name": "Test Job",
            "function_name": "nonexistent_function",
            "args": [],
            "kwargs": {}
        }
    
>       response = await client.post("/api/v1/jobs/", json=job_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3919' coro=<TestJobsUnit.test_create_job_invalid_function() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBOERDR1dQOFBZRkRURDgxQUtRViIsImVtYWlsIjoidXNlcmE4NDEwNWQ2QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYTg0MTA1ZDYiLCJqdGkiOiI4OGMxMDdmMi0zNDBhLTQwODItOTg4NS1iMWJkMDY4MTc5YjEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzUwLCJzZXNzaW9uX2lkIjoiNzczOTE5MGUtZTBiMy00Njk2LTg1ZWYtZGE0YmIwZDc1ODM4IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NTB9.ZtLyNdv8CRreLW7c1lybFwifHDusRO6GK3rkdvTAfNc
__________________ TestJobsUnit.test_create_job_invalid_data ___________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x728984264590>
client = <httpx.AsyncClient object at 0x7288c2006690>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBOVo2OU1QWDJRV1BOMDRHUEhaViIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NTJ9.BTLnL5cu3ylfW2aM41lSZ1A6wpUeQI2rFUCQX5x645U'}

    @pytest.mark.unit
    async def test_create_job_invalid_data(self, client: AsyncClient, auth_headers: dict):
        """Test job creation with invalid data."""
        # Missing required fields
        job_data = {
            "name": "Test Job"
            # Missing function_name
        }
    
>       response = await client.post("/api/v1/jobs/", json=job_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:116: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3932' coro=<TestJobsUnit.test_create_job_invalid_data() running at /home/yam/chatter/tests/test_jobs_unit.py:116> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBOVo2OU1QWDJRV1BOMDRHUEhaViIsImVtYWlsIjoidXNlcmZkOGEzYTMwQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZmQ4YTNhMzAiLCJqdGkiOiJjOGJlNmFmZi1mMTE3LTQzMDgtYTM3My1mMmE2Y2M3NDA1MTMiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzUyLCJzZXNzaW9uX2lkIjoiMTVkNjEwMzgtZTQ4Zi00MGZlLTljYzktOTZmMTEzMDQzMzA3IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NTJ9.BTLnL5cu3ylfW2aM41lSZ1A6wpUeQI2rFUCQX5x645U
_____________________ TestJobsUnit.test_list_jobs_success ______________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x728984264950>
mock_job_queue = <MagicMock name='job_queue' id='125931305163312'>
client = <httpx.AsyncClient object at 0x7288a3f10860>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBQkhGNU45MjdQVjFXOUVWSFpENyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NTR9.da2gGwXJeYtULV1JJPG3U6Yt9cRj8475dQIedPdMqms'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_list_jobs_success(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test successful job listing."""
        mock_jobs = [
            {
                "id": "job-1",
                "name": "Job 1",
                "status": "completed",
                "created_at": "2024-01-01T12:00:00Z"
            },
            {
                "id": "job-2",
                "name": "Job 2",
                "status": "pending",
                "created_at": "2024-01-01T13:00:00Z"
            }
        ]
    
        mock_job_queue.list_jobs.return_value = {
            "jobs": mock_jobs,
            "total": 2,
            "page": 1,
            "per_page": 10
        }
    
>       response = await client.get("/api/v1/jobs/", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:145: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3945' coro=<TestJobsUnit.test_list_jobs_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBQkhGNU45MjdQVjFXOUVWSFpENyIsImVtYWlsIjoidXNlcmVjNTIyZjhkQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZWM1MjJmOGQiLCJqdGkiOiI4NjBjM2ZlZi01Nzg5LTQ3ZWMtYjllZC1lOGYyMjY4ODJlZDEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzU0LCJzZXNzaW9uX2lkIjoiZTI3NTM5NDItN2VkYi00YzFlLTlhZjQtZGEwOGY3NmM4MmI5IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NTR9.da2gGwXJeYtULV1JJPG3U6Yt9cRj8475dQIedPdMqms
___________________ TestJobsUnit.test_list_jobs_with_filters ___________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x72898423f9b0>
mock_job_queue = <MagicMock name='job_queue' id='125931173612672'>
client = <httpx.AsyncClient object at 0x7288a2de8800>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBQ1lZTVJTNzFHSEFYMzRYUE0xWCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NTV9.XWBWEYM1WdvL4bu0sThd5OWbQ8AztJOfUB4JZvoUANU'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_list_jobs_with_filters(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test job listing with filters."""
        mock_job_queue.list_jobs.return_value = {
            "jobs": [],
            "total": 0,
            "page": 1,
            "per_page": 10
        }
    
        # Test with status filter
>       response = await client.get("/api/v1/jobs/?status=completed", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:164: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3958' coro=<TestJobsUnit.test_list_jobs_with_filters() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBQ1lZTVJTNzFHSEFYMzRYUE0xWCIsImVtYWlsIjoidXNlcjEwZTkxNzNmQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMTBlOTE3M2YiLCJqdGkiOiI2YTkxOWMzMS01ZTlhLTQ1MTctYThiYy1kZWY0NjVlMTFhODgiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzU1LCJzZXNzaW9uX2lkIjoiNGIyNzUzOGYtZjRkMy00MWU1LWFjNjgtZTZmMzRkYzYzYWE1IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NTV9.XWBWEYM1WdvL4bu0sThd5OWbQ8AztJOfUB4JZvoUANU
_____________________ TestJobsUnit.test_get_job_not_found ______________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7289842648c0>
mock_job_queue = <MagicMock name='job_queue' id='125931689974800'>
client = <httpx.AsyncClient object at 0x7288c1a581a0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBRzVDVkZEQjlIRVQ2ODlDSDFLNiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NTh9.hzLWFOJ9sjw7JfLDvAbXDjOLOuAZed9IHmg1O9Gk8sQ'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_get_job_not_found(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test job retrieval for non-existent job."""
        job_id = "550e8400-e29b-41d4-a716-446655440000"
        mock_job_queue.get_job.return_value = None
    
>       response = await client.get(f"/api/v1/jobs/{job_id}", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:204: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3983' coro=<TestJobsUnit.test_get_job_not_found() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBRzVDVkZEQjlIRVQ2ODlDSDFLNiIsImVtYWlsIjoidXNlcmQ4MmVjNDdhQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZDgyZWM0N2EiLCJqdGkiOiI1MjU4MmVlNy1mZTE2LTRhZDUtYTUzNi0xMjc5ZTcxZGE3NjQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzU4LCJzZXNzaW9uX2lkIjoiYjkxY2Y5YWUtODJjNS00OTNjLTkxZTQtZGNkZmEyMTQyN2FmIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NTh9.hzLWFOJ9sjw7JfLDvAbXDjOLOuAZed9IHmg1O9Gk8sQ
_________________ TestJobsUnit.test_get_job_invalid_id_format __________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x728984264560>
client = <httpx.AsyncClient object at 0x7288c3355a60>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBSEZIOTMwNDJOQ1hBOEVNU0dFQiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NjB9.QEetqFinoRgaglGL7tuqcPyX0dgivnJbvQf_OVjJYHo'}

    @pytest.mark.unit
    async def test_get_job_invalid_id_format(self, client: AsyncClient, auth_headers: dict):
        """Test job retrieval with invalid job ID format."""
        invalid_job_id = "not-a-uuid"
    
>       response = await client.get(f"/api/v1/jobs/{invalid_job_id}", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:212: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3996' coro=<TestJobsUnit.test_get_job_invalid_id_format() running at /home/yam/chatter/tests/test_jobs_unit.py:212> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBSEZIOTMwNDJOQ1hBOEVNU0dFQiIsImVtYWlsIjoidXNlcjQ3ZThlMzk1QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNDdlOGUzOTUiLCJqdGkiOiI2MDk4ZGY1Mi1lNjY3LTQxNzAtOTA1NS0xN2JlOTcwNmJiMGQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzYwLCJzZXNzaW9uX2lkIjoiNzUzMDYyMGMtN2Q2NC00YmMzLTk5YmQtYjIxZjE3YWQ2MDBiIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NjB9.QEetqFinoRgaglGL7tuqcPyX0dgivnJbvQf_OVjJYHo
_____________________ TestJobsUnit.test_cancel_job_success _____________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7289842650d0>
mock_job_queue = <MagicMock name='job_queue' id='125931683094096'>
client = <httpx.AsyncClient object at 0x7288c13c8bc0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBSlNRQjJXRFJRM0tLNlhSODFBNSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NjF9.EW8PyYYXQJO6Wii7uEWhIB5mYigVTu98SUpOXPAIWDM'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_cancel_job_success(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test successful job cancellation."""
        job_id = "550e8400-e29b-41d4-a716-446655440000"
    
        mock_job_queue.cancel_job.return_value = True
    
>       response = await client.post(f"/api/v1/jobs/{job_id}/cancel", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:223: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4009' coro=<TestJobsUnit.test_cancel_job_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBSlNRQjJXRFJRM0tLNlhSODFBNSIsImVtYWlsIjoidXNlcmY4NDNhMGRmQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZjg0M2EwZGYiLCJqdGkiOiI2OGVjODNhNy1mZmU1LTQ5MGUtYjM3Ni1jZjQyZTY5YmZlZjciLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzYxLCJzZXNzaW9uX2lkIjoiYjEyZWQ1NjctOWFlMC00ZTUzLWI4MTctNmQ2OTlhMzU0M2U2IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NjF9.EW8PyYYXQJO6Wii7uEWhIB5mYigVTu98SUpOXPAIWDM
____________________ TestJobsUnit.test_cancel_job_not_found ____________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x728984265490>
mock_job_queue = <MagicMock name='job_queue' id='125931665969840'>
client = <httpx.AsyncClient object at 0x7288c1103e00>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBTTREMTI5WEMzTUEyWVI0TUdaNiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NjJ9.szXag1-siVgKA60qoDQ8OMPZZx8rrvsv_S3HWNtL_qU'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_cancel_job_not_found(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test cancellation of non-existent job."""
        job_id = "550e8400-e29b-41d4-a716-446655440000"
        mock_job_queue.cancel_job.return_value = False
    
>       response = await client.post(f"/api/v1/jobs/{job_id}/cancel", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:238: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4022' coro=<TestJobsUnit.test_cancel_job_not_found() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBTTREMTI5WEMzTUEyWVI0TUdaNiIsImVtYWlsIjoidXNlcjMxZDI4OGRjQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMzFkMjg4ZGMiLCJqdGkiOiIzMGViMTgxZC00M2I2LTQ5ZmMtYWYzNy1iYjBiNGU5MTAyMjkiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzYyLCJzZXNzaW9uX2lkIjoiMmQ5YWQxOWYtODQyZC00NGNmLWE0NjQtOTczYmJhNGUyOTkyIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NjJ9.szXag1-siVgKA60qoDQ8OMPZZx8rrvsv_S3HWNtL_qU
________________ TestJobsUnit.test_cancel_job_invalid_id_format ________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x728984265850>
client = <httpx.AsyncClient object at 0x7288a1b8c440>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBTkUwS1Y2R1NHSFNBOUhIRzRQSCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NjR9.Ixs0a8tevwC1uYLgDn0gj6XYmlCSDcnGk_B-GaFc_sE'}

    @pytest.mark.unit
    async def test_cancel_job_invalid_id_format(self, client: AsyncClient, auth_headers: dict):
        """Test job cancellation with invalid job ID format."""
        invalid_job_id = "not-a-uuid"
    
>       response = await client.post(f"/api/v1/jobs/{invalid_job_id}/cancel", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:246: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4035' coro=<TestJobsUnit.test_cancel_job_invalid_id_format() running at /home/yam/chatter/tests/test_jobs_unit.py:246> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBTkUwS1Y2R1NHSFNBOUhIRzRQSCIsImVtYWlsIjoidXNlcmEwNDRiYjBiQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYTA0NGJiMGIiLCJqdGkiOiI5YzM2ODc0NS05YjdhLTQyZmEtYWU1OS05MGI3Njg2MDBiNWIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzY0LCJzZXNzaW9uX2lkIjoiZTdlYTFiZmUtMzA5Ni00YzYwLWE4NTUtNzhhOGVhNmJjZGM3IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NjR9.Ixs0a8tevwC1uYLgDn0gj6XYmlCSDcnGk_B-GaFc_sE
___________________ TestJobsUnit.test_get_job_stats_success ____________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x728984265c10>
mock_job_queue = <MagicMock name='job_queue' id='125931189171552'>
client = <httpx.AsyncClient object at 0x7288a27ca4e0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBUFI4NzhCQjNXVlNUTUdGMjNWOCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NjV9.oOv6MR3llXU9tLtbnVr-SNaHmVvxhVaXxATJTR18jII'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_get_job_stats_success(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test successful job stats retrieval."""
        mock_stats = {
            "total_jobs": 100,
            "pending_jobs": 5,
            "running_jobs": 3,
            "completed_jobs": 85,
            "failed_jobs": 7,
            "cancelled_jobs": 0,
            "queue_size": 8,
            "worker_count": 4,
            "average_processing_time": 45.5
        }
    
        mock_job_queue.get_stats.return_value = mock_stats
    
>       response = await client.get("/api/v1/jobs/stats/overview", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:267: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4048' coro=<TestJobsUnit.test_get_job_stats_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBUFI4NzhCQjNXVlNUTUdGMjNWOCIsImVtYWlsIjoidXNlcmJjZGUxOTI4QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYmNkZTE5MjgiLCJqdGkiOiJmNWU3Y2M4NC1iMTM3LTQ1MzktOWU3Yi00MzIxYmU5ZDhjY2YiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzY1LCJzZXNzaW9uX2lkIjoiNTAxNTY2MTUtMDFlNy00N2MzLWE1ZDEtODljZGNhYTJiNWM0IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NjV9.oOv6MR3llXU9tLtbnVr-SNaHmVvxhVaXxATJTR18jII
____________________ TestJobsUnit.test_cleanup_jobs_success ____________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x728984265fd0>
mock_job_queue = <MagicMock name='job_queue' id='125931186482848'>
client = <httpx.AsyncClient object at 0x7288a3a2db20>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBUjNSUUVQNUVCWVA2UTZUUFlRSiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NjZ9.w0y2_lUSTofDEMLxdAJqkGDM7jKX9I7nuyKC8_jbyyE'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_cleanup_jobs_success(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test successful job cleanup."""
        mock_job_queue.cleanup_completed_jobs.return_value = {
            "cleaned_count": 25,
            "remaining_count": 75
        }
    
>       response = await client.post("/api/v1/jobs/cleanup", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:285: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4061' coro=<TestJobsUnit.test_cleanup_jobs_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBUjNSUUVQNUVCWVA2UTZUUFlRSiIsImVtYWlsIjoidXNlcjg4OGQ4ZjNhQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyODg4ZDhmM2EiLCJqdGkiOiJmMjM4Zjg5Mi02MDRjLTRhODktYjBjYy1lZjY1ZTQxNmZjNzIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzY2LCJzZXNzaW9uX2lkIjoiZDhmNWEyZjgtYWVjMy00Y2ZmLTg0NDMtOTVhNjMyNWY5ZTE1IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NjZ9.w0y2_lUSTofDEMLxdAJqkGDM7jKX9I7nuyKC8_jbyyE
__________________ TestJobsUnit.test_job_queue_error_handling __________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x728984266390>
mock_job_queue = <MagicMock name='job_queue' id='125931147440928'>
client = <httpx.AsyncClient object at 0x7288a14f2000>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBU0VKMDdSNDlNOEZNTUI3WktUUCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1Njh9.xXdcCBdRB8EBB-H8GCjfW4h4beUYNn94QT2IGDFr9iM'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_job_queue_error_handling(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test job queue error handling."""
        mock_job_queue.submit.side_effect = Exception("Job queue error")
    
        job_data = {
            "name": "Test Job",
            "function_name": "test_function",
            "args": [],
            "kwargs": {}
        }
    
>       response = await client.post("/api/v1/jobs/", json=job_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:305: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4074' coro=<TestJobsUnit.test_job_queue_error_handling() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBU0VKMDdSNDlNOEZNTUI3WktUUCIsImVtYWlsIjoidXNlcjljMmJiZWY2QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOWMyYmJlZjYiLCJqdGkiOiI0NWU4YTQ4My0xZDg3LTQ5NjQtYjhkYS05YjFkN2Y0NTRhZjYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzY4LCJzZXNzaW9uX2lkIjoiNDNmMmUzOGItYTJmNy00MmVhLTg3NDYtOTk5NTI4MDZiYTAzIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1Njh9.xXdcCBdRB8EBB-H8GCjfW4h4beUYNn94QT2IGDFr9iM
____________________ TestJobsUnit.test_list_jobs_pagination ____________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x728984266750>
mock_job_queue = <MagicMock name='job_queue' id='125931181175776'>
client = <httpx.AsyncClient object at 0x7288a1a6f9b0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBVzBKRjIwUk0xQ1hEVlFYRVJBViIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NzB9.YQbMznpCCkRH9IJ0KuleJN-0pcCoe-zyUzpB4PG3Mmc'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_list_jobs_pagination(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test job listing pagination."""
        mock_job_queue.list_jobs.return_value = {
            "jobs": [],
            "total": 50,
            "page": 2,
            "per_page": 20
        }
    
>       response = await client.get("/api/v1/jobs/?page=2&per_page=20", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:319: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4087' coro=<TestJobsUnit.test_list_jobs_pagination() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENBVzBKRjIwUk0xQ1hEVlFYRVJBViIsImVtYWlsIjoidXNlcjYwMjVkMGVjQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNjAyNWQwZWMiLCJqdGkiOiIwYjdkNjUyZC0xYWU4LTQxMTgtYWE1Yi0zMzFmZWU0MGQ2MDUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwNzcwLCJzZXNzaW9uX2lkIjoiYjFjN2Q4OTctYzU3Yy00ZmQ3LWJkOWUtMzRjOTllNDViZjVjIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI1NzB9.YQbMznpCCkRH9IJ0KuleJN-0pcCoe-zyUzpB4PG3Mmc
__________________ TestMCPToolService.test_add_server_success __________________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7289842745f0>

    @pytest.mark.asyncio
    async def test_add_server_success(self):
        """Test successfully adding a server."""
        server_config = RemoteMCPServer(
            name="test_server",
            base_url=HttpUrl("https://mcp.example.com"),
            transport_type="http"
        )
    
        with patch.object(self.service, '_convert_server_to_connection') as mock_convert:
            with patch.object(self.service, '_update_client') as mock_update:
                mock_convert.return_value = MagicMock(spec=Connection)
    
>               result = await self.service.add_server(server_config)
                               ^^^^^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:255: AttributeError
_____________ TestMCPToolService.test_add_server_disabled_service ______________

self = <tests.test_mcp_service.TestMCPToolService object at 0x728984275820>

    @pytest.mark.asyncio
    async def test_add_server_disabled_service(self):
        """Test adding server when service is disabled."""
        self.service.enabled = False
    
        server_config = RemoteMCPServer(
            name="test_server",
            base_url=HttpUrl("https://mcp.example.com"),
            transport_type="http"
        )
    
>       result = await self.service.add_server(server_config)
                       ^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:275: AttributeError
_____________ TestMCPToolService.test_add_server_validation_error ______________

self = <tests.test_mcp_service.TestMCPToolService object at 0x728984275100>

    @pytest.mark.asyncio
    async def test_add_server_validation_error(self):
        """Test adding server with invalid configuration."""
        server_config = RemoteMCPServer(
            name="",  # Invalid: empty name
            base_url=HttpUrl("https://mcp.example.com"),
            transport_type="http"
        )
    
>       result = await self.service.add_server(server_config)
                       ^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:289: AttributeError
__________________ TestMCPToolService.test_call_tool_success ___________________

self = <tests.test_mcp_service.TestMCPToolService object at 0x728984277260>

    @pytest.mark.asyncio
    async def test_call_tool_success(self):
        """Test successfully calling a tool."""
        # Add server and cached tools
        self.service.servers["test_server"] = MagicMock()
        mock_tool = MagicMock(spec=BaseTool)
        mock_tool.name = "test_tool"
        self.service.tools_cache["test_server"] = [mock_tool]
    
        mock_client = MagicMock()
        mock_client.call_tool = AsyncMock(return_value={"result": "success"})
    
        with patch.object(self.service, '_get_client', return_value=mock_client):
            result = await self.service.call_tool(
                "test_tool",
                {"param": "value"}
            )
    
>       assert result == {"result": "success"}
E       AssertionError: assert {'error': 'To...': False, ...} == {'result': 'success'}
E         
E         Left contains 5 more items:
E         {'error': 'Tool not found: test_tool',
E          'response_time_ms': 0.37598609924316406,
E          'server': 'unknown',
E          'success': False,
E          'tool': 'test_tool'}...
E         
E         ...Full output truncated (12 lines hidden), use '-vv' to show

tests/test_mcp_service.py:451: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    chatter.services.mcp:mcp.py:356 [2m2025-09-05T16:46:11.563171Z[0m [[31m[1merror    [0m] [1mFailed to get tools from MCP servers[0m [[34m[1mchatter.services.mcp[0m] [36merror[0m=[35mobject MagicMock can't be used in 'await' expression[0m
ERROR    chatter.services.mcp:mcp.py:492 [2m2025-09-05T16:46:11.563289Z[0m [[31m[1merror    [0m] [1mMCP tool call failed          [0m [[34m[1mchatter.services.mcp[0m] [36merror[0m=[35mTool not found: test_tool[0m [36mserver[0m=[35mNone[0m [36mtool[0m=[35mtest_tool[0m
______________ TestMCPToolService.test_call_tool_disabled_service ______________

self = <tests.test_mcp_service.TestMCPToolService object at 0x728984277500>

    @pytest.mark.asyncio
    async def test_call_tool_disabled_service(self):
        """Test calling tool when service is disabled."""
        self.service.enabled = False
    
        result = await self.service.call_tool("test_tool", {})
    
>       assert result is None
E       AssertionError: assert {'error': 'Tool not found: test_tool', 'response_time_ms': 0.01811981201171875, 'server': 'unknown', 'success': False, ...} is None

tests/test_mcp_service.py:464: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    chatter.services.mcp:mcp.py:492 [2m2025-09-05T16:46:11.576909Z[0m [[31m[1merror    [0m] [1mMCP tool call failed          [0m [[34m[1mchatter.services.mcp[0m] [36merror[0m=[35mTool not found: test_tool[0m [36mserver[0m=[35mNone[0m [36mtool[0m=[35mtest_tool[0m
_____________________ TestMCPToolService.test_list_servers _____________________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7289842777a0>

    @pytest.mark.asyncio
    async def test_list_servers(self):
        """Test listing servers."""
        server1 = RemoteMCPServer(
            name="server1",
            base_url=HttpUrl("https://mcp1.example.com"),
            transport_type="http"
        )
        server2 = RemoteMCPServer(
            name="server2",
            base_url=HttpUrl("https://mcp2.example.com"),
            transport_type="sse",
            enabled=False
        )
    
        self.service.servers["server1"] = server1
        self.service.servers["server2"] = server2
    
>       servers = self.service.list_servers()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MCPToolService' object has no attribute 'list_servers'

tests/test_mcp_service.py:484: AttributeError
___________________ TestMCPToolService.test_get_server_info ____________________

self = <tests.test_mcp_service.TestMCPToolService object at 0x728984277a70>

    @pytest.mark.asyncio
    async def test_get_server_info(self):
        """Test getting server information."""
        server_config = RemoteMCPServer(
            name="test_server",
            base_url=HttpUrl("https://mcp.example.com"),
            transport_type="http",
            timeout=60
        )
        self.service.servers["test_server"] = server_config
        self.service.tools_cache["test_server"] = [MagicMock(), MagicMock()]
    
>       info = await self.service.get_server_info("test_server")
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MCPToolService' object has no attribute 'get_server_info'

tests/test_mcp_service.py:504: AttributeError
_____________ TestMCPToolService.test_get_server_info_nonexistent ______________

self = <tests.test_mcp_service.TestMCPToolService object at 0x728984274620>

    @pytest.mark.asyncio
    async def test_get_server_info_nonexistent(self):
        """Test getting info for nonexistent server."""
>       info = await self.service.get_server_info("nonexistent")
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MCPToolService' object has no attribute 'get_server_info'

tests/test_mcp_service.py:520: AttributeError
_______________ TestMCPServiceIntegration.test_server_lifecycle ________________

self = <tests.test_mcp_service.TestMCPServiceIntegration object at 0x728984276810>

    @pytest.mark.asyncio
    async def test_server_lifecycle(self):
        """Test complete server lifecycle: add, discover, call, remove."""
        server_config = RemoteMCPServer(
            name="test_server",
            base_url=HttpUrl("https://mcp.example.com"),
            transport_type="http"
        )
    
        # Mock the MCP client interactions
        mock_tool = StructuredTool.from_function(
            func=lambda x: f"Result: {x}",
            name="test_tool",
            description="Test tool"
        )
    
        mock_client = MagicMock()
        mock_client.get_tools = AsyncMock(return_value=[mock_tool])
        mock_client.call_tool = AsyncMock(return_value={"result": "success"})
    
        with patch.object(self.service, '_get_client', return_value=mock_client):
            with patch.object(self.service, '_convert_server_to_connection') as mock_convert:
                with patch.object(self.service, '_update_client'):
                    mock_convert.return_value = MagicMock(spec=Connection)
    
                    # Add server
>                   assert await self.service.add_server(server_config) is True
                                 ^^^^^^^^^^^^^^^^^^^^^^^
E                   AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:585: AttributeError
__________ TestMCPServiceIntegration.test_multiple_servers_management __________

self = <tests.test_mcp_service.TestMCPServiceIntegration object at 0x7289842765a0>

    @pytest.mark.asyncio
    async def test_multiple_servers_management(self):
        """Test managing multiple MCP servers."""
        server1 = RemoteMCPServer(
            name="server1",
            base_url=HttpUrl("https://mcp1.example.com"),
            transport_type="http"
        )
        server2 = RemoteMCPServer(
            name="server2",
            base_url=HttpUrl("https://mcp2.example.com"),
            transport_type="sse"
        )
    
        with patch.object(self.service, '_convert_server_to_connection') as mock_convert:
            with patch.object(self.service, '_update_client'):
                mock_convert.return_value = MagicMock(spec=Connection)
    
                # Add both servers
>               assert await self.service.add_server(server1) is True
                             ^^^^^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:625: AttributeError
___________ TestMCPServiceIntegration.test_error_recovery_scenarios ____________

self = <tests.test_mcp_service.TestMCPServiceIntegration object at 0x728984275f10>

    @pytest.mark.asyncio
    async def test_error_recovery_scenarios(self):
        """Test error recovery and circuit breaker functionality."""
        server_config = RemoteMCPServer(
            name="unreliable_server",
            base_url=HttpUrl("https://unreliable.example.com"),
            transport_type="http"
        )
    
        with patch.object(self.service, '_convert_server_to_connection'):
            with patch.object(self.service, '_update_client'):
                # Add server successfully
>               assert await self.service.add_server(server_config) is True
                             ^^^^^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:654: AttributeError
__________ TestSecurityHeadersMiddleware.test_security_headers_added ___________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 32, in test_security_headers_added
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 32, in test_security_headers_added
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x72898429f200>

    def test_security_headers_added(self):
        """Test that security headers are added to responses."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:32: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7288a1e533e0>
request = <starlette.middleware.base._CachedRequest object at 0x7288a1e53b90>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7288a0dd8360>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
______ TestSecurityHeadersMiddleware.test_content_security_policy_header _______
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 52, in test_content_security_policy_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 52, in test_content_security_policy_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x72898429f380>

    def test_content_security_policy_header(self):
        """Test Content Security Policy header configuration."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:52: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7288a1e5e7e0>
request = <starlette.middleware.base._CachedRequest object at 0x7288a1e5e9f0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7288a0dd9e40>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
__________ TestSecurityHeadersMiddleware.test_x_frame_options_header ___________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 65, in test_x_frame_options_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 65, in test_x_frame_options_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x72898429f590>

    def test_x_frame_options_header(self):
        """Test X-Frame-Options header."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:65: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7288a1e49ca0>
request = <starlette.middleware.base._CachedRequest object at 0x7288a1e49a30>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7288a0ddb1a0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
_______ TestSecurityHeadersMiddleware.test_x_content_type_options_header _______
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 71, in test_x_content_type_options_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 71, in test_x_content_type_options_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x72898429f7a0>

    def test_x_content_type_options_header(self):
        """Test X-Content-Type-Options header."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:71: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7288a1ee17f0>
request = <starlette.middleware.base._CachedRequest object at 0x7288a1ee0da0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7288a0d70540>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
__________ TestSecurityHeadersMiddleware.test_x_xss_protection_header __________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 77, in test_x_xss_protection_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 77, in test_x_xss_protection_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x72898429f9b0>

    def test_x_xss_protection_header(self):
        """Test X-XSS-Protection header."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:77: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7288a0dd78f0>
request = <starlette.middleware.base._CachedRequest object at 0x7288a0dd4a10>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7288a0d716c0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
__________ TestSecurityHeadersMiddleware.test_referrer_policy_header ___________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 83, in test_referrer_policy_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 83, in test_referrer_policy_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x72898429fbc0>

    def test_referrer_policy_header(self):
        """Test Referrer-Policy header."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:83: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7288a0d1a150>
request = <starlette.middleware.base._CachedRequest object at 0x7288a0d1a390>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7288a0d72a20>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
_________ TestSecurityHeadersMiddleware.test_permissions_policy_header _________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 89, in test_permissions_policy_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 89, in test_permissions_policy_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7289842d40b0>

    def test_permissions_policy_header(self):
        """Test Permissions-Policy header."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:89: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7288a0d46360>
request = <starlette.middleware.base._CachedRequest object at 0x7288a0d465d0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7288a0d73e20>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
_____ TestSecurityHeadersMiddleware.test_strict_transport_security_enabled _____
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 110, in test_strict_transport_security_enabled
    |     response = client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 110, in test_strict_transport_security_enabled
    response = client.get("/test")
               ^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7289842d4230>

    def test_strict_transport_security_enabled(self):
        """Test HSTS header when enabled."""
        app = FastAPI()
    
        @app.get("/test")
        async def test_endpoint():
            return {"message": "test"}
    
        app.add_middleware(SecurityHeadersMiddleware, strict_transport_security=True)
        client = TestClient(app)
    
>       response = client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:110: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7288a0defb00>
request = <starlette.middleware.base._CachedRequest object at 0x7288a0defd40>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7288a0d99800>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
____ TestSecurityHeadersMiddleware.test_strict_transport_security_disabled _____
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 128, in test_strict_transport_security_disabled
    |     response = client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 128, in test_strict_transport_security_disabled
    response = client.get("/test")
               ^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x72898429ffe0>

    def test_strict_transport_security_disabled(self):
        """Test HSTS header when disabled."""
        app = FastAPI()
    
        @app.get("/test")
        async def test_endpoint():
            return {"message": "test"}
    
        app.add_middleware(SecurityHeadersMiddleware, strict_transport_security=False)
        client = TestClient(app)
    
>       response = client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:128: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7288a0da8ad0>
request = <starlette.middleware.base._CachedRequest object at 0x7288a0da9940>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7288a0d9b2e0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
_ TestSecurityHeadersMiddleware.test_security_headers_on_different_response_types _
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 152, in test_security_headers_on_different_response_types
    |     response = client.get("/json")
    |                ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 152, in test_security_headers_on_different_response_types
    response = client.get("/json")
               ^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x72898429fa40>

    def test_security_headers_on_different_response_types(self):
        """Test security headers added to different response types."""
        app = FastAPI()
    
        @app.get("/json")
        async def json_endpoint():
            return {"message": "json"}
    
        @app.get("/html")
        async def html_endpoint():
            return Response(content="<html><body>test</body></html>", media_type="text/html")
    
        @app.get("/error")
        async def error_endpoint():
            return JSONResponse(content={"error": "test"}, status_code=400)
    
        app.add_middleware(SecurityHeadersMiddleware)
        client = TestClient(app)
    
        # Test JSON response
>       response = client.get("/json")
                   ^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:152: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7288a0d0a3f0>
request = <starlette.middleware.base._CachedRequest object at 0x7288a0d0a5a0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7288a0ddd4e0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
__ TestSecurityHeadersMiddleware.test_security_headers_dont_override_existing __
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 176, in test_security_headers_dont_override_existing
    |     response = client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 176, in test_security_headers_dont_override_existing
    response = client.get("/test")
               ^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7289842d43e0>

    def test_security_headers_dont_override_existing(self):
        """Test that security headers don't override existing ones."""
        app = FastAPI()
    
        @app.get("/test")
        async def test_endpoint():
            response = JSONResponse(content={"message": "test"})
            response.headers["X-Frame-Options"] = "SAMEORIGIN"
            return response
    
        app.add_middleware(SecurityHeadersMiddleware)
        client = TestClient(app)
    
>       response = client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:176: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7288a0d16ff0>
request = <starlette.middleware.base._CachedRequest object at 0x7288a0d171d0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7288a0ddef20>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
________ TestAuthRateLimitMiddleware.test_login_endpoint_rate_limiting _________

self = <tests.test_middleware.TestAuthRateLimitMiddleware object at 0x7289842d4920>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='125931139363376'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    async def test_login_endpoint_rate_limiting(self, mock_get_limiter):
        """Test rate limiting on login endpoint."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(False, {"retry_after": 60}))
        mock_get_limiter.return_value = mock_limiter
    
        self.app.add_middleware(AuthRateLimitMiddleware)
        client = TestClient(self.app)
    
        response = client.post("/auth/login")
    
>       assert response.status_code == status.HTTP_429_TOO_MANY_REQUESTS
E       assert 200 == 429
E        +  where 200 = <Response [200 OK]>.status_code
E        +  and   429 = status.HTTP_429_TOO_MANY_REQUESTS

tests/test_middleware.py:261: AssertionError
_______ TestAuthRateLimitMiddleware.test_register_endpoint_rate_limiting _______

self = <tests.test_middleware.TestAuthRateLimitMiddleware object at 0x7289842d4bf0>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='125931187485152'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    async def test_register_endpoint_rate_limiting(self, mock_get_limiter):
        """Test rate limiting on register endpoint."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(False, {"retry_after": 120}))
        mock_get_limiter.return_value = mock_limiter
    
        self.app.add_middleware(AuthRateLimitMiddleware)
        client = TestClient(self.app)
    
        response = client.post("/auth/register")
    
>       assert response.status_code == status.HTTP_429_TOO_MANY_REQUESTS
E       assert 200 == 429
E        +  where 200 = <Response [200 OK]>.status_code
E        +  and   429 = status.HTTP_429_TOO_MANY_REQUESTS

tests/test_middleware.py:276: AssertionError
____ TestAuthRateLimitMiddleware.test_password_reset_endpoint_rate_limiting ____

self = <tests.test_middleware.TestAuthRateLimitMiddleware object at 0x7289842d4ec0>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='125931188096416'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    async def test_password_reset_endpoint_rate_limiting(self, mock_get_limiter):
        """Test rate limiting on password reset endpoint."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(False, {"retry_after": 300}))
        mock_get_limiter.return_value = mock_limiter
    
        self.app.add_middleware(AuthRateLimitMiddleware)
        client = TestClient(self.app)
    
        response = client.post("/auth/password-reset")
    
>       assert response.status_code == status.HTTP_429_TOO_MANY_REQUESTS
E       assert 200 == 429
E        +  where 200 = <Response [200 OK]>.status_code
E        +  and   429 = status.HTTP_429_TOO_MANY_REQUESTS

tests/test_middleware.py:292: AssertionError
__________ TestAuthRateLimitMiddleware.test_client_ip_identification ___________

self = <AsyncMock name='get_unified_rate_limiter().is_allowed' id='125931187882944'>

    def assert_called_once(self):
        """assert that the mock was called only once.
        """
        if not self.call_count == 1:
            msg = ("Expected '%s' to have been called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected 'is_allowed' to have been called once. Called 0 times.

/usr/lib64/python3.12/unittest/mock.py:928: AssertionError

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestAuthRateLimitMiddleware object at 0x7289842d5730>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='125931188214128'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    async def test_client_ip_identification(self, mock_get_limiter):
        """Test client IP identification for rate limiting."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(True, {}))
        mock_get_limiter.return_value = mock_limiter
    
        self.app.add_middleware(AuthRateLimitMiddleware)
        client = TestClient(self.app)
    
        # Test with X-Forwarded-For header
        response = client.post(
            "/auth/login",
            headers={"X-Forwarded-For": "192.168.1.100, 10.0.0.1"}
        )
    
        assert response.status_code == 200
        # Verify that rate limiter was called with client IP
>       mock_limiter.is_allowed.assert_called_once()
E       AssertionError: Expected 'is_allowed' to have been called once. Called 0 times.

tests/test_middleware.py:342: AssertionError
_____ TestAuthRateLimitMiddleware.test_rate_limit_with_user_agent_tracking _____

self = <AsyncMock name='get_unified_rate_limiter().is_allowed' id='125931139363520'>

    def assert_called_once(self):
        """assert that the mock was called only once.
        """
        if not self.call_count == 1:
            msg = ("Expected '%s' to have been called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected 'is_allowed' to have been called once. Called 0 times.

/usr/lib64/python3.12/unittest/mock.py:928: AssertionError

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestAuthRateLimitMiddleware object at 0x7289842d5a00>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='125931187349136'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    async def test_rate_limit_with_user_agent_tracking(self, mock_get_limiter):
        """Test rate limiting considers user agent."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(True, {}))
        mock_get_limiter.return_value = mock_limiter
    
        self.app.add_middleware(AuthRateLimitMiddleware)
        client = TestClient(self.app)
    
        response = client.post(
            "/auth/login",
            headers={"User-Agent": "TestBot/1.0"}
        )
    
        assert response.status_code == 200
        # Verify rate limiter was called
>       mock_limiter.is_allowed.assert_called_once()
E       AssertionError: Expected 'is_allowed' to have been called once. Called 0 times.

tests/test_middleware.py:361: AssertionError
____________ TestMiddlewareIntegration.test_both_middleware_applied ____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/unittest/mock.py", line 1396, in patched
    |     return func(*newargs, **newkeywargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 470, in test_both_middleware_applied
    |     response = self.client.post("/auth/login")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 470, in test_both_middleware_applied
    response = self.client.post("/auth/login")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareIntegration object at 0x7289842d6090>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='125931187904224'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    def test_both_middleware_applied(self, mock_get_limiter):
        """Test that both security and rate limiting middleware are applied."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(True, {}))
        mock_get_limiter.return_value = mock_limiter
    
>       response = self.client.post("/auth/login")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:470: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
../.local/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/middleware/auth_security.py:61: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7288a0a6b440>
request = <starlette.middleware.base._CachedRequest object at 0x7288a0a6bb00>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7288a3b128e0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
___ TestMiddlewareIntegration.test_security_headers_on_rate_limited_response ___
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/unittest/mock.py", line 1396, in patched
    |     return func(*newargs, **newkeywargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 488, in test_security_headers_on_rate_limited_response
    |     response = self.client.post("/auth/login")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 488, in test_security_headers_on_rate_limited_response
    response = self.client.post("/auth/login")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareIntegration object at 0x7289842d5c10>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='125931188045152'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    def test_security_headers_on_rate_limited_response(self, mock_get_limiter):
        """Test that security headers are added even on rate limited responses."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(False, {"retry_after": 60}))
        mock_get_limiter.return_value = mock_limiter
    
>       response = self.client.post("/auth/login")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:488: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
../.local/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/middleware/auth_security.py:61: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7288a0a58740>
request = <starlette.middleware.base._CachedRequest object at 0x7288a0a59070>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7288a0a78040>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
___ TestMiddlewareIntegration.test_non_auth_endpoints_only_security_headers ____
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 498, in test_non_auth_endpoints_only_security_headers
    |     response = self.client.get("/api/data")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 498, in test_non_auth_endpoints_only_security_headers
    response = self.client.get("/api/data")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareIntegration object at 0x7289842d5880>

    def test_non_auth_endpoints_only_security_headers(self):
        """Test that non-auth endpoints only get security headers."""
>       response = self.client.get("/api/data")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:498: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/middleware/auth_security.py:61: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7288a0a274a0>
request = <starlette.middleware.base._CachedRequest object at 0x7288a0a5b410>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7288a3b13ec0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
___________ TestMiddlewareIntegration.test_middleware_order_matters ____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/unittest/mock.py", line 1396, in patched
    |     return func(*newargs, **newkeywargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 516, in test_middleware_order_matters
    |     response = self.client.post("/auth/login")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 516, in test_middleware_order_matters
    response = self.client.post("/auth/login")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareIntegration object at 0x7289842d5250>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='125931136270208'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    def test_middleware_order_matters(self, mock_get_limiter):
        """Test that middleware order affects behavior."""
        # This test verifies that security headers are applied
        # even when rate limiting middleware intervenes
    
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(False, {"retry_after": 60}))
        mock_get_limiter.return_value = mock_limiter
    
>       response = self.client.post("/auth/login")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:516: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
../.local/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/middleware/auth_security.py:61: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7288a0af5ac0>
request = <starlette.middleware.base._CachedRequest object at 0x7288a0af6690>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7288a0a7b2e0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
____________ TestMiddlewareIntegration.test_middleware_performance _____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 530, in test_middleware_performance
    |     response = self.client.get("/api/data")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 530, in test_middleware_performance
    response = self.client.get("/api/data")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareIntegration object at 0x7289842d4e90>

    def test_middleware_performance(self):
        """Test middleware performance with multiple requests."""
        import time
    
        start_time = time.time()
    
        # Make multiple requests
        for _ in range(10):
>           response = self.client.get("/api/data")
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:530: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/middleware/auth_security.py:61: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7288a0aeacc0>
request = <starlette.middleware.base._CachedRequest object at 0x7288a0aeb6e0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7288a0a5ce00>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
____________ TestMiddlewareEdgeCases.test_empty_app_with_middleware ____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 566, in test_empty_app_with_middleware
    |     response = client.get("/nonexistent")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 566, in test_empty_app_with_middleware
    response = client.get("/nonexistent")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareEdgeCases object at 0x7289842d6a20>

    def test_empty_app_with_middleware(self):
        """Test middleware with empty app (no routes)."""
        self.app.add_middleware(SecurityHeadersMiddleware)
    
        client = TestClient(self.app)
    
        # Should return 404 with security headers
>       response = client.get("/nonexistent")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:566: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7288a0a1b980>
request = <starlette.middleware.base._CachedRequest object at 0x7288a0a1b230>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7288a0a5e480>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
__ TestTransactionManagement.test_create_model_transaction_rollback_on_error ___

self = <tests.test_model_registry_fixes.TestTransactionManagement object at 0x7289842f9880>
service = <chatter.core.model_registry.ModelRegistryService object at 0x7288a06bdf10>
sample_provider = '01K4DCB6WPN116RBCMQW7E0JHJ'

    async def test_create_model_transaction_rollback_on_error(
        self, service: ModelRegistryService, sample_provider: str
    ):
        """Test that model creation rolls back properly on error."""
        import uuid
        unique_id = str(uuid.uuid4())[:8]
        # Create a model with invalid data to trigger an error
        model_data = ModelDefCreate(
            provider_id=sample_provider,
            name=f"test_model_{unique_id}",
            model_type=ModelType.LLM,
            display_name="Test Model",
            model_name="gpt-4",
        )
    
        # First create should succeed
        model = await service.create_model(model_data)
        assert model is not None
    
        # Second create with same name should fail and not leave partial data
        with pytest.raises(Exception):  # Could be IntegrityError or ValidationError
            await service.create_model(model_data)
    
        # Verify no partial data was left
>       models = await service.list_models(provider_id=sample_provider)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_model_registry_fixes.py:364: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/core/model_registry.py:332: in list_models
    total = await self.session.scalar(count_query)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:519: in scalar
    return await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:190: in greenlet_spawn
    result = context.switch(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2413: in scalar
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:101: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7288a1163e90>
operation_name = '_connection_for_bind'
state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "uq_provider_model_name"
E               DETAIL:  Key (provider_id, name)=(01K4DCB6WPN116RBCMQW7E0JHJ, test_model_8afa592b) already exists.
E               [SQL: INSERT INTO model_defs (provider_id, name, model_type, display_name, description, model_name, max_tokens, context_length, dimensions, chunk_size, supports_batch, max_batch_size, default_config, is_active, is_default, id) VALUES ($1::VARCHAR, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR, $7::INTEGER, $8::INTEGER, $9::INTEGER, $10::INTEGER, $11::BOOLEAN, $12::INTEGER, $13::JSON, $14::BOOLEAN, $15::BOOLEAN, $16::VARCHAR) RETURNING model_defs.created_at, model_defs.updated_at]
E               [parameters: ('01K4DCB6WPN116RBCMQW7E0JHJ', 'test_model_8afa592b', <ModelType.LLM: 'llm'>, 'Test Model', None, 'gpt-4', None, None, None, None, False, None, '{}', True, False, '01K4DCB6XTJMAR7V8KJF6DN5X6')]
E               (Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)

../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
________________ TestBasePlugin.test_base_plugin_initialization ________________

self = <tests.test_plugins.TestBasePlugin object at 0x728984116180>

    def test_base_plugin_initialization(self):
        """Test BasePlugin initialization."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
        config = {"param1": "value1", "param2": 123}
>       plugin = TestPlugin(config)
                 ^^^^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:53: TypeError
________________ TestBasePlugin.test_base_plugin_default_config ________________

self = <tests.test_plugins.TestBasePlugin object at 0x728984115e50>

    def test_base_plugin_default_config(self):
        """Test BasePlugin with default empty config."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:72: TypeError
___________ TestBasePlugin.test_base_plugin_get_configuration_schema ___________

self = <tests.test_plugins.TestBasePlugin object at 0x7289842f88f0>

    @pytest.mark.asyncio
    async def test_base_plugin_get_configuration_schema(self):
        """Test default configuration schema."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:91: TypeError
_____________ TestBasePlugin.test_validate_configuration_no_schema _____________

self = <tests.test_plugins.TestBasePlugin object at 0x728984134cb0>

    @pytest.mark.asyncio
    async def test_validate_configuration_no_schema(self):
        """Test configuration validation with no schema."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:115: TypeError
____________ TestBasePlugin.test_validate_configuration_with_schema ____________

self = <tests.test_plugins.TestBasePlugin object at 0x728984134f20>

    @pytest.mark.asyncio
    async def test_validate_configuration_with_schema(self):
        """Test configuration validation with custom schema."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            async def get_configuration_schema(self):
                return {
                    "type": "object",
                    "properties": {
                        "required_param": {"type": "string"},
                        "optional_param": {"type": "number"}
                    },
                    "required": ["required_param"]
                }
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:145: TypeError
___________ TestBasePlugin.test_validate_configuration_type_checking ___________

self = <tests.test_plugins.TestBasePlugin object at 0x728984135190>

    @pytest.mark.asyncio
    async def test_validate_configuration_type_checking(self):
        """Test configuration validation with type checking."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            async def get_configuration_schema(self):
                return {
                    "type": "object",
                    "properties": {
                        "string_param": {"type": "string"},
                        "number_param": {"type": "number"},
                        "boolean_param": {"type": "boolean"},
                        "object_param": {"type": "object"},
                        "array_param": {"type": "array"}
                    }
                }
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:183: TypeError
__________ TestBasePlugin.test_validate_configuration_error_handling ___________

self = <tests.test_plugins.TestBasePlugin object at 0x728984135400>

    @pytest.mark.asyncio
    async def test_validate_configuration_error_handling(self):
        """Test configuration validation error handling."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            async def get_configuration_schema(self):
                raise Exception("Schema generation error")
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:218: TypeError
_________________ TestToolPlugin.test_tool_plugin_inheritance __________________

self = <tests.test_plugins.TestToolPlugin object at 0x728984135580>

    def test_tool_plugin_inheritance(self):
        """Test ToolPlugin inherits from BasePlugin."""
    
        class TestToolPlugin(ToolPlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            def get_tools(self):
                return [MockBaseTool("test_tool", "Test tool description")]
    
>       plugin = TestToolPlugin()
                 ^^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestToolPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:243: TypeError
_________________ TestToolPlugin.test_get_tools_implementation _________________

self = <tests.test_plugins.TestToolPlugin object at 0x7289841358b0>

    def test_get_tools_implementation(self):
        """Test get_tools implementation."""
    
        class TestToolPlugin(ToolPlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            def get_tools(self):
                return [
                    MockBaseTool("tool1", "First tool"),
                    MockBaseTool("tool2", "Second tool")
                ]
    
>       plugin = TestToolPlugin()
                 ^^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestToolPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:282: TypeError
_____________ TestWorkflowPlugin.test_workflow_plugin_inheritance ______________

self = <tests.test_plugins.TestWorkflowPlugin object at 0x728984135bb0>

    def test_workflow_plugin_inheritance(self):
        """Test WorkflowPlugin inherits from BasePlugin."""
    
        class TestWorkflowPlugin(WorkflowPlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            async def execute_workflow(self, workflow_id: str, params: dict):
                return {"result": "workflow executed"}
    
>       plugin = TestWorkflowPlugin()
                 ^^^^^^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestWorkflowPlugin without an implementation for abstract methods 'create_workflow', 'get_capabilities', 'shutdown'

tests/test_plugins.py:309: TypeError
_____________ TestPluginManager.test_plugin_manager_initialization _____________

self = <tests.test_plugins.TestPluginManager object at 0x7289841360c0>

    def test_plugin_manager_initialization(self):
        """Test PluginManager initialization."""
        assert isinstance(self.plugin_manager.plugins, dict)
>       assert isinstance(self.plugin_manager.plugin_instances, dict)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'PluginManager' object has no attribute 'plugin_instances'

tests/test_plugins.py:340: AttributeError
_____________ TestPluginManager.test_get_plugin_directory_default ______________

self = <tests.test_plugins.TestPluginManager object at 0x728984136240>

    def test_get_plugin_directory_default(self):
        """Test getting default plugin directory."""
>       plugins_dir = self.plugin_manager._get_plugin_directory()
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'PluginManager' object has no attribute '_get_plugin_directory'. Did you mean: 'plugins_directory'?

tests/test_plugins.py:345: AttributeError
______________ TestPluginManager.test_get_plugin_directory_custom ______________

self = <tests.test_plugins.TestPluginManager object at 0x728984136450>

    def test_get_plugin_directory_custom(self):
        """Test getting custom plugin directory."""
        with patch('chatter.services.plugins.settings') as mock_settings:
            mock_settings.plugins_directory = "/custom/plugins"
    
>           plugins_dir = self.plugin_manager._get_plugin_directory()
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           AttributeError: 'PluginManager' object has no attribute '_get_plugin_directory'. Did you mean: 'plugins_directory'?

tests/test_plugins.py:353: AttributeError
_____________ TestPluginManager.test_load_plugin_from_file_success _____________

self = <tests.test_plugins.TestPluginManager object at 0x728984136660>

        @pytest.mark.asyncio
        async def test_load_plugin_from_file_success(self):
            """Test successfully loading plugin from file."""
    
            # Create a temporary plugin file
            plugin_code = '''
    from chatter.services.plugins import ToolPlugin
    
    class TestFilePlugin(ToolPlugin):
        async def initialize(self):
            pass
    
        async def cleanup(self):
            pass
    
        async def health_check(self):
            return {"status": "healthy"}
    
        def get_tools(self):
            from tests.test_plugins import MockBaseTool
            return [MockBaseTool("file_tool", "Tool from file")]
    
    # Plugin entry point
    plugin_class = TestFilePlugin
    '''
    
            with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
                f.write(plugin_code)
                plugin_file = Path(f.name)
    
            try:
>               plugin_instance = await self.plugin_manager.load_plugin_from_file(
                                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                    plugin_file, "test_file_plugin", {}
                )
E               AttributeError: 'PluginManager' object has no attribute 'load_plugin_from_file'

tests/test_plugins.py:387: AttributeError
__________ TestPluginManager.test_load_plugin_from_file_missing_file ___________

self = <tests.test_plugins.TestPluginManager object at 0x728984136870>

    @pytest.mark.asyncio
    async def test_load_plugin_from_file_missing_file(self):
        """Test loading plugin from non-existent file."""
        non_existent_file = Path("/non/existent/plugin.py")
    
        with pytest.raises(PluginError, match="Plugin file not found"):
>           await self.plugin_manager.load_plugin_from_file(
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                non_existent_file, "missing_plugin", {}
            )
E           AttributeError: 'PluginManager' object has no attribute 'load_plugin_from_file'

tests/test_plugins.py:404: AttributeError
__________ TestPluginManager.test_load_plugin_from_file_syntax_error ___________

self = <tests.test_plugins.TestPluginManager object at 0x728984136b10>

        @pytest.mark.asyncio
        async def test_load_plugin_from_file_syntax_error(self):
            """Test loading plugin with syntax error."""
    
            # Create plugin file with syntax error
            plugin_code = '''
    from chatter.services.plugins import ToolPlugin
    
    class TestFilePlugin(ToolPlugin):
        async def initialize(self)
            # Missing colon - syntax error
            pass
    '''
    
            with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
                f.write(plugin_code)
                plugin_file = Path(f.name)
    
            try:
                with pytest.raises(PluginError, match="Failed to load plugin"):
>                   await self.plugin_manager.load_plugin_from_file(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                        plugin_file, "syntax_error_plugin", {}
                    )
E                   AttributeError: 'PluginManager' object has no attribute 'load_plugin_from_file'

tests/test_plugins.py:428: AttributeError
_________________ TestPluginManager.test_unload_plugin_success _________________

self = <tests.test_plugins.TestPluginManager object at 0x728984136360>

    @pytest.mark.asyncio
    async def test_unload_plugin_success(self):
        """Test successfully unloading a plugin."""
    
        # Create a mock plugin instance
        mock_plugin = MagicMock()
        mock_plugin.cleanup = AsyncMock()
    
>       plugin_instance = PluginInstance(
            plugin_id="test_plugin",
            name="Test Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=mock_plugin,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:442: ValidationError
________________ TestPluginManager.test_unload_plugin_not_found ________________

self = <tests.test_plugins.TestPluginManager object at 0x728984135760>

    @pytest.mark.asyncio
    async def test_unload_plugin_not_found(self):
        """Test unloading non-existent plugin."""
>       result = await self.plugin_manager.unload_plugin("non_existent_plugin")
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'PluginManager' object has no attribute 'unload_plugin'. Did you mean: 'install_plugin'?

tests/test_plugins.py:464: AttributeError
______________ TestPluginManager.test_unload_plugin_cleanup_error ______________

self = <tests.test_plugins.TestPluginManager object at 0x7289841351f0>

    @pytest.mark.asyncio
    async def test_unload_plugin_cleanup_error(self):
        """Test unloading plugin when cleanup fails."""
    
        mock_plugin = MagicMock()
        mock_plugin.cleanup = AsyncMock(side_effect=Exception("Cleanup failed"))
    
>       plugin_instance = PluginInstance(
            plugin_id="test_plugin",
            name="Test Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=mock_plugin,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:475: ValidationError
_____________________ TestPluginManager.test_list_plugins ______________________

self = <tests.test_plugins.TestPluginManager object at 0x728984134bf0>

    def test_list_plugins(self):
        """Test listing plugins."""
    
        # Add some mock plugin instances
>       plugin1 = PluginInstance(
            plugin_id="plugin1",
            name="Plugin 1",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=MagicMock(),
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'plugin1', ... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'plugin1', ... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:498: ValidationError
_________________ TestPluginManager.test_list_plugins_by_type __________________

self = <tests.test_plugins.TestPluginManager object at 0x728984136d50>

    def test_list_plugins_by_type(self):
        """Test listing plugins filtered by type."""
    
>       tool_plugin = PluginInstance(
            plugin_id="tool_plugin",
            name="Tool Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=MagicMock(),
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'tool_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'tool_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:532: ValidationError
________________ TestPluginManager.test_list_plugins_by_status _________________

self = <tests.test_plugins.TestPluginManager object at 0x728984136f60>

    def test_list_plugins_by_status(self):
        """Test listing plugins filtered by status."""
    
>       active_plugin = PluginInstance(
            plugin_id="active_plugin",
            name="Active Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=MagicMock(),
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'active_plu... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'active_plu... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:566: ValidationError
_________________ TestPluginManager.test_get_plugin_info_found _________________

self = <tests.test_plugins.TestPluginManager object at 0x728984137170>

    def test_get_plugin_info_found(self):
        """Test getting plugin info for existing plugin."""
    
>       plugin = PluginInstance(
            plugin_id="test_plugin",
            name="Test Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=MagicMock(),
            config={"param": "value"},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T01:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T01:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T01:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:600: ValidationError
_______________ TestPluginManager.test_get_plugin_info_not_found _______________

self = <tests.test_plugins.TestPluginManager object at 0x728984137380>

    def test_get_plugin_info_not_found(self):
        """Test getting plugin info for non-existent plugin."""
>       info = self.plugin_manager.get_plugin_info("non_existent")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'PluginManager' object has no attribute 'get_plugin_info'. Did you mean: '_get_plugin_lock'?

tests/test_plugins.py:619: AttributeError
________________ TestPluginManager.test_get_tools_from_plugins _________________

self = <tests.test_plugins.TestPluginManager object at 0x728984137590>

    def test_get_tools_from_plugins(self):
        """Test getting tools from tool plugins."""
    
        # Create mock tool plugin
        mock_tool_plugin = MagicMock()
        mock_tool_plugin.get_tools.return_value = [
            MockBaseTool("tool1", "Tool 1"),
            MockBaseTool("tool2", "Tool 2")
        ]
    
>       tool_plugin = PluginInstance(
            plugin_id="tool_plugin",
            name="Tool Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=mock_tool_plugin,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'tool_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'tool_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:633: ValidationError
________ TestPluginManager.test_get_tools_from_plugins_inactive_ignored ________

self = <tests.test_plugins.TestPluginManager object at 0x7289841377a0>

    def test_get_tools_from_plugins_inactive_ignored(self):
        """Test that inactive plugins are ignored when getting tools."""
    
        # Create inactive tool plugin
        mock_tool_plugin = MagicMock()
        mock_tool_plugin.get_tools.return_value = [MockBaseTool("tool1", "Tool 1")]
    
>       inactive_plugin = PluginInstance(
            plugin_id="inactive_plugin",
            name="Inactive Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ERROR,  # Inactive status
            plugin_object=mock_tool_plugin,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'inactive_p... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'inactive_p... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:674: ValidationError
_______________ TestPluginManager.test_health_check_all_plugins ________________

self = <tests.test_plugins.TestPluginManager object at 0x7289841379b0>

    @pytest.mark.asyncio
    async def test_health_check_all_plugins(self):
        """Test health check for all plugins."""
    
        # Create mock plugins with health checks
        mock_plugin1 = MagicMock()
        mock_plugin1.health_check = AsyncMock(return_value={"status": "healthy"})
    
        mock_plugin2 = MagicMock()
        mock_plugin2.health_check = AsyncMock(return_value={"status": "degraded", "issues": ["slow response"]})
    
>       plugin1 = PluginInstance(
            plugin_id="plugin1",
            name="Plugin 1",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=mock_plugin1,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'plugin1', ... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'plugin1', ... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:703: ValidationError
_______________ TestPluginManager.test_health_check_plugin_error _______________

self = <tests.test_plugins.TestPluginManager object at 0x728984137c50>

    @pytest.mark.asyncio
    async def test_health_check_plugin_error(self):
        """Test health check when plugin health check fails."""
    
        mock_plugin = MagicMock()
        mock_plugin.health_check = AsyncMock(side_effect=Exception("Health check failed"))
    
>       plugin = PluginInstance(
            plugin_id="error_plugin",
            name="Error Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=mock_plugin,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'error_plug... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'error_plug... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:743: ValidationError
_________________ TestPluginIntegration.test_plugin_lifecycle __________________

self = <tests.test_plugins.TestPluginIntegration object at 0x7289841680b0>

        @pytest.mark.asyncio
        async def test_plugin_lifecycle(self):
            """Test complete plugin lifecycle: load, activate, health check, unload."""
    
            # Create a temporary plugin file
            plugin_code = '''
    from chatter.services.plugins import ToolPlugin
    
    class LifecycleTestPlugin(ToolPlugin):
        def __init__(self, config=None):
            super().__init__(config)
            self.initialized = False
            self.cleaned_up = False
    
        async def initialize(self):
            self.initialized = True
    
        async def cleanup(self):
            self.cleaned_up = True
    
        async def health_check(self):
            return {
                "status": "healthy" if self.initialized and not self.cleaned_up else "error",
                "initialized": self.initialized,
                "cleaned_up": self.cleaned_up
            }
    
        def get_tools(self):
            from tests.test_plugins import MockBaseTool
            return [MockBaseTool("lifecycle_tool", "Test tool for lifecycle")]
    
    plugin_class = LifecycleTestPlugin
    '''
    
            with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
                f.write(plugin_code)
                plugin_file = Path(f.name)
    
            try:
                # Load plugin
>               plugin_instance = await self.plugin_manager.load_plugin_from_file(
                                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                    plugin_file, "lifecycle_plugin", {}
                )
E               AttributeError: 'PluginManager' object has no attribute 'load_plugin_from_file'

tests/test_plugins.py:811: AttributeError
____________ TestPluginIntegration.test_multiple_plugins_management ____________

self = <tests.test_plugins.TestPluginIntegration object at 0x728984168350>

        @pytest.mark.asyncio
        async def test_multiple_plugins_management(self):
            """Test managing multiple plugins simultaneously."""
    
            # Create multiple plugin files
            plugin_codes = {
                "plugin1": '''
    from chatter.services.plugins import ToolPlugin
    
    class Plugin1(ToolPlugin):
        async def initialize(self):
            pass
    
        async def cleanup(self):
            pass
    
        async def health_check(self):
            return {"status": "healthy", "plugin": "plugin1"}
    
        def get_tools(self):
            from tests.test_plugins import MockBaseTool
            return [MockBaseTool("plugin1_tool", "Tool from plugin 1")]
    
    plugin_class = Plugin1
    ''',
                "plugin2": '''
    from chatter.services.plugins import ToolPlugin
    
    class Plugin2(ToolPlugin):
        async def initialize(self):
            pass
    
        async def cleanup(self):
            pass
    
        async def health_check(self):
            return {"status": "healthy", "plugin": "plugin2"}
    
        def get_tools(self):
            from tests.test_plugins import MockBaseTool
            return [MockBaseTool("plugin2_tool", "Tool from plugin 2")]
    
    plugin_class = Plugin2
    '''
            }
    
            plugin_files = []
            try:
                # Create and load plugins
                for plugin_name, plugin_code in plugin_codes.items():
                    with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
                        f.write(plugin_code)
                        plugin_file = Path(f.name)
                        plugin_files.append(plugin_file)
    
>                   plugin_instance = await self.plugin_manager.load_plugin_from_file(
                                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                        plugin_file, plugin_name, {}
                    )
E                   AttributeError: 'PluginManager' object has no attribute 'load_plugin_from_file'

tests/test_plugins.py:897: AttributeError
___________ TestProfilesIntegration.test_profile_complete_lifecycle ____________

self = <tests.test_profiles_integration.TestProfilesIntegration object at 0x728984168f50>
client = <httpx.AsyncClient object at 0x7288a04c6630>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENEQ0c0SFY5MURGV0sxTjlEUDRYVyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NTN9._BFZMv07bwv8B9CD1iDmubHGUkdpRoL2S9FTrKVz7fY'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288a11fe120>

    @pytest.mark.integration
    async def test_profile_complete_lifecycle(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complete profile lifecycle from creation to deletion."""
        # Create profile
        profile_data = {
            "name": "Integration Test Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-3.5-turbo",
            "description": "Profile for integration testing",
            "temperature": 0.7,
            "max_tokens": 1500,
            "system_message": "You are a helpful assistant.",
            "profile_type": "chat"
        }
    
>       create_response = await client.post("/api/v1/profiles/", json=profile_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_integration.py:27: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4819' coro=<TestProfilesIntegration.test_profile_complete_lifecycle() running at /home/yam/chatter/tests/test_profiles_integration.py:27> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENEQ0c0SFY5MURGV0sxTjlEUDRYVyIsImVtYWlsIjoidXNlcjlmZTgxYzg5QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOWZlODFjODkiLCJqdGkiOiIyOTU2MGJlZC03ODU4LTQwNTQtODJjNy1jMjY3NTFhNzQzNmIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODUzLCJzZXNzaW9uX2lkIjoiOTZmN2U0ZTAtNWJhZi00MDgyLThmZjctNjJiY2JkZjk4OGFkIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NTN9._BFZMv07bwv8B9CD1iDmubHGUkdpRoL2S9FTrKVz7fY
_____________ TestProfilesIntegration.test_profile_list_and_filter _____________

self = <tests.test_profiles_integration.TestProfilesIntegration object at 0x728984169280>
client = <httpx.AsyncClient object at 0x728897629bb0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENERFNTUDRUWFdHRE5HMjJTVFZaSCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NTR9.4SV5noa38Um6qEEEMftxPPOZyB9TvHqPOz4JiSv_lEM'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288a030ac60>

    @pytest.mark.integration
    async def test_profile_list_and_filter(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test profile listing and filtering functionality."""
        # Create profiles with different providers
        profiles_to_create = [
            {
                "name": "OpenAI Profile",
                "llm_provider": "openai",
                "llm_model": "gpt-3.5-turbo",
                "temperature": 0.7
            },
            {
                "name": "Anthropic Profile",
                "llm_provider": "anthropic",
                "llm_model": "claude-3-sonnet",
                "temperature": 0.5
            },
            {
                "name": "Another OpenAI Profile",
                "llm_provider": "openai",
                "llm_model": "gpt-4",
                "temperature": 0.9
            }
        ]
    
        created_profile_ids = []
    
        for profile_data in profiles_to_create:
>           response = await client.post("/api/v1/profiles/", json=profile_data, headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_integration.py:126: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4832' coro=<TestProfilesIntegration.test_profile_list_and_filter() running at /home/yam/chatter/tests/test_profiles_integration.py:126> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENERFNTUDRUWFdHRE5HMjJTVFZaSCIsImVtYWlsIjoidXNlcjkyNjNlYTc1QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOTI2M2VhNzUiLCJqdGkiOiJiMzJlMDg5My00YThiLTQ5ZGItYWQ5NC03MjYzYWVjMGYzYmMiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODU0LCJzZXNzaW9uX2lkIjoiMTc0ODY0ZTMtZDgwMi00OTk2LWIzZWMtMjg5YWZiODYwYjQ2IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NTR9.4SV5noa38Um6qEEEMftxPPOZyB9TvHqPOz4JiSv_lEM
___________ TestProfilesIntegration.test_profile_stats_and_providers ___________

self = <tests.test_profiles_integration.TestProfilesIntegration object at 0x728984169640>
client = <httpx.AsyncClient object at 0x7288a0e105f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENER0RLQlNOTkZNRlA2UERCRUNTWCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NTd9.LdYZDyxrM-kEX9cOS20oOJVXbyfc5b4Rk-JT6PR3Wwg'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288976fba10>

    @pytest.mark.integration
    async def test_profile_stats_and_providers(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test profile statistics and provider information."""
        # Get initial stats
>       stats_response = await client.get("/api/v1/profiles/stats/overview", headers=auth_headers)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_integration.py:160: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4845' coro=<TestProfilesIntegration.test_profile_stats_and_providers() running at /home/yam/chatter/tests/test_profiles_integration.py:160> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENER0RLQlNOTkZNRlA2UERCRUNTWCIsImVtYWlsIjoidXNlcmMwNzZkNTJjQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYzA3NmQ1MmMiLCJqdGkiOiIwZDhlMjM2NC00NTJmLTQ0NmQtYjYwMS03NjFiY2M5NTMwMGYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODU3LCJzZXNzaW9uX2lkIjoiMmFkZmExNjYtNWI4Yy00NmU3LWI4ZjktZDIxODM2MjNlN2QwIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NTd9.LdYZDyxrM-kEX9cOS20oOJVXbyfc5b4Rk-JT6PR3Wwg
_____________ TestProfilesIntegration.test_profile_error_scenarios _____________

self = <tests.test_profiles_integration.TestProfilesIntegration object at 0x728984169a00>
client = <httpx.AsyncClient object at 0x7288a07ea780>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENESFBOWEEwTjcxQ0NHQjZXVzI1QiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NTh9.HYo0-R4dpSRN4dNOWkSIz_bR-E-BehmPogJrisA1MN0'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288a0e520f0>

    @pytest.mark.integration
    async def test_profile_error_scenarios(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test profile error handling scenarios."""
        # Test non-existent profile operations
        nonexistent_id = "nonexistent-profile-id"
    
        operations = [
            ("GET", f"/api/v1/profiles/{nonexistent_id}"),
            ("PUT", f"/api/v1/profiles/{nonexistent_id}"),
            ("DELETE", f"/api/v1/profiles/{nonexistent_id}"),
            ("POST", f"/api/v1/profiles/{nonexistent_id}/test"),
            ("POST", f"/api/v1/profiles/{nonexistent_id}/clone"),
        ]
    
        for method, url in operations:
            if method == "GET":
>               response = await client.get(url, headers=auth_headers)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_integration.py:225: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4858' coro=<TestProfilesIntegration.test_profile_error_scenarios() running at /home/yam/chatter/tests/test_profiles_integration.py:225> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENESFBOWEEwTjcxQ0NHQjZXVzI1QiIsImVtYWlsIjoidXNlcjI5M2FhMTI1QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMjkzYWExMjUiLCJqdGkiOiIxOGM4YWQ1Ni0zNGI0LTRmYTYtODU4My01Yzg1ZjNlYzRjMDIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODU4LCJzZXNzaW9uX2lkIjoiMDIxZThhNTYtYjY3Yy00Y2ZjLTg5MzItZWNkZDUzY2NkZjIyIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NTh9.HYo0-R4dpSRN4dNOWkSIz_bR-E-BehmPogJrisA1MN0
_____________ TestProfilesIntegration.test_profile_data_validation _____________

self = <tests.test_profiles_integration.TestProfilesIntegration object at 0x728984169dc0>
client = <httpx.AsyncClient object at 0x7288a0f114c0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENESzNUNjVSMVk1UTUyUkpDSDBKNiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NjB9.eTU6tGF6FlsqV0zXf2g3Hy_L4tdwzSd3o3Pf0LZHbC4'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288a0779070>

    @pytest.mark.integration
    async def test_profile_data_validation(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test profile data validation in integration environment."""
        # Test invalid provider
        invalid_provider_data = {
            "name": "Invalid Provider Profile",
            "llm_provider": "nonexistent_provider_xyz",
            "llm_model": "some-model"
        }
    
>       response = await client.post("/api/v1/profiles/", json=invalid_provider_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_integration.py:246: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4871' coro=<TestProfilesIntegration.test_profile_data_validation() running at /home/yam/chatter/tests/test_profiles_integration.py:246> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENESzNUNjVSMVk1UTUyUkpDSDBKNiIsImVtYWlsIjoidXNlcjJmOGM3NGVlQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMmY4Yzc0ZWUiLCJqdGkiOiJkZjBiZDcwMC05Njk5LTQ2MzQtOWE5ZC1kNDkwMDRiYjM3NDQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODYwLCJzZXNzaW9uX2lkIjoiMGRlN2IxMTAtZWMwOC00MzFiLWJjNTAtOTg0N2Y5N2ZkMWQxIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NjB9.eTU6tGF6FlsqV0zXf2g3Hy_L4tdwzSd3o3Pf0LZHbC4
__________ TestProfilesIntegration.test_profile_concurrent_operations __________

self = <tests.test_profiles_integration.TestProfilesIntegration object at 0x72898416a180>
client = <httpx.AsyncClient object at 0x7288a33b0f20>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENETUZIUUtXSFJQODJWQVFaWVg3SCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NjF9.BcaQdMl6bsQvZyswB7cb9rHqLaAjNqBCV8afLIN5WC8'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288a0f073e0>

    @pytest.mark.integration
    async def test_profile_concurrent_operations(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test concurrent profile operations."""
        # Create multiple profiles concurrently
        profile_data_list = [
            {
                "name": f"Concurrent Profile {i}",
                "llm_provider": "openai",
                "llm_model": "gpt-3.5-turbo",
                "temperature": 0.5 + (i * 0.1)
            }
            for i in range(5)
        ]
    
        # Create tasks for concurrent profile creation
        create_tasks = [
            asyncio.create_task(client.post("/api/v1/profiles/", json=profile_data, headers=auth_headers))
            for profile_data in profile_data_list
        ]
    
        # Wait for all creations
>       create_responses = await asyncio.gather(*create_tasks)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_integration.py:290: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4885' coro=<AsyncClient.post() running at /home/yam/.local/lib/python3.12/site-packages/httpx/_client.py:1859> cb=[gather.<locals>._done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:767]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENETUZIUUtXSFJQODJWQVFaWVg3SCIsImVtYWlsIjoidXNlcmE3ZjljYmVjQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYTdmOWNiZWMiLCJqdGkiOiJlMzFkZDFlYS0yNzVjLTQ4OTUtODc5OS1jNmViNTI3Nzk1NWEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODYxLCJzZXNzaW9uX2lkIjoiZDA3MmZkMDYtMjFjZS00OTk2LTkyY2MtMGRhOGVhYjgzMjM3IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NjF9.BcaQdMl6bsQvZyswB7cb9rHqLaAjNqBCV8afLIN5WC8
__________ TestProfilesIntegration.test_profile_complex_data_handling __________

self = <tests.test_profiles_integration.TestProfilesIntegration object at 0x72898416a540>
client = <httpx.AsyncClient object at 0x7288e74c7da0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENETlJSOUE0MVhZRTQ5QkdKUVZEMyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NjJ9.zAdtaYrLT29fD7vaXuNoh3fBLYa_WnHLjXETCdpuCJ8'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288a0f06b40>

    @pytest.mark.integration
    async def test_profile_complex_data_handling(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complex profile data handling."""
        # Create profile with complex configuration
        complex_profile_data = {
            "name": "Complex Configuration Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-4",
            "description": "A profile with complex configuration for testing data integrity",
            "temperature": 0.75,
            "max_tokens": 2048,
            "top_p": 0.9,
            "frequency_penalty": 0.1,
            "presence_penalty": 0.2,
            "system_message": "You are an expert assistant with deep knowledge in multiple domains. Provide detailed, accurate, and helpful responses.",
            "profile_type": "chat",
            "custom_parameters": {
                "context_window": 4096,
                "response_format": "json",
                "safety_level": "moderate",
                "custom_instructions": [
                    "Always be helpful and accurate",
                    "Provide sources when possible",
                    "Be concise but complete"
                ]
            }
        }
    
        # Create profile
>       create_response = await client.post("/api/v1/profiles/", json=complex_profile_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_integration.py:360: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4902' coro=<TestProfilesIntegration.test_profile_complex_data_handling() running at /home/yam/chatter/tests/test_profiles_integration.py:360> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENETlJSOUE0MVhZRTQ5QkdKUVZEMyIsImVtYWlsIjoidXNlcjM3MTI4YmZjQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMzcxMjhiZmMiLCJqdGkiOiJmYjE3YWVkOS1iMzQxLTRiZjEtOTMzOC0zODE3YmE3ODFhZGYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODYyLCJzZXNzaW9uX2lkIjoiZTNhYjBmYjAtZTZkZi00MzMyLTkwMzAtOTcxNDFlNWUyYTE0IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NjJ9.zAdtaYrLT29fD7vaXuNoh3fBLYa_WnHLjXETCdpuCJ8
__________ TestProfilesIntegration.test_profile_testing_functionality __________

self = <tests.test_profiles_integration.TestProfilesIntegration object at 0x728984168ec0>
client = <httpx.AsyncClient object at 0x7288a07064e0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENEUTJLTVI4R0NUQllWRkNWRUc4WSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NjR9.eJImEvIVhhjvgesE_dIPZnBJKtHmg_qOdri2czSJ8JY'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7288c65cf920>

    @pytest.mark.integration
    async def test_profile_testing_functionality(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test profile testing functionality end-to-end."""
        # Create a test profile
        profile_data = {
            "name": "Testing Functionality Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-3.5-turbo",
            "temperature": 0.7,
            "system_message": "You are a test assistant."
        }
    
>       create_response = await client.post("/api/v1/profiles/", json=profile_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_integration.py:416: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4915' coro=<TestProfilesIntegration.test_profile_testing_functionality() running at /home/yam/chatter/tests/test_profiles_integration.py:416> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENEUTJLTVI4R0NUQllWRkNWRUc4WSIsImVtYWlsIjoidXNlcmQ3NDVjOWU5QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZDc0NWM5ZTkiLCJqdGkiOiJiNTE1Mzc5Yi1mZThjLTRkNjYtYTljMi1jN2I3YmVlNTRhOTIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODY0LCJzZXNzaW9uX2lkIjoiMDRlMWRmZTAtOTYzNS00MjhhLTg1NGUtOTBkZDhhY2EyZTAxIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NjR9.eJImEvIVhhjvgesE_dIPZnBJKtHmg_qOdri2czSJ8JY
______________ TestProfilesUnit.test_create_profile_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728897ffcfb0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728897ffcfb0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x72898416bad0>
client = <httpx.AsyncClient object at 0x728897ffc170>

    @pytest.mark.unit
    async def test_create_profile_requires_auth(self, client: AsyncClient):
        """Test that creating profile requires authentication."""
        profile_data = {
            "name": "Test Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-4"
        }
    
>       response = await client.post("/api/v1/profiles/", json=profile_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728897ffcfb0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:47:45.319159Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m2c0a8ae2-7f15-4d15-b09c-5cb8d8290960[0m [36mstatus_code[0m=[35m401[0m
______________ TestProfilesUnit.test_list_profiles_requires_auth _______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728896f0b020>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728896f0b020>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x728984180110>
client = <httpx.AsyncClient object at 0x728896f0a2d0>

    @pytest.mark.unit
    async def test_list_profiles_requires_auth(self, client: AsyncClient):
        """Test that listing profiles requires authentication."""
>       response = await client.get("/api/v1/profiles")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:28: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728896f0b020>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:47:46.162645Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35md45616eb-c655-4708-a217-57ff62142c14[0m [36mstatus_code[0m=[35m401[0m
_______________ TestProfilesUnit.test_get_profile_requires_auth ________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728897ab1040>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728897ab1040>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x728984180200>
client = <httpx.AsyncClient object at 0x728897ab02f0>

    @pytest.mark.unit
    async def test_get_profile_requires_auth(self, client: AsyncClient):
        """Test that getting specific profile requires authentication."""
>       response = await client.get("/api/v1/profiles/profile-id")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:34: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728897ab1040>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:47:46.998873Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m1a851461-5b15-49cd-9c14-7592b0a54d8b[0m [36mstatus_code[0m=[35m401[0m
______________ TestProfilesUnit.test_update_profile_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72892ab0bd10>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72892ab0bd10>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7289841805c0>
client = <httpx.AsyncClient object at 0x72892ab0af00>

    @pytest.mark.unit
    async def test_update_profile_requires_auth(self, client: AsyncClient):
        """Test that updating profile requires authentication."""
>       response = await client.put("/api/v1/profiles/profile-id", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:40: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1896: in put
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x72892ab0bd10>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:47:47.837398Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m34265cbb-71a9-49a8-8ced-8e14e2d6e1b8[0m [36mstatus_code[0m=[35m401[0m
______________ TestProfilesUnit.test_delete_profile_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728896b29dc0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728896b29dc0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x72898416bf20>
client = <httpx.AsyncClient object at 0x728896b290d0>

    @pytest.mark.unit
    async def test_delete_profile_requires_auth(self, client: AsyncClient):
        """Test that deleting profile requires authentication."""
>       response = await client.delete("/api/v1/profiles/profile-id")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:46: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1966: in delete
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728896b29dc0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:47:48.645121Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m731977b8-1005-4520-a87e-13e451a926a4[0m [36mstatus_code[0m=[35m401[0m
_______________ TestProfilesUnit.test_test_profile_requires_auth _______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288a01d4080>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288a01d4080>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7289841808f0>
client = <httpx.AsyncClient object at 0x7288968bb200>

    @pytest.mark.unit
    async def test_test_profile_requires_auth(self, client: AsyncClient):
        """Test that testing profile requires authentication."""
>       response = await client.post("/api/v1/profiles/profile-id/test", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:52: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x7288a01d4080>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:47:49.456980Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m4abead8f-87f2-4d2a-a628-4768380e1c0d[0m [36mstatus_code[0m=[35m401[0m
______________ TestProfilesUnit.test_clone_profile_requires_auth _______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728897c9e210>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728897c9e210>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x728984180590>
client = <httpx.AsyncClient object at 0x728897c9d340>

    @pytest.mark.unit
    async def test_clone_profile_requires_auth(self, client: AsyncClient):
        """Test that cloning profile requires authentication."""
>       response = await client.post("/api/v1/profiles/profile-id/clone", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:58: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728897c9e210>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:47:50.312071Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m107db1c4-cfc3-4735-96a5-df29600c4266[0m [36mstatus_code[0m=[35m401[0m
____________ TestProfilesUnit.test_get_profile_stats_requires_auth _____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728897b70320>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728897b70320>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x728984180f20>
client = <httpx.AsyncClient object at 0x728897b9b560>

    @pytest.mark.unit
    async def test_get_profile_stats_requires_auth(self, client: AsyncClient):
        """Test that getting profile stats requires authentication."""
>       response = await client.get("/api/v1/profiles/stats/overview")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:64: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728897b70320>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:47:51.146446Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m29e35414-54a6-4a4c-bebd-760568c9928a[0m [36mstatus_code[0m=[35m401[0m
_________ TestProfilesUnit.test_get_available_providers_requires_auth __________

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728896f0aa20>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728896f0aa20>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7289841812e0>
client = <httpx.AsyncClient object at 0x728897ab0140>

    @pytest.mark.unit
    async def test_get_available_providers_requires_auth(self, client: AsyncClient):
        """Test that getting available providers requires authentication."""
>       response = await client.get("/api/v1/profiles/providers/available")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:70: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x728ac74d04d0>
request = <starlette.requests.Request object at 0x728896f0aa20>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T16:47:53.402018Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m313a505d-447e-4dfa-b25f-b753a5ff9146[0m [36mstatus_code[0m=[35m401[0m
_________________ TestProfilesUnit.test_create_profile_success _________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7289841816a0>
mock_get_service = <AsyncMock name='get_profile_service' id='125930969752944'>
client = <httpx.AsyncClient object at 0x728896b7d190>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFMTIxNU1QRTE1QTQ5OUFXTjMwWiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NzR9.iSOw35kKD7Xg1GB-p9US_zaOId0Y7zSQmcGQJonzbuQ'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_create_profile_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful profile creation."""
        # Mock the profile service
        mock_service = AsyncMock()
        mock_profile = {
            "id": "profile-123",
            "name": "Test Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-4",
            "created_by": "testuser",
            "created_at": "2024-01-01T12:00:00Z",
            "updated_at": "2024-01-01T12:00:00Z"
        }
        mock_service.create_profile.return_value = mock_profile
        mock_get_service.return_value = mock_service
    
        profile_data = {
            "name": "Test Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-4",
            "description": "Test profile description",
            "temperature": 0.7,
            "max_tokens": 1000
        }
    
>       response = await client.post("/api/v1/profiles/", json=profile_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:100: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5036' coro=<TestProfilesUnit.test_create_profile_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFMTIxNU1QRTE1QTQ5OUFXTjMwWiIsImVtYWlsIjoidXNlcmRhZDcwZmNmQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZGFkNzBmY2YiLCJqdGkiOiIwZDk0Y2UwOC1iZDcyLTQ4ZTUtOTkyMy00MTA3NTg5NGM0ZjAiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODc0LCJzZXNzaW9uX2lkIjoiNzJjNDgzNzUtMDc2Zi00ZGRjLWExZDUtNzI4NGZlN2U4ZTM2IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NzR9.iSOw35kKD7Xg1GB-p9US_zaOId0Y7zSQmcGQJonzbuQ
______________ TestProfilesUnit.test_create_profile_invalid_data _______________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x728984181a90>
client = <httpx.AsyncClient object at 0x728897c56e40>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFMkQ5RVdLSkg2WE5HRFIyQlJZRSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NzV9.sAfVt86NQwEKQ7PyLN2rSzNqlOhbzhmI8m-t6NEmNb0'}

    @pytest.mark.unit
    async def test_create_profile_invalid_data(self, client: AsyncClient, auth_headers: dict):
        """Test profile creation with invalid data."""
        # Missing required fields
        profile_data = {
            "name": "Test Profile"
            # Missing llm_provider and llm_model
        }
    
>       response = await client.post("/api/v1/profiles/", json=profile_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:117: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5049' coro=<TestProfilesUnit.test_create_profile_invalid_data() running at /home/yam/chatter/tests/test_profiles_unit.py:117> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFMkQ5RVdLSkg2WE5HRFIyQlJZRSIsImVtYWlsIjoidXNlcmFiNjY5MGMyQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYWI2NjkwYzIiLCJqdGkiOiJlZTE5NjZmMC00Nzk3LTRlMzEtODEyNS0wMTg1MWM4ZTZjMzciLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODc1LCJzZXNzaW9uX2lkIjoiMWVkYTUxZjMtMWVkOC00NWUyLTk4ZmQtODQ0ZmU2NDM0MjFhIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2NzV9.sAfVt86NQwEKQ7PyLN2rSzNqlOhbzhmI8m-t6NEmNb0
_______________ TestProfilesUnit.test_create_profile_rate_limit ________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x728984181e50>
mock_get_rate_limiter = <MagicMock name='get_unified_rate_limiter' id='125931137215584'>
client = <httpx.AsyncClient object at 0x7288a0b31850>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFM1NZRE1FRldUSzhZNldQQ0tQOSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2Nzd9.Be8CWoYpj6Wwgm8hsie74A5ZOhtByHt_wimv7RBlmzc'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_unified_rate_limiter')
    async def test_create_profile_rate_limit(self, mock_get_rate_limiter, client: AsyncClient, auth_headers: dict):
        """Test profile creation rate limiting."""
        from chatter.utils.unified_rate_limiter import RateLimitExceeded
    
        # Mock rate limiter to raise exception
        mock_rate_limiter = AsyncMock()
        mock_rate_limiter.check_rate_limit.side_effect = RateLimitExceeded(
            message="Rate limit exceeded",
            limit=5,
            window=300,
            remaining=0
        )
        mock_get_rate_limiter.return_value = mock_rate_limiter
    
        profile_data = {
            "name": "Test Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-4"
        }
    
>       response = await client.post("/api/v1/profiles/", json=profile_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:142: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5062' coro=<TestProfilesUnit.test_create_profile_rate_limit() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFM1NZRE1FRldUSzhZNldQQ0tQOSIsImVtYWlsIjoidXNlcmE4MDUxMTgyQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyYTgwNTExODIiLCJqdGkiOiI4YzhhMzEyMS1hY2I2LTQzZWEtOThhYS0yN2U2MTA4ODllYjMiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODc3LCJzZXNzaW9uX2lkIjoiYmM0NWFlMDMtNDRhYy00ZWNiLWI1YWUtMjliODkwMjQ4ZTc3IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2Nzd9.Be8CWoYpj6Wwgm8hsie74A5ZOhtByHt_wimv7RBlmzc
_________________ TestProfilesUnit.test_list_profiles_success __________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x728984182210>
mock_get_service = <AsyncMock name='get_profile_service' id='125930964546816'>
client = <httpx.AsyncClient object at 0x7288966874d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFNTRIUEo2TVc4RlJHQjk3RE1KNiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2Nzh9.tsrjBKu7qfo2TQfgt6yGEAtlObujvfRbvk0luqZSdBs'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_list_profiles_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful profile listing."""
        mock_service = AsyncMock()
        mock_profiles = [
            {
                "id": "profile-1",
                "name": "Profile 1",
                "llm_provider": "openai",
                "llm_model": "gpt-4",
                "created_at": "2024-01-01T12:00:00Z"
            },
            {
                "id": "profile-2",
                "name": "Profile 2",
                "llm_provider": "anthropic",
                "llm_model": "claude-3-opus",
                "created_at": "2024-01-01T13:00:00Z"
            }
        ]
    
        mock_service.list_profiles.return_value = {
            "profiles": mock_profiles,
            "total": 2,
            "page": 1,
            "per_page": 10
        }
        mock_get_service.return_value = mock_service
    
>       response = await client.get("/api/v1/profiles", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:175: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5075' coro=<TestProfilesUnit.test_list_profiles_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFNTRIUEo2TVc4RlJHQjk3RE1KNiIsImVtYWlsIjoidXNlcmY4NGI3YjhmQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZjg0YjdiOGYiLCJqdGkiOiJjOGFlYjg3ZS0yNmQ3LTRlNGItODEwOC1kOTA2OWY1NzdjMGEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODc4LCJzZXNzaW9uX2lkIjoiYzZmOGUwZjEtNmVkOS00YzIwLWIwZDktNjNjOGRhNjU0NmQ1IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2Nzh9.tsrjBKu7qfo2TQfgt6yGEAtlObujvfRbvk0luqZSdBs
__________________ TestProfilesUnit.test_get_profile_success ___________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7289841825d0>
mock_get_service = <AsyncMock name='get_profile_service' id='125930989280704'>
client = <httpx.AsyncClient object at 0x728897e1caa0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFNkQ5N0RORUdYVjIxSEhLNjQxTiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2Nzl9.LbqMxWJ5GMREp-ng2ee-mK-WQEsKl3O5UpRaULRDWYw'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_get_profile_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful profile retrieval."""
        mock_service = AsyncMock()
        mock_profile = {
            "id": "profile-123",
            "name": "Test Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-4",
            "temperature": 0.7,
            "max_tokens": 1000,
            "created_at": "2024-01-01T12:00:00Z"
        }
    
        mock_service.get_profile.return_value = mock_profile
        mock_get_service.return_value = mock_service
    
>       response = await client.get("/api/v1/profiles/profile-123", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:200: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5088' coro=<TestProfilesUnit.test_get_profile_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFNkQ5N0RORUdYVjIxSEhLNjQxTiIsImVtYWlsIjoidXNlcjE0YjI2MjM4QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMTRiMjYyMzgiLCJqdGkiOiJjZGI5OWY3MS0wMDVjLTQzZGEtYTU2MC1jYmQ4Y2UyMWQ0ZmQiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODc5LCJzZXNzaW9uX2lkIjoiZTUyYmQ3N2ItNDc1MC00MThjLWFmNzgtNTljYjliNmExMjI2IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2Nzl9.LbqMxWJ5GMREp-ng2ee-mK-WQEsKl3O5UpRaULRDWYw
_________________ TestProfilesUnit.test_get_profile_not_found __________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x728984182990>
mock_get_service = <AsyncMock name='get_profile_service' id='125933453736848'>
client = <httpx.AsyncClient object at 0x72892ac668a0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFN1BONDZRNkcxMzYyU1JKQThKRSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2ODF9.9oy7X4GIyUwikqU8Qul6M8-ZNenJRo2gdTFUsyZHA0A'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_get_profile_not_found(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test profile retrieval for non-existent profile."""
        mock_service = AsyncMock()
        mock_service.get_profile.side_effect = ProfileError("Profile not found")
        mock_get_service.return_value = mock_service
    
>       response = await client.get("/api/v1/profiles/nonexistent", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:216: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5101' coro=<TestProfilesUnit.test_get_profile_not_found() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFN1BONDZRNkcxMzYyU1JKQThKRSIsImVtYWlsIjoidXNlcjA1Yzk4YzA2QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMDVjOThjMDYiLCJqdGkiOiJkMDU0Yjk5Yy04MGNhLTRjZWYtOWI0Ny1mZjcyZjlkOTIwZjciLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODgxLCJzZXNzaW9uX2lkIjoiNGEzNWVmMDEtMDc5MC00ZWM4LWJlNmUtMTQxNTk0NDczNDViIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2ODF9.9oy7X4GIyUwikqU8Qul6M8-ZNenJRo2gdTFUsyZHA0A
_________________ TestProfilesUnit.test_update_profile_success _________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x728984182d50>
mock_get_service = <AsyncMock name='get_profile_service' id='125933450809984'>
client = <httpx.AsyncClient object at 0x72892a99c170>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFOTFGR1owOVpaNDFKQk5NTVJBWiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2ODJ9.ns4sqa6nKQUicdTlPMdDuNBEi_pqDVvvp41ItiarlzU'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_update_profile_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful profile update."""
        mock_service = AsyncMock()
        mock_updated_profile = {
            "id": "profile-123",
            "name": "Updated Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-4",
            "temperature": 0.8,
            "updated_at": "2024-01-01T13:00:00Z"
        }
    
        mock_service.update_profile.return_value = mock_updated_profile
        mock_get_service.return_value = mock_service
    
        update_data = {
            "name": "Updated Profile",
            "temperature": 0.8
        }
    
>       response = await client.put("/api/v1/profiles/profile-123", json=update_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:241: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1896: in put
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5114' coro=<TestProfilesUnit.test_update_profile_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFOTFGR1owOVpaNDFKQk5NTVJBWiIsImVtYWlsIjoidXNlcmUxMDdmZTFjQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZTEwN2ZlMWMiLCJqdGkiOiJhMWU4OWFlZi1iNWI5LTRkNjYtODU0Yi0yOTIyYTAzZjFhYTEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODgyLCJzZXNzaW9uX2lkIjoiNzU5MWYwODUtMTJhOC00NmEwLWFkZWItMTg5Y2RiNjA5YjZiIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2ODJ9.ns4sqa6nKQUicdTlPMdDuNBEi_pqDVvvp41ItiarlzU
_________________ TestProfilesUnit.test_delete_profile_success _________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x728984183110>
mock_get_service = <AsyncMock name='get_profile_service' id='125930956039104'>
client = <httpx.AsyncClient object at 0x728895e68f80>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFQUJCQ1QyWlJQVkNZQkc4NzQ2NiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2ODN9.4qBKB75JUxq-8Bv2C_qlhRPv8vN3A80AJ-FL427hnXQ'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_delete_profile_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful profile deletion."""
        mock_service = AsyncMock()
        mock_service.delete_profile.return_value = True
        mock_get_service.return_value = mock_service
    
>       response = await client.delete("/api/v1/profiles/profile-123", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:256: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1966: in delete
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5127' coro=<TestProfilesUnit.test_delete_profile_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFQUJCQ1QyWlJQVkNZQkc4NzQ2NiIsImVtYWlsIjoidXNlcjA4NWFmN2MzQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMDg1YWY3YzMiLCJqdGkiOiJmOTA5NTg1YS1kZDkwLTQ3ZjItODA0YS03NzUwNTBiNzEyZGEiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODgzLCJzZXNzaW9uX2lkIjoiNTRjOWYyNmYtNmY0Yi00YWMyLWFkNzEtYzYwN2YyZjMxNGE5IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2ODN9.4qBKB75JUxq-8Bv2C_qlhRPv8vN3A80AJ-FL427hnXQ
__________________ TestProfilesUnit.test_test_profile_success __________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7289841834d0>
mock_get_service = <AsyncMock name='get_profile_service' id='125930942051680'>
client = <httpx.AsyncClient object at 0x7288951135f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFQktWN1dYTTlBQVlaUzhRRzhLWSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2ODV9.W3DDN_jjAlNdrBqjX6u0k5XfKLm-Zx0OhxKjOI_FIOU'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_test_profile_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful profile testing."""
        mock_service = AsyncMock()
        mock_test_result = {
            "profile_id": "profile-123",
            "test_message": "Hello, World!",
            "response": "Hello! How can I assist you today?",
            "response_time": 1.25,
            "success": True
        }
    
        mock_service.test_profile.return_value = mock_test_result
        mock_get_service.return_value = mock_service
    
        test_data = {
            "message": "Hello, World!",
            "include_metrics": True
        }
    
>       response = await client.post("/api/v1/profiles/profile-123/test", json=test_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:284: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5140' coro=<TestProfilesUnit.test_test_profile_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFQktWN1dYTTlBQVlaUzhRRzhLWSIsImVtYWlsIjoidXNlcjM3NGU5YWIxQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMzc0ZTlhYjEiLCJqdGkiOiIxODdhNjZjZS1hNDAwLTQ4MWYtOWQ4Zi1kZTk5Y2IyZDMxNDAiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODg1LCJzZXNzaW9uX2lkIjoiNTFmMTY3YzctMmNiYi00MDQ0LTkxNTctOWZhZGU1ZmI5ODY1IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2ODV9.W3DDN_jjAlNdrBqjX6u0k5XfKLm-Zx0OhxKjOI_FIOU
_________________ TestProfilesUnit.test_clone_profile_success __________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x728984183890>
mock_get_service = <AsyncMock name='get_profile_service' id='125930991221024'>
client = <httpx.AsyncClient object at 0x728897ff7ec0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFRTZWTVFTUDlOMU4yODdKQTdDTSIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2ODd9.IXlHxw8zkhB7quNTNveKPsqD6hHIqHfkY1Xk8AAp7A0'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_clone_profile_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful profile cloning."""
        mock_service = AsyncMock()
        mock_cloned_profile = {
            "id": "cloned-profile-456",
            "name": "Cloned Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-4",
            "created_at": "2024-01-01T14:00:00Z"
        }
    
        mock_service.clone_profile.return_value = mock_cloned_profile
        mock_get_service.return_value = mock_service
    
        clone_data = {
            "name": "Cloned Profile",
            "include_settings": True
        }
    
>       response = await client.post("/api/v1/profiles/profile-123/clone", json=clone_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:312: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5153' coro=<TestProfilesUnit.test_clone_profile_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFRTZWTVFTUDlOMU4yODdKQTdDTSIsImVtYWlsIjoidXNlcjJkMDIzNTlmQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMmQwMjM1OWYiLCJqdGkiOiI5N2E1ZjBlMy0zMTI4LTRlMTgtOTM3ZS0xYWE0ZTYxYzQ2NWIiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODg3LCJzZXNzaW9uX2lkIjoiMTFiYmQ1NWQtNjY4Ni00NzIyLTk4ZTUtMjQ3ZTExMzQ0ZWYyIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2ODd9.IXlHxw8zkhB7quNTNveKPsqD6hHIqHfkY1Xk8AAp7A0
_______________ TestProfilesUnit.test_get_profile_stats_success ________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7289841834a0>
mock_get_service = <AsyncMock name='get_profile_service' id='125930938474640'>
client = <httpx.AsyncClient object at 0x728894da8ce0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFRkZHSkFKUjBRSjgyOEVFME4zRiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2ODl9.iCyuhAfcwoDEJhPskc7qQSgXeh5tTPaL_dPz6hrKP-8'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_get_profile_stats_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful profile stats retrieval."""
        mock_service = AsyncMock()
        mock_stats = {
            "total_profiles": 25,
            "profiles_by_provider": {
                "openai": 15,
                "anthropic": 8,
                "google": 2
            },
            "active_profiles": 20,
            "average_usage_per_profile": 45.5
        }
    
        mock_service.get_profile_stats.return_value = mock_stats
        mock_get_service.return_value = mock_service
    
>       response = await client.get("/api/v1/profiles/stats/overview", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:338: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5166' coro=<TestProfilesUnit.test_get_profile_stats_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFRkZHSkFKUjBRSjgyOEVFME4zRiIsImVtYWlsIjoidXNlcjBlNzgyMzc4QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyMGU3ODIzNzgiLCJqdGkiOiI5ZDU3YjEwYS00MmU5LTRiNTgtYTdiNC00OTU5YWY3MTM3NGYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODg5LCJzZXNzaW9uX2lkIjoiYzA4ZDMxOTItYjI3Mi00NjI3LTk4NGItZDkzMzYzNmFjZGU0IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2ODl9.iCyuhAfcwoDEJhPskc7qQSgXeh5tTPaL_dPz6hrKP-8
____________ TestProfilesUnit.test_get_available_providers_success _____________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x728984182690>
mock_get_service = <AsyncMock name='get_profile_service' id='125930961972896'>
client = <httpx.AsyncClient object at 0x728896411b50>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFR1FLVkVCNVRCVzJEQ00wOEFUMCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2OTB9.G46eN9zkf8UvUTXMYVu9TMOZAtLKIIDW5bFMIFUYMmQ'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_get_available_providers_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful available providers retrieval."""
        mock_service = AsyncMock()
        mock_providers = {
            "openai": {
                "models": ["gpt-4", "gpt-3.5-turbo", "gpt-4-turbo"],
                "supports_streaming": True,
                "max_tokens": 4096
            },
            "anthropic": {
                "models": ["claude-3-opus", "claude-3-sonnet", "claude-3-haiku"],
                "supports_streaming": True,
                "max_tokens": 8192
            }
        }
    
        mock_service.get_available_providers.return_value = mock_providers
        mock_get_service.return_value = mock_service
    
>       response = await client.get("/api/v1/profiles/providers/available", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:367: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5179' coro=<TestProfilesUnit.test_get_available_providers_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFR1FLVkVCNVRCVzJEQ00wOEFUMCIsImVtYWlsIjoidXNlcjk3OWE2M2Q1QGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOTc5YTYzZDUiLCJqdGkiOiI5YzkzZTc3OS1iN2UwLTQ2MmYtYTYzNy03MmJmN2MzY2FiOTUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODkwLCJzZXNzaW9uX2lkIjoiZjJhMjM2MWEtN2I4NC00OGU2LWFjNzgtODgxMGU3MmVlNzkxIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2OTB9.G46eN9zkf8UvUTXMYVu9TMOZAtLKIIDW5bFMIFUYMmQ
_____________ TestProfilesUnit.test_profile_service_error_handling _____________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x728984181b80>
mock_get_service = <AsyncMock name='get_profile_service' id='125930959452880'>
client = <httpx.AsyncClient object at 0x7288961aa7b0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFSjBQU1hQVjJUQ1pXWTBINVZBNiIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2OTF9.kuxLe3Ac7Uf7ZuFLodlsMI68WltsdRPmpWNETFF5YcM'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_profile_service_error_handling(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test profile service error handling."""
        mock_service = AsyncMock()
        mock_service.create_profile.side_effect = Exception("Database error")
        mock_get_service.return_value = mock_service
    
        profile_data = {
            "name": "Test Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-4"
        }
    
>       response = await client.post("/api/v1/profiles/", json=profile_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:389: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5192' coro=<TestProfilesUnit.test_profile_service_error_handling() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFSjBQU1hQVjJUQ1pXWTBINVZBNiIsImVtYWlsIjoidXNlcmVjYzg4MDFhQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyZWNjODgwMWEiLCJqdGkiOiJhZmQzYzZhNC0zNDQ4LTQ5YjItODhjYy0zMDIxMjYzY2ZlMzUiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODkxLCJzZXNzaW9uX2lkIjoiODMzZmQzOTItYTgyMC00M2U2LTllYTItNDE1ODJmN2I0N2U0IiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2OTF9.kuxLe3Ac7Uf7ZuFLodlsMI68WltsdRPmpWNETFF5YcM
_______________ TestProfilesUnit.test_profile_validation_errors ________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x728984180ef0>
mock_get_service = <AsyncMock name='get_profile_service' id='125930856495296'>
client = <httpx.AsyncClient object at 0x72888ff7b890>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFSzlaRFROOUpRM0szTTA1RUZIMyIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2OTN9.AeMRthfrdFJrvesYJpf4t9QeVyHoAs8rkwWr_t1WnfE'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_profile_validation_errors(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test profile data validation errors."""
        # Test invalid provider
        invalid_profile_data = {
            "name": "Test Profile",
            "llm_provider": "invalid_provider",
            "llm_model": "gpt-4"
        }
    
>       response = await client.post("/api/v1/profiles/", json=invalid_profile_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:403: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5205' coro=<TestProfilesUnit.test_profile_validation_errors() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFSzlaRFROOUpRM0szTTA1RUZIMyIsImVtYWlsIjoidXNlcjlkYzFmODJjQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyOWRjMWY4MmMiLCJqdGkiOiIwNzhhZDI4Ny1mYWU3LTQyNGUtYjE4Zi04MjI3YTdhN2ZhMzgiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODkzLCJzZXNzaW9uX2lkIjoiYmRjOTVjNzItZTkxMS00NDcyLTkxZWEtZmI5YzhmYmQ3ZmViIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2OTN9.AeMRthfrdFJrvesYJpf4t9QeVyHoAs8rkwWr_t1WnfE
________________ TestProfilesUnit.test_list_profiles_filtering _________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x728984183c20>
mock_get_service = <AsyncMock name='get_profile_service' id='125930939071232'>
client = <httpx.AsyncClient object at 0x728894e3a840>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFTUpZREZXUjJHV0FaVFJYQUszWCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2OTR9.ECrReDGSKQy5LQ-BTOKuQXzwYA-vypZtP1DsjF45oxA'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_list_profiles_filtering(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test profile listing with filters."""
        mock_service = AsyncMock()
        mock_service.list_profiles.return_value = {
            "profiles": [],
            "total": 0,
            "page": 1,
            "per_page": 10
        }
        mock_get_service.return_value = mock_service
    
        # Test with provider filter
>       response = await client.get("/api/v1/profiles?provider=openai", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:430: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5218' coro=<TestProfilesUnit.test_list_profiles_filtering() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFTUpZREZXUjJHV0FaVFJYQUszWCIsImVtYWlsIjoidXNlcjQ4YjA0OGEyQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyNDhiMDQ4YTIiLCJqdGkiOiIxMjJiM2M1MS04ZjRhLTRjMTMtOWE5Ny1mNWM5Y2MzZjM5NjYiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODk0LCJzZXNzaW9uX2lkIjoiODdmMjdiMWUtZGM3YS00OTJjLWE1NWEtMTlmY2MyMDNlMjBiIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2OTR9.ECrReDGSKQy5LQ-BTOKuQXzwYA-vypZtP1DsjF45oxA
________________ TestProfilesUnit.test_test_profile_rate_limit _________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x728984198050>
mock_get_service = <AsyncMock name='get_profile_service' id='125930847253808'>
client = <httpx.AsyncClient object at 0x72888f6ab500>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFTlZSOVcxQldNUkpQMFg0R0QxRCIsImVtYWl...vbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2OTV9.QAJ06OPMzf92tPdV161jxAlVTwQrMBzZpZvE9zTbqWo'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_test_profile_rate_limit(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test profile testing rate limiting."""
        # This would test rate limiting on profile testing if implemented
        mock_service = AsyncMock()
        mock_service.test_profile.return_value = {
            "success": True,
            "response": "Test response"
        }
        mock_get_service.return_value = mock_service
    
        test_data = {"message": "Test message"}
    
>       response = await client.post("/api/v1/profiles/profile-123/test", json=test_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:452: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5231' coro=<TestProfilesUnit.test_test_profile_rate_limit() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
---------------------------- Captured stdout setup -----------------------------
ACCESS TOKEN eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0RENFTlZSOVcxQldNUkpQMFg0R0QxRCIsImVtYWlsIjoidXNlcjg4YjJkNDdkQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ1c2VyODhiMmQ0N2QiLCJqdGkiOiJhZDFlMjkzOC05YTUwLTRjMzYtOGViYy1kMmI0MjhjYjFjNjkiLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzU3MDkwODk1LCJzZXNzaW9uX2lkIjoiYjk3MDZmOTQtNTY0ZC00OTk2LTg4OTQtNWEzMGQyYzdlMjVkIiwicGVybWlzc2lvbnMiOlsicmVhZDpwcm9maWxlIiwid3JpdGU6cHJvZmlsZSJdLCJleHAiOjE3NTcwOTI2OTV9.QAJ06OPMzf92tPdV161jxAlVTwQrMBzZpZvE9zTbqWo
____________ TestStreamingEvent.test_streaming_event_data_creation _____________

self = <tests.test_streaming.TestStreamingEvent object at 0x7289840dbdd0>

    def test_streaming_event_data_creation(self):
        """Test creating StreamingEvent."""
>       event_data = StreamingEvent(
            event_type=StreamingEventType.TOKEN,
            content="Hello",
            metadata={"token_id": 123},
            timestamp=1234567890.0
        )
E       TypeError: StreamingEvent.__init__() got an unexpected keyword argument 'event_type'

tests/test_streaming.py:45: TypeError
_____________ TestStreamingEvent.test_streaming_event_data_minimal _____________

self = <tests.test_streaming.TestStreamingEvent object at 0x728983f0c170>

    def test_streaming_event_data_minimal(self):
        """Test creating StreamingEvent with minimal fields."""
>       event_data = StreamingEvent(
            event_type=StreamingEventType.START
        )
E       TypeError: StreamingEvent.__init__() got an unexpected keyword argument 'event_type'

tests/test_streaming.py:59: TypeError
_________ TestStreamingEvent.test_streaming_event_data_auto_timestamp __________

self = <tests.test_streaming.TestStreamingEvent object at 0x728983f0c350>

    def test_streaming_event_data_auto_timestamp(self):
        """Test that timestamp is automatically set if not provided."""
        before = time.time()
>       event_data = StreamingEvent(
            event_type=StreamingEventType.COMPLETE
        )
E       TypeError: StreamingEvent.__init__() got an unexpected keyword argument 'event_type'

tests/test_streaming.py:71: TypeError
__________ TestStreamingEvent.test_streaming_event_data_with_metadata __________

self = <tests.test_streaming.TestStreamingEvent object at 0x728983f0c530>

    def test_streaming_event_data_with_metadata(self):
        """Test StreamingEvent with complex metadata."""
        metadata = {
            "tool_name": "calculator",
            "input": {"a": 1, "b": 2},
            "result": {"sum": 3},
            "execution_time": 0.5
        }
    
>       event_data = StreamingEvent(
            event_type=StreamingEventType.TOOL_CALL_END,
            content="Tool execution completed",
            metadata=metadata
        )
E       TypeError: StreamingEvent.__init__() got an unexpected keyword argument 'event_type'

tests/test_streaming.py:87: TypeError
_____________________ TestStreamingService.test_end_stream _____________________

self = <tests.test_streaming.TestStreamingService object at 0x7289840dbc50>
mock_record_metrics = <MagicMock name='record_workflow_metrics' id='125930957363520'>

    @pytest.mark.asyncio
    @patch('chatter.services.streaming.record_workflow_metrics')
    async def test_end_stream(self, mock_record_metrics):
        """Test ending a stream and getting metrics."""
        stream_id = "end_test_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        # Simulate some activity
        self.service.active_streams[stream_id]["token_count"] = 100
        self.service.active_streams[stream_id]["event_count"] = 10
    
        # Wait a bit to have measurable duration
        await asyncio.sleep(0.01)
    
        # End stream
        metrics = await self.service.end_stream(stream_id)
    
        assert metrics["total_duration"] > 0
        assert metrics["tokens_per_second"] > 0
        assert metrics["events_per_second"] > 0
        assert stream_id not in self.service.active_streams
>       assert stream_id not in self.stream_metrics
                                ^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'TestStreamingService' object has no attribute 'stream_metrics'

tests/test_streaming.py:223: AttributeError
_________________ TestStreamingService.test_stream_event_basic _________________

self = <tests.test_streaming.TestStreamingService object at 0x728983f0d1f0>

    @pytest.mark.asyncio
    async def test_stream_event_basic(self):
        """Test streaming a basic event."""
        stream_id = "event_test_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        # Create async generator for streaming
        async def stream_events():
            event_data = StreamingEvent(
                event_type=StreamingEventType.TOKEN,
                content="Hello",
                metadata={"token_id": 1}
            )
    
            async for chunk in self.service.stream_event(stream_id, event_data):
                yield chunk
    
        # Collect streamed events
        events = []
>       async for event in stream_events():

tests/test_streaming.py:259: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    async def stream_events():
>       event_data = StreamingEvent(
            event_type=StreamingEventType.TOKEN,
            content="Hello",
            metadata={"token_id": 1}
        )
E       TypeError: StreamingEvent.__init__() got an unexpected keyword argument 'event_type'

tests/test_streaming.py:248: TypeError
____________________ TestStreamingService.test_stream_token ____________________

self = <tests.test_streaming.TestStreamingService object at 0x728983f0ca10>

    @pytest.mark.asyncio
    async def test_stream_token(self):
        """Test streaming a token event."""
        stream_id = "token_test_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="chat_completion"
        )
    
        token_content = "world"
    
        # Stream token
        events = []
>       async for chunk in self.service.stream_token(stream_id, token_content):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:283: AttributeError
_____________ TestStreamingService.test_stream_tool_call_lifecycle _____________

self = <tests.test_streaming.TestStreamingService object at 0x728983f0c080>

    @pytest.mark.asyncio
    async def test_stream_tool_call_lifecycle(self):
        """Test complete tool call streaming lifecycle."""
        stream_id = "tool_call_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="tool_execution"
        )
    
        tool_name = "calculator"
        tool_input = {"operation": "add", "a": 5, "b": 3}
        tool_result = {"result": 8}
    
        # Stream tool call start
        start_events = []
>       async for chunk in self.service.stream_tool_call_start(stream_id, tool_name, tool_input):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_tool_call_start'

tests/test_streaming.py:313: AttributeError
__________________ TestStreamingService.test_stream_thinking ___________________

self = <tests.test_streaming.TestStreamingService object at 0x728983f0d9a0>

    @pytest.mark.asyncio
    async def test_stream_thinking(self):
        """Test streaming thinking event."""
        stream_id = "thinking_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="reasoning"
        )
    
        thinking_content = "Let me analyze this problem..."
    
        # Stream thinking
        events = []
>       async for chunk in self.service.stream_thinking(stream_id, thinking_content):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_thinking'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:344: AttributeError
________________ TestStreamingService.test_stream_source_found _________________

self = <tests.test_streaming.TestStreamingService object at 0x728983f0dc40>

    @pytest.mark.asyncio
    async def test_stream_source_found(self):
        """Test streaming source found event."""
        stream_id = "source_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="document_search"
        )
    
        source_info = {
            "title": "Test Document",
            "url": "https://example.com/doc",
            "relevance": 0.95
        }
    
        # Stream source found
        events = []
>       async for chunk in self.service.stream_source_found(stream_id, source_info):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_source_found'

tests/test_streaming.py:368: AttributeError
____________________ TestStreamingService.test_stream_error ____________________

self = <tests.test_streaming.TestStreamingService object at 0x728983f0dee0>

    @pytest.mark.asyncio
    async def test_stream_error(self):
        """Test streaming error event."""
        stream_id = "error_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        error_message = "Test error occurred"
        error_details = {"error_code": "TEST_001", "retry": False}
    
        # Stream error
        events = []
>       async for chunk in self.service.stream_error(stream_id, error_message, error_details):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_error'

tests/test_streaming.py:389: AttributeError
__________________ TestStreamingService.test_stream_complete ___________________

self = <tests.test_streaming.TestStreamingService object at 0x728983f0e180>

    @pytest.mark.asyncio
    async def test_stream_complete(self):
        """Test streaming completion event."""
        stream_id = "complete_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        final_result = {"status": "success", "total_tokens": 150}
    
        # Stream completion
        events = []
>       async for chunk in self.service.stream_complete(stream_id, final_result):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_complete'

tests/test_streaming.py:413: AttributeError
__________________ TestStreamingService.test_stream_metadata ___________________

self = <tests.test_streaming.TestStreamingService object at 0x728983f0e420>

    @pytest.mark.asyncio
    async def test_stream_metadata(self):
        """Test streaming metadata event."""
        stream_id = "metadata_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        metadata = {
            "model": "gpt-4",
            "temperature": 0.7,
            "max_tokens": 500
        }
    
        # Stream metadata
        events = []
>       async for chunk in self.service.stream_metadata(stream_id, metadata):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_metadata'. Did you mean: 'stream_metrics'?

tests/test_streaming.py:437: AttributeError
_________________ TestStreamingService.test_get_stream_metrics _________________

self = <tests.test_streaming.TestStreamingService object at 0x728983f0e6c0>

    @pytest.mark.asyncio
    async def test_get_stream_metrics(self):
        """Test getting stream metrics."""
        stream_id = "metrics_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        # Simulate some activity
        self.service.active_streams[stream_id]["token_count"] = 50
        self.service.active_streams[stream_id]["event_count"] = 5
    
        # Get metrics
>       metrics = self.service.get_stream_metrics(stream_id)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'get_stream_metrics'. Did you mean: 'stream_metrics'?

tests/test_streaming.py:458: AttributeError
___________ TestStreamingService.test_get_nonexistent_stream_metrics ___________

self = <tests.test_streaming.TestStreamingService object at 0x728983f0e960>

    @pytest.mark.asyncio
    async def test_get_nonexistent_stream_metrics(self):
        """Test getting metrics for nonexistent stream."""
>       metrics = self.service.get_stream_metrics("nonexistent")
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'get_stream_metrics'. Did you mean: 'stream_metrics'?

tests/test_streaming.py:468: AttributeError
________________ TestStreamingService.test_list_active_streams _________________

self = <tests.test_streaming.TestStreamingService object at 0x728983f0ec00>

    @pytest.mark.asyncio
    async def test_list_active_streams(self):
        """Test listing active streams."""
        # Initially no streams
>       streams = self.service.list_active_streams()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'list_active_streams'. Did you mean: 'active_streams'?

tests/test_streaming.py:476: AttributeError
__________________ TestStreamingService.test_is_stream_active __________________

self = <tests.test_streaming.TestStreamingService object at 0x728983f0eea0>

    @pytest.mark.asyncio
    async def test_is_stream_active(self):
        """Test checking if stream is active."""
        stream_id = "active_check_stream"
    
        # Stream doesn't exist
>       assert self.service.is_stream_active(stream_id) is False
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'is_stream_active'

tests/test_streaming.py:494: AttributeError
______________ TestStreamingService.test_stream_activity_tracking ______________

self = <tests.test_streaming.TestStreamingService object at 0x728983f0f140>

    @pytest.mark.asyncio
    async def test_stream_activity_tracking(self):
        """Test that stream activity is properly tracked."""
        stream_id = "activity_stream"
    
        # Create stream
        await self.service.create_stream(stream_id, "test_workflow")
    
        initial_activity = self.service.active_streams[stream_id]["last_activity"]
    
        # Wait a bit
        await asyncio.sleep(0.01)
    
        # Stream a token (should update last_activity)
>       async for _ in self.service.stream_token(stream_id, "test"):
                       ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:522: AttributeError
________ TestStreamingService.test_stream_error_handling_invalid_stream ________

self = <tests.test_streaming.TestStreamingService object at 0x728983f0f3e0>

    @pytest.mark.asyncio
    async def test_stream_error_handling_invalid_stream(self):
        """Test error handling when streaming to invalid stream."""
        with pytest.raises(StreamingError):
>           async for _ in self.service.stream_token("invalid_stream", "test"):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^
E           AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:533: AttributeError
_________________ TestStreamingService.test_concurrent_streams _________________

self = <tests.test_streaming.TestStreamingService object at 0x728983f0f680>

    @pytest.mark.asyncio
    async def test_concurrent_streams(self):
        """Test handling multiple concurrent streams."""
        stream_ids = ["concurrent1", "concurrent2", "concurrent3"]
    
        # Create multiple streams concurrently
        create_tasks = [
            self.service.create_stream(stream_id, f"workflow_{i}")
            for i, stream_id in enumerate(stream_ids)
        ]
        await asyncio.gather(*create_tasks)
    
        # Verify all streams are active
        for stream_id in stream_ids:
>           assert self.service.is_stream_active(stream_id)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           AttributeError: 'StreamingService' object has no attribute 'is_stream_active'

tests/test_streaming.py:550: AttributeError
______________ TestStreamingService.test_stream_cleanup_on_error _______________

self = <tests.test_streaming.TestStreamingService object at 0x728983f0f920>

    @pytest.mark.asyncio
    async def test_stream_cleanup_on_error(self):
        """Test stream cleanup when errors occur."""
        stream_id = "cleanup_stream"
    
        # Create stream
        await self.service.create_stream(stream_id, "test_workflow")
    
        # Simulate an error during streaming
>       with patch.object(self.service, 'stream_event', side_effect=StreamingError("Test error")):
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_streaming.py:574: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x72888f119e20>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <chatter.services.streaming.StreamingService object at 0x72888f11a2a0> does not have the attribute 'stream_event'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
_______ TestStreamingServiceIntegration.test_complete_streaming_workflow _______

self = <tests.test_streaming.TestStreamingServiceIntegration object at 0x728983f0ef60>

    @pytest.mark.asyncio
    async def test_complete_streaming_workflow(self):
        """Test complete streaming workflow from start to finish."""
        stream_id = "complete_workflow_stream"
        workflow_type = "chat_completion"
    
        # 1. Create stream
        await self.service.create_stream(stream_id, workflow_type)
>       assert self.service.is_stream_active(stream_id)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'is_stream_active'

tests/test_streaming.py:599: AttributeError
_________ TestStreamingServiceIntegration.test_error_recovery_workflow _________

self = <tests.test_streaming.TestStreamingServiceIntegration object at 0x728983f0eab0>

    @pytest.mark.asyncio
    async def test_error_recovery_workflow(self):
        """Test streaming workflow with error recovery."""
        stream_id = "error_recovery_stream"
    
        # Create stream
        await self.service.create_stream(stream_id, "error_recovery_test")
    
        # Stream some successful events
>       async for _ in self.service.stream_token(stream_id, "Success"):
                       ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:659: AttributeError
_ TestStreamingServiceIntegration.test_performance_with_high_volume_streaming __

self = <tests.test_streaming.TestStreamingServiceIntegration object at 0x728983f0e5a0>

    @pytest.mark.asyncio
    async def test_performance_with_high_volume_streaming(self):
        """Test streaming performance with high volume of events."""
        stream_id = "high_volume_stream"
    
        # Create stream
        await self.service.create_stream(stream_id, "performance_test")
    
        # Stream many tokens quickly
        start_time = time.time()
    
        for i in range(100):  # Stream 100 tokens
>           async for _ in self.service.stream_token(stream_id, f"token_{i}"):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^
E           AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:697: AttributeError
____________ TestStreamingServiceIntegration.test_stream_isolation _____________

self = <tests.test_streaming.TestStreamingServiceIntegration object at 0x728983f0dfa0>

    @pytest.mark.asyncio
    async def test_stream_isolation(self):
        """Test that streams are properly isolated from each other."""
        stream1_id = "isolation_stream_1"
        stream2_id = "isolation_stream_2"
    
        # Create two streams
        await self.service.create_stream(stream1_id, "workflow1")
        await self.service.create_stream(stream2_id, "workflow2")
    
        # Stream different content to each
>       async for _ in self.service.stream_token(stream1_id, "stream1_content"):
                       ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:722: AttributeError
____________ TestAPIVersion.test_api_version_string_representation _____________

self = <tests.test_versioning.TestAPIVersion object at 0x728983fa6e70>

    def test_api_version_string_representation(self):
        """Test API version string representation."""
>       assert str(APIVersion.V1) == "v1"
E       AssertionError: assert 'APIVersion.V1' == 'v1'
E         
E         - v1
E         + APIVersion.V1

tests/test_versioning.py:27: AssertionError
_________________ TestVersionStatus.test_version_status_values _________________

self = <tests.test_versioning.TestVersionStatus object at 0x728983fa51f0>

    def test_version_status_values(self):
        """Test version status enum values."""
        assert VersionStatus.ACTIVE == "active"
>       assert VersionStatus.DEPRECATED == "deprecated"
               ^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: type object 'VersionStatus' has no attribute 'DEPRECATED'

tests/test_versioning.py:37: AttributeError
______________ TestVersionStatus.test_version_status_progression _______________

self = <tests.test_versioning.TestVersionStatus object at 0x728983fa4da0>

    def test_version_status_progression(self):
        """Test logical version status progression."""
>       statuses = [VersionStatus.ACTIVE, VersionStatus.DEPRECATED, VersionStatus.SUNSET]
                                          ^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: type object 'VersionStatus' has no attribute 'DEPRECATED'

tests/test_versioning.py:42: AttributeError
___________ TestEndpointVersioning.test_endpoint_versioning_creation ___________

self = <tests.test_versioning.TestEndpointVersioning object at 0x728983fa7410>

    def test_endpoint_versioning_creation(self):
        """Test creating EndpointVersioning."""
        endpoint = EndpointVersioning(
            path="/api/users",
            method="GET",
            introduced_in=APIVersion.V1,
            deprecated_in=APIVersion.V2,
            removed_in=None
        )
    
        assert endpoint.path == "/api/users"
        assert endpoint.method == "GET"
        assert endpoint.introduced_in == APIVersion.V1
>       assert endpoint.deprecated_in == APIVersion.V2
               ^^^^^^^^^^^^^^^^^^^^^^

tests/test_versioning.py:101: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = EndpointVersioning(path='/api/users', method='GET', introduced_in=<APIVersion.V1: 'v1'>, removed_in=None, changes={})
item = 'deprecated_in'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'EndpointVersioning' object has no attribute 'deprecated_in'

../.local/lib/python3.12/site-packages/pydantic/main.py:991: AttributeError
__________ TestEndpointVersioning.test_endpoint_versioning_lifecycle ___________

self = <tests.test_versioning.TestEndpointVersioning object at 0x728983fa7560>

    def test_endpoint_versioning_lifecycle(self):
        """Test endpoint lifecycle through versions."""
        # Endpoint introduced in V1, deprecated in V2, removed in hypothetical V3
        endpoint = EndpointVersioning(
            path="/api/legacy",
            method="POST",
            introduced_in=APIVersion.V1,
            deprecated_in=APIVersion.V2,
            removed_in=APIVersion.V2  # Removed in V2 (immediately deprecated and removed)
        )
    
        assert endpoint.introduced_in == APIVersion.V1
>       assert endpoint.deprecated_in == APIVersion.V2
               ^^^^^^^^^^^^^^^^^^^^^^

tests/test_versioning.py:116: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = EndpointVersioning(path='/api/legacy', method='POST', introduced_in=<APIVersion.V1: 'v1'>, removed_in=<APIVersion.V2: 'v2'>, changes={})
item = 'deprecated_in'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'EndpointVersioning' object has no attribute 'deprecated_in'

../.local/lib/python3.12/site-packages/pydantic/main.py:991: AttributeError
______________ TestAPIVersionManager.test_default_versions_loaded ______________

self = <tests.test_versioning.TestAPIVersionManager object at 0x728983fa7a70>

    def test_default_versions_loaded(self):
        """Test that default versions are properly loaded."""
        # V1 should exist
        v1_info = self.manager.get_version_info(APIVersion.V1)
        assert v1_info is not None
        assert v1_info.version == APIVersion.V1
>       assert v1_info.status == VersionStatus.DEPRECATED
                                 ^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: type object 'VersionStatus' has no attribute 'DEPRECATED'

tests/test_versioning.py:142: AttributeError
________ TestAPIVersionManager.test_is_endpoint_available_unregistered _________

self = <tests.test_versioning.TestAPIVersionManager object at 0x728983fcc5f0>

    def test_is_endpoint_available_unregistered(self):
        """Test endpoint availability for unregistered endpoint."""
        is_available = self.manager.is_endpoint_available(
            "/api/nonexistent", "GET", APIVersion.V1
        )
        # Unregistered endpoints should be considered available
>       assert is_available is True
E       assert False is True

tests/test_versioning.py:335: AssertionError
________________ TestAPIVersionManager.test_deprecate_endpoint _________________

self = <tests.test_versioning.TestAPIVersionManager object at 0x728983fcd310>

    def test_deprecate_endpoint(self):
        """Test deprecating an endpoint."""
        # Register endpoint
        self.manager.register_endpoint(
            path="/api/to-deprecate",
            method="GET",
            introduced_in=APIVersion.V1
        )
    
        # Deprecate endpoint
>       self.manager.deprecate_endpoint(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            "/api/to-deprecate", "GET", APIVersion.V2
        )
E       AttributeError: 'APIVersionManager' object has no attribute 'deprecate_endpoint'

tests/test_versioning.py:347: AttributeError
__________ TestAPIVersionManager.test_deprecate_nonexistent_endpoint ___________

self = <tests.test_versioning.TestAPIVersionManager object at 0x728983fcd520>

    def test_deprecate_nonexistent_endpoint(self):
        """Test deprecating a non-existent endpoint."""
        # Should not raise error
>       self.manager.deprecate_endpoint(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            "/api/nonexistent", "GET", APIVersion.V2
        )
E       AttributeError: 'APIVersionManager' object has no attribute 'deprecate_endpoint'

tests/test_versioning.py:358: AttributeError
_________________ TestAPIVersionManager.test_get_endpoint_info _________________

self = <tests.test_versioning.TestAPIVersionManager object at 0x728983fcd730>

    def test_get_endpoint_info(self):
        """Test getting endpoint information."""
        # Register endpoint
        self.manager.register_endpoint(
            path="/api/info-test",
            method="POST",
            introduced_in=APIVersion.V1,
            removed_in=APIVersion.V2
        )
    
>       endpoint_info = self.manager.get_endpoint_info(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            "/api/info-test", "POST"
        )
E       AttributeError: 'APIVersionManager' object has no attribute 'get_endpoint_info'. Did you mean: 'get_endpoint_status'?

tests/test_versioning.py:376: AttributeError
___________ TestAPIVersionManager.test_get_endpoint_info_nonexistent ___________

self = <tests.test_versioning.TestAPIVersionManager object at 0x728983fcd940>

    def test_get_endpoint_info_nonexistent(self):
        """Test getting info for non-existent endpoint."""
>       endpoint_info = self.manager.get_endpoint_info(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            "/api/nonexistent", "GET"
        )
E       AttributeError: 'APIVersionManager' object has no attribute 'get_endpoint_info'. Did you mean: 'get_endpoint_status'?

tests/test_versioning.py:388: AttributeError
_____________ TestAPIVersionManager.test_get_endpoints_for_version _____________

self = <tests.test_versioning.TestAPIVersionManager object at 0x728983fcdb50>

    def test_get_endpoints_for_version(self):
        """Test getting all endpoints available for a version."""
        # Register multiple endpoints
        endpoints_to_register = [
            ("/api/v1-only", "GET", APIVersion.V1, APIVersion.V2),
            ("/api/v1-v2", "GET", APIVersion.V1, None),
            ("/api/v2-only", "GET", APIVersion.V2, None),
        ]
    
        for path, method, introduced, removed in endpoints_to_register:
            self.manager.register_endpoint(
                path=path,
                method=method,
                introduced_in=introduced,
                removed_in=removed
            )
    
        # Get endpoints for V1
>       v1_endpoints = self.manager.get_endpoints_for_version(APIVersion.V1)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'APIVersionManager' object has no attribute 'get_endpoints_for_version'

tests/test_versioning.py:412: AttributeError
__________ TestAPIVersionManager.test_version_middleware_integration ___________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_versioning.py", line 470, in test_version_middleware_integration
    |     response = client.get("/api/test", headers={"API-Version": "v1"})
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_versioning.py", line 446, in version_middleware
    |     raise HTTPException(
    | fastapi.exceptions.HTTPException: 400: API version v1 is not supported
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_versioning.py", line 470, in test_version_middleware_integration
    response = client.get("/api/test", headers={"API-Version": "v1"})
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/tests/test_versioning.py", line 446, in version_middleware
    raise HTTPException(
fastapi.exceptions.HTTPException: 400: API version v1 is not supported

During handling of the above exception, another exception occurred:

self = <tests.test_versioning.TestAPIVersionManager object at 0x728983fcdd60>

    def test_version_middleware_integration(self):
        """Test integration with versioning middleware."""
        app = FastAPI()
    
        @app.get("/api/test")
        async def test_endpoint():
            return {"message": "test"}
    
        # Add versioning middleware
        @app.middleware("http")
        async def version_middleware(request: Request, call_next):
            # Extract version from header
            api_version = request.headers.get("API-Version", "v1")
    
            # Validate version
            version_enum = APIVersion.V1 if api_version == "v1" else APIVersion.V2
    
            if not self.manager.is_version_supported(version_enum):
                from fastapi import HTTPException
                raise HTTPException(
                    status_code=400,
                    detail=f"API version {api_version} is not supported"
                )
    
            response = await call_next(request)
            response.headers["API-Version"] = api_version
            return response
    
        client = TestClient(app)
    
        # Test with supported version
        response = client.get("/api/test", headers={"API-Version": "v2"})
        assert response.status_code == 200
        assert response.headers["API-Version"] == "v2"
    
        # Test with unsupported version (after making V1 sunset)
        sunset_v1 = VersionInfo(
            version=APIVersion.V1,
            status=VersionStatus.SUNSET,
            release_date="2023-01-01"
        )
        self.manager.add_version(sunset_v1)
    
>       response = client.get("/api/test", headers={"API-Version": "v1"})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_versioning.py:470: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

request = <starlette.middleware.base._CachedRequest object at 0x72888f11a1b0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x728894161c60>

    @app.middleware("http")
    async def version_middleware(request: Request, call_next):
        # Extract version from header
        api_version = request.headers.get("API-Version", "v1")
    
        # Validate version
        version_enum = APIVersion.V1 if api_version == "v1" else APIVersion.V2
    
        if not self.manager.is_version_supported(version_enum):
            from fastapi import HTTPException
>           raise HTTPException(
                status_code=400,
                detail=f"API version {api_version} is not supported"
            )
E           fastapi.exceptions.HTTPException: 400: API version v1 is not supported

tests/test_versioning.py:446: HTTPException
__________ TestVersioningIntegration.test_complete_version_lifecycle ___________

self = <tests.test_versioning.TestVersioningIntegration object at 0x728983fcdf70>

    def test_complete_version_lifecycle(self):
        """Test complete version lifecycle management."""
        # 1. Add a new version
        v3_info = VersionInfo(
            version=APIVersion.V2,  # Override V2 for testing
            status=VersionStatus.ACTIVE,
            release_date="2024-12-01",
            documentation_url="https://api.example.com/docs/v3",
            breaking_changes=["Restructured response format"],
            new_features=["Real-time streaming", "Enhanced security"]
        )
        self.manager.add_version(v3_info)
    
        # 2. Register endpoints for different versions
        self.manager.register_endpoint("/api/legacy", "GET", APIVersion.V1, APIVersion.V2)
        self.manager.register_endpoint("/api/stable", "GET", APIVersion.V1)
        self.manager.register_endpoint("/api/new", "GET", APIVersion.V2)
    
        # 3. Deprecate an endpoint
>       self.manager.deprecate_endpoint("/api/stable", "GET", APIVersion.V2)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'APIVersionManager' object has no attribute 'deprecate_endpoint'

tests/test_versioning.py:501: AttributeError
__________ TestVersioningIntegration.test_version_migration_scenario ___________

self = <tests.test_versioning.TestVersioningIntegration object at 0x728983fce0f0>

    def test_version_migration_scenario(self):
        """Test a realistic version migration scenario."""
        # Scenario: Migrating from V1 to V2 with gradual deprecation
    
        # 1. Start with V1 as active, V2 as new
        v1_info = VersionInfo(
            version=APIVersion.V1,
            status=VersionStatus.ACTIVE,
            release_date="2023-01-01",
            documentation_url="https://api.example.com/docs/v1"
        )
        self.manager.add_version(v1_info)
    
        # 2. Register endpoints that exist in V1
        legacy_endpoints = [
            "/api/users",
            "/api/posts",
            "/api/comments"
        ]
    
        for endpoint in legacy_endpoints:
            self.manager.register_endpoint(endpoint, "GET", APIVersion.V1)
            self.manager.register_endpoint(endpoint, "POST", APIVersion.V1)
    
        # 3. Add V2 with some endpoints deprecated/changed
        v2_info = VersionInfo(
            version=APIVersion.V2,
            status=VersionStatus.ACTIVE,
            release_date="2024-06-01",
            documentation_url="https://api.example.com/docs/v2",
            breaking_changes=[
                "Removed /api/comments endpoint",
                "Changed /api/posts response format"
            ],
            new_features=[
                "Added /api/threads endpoint",
                "Enhanced /api/users with filtering"
            ]
        )
        self.manager.add_version(v2_info)
    
        # 4. Register V2 changes
        self.manager.register_endpoint("/api/comments", "GET", APIVersion.V1, APIVersion.V2)  # Removed in V2
        self.manager.register_endpoint("/api/threads", "GET", APIVersion.V2)  # New in V2
>       self.manager.deprecate_endpoint("/api/posts", "POST", APIVersion.V2)  # Deprecated in V2
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'APIVersionManager' object has no attribute 'deprecate_endpoint'

tests/test_versioning.py:559: AttributeError
_______ TestVersioningIntegration.test_backwards_compatibility_checking ________

self = <tests.test_versioning.TestVersioningIntegration object at 0x728983fce300>

    def test_backwards_compatibility_checking(self):
        """Test backwards compatibility validation."""
        # Register endpoints in V1
        self.manager.register_endpoint("/api/stable", "GET", APIVersion.V1)
        self.manager.register_endpoint("/api/changing", "GET", APIVersion.V1, APIVersion.V2)
    
        # Get compatibility report
>       v1_endpoints = self.manager.get_endpoints_for_version(APIVersion.V1)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'APIVersionManager' object has no attribute 'get_endpoints_for_version'

tests/test_versioning.py:597: AttributeError
________ TestWorkflowExecutionService.test_execute_workflow_with_limits ________

self = <chatter.core.workflow_executors.PlainWorkflowExecutor object at 0x728896089ee0>
conversation = <MagicMock spec='Conversation' id='125930838506528'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='plain', provider=No...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> tuple[Message, dict[str, Any]]:
        """Execute plain workflow."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Create and execute plain workflow
            workflow = await self.llm_service.create_langgraph_workflow(
                provider_name=chat_request.provider,
                workflow_type=self.workflow_type,
                enable_memory=True,
                memory_window=20,
                system_message=chat_request.system_prompt_override,
            )
    
            # Prepare conversation context
            messages = []
            recent_messages = await self.message_service.get_recent_messages(
                conversation.id, limit=20
            )
    
            for msg in recent_messages:
                if msg.role == MessageRole.USER:
                    messages.append({"role": "human", "content": msg.content})
                elif msg.role == MessageRole.ASSISTANT:
                    messages.append({"role": "ai", "content": msg.content})
    
            # Add current message
            messages.append({"role": "human", "content": chat_request.message})
    
            # Execute workflow
            state = ConversationState(messages=messages)
            result = await workflow.ainvoke(state, {"configurable": {"thread_id": conversation.id}})
    
            # Extract response
            if isinstance(result["messages"][-1], AIMessage):
                response_content = result["messages"][-1].content
            else:
                response_content = str(result["messages"][-1])
    
            # Create response message
>           assistant_message = await self.message_service.create_message(
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                conversation_id=conversation.id,
                role=MessageRole.ASSISTANT,
                content=response_content,
            )

chatter/core/workflow_executors.py:205: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <AsyncMock spec='MessageService' id='125930841543584'>
name = 'create_message'

    def __getattr__(self, name):
        if name in {'_mock_methods', '_mock_unsafe'}:
            raise AttributeError(name)
        elif self._mock_methods is not None:
            if name not in self._mock_methods or name in _all_magics:
>               raise AttributeError("Mock object has no attribute %r" % name)
E               AttributeError: Mock object has no attribute 'create_message'. Did you mean: 'delete_message'?

/usr/lib64/python3.12/unittest/mock.py:660: AttributeError

The above exception was the direct cause of the following exception:

self = <chatter.core.workflow_executors.PlainWorkflowExecutor object at 0x728896089ee0>
conversation = <MagicMock spec='Conversation' id='125930838506528'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='plain', provider=No...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> tuple[Message, dict[str, Any]]:
        """Execute plain workflow."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Create and execute plain workflow
            workflow = await self.llm_service.create_langgraph_workflow(
                provider_name=chat_request.provider,
                workflow_type=self.workflow_type,
                enable_memory=True,
                memory_window=20,
                system_message=chat_request.system_prompt_override,
            )
    
            # Prepare conversation context
            messages = []
            recent_messages = await self.message_service.get_recent_messages(
                conversation.id, limit=20
            )
    
            for msg in recent_messages:
                if msg.role == MessageRole.USER:
                    messages.append({"role": "human", "content": msg.content})
                elif msg.role == MessageRole.ASSISTANT:
                    messages.append({"role": "ai", "content": msg.content})
    
            # Add current message
            messages.append({"role": "human", "content": chat_request.message})
    
            # Execute workflow
            state = ConversationState(messages=messages)
            result = await workflow.ainvoke(state, {"configurable": {"thread_id": conversation.id}})
    
            # Extract response
            if isinstance(result["messages"][-1], AIMessage):
                response_content = result["messages"][-1].content
            else:
                response_content = str(result["messages"][-1])
    
            # Create response message
            assistant_message = await self.message_service.create_message(
                conversation_id=conversation.id,
                role=MessageRole.ASSISTANT,
                content=response_content,
            )
    
            # Record success metrics
            await self._record_metrics(
                workflow_id, "execute", start_time, True, correlation_id=correlation_id
            )
    
            return assistant_message, {"usage": result.get("usage", {})}
    
        except Exception as e:
            # Record error metrics
            await self._record_metrics(
                workflow_id, "execute", start_time, False,
                error_type=type(e).__name__, correlation_id=correlation_id
            )
>           raise WorkflowExecutionError(f"Plain workflow execution failed: {str(e)}") from e
E           chatter.core.workflow_executors.WorkflowExecutionError: Plain workflow execution failed: Mock object has no attribute 'create_message'

chatter/core/workflow_executors.py:224: WorkflowExecutionError

During handling of the above exception, another exception occurred:

self = <tests.test_workflow_limits_and_streaming.TestWorkflowExecutionService object at 0x728983fcf3e0>

    @pytest.mark.asyncio
    async def test_execute_workflow_with_limits(self):
        """Test workflow execution with resource limits."""
        # Mock LLM response
        mock_response = MagicMock()
        mock_response.content = "Test response"
    
        mock_provider = AsyncMock()
        mock_provider.ainvoke.return_value = mock_response
        mock_provider.__class__.__name__ = "TestProvider"
    
        self.llm_service.get_default_provider.return_value = mock_provider
        self.llm_service.convert_conversation_to_messages.return_value = []
    
        # Mock message service
        self.workflow_service._get_conversation_messages = AsyncMock(return_value=[])
    
        # Define custom limits
        limits = WorkflowLimits(
            execution_timeout=60,
            step_timeout=30,
            streaming_timeout=120,
            max_tokens=1000,
            max_memory_mb=512,
            max_concurrent=5,
        )
    
        # Execute workflow
>       result_message, usage_info = await self.workflow_service.execute_workflow(
            self.conversation,
            self.chat_request,
            self.correlation_id,
            user_id="user_123",
            limits=limits,
        )

tests/test_workflow_limits_and_streaming.py:202: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/services/workflow_execution.py:86: in execute_workflow
    return await executor.execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.core.workflow_executors.PlainWorkflowExecutor object at 0x728896089ee0>
conversation = <MagicMock spec='Conversation' id='125930838506528'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='plain', provider=No...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> tuple[Message, dict[str, Any]]:
        """Execute plain workflow."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Create and execute plain workflow
            workflow = await self.llm_service.create_langgraph_workflow(
                provider_name=chat_request.provider,
                workflow_type=self.workflow_type,
                enable_memory=True,
                memory_window=20,
                system_message=chat_request.system_prompt_override,
            )
    
            # Prepare conversation context
            messages = []
            recent_messages = await self.message_service.get_recent_messages(
                conversation.id, limit=20
            )
    
            for msg in recent_messages:
                if msg.role == MessageRole.USER:
                    messages.append({"role": "human", "content": msg.content})
                elif msg.role == MessageRole.ASSISTANT:
                    messages.append({"role": "ai", "content": msg.content})
    
            # Add current message
            messages.append({"role": "human", "content": chat_request.message})
    
            # Execute workflow
            state = ConversationState(messages=messages)
            result = await workflow.ainvoke(state, {"configurable": {"thread_id": conversation.id}})
    
            # Extract response
            if isinstance(result["messages"][-1], AIMessage):
                response_content = result["messages"][-1].content
            else:
                response_content = str(result["messages"][-1])
    
            # Create response message
            assistant_message = await self.message_service.create_message(
                conversation_id=conversation.id,
                role=MessageRole.ASSISTANT,
                content=response_content,
            )
    
            # Record success metrics
            await self._record_metrics(
                workflow_id, "execute", start_time, True, correlation_id=correlation_id
            )
    
            return assistant_message, {"usage": result.get("usage", {})}
    
        except Exception as e:
            # Record error metrics
            await self._record_metrics(
                workflow_id, "execute", start_time, False,
                error_type=type(e).__name__, correlation_id=correlation_id
            )
            raise WorkflowExecutionError(f"Plain workflow execution failed: {str(e)}") from e
        finally:
            # Clean up resource tracking
            if user_id:
>               self.limit_manager.end_workflow_tracking(workflow_id)
E               TypeError: WorkflowLimitManager.end_workflow_tracking() missing 1 required positional argument: 'user_id'

chatter/core/workflow_executors.py:228: TypeError
__________ TestWorkflowExecutionService.test_execute_workflow_timeout __________

self = <chatter.core.workflow_executors.PlainWorkflowExecutor object at 0x72888e826210>
conversation = <MagicMock spec='Conversation' id='125930926110816'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='plain', provider=No...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=1, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> tuple[Message, dict[str, Any]]:
        """Execute plain workflow."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Create and execute plain workflow
            workflow = await self.llm_service.create_langgraph_workflow(
                provider_name=chat_request.provider,
                workflow_type=self.workflow_type,
                enable_memory=True,
                memory_window=20,
                system_message=chat_request.system_prompt_override,
            )
    
            # Prepare conversation context
            messages = []
            recent_messages = await self.message_service.get_recent_messages(
                conversation.id, limit=20
            )
    
            for msg in recent_messages:
                if msg.role == MessageRole.USER:
                    messages.append({"role": "human", "content": msg.content})
                elif msg.role == MessageRole.ASSISTANT:
                    messages.append({"role": "ai", "content": msg.content})
    
            # Add current message
            messages.append({"role": "human", "content": chat_request.message})
    
            # Execute workflow
            state = ConversationState(messages=messages)
            result = await workflow.ainvoke(state, {"configurable": {"thread_id": conversation.id}})
    
            # Extract response
            if isinstance(result["messages"][-1], AIMessage):
                response_content = result["messages"][-1].content
            else:
                response_content = str(result["messages"][-1])
    
            # Create response message
>           assistant_message = await self.message_service.create_message(
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                conversation_id=conversation.id,
                role=MessageRole.ASSISTANT,
                content=response_content,
            )

chatter/core/workflow_executors.py:205: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <AsyncMock spec='MessageService' id='125930831656624'>
name = 'create_message'

    def __getattr__(self, name):
        if name in {'_mock_methods', '_mock_unsafe'}:
            raise AttributeError(name)
        elif self._mock_methods is not None:
            if name not in self._mock_methods or name in _all_magics:
>               raise AttributeError("Mock object has no attribute %r" % name)
E               AttributeError: Mock object has no attribute 'create_message'. Did you mean: 'delete_message'?

/usr/lib64/python3.12/unittest/mock.py:660: AttributeError

The above exception was the direct cause of the following exception:

self = <chatter.core.workflow_executors.PlainWorkflowExecutor object at 0x72888e826210>
conversation = <MagicMock spec='Conversation' id='125930926110816'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='plain', provider=No...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=1, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> tuple[Message, dict[str, Any]]:
        """Execute plain workflow."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Create and execute plain workflow
            workflow = await self.llm_service.create_langgraph_workflow(
                provider_name=chat_request.provider,
                workflow_type=self.workflow_type,
                enable_memory=True,
                memory_window=20,
                system_message=chat_request.system_prompt_override,
            )
    
            # Prepare conversation context
            messages = []
            recent_messages = await self.message_service.get_recent_messages(
                conversation.id, limit=20
            )
    
            for msg in recent_messages:
                if msg.role == MessageRole.USER:
                    messages.append({"role": "human", "content": msg.content})
                elif msg.role == MessageRole.ASSISTANT:
                    messages.append({"role": "ai", "content": msg.content})
    
            # Add current message
            messages.append({"role": "human", "content": chat_request.message})
    
            # Execute workflow
            state = ConversationState(messages=messages)
            result = await workflow.ainvoke(state, {"configurable": {"thread_id": conversation.id}})
    
            # Extract response
            if isinstance(result["messages"][-1], AIMessage):
                response_content = result["messages"][-1].content
            else:
                response_content = str(result["messages"][-1])
    
            # Create response message
            assistant_message = await self.message_service.create_message(
                conversation_id=conversation.id,
                role=MessageRole.ASSISTANT,
                content=response_content,
            )
    
            # Record success metrics
            await self._record_metrics(
                workflow_id, "execute", start_time, True, correlation_id=correlation_id
            )
    
            return assistant_message, {"usage": result.get("usage", {})}
    
        except Exception as e:
            # Record error metrics
            await self._record_metrics(
                workflow_id, "execute", start_time, False,
                error_type=type(e).__name__, correlation_id=correlation_id
            )
>           raise WorkflowExecutionError(f"Plain workflow execution failed: {str(e)}") from e
E           chatter.core.workflow_executors.WorkflowExecutionError: Plain workflow execution failed: Mock object has no attribute 'create_message'

chatter/core/workflow_executors.py:224: WorkflowExecutionError

During handling of the above exception, another exception occurred:

self = <tests.test_workflow_limits_and_streaming.TestWorkflowExecutionService object at 0x728983fcf5c0>

    @pytest.mark.asyncio
    async def test_execute_workflow_timeout(self):
        """Test workflow execution timeout."""
        # Mock slow LLM response
        async def slow_invoke(*args, **kwargs):
            await asyncio.sleep(2)  # Simulate slow response
            mock_response = MagicMock()
            mock_response.content = "Test response"
            return mock_response
    
        mock_provider = AsyncMock()
        mock_provider.ainvoke = slow_invoke
        mock_provider.__class__.__name__ = "TestProvider"
    
        self.llm_service.get_default_provider.return_value = mock_provider
        self.llm_service.convert_conversation_to_messages.return_value = []
        self.workflow_service._get_conversation_messages = AsyncMock(return_value=[])
    
        # Define short timeout
        limits = WorkflowLimits(
            execution_timeout=1,  # 1 second timeout
            step_timeout=30,
            streaming_timeout=120,
            max_tokens=1000,
            max_memory_mb=512,
            max_concurrent=5,
        )
    
        # Should timeout
        with pytest.raises(WorkflowTimeoutError) as exc_info:
>           await self.workflow_service.execute_workflow(
                self.conversation,
                self.chat_request,
                self.correlation_id,
                user_id="user_123",
                limits=limits,
            )

tests/test_workflow_limits_and_streaming.py:245: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/services/workflow_execution.py:86: in execute_workflow
    return await executor.execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.core.workflow_executors.PlainWorkflowExecutor object at 0x72888e826210>
conversation = <MagicMock spec='Conversation' id='125930926110816'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='plain', provider=No...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=1, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> tuple[Message, dict[str, Any]]:
        """Execute plain workflow."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Create and execute plain workflow
            workflow = await self.llm_service.create_langgraph_workflow(
                provider_name=chat_request.provider,
                workflow_type=self.workflow_type,
                enable_memory=True,
                memory_window=20,
                system_message=chat_request.system_prompt_override,
            )
    
            # Prepare conversation context
            messages = []
            recent_messages = await self.message_service.get_recent_messages(
                conversation.id, limit=20
            )
    
            for msg in recent_messages:
                if msg.role == MessageRole.USER:
                    messages.append({"role": "human", "content": msg.content})
                elif msg.role == MessageRole.ASSISTANT:
                    messages.append({"role": "ai", "content": msg.content})
    
            # Add current message
            messages.append({"role": "human", "content": chat_request.message})
    
            # Execute workflow
            state = ConversationState(messages=messages)
            result = await workflow.ainvoke(state, {"configurable": {"thread_id": conversation.id}})
    
            # Extract response
            if isinstance(result["messages"][-1], AIMessage):
                response_content = result["messages"][-1].content
            else:
                response_content = str(result["messages"][-1])
    
            # Create response message
            assistant_message = await self.message_service.create_message(
                conversation_id=conversation.id,
                role=MessageRole.ASSISTANT,
                content=response_content,
            )
    
            # Record success metrics
            await self._record_metrics(
                workflow_id, "execute", start_time, True, correlation_id=correlation_id
            )
    
            return assistant_message, {"usage": result.get("usage", {})}
    
        except Exception as e:
            # Record error metrics
            await self._record_metrics(
                workflow_id, "execute", start_time, False,
                error_type=type(e).__name__, correlation_id=correlation_id
            )
            raise WorkflowExecutionError(f"Plain workflow execution failed: {str(e)}") from e
        finally:
            # Clean up resource tracking
            if user_id:
>               self.limit_manager.end_workflow_tracking(workflow_id)
E               TypeError: WorkflowLimitManager.end_workflow_tracking() missing 1 required positional argument: 'user_id'

chatter/core/workflow_executors.py:228: TypeError
_________ TestWorkflowExecutionService.test_concurrent_workflow_limit __________

self = <chatter.core.workflow_executors.PlainWorkflowExecutor object at 0x72888e821460>
conversation = <MagicMock spec='Conversation' id='125930832358016'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='plain', provider=No...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_1', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=1)

    async def _setup_execution(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> tuple[str, WorkflowLimits]:
        """Common setup for workflow execution."""
        workflow_id = f"{correlation_id}_{self.workflow_type}"
    
        # Use provided limits or get defaults
        if limits is None:
            limits = self.limit_manager.get_default_limits()
    
        # Start resource tracking if user_id provided
        if user_id:
            try:
>               self.limit_manager.start_workflow_tracking(workflow_id, user_id, limits)

chatter/core/workflow_executors.py:113: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/core/workflow_limits.py:94: in start_workflow_tracking
    self.check_concurrent_limit(user_id, limits)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.core.workflow_limits.WorkflowLimitManager object at 0x728ac7fcb980>
user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=1)

    def check_concurrent_limit(self, user_id: str, limits: WorkflowLimits) -> None:
        """Check if user has reached concurrent workflow limit."""
        current_count = self.user_workflow_counts.get(user_id, 0)
        if current_count >= limits.max_concurrent:
>           raise WorkflowResourceLimitError(
                f"User {user_id} has reached maximum concurrent workflows limit",
                "concurrent_workflows",
                current_count,
                limits.max_concurrent,
            )
E           chatter.core.workflow_limits.WorkflowResourceLimitError: User user_123 has reached maximum concurrent workflows limit

chatter/core/workflow_limits.py:83: WorkflowResourceLimitError

The above exception was the direct cause of the following exception:

self = <tests.test_workflow_limits_and_streaming.TestWorkflowExecutionService object at 0x728983fcf860>

    @pytest.mark.asyncio
    async def test_concurrent_workflow_limit(self):
        """Test concurrent workflow limit enforcement."""
        # Mock successful workflow
        mock_response = MagicMock()
        mock_response.content = "Test response"
    
        mock_provider = AsyncMock()
        mock_provider.ainvoke.return_value = mock_response
        mock_provider.__class__.__name__ = "TestProvider"
    
        self.llm_service.get_default_provider.return_value = mock_provider
        self.llm_service.convert_conversation_to_messages.return_value = []
        self.workflow_service._get_conversation_messages = AsyncMock(return_value=[])
    
        # Set very low concurrent limit
        limits = WorkflowLimits(
            execution_timeout=60,
            step_timeout=30,
            streaming_timeout=120,
            max_tokens=1000,
            max_memory_mb=512,
            max_concurrent=1,
        )
    
        user_id = "user_123"
    
        # First workflow should succeed
>       result1 = await self.workflow_service.execute_workflow(
            self.conversation,
            self.chat_request,
            "corr_1",
            user_id=user_id,
            limits=limits,
        )

tests/test_workflow_limits_and_streaming.py:282: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/services/workflow_execution.py:86: in execute_workflow
    return await executor.execute(
chatter/core/workflow_executors.py:162: in execute
    workflow_id, limits = await self._setup_execution(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.core.workflow_executors.PlainWorkflowExecutor object at 0x72888e821460>
conversation = <MagicMock spec='Conversation' id='125930832358016'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='plain', provider=No...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_1', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=1)

    async def _setup_execution(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> tuple[str, WorkflowLimits]:
        """Common setup for workflow execution."""
        workflow_id = f"{correlation_id}_{self.workflow_type}"
    
        # Use provided limits or get defaults
        if limits is None:
            limits = self.limit_manager.get_default_limits()
    
        # Start resource tracking if user_id provided
        if user_id:
            try:
                self.limit_manager.start_workflow_tracking(workflow_id, user_id, limits)
            except WorkflowResourceLimitError as e:
                logger.warning(
                    "Workflow rejected due to resource limits",
                    extra={"user_id": user_id, "error": str(e), "correlation_id": correlation_id}
                )
>               raise WorkflowExecutionError(f"Resource limit exceeded: {e}") from e
E               chatter.core.workflow_executors.WorkflowExecutionError: Resource limit exceeded: User user_123 has reached maximum concurrent workflows limit

chatter/core/workflow_executors.py:119: WorkflowExecutionError
------------------------------ Captured log call -------------------------------
WARNING  chatter.core.workflow_executors:workflow_executors.py:115 Workflow rejected due to resource limits
_______ TestWorkflowExecutionService.test_streaming_workflow_with_limits _______

self = <tests.test_workflow_limits_and_streaming.TestWorkflowExecutionService object at 0x728983fcfb00>

    @pytest.mark.asyncio
    async def test_streaming_workflow_with_limits(self):
        """Test streaming workflow execution with resource limits."""
        # Mock streaming response
        mock_provider = AsyncMock()
        mock_provider.__class__.__name__ = "TestProvider"
    
        # Mock astream method for native streaming
        async def mock_astream(messages):
            chunks = [
                MagicMock(content="Hello"),
                MagicMock(content=" "),
                MagicMock(content="world"),
            ]
            for chunk in chunks:
                yield chunk
    
        mock_provider.astream = mock_astream
    
        self.llm_service.get_default_provider.return_value = mock_provider
        self.llm_service.convert_conversation_to_messages.return_value = []
        self.workflow_service._get_conversation_messages = AsyncMock(return_value=[])
    
        # Mock the workflow manager to avoid the 'str' object astream issue
>       with patch('chatter.services.workflow_execution.get_workflow_manager') as mock_get_manager:
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_workflow_limits_and_streaming.py:330: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x72888e842270>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.services.workflow_execution' from '/home/yam/chatter/chatter/services/workflow_execution.py'> does not have the attribute 'get_workflow_manager'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
_________ TestWorkflowExecutionService.test_streaming_workflow_timeout _________

self = <tests.test_workflow_limits_and_streaming.TestWorkflowExecutionService object at 0x728983fe4080>

    @pytest.mark.asyncio
    async def test_streaming_workflow_timeout(self):
        """Test streaming workflow timeout."""
        # Mock workflow manager to avoid the 'str' object astream issue
>       with patch('chatter.services.workflow_execution.get_workflow_manager') as mock_get_manager:
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_workflow_limits_and_streaming.py:381: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x72888e843c80>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.services.workflow_execution' from '/home/yam/chatter/chatter/services/workflow_execution.py'> does not have the attribute 'get_workflow_manager'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
___ TestWorkflowExecutionService.test_enhanced_token_streaming_all_workflows ___

self = <chatter.core.workflow_executors.RAGWorkflowExecutor object at 0x72888e8642f0>
conversation = <MagicMock spec='Conversation' id='125930831926320'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='rag', provider=None...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute_streaming(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> AsyncGenerator[StreamingChatChunk, None]:
        """Execute RAG workflow with streaming."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Get retriever from workflow manager
            workflow_manager = get_workflow_manager()
>           retriever = workflow_manager.get_retriever(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                conversation.workspace_id if conversation.workspace_id else "default"
            )
E           AttributeError: 'LangGraphWorkflowManager' object has no attribute 'get_retriever'

chatter/core/workflow_executors.py:430: AttributeError

The above exception was the direct cause of the following exception:

self = <chatter.core.workflow_executors.RAGWorkflowExecutor object at 0x72888e8642f0>
conversation = <MagicMock spec='Conversation' id='125930831926320'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='rag', provider=None...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute_streaming(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> AsyncGenerator[StreamingChatChunk, None]:
        """Execute RAG workflow with streaming."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Get retriever from workflow manager
            workflow_manager = get_workflow_manager()
            retriever = workflow_manager.get_retriever(
                conversation.workspace_id if conversation.workspace_id else "default"
            )
    
            # Create streaming RAG workflow
            workflow = await self.llm_service.create_langgraph_workflow(
                provider_name=chat_request.provider,
                workflow_type=self.workflow_type,
                retriever=retriever,
                enable_memory=True,
                memory_window=30,
                max_documents=10,
                system_message=chat_request.system_prompt_override,
            )
    
            # Prepare conversation state
            messages = []
            recent_messages = await self.message_service.get_recent_messages(
                conversation.id, limit=30
            )
    
            for msg in recent_messages:
                if msg.role == MessageRole.USER:
                    messages.append({"role": "human", "content": msg.content})
                elif msg.role == MessageRole.ASSISTANT:
                    messages.append({"role": "ai", "content": msg.content})
    
            messages.append({"role": "human", "content": chat_request.message})
            state = ConversationState(messages=messages)
    
            # Stream workflow execution
            content_buffer = ""
            async for event in workflow.astream(
                state, {"configurable": {"thread_id": conversation.id}}
            ):
                if "messages" in event:
                    message = event["messages"][-1]
                    if hasattr(message, "content") and message.content:
                        # Extract new content since last chunk
                        if len(message.content) > len(content_buffer):
                            new_content = message.content[len(content_buffer):]
                            content_buffer = message.content
    
                            yield StreamingChatChunk(
                                id=correlation_id,
                                content=new_content,
                                role="assistant",
                                conversation_id=conversation.id,
                            )
    
            # Create final message
            if content_buffer:
                await self.message_service.create_message(
                    conversation_id=conversation.id,
                    role=MessageRole.ASSISTANT,
                    content=content_buffer,
                )
    
            # Record success metrics
            await self._record_metrics(
                workflow_id, "stream", start_time, True, correlation_id=correlation_id
            )
    
        except Exception as e:
            # Record error metrics
            await self._record_metrics(
                workflow_id, "stream", start_time, False,
                error_type=type(e).__name__, correlation_id=correlation_id
            )
>           raise WorkflowExecutionError(f"RAG workflow streaming failed: {str(e)}") from e
E           chatter.core.workflow_executors.WorkflowExecutionError: RAG workflow streaming failed: 'LangGraphWorkflowManager' object has no attribute 'get_retriever'

chatter/core/workflow_executors.py:499: WorkflowExecutionError

During handling of the above exception, another exception occurred:

self = <tests.test_workflow_limits_and_streaming.TestWorkflowExecutionService object at 0x728983fe4320>

    @pytest.mark.asyncio
    async def test_enhanced_token_streaming_all_workflows(self):
        """Test enhanced token streaming for all workflow types."""
        # Mock workflow manager
        with patch('chatter.core.dependencies.get_workflow_manager') as mock_get_manager:
            mock_workflow_manager = MagicMock()
            mock_get_manager.return_value = mock_workflow_manager
    
            # Mock streaming workflow response
            async def mock_stream_workflow(workflow_type, state):
                events = [
                    {"type": "thinking", "thought": "Processing..."},
                    {"type": "token", "content": "Test"},
                    {"type": "token", "content": " response"},
                    {"type": "complete", "usage": {"tokens": 2}},
                ]
                for event in events:
                    yield event
    
            mock_workflow_manager.stream_workflow = mock_stream_workflow
    
            self.workflow_service._get_conversation_messages = AsyncMock(return_value=[])
    
            limits = WorkflowLimits(
                execution_timeout=60,
                step_timeout=30,
                streaming_timeout=120,
                max_tokens=1000,
                max_memory_mb=512,
                max_concurrent=5,
            )
    
            # Test different workflow types
            for workflow_type in ["rag", "tools", "full"]:
                self.chat_request.workflow = workflow_type
    
                chunks = []
>               async for chunk in self.workflow_service.execute_workflow_streaming(
                    self.conversation,
                    self.chat_request,
                    self.correlation_id,
                    user_id="user_123",
                    limits=limits,
                ):

tests/test_workflow_limits_and_streaming.py:462: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/services/workflow_execution.py:121: in execute_workflow_streaming
    async for chunk in executor.execute_streaming(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.core.workflow_executors.RAGWorkflowExecutor object at 0x72888e8642f0>
conversation = <MagicMock spec='Conversation' id='125930831926320'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='rag', provider=None...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute_streaming(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> AsyncGenerator[StreamingChatChunk, None]:
        """Execute RAG workflow with streaming."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Get retriever from workflow manager
            workflow_manager = get_workflow_manager()
            retriever = workflow_manager.get_retriever(
                conversation.workspace_id if conversation.workspace_id else "default"
            )
    
            # Create streaming RAG workflow
            workflow = await self.llm_service.create_langgraph_workflow(
                provider_name=chat_request.provider,
                workflow_type=self.workflow_type,
                retriever=retriever,
                enable_memory=True,
                memory_window=30,
                max_documents=10,
                system_message=chat_request.system_prompt_override,
            )
    
            # Prepare conversation state
            messages = []
            recent_messages = await self.message_service.get_recent_messages(
                conversation.id, limit=30
            )
    
            for msg in recent_messages:
                if msg.role == MessageRole.USER:
                    messages.append({"role": "human", "content": msg.content})
                elif msg.role == MessageRole.ASSISTANT:
                    messages.append({"role": "ai", "content": msg.content})
    
            messages.append({"role": "human", "content": chat_request.message})
            state = ConversationState(messages=messages)
    
            # Stream workflow execution
            content_buffer = ""
            async for event in workflow.astream(
                state, {"configurable": {"thread_id": conversation.id}}
            ):
                if "messages" in event:
                    message = event["messages"][-1]
                    if hasattr(message, "content") and message.content:
                        # Extract new content since last chunk
                        if len(message.content) > len(content_buffer):
                            new_content = message.content[len(content_buffer):]
                            content_buffer = message.content
    
                            yield StreamingChatChunk(
                                id=correlation_id,
                                content=new_content,
                                role="assistant",
                                conversation_id=conversation.id,
                            )
    
            # Create final message
            if content_buffer:
                await self.message_service.create_message(
                    conversation_id=conversation.id,
                    role=MessageRole.ASSISTANT,
                    content=content_buffer,
                )
    
            # Record success metrics
            await self._record_metrics(
                workflow_id, "stream", start_time, True, correlation_id=correlation_id
            )
    
        except Exception as e:
            # Record error metrics
            await self._record_metrics(
                workflow_id, "stream", start_time, False,
                error_type=type(e).__name__, correlation_id=correlation_id
            )
            raise WorkflowExecutionError(f"RAG workflow streaming failed: {str(e)}") from e
        finally:
            # Clean up resource tracking
            if user_id:
>               self.limit_manager.end_workflow_tracking(workflow_id)
E               TypeError: WorkflowLimitManager.end_workflow_tracking() missing 1 required positional argument: 'user_id'

chatter/core/workflow_executors.py:503: TypeError

