============================= test session starts ==============================
platform linux -- Python 3.12.11, pytest-8.4.1, pluggy-1.6.0 -- /usr/bin/python3.12
cachedir: .pytest_cache
rootdir: /home/yam/chatter
configfile: pyproject.toml
testpaths: tests
plugins: mock-3.14.1, cov-6.2.1, socket-0.7.0, timeout-2.4.0, anyio-4.9.0, asyncio-1.1.0, langsmith-0.4.21, postgresql-7.0.2
asyncio: mode=Mode.AUTO, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collecting ... collected 776 items / 1 skipped

tests/e2e/test_auth_e2e.py::TestAuthE2E::test_complete_registration_workflow SKIPPED [  0%]
tests/e2e/test_auth_e2e.py::TestAuthE2E::test_complete_login_workflow SKIPPED [  0%]
tests/e2e/test_auth_e2e.py::TestAuthE2E::test_profile_access_workflow SKIPPED [  0%]
tests/e2e/test_auth_e2e.py::TestAuthE2E::test_registration_login_profile_complete_flow SKIPPED [  0%]
tests/e2e/test_auth_e2e.py::TestAuthE2E::test_invalid_credentials_workflow SKIPPED [  0%]
tests/e2e/test_chat_e2e.py::TestChatE2E::test_complete_chat_conversation_workflow SKIPPED [  0%]
tests/e2e/test_chat_e2e.py::TestChatE2E::test_chat_list_and_retrieval_workflow SKIPPED [  0%]
tests/e2e/test_chat_e2e.py::TestChatE2E::test_chat_message_streaming_workflow SKIPPED [  1%]
tests/e2e/test_chat_e2e.py::TestChatE2E::test_chat_deletion_workflow SKIPPED [  1%]
tests/e2e/test_chat_e2e.py::TestChatE2E::test_multi_user_chat_isolation SKIPPED [  1%]
tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_complete_document_upload_workflow SKIPPED [  1%]
tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_document_list_and_search_workflow SKIPPED [  1%]
tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_document_processing_status_workflow SKIPPED [  1%]
tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_document_chat_integration_workflow SKIPPED [  1%]
tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_document_deletion_workflow SKIPPED [  1%]
tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_large_document_upload_workflow SKIPPED [  2%]
tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_complete_lifecycle SKIPPED [  2%]
tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_list_and_filter SKIPPED [  2%]
tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_update_workflow SKIPPED [  2%]
tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_metrics_and_performance SKIPPED [  2%]
tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_error_scenarios SKIPPED [  2%]
tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_state_validation SKIPPED [  2%]
tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_concurrent_operations SKIPPED [  2%]
tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_data_persistence SKIPPED [  3%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_create_ab_test_requires_auth SKIPPED [  3%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_list_ab_tests_requires_auth SKIPPED [  3%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_ab_test_requires_auth SKIPPED [  3%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_update_ab_test_requires_auth SKIPPED [  3%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_delete_ab_test_requires_auth SKIPPED [  3%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_start_ab_test_requires_auth SKIPPED [  3%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_pause_ab_test_requires_auth SKIPPED [  3%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_complete_ab_test_requires_auth SKIPPED [  4%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_results_requires_auth SKIPPED [  4%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_metrics_requires_auth SKIPPED [  4%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_create_ab_test_success SKIPPED [  4%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_create_ab_test_invalid_data SKIPPED [  4%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_create_ab_test_invalid_allocation SKIPPED [  4%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_list_ab_tests_success SKIPPED [  4%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_ab_test_success SKIPPED [  5%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_ab_test_not_found SKIPPED [  5%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_start_ab_test_success SKIPPED [  5%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_start_ab_test_invalid_status SKIPPED [  5%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_delete_running_test_forbidden SKIPPED [  5%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_access_other_user_test_forbidden SKIPPED [  5%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_results_success SKIPPED [  5%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_metrics_success SKIPPED [  5%]
tests/test_agents_integration.py::TestAgentsIntegration::test_agent_complete_lifecycle SKIPPED [  6%]
tests/test_agents_integration.py::TestAgentsIntegration::test_agents_list_and_filter SKIPPED [  6%]
tests/test_agents_integration.py::TestAgentsIntegration::test_agent_templates_workflow SKIPPED [  6%]
tests/test_agents_integration.py::TestAgentsIntegration::test_bulk_agent_operations SKIPPED [  6%]
tests/test_agents_integration.py::TestAgentsIntegration::test_agent_testing_functionality SKIPPED [  6%]
tests/test_agents_integration.py::TestAgentsIntegration::test_agent_health_monitoring SKIPPED [  6%]
tests/test_agents_integration.py::TestAgentsIntegration::test_agent_error_scenarios SKIPPED [  6%]
tests/test_agents_integration.py::TestAgentsIntegration::test_agent_data_validation SKIPPED [  6%]
tests/test_agents_integration.py::TestAgentsIntegration::test_concurrent_agent_operations SKIPPED [  7%]
tests/test_agents_integration.py::TestAgentsIntegration::test_agent_complex_configuration SKIPPED [  7%]
tests/test_agents_unit.py::TestAgentsUnit::test_create_agent_requires_auth SKIPPED [  7%]
tests/test_agents_unit.py::TestAgentsUnit::test_list_agents_requires_auth SKIPPED [  7%]
tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_templates_requires_auth SKIPPED [  7%]
tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_requires_auth SKIPPED [  7%]
tests/test_agents_unit.py::TestAgentsUnit::test_update_agent_requires_auth SKIPPED [  7%]
tests/test_agents_unit.py::TestAgentsUnit::test_delete_agent_requires_auth SKIPPED [  7%]
tests/test_agents_unit.py::TestAgentsUnit::test_test_agent_requires_auth SKIPPED [  8%]
tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_health_requires_auth SKIPPED [  8%]
tests/test_agents_unit.py::TestAgentsUnit::test_bulk_create_agents_requires_auth SKIPPED [  8%]
tests/test_agents_unit.py::TestAgentsUnit::test_bulk_delete_agents_requires_auth SKIPPED [  8%]
tests/test_agents_unit.py::TestAgentsUnit::test_create_agent_success SKIPPED [  8%]
tests/test_agents_unit.py::TestAgentsUnit::test_create_agent_invalid_data SKIPPED [  8%]
tests/test_agents_unit.py::TestAgentsUnit::test_list_agents_success SKIPPED [  8%]
tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_templates_success SKIPPED [  9%]
tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_success SKIPPED [  9%]
tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_not_found SKIPPED [  9%]
tests/test_agents_unit.py::TestAgentsUnit::test_update_agent_success SKIPPED [  9%]
tests/test_agents_unit.py::TestAgentsUnit::test_delete_agent_success SKIPPED [  9%]
tests/test_agents_unit.py::TestAgentsUnit::test_test_agent_success SKIPPED [  9%]
tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_health_success SKIPPED [  9%]
tests/test_agents_unit.py::TestAgentsUnit::test_bulk_create_agents_success SKIPPED [  9%]
tests/test_agents_unit.py::TestAgentsUnit::test_bulk_delete_agents_success SKIPPED [ 10%]
tests/test_agents_unit.py::TestAgentsUnit::test_agent_service_error_handling SKIPPED [ 10%]
tests/test_agents_unit.py::TestAgentsUnit::test_list_agents_with_filters SKIPPED [ 10%]
tests/test_agents_unit.py::TestAgentsUnit::test_agent_test_with_invalid_input SKIPPED [ 10%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_dashboard_workflow SKIPPED [ 10%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_conversation_analytics_workflow SKIPPED [ 10%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_usage_metrics_workflow SKIPPED [ 10%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_performance_metrics_workflow SKIPPED [ 10%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_document_analytics_workflow SKIPPED [ 11%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_system_analytics_workflow SKIPPED [ 11%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_user_analytics_workflow SKIPPED [ 11%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_export_workflow SKIPPED [ 11%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_health_check SKIPPED [ 11%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_metrics_summary_workflow SKIPPED [ 11%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_toolserver_analytics_workflow SKIPPED [ 11%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_concurrent_analytics_requests SKIPPED [ 11%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_data_consistency SKIPPED [ 12%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_error_handling SKIPPED [ 12%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_pagination_and_filtering SKIPPED [ 12%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_response_format_validation SKIPPED [ 12%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_conversation_stats_requires_auth SKIPPED [ 12%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_usage_metrics_requires_auth SKIPPED [ 12%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_performance_metrics_requires_auth SKIPPED [ 12%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_document_analytics_requires_auth SKIPPED [ 13%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_system_analytics_requires_auth SKIPPED [ 13%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_dashboard_requires_auth SKIPPED [ 13%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_toolserver_analytics_requires_auth SKIPPED [ 13%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_user_analytics_requires_auth SKIPPED [ 13%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_export_analytics_requires_auth SKIPPED [ 13%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_health_requires_auth SKIPPED [ 13%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_metrics_summary_requires_auth SKIPPED [ 13%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_conversation_stats_success SKIPPED [ 14%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_usage_metrics_success SKIPPED [ 14%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_performance_metrics_success SKIPPED [ 14%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_document_analytics_success SKIPPED [ 14%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_system_analytics_success SKIPPED [ 14%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_dashboard_success SKIPPED [ 14%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_user_analytics_success SKIPPED [ 14%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_export_analytics_success SKIPPED [ 14%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_analytics_service_error_handling SKIPPED [ 15%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_invalid_user_id_format SKIPPED [ 15%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_metrics_summary_success SKIPPED [ 15%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_health_success SKIPPED [ 15%]
tests/test_api_validation.py::TestWorkflowMapping::test_valid_workflow_types PASSED [ 15%]
tests/test_api_validation.py::TestWorkflowMapping::test_case_insensitive_workflow_types PASSED [ 15%]
tests/test_api_validation.py::TestWorkflowMapping::test_none_workflow_type PASSED [ 15%]
tests/test_api_validation.py::TestWorkflowMapping::test_empty_workflow_type PASSED [ 15%]
tests/test_api_validation.py::TestWorkflowMapping::test_invalid_workflow_type PASSED [ 16%]
tests/test_api_validation.py::TestUUIDValidation::test_valid_uuid PASSED [ 16%]
tests/test_api_validation.py::TestUUIDValidation::test_invalid_uuid_format PASSED [ 16%]
tests/test_api_validation.py::TestUUIDValidation::test_empty_uuid PASSED [ 16%]
tests/test_api_validation.py::TestUUIDValidation::test_none_uuid PASSED  [ 16%]
tests/test_api_validation.py::TestUUIDValidation::test_malformed_uuid PASSED [ 16%]
tests/test_auth_direct.py::TestAuthServiceDirect::test_auth_service_create_user SKIPPED [ 16%]
tests/test_auth_direct.py::TestAuthServiceDirect::test_auth_service_authenticate SKIPPED [ 17%]
tests/test_auth_integration.py::TestAuthIntegration::test_complete_user_registration_and_login_flow SKIPPED [ 17%]
tests/test_auth_integration.py::TestAuthIntegration::test_login_with_email_workflow SKIPPED [ 17%]
tests/test_auth_integration.py::TestAuthIntegration::test_token_refresh_workflow SKIPPED [ 17%]
tests/test_auth_integration.py::TestAuthIntegration::test_profile_update_workflow SKIPPED [ 17%]
tests/test_auth_integration.py::TestAuthIntegration::test_password_change_workflow SKIPPED [ 17%]
tests/test_auth_integration.py::TestAuthIntegration::test_api_key_workflow SKIPPED [ 17%]
tests/test_auth_integration.py::TestAuthIntegration::test_logout_workflow SKIPPED [ 17%]
tests/test_auth_integration.py::TestAuthIntegration::test_account_deactivation_workflow SKIPPED [ 18%]
tests/test_auth_integration.py::TestAuthIntegration::test_multiple_users_isolation SKIPPED [ 18%]
tests/test_auth_integration.py::TestAuthIntegration::test_password_reset_workflow SKIPPED [ 18%]
tests/test_auth_integration.py::TestAuthDatabaseIntegration::test_user_persistence SKIPPED [ 18%]
tests/test_auth_integration.py::TestAuthDatabaseIntegration::test_user_uniqueness_constraints SKIPPED [ 18%]
tests/test_auth_integration.py::TestAuthDatabaseIntegration::test_transaction_rollback_on_error SKIPPED [ 18%]
tests/test_auth_security_comprehensive.py::TestEnhancedPasswordSecurity::test_password_entropy_calculation FAILED [ 18%]
tests/test_auth_security_comprehensive.py::TestEnhancedPasswordSecurity::test_common_password_detection PASSED [ 18%]
tests/test_auth_security_comprehensive.py::TestEnhancedPasswordSecurity::test_keyboard_pattern_detection PASSED [ 19%]
tests/test_auth_security_comprehensive.py::TestEnhancedPasswordSecurity::test_excessive_repetition_detection PASSED [ 19%]
tests/test_auth_security_comprehensive.py::TestEnhancedPasswordSecurity::test_personal_info_in_password FAILED [ 19%]
tests/test_auth_security_comprehensive.py::TestEnhancedPasswordSecurity::test_advanced_password_validation PASSED [ 19%]
tests/test_auth_security_comprehensive.py::TestEnhancedEmailValidation::test_disposable_email_detection PASSED [ 19%]
tests/test_auth_security_comprehensive.py::TestEnhancedEmailValidation::test_email_format_security PASSED [ 19%]
tests/test_auth_security_comprehensive.py::TestEnhancedUsernameValidation::test_prohibited_usernames PASSED [ 19%]
tests/test_auth_security_comprehensive.py::TestEnhancedUsernameValidation::test_username_pattern_security PASSED [ 19%]
tests/test_auth_security_comprehensive.py::TestSecureAPIKeyManagement::test_secure_api_key_generation PASSED [ 20%]
tests/test_auth_security_comprehensive.py::TestSecureAPIKeyManagement::test_api_key_uniqueness PASSED [ 20%]
tests/test_auth_security_comprehensive.py::TestSecureAPIKeyManagement::test_api_key_timing_attack_resistance PASSED [ 20%]
tests/test_auth_security_comprehensive.py::TestAuthServiceSecurity::test_user_creation_security_validation SKIPPED [ 20%]
tests/test_auth_security_comprehensive.py::TestAuthServiceSecurity::test_password_change_security SKIPPED [ 20%]
tests/test_auth_security_comprehensive.py::TestAuthServiceSecurity::test_secure_api_key_creation SKIPPED [ 20%]
tests/test_auth_security_comprehensive.py::TestAuthServiceSecurity::test_authentication_security_logging SKIPPED [ 20%]
tests/test_auth_security_comprehensive.py::TestTokenSecurityIntegration::test_token_creation_security_claims SKIPPED [ 21%]
tests/test_auth_security_comprehensive.py::TestTokenSecurityIntegration::test_token_blacklisting SKIPPED [ 21%]
tests/test_auth_security_comprehensive.py::TestRateLimitingIntegration::test_login_rate_limiting SKIPPED [ 21%]
tests/test_auth_security_comprehensive.py::TestRateLimitingIntegration::test_registration_rate_limiting SKIPPED [ 21%]
tests/test_auth_security_comprehensive.py::TestSecurityCompliance::test_password_storage_security PASSED [ 21%]
tests/test_auth_security_comprehensive.py::TestSecurityCompliance::test_sensitive_data_sanitization PASSED [ 21%]
tests/test_auth_security_comprehensive.py::TestSecurityCompliance::test_timing_attack_resistance PASSED [ 21%]
tests/test_auth_security_comprehensive.py::TestSecurityPerformance::test_password_hashing_performance PASSED [ 21%]
tests/test_auth_security_comprehensive.py::TestSecurityPerformance::test_api_key_verification_performance PASSED [ 22%]
tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_complete_secure_registration_flow SKIPPED [ 22%]
tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_secure_login_with_monitoring SKIPPED [ 22%]
tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_secure_api_key_management SKIPPED [ 22%]
tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_secure_password_change_flow SKIPPED [ 22%]
tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_token_security_features SKIPPED [ 22%]
tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_security_monitoring_integration SKIPPED [ 22%]
tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_password_reset_security_flow SKIPPED [ 22%]
tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_comprehensive_security_validation SKIPPED [ 23%]
tests/test_auth_security_integration.py::TestSecurityPerformanceIntegration::test_auth_endpoint_performance SKIPPED [ 23%]
tests/test_auth_security_integration.py::TestSecurityPerformanceIntegration::test_multiple_concurrent_requests SKIPPED [ 23%]
tests/test_auth_unit.py::TestAuthUnitTests::test_user_registration SKIPPED [ 23%]
tests/test_auth_unit.py::TestAuthUnitTests::test_user_registration_duplicate_username SKIPPED [ 23%]
tests/test_auth_unit.py::TestAuthUnitTests::test_user_registration_duplicate_email SKIPPED [ 23%]
tests/test_auth_unit.py::TestAuthUnitTests::test_user_registration_invalid_data SKIPPED [ 23%]
tests/test_auth_unit.py::TestAuthUnitTests::test_user_login_success SKIPPED [ 23%]
tests/test_auth_unit.py::TestAuthUnitTests::test_user_login_with_email SKIPPED [ 24%]
tests/test_auth_unit.py::TestAuthUnitTests::test_user_login_invalid_credentials SKIPPED [ 24%]
tests/test_auth_unit.py::TestAuthUnitTests::test_user_login_nonexistent_user SKIPPED [ 24%]
tests/test_auth_unit.py::TestAuthUnitTests::test_get_current_user SKIPPED [ 24%]
tests/test_auth_unit.py::TestAuthUnitTests::test_get_current_user_without_auth SKIPPED [ 24%]
tests/test_auth_unit.py::TestAuthUnitTests::test_get_current_user_invalid_token SKIPPED [ 24%]
tests/test_auth_unit.py::TestAuthUnitTests::test_token_refresh SKIPPED   [ 24%]
tests/test_auth_unit.py::TestAuthUnitTests::test_token_refresh_invalid_token SKIPPED [ 25%]
tests/test_auth_unit.py::TestAuthUnitTests::test_update_profile SKIPPED  [ 25%]
tests/test_auth_unit.py::TestAuthUnitTests::test_update_profile_without_auth SKIPPED [ 25%]
tests/test_auth_unit.py::TestAuthUnitTests::test_change_password SKIPPED [ 25%]
tests/test_auth_unit.py::TestAuthUnitTests::test_change_password_wrong_current SKIPPED [ 25%]
tests/test_auth_unit.py::TestAuthUnitTests::test_logout SKIPPED (Dat...) [ 25%]
tests/test_auth_unit.py::TestAuthServiceUnit::test_create_user SKIPPED   [ 25%]
tests/test_auth_unit.py::TestAuthServiceUnit::test_authenticate_user SKIPPED [ 25%]
tests/test_auth_unit.py::TestAuthServiceUnit::test_authenticate_user_wrong_password SKIPPED [ 26%]
tests/test_auth_unit.py::TestAuthServiceUnit::test_authenticate_user_nonexistent SKIPPED [ 26%]
tests/test_auth_unit.py::TestAuthServiceUnit::test_create_tokens SKIPPED [ 26%]
tests/test_cli.py::TestAPIClient::test_api_client_init_default_values PASSED [ 26%]
tests/test_cli.py::TestAPIClient::test_api_client_init_custom_values PASSED [ 26%]
tests/test_cli.py::TestAPIClient::test_api_client_close PASSED           [ 26%]
tests/test_cli.py::TestAPIClient::test_get_headers_without_token PASSED  [ 26%]
tests/test_cli.py::TestAPIClient::test_get_headers_with_token PASSED     [ 26%]
tests/test_cli.py::TestAPIClient::test_request_success PASSED            [ 27%]
tests/test_cli.py::TestAPIClient::test_request_no_content_response PASSED [ 27%]
tests/test_cli.py::TestAPIClient::test_request_401_error PASSED          [ 27%]
tests/test_cli.py::TestAPIClient::test_request_403_error PASSED          [ 27%]
tests/test_cli.py::TestAPIClient::test_request_other_http_error PASSED   [ 27%]
tests/test_cli.py::TestAPIClient::test_request_connection_error PASSED   [ 27%]
tests/test_cli.py::TestGetAPIClient::test_get_api_client_from_environment PASSED [ 27%]
tests/test_cli.py::TestGetAPIClient::test_get_api_client_defaults PASSED [ 27%]
tests/test_cli.py::TestCLICommands::test_cli_app_help PASSED             [ 28%]
tests/test_cli.py::TestCLICommands::test_prompts_help PASSED             [ 28%]
tests/test_cli.py::TestCLICommands::test_list_prompts_command PASSED     [ 28%]
tests/test_cli.py::TestCLICommands::test_create_prompt_command PASSED    [ 28%]
tests/test_cli.py::TestCLICommands::test_delete_prompt_command PASSED    [ 28%]
tests/test_cli.py::TestCLICommands::test_health_command FAILED           [ 28%]
tests/test_cli.py::TestCLICommands::test_db_init PASSED                  [ 28%]
tests/test_cli.py::TestCLICommands::test_db_check_command PASSED         [ 28%]
tests/test_cli.py::TestHealthCheck::test_health_check_success FAILED     [ 29%]
tests/test_cli.py::TestHealthCheck::test_health_check_failure FAILED     [ 29%]
tests/test_cli.py::TestDatabaseCommands::test_db_init_success FAILED     [ 29%]
tests/test_cli.py::TestDatabaseCommands::test_db_init_connection_failure FAILED [ 29%]
tests/test_cli.py::TestDatabaseCommands::test_db_init_init_failure FAILED [ 29%]
tests/test_cli.py::TestInteractivePromptCreation::test_interactive_prompt_creation FAILED [ 29%]
tests/test_cli.py::TestOpenAPIGeneration::test_generate_openapi_spec_available PASSED [ 29%]
tests/test_cli.py::TestOpenAPIGeneration::test_export_openapi_json PASSED [ 30%]
tests/test_cli.py::TestOpenAPIGeneration::test_export_openapi_yaml PASSED [ 30%]
tests/test_cli.py::TestCLIIntegration::test_full_prompt_lifecycle FAILED [ 30%]
tests/test_cli.py::TestCLIIntegration::test_cli_error_handling PASSED    [ 30%]
tests/test_cli.py::TestCLIIntegration::test_cli_with_authentication PASSED [ 30%]
tests/test_cli.py::TestCLIIntegration::test_cli_version_information PASSED [ 30%]
tests/test_cli.py::TestCLIErrorScenarios::test_missing_required_options PASSED [ 30%]
tests/test_cli.py::TestCLIErrorScenarios::test_invalid_option_values PASSED [ 30%]
tests/test_cli.py::TestCLIErrorScenarios::test_api_unavailable_scenarios FAILED [ 31%]
tests/test_contract_testing.py::TestContractTesting::test_api_response_schema_validation SKIPPED [ 31%]
tests/test_contract_testing.py::TestContractTesting::test_backward_compatibility SKIPPED [ 31%]
tests/test_contract_testing.py::TestContractTesting::test_error_response_consistency SKIPPED [ 31%]
tests/test_contract_testing.py::TestContractTesting::test_openapi_specification_compliance SKIPPED [ 31%]
tests/test_contract_testing.py::TestContractTesting::test_frontend_backend_contract_validation SKIPPED [ 31%]
tests/test_contract_testing.py::TestContractTesting::test_cors_headers_and_security_compliance SKIPPED [ 31%]
tests/test_contract_testing.py::TestContractTesting::test_data_consistency_across_services SKIPPED [ 31%]
tests/test_crypto_utils.py::TestSecretManager::test_init_with_key PASSED [ 32%]
tests/test_crypto_utils.py::TestSecretManager::test_init_with_invalid_key PASSED [ 32%]
tests/test_crypto_utils.py::TestSecretManager::test_init_without_key_uses_environment PASSED [ 32%]
tests/test_crypto_utils.py::TestSecretManager::test_init_without_key_derives_from_password PASSED [ 32%]
tests/test_crypto_utils.py::TestSecretManager::test_encrypt_decrypt_string PASSED [ 32%]
tests/test_crypto_utils.py::TestSecretManager::test_encrypt_empty_string PASSED [ 32%]
tests/test_crypto_utils.py::TestSecretManager::test_encrypt_unicode_string PASSED [ 32%]
tests/test_crypto_utils.py::TestSecretManager::test_decrypt_invalid_data_raises_error PASSED [ 32%]
tests/test_crypto_utils.py::TestSecretManager::test_encrypt_with_different_managers_incompatible FAILED [ 33%]
tests/test_crypto_utils.py::TestSecretManager::test_encrypt_dict_with_sensitive_fields PASSED [ 33%]
tests/test_crypto_utils.py::TestSecretManager::test_decrypt_dict_with_encrypted_fields PASSED [ 33%]
tests/test_crypto_utils.py::TestSecretManager::test_encrypt_decrypt_dict_preserves_non_string_values PASSED [ 33%]
tests/test_crypto_utils.py::TestSecretManager::test_encrypt_dict_case_insensitive_field_detection PASSED [ 33%]
tests/test_crypto_utils.py::TestSecretManager::test_decrypt_dict_with_missing_encryption_markers PASSED [ 33%]
tests/test_crypto_utils.py::TestGlobalSecretManager::test_get_secret_manager_singleton PASSED [ 33%]
tests/test_crypto_utils.py::TestGlobalSecretManager::test_encrypt_secret_function PASSED [ 34%]
tests/test_crypto_utils.py::TestGlobalSecretManager::test_decrypt_secret_function PASSED [ 34%]
tests/test_crypto_utils.py::TestCryptoError::test_crypto_error_inheritance PASSED [ 34%]
tests/test_crypto_utils.py::TestSecurityBestPractices::test_encrypted_data_is_not_deterministic PASSED [ 34%]
tests/test_crypto_utils.py::TestSecurityBestPractices::test_key_derivation_with_different_passwords PASSED [ 34%]
tests/test_crypto_utils.py::TestSecurityBestPractices::test_key_derivation_with_different_salts PASSED [ 34%]
tests/test_crypto_utils.py::TestSecurityBestPractices::test_warning_logged_when_using_derived_key PASSED [ 34%]
tests/test_crypto_utils.py::TestCryptoIntegration::test_full_encryption_decryption_workflow PASSED [ 34%]
tests/test_crypto_utils.py::TestCryptoIntegration::test_cross_manager_incompatibility_security PASSED [ 35%]
tests/test_crypto_utils.py::TestCryptoIntegration::test_large_data_encryption PASSED [ 35%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_export_data_workflow SKIPPED [ 35%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_backup_workflow SKIPPED [ 35%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_restore_workflow SKIPPED [ 35%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_storage_stats_workflow SKIPPED [ 35%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_bulk_delete_documents_workflow SKIPPED [ 35%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_bulk_delete_conversations_workflow SKIPPED [ 35%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_bulk_delete_prompts_workflow SKIPPED [ 36%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_data_management_permission_workflow SKIPPED [ 36%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_cross_api_data_consistency SKIPPED [ 36%]
tests/test_data_management_unit.py::TestDataManagementUnit::test_export_data_endpoint_exists SKIPPED [ 36%]
tests/test_data_management_unit.py::TestDataManagementUnit::test_create_backup_endpoint_exists SKIPPED [ 36%]
tests/test_data_management_unit.py::TestDataManagementUnit::test_list_backups_endpoint_exists SKIPPED [ 36%]
tests/test_data_management_unit.py::TestDataManagementUnit::test_restore_data_endpoint_exists SKIPPED [ 36%]
tests/test_data_management_unit.py::TestDataManagementUnit::test_get_storage_stats_endpoint_exists SKIPPED [ 36%]
tests/test_data_management_unit.py::TestDataManagementUnit::test_bulk_delete_documents_endpoint_exists SKIPPED [ 37%]
tests/test_data_management_unit.py::TestDataManagementUnit::test_bulk_delete_conversations_endpoint_exists SKIPPED [ 37%]
tests/test_data_management_unit.py::TestDataManagementUnit::test_bulk_delete_prompts_endpoint_exists SKIPPED [ 37%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_user_model_has_required_constraints PASSED [ 37%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_conversation_model_has_required_constraints PASSED [ 37%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_message_model_has_required_constraints PASSED [ 37%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_user_relationships_are_properly_defined PASSED [ 37%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_foreign_key_references_are_valid PASSED [ 38%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_model_fields_match_schema_requirements PASSED [ 38%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_model_indexes_are_properly_defined PASSED [ 38%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_model_enum_fields_are_properly_configured PASSED [ 38%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_json_fields_are_properly_defined PASSED [ 38%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_document_model_has_required_constraints PASSED [ 38%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_document_chunk_model_has_required_constraints PASSED [ 38%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_profile_model_has_required_constraints PASSED [ 38%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_prompt_model_has_required_constraints PASSED [ 39%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_provider_model_has_required_constraints PASSED [ 39%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_model_def_has_required_constraints PASSED [ 39%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_embedding_space_has_required_constraints PASSED [ 39%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_analytics_models_have_required_constraints PASSED [ 39%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_toolserver_models_have_required_constraints PASSED [ 39%]
tests/test_database_testing.py::TestDatabaseTesting::test_migration_script_validation SKIPPED [ 39%]
tests/test_database_testing.py::TestDatabaseTesting::test_connection_pooling_behavior SKIPPED [ 39%]
tests/test_database_testing.py::TestDatabaseTesting::test_transaction_rollback_testing SKIPPED [ 40%]
tests/test_database_testing.py::TestDatabaseTesting::test_index_performance_validation SKIPPED [ 40%]
tests/test_database_testing.py::TestDatabaseTesting::test_foreign_key_constraint_enforcement SKIPPED [ 40%]
tests/test_database_testing.py::TestDatabaseTesting::test_data_integrity_and_consistency SKIPPED [ 40%]
tests/test_database_testing.py::TestDatabaseTesting::test_bulk_operation_performance SKIPPED [ 40%]
tests/test_database_testing.py::TestDatabaseTesting::test_connection_security_and_encryption SKIPPED [ 40%]
tests/test_database_testing.py::TestDatabaseTesting::test_database_backup_and_recovery_readiness SKIPPED [ 40%]
tests/test_database_testing.py::TestDatabaseTesting::test_query_performance_optimization SKIPPED [ 40%]
tests/test_database_testing.py::TestDatabaseTesting::test_database_api_integration_consistency SKIPPED [ 41%]
tests/test_documents_integration.py::TestDocumentsIntegration::test_document_upload_workflow SKIPPED [ 41%]
tests/test_documents_integration.py::TestDocumentsIntegration::test_document_list_and_search_workflow SKIPPED [ 41%]
tests/test_documents_integration.py::TestDocumentsIntegration::test_document_crud_workflow SKIPPED [ 41%]
tests/test_documents_integration.py::TestDocumentsIntegration::test_document_chunks_workflow SKIPPED [ 41%]
tests/test_documents_integration.py::TestDocumentsIntegration::test_document_processing_workflow SKIPPED [ 41%]
tests/test_documents_integration.py::TestDocumentsIntegration::test_document_stats_workflow SKIPPED [ 41%]
tests/test_documents_integration.py::TestDocumentsIntegration::test_document_download_workflow SKIPPED [ 42%]
tests/test_documents_integration.py::TestDocumentsIntegration::test_document_permission_workflow SKIPPED [ 42%]
tests/test_documents_unit.py::TestDocumentsUnit::test_upload_document_endpoint_exists SKIPPED [ 42%]
tests/test_documents_unit.py::TestDocumentsUnit::test_list_documents_endpoint_exists SKIPPED [ 42%]
tests/test_documents_unit.py::TestDocumentsUnit::test_search_documents_endpoint_exists SKIPPED [ 42%]
tests/test_documents_unit.py::TestDocumentsUnit::test_get_document_endpoint_exists SKIPPED [ 42%]
tests/test_documents_unit.py::TestDocumentsUnit::test_delete_document_endpoint_exists SKIPPED [ 42%]
tests/test_documents_unit.py::TestDocumentsUnit::test_update_document_endpoint_exists SKIPPED [ 42%]
tests/test_documents_unit.py::TestDocumentsUnit::test_get_document_chunks_endpoint_exists SKIPPED [ 43%]
tests/test_documents_unit.py::TestDocumentsUnit::test_process_document_endpoint_exists SKIPPED [ 43%]
tests/test_documents_unit.py::TestDocumentsUnit::test_get_document_stats_endpoint_exists SKIPPED [ 43%]
tests/test_documents_unit.py::TestDocumentsUnit::test_download_document_endpoint_exists SKIPPED [ 43%]
tests/test_events_integration.py::TestEventsIntegration::test_events_stream_workflow SKIPPED [ 43%]
tests/test_events_integration.py::TestEventsIntegration::test_events_stats_real_service SKIPPED [ 43%]
tests/test_events_integration.py::TestEventsIntegration::test_test_event_end_to_end SKIPPED [ 43%]
tests/test_events_integration.py::TestEventsIntegration::test_broadcast_test_end_to_end SKIPPED [ 43%]
tests/test_events_integration.py::TestEventsIntegration::test_multiple_sse_connections SKIPPED [ 44%]
tests/test_events_integration.py::TestEventsIntegration::test_events_workflow_with_database SKIPPED [ 44%]
tests/test_events_integration.py::TestEventsIntegration::test_event_validation_integration SKIPPED [ 44%]
tests/test_events_integration.py::TestEventsIntegration::test_event_data_serialization SKIPPED [ 44%]
tests/test_events_integration.py::TestEventsIntegration::test_concurrent_event_operations SKIPPED [ 44%]
tests/test_events_integration.py::TestEventsIntegration::test_sse_connection_cleanup SKIPPED [ 44%]
tests/test_events_unit.py::TestEventsUnit::test_events_stream_requires_auth SKIPPED [ 44%]
tests/test_events_unit.py::TestEventsUnit::test_admin_stream_requires_auth SKIPPED [ 44%]
tests/test_events_unit.py::TestEventsUnit::test_events_stats_requires_auth SKIPPED [ 45%]
tests/test_events_unit.py::TestEventsUnit::test_test_event_requires_auth SKIPPED [ 45%]
tests/test_events_unit.py::TestEventsUnit::test_broadcast_test_requires_auth SKIPPED [ 45%]
tests/test_events_unit.py::TestEventsUnit::test_events_stats_success SKIPPED [ 45%]
tests/test_events_unit.py::TestEventsUnit::test_test_event_success SKIPPED [ 45%]
tests/test_events_unit.py::TestEventsUnit::test_broadcast_test_success SKIPPED [ 45%]
tests/test_events_unit.py::TestEventsUnit::test_test_event_invalid_data SKIPPED [ 45%]
tests/test_events_unit.py::TestEventsUnit::test_broadcast_test_invalid_data SKIPPED [ 46%]
tests/test_events_unit.py::TestEventsUnit::test_events_stream_rate_limit SKIPPED [ 46%]
tests/test_events_unit.py::TestEventsUnit::test_events_stream_connection_limit SKIPPED [ 46%]
tests/test_events_unit.py::TestEventsUnit::test_events_stream_connection_not_found SKIPPED [ 46%]
tests/test_events_unit.py::TestEventsUnit::test_admin_stream_requires_admin SKIPPED [ 46%]
tests/test_events_unit.py::TestEventsUnit::test_events_stats_sse_service_error SKIPPED [ 46%]
tests/test_events_unit.py::TestEventsUnit::test_test_event_sse_service_error SKIPPED [ 46%]
tests/test_events_unit.py::TestEventsUnit::test_broadcast_test_sse_service_error SKIPPED [ 46%]
tests/test_health_integration.py::TestHealthIntegration::test_readiness_check_with_database SKIPPED [ 47%]
tests/test_health_integration.py::TestHealthIntegration::test_readiness_check_database_timeout SKIPPED [ 47%]
tests/test_health_integration.py::TestHealthIntegration::test_readiness_check_database_error SKIPPED [ 47%]
tests/test_health_integration.py::TestHealthIntegration::test_health_endpoints_response_consistency SKIPPED [ 47%]
tests/test_health_integration.py::TestHealthIntegration::test_readiness_check_performance SKIPPED [ 47%]
tests/test_health_integration.py::TestHealthIntegration::test_correlation_trace_nonexistent_id SKIPPED [ 47%]
tests/test_health_integration.py::TestHealthIntegration::test_metrics_endpoint_structure SKIPPED [ 47%]
tests/test_health_integration.py::TestHealthIntegration::test_multiple_readiness_checks_isolation SKIPPED [ 47%]
tests/test_health_integration.py::TestHealthIntegration::test_health_endpoints_concurrent_access SKIPPED [ 48%]
tests/test_health_unit.py::TestHealthUnit::test_health_check_endpoint SKIPPED [ 48%]
tests/test_health_unit.py::TestHealthUnit::test_liveness_check_endpoint SKIPPED [ 48%]
tests/test_health_unit.py::TestHealthUnit::test_health_and_liveness_different_status SKIPPED [ 48%]
tests/test_health_unit.py::TestHealthUnit::test_metrics_endpoint_without_monitoring SKIPPED [ 48%]
tests/test_health_unit.py::TestHealthUnit::test_correlation_trace_without_monitoring SKIPPED [ 48%]
tests/test_health_unit.py::TestHealthUnit::test_metrics_endpoint_with_monitoring_success SKIPPED [ 48%]
tests/test_health_unit.py::TestHealthUnit::test_metrics_endpoint_with_monitoring_error SKIPPED [ 48%]
tests/test_health_unit.py::TestHealthUnit::test_correlation_trace_with_monitoring_success SKIPPED [ 49%]
tests/test_health_unit.py::TestHealthUnit::test_correlation_trace_with_monitoring_error SKIPPED [ 49%]
tests/test_health_unit.py::TestHealthUnit::test_metrics_timestamp_format SKIPPED [ 49%]
tests/test_infrastructure.py::TestInfrastructureValidation::test_pytest_is_working PASSED [ 49%]
tests/test_infrastructure.py::TestInfrastructureValidation::test_unit_marker_works PASSED [ 49%]
tests/test_infrastructure.py::TestInfrastructureValidation::test_integration_marker_works PASSED [ 49%]
tests/test_infrastructure.py::TestInfrastructureValidation::test_test_data_fixture PASSED [ 49%]
tests/test_infrastructure.py::TestInfrastructureValidation::test_test_login_data_fixture PASSED [ 50%]
tests/test_infrastructure.py::TestInfrastructureValidation::test_async_test_support PASSED [ 50%]
tests/test_infrastructure.py::TestDatabaseFixtures::test_db_session_fixture SKIPPED [ 50%]
tests/test_infrastructure.py::TestDatabaseFixtures::test_app_fixture SKIPPED [ 50%]
tests/test_infrastructure.py::TestDatabaseFixtures::test_client_fixture SKIPPED [ 50%]
tests/test_integration_workflows.py::TestIntegrationWorkflows::test_document_to_chat_workflow SKIPPED [ 50%]
tests/test_integration_workflows.py::TestIntegrationWorkflows::test_user_agent_interaction_workflows SKIPPED [ 50%]
tests/test_integration_workflows.py::TestIntegrationWorkflows::test_analytics_across_multiple_services SKIPPED [ 50%]
tests/test_integration_workflows.py::TestIntegrationWorkflows::test_external_service_integration SKIPPED [ 51%]
tests/test_integration_workflows.py::TestIntegrationWorkflows::test_cache_service_integration SKIPPED [ 51%]
tests/test_integration_workflows.py::TestIntegrationWorkflows::test_error_propagation_and_recovery SKIPPED [ 51%]
tests/test_integration_workflows.py::TestIntegrationWorkflows::test_service_dependencies_and_graceful_degradation SKIPPED [ 51%]
tests/test_jobs_integration.py::TestJobsIntegration::test_job_complete_lifecycle SKIPPED [ 51%]
tests/test_jobs_integration.py::TestJobsIntegration::test_job_listing_and_filtering SKIPPED [ 51%]
tests/test_jobs_integration.py::TestJobsIntegration::test_job_cancellation_workflow SKIPPED [ 51%]
tests/test_jobs_integration.py::TestJobsIntegration::test_job_error_scenarios SKIPPED [ 51%]
tests/test_jobs_integration.py::TestJobsIntegration::test_job_validation_scenarios SKIPPED [ 52%]
tests/test_jobs_integration.py::TestJobsIntegration::test_job_stats_accuracy SKIPPED [ 52%]
tests/test_jobs_integration.py::TestJobsIntegration::test_job_cleanup_functionality SKIPPED [ 52%]
tests/test_jobs_integration.py::TestJobsIntegration::test_concurrent_job_operations SKIPPED [ 52%]
tests/test_jobs_integration.py::TestJobsIntegration::test_job_data_persistence SKIPPED [ 52%]
tests/test_jobs_unit.py::TestJobsUnit::test_create_job_requires_auth SKIPPED [ 52%]
tests/test_jobs_unit.py::TestJobsUnit::test_list_jobs_requires_auth SKIPPED [ 52%]
tests/test_jobs_unit.py::TestJobsUnit::test_get_job_requires_auth SKIPPED [ 52%]
tests/test_jobs_unit.py::TestJobsUnit::test_cancel_job_requires_auth SKIPPED [ 53%]
tests/test_jobs_unit.py::TestJobsUnit::test_get_job_stats_requires_auth SKIPPED [ 53%]
tests/test_jobs_unit.py::TestJobsUnit::test_cleanup_jobs_requires_auth SKIPPED [ 53%]
tests/test_jobs_unit.py::TestJobsUnit::test_create_job_success SKIPPED   [ 53%]
tests/test_jobs_unit.py::TestJobsUnit::test_create_job_invalid_function SKIPPED [ 53%]
tests/test_jobs_unit.py::TestJobsUnit::test_create_job_invalid_data SKIPPED [ 53%]
tests/test_jobs_unit.py::TestJobsUnit::test_list_jobs_success SKIPPED    [ 53%]
tests/test_jobs_unit.py::TestJobsUnit::test_list_jobs_with_filters SKIPPED [ 53%]
tests/test_jobs_unit.py::TestJobsUnit::test_get_job_success SKIPPED      [ 54%]
tests/test_jobs_unit.py::TestJobsUnit::test_get_job_not_found SKIPPED    [ 54%]
tests/test_jobs_unit.py::TestJobsUnit::test_get_job_invalid_id_format SKIPPED [ 54%]
tests/test_jobs_unit.py::TestJobsUnit::test_cancel_job_success SKIPPED   [ 54%]
tests/test_jobs_unit.py::TestJobsUnit::test_cancel_job_not_found SKIPPED [ 54%]
tests/test_jobs_unit.py::TestJobsUnit::test_cancel_job_invalid_id_format SKIPPED [ 54%]
tests/test_jobs_unit.py::TestJobsUnit::test_get_job_stats_success SKIPPED [ 54%]
tests/test_jobs_unit.py::TestJobsUnit::test_cleanup_jobs_success SKIPPED [ 55%]
tests/test_jobs_unit.py::TestJobsUnit::test_job_queue_error_handling SKIPPED [ 55%]
tests/test_jobs_unit.py::TestJobsUnit::test_list_jobs_pagination SKIPPED [ 55%]
tests/test_mcp_service.py::TestOAuthConfig::test_oauth_config_creation PASSED [ 55%]
tests/test_mcp_service.py::TestOAuthConfig::test_oauth_config_with_optional_fields PASSED [ 55%]
tests/test_mcp_service.py::TestRemoteMCPServer::test_remote_server_creation PASSED [ 55%]
tests/test_mcp_service.py::TestRemoteMCPServer::test_remote_server_with_oauth PASSED [ 55%]
tests/test_mcp_service.py::TestMCPToolService::test_service_initialization PASSED [ 55%]
tests/test_mcp_service.py::TestMCPToolService::test_get_client PASSED    [ 56%]
tests/test_mcp_service.py::TestMCPToolService::test_validate_server_config_valid PASSED [ 56%]
tests/test_mcp_service.py::TestMCPToolService::test_validate_server_config_empty_name PASSED [ 56%]
tests/test_mcp_service.py::TestMCPToolService::test_validate_server_config_invalid_transport PASSED [ 56%]
tests/test_mcp_service.py::TestMCPToolService::test_is_server_healthy PASSED [ 56%]
tests/test_mcp_service.py::TestMCPToolService::test_retry_with_backoff_success_first_try PASSED [ 56%]
tests/test_mcp_service.py::TestMCPToolService::test_retry_with_backoff_success_after_retries PASSED [ 56%]
tests/test_mcp_service.py::TestMCPToolService::test_retry_with_backoff_all_retries_fail PASSED [ 56%]
tests/test_mcp_service.py::TestMCPToolService::test_retry_with_backoff_circuit_breaker PASSED [ 57%]
tests/test_mcp_service.py::TestMCPToolService::test_add_server_success FAILED [ 57%]
tests/test_mcp_service.py::TestMCPToolService::test_add_server_disabled_service FAILED [ 57%]
tests/test_mcp_service.py::TestMCPToolService::test_add_server_validation_error FAILED [ 57%]
tests/test_mcp_service.py::TestMCPToolService::test_remove_server_success PASSED [ 57%]
tests/test_mcp_service.py::TestMCPToolService::test_remove_nonexistent_server PASSED [ 57%]
tests/test_mcp_service.py::TestMCPToolService::test_discover_tools_success PASSED [ 57%]
tests/test_mcp_service.py::TestMCPToolService::test_discover_tools_disabled_service PASSED [ 57%]
tests/test_mcp_service.py::TestMCPToolService::test_discover_tools_nonexistent_server PASSED [ 58%]
tests/test_mcp_service.py::TestMCPToolService::test_discover_tools_unhealthy_server PASSED [ 58%]
tests/test_mcp_service.py::TestMCPToolService::test_get_tools_all_servers PASSED [ 58%]
tests/test_mcp_service.py::TestMCPToolService::test_get_tools_specific_servers PASSED [ 58%]
tests/test_mcp_service.py::TestMCPToolService::test_get_tools_disabled_service PASSED [ 58%]
tests/test_mcp_service.py::TestMCPToolService::test_call_tool_success FAILED [ 58%]
tests/test_mcp_service.py::TestMCPToolService::test_call_tool_disabled_service FAILED [ 58%]
tests/test_mcp_service.py::TestMCPToolService::test_list_servers FAILED  [ 59%]
tests/test_mcp_service.py::TestMCPToolService::test_get_server_info FAILED [ 59%]
tests/test_mcp_service.py::TestMCPToolService::test_get_server_info_nonexistent FAILED [ 59%]
tests/test_mcp_service.py::TestMCPToolService::test_authenticate_oauth_not_implemented PASSED [ 59%]
tests/test_mcp_service.py::TestMCPToolService::test_convert_server_to_connection_http PASSED [ 59%]
tests/test_mcp_service.py::TestMCPServiceIntegration::test_server_lifecycle FAILED [ 59%]
tests/test_mcp_service.py::TestMCPServiceIntegration::test_multiple_servers_management FAILED [ 59%]
tests/test_mcp_service.py::TestMCPServiceIntegration::test_error_recovery_scenarios FAILED [ 59%]
tests/test_mcp_service.py::TestMCPServiceError::test_mcp_service_error_creation PASSED [ 60%]
tests/test_mcp_service.py::TestMCPServiceError::test_mcp_service_error_with_cause PASSED [ 60%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_security_headers_added FAILED [ 60%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_content_security_policy_header FAILED [ 60%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_x_frame_options_header FAILED [ 60%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_x_content_type_options_header FAILED [ 60%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_x_xss_protection_header FAILED [ 60%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_referrer_policy_header FAILED [ 60%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_permissions_policy_header FAILED [ 61%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_strict_transport_security_enabled FAILED [ 61%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_strict_transport_security_disabled FAILED [ 61%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_security_headers_on_different_response_types FAILED [ 61%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_security_headers_dont_override_existing FAILED [ 61%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_middleware_initialization PASSED [ 61%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_rate_limit_configuration PASSED [ 61%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_login_endpoint_rate_limiting FAILED [ 61%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_register_endpoint_rate_limiting FAILED [ 62%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_password_reset_endpoint_rate_limiting FAILED [ 62%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_non_auth_endpoint_not_rate_limited PASSED [ 62%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_rate_limit_allowed_request PASSED [ 62%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_client_ip_identification FAILED [ 62%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_rate_limit_with_user_agent_tracking FAILED [ 62%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_rate_limit_error_handling PASSED [ 62%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_different_auth_endpoints_have_different_limits PASSED [ 63%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_get_client_ip_x_forwarded_for PASSED [ 63%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_get_client_ip_x_real_ip PASSED [ 63%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_get_client_ip_fallback PASSED [ 63%]
tests/test_middleware.py::TestMiddlewareIntegration::test_both_middleware_applied FAILED [ 63%]
tests/test_middleware.py::TestMiddlewareIntegration::test_security_headers_on_rate_limited_response FAILED [ 63%]
tests/test_middleware.py::TestMiddlewareIntegration::test_non_auth_endpoints_only_security_headers FAILED [ 63%]
tests/test_middleware.py::TestMiddlewareIntegration::test_middleware_order_matters FAILED [ 63%]
tests/test_middleware.py::TestMiddlewareIntegration::test_middleware_performance FAILED [ 64%]
tests/test_middleware.py::TestMiddlewareEdgeCases::test_security_middleware_with_exception PASSED [ 64%]
tests/test_middleware.py::TestMiddlewareEdgeCases::test_empty_app_with_middleware FAILED [ 64%]
tests/test_middleware.py::TestMiddlewareEdgeCases::test_rate_limit_middleware_with_none_client PASSED [ 64%]
tests/test_model_registry_fixes.py::TestDefaultProviderLogic::test_set_default_provider_with_model_type SKIPPED [ 64%]
tests/test_model_registry_fixes.py::TestDefaultProviderLogic::test_set_default_provider_without_models_fails SKIPPED [ 64%]
tests/test_model_registry_fixes.py::TestDefaultProviderLogic::test_set_default_provider_nonexistent_fails SKIPPED [ 64%]
tests/test_model_registry_fixes.py::TestDefaultProviderLogic::test_get_default_provider_by_model_type SKIPPED [ 64%]
tests/test_model_registry_fixes.py::TestValidationImprovements::test_create_model_validates_provider_exists SKIPPED [ 65%]
tests/test_model_registry_fixes.py::TestValidationImprovements::test_create_model_validates_provider_active SKIPPED [ 65%]
tests/test_model_registry_fixes.py::TestValidationImprovements::test_create_embedding_space_validates_model_exists SKIPPED [ 65%]
tests/test_model_registry_fixes.py::TestValidationImprovements::test_create_embedding_space_validates_model_type SKIPPED [ 65%]
tests/test_model_registry_fixes.py::TestValidationImprovements::test_create_embedding_space_validates_model_active SKIPPED [ 65%]
tests/test_model_registry_fixes.py::TestValidationImprovements::test_create_embedding_space_validates_dimensions SKIPPED [ 65%]
tests/test_model_registry_fixes.py::TestBusinessLogicImprovements::test_set_default_provider_sets_model_default SKIPPED [ 65%]
tests/test_model_registry_fixes.py::TestBusinessLogicImprovements::test_multiple_providers_different_model_types SKIPPED [ 65%]
tests/test_model_registry_fixes.py::TestTransactionManagement::test_create_model_transaction_rollback_on_error SKIPPED [ 66%]
tests/test_model_registry_validation.py::TestModelValidation::test_validate_model_consistency_embedding_without_dimensions PASSED [ 66%]
tests/test_model_registry_validation.py::TestModelValidation::test_validate_model_consistency_llm_with_dimensions PASSED [ 66%]
tests/test_model_registry_validation.py::TestModelValidation::test_validate_model_consistency_negative_max_tokens PASSED [ 66%]
tests/test_model_registry_validation.py::TestModelValidation::test_validate_model_consistency_batch_settings_conflict PASSED [ 66%]
tests/test_model_registry_validation.py::TestModelValidation::test_validate_model_consistency_valid_embedding_model PASSED [ 66%]
tests/test_model_registry_validation.py::TestModelValidation::test_validate_model_consistency_valid_llm_model PASSED [ 66%]
tests/test_model_registry_validation.py::TestValidationErrorMessages::test_validation_error_contains_helpful_context PASSED [ 67%]
tests/test_model_registry_validation.py::TestValidationErrorMessages::test_validation_error_is_exception PASSED [ 67%]
tests/test_model_registry_validation.py::TestBusinessLogicValidation::test_dimension_mismatch_error_message PASSED [ 67%]
tests/test_model_registry_validation.py::TestBusinessLogicValidation::test_provider_model_type_mismatch_error PASSED [ 67%]
tests/test_performance.py::TestPerformance::test_authentication_endpoint_performance SKIPPED [ 67%]
tests/test_performance.py::TestPerformance::test_chat_message_processing_benchmarks SKIPPED [ 67%]
tests/test_performance.py::TestPerformance::test_document_upload_performance_validation SKIPPED [ 67%]
tests/test_performance.py::TestPerformance::test_concurrent_request_handling SKIPPED [ 67%]
tests/test_performance.py::TestPerformance::test_memory_usage_and_leak_detection SKIPPED [ 68%]
tests/test_performance.py::TestPerformance::test_database_query_optimization SKIPPED [ 68%]
tests/test_performance.py::TestPerformance::test_sustained_load_performance SKIPPED [ 68%]
tests/test_performance.py::TestPerformance::test_response_time_consistency SKIPPED [ 68%]
tests/test_plugins.py::TestBasePlugin::test_base_plugin_initialization FAILED [ 68%]
tests/test_plugins.py::TestBasePlugin::test_base_plugin_default_config FAILED [ 68%]
tests/test_plugins.py::TestBasePlugin::test_base_plugin_get_configuration_schema FAILED [ 68%]
tests/test_plugins.py::TestBasePlugin::test_validate_configuration_no_schema FAILED [ 68%]
tests/test_plugins.py::TestBasePlugin::test_validate_configuration_with_schema FAILED [ 69%]
tests/test_plugins.py::TestBasePlugin::test_validate_configuration_type_checking FAILED [ 69%]
tests/test_plugins.py::TestBasePlugin::test_validate_configuration_error_handling FAILED [ 69%]
tests/test_plugins.py::TestToolPlugin::test_tool_plugin_inheritance FAILED [ 69%]
tests/test_plugins.py::TestToolPlugin::test_get_tools_abstract_method PASSED [ 69%]
tests/test_plugins.py::TestToolPlugin::test_get_tools_implementation FAILED [ 69%]
tests/test_plugins.py::TestWorkflowPlugin::test_workflow_plugin_inheritance FAILED [ 69%]
tests/test_plugins.py::TestWorkflowPlugin::test_execute_workflow_abstract_method PASSED [ 69%]
tests/test_plugins.py::TestPluginManager::test_plugin_manager_initialization FAILED [ 70%]
tests/test_plugins.py::TestPluginManager::test_get_plugin_directory_default FAILED [ 70%]
tests/test_plugins.py::TestPluginManager::test_get_plugin_directory_custom FAILED [ 70%]
tests/test_plugins.py::TestPluginManager::test_load_plugin_from_file_success FAILED [ 70%]
tests/test_plugins.py::TestPluginManager::test_load_plugin_from_file_missing_file FAILED [ 70%]
tests/test_plugins.py::TestPluginManager::test_load_plugin_from_file_syntax_error FAILED [ 70%]
tests/test_plugins.py::TestPluginManager::test_unload_plugin_success FAILED [ 70%]
tests/test_plugins.py::TestPluginManager::test_unload_plugin_not_found FAILED [ 71%]
tests/test_plugins.py::TestPluginManager::test_unload_plugin_cleanup_error FAILED [ 71%]
tests/test_plugins.py::TestPluginManager::test_list_plugins FAILED       [ 71%]
tests/test_plugins.py::TestPluginManager::test_list_plugins_by_type FAILED [ 71%]
tests/test_plugins.py::TestPluginManager::test_list_plugins_by_status FAILED [ 71%]
tests/test_plugins.py::TestPluginManager::test_get_plugin_info_found FAILED [ 71%]
tests/test_plugins.py::TestPluginManager::test_get_plugin_info_not_found FAILED [ 71%]
tests/test_plugins.py::TestPluginManager::test_get_tools_from_plugins FAILED [ 71%]
tests/test_plugins.py::TestPluginManager::test_get_tools_from_plugins_inactive_ignored FAILED [ 72%]
tests/test_plugins.py::TestPluginManager::test_health_check_all_plugins FAILED [ 72%]
tests/test_plugins.py::TestPluginManager::test_health_check_plugin_error FAILED [ 72%]
tests/test_plugins.py::TestPluginIntegration::test_plugin_lifecycle FAILED [ 72%]
tests/test_plugins.py::TestPluginIntegration::test_multiple_plugins_management FAILED [ 72%]
tests/test_plugins.py::TestPluginError::test_plugin_error_creation PASSED [ 72%]
tests/test_plugins.py::TestPluginError::test_plugin_error_with_cause PASSED [ 72%]
tests/test_postgresql_functionality.py::TestPostgreSQLDatabase::test_postgresql_session_exists SKIPPED [ 72%]
tests/test_postgresql_functionality.py::TestPostgreSQLDatabase::test_postgresql_basic_query SKIPPED [ 73%]
tests/test_postgresql_functionality.py::TestPostgreSQLDatabase::test_postgresql_engine_info SKIPPED [ 73%]
tests/test_postgresql_functionality.py::TestPostgreSQLDatabase::test_postgresql_transaction_rollback SKIPPED [ 73%]
tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_complete_lifecycle SKIPPED [ 73%]
tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_list_and_filter SKIPPED [ 73%]
tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_stats_and_providers SKIPPED [ 73%]
tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_error_scenarios SKIPPED [ 73%]
tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_data_validation SKIPPED [ 73%]
tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_concurrent_operations SKIPPED [ 74%]
tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_complex_data_handling SKIPPED [ 74%]
tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_testing_functionality SKIPPED [ 74%]
tests/test_profiles_unit.py::TestProfilesUnit::test_create_profile_requires_auth SKIPPED [ 74%]
tests/test_profiles_unit.py::TestProfilesUnit::test_list_profiles_requires_auth SKIPPED [ 74%]
tests/test_profiles_unit.py::TestProfilesUnit::test_get_profile_requires_auth SKIPPED [ 74%]
tests/test_profiles_unit.py::TestProfilesUnit::test_update_profile_requires_auth SKIPPED [ 74%]
tests/test_profiles_unit.py::TestProfilesUnit::test_delete_profile_requires_auth SKIPPED [ 75%]
tests/test_profiles_unit.py::TestProfilesUnit::test_test_profile_requires_auth SKIPPED [ 75%]
tests/test_profiles_unit.py::TestProfilesUnit::test_clone_profile_requires_auth SKIPPED [ 75%]
tests/test_profiles_unit.py::TestProfilesUnit::test_get_profile_stats_requires_auth SKIPPED [ 75%]
tests/test_profiles_unit.py::TestProfilesUnit::test_get_available_providers_requires_auth SKIPPED [ 75%]
tests/test_profiles_unit.py::TestProfilesUnit::test_create_profile_success SKIPPED [ 75%]
tests/test_profiles_unit.py::TestProfilesUnit::test_create_profile_invalid_data SKIPPED [ 75%]
tests/test_profiles_unit.py::TestProfilesUnit::test_create_profile_rate_limit SKIPPED [ 75%]
tests/test_profiles_unit.py::TestProfilesUnit::test_list_profiles_success SKIPPED [ 76%]
tests/test_profiles_unit.py::TestProfilesUnit::test_get_profile_success SKIPPED [ 76%]
tests/test_profiles_unit.py::TestProfilesUnit::test_get_profile_not_found SKIPPED [ 76%]
tests/test_profiles_unit.py::TestProfilesUnit::test_update_profile_success SKIPPED [ 76%]
tests/test_profiles_unit.py::TestProfilesUnit::test_delete_profile_success SKIPPED [ 76%]
tests/test_profiles_unit.py::TestProfilesUnit::test_test_profile_success SKIPPED [ 76%]
tests/test_profiles_unit.py::TestProfilesUnit::test_clone_profile_success SKIPPED [ 76%]
tests/test_profiles_unit.py::TestProfilesUnit::test_get_profile_stats_success SKIPPED [ 76%]
tests/test_profiles_unit.py::TestProfilesUnit::test_get_available_providers_success SKIPPED [ 77%]
tests/test_profiles_unit.py::TestProfilesUnit::test_profile_service_error_handling SKIPPED [ 77%]
tests/test_profiles_unit.py::TestProfilesUnit::test_profile_validation_errors SKIPPED [ 77%]
tests/test_profiles_unit.py::TestProfilesUnit::test_list_profiles_filtering SKIPPED [ 77%]
tests/test_profiles_unit.py::TestProfilesUnit::test_test_profile_rate_limit SKIPPED [ 77%]
tests/test_schema_model_consistency.py::TestSchemaModelConsistency::test_user_registration_schema_matches_model_fields PASSED [ 77%]
tests/test_schema_model_consistency.py::TestSchemaModelConsistency::test_user_update_schema_matches_model_fields PASSED [ 77%]
tests/test_schema_model_consistency.py::TestSchemaModelConsistency::test_user_response_schema_matches_model_fields PASSED [ 77%]
tests/test_schema_model_consistency.py::TestSchemaModelConsistency::test_user_model_required_fields_in_schemas PASSED [ 78%]
tests/test_schema_model_consistency.py::TestSchemaModelConsistency::test_phone_number_field_exists_in_user_model PASSED [ 78%]
tests/test_schema_model_consistency.py::TestSchemaModelConsistency::test_user_schema_validation_with_phone_number PASSED [ 78%]
tests/test_schema_model_consistency.py::TestSchemaModelConsistency::test_user_model_can_store_phone_number PASSED [ 78%]
tests/test_security_testing.py::TestSecurityTesting::test_sql_injection_protection_validation SKIPPED [ 78%]
tests/test_security_testing.py::TestSecurityTesting::test_xss_prevention SKIPPED [ 78%]
tests/test_security_testing.py::TestSecurityTesting::test_authentication_security_brute_force_protection SKIPPED [ 78%]
tests/test_security_testing.py::TestSecurityTesting::test_authorization_checks_and_token_validation SKIPPED [ 78%]
tests/test_security_testing.py::TestSecurityTesting::test_file_upload_security_malicious_detection SKIPPED [ 79%]
tests/test_security_testing.py::TestSecurityTesting::test_input_validation_and_sanitization SKIPPED [ 79%]
tests/test_security_testing.py::TestSecurityTesting::test_security_headers_validation SKIPPED [ 79%]
tests/test_security_testing.py::TestSecurityTesting::test_information_disclosure_prevention SKIPPED [ 79%]
tests/test_security_testing.py::TestSecurityTesting::test_cors_configuration_security SKIPPED [ 79%]
tests/test_seeding_fixes.py::TestSeedingEnumFixes::test_prompt_category_enums_exist PASSED [ 79%]
tests/test_seeding_fixes.py::TestSeedingEnumFixes::test_profile_type_enums_exist PASSED [ 79%]
tests/test_seeding_fixes.py::TestDatabaseSeederBasics::test_seeder_initialization PASSED [ 80%]
tests/test_seeding_fixes.py::TestDatabaseSeederBasics::test_count_users_mock PASSED [ 80%]
tests/test_seeding_fixes.py::TestConfigurableSeederBasics::test_configurable_seeder_initialization PASSED [ 80%]
tests/test_seeding_fixes.py::TestConfigurableSeederBasics::test_yaml_config_loading_with_missing_file PASSED [ 80%]
tests/test_seeding_fixes.py::TestSeedingModes::test_seeding_modes_exist PASSED [ 80%]
tests/test_seeding_fixes.py::TestSeedingModes::test_seeding_mode_values PASSED [ 80%]
tests/test_seeding_fixes.py::TestMethodImplementations::test_demo_embedding_spaces_method_exists PASSED [ 80%]
tests/test_seeding_fixes.py::TestMethodImplementations::test_test_registry_data_method_exists PASSED [ 80%]
tests/test_seeding_fixes.py::TestMethodImplementations::test_test_conversations_method_exists PASSED [ 81%]
tests/test_seeding_fixes.py::TestMethodImplementations::test_test_documents_method_exists PASSED [ 81%]
tests/test_seeding_fixes.py::TestErrorHandling::test_seeding_handles_exceptions PASSED [ 81%]
tests/test_seeding_fixes.py::TestSkipExistingLogic::test_skip_existing_when_users_exist PASSED [ 81%]
tests/test_seeding_fixes.py::TestSkipExistingLogic::test_force_mode_bypasses_existing_check PASSED [ 81%]
tests/test_streaming.py::TestStreamingEventType::test_streaming_event_types PASSED [ 81%]
tests/test_streaming.py::TestStreamingEventType::test_streaming_event_type_string_values PASSED [ 81%]
tests/test_streaming.py::TestStreamingEvent::test_streaming_event_data_creation FAILED [ 81%]
tests/test_streaming.py::TestStreamingEvent::test_streaming_event_data_minimal FAILED [ 82%]
tests/test_streaming.py::TestStreamingEvent::test_streaming_event_data_auto_timestamp FAILED [ 82%]
tests/test_streaming.py::TestStreamingEvent::test_streaming_event_data_with_metadata FAILED [ 82%]
tests/test_streaming.py::TestStreamingError::test_streaming_error_basic PASSED [ 82%]
tests/test_streaming.py::TestStreamingError::test_streaming_error_with_event_type PASSED [ 82%]
tests/test_streaming.py::TestStreamingError::test_streaming_error_inheritance PASSED [ 82%]
tests/test_streaming.py::TestStreamingService::test_streaming_service_initialization PASSED [ 82%]
tests/test_streaming.py::TestStreamingService::test_create_stream PASSED [ 82%]
tests/test_streaming.py::TestStreamingService::test_create_stream_auto_correlation_id PASSED [ 83%]
tests/test_streaming.py::TestStreamingService::test_create_stream_metrics_initialization PASSED [ 83%]
tests/test_streaming.py::TestStreamingService::test_end_stream FAILED    [ 83%]
tests/test_streaming.py::TestStreamingService::test_end_nonexistent_stream PASSED [ 83%]
tests/test_streaming.py::TestStreamingService::test_stream_event_basic FAILED [ 83%]
tests/test_streaming.py::TestStreamingService::test_stream_token FAILED  [ 83%]
tests/test_streaming.py::TestStreamingService::test_stream_tool_call_lifecycle FAILED [ 83%]
tests/test_streaming.py::TestStreamingService::test_stream_thinking FAILED [ 84%]
tests/test_streaming.py::TestStreamingService::test_stream_source_found FAILED [ 84%]
tests/test_streaming.py::TestStreamingService::test_stream_error FAILED  [ 84%]
tests/test_streaming.py::TestStreamingService::test_stream_complete FAILED [ 84%]
tests/test_streaming.py::TestStreamingService::test_stream_metadata FAILED [ 84%]
tests/test_streaming.py::TestStreamingService::test_get_stream_metrics FAILED [ 84%]
tests/test_streaming.py::TestStreamingService::test_get_nonexistent_stream_metrics FAILED [ 84%]
tests/test_streaming.py::TestStreamingService::test_list_active_streams FAILED [ 84%]
tests/test_streaming.py::TestStreamingService::test_is_stream_active FAILED [ 85%]
tests/test_streaming.py::TestStreamingService::test_stream_activity_tracking FAILED [ 85%]
tests/test_streaming.py::TestStreamingService::test_stream_error_handling_invalid_stream FAILED [ 85%]
tests/test_streaming.py::TestStreamingService::test_concurrent_streams FAILED [ 85%]
tests/test_streaming.py::TestStreamingService::test_stream_cleanup_on_error FAILED [ 85%]
tests/test_streaming.py::TestStreamingServiceIntegration::test_complete_streaming_workflow FAILED [ 85%]
tests/test_streaming.py::TestStreamingServiceIntegration::test_error_recovery_workflow FAILED [ 85%]
tests/test_streaming.py::TestStreamingServiceIntegration::test_performance_with_high_volume_streaming FAILED [ 85%]
tests/test_streaming.py::TestStreamingServiceIntegration::test_stream_isolation FAILED [ 86%]
tests/test_toolserver_improvements.py::test_crypto_utility PASSED        [ 86%]
tests/test_toolserver_improvements.py::test_rate_limiter PASSED          [ 86%]
tests/test_toolserver_improvements.py::test_mcp_service_validation PASSED [ 86%]
tests/test_toolserver_improvements.py::test_schema_validation PASSED     [ 86%]
tests/test_unified_cache.py::TestCacheInterface::test_memory_cache_basic_operations PASSED [ 86%]
tests/test_unified_cache.py::TestCacheInterface::test_memory_cache_batch_operations PASSED [ 86%]
tests/test_unified_cache.py::TestCacheInterface::test_memory_cache_increment PASSED [ 86%]
tests/test_unified_cache.py::TestCacheInterface::test_memory_cache_ttl PASSED [ 87%]
tests/test_unified_cache.py::TestCacheInterface::test_memory_cache_key_generation PASSED [ 87%]
tests/test_unified_cache.py::TestCacheInterface::test_memory_cache_eviction PASSED [ 87%]
tests/test_unified_cache.py::TestCacheInterface::test_memory_cache_stats PASSED [ 87%]
tests/test_unified_cache.py::TestCacheInterface::test_memory_cache_health_check PASSED [ 87%]
tests/test_unified_cache.py::TestCacheFactory::test_create_different_cache_types PASSED [ 87%]
tests/test_unified_cache.py::TestCacheFactory::test_convenience_methods PASSED [ 87%]
tests/test_unified_cache.py::TestCacheFactory::test_health_check_all PASSED [ 88%]
tests/test_unified_cache.py::TestCacheFactory::test_get_stats_all PASSED [ 88%]
tests/test_unified_cache.py::TestUnifiedModelRegistryCache::test_default_provider_operations PASSED [ 88%]
tests/test_unified_cache.py::TestUnifiedModelRegistryCache::test_provider_data_operations PASSED [ 88%]
tests/test_unified_cache.py::TestUnifiedModelRegistryCache::test_list_operations PASSED [ 88%]
tests/test_unified_cache.py::TestUnifiedWorkflowCache::test_workflow_operations PASSED [ 88%]
tests/test_unified_cache.py::TestUnifiedWorkflowCache::test_workflow_stats PASSED [ 88%]
tests/test_unified_cache.py::TestUnifiedWorkflowCache::test_workflow_key_generation PASSED [ 88%]
tests/test_unified_cache.py::test_cache_integration PASSED               [ 89%]
tests/test_unified_events.py::TestUnifiedEvent::test_create_unified_event PASSED [ 89%]
tests/test_unified_events.py::TestUnifiedEvent::test_event_to_dict PASSED [ 89%]
tests/test_unified_events.py::TestUnifiedEvent::test_event_from_dict PASSED [ 89%]
tests/test_unified_events.py::TestEventCreationFunctions::test_create_realtime_event PASSED [ 89%]
tests/test_unified_events.py::TestEventCreationFunctions::test_create_security_event PASSED [ 89%]
tests/test_unified_events.py::TestEventCreationFunctions::test_create_audit_event PASSED [ 89%]
tests/test_unified_events.py::TestEventCreationFunctions::test_create_streaming_event PASSED [ 89%]
tests/test_unified_events.py::TestEventCreationFunctions::test_create_analytics_event PASSED [ 90%]
tests/test_unified_events.py::TestEventRouter::test_register_emitter PASSED [ 90%]
tests/test_unified_events.py::TestEventRouter::test_add_handlers PASSED  [ 90%]
tests/test_unified_events.py::TestEventRouter::test_route_event PASSED   [ 90%]
tests/test_unified_events.py::TestUnifiedEventManager::test_manager_initialization PASSED [ 90%]
tests/test_unified_events.py::TestUnifiedEventManager::test_emit_different_event_types PASSED [ 90%]
tests/test_unified_events.py::TestUnifiedEventManager::test_system_alert PASSED [ 90%]
tests/test_unified_events.py::TestEventIntegration::test_full_event_flow PASSED [ 90%]
tests/test_unified_events.py::TestEventIntegration::test_convenience_functions PASSED [ 91%]
tests/test_unified_events.py::TestMinimalIntegration::test_setup_functions PASSED [ 91%]
tests/test_unified_events.py::TestMinimalIntegration::test_convenience_without_manager PASSED [ 91%]
tests/test_unified_events.py::TestMinimalIntegration::test_get_stats_without_manager PASSED [ 91%]
tests/test_unified_validation.py::TestValidationEngine::test_validate_input_success PASSED [ 91%]
tests/test_unified_validation.py::TestValidationEngine::test_validate_input_failure PASSED [ 91%]
tests/test_unified_validation.py::TestValidationEngine::test_validate_security_success PASSED [ 91%]
tests/test_unified_validation.py::TestValidationEngine::test_validate_security_failure PASSED [ 92%]
tests/test_unified_validation.py::TestInputValidator::test_email_validation PASSED [ 92%]
tests/test_unified_validation.py::TestInputValidator::test_username_validation PASSED [ 92%]
tests/test_unified_validation.py::TestInputValidator::test_sanitization PASSED [ 92%]
tests/test_unified_validation.py::TestSecurityValidator::test_xss_detection PASSED [ 92%]
tests/test_unified_validation.py::TestSecurityValidator::test_sql_injection_detection PASSED [ 92%]
tests/test_unified_validation.py::TestSecurityValidator::test_path_traversal_detection PASSED [ 92%]
tests/test_unified_validation.py::TestBusinessValidator::test_model_consistency PASSED [ 92%]
tests/test_unified_validation.py::TestBusinessValidator::test_embedding_space_validation PASSED [ 93%]
tests/test_unified_validation.py::TestValidationContext::test_context_overrides PASSED [ 93%]
tests/test_unified_validation.py::TestValidationContext::test_context_modes PASSED [ 93%]
tests/test_unified_validation.py::TestValidationContext::test_validator_enablement PASSED [ 93%]
tests/test_unified_validation.py::TestBackwardsCompatibility::test_legacy_imports SKIPPED [ 93%]
tests/test_unified_validation.py::TestBackwardsCompatibility::test_legacy_validator_classes SKIPPED [ 93%]
tests/test_unified_validation.py::TestValidationResult::test_result_creation PASSED [ 93%]
tests/test_unified_validation.py::TestValidationResult::test_result_with_errors PASSED [ 93%]
tests/test_unified_validation.py::TestValidationResult::test_result_merging PASSED [ 94%]
tests/test_versioning.py::TestAPIVersion::test_api_version_values PASSED [ 94%]
tests/test_versioning.py::TestAPIVersion::test_api_version_string_representation FAILED [ 94%]
tests/test_versioning.py::TestVersionStatus::test_version_status_values FAILED [ 94%]
tests/test_versioning.py::TestVersionStatus::test_version_status_progression FAILED [ 94%]
tests/test_versioning.py::TestVersionInfo::test_version_info_creation PASSED [ 94%]
tests/test_versioning.py::TestVersionInfo::test_version_info_minimal PASSED [ 94%]
tests/test_versioning.py::TestEndpointVersioning::test_endpoint_versioning_creation FAILED [ 94%]
tests/test_versioning.py::TestEndpointVersioning::test_endpoint_versioning_lifecycle FAILED [ 95%]
tests/test_versioning.py::TestAPIVersionManager::test_manager_initialization PASSED [ 95%]
tests/test_versioning.py::TestAPIVersionManager::test_default_versions_loaded FAILED [ 95%]
tests/test_versioning.py::TestAPIVersionManager::test_add_version PASSED [ 95%]
tests/test_versioning.py::TestAPIVersionManager::test_get_version_info_existing PASSED [ 95%]
tests/test_versioning.py::TestAPIVersionManager::test_get_version_info_nonexistent PASSED [ 95%]
tests/test_versioning.py::TestAPIVersionManager::test_get_all_versions PASSED [ 95%]
tests/test_versioning.py::TestAPIVersionManager::test_get_active_versions PASSED [ 96%]
tests/test_versioning.py::TestAPIVersionManager::test_is_version_supported_active PASSED [ 96%]
tests/test_versioning.py::TestAPIVersionManager::test_is_version_supported_deprecated PASSED [ 96%]
tests/test_versioning.py::TestAPIVersionManager::test_is_version_supported_sunset PASSED [ 96%]
tests/test_versioning.py::TestAPIVersionManager::test_is_version_supported_nonexistent PASSED [ 96%]
tests/test_versioning.py::TestAPIVersionManager::test_register_endpoint PASSED [ 96%]
tests/test_versioning.py::TestAPIVersionManager::test_register_endpoint_method_normalization PASSED [ 96%]
tests/test_versioning.py::TestAPIVersionManager::test_is_endpoint_available_current_version PASSED [ 96%]
tests/test_versioning.py::TestAPIVersionManager::test_is_endpoint_available_future_version PASSED [ 97%]
tests/test_versioning.py::TestAPIVersionManager::test_is_endpoint_available_after_removal PASSED [ 97%]
tests/test_versioning.py::TestAPIVersionManager::test_is_endpoint_available_unregistered FAILED [ 97%]
tests/test_versioning.py::TestAPIVersionManager::test_deprecate_endpoint FAILED [ 97%]
tests/test_versioning.py::TestAPIVersionManager::test_deprecate_nonexistent_endpoint FAILED [ 97%]
tests/test_versioning.py::TestAPIVersionManager::test_get_endpoint_info FAILED [ 97%]
tests/test_versioning.py::TestAPIVersionManager::test_get_endpoint_info_nonexistent FAILED [ 97%]
tests/test_versioning.py::TestAPIVersionManager::test_get_endpoints_for_version FAILED [ 97%]
tests/test_versioning.py::TestAPIVersionManager::test_version_middleware_integration FAILED [ 98%]
tests/test_versioning.py::TestVersioningIntegration::test_complete_version_lifecycle FAILED [ 98%]
tests/test_versioning.py::TestVersioningIntegration::test_version_migration_scenario FAILED [ 98%]
tests/test_versioning.py::TestVersioningIntegration::test_backwards_compatibility_checking FAILED [ 98%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowLimitManager::test_get_default_limits PASSED [ 98%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowLimitManager::test_concurrent_limit_check PASSED [ 98%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowLimitManager::test_workflow_tracking_lifecycle PASSED [ 98%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowLimitManager::test_resource_limit_checking PASSED [ 98%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowLimitManager::test_timeout_context_manager PASSED [ 99%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowLimitManager::test_workflow_stats PASSED [ 99%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_execute_workflow_with_limits FAILED [ 99%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_execute_workflow_timeout FAILED [ 99%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_concurrent_workflow_limit PASSED [ 99%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_streaming_workflow_with_limits FAILED [ 99%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_streaming_workflow_timeout FAILED [ 99%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_enhanced_token_streaming_all_workflows FAILED [100%]

=================================== FAILURES ===================================
________ TestEnhancedPasswordSecurity.test_password_entropy_calculation ________

self = <tests.test_auth_security_comprehensive.TestEnhancedPasswordSecurity object at 0x7d937e261940>

    @pytest.mark.security
    def test_password_entropy_calculation(self):
        """Test password entropy calculation."""
        # Weak password
        weak_entropy = calculate_password_entropy("123456")
        assert weak_entropy < 30
    
        # Medium password
        medium_entropy = calculate_password_entropy("Password123")
>       assert 30 <= medium_entropy < 50
E       assert 56.66343593148202 < 50

tests/test_auth_security_comprehensive.py:40: AssertionError
_________ TestEnhancedPasswordSecurity.test_personal_info_in_password __________

self = <tests.test_auth_security_comprehensive.TestEnhancedPasswordSecurity object at 0x7d937e2465d0>

    @pytest.mark.security
    def test_personal_info_in_password(self):
        """Test personal information detection in passwords."""
        user_data = {
            "username": "johndoe",
            "email": "john.doe@example.com",
            "full_name": "John Doe"
        }
    
        assert contains_personal_info("johndoe123", user_data) is True
>       assert contains_personal_info("john123password", user_data) is True
E       AssertionError: assert False is True
E        +  where False = contains_personal_info('john123password', {'email': 'john.doe@example.com', 'full_name': 'John Doe', 'username': 'johndoe'})

tests/test_auth_security_comprehensive.py:81: AssertionError
_____________________ TestCLICommands.test_health_command ______________________

self = <tests.test_cli.TestCLICommands object at 0x7d937dd78830>
mock_asyncio_run = <MagicMock name='run' id='138072408455984'>

    @patch('chatter.cli.asyncio.run')
    def test_health_command(self, mock_asyncio_run):
        """Test health check command."""
        result = self.runner.invoke(app, ["health"])
>       assert result.exit_code == 0
E       assert 2 == 0
E        +  where 2 = <Result SystemExit(2)>.exit_code

tests/test_cli.py:283: AssertionError
__________________ TestHealthCheck.test_health_check_success ___________________

self = <tests.test_cli.TestHealthCheck object at 0x7d937dd78ec0>
mock_get_client = <MagicMock name='get_api_client' id='138072407038464'>

    @pytest.mark.asyncio
    @patch('chatter.cli.get_api_client')
    async def test_health_check_success(self, mock_get_client):
        """Test successful health check."""
        mock_client = MagicMock()
        mock_client.request = AsyncMock(return_value={
            "status": "ok",
            "version": "1.0.0",
            "timestamp": "2024-01-01T00:00:00Z"
        })
        mock_client.close = AsyncMock()
        mock_get_client.return_value = mock_client
    
        with patch('chatter.cli.console') as mock_console:
>           await health_check()
                  ^^^^^^^^^^^^^^

tests/test_cli.py:318: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/cli.py:988: in health_check
    asyncio.run(_check())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

main = <coroutine object health_check.<locals>._check at 0x7d937d84f290>

    def run(main, *, debug=None, loop_factory=None):
        """Execute the coroutine and return the result.
    
        This function runs the passed coroutine, taking care of
        managing the asyncio event loop, finalizing asynchronous
        generators and closing the default executor.
    
        This function cannot be called when another asyncio event loop is
        running in the same thread.
    
        If debug is True, the event loop will be run in debug mode.
        If loop_factory is passed, it is used for new event loop creation.
    
        This function always creates a new event loop and closes it at the end.
        It should be used as a main entry point for asyncio programs, and should
        ideally only be called once.
    
        The executor is given a timeout duration of 5 minutes to shutdown.
        If the executor hasn't finished within that duration, a warning is
        emitted and the executor is closed.
    
        Example:
    
            async def main():
                await asyncio.sleep(1)
                print('hello')
    
            asyncio.run(main())
        """
        if events._get_running_loop() is not None:
            # fail fast with short traceback
>           raise RuntimeError(
                "asyncio.run() cannot be called from a running event loop")
E           RuntimeError: asyncio.run() cannot be called from a running event loop

/usr/lib64/python3.12/asyncio/runners.py:191: RuntimeError
__________________ TestHealthCheck.test_health_check_failure ___________________

self = <tests.test_cli.TestHealthCheck object at 0x7d937dd78fe0>
mock_get_client = <MagicMock name='get_api_client' id='138072408448400'>

    @pytest.mark.asyncio
    @patch('chatter.cli.get_api_client')
    async def test_health_check_failure(self, mock_get_client):
        """Test health check failure."""
        mock_client = MagicMock()
        mock_client.request = AsyncMock(side_effect=Exception("Connection failed"))
        mock_client.close = AsyncMock()
        mock_get_client.return_value = mock_client
    
        # Should not raise exception, but handle gracefully
>       await health_check()
              ^^^^^^^^^^^^^^

tests/test_cli.py:333: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/cli.py:988: in health_check
    asyncio.run(_check())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

main = <coroutine object health_check.<locals>._check at 0x7d937cbc81b0>

    def run(main, *, debug=None, loop_factory=None):
        """Execute the coroutine and return the result.
    
        This function runs the passed coroutine, taking care of
        managing the asyncio event loop, finalizing asynchronous
        generators and closing the default executor.
    
        This function cannot be called when another asyncio event loop is
        running in the same thread.
    
        If debug is True, the event loop will be run in debug mode.
        If loop_factory is passed, it is used for new event loop creation.
    
        This function always creates a new event loop and closes it at the end.
        It should be used as a main entry point for asyncio programs, and should
        ideally only be called once.
    
        The executor is given a timeout duration of 5 minutes to shutdown.
        If the executor hasn't finished within that duration, a warning is
        emitted and the executor is closed.
    
        Example:
    
            async def main():
                await asyncio.sleep(1)
                print('hello')
    
            asyncio.run(main())
        """
        if events._get_running_loop() is not None:
            # fail fast with short traceback
>           raise RuntimeError(
                "asyncio.run() cannot be called from a running event loop")
E           RuntimeError: asyncio.run() cannot be called from a running event loop

/usr/lib64/python3.12/asyncio/runners.py:191: RuntimeError
__________________ TestDatabaseCommands.test_db_init_success ___________________

self = <tests.test_cli.TestDatabaseCommands object at 0x7d937dd79220>
mock_check_db = <AsyncMock name='check_database_connection' id='138072408290896'>
mock_init_db = <MagicMock name='db_init' id='138072407013472'>

    @pytest.mark.asyncio
    @patch('chatter.cli.db_init')
    @patch('chatter.cli.check_database_connection')
    async def test_db_init_success(self, mock_check_db, mock_init_db):
        """Test successful database initialization."""
        mock_check_db.return_value = True
        mock_init_db.return_value = None
    
        with patch('chatter.cli.console') as mock_console:
>           await db_init()
                  ^^^^^^^^^

tests/test_cli.py:348: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/cli.py:677: in db_init
    asyncio.run(_init())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

main = <coroutine object db_init.<locals>._init at 0x7d937cc764d0>

    def run(main, *, debug=None, loop_factory=None):
        """Execute the coroutine and return the result.
    
        This function runs the passed coroutine, taking care of
        managing the asyncio event loop, finalizing asynchronous
        generators and closing the default executor.
    
        This function cannot be called when another asyncio event loop is
        running in the same thread.
    
        If debug is True, the event loop will be run in debug mode.
        If loop_factory is passed, it is used for new event loop creation.
    
        This function always creates a new event loop and closes it at the end.
        It should be used as a main entry point for asyncio programs, and should
        ideally only be called once.
    
        The executor is given a timeout duration of 5 minutes to shutdown.
        If the executor hasn't finished within that duration, a warning is
        emitted and the executor is closed.
    
        Example:
    
            async def main():
                await asyncio.sleep(1)
                print('hello')
    
            asyncio.run(main())
        """
        if events._get_running_loop() is not None:
            # fail fast with short traceback
>           raise RuntimeError(
                "asyncio.run() cannot be called from a running event loop")
E           RuntimeError: asyncio.run() cannot be called from a running event loop

/usr/lib64/python3.12/asyncio/runners.py:191: RuntimeError
_____________ TestDatabaseCommands.test_db_init_connection_failure _____________

self = <tests.test_cli.TestDatabaseCommands object at 0x7d937dd79460>
mock_check_db = <AsyncMock name='check_database_connection' id='138072407041728'>
mock_init_db = <MagicMock name='db_init' id='138072407043600'>

    @pytest.mark.asyncio
    @patch('chatter.cli.db_init')
    @patch('chatter.cli.check_database_connection')
    async def test_db_init_connection_failure(self, mock_check_db, mock_init_db):
        """Test database initialization with connection failure."""
        mock_check_db.return_value = False
    
        with patch('chatter.cli.console') as mock_console:
>           await db_init()
                  ^^^^^^^^^

tests/test_cli.py:362: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/cli.py:677: in db_init
    asyncio.run(_init())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

main = <coroutine object db_init.<locals>._init at 0x7d937cc76e90>

    def run(main, *, debug=None, loop_factory=None):
        """Execute the coroutine and return the result.
    
        This function runs the passed coroutine, taking care of
        managing the asyncio event loop, finalizing asynchronous
        generators and closing the default executor.
    
        This function cannot be called when another asyncio event loop is
        running in the same thread.
    
        If debug is True, the event loop will be run in debug mode.
        If loop_factory is passed, it is used for new event loop creation.
    
        This function always creates a new event loop and closes it at the end.
        It should be used as a main entry point for asyncio programs, and should
        ideally only be called once.
    
        The executor is given a timeout duration of 5 minutes to shutdown.
        If the executor hasn't finished within that duration, a warning is
        emitted and the executor is closed.
    
        Example:
    
            async def main():
                await asyncio.sleep(1)
                print('hello')
    
            asyncio.run(main())
        """
        if events._get_running_loop() is not None:
            # fail fast with short traceback
>           raise RuntimeError(
                "asyncio.run() cannot be called from a running event loop")
E           RuntimeError: asyncio.run() cannot be called from a running event loop

/usr/lib64/python3.12/asyncio/runners.py:191: RuntimeError
________________ TestDatabaseCommands.test_db_init_init_failure ________________

self = <tests.test_cli.TestDatabaseCommands object at 0x7d937dd796a0>
mock_check_db = <AsyncMock name='check_database_connection' id='138072409569616'>
mock_init_db = <MagicMock name='db_init' id='138072409555216'>

    @pytest.mark.asyncio
    @patch('chatter.cli.db_init')
    @patch('chatter.cli.check_database_connection')
    async def test_db_init_init_failure(self, mock_check_db, mock_init_db):
        """Test database initialization with init failure."""
        mock_check_db.return_value = True
        mock_init_db.side_effect = Exception("Init failed")
    
        with patch('chatter.cli.console') as mock_console:
>           await db_init()
                  ^^^^^^^^^

tests/test_cli.py:377: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/cli.py:677: in db_init
    asyncio.run(_init())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

main = <coroutine object db_init.<locals>._init at 0x7d937cc776b0>

    def run(main, *, debug=None, loop_factory=None):
        """Execute the coroutine and return the result.
    
        This function runs the passed coroutine, taking care of
        managing the asyncio event loop, finalizing asynchronous
        generators and closing the default executor.
    
        This function cannot be called when another asyncio event loop is
        running in the same thread.
    
        If debug is True, the event loop will be run in debug mode.
        If loop_factory is passed, it is used for new event loop creation.
    
        This function always creates a new event loop and closes it at the end.
        It should be used as a main entry point for asyncio programs, and should
        ideally only be called once.
    
        The executor is given a timeout duration of 5 minutes to shutdown.
        If the executor hasn't finished within that duration, a warning is
        emitted and the executor is closed.
    
        Example:
    
            async def main():
                await asyncio.sleep(1)
                print('hello')
    
            asyncio.run(main())
        """
        if events._get_running_loop() is not None:
            # fail fast with short traceback
>           raise RuntimeError(
                "asyncio.run() cannot be called from a running event loop")
E           RuntimeError: asyncio.run() cannot be called from a running event loop

/usr/lib64/python3.12/asyncio/runners.py:191: RuntimeError
________ TestInteractivePromptCreation.test_interactive_prompt_creation ________

self = <tests.test_cli.TestInteractivePromptCreation object at 0x7d937dd79a90>
mock_get_client = <MagicMock name='get_api_client' id='138072407578848'>
mock_confirm = <MagicMock name='ask' id='138072406926032'>
mock_prompt = <MagicMock name='ask' id='138072419603120'>

    @pytest.mark.asyncio
    @patch('chatter.cli.Prompt.ask')
    @patch('chatter.cli.Confirm.ask')
    @patch('chatter.cli.get_api_client')
    async def test_interactive_prompt_creation(self, mock_get_client, mock_confirm, mock_prompt):
        """Test interactive prompt creation flow."""
        # Mock interactive input
        mock_prompt.side_effect = [
            "Test Prompt",        # name
            "Hello {name}",       # content
            "Test description",   # description
            "greeting",           # category
            "template",           # prompt_type
            "f-string",          # template_format
            "hello,greeting"      # tags
        ]
        mock_confirm.return_value = True  # public
    
        # Mock API client
        mock_client = MagicMock()
        mock_client.request = AsyncMock(return_value={
            "id": "test_id",
            "name": "Test Prompt",
            "status": "created"
        })
        mock_client.close = AsyncMock()
        mock_get_client.return_value = mock_client
    
        # This would normally be called through the CLI command
        # We're testing the underlying async function logic
        from chatter.cli import create_prompt
    
        runner = CliRunner()
        result = runner.invoke(app, [
            "prompts", "create",
            "--name", "Test Prompt",
            "--content", "Hello {name}",
            "--interactive"
        ])
    
        # Should complete without error
>       assert result.exit_code == 0
E       AssertionError: assert 1 == 0
E        +  where 1 = <Result RuntimeError('asyncio.run() cannot be called from a running event loop')>.exit_code

tests/test_cli.py:428: AssertionError
________________ TestCLIIntegration.test_full_prompt_lifecycle _________________

self = <tests.test_cli.TestCLIIntegration object at 0x7d937dd7a420>
mock_get_client = <MagicMock name='get_api_client' id='138072402497936'>

    @patch('chatter.cli.get_api_client')
    def test_full_prompt_lifecycle(self, mock_get_client):
        """Test complete prompt management lifecycle."""
        mock_client = MagicMock()
    
        # Mock different API responses for different commands
        def mock_request(method, endpoint, **kwargs):
            if endpoint == "/prompts" and method == "POST":
                return {"id": "new_prompt_id", "name": "Test Prompt"}
            elif endpoint == "/prompts" and method == "GET":
                return {
                    "prompts": [{
                        "id": "new_prompt_id",
                        "name": "Test Prompt",
                        "prompt_type": "template",
                        "category": "test"
                    }],
                    "total_count": 1
                }
            elif endpoint == "/prompts/new_prompt_id" and method == "DELETE":
                return {"status": "deleted"}
            return {}
    
        mock_client.request = AsyncMock(side_effect=mock_request)
        mock_client.close = AsyncMock()
        mock_get_client.return_value = mock_client
    
        # Create prompt
        result = self.runner.invoke(app, [
            "prompts", "create",
            "--name", "Test Prompt",
            "--content", "Hello {name}",
            "--category", "test"
        ])
>       assert result.exit_code == 0
E       assert 1 == 0
E        +  where 1 = <Result UnboundLocalError("cannot access local variable 'name' where it is not associated with a value")>.exit_code

tests/test_cli.py:532: AssertionError
_____________ TestCLIErrorScenarios.test_api_unavailable_scenarios _____________

self = <tests.test_cli.TestCLIErrorScenarios object at 0x7d937dd79d60>
mock_get_client = <MagicMock name='get_api_client' id='138072403223440'>

    @patch('chatter.cli.get_api_client')
    def test_api_unavailable_scenarios(self, mock_get_client):
        """Test CLI behavior when API is unavailable."""
        mock_client = MagicMock()
        mock_client.request = AsyncMock(side_effect=httpx.RequestError("Connection failed"))
        mock_client.close = AsyncMock()
        mock_get_client.return_value = mock_client
    
        result = self.runner.invoke(app, ["health"])
        # Should handle error gracefully
>       assert result.exit_code == 0  # Command should complete, even if API is down
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       assert 2 == 0
E        +  where 2 = <Result SystemExit(2)>.exit_code

tests/test_cli.py:601: AssertionError
_____ TestSecretManager.test_encrypt_with_different_managers_incompatible ______

self = <tests.test_crypto_utils.TestSecretManager object at 0x7d937dda1dc0>

    def test_encrypt_with_different_managers_incompatible(self):
        """Test that data encrypted with one manager can't be decrypted with another."""
        manager1 = SecretManager()
        manager2 = SecretManager()
    
        test_data = "secret data"
        encrypted = manager1.encrypt(test_data)
    
>       with pytest.raises(CryptoError, match="Failed to decrypt data"):
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       Failed: DID NOT RAISE <class 'chatter.utils.crypto.CryptoError'>

tests/test_crypto_utils.py:93: Failed
------------------------------ Captured log call -------------------------------
WARNING  chatter.utils.crypto:crypto.py:59 [2m2025-09-05T18:33:14.922478Z[0m [[33m[1mwarning  [0m] [1mUsing derived encryption key. Set CHATTER_ENCRYPTION_KEY in production.[0m [[34m[1mchatter.utils.crypto[0m] 
WARNING  chatter.utils.crypto:crypto.py:59 [2m2025-09-05T18:33:14.939423Z[0m [[33m[1mwarning  [0m] [1mUsing derived encryption key. Set CHATTER_ENCRYPTION_KEY in production.[0m [[34m[1mchatter.utils.crypto[0m]
__________________ TestMCPToolService.test_add_server_success __________________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7d937dcad1f0>

    @pytest.mark.asyncio
    async def test_add_server_success(self):
        """Test successfully adding a server."""
        server_config = RemoteMCPServer(
            name="test_server",
            base_url=HttpUrl("https://mcp.example.com"),
            transport_type="http"
        )
    
        with patch.object(self.service, '_convert_server_to_connection') as mock_convert:
            with patch.object(self.service, '_update_client') as mock_update:
                mock_convert.return_value = MagicMock(spec=Connection)
    
>               result = await self.service.add_server(server_config)
                               ^^^^^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:255: AttributeError
_____________ TestMCPToolService.test_add_server_disabled_service ______________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7d937dcae420>

    @pytest.mark.asyncio
    async def test_add_server_disabled_service(self):
        """Test adding server when service is disabled."""
        self.service.enabled = False
    
        server_config = RemoteMCPServer(
            name="test_server",
            base_url=HttpUrl("https://mcp.example.com"),
            transport_type="http"
        )
    
>       result = await self.service.add_server(server_config)
                       ^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:275: AttributeError
_____________ TestMCPToolService.test_add_server_validation_error ______________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7d937dcadd00>

    @pytest.mark.asyncio
    async def test_add_server_validation_error(self):
        """Test adding server with invalid configuration."""
        server_config = RemoteMCPServer(
            name="",  # Invalid: empty name
            base_url=HttpUrl("https://mcp.example.com"),
            transport_type="http"
        )
    
>       result = await self.service.add_server(server_config)
                       ^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:289: AttributeError
__________________ TestMCPToolService.test_call_tool_success ___________________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7d937dcd8140>

    @pytest.mark.asyncio
    async def test_call_tool_success(self):
        """Test successfully calling a tool."""
        # Add server and cached tools
        self.service.servers["test_server"] = MagicMock()
        mock_tool = MagicMock(spec=BaseTool)
        mock_tool.name = "test_tool"
        self.service.tools_cache["test_server"] = [mock_tool]
    
        mock_client = MagicMock()
        mock_client.call_tool = AsyncMock(return_value={"result": "success"})
    
        with patch.object(self.service, '_get_client', return_value=mock_client):
            result = await self.service.call_tool(
                "test_tool",
                {"param": "value"}
            )
    
>       assert result == {"result": "success"}
E       AssertionError: assert {'error': 'To...': False, ...} == {'result': 'success'}
E         
E         Left contains 5 more items:
E         {'error': 'Tool not found: test_tool',
E          'response_time_ms': 0.4069805145263672,
E          'server': 'unknown',
E          'success': False,
E          'tool': 'test_tool'}...
E         
E         ...Full output truncated (12 lines hidden), use '-vv' to show

tests/test_mcp_service.py:451: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    chatter.services.mcp:mcp.py:356 [2m2025-09-05T18:33:15.649776Z[0m [[31m[1merror    [0m] [1mFailed to get tools from MCP servers[0m [[34m[1mchatter.services.mcp[0m] [36merror[0m=[35mobject MagicMock can't be used in 'await' expression[0m
ERROR    chatter.services.mcp:mcp.py:492 [2m2025-09-05T18:33:15.649893Z[0m [[31m[1merror    [0m] [1mMCP tool call failed          [0m [[34m[1mchatter.services.mcp[0m] [36merror[0m=[35mTool not found: test_tool[0m [36mserver[0m=[35mNone[0m [36mtool[0m=[35mtest_tool[0m
______________ TestMCPToolService.test_call_tool_disabled_service ______________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7d937dcd83e0>

    @pytest.mark.asyncio
    async def test_call_tool_disabled_service(self):
        """Test calling tool when service is disabled."""
        self.service.enabled = False
    
        result = await self.service.call_tool("test_tool", {})
    
>       assert result is None
E       AssertionError: assert {'error': 'Tool not found: test_tool', 'response_time_ms': 0.02765655517578125, 'server': 'unknown', 'success': False, ...} is None

tests/test_mcp_service.py:464: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    chatter.services.mcp:mcp.py:492 [2m2025-09-05T18:33:15.666612Z[0m [[31m[1merror    [0m] [1mMCP tool call failed          [0m [[34m[1mchatter.services.mcp[0m] [36merror[0m=[35mTool not found: test_tool[0m [36mserver[0m=[35mNone[0m [36mtool[0m=[35mtest_tool[0m
_____________________ TestMCPToolService.test_list_servers _____________________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7d937dcd86b0>

    @pytest.mark.asyncio
    async def test_list_servers(self):
        """Test listing servers."""
        server1 = RemoteMCPServer(
            name="server1",
            base_url=HttpUrl("https://mcp1.example.com"),
            transport_type="http"
        )
        server2 = RemoteMCPServer(
            name="server2",
            base_url=HttpUrl("https://mcp2.example.com"),
            transport_type="sse",
            enabled=False
        )
    
        self.service.servers["server1"] = server1
        self.service.servers["server2"] = server2
    
>       servers = self.service.list_servers()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MCPToolService' object has no attribute 'list_servers'

tests/test_mcp_service.py:484: AttributeError
___________________ TestMCPToolService.test_get_server_info ____________________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7d937dcd8980>

    @pytest.mark.asyncio
    async def test_get_server_info(self):
        """Test getting server information."""
        server_config = RemoteMCPServer(
            name="test_server",
            base_url=HttpUrl("https://mcp.example.com"),
            transport_type="http",
            timeout=60
        )
        self.service.servers["test_server"] = server_config
        self.service.tools_cache["test_server"] = [MagicMock(), MagicMock()]
    
>       info = await self.service.get_server_info("test_server")
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MCPToolService' object has no attribute 'get_server_info'

tests/test_mcp_service.py:504: AttributeError
_____________ TestMCPToolService.test_get_server_info_nonexistent ______________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7d937dcaff20>

    @pytest.mark.asyncio
    async def test_get_server_info_nonexistent(self):
        """Test getting info for nonexistent server."""
>       info = await self.service.get_server_info("nonexistent")
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MCPToolService' object has no attribute 'get_server_info'

tests/test_mcp_service.py:520: AttributeError
_______________ TestMCPServiceIntegration.test_server_lifecycle ________________

self = <tests.test_mcp_service.TestMCPServiceIntegration object at 0x7d937dcacd70>

    @pytest.mark.asyncio
    async def test_server_lifecycle(self):
        """Test complete server lifecycle: add, discover, call, remove."""
        server_config = RemoteMCPServer(
            name="test_server",
            base_url=HttpUrl("https://mcp.example.com"),
            transport_type="http"
        )
    
        # Mock the MCP client interactions
        mock_tool = StructuredTool.from_function(
            func=lambda x: f"Result: {x}",
            name="test_tool",
            description="Test tool"
        )
    
        mock_client = MagicMock()
        mock_client.get_tools = AsyncMock(return_value=[mock_tool])
        mock_client.call_tool = AsyncMock(return_value={"result": "success"})
    
        with patch.object(self.service, '_get_client', return_value=mock_client):
            with patch.object(self.service, '_convert_server_to_connection') as mock_convert:
                with patch.object(self.service, '_update_client'):
                    mock_convert.return_value = MagicMock(spec=Connection)
    
                    # Add server
>                   assert await self.service.add_server(server_config) is True
                                 ^^^^^^^^^^^^^^^^^^^^^^^
E                   AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:585: AttributeError
__________ TestMCPServiceIntegration.test_multiple_servers_management __________

self = <tests.test_mcp_service.TestMCPServiceIntegration object at 0x7d937dc95eb0>

    @pytest.mark.asyncio
    async def test_multiple_servers_management(self):
        """Test managing multiple MCP servers."""
        server1 = RemoteMCPServer(
            name="server1",
            base_url=HttpUrl("https://mcp1.example.com"),
            transport_type="http"
        )
        server2 = RemoteMCPServer(
            name="server2",
            base_url=HttpUrl("https://mcp2.example.com"),
            transport_type="sse"
        )
    
        with patch.object(self.service, '_convert_server_to_connection') as mock_convert:
            with patch.object(self.service, '_update_client'):
                mock_convert.return_value = MagicMock(spec=Connection)
    
                # Add both servers
>               assert await self.service.add_server(server1) is True
                             ^^^^^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:625: AttributeError
___________ TestMCPServiceIntegration.test_error_recovery_scenarios ____________

self = <tests.test_mcp_service.TestMCPServiceIntegration object at 0x7d937dcd85c0>

    @pytest.mark.asyncio
    async def test_error_recovery_scenarios(self):
        """Test error recovery and circuit breaker functionality."""
        server_config = RemoteMCPServer(
            name="unreliable_server",
            base_url=HttpUrl("https://unreliable.example.com"),
            transport_type="http"
        )
    
        with patch.object(self.service, '_convert_server_to_connection'):
            with patch.object(self.service, '_update_client'):
                # Add server successfully
>               assert await self.service.add_server(server_config) is True
                             ^^^^^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:654: AttributeError
__________ TestSecurityHeadersMiddleware.test_security_headers_added ___________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 32, in test_security_headers_added
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 32, in test_security_headers_added
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7d937dcdbdd0>

    def test_security_headers_added(self):
        """Test that security headers are added to responses."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:32: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7d937c51d6d0>
request = <starlette.middleware.base._CachedRequest object at 0x7d937c9af860>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d937c698a40>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
______ TestSecurityHeadersMiddleware.test_content_security_policy_header _______
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 52, in test_content_security_policy_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 52, in test_content_security_policy_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7d937db101a0>

    def test_content_security_policy_header(self):
        """Test Content Security Policy header configuration."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:52: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7d937c4e8c80>
request = <starlette.middleware.base._CachedRequest object at 0x7d937c4e86e0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d9377600a40>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
__________ TestSecurityHeadersMiddleware.test_x_frame_options_header ___________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 65, in test_x_frame_options_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 65, in test_x_frame_options_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7d937db103b0>

    def test_x_frame_options_header(self):
        """Test X-Frame-Options header."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:65: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7d937c5a3650>
request = <starlette.middleware.base._CachedRequest object at 0x7d937c5a3c20>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d9377601da0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
_______ TestSecurityHeadersMiddleware.test_x_content_type_options_header _______
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 71, in test_x_content_type_options_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 71, in test_x_content_type_options_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7d937db105c0>

    def test_x_content_type_options_header(self):
        """Test X-Content-Type-Options header."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:71: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7d937c8f4b90>
request = <starlette.middleware.base._CachedRequest object at 0x7d937c8f4950>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d937c89a480>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
__________ TestSecurityHeadersMiddleware.test_x_xss_protection_header __________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 77, in test_x_xss_protection_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 77, in test_x_xss_protection_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7d937db107d0>

    def test_x_xss_protection_header(self):
        """Test X-XSS-Protection header."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:77: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7d937c9ad160>
request = <starlette.middleware.base._CachedRequest object at 0x7d937c9ac6e0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d937c8991c0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
__________ TestSecurityHeadersMiddleware.test_referrer_policy_header ___________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 83, in test_referrer_policy_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 83, in test_referrer_policy_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7d937db109e0>

    def test_referrer_policy_header(self):
        """Test Referrer-Policy header."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:83: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7d937c921ee0>
request = <starlette.middleware.base._CachedRequest object at 0x7d937c9220f0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d937c898040>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
_________ TestSecurityHeadersMiddleware.test_permissions_policy_header _________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 89, in test_permissions_policy_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 89, in test_permissions_policy_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7d937db10bf0>

    def test_permissions_policy_header(self):
        """Test Permissions-Policy header."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:89: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7d937c573d70>
request = <starlette.middleware.base._CachedRequest object at 0x7d937c570980>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d937cc58a40>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
_____ TestSecurityHeadersMiddleware.test_strict_transport_security_enabled _____
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 110, in test_strict_transport_security_enabled
    |     response = client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 110, in test_strict_transport_security_enabled
    response = client.get("/test")
               ^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7d937db10e00>

    def test_strict_transport_security_enabled(self):
        """Test HSTS header when enabled."""
        app = FastAPI()
    
        @app.get("/test")
        async def test_endpoint():
            return {"message": "test"}
    
        app.add_middleware(SecurityHeadersMiddleware, strict_transport_security=True)
        client = TestClient(app)
    
>       response = client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:110: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7d937c8bb020>
request = <starlette.middleware.base._CachedRequest object at 0x7d937c8baba0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d937cc5b920>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
____ TestSecurityHeadersMiddleware.test_strict_transport_security_disabled _____
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 128, in test_strict_transport_security_disabled
    |     response = client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 128, in test_strict_transport_security_disabled
    response = client.get("/test")
               ^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7d937db10ce0>

    def test_strict_transport_security_disabled(self):
        """Test HSTS header when disabled."""
        app = FastAPI()
    
        @app.get("/test")
        async def test_endpoint():
            return {"message": "test"}
    
        app.add_middleware(SecurityHeadersMiddleware, strict_transport_security=False)
        client = TestClient(app)
    
>       response = client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:128: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7d937c8c1eb0>
request = <starlette.middleware.base._CachedRequest object at 0x7d937c8c0ef0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d937c9baac0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
_ TestSecurityHeadersMiddleware.test_security_headers_on_different_response_types _
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 152, in test_security_headers_on_different_response_types
    |     response = client.get("/json")
    |                ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 152, in test_security_headers_on_different_response_types
    response = client.get("/json")
               ^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7d937db104d0>

    def test_security_headers_on_different_response_types(self):
        """Test security headers added to different response types."""
        app = FastAPI()
    
        @app.get("/json")
        async def json_endpoint():
            return {"message": "json"}
    
        @app.get("/html")
        async def html_endpoint():
            return Response(content="<html><body>test</body></html>", media_type="text/html")
    
        @app.get("/error")
        async def error_endpoint():
            return JSONResponse(content={"error": "test"}, status_code=400)
    
        app.add_middleware(SecurityHeadersMiddleware)
        client = TestClient(app)
    
        # Test JSON response
>       response = client.get("/json")
                   ^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:152: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7d937c812e70>
request = <starlette.middleware.base._CachedRequest object at 0x7d937c810830>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d937c56fba0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
__ TestSecurityHeadersMiddleware.test_security_headers_dont_override_existing __
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 176, in test_security_headers_dont_override_existing
    |     response = client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 176, in test_security_headers_dont_override_existing
    response = client.get("/test")
               ^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7d937db10fb0>

    def test_security_headers_dont_override_existing(self):
        """Test that security headers don't override existing ones."""
        app = FastAPI()
    
        @app.get("/test")
        async def test_endpoint():
            response = JSONResponse(content={"message": "test"})
            response.headers["X-Frame-Options"] = "SAMEORIGIN"
            return response
    
        app.add_middleware(SecurityHeadersMiddleware)
        client = TestClient(app)
    
>       response = client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:176: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7d937cb699a0>
request = <starlette.middleware.base._CachedRequest object at 0x7d937cb69f10>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d937c886f20>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
________ TestAuthRateLimitMiddleware.test_login_endpoint_rate_limiting _________

self = <tests.test_middleware.TestAuthRateLimitMiddleware object at 0x7d937db114f0>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='138072405523680'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    async def test_login_endpoint_rate_limiting(self, mock_get_limiter):
        """Test rate limiting on login endpoint."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(False, {"retry_after": 60}))
        mock_get_limiter.return_value = mock_limiter
    
        self.app.add_middleware(AuthRateLimitMiddleware)
        client = TestClient(self.app)
    
        response = client.post("/auth/login")
    
>       assert response.status_code == status.HTTP_429_TOO_MANY_REQUESTS
E       assert 200 == 429
E        +  where 200 = <Response [200 OK]>.status_code
E        +  and   429 = status.HTTP_429_TOO_MANY_REQUESTS

tests/test_middleware.py:261: AssertionError
_______ TestAuthRateLimitMiddleware.test_register_endpoint_rate_limiting _______

self = <tests.test_middleware.TestAuthRateLimitMiddleware object at 0x7d937db117c0>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='138072407081376'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    async def test_register_endpoint_rate_limiting(self, mock_get_limiter):
        """Test rate limiting on register endpoint."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(False, {"retry_after": 120}))
        mock_get_limiter.return_value = mock_limiter
    
        self.app.add_middleware(AuthRateLimitMiddleware)
        client = TestClient(self.app)
    
        response = client.post("/auth/register")
    
>       assert response.status_code == status.HTTP_429_TOO_MANY_REQUESTS
E       assert 200 == 429
E        +  where 200 = <Response [200 OK]>.status_code
E        +  and   429 = status.HTTP_429_TOO_MANY_REQUESTS

tests/test_middleware.py:276: AssertionError
____ TestAuthRateLimitMiddleware.test_password_reset_endpoint_rate_limiting ____

self = <tests.test_middleware.TestAuthRateLimitMiddleware object at 0x7d937db11a90>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='138072407002816'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    async def test_password_reset_endpoint_rate_limiting(self, mock_get_limiter):
        """Test rate limiting on password reset endpoint."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(False, {"retry_after": 300}))
        mock_get_limiter.return_value = mock_limiter
    
        self.app.add_middleware(AuthRateLimitMiddleware)
        client = TestClient(self.app)
    
        response = client.post("/auth/password-reset")
    
>       assert response.status_code == status.HTTP_429_TOO_MANY_REQUESTS
E       assert 200 == 429
E        +  where 200 = <Response [200 OK]>.status_code
E        +  and   429 = status.HTTP_429_TOO_MANY_REQUESTS

tests/test_middleware.py:292: AssertionError
__________ TestAuthRateLimitMiddleware.test_client_ip_identification ___________

self = <AsyncMock name='get_unified_rate_limiter().is_allowed' id='138072403290464'>

    def assert_called_once(self):
        """assert that the mock was called only once.
        """
        if not self.call_count == 1:
            msg = ("Expected '%s' to have been called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected 'is_allowed' to have been called once. Called 0 times.

/usr/lib64/python3.12/unittest/mock.py:928: AssertionError

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestAuthRateLimitMiddleware object at 0x7d937db12300>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='138072409557424'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    async def test_client_ip_identification(self, mock_get_limiter):
        """Test client IP identification for rate limiting."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(True, {}))
        mock_get_limiter.return_value = mock_limiter
    
        self.app.add_middleware(AuthRateLimitMiddleware)
        client = TestClient(self.app)
    
        # Test with X-Forwarded-For header
        response = client.post(
            "/auth/login",
            headers={"X-Forwarded-For": "192.168.1.100, 10.0.0.1"}
        )
    
        assert response.status_code == 200
        # Verify that rate limiter was called with client IP
>       mock_limiter.is_allowed.assert_called_once()
E       AssertionError: Expected 'is_allowed' to have been called once. Called 0 times.

tests/test_middleware.py:342: AssertionError
_____ TestAuthRateLimitMiddleware.test_rate_limit_with_user_agent_tracking _____

self = <AsyncMock name='get_unified_rate_limiter().is_allowed' id='138072429973184'>

    def assert_called_once(self):
        """assert that the mock was called only once.
        """
        if not self.call_count == 1:
            msg = ("Expected '%s' to have been called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected 'is_allowed' to have been called once. Called 0 times.

/usr/lib64/python3.12/unittest/mock.py:928: AssertionError

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestAuthRateLimitMiddleware object at 0x7d937db125d0>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='138072408442256'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    async def test_rate_limit_with_user_agent_tracking(self, mock_get_limiter):
        """Test rate limiting considers user agent."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(True, {}))
        mock_get_limiter.return_value = mock_limiter
    
        self.app.add_middleware(AuthRateLimitMiddleware)
        client = TestClient(self.app)
    
        response = client.post(
            "/auth/login",
            headers={"User-Agent": "TestBot/1.0"}
        )
    
        assert response.status_code == 200
        # Verify rate limiter was called
>       mock_limiter.is_allowed.assert_called_once()
E       AssertionError: Expected 'is_allowed' to have been called once. Called 0 times.

tests/test_middleware.py:361: AssertionError
____________ TestMiddlewareIntegration.test_both_middleware_applied ____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/unittest/mock.py", line 1396, in patched
    |     return func(*newargs, **newkeywargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 470, in test_both_middleware_applied
    |     response = self.client.post("/auth/login")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 470, in test_both_middleware_applied
    response = self.client.post("/auth/login")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareIntegration object at 0x7d937db12ae0>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='138072405635968'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    def test_both_middleware_applied(self, mock_get_limiter):
        """Test that both security and rate limiting middleware are applied."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(True, {}))
        mock_get_limiter.return_value = mock_limiter
    
>       response = self.client.post("/auth/login")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:470: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
../.local/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/middleware/auth_security.py:61: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7d937cb343b0>
request = <starlette.middleware.base._CachedRequest object at 0x7d937cb34a70>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d937cb704a0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
___ TestMiddlewareIntegration.test_security_headers_on_rate_limited_response ___
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/unittest/mock.py", line 1396, in patched
    |     return func(*newargs, **newkeywargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 488, in test_security_headers_on_rate_limited_response
    |     response = self.client.post("/auth/login")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 488, in test_security_headers_on_rate_limited_response
    response = self.client.post("/auth/login")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareIntegration object at 0x7d937db12690>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='138072406015968'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    def test_security_headers_on_rate_limited_response(self, mock_get_limiter):
        """Test that security headers are added even on rate limited responses."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(False, {"retry_after": 60}))
        mock_get_limiter.return_value = mock_limiter
    
>       response = self.client.post("/auth/login")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:488: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
../.local/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/middleware/auth_security.py:61: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7d937c8a6000>
request = <starlette.middleware.base._CachedRequest object at 0x7d937c8a4920>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d937c949300>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
___ TestMiddlewareIntegration.test_non_auth_endpoints_only_security_headers ____
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 498, in test_non_auth_endpoints_only_security_headers
    |     response = self.client.get("/api/data")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 498, in test_non_auth_endpoints_only_security_headers
    response = self.client.get("/api/data")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareIntegration object at 0x7d937db122d0>

    def test_non_auth_endpoints_only_security_headers(self):
        """Test that non-auth endpoints only get security headers."""
>       response = self.client.get("/api/data")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:498: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/middleware/auth_security.py:61: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7d937c8bbef0>
request = <starlette.middleware.base._CachedRequest object at 0x7d937c8bac00>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d937c9b80e0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
___________ TestMiddlewareIntegration.test_middleware_order_matters ____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/unittest/mock.py", line 1396, in patched
    |     return func(*newargs, **newkeywargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 516, in test_middleware_order_matters
    |     response = self.client.post("/auth/login")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 516, in test_middleware_order_matters
    response = self.client.post("/auth/login")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareIntegration object at 0x7d937db11ca0>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='138072403683584'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    def test_middleware_order_matters(self, mock_get_limiter):
        """Test that middleware order affects behavior."""
        # This test verifies that security headers are applied
        # even when rate limiting middleware intervenes
    
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(False, {"retry_after": 60}))
        mock_get_limiter.return_value = mock_limiter
    
>       response = self.client.post("/auth/login")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:516: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
../.local/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/middleware/auth_security.py:61: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7d937c55d4f0>
request = <starlette.middleware.base._CachedRequest object at 0x7d937c55f200>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d937cc59120>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
____________ TestMiddlewareIntegration.test_middleware_performance _____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 530, in test_middleware_performance
    |     response = self.client.get("/api/data")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 530, in test_middleware_performance
    response = self.client.get("/api/data")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareIntegration object at 0x7d937db11910>

    def test_middleware_performance(self):
        """Test middleware performance with multiple requests."""
        import time
    
        start_time = time.time()
    
        # Make multiple requests
        for _ in range(10):
>           response = self.client.get("/api/data")
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:530: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/middleware/auth_security.py:61: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7d937db10860>
request = <starlette.middleware.base._CachedRequest object at 0x7d937c8d00b0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d937c89a700>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
____________ TestMiddlewareEdgeCases.test_empty_app_with_middleware ____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 566, in test_empty_app_with_middleware
    |     response = client.get("/nonexistent")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 566, in test_empty_app_with_middleware
    response = client.get("/nonexistent")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareEdgeCases object at 0x7d937db135c0>

    def test_empty_app_with_middleware(self):
        """Test middleware with empty app (no routes)."""
        self.app.add_middleware(SecurityHeadersMiddleware)
    
        client = TestClient(self.app)
    
        # Should return 404 with security headers
>       response = client.get("/nonexistent")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:566: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7d937cb37620>
request = <starlette.middleware.base._CachedRequest object at 0x7d937cb36d20>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d937c89a480>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
________________ TestBasePlugin.test_base_plugin_initialization ________________

self = <tests.test_plugins.TestBasePlugin object at 0x7d937db4aed0>

    def test_base_plugin_initialization(self):
        """Test BasePlugin initialization."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
        config = {"param1": "value1", "param2": 123}
>       plugin = TestPlugin(config)
                 ^^^^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:53: TypeError
________________ TestBasePlugin.test_base_plugin_default_config ________________

self = <tests.test_plugins.TestBasePlugin object at 0x7d937db4a960>

    def test_base_plugin_default_config(self):
        """Test BasePlugin with default empty config."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:72: TypeError
___________ TestBasePlugin.test_base_plugin_get_configuration_schema ___________

self = <tests.test_plugins.TestBasePlugin object at 0x7d937db2cd40>

    @pytest.mark.asyncio
    async def test_base_plugin_get_configuration_schema(self):
        """Test default configuration schema."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:91: TypeError
_____________ TestBasePlugin.test_validate_configuration_no_schema _____________

self = <tests.test_plugins.TestBasePlugin object at 0x7d937db71850>

    @pytest.mark.asyncio
    async def test_validate_configuration_no_schema(self):
        """Test configuration validation with no schema."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:115: TypeError
____________ TestBasePlugin.test_validate_configuration_with_schema ____________

self = <tests.test_plugins.TestBasePlugin object at 0x7d937db71ac0>

    @pytest.mark.asyncio
    async def test_validate_configuration_with_schema(self):
        """Test configuration validation with custom schema."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            async def get_configuration_schema(self):
                return {
                    "type": "object",
                    "properties": {
                        "required_param": {"type": "string"},
                        "optional_param": {"type": "number"}
                    },
                    "required": ["required_param"]
                }
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:145: TypeError
___________ TestBasePlugin.test_validate_configuration_type_checking ___________

self = <tests.test_plugins.TestBasePlugin object at 0x7d937db71d30>

    @pytest.mark.asyncio
    async def test_validate_configuration_type_checking(self):
        """Test configuration validation with type checking."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            async def get_configuration_schema(self):
                return {
                    "type": "object",
                    "properties": {
                        "string_param": {"type": "string"},
                        "number_param": {"type": "number"},
                        "boolean_param": {"type": "boolean"},
                        "object_param": {"type": "object"},
                        "array_param": {"type": "array"}
                    }
                }
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:183: TypeError
__________ TestBasePlugin.test_validate_configuration_error_handling ___________

self = <tests.test_plugins.TestBasePlugin object at 0x7d937db71fa0>

    @pytest.mark.asyncio
    async def test_validate_configuration_error_handling(self):
        """Test configuration validation error handling."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            async def get_configuration_schema(self):
                raise Exception("Schema generation error")
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:218: TypeError
_________________ TestToolPlugin.test_tool_plugin_inheritance __________________

self = <tests.test_plugins.TestToolPlugin object at 0x7d937db72120>

    def test_tool_plugin_inheritance(self):
        """Test ToolPlugin inherits from BasePlugin."""
    
        class TestToolPlugin(ToolPlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            def get_tools(self):
                return [MockBaseTool("test_tool", "Test tool description")]
    
>       plugin = TestToolPlugin()
                 ^^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestToolPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:243: TypeError
_________________ TestToolPlugin.test_get_tools_implementation _________________

self = <tests.test_plugins.TestToolPlugin object at 0x7d937db72450>

    def test_get_tools_implementation(self):
        """Test get_tools implementation."""
    
        class TestToolPlugin(ToolPlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            def get_tools(self):
                return [
                    MockBaseTool("tool1", "First tool"),
                    MockBaseTool("tool2", "Second tool")
                ]
    
>       plugin = TestToolPlugin()
                 ^^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestToolPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:282: TypeError
_____________ TestWorkflowPlugin.test_workflow_plugin_inheritance ______________

self = <tests.test_plugins.TestWorkflowPlugin object at 0x7d937db72750>

    def test_workflow_plugin_inheritance(self):
        """Test WorkflowPlugin inherits from BasePlugin."""
    
        class TestWorkflowPlugin(WorkflowPlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            async def execute_workflow(self, workflow_id: str, params: dict):
                return {"result": "workflow executed"}
    
>       plugin = TestWorkflowPlugin()
                 ^^^^^^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestWorkflowPlugin without an implementation for abstract methods 'create_workflow', 'get_capabilities', 'shutdown'

tests/test_plugins.py:309: TypeError
_____________ TestPluginManager.test_plugin_manager_initialization _____________

self = <tests.test_plugins.TestPluginManager object at 0x7d937db72c60>

    def test_plugin_manager_initialization(self):
        """Test PluginManager initialization."""
        assert isinstance(self.plugin_manager.plugins, dict)
>       assert isinstance(self.plugin_manager.plugin_instances, dict)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'PluginManager' object has no attribute 'plugin_instances'

tests/test_plugins.py:340: AttributeError
_____________ TestPluginManager.test_get_plugin_directory_default ______________

self = <tests.test_plugins.TestPluginManager object at 0x7d937db72de0>

    def test_get_plugin_directory_default(self):
        """Test getting default plugin directory."""
>       plugins_dir = self.plugin_manager._get_plugin_directory()
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'PluginManager' object has no attribute '_get_plugin_directory'. Did you mean: 'plugins_directory'?

tests/test_plugins.py:345: AttributeError
______________ TestPluginManager.test_get_plugin_directory_custom ______________

self = <tests.test_plugins.TestPluginManager object at 0x7d937db72ff0>

    def test_get_plugin_directory_custom(self):
        """Test getting custom plugin directory."""
        with patch('chatter.services.plugins.settings') as mock_settings:
            mock_settings.plugins_directory = "/custom/plugins"
    
>           plugins_dir = self.plugin_manager._get_plugin_directory()
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           AttributeError: 'PluginManager' object has no attribute '_get_plugin_directory'. Did you mean: 'plugins_directory'?

tests/test_plugins.py:353: AttributeError
_____________ TestPluginManager.test_load_plugin_from_file_success _____________

self = <tests.test_plugins.TestPluginManager object at 0x7d937db73200>

        @pytest.mark.asyncio
        async def test_load_plugin_from_file_success(self):
            """Test successfully loading plugin from file."""
    
            # Create a temporary plugin file
            plugin_code = '''
    from chatter.services.plugins import ToolPlugin
    
    class TestFilePlugin(ToolPlugin):
        async def initialize(self):
            pass
    
        async def cleanup(self):
            pass
    
        async def health_check(self):
            return {"status": "healthy"}
    
        def get_tools(self):
            from tests.test_plugins import MockBaseTool
            return [MockBaseTool("file_tool", "Tool from file")]
    
    # Plugin entry point
    plugin_class = TestFilePlugin
    '''
    
            with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
                f.write(plugin_code)
                plugin_file = Path(f.name)
    
            try:
>               plugin_instance = await self.plugin_manager.load_plugin_from_file(
                                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                    plugin_file, "test_file_plugin", {}
                )
E               AttributeError: 'PluginManager' object has no attribute 'load_plugin_from_file'

tests/test_plugins.py:387: AttributeError
__________ TestPluginManager.test_load_plugin_from_file_missing_file ___________

self = <tests.test_plugins.TestPluginManager object at 0x7d937db73410>

    @pytest.mark.asyncio
    async def test_load_plugin_from_file_missing_file(self):
        """Test loading plugin from non-existent file."""
        non_existent_file = Path("/non/existent/plugin.py")
    
        with pytest.raises(PluginError, match="Plugin file not found"):
>           await self.plugin_manager.load_plugin_from_file(
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                non_existent_file, "missing_plugin", {}
            )
E           AttributeError: 'PluginManager' object has no attribute 'load_plugin_from_file'

tests/test_plugins.py:404: AttributeError
__________ TestPluginManager.test_load_plugin_from_file_syntax_error ___________

self = <tests.test_plugins.TestPluginManager object at 0x7d937db736b0>

        @pytest.mark.asyncio
        async def test_load_plugin_from_file_syntax_error(self):
            """Test loading plugin with syntax error."""
    
            # Create plugin file with syntax error
            plugin_code = '''
    from chatter.services.plugins import ToolPlugin
    
    class TestFilePlugin(ToolPlugin):
        async def initialize(self)
            # Missing colon - syntax error
            pass
    '''
    
            with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
                f.write(plugin_code)
                plugin_file = Path(f.name)
    
            try:
                with pytest.raises(PluginError, match="Failed to load plugin"):
>                   await self.plugin_manager.load_plugin_from_file(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                        plugin_file, "syntax_error_plugin", {}
                    )
E                   AttributeError: 'PluginManager' object has no attribute 'load_plugin_from_file'

tests/test_plugins.py:428: AttributeError
_________________ TestPluginManager.test_unload_plugin_success _________________

self = <tests.test_plugins.TestPluginManager object at 0x7d937db72f00>

    @pytest.mark.asyncio
    async def test_unload_plugin_success(self):
        """Test successfully unloading a plugin."""
    
        # Create a mock plugin instance
        mock_plugin = MagicMock()
        mock_plugin.cleanup = AsyncMock()
    
>       plugin_instance = PluginInstance(
            plugin_id="test_plugin",
            name="Test Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=mock_plugin,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:442: ValidationError
________________ TestPluginManager.test_unload_plugin_not_found ________________

self = <tests.test_plugins.TestPluginManager object at 0x7d937db72300>

    @pytest.mark.asyncio
    async def test_unload_plugin_not_found(self):
        """Test unloading non-existent plugin."""
>       result = await self.plugin_manager.unload_plugin("non_existent_plugin")
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'PluginManager' object has no attribute 'unload_plugin'. Did you mean: 'install_plugin'?

tests/test_plugins.py:464: AttributeError
______________ TestPluginManager.test_unload_plugin_cleanup_error ______________

self = <tests.test_plugins.TestPluginManager object at 0x7d937db71d90>

    @pytest.mark.asyncio
    async def test_unload_plugin_cleanup_error(self):
        """Test unloading plugin when cleanup fails."""
    
        mock_plugin = MagicMock()
        mock_plugin.cleanup = AsyncMock(side_effect=Exception("Cleanup failed"))
    
>       plugin_instance = PluginInstance(
            plugin_id="test_plugin",
            name="Test Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=mock_plugin,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:475: ValidationError
_____________________ TestPluginManager.test_list_plugins ______________________

self = <tests.test_plugins.TestPluginManager object at 0x7d937db71790>

    def test_list_plugins(self):
        """Test listing plugins."""
    
        # Add some mock plugin instances
>       plugin1 = PluginInstance(
            plugin_id="plugin1",
            name="Plugin 1",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=MagicMock(),
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'plugin1', ... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'plugin1', ... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:498: ValidationError
_________________ TestPluginManager.test_list_plugins_by_type __________________

self = <tests.test_plugins.TestPluginManager object at 0x7d937db738f0>

    def test_list_plugins_by_type(self):
        """Test listing plugins filtered by type."""
    
>       tool_plugin = PluginInstance(
            plugin_id="tool_plugin",
            name="Tool Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=MagicMock(),
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'tool_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'tool_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:532: ValidationError
________________ TestPluginManager.test_list_plugins_by_status _________________

self = <tests.test_plugins.TestPluginManager object at 0x7d937db73b00>

    def test_list_plugins_by_status(self):
        """Test listing plugins filtered by status."""
    
>       active_plugin = PluginInstance(
            plugin_id="active_plugin",
            name="Active Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=MagicMock(),
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'active_plu... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'active_plu... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:566: ValidationError
_________________ TestPluginManager.test_get_plugin_info_found _________________

self = <tests.test_plugins.TestPluginManager object at 0x7d937db73d10>

    def test_get_plugin_info_found(self):
        """Test getting plugin info for existing plugin."""
    
>       plugin = PluginInstance(
            plugin_id="test_plugin",
            name="Test Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=MagicMock(),
            config={"param": "value"},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T01:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T01:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T01:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:600: ValidationError
_______________ TestPluginManager.test_get_plugin_info_not_found _______________

self = <tests.test_plugins.TestPluginManager object at 0x7d937db73f20>

    def test_get_plugin_info_not_found(self):
        """Test getting plugin info for non-existent plugin."""
>       info = self.plugin_manager.get_plugin_info("non_existent")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'PluginManager' object has no attribute 'get_plugin_info'. Did you mean: '_get_plugin_lock'?

tests/test_plugins.py:619: AttributeError
________________ TestPluginManager.test_get_tools_from_plugins _________________

self = <tests.test_plugins.TestPluginManager object at 0x7d937dba0170>

    def test_get_tools_from_plugins(self):
        """Test getting tools from tool plugins."""
    
        # Create mock tool plugin
        mock_tool_plugin = MagicMock()
        mock_tool_plugin.get_tools.return_value = [
            MockBaseTool("tool1", "Tool 1"),
            MockBaseTool("tool2", "Tool 2")
        ]
    
>       tool_plugin = PluginInstance(
            plugin_id="tool_plugin",
            name="Tool Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=mock_tool_plugin,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'tool_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'tool_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:633: ValidationError
________ TestPluginManager.test_get_tools_from_plugins_inactive_ignored ________

self = <tests.test_plugins.TestPluginManager object at 0x7d937dba0380>

    def test_get_tools_from_plugins_inactive_ignored(self):
        """Test that inactive plugins are ignored when getting tools."""
    
        # Create inactive tool plugin
        mock_tool_plugin = MagicMock()
        mock_tool_plugin.get_tools.return_value = [MockBaseTool("tool1", "Tool 1")]
    
>       inactive_plugin = PluginInstance(
            plugin_id="inactive_plugin",
            name="Inactive Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ERROR,  # Inactive status
            plugin_object=mock_tool_plugin,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'inactive_p... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'inactive_p... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:674: ValidationError
_______________ TestPluginManager.test_health_check_all_plugins ________________

self = <tests.test_plugins.TestPluginManager object at 0x7d937dba0590>

    @pytest.mark.asyncio
    async def test_health_check_all_plugins(self):
        """Test health check for all plugins."""
    
        # Create mock plugins with health checks
        mock_plugin1 = MagicMock()
        mock_plugin1.health_check = AsyncMock(return_value={"status": "healthy"})
    
        mock_plugin2 = MagicMock()
        mock_plugin2.health_check = AsyncMock(return_value={"status": "degraded", "issues": ["slow response"]})
    
>       plugin1 = PluginInstance(
            plugin_id="plugin1",
            name="Plugin 1",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=mock_plugin1,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'plugin1', ... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'plugin1', ... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:703: ValidationError
_______________ TestPluginManager.test_health_check_plugin_error _______________

self = <tests.test_plugins.TestPluginManager object at 0x7d937dba0830>

    @pytest.mark.asyncio
    async def test_health_check_plugin_error(self):
        """Test health check when plugin health check fails."""
    
        mock_plugin = MagicMock()
        mock_plugin.health_check = AsyncMock(side_effect=Exception("Health check failed"))
    
>       plugin = PluginInstance(
            plugin_id="error_plugin",
            name="Error Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=mock_plugin,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'error_plug... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'error_plug... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:743: ValidationError
_________________ TestPluginIntegration.test_plugin_lifecycle __________________

self = <tests.test_plugins.TestPluginIntegration object at 0x7d937dba0aa0>

        @pytest.mark.asyncio
        async def test_plugin_lifecycle(self):
            """Test complete plugin lifecycle: load, activate, health check, unload."""
    
            # Create a temporary plugin file
            plugin_code = '''
    from chatter.services.plugins import ToolPlugin
    
    class LifecycleTestPlugin(ToolPlugin):
        def __init__(self, config=None):
            super().__init__(config)
            self.initialized = False
            self.cleaned_up = False
    
        async def initialize(self):
            self.initialized = True
    
        async def cleanup(self):
            self.cleaned_up = True
    
        async def health_check(self):
            return {
                "status": "healthy" if self.initialized and not self.cleaned_up else "error",
                "initialized": self.initialized,
                "cleaned_up": self.cleaned_up
            }
    
        def get_tools(self):
            from tests.test_plugins import MockBaseTool
            return [MockBaseTool("lifecycle_tool", "Test tool for lifecycle")]
    
    plugin_class = LifecycleTestPlugin
    '''
    
            with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
                f.write(plugin_code)
                plugin_file = Path(f.name)
    
            try:
                # Load plugin
>               plugin_instance = await self.plugin_manager.load_plugin_from_file(
                                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                    plugin_file, "lifecycle_plugin", {}
                )
E               AttributeError: 'PluginManager' object has no attribute 'load_plugin_from_file'

tests/test_plugins.py:811: AttributeError
____________ TestPluginIntegration.test_multiple_plugins_management ____________

self = <tests.test_plugins.TestPluginIntegration object at 0x7d937dba0c20>

        @pytest.mark.asyncio
        async def test_multiple_plugins_management(self):
            """Test managing multiple plugins simultaneously."""
    
            # Create multiple plugin files
            plugin_codes = {
                "plugin1": '''
    from chatter.services.plugins import ToolPlugin
    
    class Plugin1(ToolPlugin):
        async def initialize(self):
            pass
    
        async def cleanup(self):
            pass
    
        async def health_check(self):
            return {"status": "healthy", "plugin": "plugin1"}
    
        def get_tools(self):
            from tests.test_plugins import MockBaseTool
            return [MockBaseTool("plugin1_tool", "Tool from plugin 1")]
    
    plugin_class = Plugin1
    ''',
                "plugin2": '''
    from chatter.services.plugins import ToolPlugin
    
    class Plugin2(ToolPlugin):
        async def initialize(self):
            pass
    
        async def cleanup(self):
            pass
    
        async def health_check(self):
            return {"status": "healthy", "plugin": "plugin2"}
    
        def get_tools(self):
            from tests.test_plugins import MockBaseTool
            return [MockBaseTool("plugin2_tool", "Tool from plugin 2")]
    
    plugin_class = Plugin2
    '''
            }
    
            plugin_files = []
            try:
                # Create and load plugins
                for plugin_name, plugin_code in plugin_codes.items():
                    with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
                        f.write(plugin_code)
                        plugin_file = Path(f.name)
                        plugin_files.append(plugin_file)
    
>                   plugin_instance = await self.plugin_manager.load_plugin_from_file(
                                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                        plugin_file, plugin_name, {}
                    )
E                   AttributeError: 'PluginManager' object has no attribute 'load_plugin_from_file'

tests/test_plugins.py:897: AttributeError
____________ TestStreamingEvent.test_streaming_event_data_creation _____________

self = <tests.test_streaming.TestStreamingEvent object at 0x7d937d940920>

    def test_streaming_event_data_creation(self):
        """Test creating StreamingEvent."""
>       event_data = StreamingEvent(
            event_type=StreamingEventType.TOKEN,
            content="Hello",
            metadata={"token_id": 123},
            timestamp=1234567890.0
        )
E       TypeError: StreamingEvent.__init__() got an unexpected keyword argument 'event_type'

tests/test_streaming.py:45: TypeError
_____________ TestStreamingEvent.test_streaming_event_data_minimal _____________

self = <tests.test_streaming.TestStreamingEvent object at 0x7d937d940b00>

    def test_streaming_event_data_minimal(self):
        """Test creating StreamingEvent with minimal fields."""
>       event_data = StreamingEvent(
            event_type=StreamingEventType.START
        )
E       TypeError: StreamingEvent.__init__() got an unexpected keyword argument 'event_type'

tests/test_streaming.py:59: TypeError
_________ TestStreamingEvent.test_streaming_event_data_auto_timestamp __________

self = <tests.test_streaming.TestStreamingEvent object at 0x7d937d940ce0>

    def test_streaming_event_data_auto_timestamp(self):
        """Test that timestamp is automatically set if not provided."""
        before = time.time()
>       event_data = StreamingEvent(
            event_type=StreamingEventType.COMPLETE
        )
E       TypeError: StreamingEvent.__init__() got an unexpected keyword argument 'event_type'

tests/test_streaming.py:71: TypeError
__________ TestStreamingEvent.test_streaming_event_data_with_metadata __________

self = <tests.test_streaming.TestStreamingEvent object at 0x7d937d940ec0>

    def test_streaming_event_data_with_metadata(self):
        """Test StreamingEvent with complex metadata."""
        metadata = {
            "tool_name": "calculator",
            "input": {"a": 1, "b": 2},
            "result": {"sum": 3},
            "execution_time": 0.5
        }
    
>       event_data = StreamingEvent(
            event_type=StreamingEventType.TOOL_CALL_END,
            content="Tool execution completed",
            metadata=metadata
        )
E       TypeError: StreamingEvent.__init__() got an unexpected keyword argument 'event_type'

tests/test_streaming.py:87: TypeError
_____________________ TestStreamingService.test_end_stream _____________________

self = <tests.test_streaming.TestStreamingService object at 0x7d937d941f10>
mock_record_metrics = <MagicMock name='record_workflow_metrics' id='138072314647264'>

    @pytest.mark.asyncio
    @patch('chatter.services.streaming.record_workflow_metrics')
    async def test_end_stream(self, mock_record_metrics):
        """Test ending a stream and getting metrics."""
        stream_id = "end_test_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        # Simulate some activity
        self.service.active_streams[stream_id]["token_count"] = 100
        self.service.active_streams[stream_id]["event_count"] = 10
    
        # Wait a bit to have measurable duration
        await asyncio.sleep(0.01)
    
        # End stream
        metrics = await self.service.end_stream(stream_id)
    
        assert metrics["total_duration"] > 0
        assert metrics["tokens_per_second"] > 0
        assert metrics["events_per_second"] > 0
        assert stream_id not in self.service.active_streams
>       assert stream_id not in self.stream_metrics
                                ^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'TestStreamingService' object has no attribute 'stream_metrics'

tests/test_streaming.py:223: AttributeError
_________________ TestStreamingService.test_stream_event_basic _________________

self = <tests.test_streaming.TestStreamingService object at 0x7d937d941a60>

    @pytest.mark.asyncio
    async def test_stream_event_basic(self):
        """Test streaming a basic event."""
        stream_id = "event_test_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        # Create async generator for streaming
        async def stream_events():
            event_data = StreamingEvent(
                event_type=StreamingEventType.TOKEN,
                content="Hello",
                metadata={"token_id": 1}
            )
    
            async for chunk in self.service.stream_event(stream_id, event_data):
                yield chunk
    
        # Collect streamed events
        events = []
>       async for event in stream_events():

tests/test_streaming.py:259: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    async def stream_events():
>       event_data = StreamingEvent(
            event_type=StreamingEventType.TOKEN,
            content="Hello",
            metadata={"token_id": 1}
        )
E       TypeError: StreamingEvent.__init__() got an unexpected keyword argument 'event_type'

tests/test_streaming.py:248: TypeError
____________________ TestStreamingService.test_stream_token ____________________

self = <tests.test_streaming.TestStreamingService object at 0x7d937d941010>

    @pytest.mark.asyncio
    async def test_stream_token(self):
        """Test streaming a token event."""
        stream_id = "token_test_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="chat_completion"
        )
    
        token_content = "world"
    
        # Stream token
        events = []
>       async for chunk in self.service.stream_token(stream_id, token_content):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:283: AttributeError
_____________ TestStreamingService.test_stream_tool_call_lifecycle _____________

self = <tests.test_streaming.TestStreamingService object at 0x7d937d940680>

    @pytest.mark.asyncio
    async def test_stream_tool_call_lifecycle(self):
        """Test complete tool call streaming lifecycle."""
        stream_id = "tool_call_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="tool_execution"
        )
    
        tool_name = "calculator"
        tool_input = {"operation": "add", "a": 5, "b": 3}
        tool_result = {"result": 8}
    
        # Stream tool call start
        start_events = []
>       async for chunk in self.service.stream_tool_call_start(stream_id, tool_name, tool_input):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_tool_call_start'

tests/test_streaming.py:313: AttributeError
__________________ TestStreamingService.test_stream_thinking ___________________

self = <tests.test_streaming.TestStreamingService object at 0x7d937d942300>

    @pytest.mark.asyncio
    async def test_stream_thinking(self):
        """Test streaming thinking event."""
        stream_id = "thinking_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="reasoning"
        )
    
        thinking_content = "Let me analyze this problem..."
    
        # Stream thinking
        events = []
>       async for chunk in self.service.stream_thinking(stream_id, thinking_content):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_thinking'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:344: AttributeError
________________ TestStreamingService.test_stream_source_found _________________

self = <tests.test_streaming.TestStreamingService object at 0x7d937d9425a0>

    @pytest.mark.asyncio
    async def test_stream_source_found(self):
        """Test streaming source found event."""
        stream_id = "source_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="document_search"
        )
    
        source_info = {
            "title": "Test Document",
            "url": "https://example.com/doc",
            "relevance": 0.95
        }
    
        # Stream source found
        events = []
>       async for chunk in self.service.stream_source_found(stream_id, source_info):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_source_found'

tests/test_streaming.py:368: AttributeError
____________________ TestStreamingService.test_stream_error ____________________

self = <tests.test_streaming.TestStreamingService object at 0x7d937d942840>

    @pytest.mark.asyncio
    async def test_stream_error(self):
        """Test streaming error event."""
        stream_id = "error_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        error_message = "Test error occurred"
        error_details = {"error_code": "TEST_001", "retry": False}
    
        # Stream error
        events = []
>       async for chunk in self.service.stream_error(stream_id, error_message, error_details):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_error'

tests/test_streaming.py:389: AttributeError
__________________ TestStreamingService.test_stream_complete ___________________

self = <tests.test_streaming.TestStreamingService object at 0x7d937d942ae0>

    @pytest.mark.asyncio
    async def test_stream_complete(self):
        """Test streaming completion event."""
        stream_id = "complete_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        final_result = {"status": "success", "total_tokens": 150}
    
        # Stream completion
        events = []
>       async for chunk in self.service.stream_complete(stream_id, final_result):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_complete'

tests/test_streaming.py:413: AttributeError
__________________ TestStreamingService.test_stream_metadata ___________________

self = <tests.test_streaming.TestStreamingService object at 0x7d937d942d80>

    @pytest.mark.asyncio
    async def test_stream_metadata(self):
        """Test streaming metadata event."""
        stream_id = "metadata_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        metadata = {
            "model": "gpt-4",
            "temperature": 0.7,
            "max_tokens": 500
        }
    
        # Stream metadata
        events = []
>       async for chunk in self.service.stream_metadata(stream_id, metadata):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_metadata'. Did you mean: 'stream_metrics'?

tests/test_streaming.py:437: AttributeError
_________________ TestStreamingService.test_get_stream_metrics _________________

self = <tests.test_streaming.TestStreamingService object at 0x7d937d943020>

    @pytest.mark.asyncio
    async def test_get_stream_metrics(self):
        """Test getting stream metrics."""
        stream_id = "metrics_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        # Simulate some activity
        self.service.active_streams[stream_id]["token_count"] = 50
        self.service.active_streams[stream_id]["event_count"] = 5
    
        # Get metrics
>       metrics = self.service.get_stream_metrics(stream_id)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'get_stream_metrics'. Did you mean: 'stream_metrics'?

tests/test_streaming.py:458: AttributeError
___________ TestStreamingService.test_get_nonexistent_stream_metrics ___________

self = <tests.test_streaming.TestStreamingService object at 0x7d937d9432c0>

    @pytest.mark.asyncio
    async def test_get_nonexistent_stream_metrics(self):
        """Test getting metrics for nonexistent stream."""
>       metrics = self.service.get_stream_metrics("nonexistent")
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'get_stream_metrics'. Did you mean: 'stream_metrics'?

tests/test_streaming.py:468: AttributeError
________________ TestStreamingService.test_list_active_streams _________________

self = <tests.test_streaming.TestStreamingService object at 0x7d937d943560>

    @pytest.mark.asyncio
    async def test_list_active_streams(self):
        """Test listing active streams."""
        # Initially no streams
>       streams = self.service.list_active_streams()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'list_active_streams'. Did you mean: 'active_streams'?

tests/test_streaming.py:476: AttributeError
__________________ TestStreamingService.test_is_stream_active __________________

self = <tests.test_streaming.TestStreamingService object at 0x7d937d943800>

    @pytest.mark.asyncio
    async def test_is_stream_active(self):
        """Test checking if stream is active."""
        stream_id = "active_check_stream"
    
        # Stream doesn't exist
>       assert self.service.is_stream_active(stream_id) is False
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'is_stream_active'

tests/test_streaming.py:494: AttributeError
______________ TestStreamingService.test_stream_activity_tracking ______________

self = <tests.test_streaming.TestStreamingService object at 0x7d937d943aa0>

    @pytest.mark.asyncio
    async def test_stream_activity_tracking(self):
        """Test that stream activity is properly tracked."""
        stream_id = "activity_stream"
    
        # Create stream
        await self.service.create_stream(stream_id, "test_workflow")
    
        initial_activity = self.service.active_streams[stream_id]["last_activity"]
    
        # Wait a bit
        await asyncio.sleep(0.01)
    
        # Stream a token (should update last_activity)
>       async for _ in self.service.stream_token(stream_id, "test"):
                       ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:522: AttributeError
________ TestStreamingService.test_stream_error_handling_invalid_stream ________

self = <tests.test_streaming.TestStreamingService object at 0x7d937d96c0b0>

    @pytest.mark.asyncio
    async def test_stream_error_handling_invalid_stream(self):
        """Test error handling when streaming to invalid stream."""
        with pytest.raises(StreamingError):
>           async for _ in self.service.stream_token("invalid_stream", "test"):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^
E           AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:533: AttributeError
_________________ TestStreamingService.test_concurrent_streams _________________

self = <tests.test_streaming.TestStreamingService object at 0x7d937d96c2c0>

    @pytest.mark.asyncio
    async def test_concurrent_streams(self):
        """Test handling multiple concurrent streams."""
        stream_ids = ["concurrent1", "concurrent2", "concurrent3"]
    
        # Create multiple streams concurrently
        create_tasks = [
            self.service.create_stream(stream_id, f"workflow_{i}")
            for i, stream_id in enumerate(stream_ids)
        ]
        await asyncio.gather(*create_tasks)
    
        # Verify all streams are active
        for stream_id in stream_ids:
>           assert self.service.is_stream_active(stream_id)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           AttributeError: 'StreamingService' object has no attribute 'is_stream_active'

tests/test_streaming.py:550: AttributeError
______________ TestStreamingService.test_stream_cleanup_on_error _______________

self = <tests.test_streaming.TestStreamingService object at 0x7d937d943fe0>

    @pytest.mark.asyncio
    async def test_stream_cleanup_on_error(self):
        """Test stream cleanup when errors occur."""
        stream_id = "cleanup_stream"
    
        # Create stream
        await self.service.create_stream(stream_id, "test_workflow")
    
        # Simulate an error during streaming
>       with patch.object(self.service, 'stream_event', side_effect=StreamingError("Test error")):
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_streaming.py:574: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7d937c55ecf0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <chatter.services.streaming.StreamingService object at 0x7d937c55c2f0> does not have the attribute 'stream_event'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
_______ TestStreamingServiceIntegration.test_complete_streaming_workflow _______

self = <tests.test_streaming.TestStreamingServiceIntegration object at 0x7d937d9435c0>

    @pytest.mark.asyncio
    async def test_complete_streaming_workflow(self):
        """Test complete streaming workflow from start to finish."""
        stream_id = "complete_workflow_stream"
        workflow_type = "chat_completion"
    
        # 1. Create stream
        await self.service.create_stream(stream_id, workflow_type)
>       assert self.service.is_stream_active(stream_id)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'is_stream_active'

tests/test_streaming.py:599: AttributeError
_________ TestStreamingServiceIntegration.test_error_recovery_workflow _________

self = <tests.test_streaming.TestStreamingServiceIntegration object at 0x7d937d9431d0>

    @pytest.mark.asyncio
    async def test_error_recovery_workflow(self):
        """Test streaming workflow with error recovery."""
        stream_id = "error_recovery_stream"
    
        # Create stream
        await self.service.create_stream(stream_id, "error_recovery_test")
    
        # Stream some successful events
>       async for _ in self.service.stream_token(stream_id, "Success"):
                       ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:659: AttributeError
_ TestStreamingServiceIntegration.test_performance_with_high_volume_streaming __

self = <tests.test_streaming.TestStreamingServiceIntegration object at 0x7d937d942b10>

    @pytest.mark.asyncio
    async def test_performance_with_high_volume_streaming(self):
        """Test streaming performance with high volume of events."""
        stream_id = "high_volume_stream"
    
        # Create stream
        await self.service.create_stream(stream_id, "performance_test")
    
        # Stream many tokens quickly
        start_time = time.time()
    
        for i in range(100):  # Stream 100 tokens
>           async for _ in self.service.stream_token(stream_id, f"token_{i}"):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^
E           AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:697: AttributeError
____________ TestStreamingServiceIntegration.test_stream_isolation _____________

self = <tests.test_streaming.TestStreamingServiceIntegration object at 0x7d937d942600>

    @pytest.mark.asyncio
    async def test_stream_isolation(self):
        """Test that streams are properly isolated from each other."""
        stream1_id = "isolation_stream_1"
        stream2_id = "isolation_stream_2"
    
        # Create two streams
        await self.service.create_stream(stream1_id, "workflow1")
        await self.service.create_stream(stream2_id, "workflow2")
    
        # Stream different content to each
>       async for _ in self.service.stream_token(stream1_id, "stream1_content"):
                       ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:722: AttributeError
____________ TestAPIVersion.test_api_version_string_representation _____________

self = <tests.test_versioning.TestAPIVersion object at 0x7d937d9df830>

    def test_api_version_string_representation(self):
        """Test API version string representation."""
>       assert str(APIVersion.V1) == "v1"
E       AssertionError: assert 'APIVersion.V1' == 'v1'
E         
E         - v1
E         + APIVersion.V1

tests/test_versioning.py:27: AssertionError
_________________ TestVersionStatus.test_version_status_values _________________

self = <tests.test_versioning.TestVersionStatus object at 0x7d937d9dd9a0>

    def test_version_status_values(self):
        """Test version status enum values."""
        assert VersionStatus.ACTIVE == "active"
>       assert VersionStatus.DEPRECATED == "deprecated"
               ^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: type object 'VersionStatus' has no attribute 'DEPRECATED'

tests/test_versioning.py:37: AttributeError
______________ TestVersionStatus.test_version_status_progression _______________

self = <tests.test_versioning.TestVersionStatus object at 0x7d937d9dc800>

    def test_version_status_progression(self):
        """Test logical version status progression."""
>       statuses = [VersionStatus.ACTIVE, VersionStatus.DEPRECATED, VersionStatus.SUNSET]
                                          ^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: type object 'VersionStatus' has no attribute 'DEPRECATED'

tests/test_versioning.py:42: AttributeError
___________ TestEndpointVersioning.test_endpoint_versioning_creation ___________

self = <tests.test_versioning.TestEndpointVersioning object at 0x7d937d9dfda0>

    def test_endpoint_versioning_creation(self):
        """Test creating EndpointVersioning."""
        endpoint = EndpointVersioning(
            path="/api/users",
            method="GET",
            introduced_in=APIVersion.V1,
            deprecated_in=APIVersion.V2,
            removed_in=None
        )
    
        assert endpoint.path == "/api/users"
        assert endpoint.method == "GET"
        assert endpoint.introduced_in == APIVersion.V1
>       assert endpoint.deprecated_in == APIVersion.V2
               ^^^^^^^^^^^^^^^^^^^^^^

tests/test_versioning.py:101: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = EndpointVersioning(path='/api/users', method='GET', introduced_in=<APIVersion.V1: 'v1'>, removed_in=None, changes={})
item = 'deprecated_in'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'EndpointVersioning' object has no attribute 'deprecated_in'

../.local/lib/python3.12/site-packages/pydantic/main.py:991: AttributeError
__________ TestEndpointVersioning.test_endpoint_versioning_lifecycle ___________

self = <tests.test_versioning.TestEndpointVersioning object at 0x7d937d9fc110>

    def test_endpoint_versioning_lifecycle(self):
        """Test endpoint lifecycle through versions."""
        # Endpoint introduced in V1, deprecated in V2, removed in hypothetical V3
        endpoint = EndpointVersioning(
            path="/api/legacy",
            method="POST",
            introduced_in=APIVersion.V1,
            deprecated_in=APIVersion.V2,
            removed_in=APIVersion.V2  # Removed in V2 (immediately deprecated and removed)
        )
    
        assert endpoint.introduced_in == APIVersion.V1
>       assert endpoint.deprecated_in == APIVersion.V2
               ^^^^^^^^^^^^^^^^^^^^^^

tests/test_versioning.py:116: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = EndpointVersioning(path='/api/legacy', method='POST', introduced_in=<APIVersion.V1: 'v1'>, removed_in=<APIVersion.V2: 'v2'>, changes={})
item = 'deprecated_in'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'EndpointVersioning' object has no attribute 'deprecated_in'

../.local/lib/python3.12/site-packages/pydantic/main.py:991: AttributeError
______________ TestAPIVersionManager.test_default_versions_loaded ______________

self = <tests.test_versioning.TestAPIVersionManager object at 0x7d937d9fc440>

    def test_default_versions_loaded(self):
        """Test that default versions are properly loaded."""
        # V1 should exist
        v1_info = self.manager.get_version_info(APIVersion.V1)
        assert v1_info is not None
        assert v1_info.version == APIVersion.V1
>       assert v1_info.status == VersionStatus.DEPRECATED
                                 ^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: type object 'VersionStatus' has no attribute 'DEPRECATED'

tests/test_versioning.py:142: AttributeError
________ TestAPIVersionManager.test_is_endpoint_available_unregistered _________

self = <tests.test_versioning.TestAPIVersionManager object at 0x7d937d9fc4d0>

    def test_is_endpoint_available_unregistered(self):
        """Test endpoint availability for unregistered endpoint."""
        is_available = self.manager.is_endpoint_available(
            "/api/nonexistent", "GET", APIVersion.V1
        )
        # Unregistered endpoints should be considered available
>       assert is_available is True
E       assert False is True

tests/test_versioning.py:335: AssertionError
________________ TestAPIVersionManager.test_deprecate_endpoint _________________

self = <tests.test_versioning.TestAPIVersionManager object at 0x7d937d9fdca0>

    def test_deprecate_endpoint(self):
        """Test deprecating an endpoint."""
        # Register endpoint
        self.manager.register_endpoint(
            path="/api/to-deprecate",
            method="GET",
            introduced_in=APIVersion.V1
        )
    
        # Deprecate endpoint
>       self.manager.deprecate_endpoint(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            "/api/to-deprecate", "GET", APIVersion.V2
        )
E       AttributeError: 'APIVersionManager' object has no attribute 'deprecate_endpoint'

tests/test_versioning.py:347: AttributeError
__________ TestAPIVersionManager.test_deprecate_nonexistent_endpoint ___________

self = <tests.test_versioning.TestAPIVersionManager object at 0x7d937d9fdeb0>

    def test_deprecate_nonexistent_endpoint(self):
        """Test deprecating a non-existent endpoint."""
        # Should not raise error
>       self.manager.deprecate_endpoint(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            "/api/nonexistent", "GET", APIVersion.V2
        )
E       AttributeError: 'APIVersionManager' object has no attribute 'deprecate_endpoint'

tests/test_versioning.py:358: AttributeError
_________________ TestAPIVersionManager.test_get_endpoint_info _________________

self = <tests.test_versioning.TestAPIVersionManager object at 0x7d937d9fe0c0>

    def test_get_endpoint_info(self):
        """Test getting endpoint information."""
        # Register endpoint
        self.manager.register_endpoint(
            path="/api/info-test",
            method="POST",
            introduced_in=APIVersion.V1,
            removed_in=APIVersion.V2
        )
    
>       endpoint_info = self.manager.get_endpoint_info(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            "/api/info-test", "POST"
        )
E       AttributeError: 'APIVersionManager' object has no attribute 'get_endpoint_info'. Did you mean: 'get_endpoint_status'?

tests/test_versioning.py:376: AttributeError
___________ TestAPIVersionManager.test_get_endpoint_info_nonexistent ___________

self = <tests.test_versioning.TestAPIVersionManager object at 0x7d937d9fe2d0>

    def test_get_endpoint_info_nonexistent(self):
        """Test getting info for non-existent endpoint."""
>       endpoint_info = self.manager.get_endpoint_info(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            "/api/nonexistent", "GET"
        )
E       AttributeError: 'APIVersionManager' object has no attribute 'get_endpoint_info'. Did you mean: 'get_endpoint_status'?

tests/test_versioning.py:388: AttributeError
_____________ TestAPIVersionManager.test_get_endpoints_for_version _____________

self = <tests.test_versioning.TestAPIVersionManager object at 0x7d937d9fe4e0>

    def test_get_endpoints_for_version(self):
        """Test getting all endpoints available for a version."""
        # Register multiple endpoints
        endpoints_to_register = [
            ("/api/v1-only", "GET", APIVersion.V1, APIVersion.V2),
            ("/api/v1-v2", "GET", APIVersion.V1, None),
            ("/api/v2-only", "GET", APIVersion.V2, None),
        ]
    
        for path, method, introduced, removed in endpoints_to_register:
            self.manager.register_endpoint(
                path=path,
                method=method,
                introduced_in=introduced,
                removed_in=removed
            )
    
        # Get endpoints for V1
>       v1_endpoints = self.manager.get_endpoints_for_version(APIVersion.V1)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'APIVersionManager' object has no attribute 'get_endpoints_for_version'

tests/test_versioning.py:412: AttributeError
__________ TestAPIVersionManager.test_version_middleware_integration ___________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_versioning.py", line 470, in test_version_middleware_integration
    |     response = client.get("/api/test", headers={"API-Version": "v1"})
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_versioning.py", line 446, in version_middleware
    |     raise HTTPException(
    | fastapi.exceptions.HTTPException: 400: API version v1 is not supported
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_versioning.py", line 470, in test_version_middleware_integration
    response = client.get("/api/test", headers={"API-Version": "v1"})
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/tests/test_versioning.py", line 446, in version_middleware
    raise HTTPException(
fastapi.exceptions.HTTPException: 400: API version v1 is not supported

During handling of the above exception, another exception occurred:

self = <tests.test_versioning.TestAPIVersionManager object at 0x7d937d9fe6f0>

    def test_version_middleware_integration(self):
        """Test integration with versioning middleware."""
        app = FastAPI()
    
        @app.get("/api/test")
        async def test_endpoint():
            return {"message": "test"}
    
        # Add versioning middleware
        @app.middleware("http")
        async def version_middleware(request: Request, call_next):
            # Extract version from header
            api_version = request.headers.get("API-Version", "v1")
    
            # Validate version
            version_enum = APIVersion.V1 if api_version == "v1" else APIVersion.V2
    
            if not self.manager.is_version_supported(version_enum):
                from fastapi import HTTPException
                raise HTTPException(
                    status_code=400,
                    detail=f"API version {api_version} is not supported"
                )
    
            response = await call_next(request)
            response.headers["API-Version"] = api_version
            return response
    
        client = TestClient(app)
    
        # Test with supported version
        response = client.get("/api/test", headers={"API-Version": "v2"})
        assert response.status_code == 200
        assert response.headers["API-Version"] == "v2"
    
        # Test with unsupported version (after making V1 sunset)
        sunset_v1 = VersionInfo(
            version=APIVersion.V1,
            status=VersionStatus.SUNSET,
            release_date="2023-01-01"
        )
        self.manager.add_version(sunset_v1)
    
>       response = client.get("/api/test", headers={"API-Version": "v1"})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_versioning.py:470: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

request = <starlette.middleware.base._CachedRequest object at 0x7d937c93aa20>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7d937c1096c0>

    @app.middleware("http")
    async def version_middleware(request: Request, call_next):
        # Extract version from header
        api_version = request.headers.get("API-Version", "v1")
    
        # Validate version
        version_enum = APIVersion.V1 if api_version == "v1" else APIVersion.V2
    
        if not self.manager.is_version_supported(version_enum):
            from fastapi import HTTPException
>           raise HTTPException(
                status_code=400,
                detail=f"API version {api_version} is not supported"
            )
E           fastapi.exceptions.HTTPException: 400: API version v1 is not supported

tests/test_versioning.py:446: HTTPException
__________ TestVersioningIntegration.test_complete_version_lifecycle ___________

self = <tests.test_versioning.TestVersioningIntegration object at 0x7d937d9fe900>

    def test_complete_version_lifecycle(self):
        """Test complete version lifecycle management."""
        # 1. Add a new version
        v3_info = VersionInfo(
            version=APIVersion.V2,  # Override V2 for testing
            status=VersionStatus.ACTIVE,
            release_date="2024-12-01",
            documentation_url="https://api.example.com/docs/v3",
            breaking_changes=["Restructured response format"],
            new_features=["Real-time streaming", "Enhanced security"]
        )
        self.manager.add_version(v3_info)
    
        # 2. Register endpoints for different versions
        self.manager.register_endpoint("/api/legacy", "GET", APIVersion.V1, APIVersion.V2)
        self.manager.register_endpoint("/api/stable", "GET", APIVersion.V1)
        self.manager.register_endpoint("/api/new", "GET", APIVersion.V2)
    
        # 3. Deprecate an endpoint
>       self.manager.deprecate_endpoint("/api/stable", "GET", APIVersion.V2)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'APIVersionManager' object has no attribute 'deprecate_endpoint'

tests/test_versioning.py:501: AttributeError
__________ TestVersioningIntegration.test_version_migration_scenario ___________

self = <tests.test_versioning.TestVersioningIntegration object at 0x7d937d9fea80>

    def test_version_migration_scenario(self):
        """Test a realistic version migration scenario."""
        # Scenario: Migrating from V1 to V2 with gradual deprecation
    
        # 1. Start with V1 as active, V2 as new
        v1_info = VersionInfo(
            version=APIVersion.V1,
            status=VersionStatus.ACTIVE,
            release_date="2023-01-01",
            documentation_url="https://api.example.com/docs/v1"
        )
        self.manager.add_version(v1_info)
    
        # 2. Register endpoints that exist in V1
        legacy_endpoints = [
            "/api/users",
            "/api/posts",
            "/api/comments"
        ]
    
        for endpoint in legacy_endpoints:
            self.manager.register_endpoint(endpoint, "GET", APIVersion.V1)
            self.manager.register_endpoint(endpoint, "POST", APIVersion.V1)
    
        # 3. Add V2 with some endpoints deprecated/changed
        v2_info = VersionInfo(
            version=APIVersion.V2,
            status=VersionStatus.ACTIVE,
            release_date="2024-06-01",
            documentation_url="https://api.example.com/docs/v2",
            breaking_changes=[
                "Removed /api/comments endpoint",
                "Changed /api/posts response format"
            ],
            new_features=[
                "Added /api/threads endpoint",
                "Enhanced /api/users with filtering"
            ]
        )
        self.manager.add_version(v2_info)
    
        # 4. Register V2 changes
        self.manager.register_endpoint("/api/comments", "GET", APIVersion.V1, APIVersion.V2)  # Removed in V2
        self.manager.register_endpoint("/api/threads", "GET", APIVersion.V2)  # New in V2
>       self.manager.deprecate_endpoint("/api/posts", "POST", APIVersion.V2)  # Deprecated in V2
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'APIVersionManager' object has no attribute 'deprecate_endpoint'

tests/test_versioning.py:559: AttributeError
_______ TestVersioningIntegration.test_backwards_compatibility_checking ________

self = <tests.test_versioning.TestVersioningIntegration object at 0x7d937d9fec90>

    def test_backwards_compatibility_checking(self):
        """Test backwards compatibility validation."""
        # Register endpoints in V1
        self.manager.register_endpoint("/api/stable", "GET", APIVersion.V1)
        self.manager.register_endpoint("/api/changing", "GET", APIVersion.V1, APIVersion.V2)
    
        # Get compatibility report
>       v1_endpoints = self.manager.get_endpoints_for_version(APIVersion.V1)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'APIVersionManager' object has no attribute 'get_endpoints_for_version'

tests/test_versioning.py:597: AttributeError
________ TestWorkflowExecutionService.test_execute_workflow_with_limits ________

self = <tests.test_workflow_limits_and_streaming.TestWorkflowExecutionService object at 0x7d937d9ffe30>

    @pytest.mark.asyncio
    async def test_execute_workflow_with_limits(self):
        """Test workflow execution with resource limits."""
        # Mock LLM response
        mock_response = MagicMock()
        mock_response.content = "Test response"
    
        mock_provider = AsyncMock()
        mock_provider.ainvoke.return_value = mock_response
        mock_provider.__class__.__name__ = "TestProvider"
    
        self.llm_service.get_default_provider.return_value = mock_provider
        self.llm_service.convert_conversation_to_messages.return_value = []
    
        # Mock message service
        self.workflow_service._get_conversation_messages = AsyncMock(return_value=[])
    
        # Define custom limits
        limits = WorkflowLimits(
            execution_timeout=60,
            step_timeout=30,
            streaming_timeout=120,
            max_tokens=1000,
            max_memory_mb=512,
            max_concurrent=5,
        )
    
        # Execute workflow
        result_message, usage_info = await self.workflow_service.execute_workflow(
            self.conversation,
            self.chat_request,
            self.correlation_id,
            user_id="user_123",
            limits=limits,
        )
    
        # Verify result
        assert result_message.content == "Test response"
>       assert result_message.role == MessageRole.ASSISTANT
E       AssertionError: assert <MagicMock name='mock.role' id='138072403103280'> == <MessageRole.ASSISTANT: 'assistant'>
E        +  where <MagicMock name='mock.role' id='138072403103280'> = <MagicMock id='138072314467136'>.role
E        +  and   <MessageRole.ASSISTANT: 'assistant'> = MessageRole.ASSISTANT

tests/test_workflow_limits_and_streaming.py:237: AssertionError
__________ TestWorkflowExecutionService.test_execute_workflow_timeout __________

self = <tests.test_workflow_limits_and_streaming.TestWorkflowExecutionService object at 0x7d937d81c290>

    @pytest.mark.asyncio
    async def test_execute_workflow_timeout(self):
        """Test workflow execution timeout."""
        # Mock slow LLM response
        async def slow_invoke(*args, **kwargs):
            await asyncio.sleep(2)  # Simulate slow response
            mock_response = MagicMock()
            mock_response.content = "Test response"
            return mock_response
    
        mock_provider = AsyncMock()
        mock_provider.ainvoke = slow_invoke
        mock_provider.__class__.__name__ = "TestProvider"
    
        self.llm_service.get_default_provider.return_value = mock_provider
        self.llm_service.convert_conversation_to_messages.return_value = []
        self.workflow_service._get_conversation_messages = AsyncMock(return_value=[])
    
        # Define short timeout
        limits = WorkflowLimits(
            execution_timeout=1,  # 1 second timeout
            step_timeout=30,
            streaming_timeout=120,
            max_tokens=1000,
            max_memory_mb=512,
            max_concurrent=5,
        )
    
        # Should timeout
>       with pytest.raises(WorkflowTimeoutError) as exc_info:
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       Failed: DID NOT RAISE <class 'chatter.core.workflow_limits.WorkflowTimeoutError'>

tests/test_workflow_limits_and_streaming.py:269: Failed
_______ TestWorkflowExecutionService.test_streaming_workflow_with_limits _______

self = <tests.test_workflow_limits_and_streaming.TestWorkflowExecutionService object at 0x7d937d81c7d0>

    @pytest.mark.asyncio
    async def test_streaming_workflow_with_limits(self):
        """Test streaming workflow execution with resource limits."""
        # Mock streaming response
        mock_provider = AsyncMock()
        mock_provider.__class__.__name__ = "TestProvider"
    
        # Mock astream method for native streaming
        async def mock_astream(messages):
            chunks = [
                MagicMock(content="Hello"),
                MagicMock(content=" "),
                MagicMock(content="world"),
            ]
            for chunk in chunks:
                yield chunk
    
        mock_provider.astream = mock_astream
    
        self.llm_service.get_default_provider.return_value = mock_provider
        self.llm_service.convert_conversation_to_messages.return_value = []
        self.workflow_service._get_conversation_messages = AsyncMock(return_value=[])
    
        # Mock the workflow manager to avoid the 'str' object astream issue
>       with patch('chatter.services.workflow_execution.get_workflow_manager') as mock_get_manager:
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_workflow_limits_and_streaming.py:355: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7d937c1e1a30>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.services.workflow_execution' from '/home/yam/chatter/chatter/services/workflow_execution.py'> does not have the attribute 'get_workflow_manager'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
_________ TestWorkflowExecutionService.test_streaming_workflow_timeout _________

self = <tests.test_workflow_limits_and_streaming.TestWorkflowExecutionService object at 0x7d937d81ca70>

    @pytest.mark.asyncio
    async def test_streaming_workflow_timeout(self):
        """Test streaming workflow timeout."""
        # Mock workflow manager to avoid the 'str' object astream issue
>       with patch('chatter.services.workflow_execution.get_workflow_manager') as mock_get_manager:
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_workflow_limits_and_streaming.py:406: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7d937c49b350>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.services.workflow_execution' from '/home/yam/chatter/chatter/services/workflow_execution.py'> does not have the attribute 'get_workflow_manager'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
___ TestWorkflowExecutionService.test_enhanced_token_streaming_all_workflows ___

self = <chatter.core.workflow_executors.RAGWorkflowExecutor object at 0x7d937c2149e0>
conversation = <MagicMock spec='Conversation' id='138072396666720'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='rag', provider=None...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute_streaming(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> AsyncGenerator[StreamingChatChunk, None]:
        """Execute RAG workflow with streaming."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Get retriever from workflow manager
            workflow_manager = get_workflow_manager()
            retriever = workflow_manager.get_retriever(
>               conversation.workspace_id if conversation.workspace_id else "default"
                                             ^^^^^^^^^^^^^^^^^^^^^^^^^
            )

chatter/core/workflow_executors.py:431: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <MagicMock spec='Conversation' id='138072396666720'>
name = 'workspace_id'

    def __getattr__(self, name):
        if name in {'_mock_methods', '_mock_unsafe'}:
            raise AttributeError(name)
        elif self._mock_methods is not None:
            if name not in self._mock_methods or name in _all_magics:
>               raise AttributeError("Mock object has no attribute %r" % name)
E               AttributeError: Mock object has no attribute 'workspace_id'

/usr/lib64/python3.12/unittest/mock.py:660: AttributeError

The above exception was the direct cause of the following exception:

self = <tests.test_workflow_limits_and_streaming.TestWorkflowExecutionService object at 0x7d937d81cd10>

    @pytest.mark.asyncio
    async def test_enhanced_token_streaming_all_workflows(self):
        """Test enhanced token streaming for all workflow types."""
        # Mock workflow manager
        with patch('chatter.core.dependencies.get_workflow_manager') as mock_get_manager:
            mock_workflow_manager = MagicMock()
            mock_get_manager.return_value = mock_workflow_manager
    
            # Mock streaming workflow response
            async def mock_stream_workflow(workflow_type, state):
                events = [
                    {"type": "thinking", "thought": "Processing..."},
                    {"type": "token", "content": "Test"},
                    {"type": "token", "content": " response"},
                    {"type": "complete", "usage": {"tokens": 2}},
                ]
                for event in events:
                    yield event
    
            mock_workflow_manager.stream_workflow = mock_stream_workflow
    
            self.workflow_service._get_conversation_messages = AsyncMock(return_value=[])
    
            limits = WorkflowLimits(
                execution_timeout=60,
                step_timeout=30,
                streaming_timeout=120,
                max_tokens=1000,
                max_memory_mb=512,
                max_concurrent=5,
            )
    
            # Test different workflow types
            for workflow_type in ["rag", "tools", "full"]:
                self.chat_request.workflow = workflow_type
    
                chunks = []
>               async for chunk in self.workflow_service.execute_workflow_streaming(
                    self.conversation,
                    self.chat_request,
                    self.correlation_id,
                    user_id="user_123",
                    limits=limits,
                ):

tests/test_workflow_limits_and_streaming.py:487: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/services/workflow_execution.py:121: in execute_workflow_streaming
    async for chunk in executor.execute_streaming(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.core.workflow_executors.RAGWorkflowExecutor object at 0x7d937c2149e0>
conversation = <MagicMock spec='Conversation' id='138072396666720'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='rag', provider=None...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute_streaming(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> AsyncGenerator[StreamingChatChunk, None]:
        """Execute RAG workflow with streaming."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Get retriever from workflow manager
            workflow_manager = get_workflow_manager()
            retriever = workflow_manager.get_retriever(
                conversation.workspace_id if conversation.workspace_id else "default"
            )
    
            # Create streaming RAG workflow
            workflow = await self.llm_service.create_langgraph_workflow(
                provider_name=chat_request.provider,
                workflow_type=self.workflow_type,
                retriever=retriever,
                enable_memory=True,
                memory_window=30,
                max_documents=10,
                system_message=chat_request.system_prompt_override,
            )
    
            # Prepare conversation state
            messages = []
            recent_messages = await self.message_service.get_recent_messages(
                conversation.id, limit=30
            )
    
            for msg in recent_messages:
                if msg.role == MessageRole.USER:
                    messages.append({"role": "human", "content": msg.content})
                elif msg.role == MessageRole.ASSISTANT:
                    messages.append({"role": "ai", "content": msg.content})
    
            messages.append({"role": "human", "content": chat_request.message})
            state = ConversationState(messages=messages)
    
            # Stream workflow execution
            content_buffer = ""
            async for event in workflow.astream(
                state, {"configurable": {"thread_id": conversation.id}}
            ):
                if "messages" in event:
                    message = event["messages"][-1]
                    if hasattr(message, "content") and message.content:
                        # Extract new content since last chunk
                        if len(message.content) > len(content_buffer):
                            new_content = message.content[len(content_buffer):]
                            content_buffer = message.content
    
                            yield StreamingChatChunk(
                                id=correlation_id,
                                content=new_content,
                                role="assistant",
                                conversation_id=conversation.id,
                            )
    
            # Create final message
            if content_buffer:
                await self.message_service.create_message(
                    conversation_id=conversation.id,
                    role=MessageRole.ASSISTANT,
                    content=content_buffer,
                )
    
            # Record success metrics
            await self._record_metrics(
                workflow_id, "stream", start_time, True, correlation_id=correlation_id
            )
    
        except Exception as e:
            # Record error metrics
            await self._record_metrics(
                workflow_id, "stream", start_time, False,
                error_type=type(e).__name__, correlation_id=correlation_id
            )
>           raise WorkflowExecutionError(f"RAG workflow streaming failed: {str(e)}") from e
E           chatter.core.workflow_executors.WorkflowExecutionError: RAG workflow streaming failed: Mock object has no attribute 'workspace_id'

chatter/core/workflow_executors.py:499: WorkflowExecutionError
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.11-final-0 _______________

Name                                           Stmts   Miss  Cover   Missing
----------------------------------------------------------------------------
chatter/__init__.py                                6      0   100%
chatter/__main__.py                                3      3     0%   3-6
chatter/api/__init__.py                            2      0   100%
chatter/api/ab_testing.py                        289    249    14%   50-59, 75-94, 104-106, 129-268, 289-359, 380-442, 465-541, 562-581, 602-625, 646-669, 690-713, 734-845, 866-903, 926-949, 970-990, 1011-1060
chatter/api/agents.py                            342    307    10%   56-58, 88-198, 224-282, 306-312, 335-358, 379-415, 436-469, 502-605, 626-672, 691-820, 839-926
chatter/api/analytics.py                         149    105    30%   36, 68-112, 145-185, 216-267, 298-349, 371-404, 436-474, 505-523, 558-589, 631-694, 709-713, 731-735
chatter/api/auth.py                              152    106    30%   47-51, 60-69, 83, 99, 118-126, 149-184, 203-230, 251-285, 300, 319-322, 343-354, 377-386, 409-425, 442-443, 462-479, 501-519, 545-561, 582-598
chatter/api/chat.py                              169    110    35%   60-61, 136-142, 180-184, 207-227, 244-252, 270-280, 306-312, 329-340, 358-369, 401-453, 461-496, 506-520, 533-560, 571-577, 587-593
chatter/api/data_management.py                    82     55    33%   34, 48-69, 85-118, 130-165, 181-202, 213-237, 251-264, 278-293, 305-318
chatter/api/documents.py                         154    118    23%   53, 88-139, 198-230, 264-288, 311-333, 356-380, 401-429, 460-481, 506-533, 552-568, 589-627, 651-678
chatter/api/events.py                             93     71    24%   48-148, 186-258, 284-287, 307-317, 335-345
chatter/api/health.py                             68     48    29%   31, 55-100, 118, 133-183, 202-224
chatter/api/jobs.py                              122     98    20%   44-48, 69-130, 149-256, 273-304, 321-343, 360-387, 409-422
chatter/api/model_registry.py                    237    183    23%   53-60, 75-84, 99-152, 166-189, 204-225, 243-285, 309-318, 330-339, 353-403, 417-449, 462-483, 499-512, 532-541, 556-565, 579-641, 658-683, 696-711, 726-741, 754-763, 775-784, 795-804
chatter/api/plugins.py                           164    130    21%   36-38, 61-97, 118-169, 190-224, 247-300, 321-342, 363-390, 413-438, 459-479, 498-504, 525-531, 552-566, 587-601
chatter/api/profiles.py                          128     95    26%   46, 69-111, 158-190, 211-231, 254-281, 304-328, 351-397, 420-442, 461-481, 503-515
chatter/api/prompts.py                           100     71    29%   39, 62-72, 91-111, 162-195, 217-237, 260-282, 305-327, 350-363, 386-403
chatter/api/toolserver.py                        289    222    23%   61, 75, 101-107, 128-135, 156-161, 182-198, 221-239, 266-284, 308-326, 350-368, 392-410, 434-452, 480-501, 524-538, 561-575, 601-616, 639-651, 675-742, 763-769, 794-812, 838-844, 872-878, 901-913, 939-943, 966-972, 995-1002, 1025-1029, 1050-1091
chatter/cli.py                                  1203   1026    15%   34-58, 128-129, 183-246, 286-299, 323-357, 371-461, 474-495, 512-571, 589-606, 630-649, 670-675, 685-694, 702-728, 741-769, 785-834, 840-879, 894-986, 1011-1099, 1120-1229, 1242-1276, 1316-1539, 1545-1559, 1590-1656, 1665-1737, 1770-1828, 1840-1864, 1883-1937, 1954-2029, 2043-2072, 2089-2159, 2181-2244, 2262-2318, 2327-2368, 2383-2428, 2442-2471, 2496-2551, 2558-2586, 2592-2605, 2617-2679, 2690-2729, 2736-2777, 2781
chatter/config.py                                188     15    92%   531, 537-547, 558, 569, 606, 611-613, 645, 659-661
chatter/core/__init__.py                          17      8    53%   6-7, 11-12, 16-17, 21-22
chatter/core/agents.py                           320    252    21%   40-46, 71, 80, 88-91, 104-112, 120-125, 149-167, 181-182, 196-217, 230-278, 294-305, 322-377, 381, 397-472, 476-485, 537-578, 590-612, 624-642, 664-681, 693-726, 737-750, 770-777, 800-820, 830-847, 883, 891, 899, 917-938, 949, 962-966, 984-1033, 1048-1055, 1063-1085
chatter/core/analytics.py                        696    646     7%   33, 47-221, 235-446, 460-646, 660-830, 838-906, 922-1300, 1318-1343, 1357-1398, 1414-1444, 1457-1476, 1489-1498, 1510-1533, 1542-1605, 1619-1686, 1694-1731, 1735-1782, 1790-1848, 1856-1905, 1974, 1988-2041, 2059, 2070-2071, 2092-2173, 2186-2222, 2237, 2251-2362, 2378, 2389, 2403, 2418
chatter/core/audit_adapter.py                     99     60    39%   48-55, 59-61, 65-68, 86-121, 136-168, 174-191, 222-249, 261, 279-287, 308-310, 330-334
chatter/core/auth.py                             330    291    12%   46-61, 73-81, 90, 94, 106, 122-181, 196-236, 247-248, 260-309, 320-323, 334-337, 349-362, 379-392, 412-465, 481-510, 524-534, 548-557, 568-613, 631-649, 663-692, 708-741, 745-775, 786-796, 808-855, 873-939
chatter/core/cache_factory.py                    140     43    69%   117-118, 155-175, 197-199, 208, 220-224, 268, 293-294, 307, 309, 337-338, 381-394, 398-399, 424
chatter/core/cache_interface.py                  105     26    75%   59, 73, 85, 94, 106, 118, 130, 143, 156, 169, 181, 190, 199, 259-272, 284, 295, 301-302
chatter/core/dependencies.py                     171     98    43%   35-37, 48-50, 76-89, 104, 115-119, 125-129, 134, 168-170, 175-177, 182-184, 189-191, 208, 213, 218, 223, 236, 245-247, 255-278, 286-287, 296, 307-313, 324, 332-333, 342-343, 351-355, 363-367, 379-381, 392-394, 402, 417, 435-437, 445-446, 454, 465-467
chatter/core/documents.py                        351    300    15%   49-54, 75-215, 231-266, 280-339, 357-393, 407-450, 464-568, 586-643, 659-697, 708-769, 780-803, 813-834, 853-854, 865-877, 890-903, 911, 922, 935-941, 953, 965-967, 978-987, 1001-1022, 1030, 1038, 1049, 1062-1093, 1104-1105
chatter/core/dynamic_embeddings.py               173    142    18%   12-15, 30-45, 60-80, 101-134, 167-184, 198-206, 216, 222, 230, 239-258, 264-275, 285-330, 338, 344-357, 363-381, 387-431, 437-449, 455-472, 478-495
chatter/core/enhanced_memory_cache.py            224     67    70%   39, 58-59, 69-71, 94-95, 125-128, 140, 148-151, 168-171, 183, 191-192, 205-216, 256-259, 272, 287-288, 296, 318, 322, 338, 342, 348-349, 418-420, 437, 465-468, 483-496, 500-506, 521, 524
chatter/core/enhanced_redis_cache.py             280    240    14%   60-101, 105-111, 119-125, 136-159, 172-195, 206-223, 231-253, 264-275, 286-308, 319-352, 364-389, 401-415, 427-438, 449-467, 475-507, 520-561, 579-581, 589-592
chatter/core/events.py                           134     23    83%   100-101, 123, 132, 137, 142, 162-165, 197-199, 206-208, 215-217, 225-228
chatter/core/exceptions.py                       253    134    47%   48, 59, 115, 131, 144, 156-172, 176-178, 189-195, 207, 215, 218, 225, 246-252, 266-281, 293, 300, 307, 319, 324-331, 345-351, 360, 373-377, 382, 385, 392, 401-402, 411, 420-421, 432-435, 448-451, 458, 465, 468, 471, 483, 491, 494, 508-514, 519, 522, 543-553, 565-572, 587-591, 606-612, 624, 636, 648, 651, 654, 663-667, 670, 673, 682-686, 701-707
chatter/core/langchain.py                         86     64    26%   33-48, 60-73, 82-112, 121-180, 189-215, 221-236, 243
chatter/core/langgraph.py                        303    257    15%   33-36, 72-108, 150-485, 494-511, 520-536, 542-557, 577-620, 638-673, 693-751, 764-765
chatter/core/model_registry.py                   318    251    21%   39-42, 77-144, 148-151, 155-158, 164-168, 174-190, 195-218, 225-292, 302-341, 345-350, 356-364, 371-389, 395-430, 435-446, 450-471, 480-516, 536-537, 541-542, 550-566, 574-583, 589-598, 604-609, 616-664, 671-689, 701-711, 715-719, 724-737, 745-777, 784-810, 816-825
chatter/core/monitoring.py                       546    317    42%   176-179, 208, 327-335, 348-361, 374-377, 391-395, 419-439, 451-474, 480-506, 514-536, 540, 548-552, 556-569, 573-575, 583-627, 645, 649-680, 691-735, 739-752, 758-777, 781, 785-794, 798-824, 828-843, 847-855, 868-876, 889-897, 910-918, 937-968, 1003-1025, 1030-1031, 1052-1053, 1090-1151, 1156-1186, 1191-1238, 1247-1255, 1260-1268, 1273-1280, 1285-1293, 1298-1306
chatter/core/multi_tier_cache.py                 151    116    23%   81-84, 88, 99-123, 136-158, 169-189, 197-212, 223-231, 243-248, 259-278, 291-303, 315-330, 342-348, 359-368, 376-393, 401-411, 431-451, 464
chatter/core/profiles.py                         223    194    13%   38-39, 56-139, 155-175, 189-261, 276-332, 348-383, 401-498, 520-618, 631-700, 705-707, 717-754
chatter/core/prompts.py                          225    203    10%   31, 48-121, 137-193, 207-270, 285-345, 359-388, 406-532, 543-552, 577-662, 675-749
chatter/core/security_adapter.py                  77     33    57%   42, 53-60, 64-66, 70-73, 184-209, 232-235, 254, 272-276, 294-300
chatter/core/security_compliance.py              188    188     0%   3-601
chatter/core/token_manager.py                    149    149     0%   3-389
chatter/core/unified_events.py                   139     16    88%   43-44, 78-80, 86, 107-108, 148-149, 227, 271-273, 530, 535
chatter/core/unified_model_registry_cache.py     132     73    45%   73-74, 86-87, 98-114, 166-167, 179-180, 191-192, 274-282, 308-316, 333-351, 359-360, 376, 384, 396, 404-420, 428-484, 492-493, 515-517
chatter/core/unified_template_manager.py         195    136    30%   179-190, 203-206, 214-240, 255-299, 315-343, 353-360, 375-384, 396-435, 458-489, 524-560, 572-583, 597-607, 619-631, 639, 647, 655
chatter/core/unified_workflow_cache.py           158     87    45%   134, 149-157, 191, 211-222, 240-241, 249, 261-280, 309-343, 352-400, 412-417, 425-439, 447-453, 461-464
chatter/core/validation/__init__.py               12      3    75%   36, 40, 44
chatter/core/validation/context.py                40      6    85%   50, 63-84
chatter/core/validation/engine.py                134     75    44%   31-32, 36, 77-78, 94, 98, 111, 115, 126-135, 143-152, 160-169, 177-186, 194-207, 217-230, 243-267, 271-283
chatter/core/validation/exceptions.py             38     12    68%   25-27, 67-69, 76-78, 81-82, 86
chatter/core/validation/validators.py            320    146    54%   31, 35, 145, 154-159, 165, 173, 196, 204, 263, 345-350, 366-369, 394, 401, 428, 441-443, 455-464, 468-483, 491-503, 511-519, 535-544, 548-566, 574-585, 593-609, 625-636, 640-652, 659-671, 678-700, 704-718
chatter/core/vector_store.py                     180    126    30%   11-24, 40-44, 65, 76, 87, 92, 99, 114, 121, 130, 140, 154-171, 175-190, 202-230, 242-252, 264-276, 282-286, 292-299, 313-370, 378-393, 401-413, 424-456, 462, 480-497, 503-504, 511
chatter/core/workflow_executors.py               329    221    33%   69, 81, 93, 108, 186-189, 200, 218-224, 239-315, 334-408, 435-489, 511, 522-596, 607-691, 699, 710-789, 800-889, 911, 919
chatter/core/workflow_limits.py                  128     32    75%   114-115, 143, 154, 162, 202-205, 209-219, 225-253, 273-275
chatter/core/workflow_performance.py             137    105    23%   67-81, 89-105, 126-129, 133, 137-142, 146-148, 152-158, 166-169, 175-223, 232-267, 273-311, 317-336
chatter/core/workflow_security.py                155    111    28%   45-51, 55-57, 68-81, 89-103, 115-119, 127-130, 146-156, 171-179, 193-197, 222-228, 232, 279-282, 303-316, 341-353, 377-433, 444-451, 472-486, 511-521, 532-579
chatter/main.py                                  252    167    34%   29-34, 45-159, 165-296, 326-336, 376-377, 440-449, 456-464, 471-483, 490-506, 619-657, 669-670, 678-687, 700-702
chatter/middleware/__init__.py                     0      0   100%
chatter/middleware/auth_security.py               82     52    37%   53-59, 77-99, 104-123, 132-145, 149-158, 163-173, 177, 198
chatter/middleware/security.py                    36     10    72%   70, 76-78, 98-113
chatter/models/__init__.py                         9      0   100%
chatter/models/agent.py                            1      1     0%   4
chatter/models/analytics.py                      112      9    92%   14-18, 184, 292, 394, 495
chatter/models/base.py                            45      5    89%   32, 53, 55, 57, 59
chatter/models/conversation.py                    76      6    92%   27, 176, 180, 341-346, 350
chatter/models/document.py                       113     24    79%   26, 204, 209-210, 215-222, 226, 365-370, 375, 388-395, 403-411, 419
chatter/models/profile.py                         83     21    75%   26-27, 231, 236, 240-261, 265
chatter/models/prompt.py                         153     78    49%   30, 270-273, 277, 291-312, 323-431, 442-446, 450
chatter/models/registry.py                        82      3    96%   102, 194, 286
chatter/models/toolserver.py                     115      0   100%
chatter/models/user.py                            42      7    83%   19-22, 144, 149, 153
chatter/schemas/__init__.py                       13      0   100%
chatter/schemas/ab_testing.py                     94      0   100%
chatter/schemas/agents.py                        190      0   100%
chatter/schemas/analytics.py                     192     22    89%   361-366, 371-381, 464-477, 483-488
chatter/schemas/auth.py                          116     10    91%   118-122, 217-233, 240-242
chatter/schemas/chat.py                          140      0   100%
chatter/schemas/common.py                         60      2    97%   88, 93
chatter/schemas/data_management.py               129      0   100%
chatter/schemas/document.py                      131      0   100%
chatter/schemas/events.py                        157     11    93%   346-361
chatter/schemas/health.py                         41      0   100%
chatter/schemas/jobs.py                          102      0   100%
chatter/schemas/model_registry.py                142      0   100%
chatter/schemas/plugins.py                       101      0   100%
chatter/schemas/profile.py                       227     56    75%   16, 146-152, 158-167, 173-181, 187-195, 201-209, 215-217, 223-225, 239-241, 479-483
chatter/schemas/prompt.py                        221     73    67%   111-167, 260-304, 506-514
chatter/schemas/toolserver.py                    240      4    98%   83-84, 88, 97
chatter/schemas/utilities.py                      44      0   100%
chatter/services/__init__.py                      42     21    50%   6-7, 11-12, 16-17, 21-22, 29-31, 35-36, 40-41, 45-46, 50-51, 55-56
chatter/services/ab_testing.py                   535    400    25%   198-239, 276-330, 341-362, 373-384, 395-410, 430-477, 502-531, 542-545, 563-577, 591-599, 613-621, 632-666, 681-695, 713-754, 769-770, 778-981, 990-1026, 1050-1083, 1094-1198, 1202, 1208-1219, 1223-1254, 1258-1264, 1268-1269, 1275-1286, 1292-1325, 1350, 1395
chatter/services/chat.py                         117     83    29%   55-61, 71, 80-89, 98, 109, 117, 131-134, 145, 153, 174-281, 298-395, 408-419, 440, 453, 468-477, 483-506
chatter/services/conversation.py                 183    155    15%   40-41, 66-125, 146-160, 182-205, 231-306, 320-344, 364-389, 406-455, 470-515, 526-538, 552-563, 577-588, 602-616, 630-641, 655-662
chatter/services/data_management.py              302    263    13%   52-86, 92-123, 129-159, 163-181, 198-221, 244-248, 267-377, 381-431, 439-479, 489-529, 539-579, 593-664, 669-794, 799-823
chatter/services/document_processing.py          422    364    14%   24-25, 31-32, 59-63, 72-232, 238-287, 292-296, 299-302, 306-336, 339-348, 351-360, 365-374, 380-434, 442-452, 458-464, 468-474, 480-487, 493-500, 506-539, 545-553, 559-577, 583-627, 633-711, 717-746, 757-803, 807-859, 881-896, 910-923, 941-963, 977-994, 1014-1044
chatter/services/dynamic_vector_store.py         240    216    10%   40-49, 61-123, 136-193, 203-227, 244-319, 330-377, 388-438, 457-530, 534-605, 618-628, 632-641
chatter/services/embeddings.py                   237    188    21%   16, 25-27, 33-35, 41-42, 73-102, 106-131, 135-136, 143-144, 152-153, 158-161, 167-240, 247, 263-317, 325-336, 344-350, 363-376, 404-410, 427-477, 500-563, 569-584, 588-595
chatter/services/job_queue.py                    358    289    19%   97, 140-233, 248-284, 295-296, 307, 318-341, 361-380, 392-395, 407-411, 419-432, 449-462, 476-493, 497-507, 515-520, 526-535, 539-549, 555-646, 654-784, 795-851, 861-907, 925-946, 957-974, 988-1036, 1048-1051, 1060-1063, 1074-1079
chatter/services/llm.py                          294    255    13%   25-26, 51-52, 57-60, 66-106, 121-172, 183-191, 198, 217-320, 336-357, 382-474, 483-499, 522-571, 591-632, 640-646, 659-674, 700-701, 714-715, 729-787, 802-819, 849-866, 892-896, 918-926
chatter/services/mcp.py                          337    145    57%   141, 149, 152, 156-158, 162, 168-195, 201-246, 266-272, 316-322, 350-351, 366-367, 374, 390, 395, 400-403, 410-420, 454-480, 549-570, 575, 586, 595-613, 617-667, 678-682, 686-695, 699-717, 722-726, 735, 751-762, 767-769
chatter/services/message.py                      158    140    11%   27, 52-104, 138-200, 216-265, 288-334, 357-404, 421-498, 516-566
chatter/services/plugins.py                      546    456    16%   15-20, 52-53, 62, 71, 80, 88, 101, 118-136, 148-181, 194, 210, 223, 232, 266-269, 288-384, 395-418, 429-515, 526-612, 628-643, 654, 667, 675-689, 703-725, 736-777, 788-832, 843-850, 861-868, 883-931, 943-958, 970-982, 999-1114, 1127-1143, 1151-1165, 1184-1185, 1189-1190, 1194, 1205, 1213-1214, 1218-1219, 1223, 1234, 1239, 1252-1267, 1284
chatter/services/scheduler.py                    123    123     0%   3-247
chatter/services/sse_events.py                   183    118    36%   19-21, 28-35, 39-61, 69-88, 92-93, 115-116, 122-134, 139-177, 183, 187-201, 224-233, 243-248, 256, 308-337, 343, 362, 376, 391, 409, 425, 443, 459, 475, 489, 506, 522, 537, 552
chatter/services/streaming.py                    182    111    39%   46-47, 178-235, 251-364, 386-421, 425, 438-447, 475-505, 513-528, 559-567, 587-607
chatter/services/tool_access.py                  251    216    14%   49, 68-117, 133-160, 171-181, 194-201, 222-245, 258-265, 283-323, 346-360, 368-378, 384-389, 393-396, 402-438, 447-472, 478-492, 496-501, 507-543, 558-580, 593-603, 609-693, 703-782
chatter/services/toolserver.py                   442    396    10%   57-60, 76-150, 163-172, 190-194, 212-232, 249-284, 295-329, 342-375, 386-410, 421-434, 445-472, 483-513, 528-533, 543-548, 591-612, 623-644, 664-732, 747-820, 845-924, 944-1086, 1097-1137, 1145-1218, 1227-1297, 1301-1340, 1348
chatter/services/workflow_execution.py            45     12    73%   124, 132, 160-171, 189-226
chatter/utils/__init__.py                          4      0   100%
chatter/utils/audit_logging.py                   114     45    61%   95, 106-125, 162-214, 238, 271, 306, 340, 365-369, 388-410, 429, 447, 465
chatter/utils/config_validator.py                 33     33     0%   3-65
chatter/utils/configurable_seeding.py            320    283    12%   40-41, 54-56, 60-101, 105-155, 159-208, 212-261, 265-315, 319-372, 376-395, 399-448, 452-498, 502-553, 557-598, 609-610
chatter/utils/correlation.py                      26     13    50%   23, 41, 63-81
chatter/utils/crypto.py                           72      3    96%   76-77, 138
chatter/utils/database.py                        225    176    22%   53-73, 102-176, 203-306, 315-339, 348-355, 362-367, 375-378, 382-384, 388-393, 397-399, 408-410, 414-420, 424, 431-445, 449-458, 471-473, 485-517, 530-536, 545-551
chatter/utils/database_optimization.py           213    180    15%   44-65, 83-93, 111-118, 136-143, 154-182, 193-224, 235-278, 289-317, 328-359, 373-403, 416, 435-474, 494-556, 572-602, 625-647, 667-668
chatter/utils/documentation.py                    77     39    49%   59-168, 173-254, 549-553
chatter/utils/error_recovery.py                  145    145     0%   3-309
chatter/utils/logging.py                          54     21    61%   22-25, 65, 75, 80, 84-86, 113-114, 125-126, 130, 134, 138, 142, 146, 150, 163-164
chatter/utils/performance.py                     144    108    25%   27, 50-82, 103-131, 145-164, 177-207, 225-245, 257-271, 283, 299-312, 328-340, 354-371, 397, 443-455
chatter/utils/problem.py                         100     55    45%   53, 63-81, 87-88, 125, 141, 160, 180-186, 205-209, 231-244, 265-269, 287, 305, 323-327, 358-365, 389-404, 431-446
chatter/utils/prompt_audit.py                     35     35     0%   3-210
chatter/utils/response.py                         29     29     0%   3-106
chatter/utils/security_enhanced.py               278     79    72%   99-101, 139-141, 154, 189, 193, 261-262, 279-280, 282, 288-289, 295-296, 302-303, 323, 357, 397, 422, 452, 461, 473, 479-482, 491, 497-507, 517, 527-542, 549-564, 569-576, 581-597, 602-603, 608, 635-638, 649-652, 656-659, 663-666
chatter/utils/seeding.py                         346    257    26%   57-60, 64-65, 108, 111-116, 137-154, 158-173, 177-193, 197-208, 212-215, 219-253, 257-310, 314-357, 362-373, 377-445, 449-548, 552-605, 609-713, 719, 724, 740-785, 803-859, 866-923, 933-934, 946-986
chatter/utils/template_security.py               107     84    21%   43-58, 78-112, 132-149, 168-186, 199-216, 233-244, 259-311
chatter/utils/unified_rate_limiter.py            229    131    43%   83-93, 99-109, 135-138, 167, 178-192, 202-210, 309-320, 328-334, 340, 367-373, 385-390, 395-405, 410-425, 430-498, 540-588
chatter/utils/versioning.py                      118     56    53%   196-205, 218-247, 264-300, 309-318, 355-356, 375-386, 399, 410, 416
----------------------------------------------------------------------------
TOTAL                                          22803  14547    36%
Coverage HTML written to dir htmlcov
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED tests/test_auth_security_comprehensive.py::TestEnhancedPasswordSecurity::test_password_entropy_calculation
FAILED tests/test_auth_security_comprehensive.py::TestEnhancedPasswordSecurity::test_personal_info_in_password
FAILED tests/test_cli.py::TestCLICommands::test_health_command - assert 2 == 0
FAILED tests/test_cli.py::TestHealthCheck::test_health_check_success - Runtim...
FAILED tests/test_cli.py::TestHealthCheck::test_health_check_failure - Runtim...
FAILED tests/test_cli.py::TestDatabaseCommands::test_db_init_success - Runtim...
FAILED tests/test_cli.py::TestDatabaseCommands::test_db_init_connection_failure
FAILED tests/test_cli.py::TestDatabaseCommands::test_db_init_init_failure - R...
FAILED tests/test_cli.py::TestInteractivePromptCreation::test_interactive_prompt_creation
FAILED tests/test_cli.py::TestCLIIntegration::test_full_prompt_lifecycle - as...
FAILED tests/test_cli.py::TestCLIErrorScenarios::test_api_unavailable_scenarios
FAILED tests/test_crypto_utils.py::TestSecretManager::test_encrypt_with_different_managers_incompatible
FAILED tests/test_mcp_service.py::TestMCPToolService::test_add_server_success
FAILED tests/test_mcp_service.py::TestMCPToolService::test_add_server_disabled_service
FAILED tests/test_mcp_service.py::TestMCPToolService::test_add_server_validation_error
FAILED tests/test_mcp_service.py::TestMCPToolService::test_call_tool_success
FAILED tests/test_mcp_service.py::TestMCPToolService::test_call_tool_disabled_service
FAILED tests/test_mcp_service.py::TestMCPToolService::test_list_servers - Att...
FAILED tests/test_mcp_service.py::TestMCPToolService::test_get_server_info - ...
FAILED tests/test_mcp_service.py::TestMCPToolService::test_get_server_info_nonexistent
FAILED tests/test_mcp_service.py::TestMCPServiceIntegration::test_server_lifecycle
FAILED tests/test_mcp_service.py::TestMCPServiceIntegration::test_multiple_servers_management
FAILED tests/test_mcp_service.py::TestMCPServiceIntegration::test_error_recovery_scenarios
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_security_headers_added
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_content_security_policy_header
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_x_frame_options_header
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_x_content_type_options_header
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_x_xss_protection_header
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_referrer_policy_header
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_permissions_policy_header
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_strict_transport_security_enabled
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_strict_transport_security_disabled
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_security_headers_on_different_response_types
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_security_headers_dont_override_existing
FAILED tests/test_middleware.py::TestAuthRateLimitMiddleware::test_login_endpoint_rate_limiting
FAILED tests/test_middleware.py::TestAuthRateLimitMiddleware::test_register_endpoint_rate_limiting
FAILED tests/test_middleware.py::TestAuthRateLimitMiddleware::test_password_reset_endpoint_rate_limiting
FAILED tests/test_middleware.py::TestAuthRateLimitMiddleware::test_client_ip_identification
FAILED tests/test_middleware.py::TestAuthRateLimitMiddleware::test_rate_limit_with_user_agent_tracking
FAILED tests/test_middleware.py::TestMiddlewareIntegration::test_both_middleware_applied
FAILED tests/test_middleware.py::TestMiddlewareIntegration::test_security_headers_on_rate_limited_response
FAILED tests/test_middleware.py::TestMiddlewareIntegration::test_non_auth_endpoints_only_security_headers
FAILED tests/test_middleware.py::TestMiddlewareIntegration::test_middleware_order_matters
FAILED tests/test_middleware.py::TestMiddlewareIntegration::test_middleware_performance
FAILED tests/test_middleware.py::TestMiddlewareEdgeCases::test_empty_app_with_middleware
FAILED tests/test_plugins.py::TestBasePlugin::test_base_plugin_initialization
FAILED tests/test_plugins.py::TestBasePlugin::test_base_plugin_default_config
FAILED tests/test_plugins.py::TestBasePlugin::test_base_plugin_get_configuration_schema
FAILED tests/test_plugins.py::TestBasePlugin::test_validate_configuration_no_schema
FAILED tests/test_plugins.py::TestBasePlugin::test_validate_configuration_with_schema
FAILED tests/test_plugins.py::TestBasePlugin::test_validate_configuration_type_checking
FAILED tests/test_plugins.py::TestBasePlugin::test_validate_configuration_error_handling
FAILED tests/test_plugins.py::TestToolPlugin::test_tool_plugin_inheritance - ...
FAILED tests/test_plugins.py::TestToolPlugin::test_get_tools_implementation
FAILED tests/test_plugins.py::TestWorkflowPlugin::test_workflow_plugin_inheritance
FAILED tests/test_plugins.py::TestPluginManager::test_plugin_manager_initialization
FAILED tests/test_plugins.py::TestPluginManager::test_get_plugin_directory_default
FAILED tests/test_plugins.py::TestPluginManager::test_get_plugin_directory_custom
FAILED tests/test_plugins.py::TestPluginManager::test_load_plugin_from_file_success
FAILED tests/test_plugins.py::TestPluginManager::test_load_plugin_from_file_missing_file
FAILED tests/test_plugins.py::TestPluginManager::test_load_plugin_from_file_syntax_error
FAILED tests/test_plugins.py::TestPluginManager::test_unload_plugin_success
FAILED tests/test_plugins.py::TestPluginManager::test_unload_plugin_not_found
FAILED tests/test_plugins.py::TestPluginManager::test_unload_plugin_cleanup_error
FAILED tests/test_plugins.py::TestPluginManager::test_list_plugins - pydantic...
FAILED tests/test_plugins.py::TestPluginManager::test_list_plugins_by_type - ...
FAILED tests/test_plugins.py::TestPluginManager::test_list_plugins_by_status
FAILED tests/test_plugins.py::TestPluginManager::test_get_plugin_info_found
FAILED tests/test_plugins.py::TestPluginManager::test_get_plugin_info_not_found
FAILED tests/test_plugins.py::TestPluginManager::test_get_tools_from_plugins
FAILED tests/test_plugins.py::TestPluginManager::test_get_tools_from_plugins_inactive_ignored
FAILED tests/test_plugins.py::TestPluginManager::test_health_check_all_plugins
FAILED tests/test_plugins.py::TestPluginManager::test_health_check_plugin_error
FAILED tests/test_plugins.py::TestPluginIntegration::test_plugin_lifecycle - ...
FAILED tests/test_plugins.py::TestPluginIntegration::test_multiple_plugins_management
FAILED tests/test_streaming.py::TestStreamingEvent::test_streaming_event_data_creation
FAILED tests/test_streaming.py::TestStreamingEvent::test_streaming_event_data_minimal
FAILED tests/test_streaming.py::TestStreamingEvent::test_streaming_event_data_auto_timestamp
FAILED tests/test_streaming.py::TestStreamingEvent::test_streaming_event_data_with_metadata
FAILED tests/test_streaming.py::TestStreamingService::test_end_stream - Attri...
FAILED tests/test_streaming.py::TestStreamingService::test_stream_event_basic
FAILED tests/test_streaming.py::TestStreamingService::test_stream_token - Att...
FAILED tests/test_streaming.py::TestStreamingService::test_stream_tool_call_lifecycle
FAILED tests/test_streaming.py::TestStreamingService::test_stream_thinking - ...
FAILED tests/test_streaming.py::TestStreamingService::test_stream_source_found
FAILED tests/test_streaming.py::TestStreamingService::test_stream_error - Att...
FAILED tests/test_streaming.py::TestStreamingService::test_stream_complete - ...
FAILED tests/test_streaming.py::TestStreamingService::test_stream_metadata - ...
FAILED tests/test_streaming.py::TestStreamingService::test_get_stream_metrics
FAILED tests/test_streaming.py::TestStreamingService::test_get_nonexistent_stream_metrics
FAILED tests/test_streaming.py::TestStreamingService::test_list_active_streams
FAILED tests/test_streaming.py::TestStreamingService::test_is_stream_active
FAILED tests/test_streaming.py::TestStreamingService::test_stream_activity_tracking
FAILED tests/test_streaming.py::TestStreamingService::test_stream_error_handling_invalid_stream
FAILED tests/test_streaming.py::TestStreamingService::test_concurrent_streams
FAILED tests/test_streaming.py::TestStreamingService::test_stream_cleanup_on_error
FAILED tests/test_streaming.py::TestStreamingServiceIntegration::test_complete_streaming_workflow
FAILED tests/test_streaming.py::TestStreamingServiceIntegration::test_error_recovery_workflow
FAILED tests/test_streaming.py::TestStreamingServiceIntegration::test_performance_with_high_volume_streaming
FAILED tests/test_streaming.py::TestStreamingServiceIntegration::test_stream_isolation
FAILED tests/test_versioning.py::TestAPIVersion::test_api_version_string_representation
FAILED tests/test_versioning.py::TestVersionStatus::test_version_status_values
FAILED tests/test_versioning.py::TestVersionStatus::test_version_status_progression
FAILED tests/test_versioning.py::TestEndpointVersioning::test_endpoint_versioning_creation
FAILED tests/test_versioning.py::TestEndpointVersioning::test_endpoint_versioning_lifecycle
FAILED tests/test_versioning.py::TestAPIVersionManager::test_default_versions_loaded
FAILED tests/test_versioning.py::TestAPIVersionManager::test_is_endpoint_available_unregistered
FAILED tests/test_versioning.py::TestAPIVersionManager::test_deprecate_endpoint
FAILED tests/test_versioning.py::TestAPIVersionManager::test_deprecate_nonexistent_endpoint
FAILED tests/test_versioning.py::TestAPIVersionManager::test_get_endpoint_info
FAILED tests/test_versioning.py::TestAPIVersionManager::test_get_endpoint_info_nonexistent
FAILED tests/test_versioning.py::TestAPIVersionManager::test_get_endpoints_for_version
FAILED tests/test_versioning.py::TestAPIVersionManager::test_version_middleware_integration
FAILED tests/test_versioning.py::TestVersioningIntegration::test_complete_version_lifecycle
FAILED tests/test_versioning.py::TestVersioningIntegration::test_version_migration_scenario
FAILED tests/test_versioning.py::TestVersioningIntegration::test_backwards_compatibility_checking
FAILED tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_execute_workflow_with_limits
FAILED tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_execute_workflow_timeout
FAILED tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_streaming_workflow_with_limits
FAILED tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_streaming_workflow_timeout
FAILED tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_enhanced_token_streaming_all_workflows
================ 121 failed, 271 passed, 385 skipped in 36.69s =================
