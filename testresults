============================= test session starts ==============================
platform linux -- Python 3.12.11, pytest-8.4.1, pluggy-1.6.0 -- /usr/bin/python3.12
cachedir: .pytest_cache
rootdir: /home/yam/chatter
configfile: pyproject.toml
testpaths: tests
plugins: mock-3.14.1, cov-6.2.1, socket-0.7.0, timeout-2.4.0, anyio-4.9.0, asyncio-1.1.0, langsmith-0.4.21, postgresql-7.0.2
asyncio: mode=Mode.AUTO, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collecting ... collected 776 items / 1 skipped

tests/e2e/test_auth_e2e.py::TestAuthE2E::test_complete_registration_workflow ERROR [  0%]
tests/e2e/test_auth_e2e.py::TestAuthE2E::test_complete_login_workflow ERROR [  0%]
tests/e2e/test_auth_e2e.py::TestAuthE2E::test_profile_access_workflow ERROR [  0%]
tests/e2e/test_auth_e2e.py::TestAuthE2E::test_registration_login_profile_complete_flow ERROR [  0%]
tests/e2e/test_auth_e2e.py::TestAuthE2E::test_invalid_credentials_workflow ERROR [  0%]
tests/e2e/test_chat_e2e.py::TestChatE2E::test_complete_chat_conversation_workflow ERROR [  0%]
tests/e2e/test_chat_e2e.py::TestChatE2E::test_chat_list_and_retrieval_workflow ERROR [  0%]
tests/e2e/test_chat_e2e.py::TestChatE2E::test_chat_message_streaming_workflow ERROR [  1%]
tests/e2e/test_chat_e2e.py::TestChatE2E::test_chat_deletion_workflow ERROR [  1%]
tests/e2e/test_chat_e2e.py::TestChatE2E::test_multi_user_chat_isolation ERROR [  1%]
tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_complete_document_upload_workflow ERROR [  1%]
tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_document_list_and_search_workflow ERROR [  1%]
tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_document_processing_status_workflow ERROR [  1%]
tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_document_chat_integration_workflow ERROR [  1%]
tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_document_deletion_workflow ERROR [  1%]
tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_large_document_upload_workflow ERROR [  2%]
tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_complete_lifecycle FAILED [  2%]
tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_list_and_filter FAILED [  2%]
tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_update_workflow FAILED [  2%]
tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_metrics_and_performance FAILED [  2%]
tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_error_scenarios FAILED [  2%]
tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_state_validation FAILED [  2%]
tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_concurrent_operations FAILED [  2%]
tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_data_persistence FAILED [  3%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_create_ab_test_requires_auth FAILED [  3%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_list_ab_tests_requires_auth FAILED [  3%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_ab_test_requires_auth FAILED [  3%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_update_ab_test_requires_auth FAILED [  3%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_delete_ab_test_requires_auth FAILED [  3%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_start_ab_test_requires_auth FAILED [  3%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_pause_ab_test_requires_auth FAILED [  3%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_complete_ab_test_requires_auth FAILED [  4%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_results_requires_auth FAILED [  4%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_metrics_requires_auth FAILED [  4%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_create_ab_test_success FAILED [  4%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_create_ab_test_invalid_data FAILED [  4%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_create_ab_test_invalid_allocation FAILED [  4%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_list_ab_tests_success FAILED [  4%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_ab_test_success FAILED [  5%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_ab_test_not_found FAILED [  5%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_start_ab_test_success FAILED [  5%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_start_ab_test_invalid_status FAILED [  5%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_delete_running_test_forbidden FAILED [  5%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_access_other_user_test_forbidden FAILED [  5%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_results_success FAILED [  5%]
tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_metrics_success FAILED [  5%]
tests/test_agents_integration.py::TestAgentsIntegration::test_agent_complete_lifecycle FAILED [  6%]
tests/test_agents_integration.py::TestAgentsIntegration::test_agents_list_and_filter FAILED [  6%]
tests/test_agents_integration.py::TestAgentsIntegration::test_agent_templates_workflow ERROR [  6%]
tests/test_agents_integration.py::TestAgentsIntegration::test_bulk_agent_operations FAILED [  6%]
tests/test_agents_integration.py::TestAgentsIntegration::test_agent_testing_functionality FAILED [  6%]
tests/test_agents_integration.py::TestAgentsIntegration::test_agent_health_monitoring FAILED [  6%]
tests/test_agents_integration.py::TestAgentsIntegration::test_agent_error_scenarios FAILED [  6%]
tests/test_agents_integration.py::TestAgentsIntegration::test_agent_data_validation FAILED [  6%]
tests/test_agents_integration.py::TestAgentsIntegration::test_concurrent_agent_operations FAILED [  7%]
tests/test_agents_integration.py::TestAgentsIntegration::test_agent_complex_configuration FAILED [  7%]
tests/test_agents_unit.py::TestAgentsUnit::test_create_agent_requires_auth FAILED [  7%]
tests/test_agents_unit.py::TestAgentsUnit::test_list_agents_requires_auth FAILED [  7%]
tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_templates_requires_auth FAILED [  7%]
tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_requires_auth FAILED [  7%]
tests/test_agents_unit.py::TestAgentsUnit::test_update_agent_requires_auth FAILED [  7%]
tests/test_agents_unit.py::TestAgentsUnit::test_delete_agent_requires_auth FAILED [  7%]
tests/test_agents_unit.py::TestAgentsUnit::test_test_agent_requires_auth FAILED [  8%]
tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_health_requires_auth FAILED [  8%]
tests/test_agents_unit.py::TestAgentsUnit::test_bulk_create_agents_requires_auth FAILED [  8%]
tests/test_agents_unit.py::TestAgentsUnit::test_bulk_delete_agents_requires_auth FAILED [  8%]
tests/test_agents_unit.py::TestAgentsUnit::test_create_agent_success FAILED [  8%]
tests/test_agents_unit.py::TestAgentsUnit::test_create_agent_invalid_data FAILED [  8%]
tests/test_agents_unit.py::TestAgentsUnit::test_list_agents_success FAILED [  8%]
tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_templates_success FAILED [  9%]
tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_success FAILED [  9%]
tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_not_found FAILED [  9%]
tests/test_agents_unit.py::TestAgentsUnit::test_update_agent_success FAILED [  9%]
tests/test_agents_unit.py::TestAgentsUnit::test_delete_agent_success FAILED [  9%]
tests/test_agents_unit.py::TestAgentsUnit::test_test_agent_success FAILED [  9%]
tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_health_success FAILED [  9%]
tests/test_agents_unit.py::TestAgentsUnit::test_bulk_create_agents_success FAILED [  9%]
tests/test_agents_unit.py::TestAgentsUnit::test_bulk_delete_agents_success FAILED [ 10%]
tests/test_agents_unit.py::TestAgentsUnit::test_agent_service_error_handling FAILED [ 10%]
tests/test_agents_unit.py::TestAgentsUnit::test_list_agents_with_filters FAILED [ 10%]
tests/test_agents_unit.py::TestAgentsUnit::test_agent_test_with_invalid_input FAILED [ 10%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_dashboard_workflow FAILED [ 10%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_conversation_analytics_workflow FAILED [ 10%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_usage_metrics_workflow FAILED [ 10%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_performance_metrics_workflow FAILED [ 10%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_document_analytics_workflow FAILED [ 11%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_system_analytics_workflow FAILED [ 11%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_user_analytics_workflow FAILED [ 11%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_export_workflow FAILED [ 11%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_health_check FAILED [ 11%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_metrics_summary_workflow FAILED [ 11%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_toolserver_analytics_workflow FAILED [ 11%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_concurrent_analytics_requests FAILED [ 11%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_data_consistency FAILED [ 12%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_error_handling FAILED [ 12%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_pagination_and_filtering FAILED [ 12%]
tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_response_format_validation FAILED [ 12%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_conversation_stats_requires_auth FAILED [ 12%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_usage_metrics_requires_auth FAILED [ 12%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_performance_metrics_requires_auth FAILED [ 12%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_document_analytics_requires_auth FAILED [ 13%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_system_analytics_requires_auth FAILED [ 13%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_dashboard_requires_auth FAILED [ 13%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_toolserver_analytics_requires_auth FAILED [ 13%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_user_analytics_requires_auth FAILED [ 13%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_export_analytics_requires_auth FAILED [ 13%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_health_requires_auth FAILED [ 13%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_metrics_summary_requires_auth FAILED [ 13%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_conversation_stats_success FAILED [ 14%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_usage_metrics_success FAILED [ 14%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_performance_metrics_success ERROR [ 14%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_document_analytics_success FAILED [ 14%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_system_analytics_success FAILED [ 14%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_dashboard_success FAILED [ 14%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_user_analytics_success FAILED [ 14%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_export_analytics_success FAILED [ 14%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_analytics_service_error_handling FAILED [ 15%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_invalid_user_id_format ERROR [ 15%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_metrics_summary_success FAILED [ 15%]
tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_health_success FAILED [ 15%]
tests/test_api_validation.py::TestWorkflowMapping::test_valid_workflow_types PASSED [ 15%]
tests/test_api_validation.py::TestWorkflowMapping::test_case_insensitive_workflow_types PASSED [ 15%]
tests/test_api_validation.py::TestWorkflowMapping::test_none_workflow_type PASSED [ 15%]
tests/test_api_validation.py::TestWorkflowMapping::test_empty_workflow_type PASSED [ 15%]
tests/test_api_validation.py::TestWorkflowMapping::test_invalid_workflow_type PASSED [ 16%]
tests/test_api_validation.py::TestUUIDValidation::test_valid_uuid PASSED [ 16%]
tests/test_api_validation.py::TestUUIDValidation::test_invalid_uuid_format PASSED [ 16%]
tests/test_api_validation.py::TestUUIDValidation::test_empty_uuid PASSED [ 16%]
tests/test_api_validation.py::TestUUIDValidation::test_none_uuid PASSED  [ 16%]
tests/test_api_validation.py::TestUUIDValidation::test_malformed_uuid PASSED [ 16%]
tests/test_auth_direct.py::TestAuthServiceDirect::test_auth_service_create_user PASSED [ 16%]
tests/test_auth_direct.py::TestAuthServiceDirect::test_auth_service_authenticate PASSED [ 17%]
tests/test_auth_integration.py::TestAuthIntegration::test_complete_user_registration_and_login_flow FAILED [ 17%]
tests/test_auth_integration.py::TestAuthIntegration::test_login_with_email_workflow FAILED [ 17%]
tests/test_auth_integration.py::TestAuthIntegration::test_token_refresh_workflow FAILED [ 17%]
tests/test_auth_integration.py::TestAuthIntegration::test_profile_update_workflow FAILED [ 17%]
tests/test_auth_integration.py::TestAuthIntegration::test_password_change_workflow FAILED [ 17%]
tests/test_auth_integration.py::TestAuthIntegration::test_api_key_workflow FAILED [ 17%]
tests/test_auth_integration.py::TestAuthIntegration::test_logout_workflow FAILED [ 17%]
tests/test_auth_integration.py::TestAuthIntegration::test_account_deactivation_workflow FAILED [ 18%]
tests/test_auth_integration.py::TestAuthIntegration::test_multiple_users_isolation FAILED [ 18%]
tests/test_auth_integration.py::TestAuthIntegration::test_password_reset_workflow FAILED [ 18%]
tests/test_auth_integration.py::TestAuthDatabaseIntegration::test_user_persistence FAILED [ 18%]
tests/test_auth_integration.py::TestAuthDatabaseIntegration::test_user_uniqueness_constraints FAILED [ 18%]
tests/test_auth_integration.py::TestAuthDatabaseIntegration::test_transaction_rollback_on_error FAILED [ 18%]
tests/test_auth_security_comprehensive.py::TestEnhancedPasswordSecurity::test_password_entropy_calculation FAILED [ 18%]
tests/test_auth_security_comprehensive.py::TestEnhancedPasswordSecurity::test_common_password_detection PASSED [ 18%]
tests/test_auth_security_comprehensive.py::TestEnhancedPasswordSecurity::test_keyboard_pattern_detection PASSED [ 19%]
tests/test_auth_security_comprehensive.py::TestEnhancedPasswordSecurity::test_excessive_repetition_detection PASSED [ 19%]
tests/test_auth_security_comprehensive.py::TestEnhancedPasswordSecurity::test_personal_info_in_password FAILED [ 19%]
tests/test_auth_security_comprehensive.py::TestEnhancedPasswordSecurity::test_advanced_password_validation PASSED [ 19%]
tests/test_auth_security_comprehensive.py::TestEnhancedEmailValidation::test_disposable_email_detection PASSED [ 19%]
tests/test_auth_security_comprehensive.py::TestEnhancedEmailValidation::test_email_format_security PASSED [ 19%]
tests/test_auth_security_comprehensive.py::TestEnhancedUsernameValidation::test_prohibited_usernames PASSED [ 19%]
tests/test_auth_security_comprehensive.py::TestEnhancedUsernameValidation::test_username_pattern_security PASSED [ 19%]
tests/test_auth_security_comprehensive.py::TestSecureAPIKeyManagement::test_secure_api_key_generation PASSED [ 20%]
tests/test_auth_security_comprehensive.py::TestSecureAPIKeyManagement::test_api_key_uniqueness PASSED [ 20%]
tests/test_auth_security_comprehensive.py::TestSecureAPIKeyManagement::test_api_key_timing_attack_resistance PASSED [ 20%]
tests/test_auth_security_comprehensive.py::TestAuthServiceSecurity::test_user_creation_security_validation FAILED [ 20%]
tests/test_auth_security_comprehensive.py::TestAuthServiceSecurity::test_password_change_security FAILED [ 20%]
tests/test_auth_security_comprehensive.py::TestAuthServiceSecurity::test_secure_api_key_creation FAILED [ 20%]
tests/test_auth_security_comprehensive.py::TestAuthServiceSecurity::test_authentication_security_logging FAILED [ 20%]
tests/test_auth_security_comprehensive.py::TestTokenSecurityIntegration::test_token_creation_security_claims FAILED [ 21%]
tests/test_auth_security_comprehensive.py::TestTokenSecurityIntegration::test_token_blacklisting PASSED [ 21%]
tests/test_auth_security_comprehensive.py::TestRateLimitingIntegration::test_login_rate_limiting FAILED [ 21%]
tests/test_auth_security_comprehensive.py::TestRateLimitingIntegration::test_registration_rate_limiting FAILED [ 21%]
tests/test_auth_security_comprehensive.py::TestSecurityCompliance::test_password_storage_security PASSED [ 21%]
tests/test_auth_security_comprehensive.py::TestSecurityCompliance::test_sensitive_data_sanitization PASSED [ 21%]
tests/test_auth_security_comprehensive.py::TestSecurityCompliance::test_timing_attack_resistance PASSED [ 21%]
tests/test_auth_security_comprehensive.py::TestSecurityPerformance::test_password_hashing_performance PASSED [ 21%]
tests/test_auth_security_comprehensive.py::TestSecurityPerformance::test_api_key_verification_performance PASSED [ 22%]
tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_complete_secure_registration_flow FAILED [ 22%]
tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_secure_login_with_monitoring FAILED [ 22%]
tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_secure_api_key_management FAILED [ 22%]
tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_secure_password_change_flow FAILED [ 22%]
tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_token_security_features FAILED [ 22%]
tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_security_monitoring_integration SKIPPED [ 22%]
tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_password_reset_security_flow FAILED [ 22%]
tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_comprehensive_security_validation FAILED [ 23%]
tests/test_auth_security_integration.py::TestSecurityPerformanceIntegration::test_auth_endpoint_performance FAILED [ 23%]
tests/test_auth_security_integration.py::TestSecurityPerformanceIntegration::test_multiple_concurrent_requests FAILED [ 23%]
tests/test_auth_unit.py::TestAuthUnitTests::test_user_registration FAILED [ 23%]
tests/test_auth_unit.py::TestAuthUnitTests::test_user_registration_duplicate_username FAILED [ 23%]
tests/test_auth_unit.py::TestAuthUnitTests::test_user_registration_duplicate_email FAILED [ 23%]
tests/test_auth_unit.py::TestAuthUnitTests::test_user_registration_invalid_data PASSED [ 23%]
tests/test_auth_unit.py::TestAuthUnitTests::test_user_login_success FAILED [ 23%]
tests/test_auth_unit.py::TestAuthUnitTests::test_user_login_with_email FAILED [ 24%]
tests/test_auth_unit.py::TestAuthUnitTests::test_user_login_invalid_credentials FAILED [ 24%]
tests/test_auth_unit.py::TestAuthUnitTests::test_user_login_nonexistent_user FAILED [ 24%]
tests/test_auth_unit.py::TestAuthUnitTests::test_get_current_user FAILED [ 24%]
tests/test_auth_unit.py::TestAuthUnitTests::test_get_current_user_without_auth FAILED [ 24%]
tests/test_auth_unit.py::TestAuthUnitTests::test_get_current_user_invalid_token PASSED [ 24%]
tests/test_auth_unit.py::TestAuthUnitTests::test_token_refresh FAILED    [ 24%]
tests/test_auth_unit.py::TestAuthUnitTests::test_token_refresh_invalid_token PASSED [ 25%]
tests/test_auth_unit.py::TestAuthUnitTests::test_update_profile FAILED   [ 25%]
tests/test_auth_unit.py::TestAuthUnitTests::test_update_profile_without_auth FAILED [ 25%]
tests/test_auth_unit.py::TestAuthUnitTests::test_change_password FAILED  [ 25%]
tests/test_auth_unit.py::TestAuthUnitTests::test_change_password_wrong_current FAILED [ 25%]
tests/test_auth_unit.py::TestAuthUnitTests::test_logout FAILED           [ 25%]
tests/test_auth_unit.py::TestAuthServiceUnit::test_create_user PASSED    [ 25%]
tests/test_auth_unit.py::TestAuthServiceUnit::test_authenticate_user FAILED [ 25%]
tests/test_auth_unit.py::TestAuthServiceUnit::test_authenticate_user_wrong_password FAILED [ 26%]
tests/test_auth_unit.py::TestAuthServiceUnit::test_authenticate_user_nonexistent PASSED [ 26%]
tests/test_auth_unit.py::TestAuthServiceUnit::test_create_tokens PASSED  [ 26%]
tests/test_cli.py::TestAPIClient::test_api_client_init_default_values PASSED [ 26%]
tests/test_cli.py::TestAPIClient::test_api_client_init_custom_values PASSED [ 26%]
tests/test_cli.py::TestAPIClient::test_api_client_close PASSED           [ 26%]
tests/test_cli.py::TestAPIClient::test_get_headers_without_token PASSED  [ 26%]
tests/test_cli.py::TestAPIClient::test_get_headers_with_token PASSED     [ 26%]
tests/test_cli.py::TestAPIClient::test_request_success PASSED            [ 27%]
tests/test_cli.py::TestAPIClient::test_request_no_content_response PASSED [ 27%]
tests/test_cli.py::TestAPIClient::test_request_401_error PASSED          [ 27%]
tests/test_cli.py::TestAPIClient::test_request_403_error PASSED          [ 27%]
tests/test_cli.py::TestAPIClient::test_request_other_http_error PASSED   [ 27%]
tests/test_cli.py::TestAPIClient::test_request_connection_error PASSED   [ 27%]
tests/test_cli.py::TestGetAPIClient::test_get_api_client_from_environment PASSED [ 27%]
tests/test_cli.py::TestGetAPIClient::test_get_api_client_defaults PASSED [ 27%]
tests/test_cli.py::TestCLICommands::test_cli_app_help PASSED             [ 28%]
tests/test_cli.py::TestCLICommands::test_prompts_help PASSED             [ 28%]
tests/test_cli.py::TestCLICommands::test_list_prompts_command PASSED     [ 28%]
tests/test_cli.py::TestCLICommands::test_create_prompt_command PASSED    [ 28%]
tests/test_cli.py::TestCLICommands::test_delete_prompt_command PASSED    [ 28%]
tests/test_cli.py::TestCLICommands::test_health_command FAILED           [ 28%]
tests/test_cli.py::TestCLICommands::test_db_init PASSED                  [ 28%]
tests/test_cli.py::TestCLICommands::test_db_check_command PASSED         [ 28%]
tests/test_cli.py::TestHealthCheck::test_health_check_success FAILED     [ 29%]
tests/test_cli.py::TestHealthCheck::test_health_check_failure FAILED     [ 29%]
tests/test_cli.py::TestDatabaseCommands::test_db_init_success FAILED     [ 29%]
tests/test_cli.py::TestDatabaseCommands::test_db_init_connection_failure FAILED [ 29%]
tests/test_cli.py::TestDatabaseCommands::test_db_init_init_failure FAILED [ 29%]
tests/test_cli.py::TestInteractivePromptCreation::test_interactive_prompt_creation FAILED [ 29%]
tests/test_cli.py::TestOpenAPIGeneration::test_generate_openapi_spec_available PASSED [ 29%]
tests/test_cli.py::TestOpenAPIGeneration::test_export_openapi_json PASSED [ 30%]
tests/test_cli.py::TestOpenAPIGeneration::test_export_openapi_yaml PASSED [ 30%]
tests/test_cli.py::TestCLIIntegration::test_full_prompt_lifecycle FAILED [ 30%]
tests/test_cli.py::TestCLIIntegration::test_cli_error_handling PASSED    [ 30%]
tests/test_cli.py::TestCLIIntegration::test_cli_with_authentication PASSED [ 30%]
tests/test_cli.py::TestCLIIntegration::test_cli_version_information PASSED [ 30%]
tests/test_cli.py::TestCLIErrorScenarios::test_missing_required_options PASSED [ 30%]
tests/test_cli.py::TestCLIErrorScenarios::test_invalid_option_values PASSED [ 30%]
tests/test_cli.py::TestCLIErrorScenarios::test_api_unavailable_scenarios FAILED [ 31%]
tests/test_contract_testing.py::TestContractTesting::test_api_response_schema_validation SKIPPED [ 31%]
tests/test_contract_testing.py::TestContractTesting::test_backward_compatibility SKIPPED [ 31%]
tests/test_contract_testing.py::TestContractTesting::test_error_response_consistency ERROR [ 31%]
tests/test_contract_testing.py::TestContractTesting::test_openapi_specification_compliance PASSED [ 31%]
tests/test_contract_testing.py::TestContractTesting::test_frontend_backend_contract_validation PASSED [ 31%]
tests/test_contract_testing.py::TestContractTesting::test_cors_headers_and_security_compliance PASSED [ 31%]
tests/test_contract_testing.py::TestContractTesting::test_data_consistency_across_services SKIPPED [ 31%]
tests/test_crypto_utils.py::TestSecretManager::test_init_with_key PASSED [ 32%]
tests/test_crypto_utils.py::TestSecretManager::test_init_with_invalid_key PASSED [ 32%]
tests/test_crypto_utils.py::TestSecretManager::test_init_without_key_uses_environment PASSED [ 32%]
tests/test_crypto_utils.py::TestSecretManager::test_init_without_key_derives_from_password PASSED [ 32%]
tests/test_crypto_utils.py::TestSecretManager::test_encrypt_decrypt_string PASSED [ 32%]
tests/test_crypto_utils.py::TestSecretManager::test_encrypt_empty_string PASSED [ 32%]
tests/test_crypto_utils.py::TestSecretManager::test_encrypt_unicode_string PASSED [ 32%]
tests/test_crypto_utils.py::TestSecretManager::test_decrypt_invalid_data_raises_error PASSED [ 32%]
tests/test_crypto_utils.py::TestSecretManager::test_encrypt_with_different_managers_incompatible FAILED [ 33%]
tests/test_crypto_utils.py::TestSecretManager::test_encrypt_dict_with_sensitive_fields PASSED [ 33%]
tests/test_crypto_utils.py::TestSecretManager::test_decrypt_dict_with_encrypted_fields PASSED [ 33%]
tests/test_crypto_utils.py::TestSecretManager::test_encrypt_decrypt_dict_preserves_non_string_values PASSED [ 33%]
tests/test_crypto_utils.py::TestSecretManager::test_encrypt_dict_case_insensitive_field_detection PASSED [ 33%]
tests/test_crypto_utils.py::TestSecretManager::test_decrypt_dict_with_missing_encryption_markers PASSED [ 33%]
tests/test_crypto_utils.py::TestGlobalSecretManager::test_get_secret_manager_singleton PASSED [ 33%]
tests/test_crypto_utils.py::TestGlobalSecretManager::test_encrypt_secret_function PASSED [ 34%]
tests/test_crypto_utils.py::TestGlobalSecretManager::test_decrypt_secret_function PASSED [ 34%]
tests/test_crypto_utils.py::TestCryptoError::test_crypto_error_inheritance PASSED [ 34%]
tests/test_crypto_utils.py::TestSecurityBestPractices::test_encrypted_data_is_not_deterministic PASSED [ 34%]
tests/test_crypto_utils.py::TestSecurityBestPractices::test_key_derivation_with_different_passwords PASSED [ 34%]
tests/test_crypto_utils.py::TestSecurityBestPractices::test_key_derivation_with_different_salts PASSED [ 34%]
tests/test_crypto_utils.py::TestSecurityBestPractices::test_warning_logged_when_using_derived_key PASSED [ 34%]
tests/test_crypto_utils.py::TestCryptoIntegration::test_full_encryption_decryption_workflow PASSED [ 34%]
tests/test_crypto_utils.py::TestCryptoIntegration::test_cross_manager_incompatibility_security PASSED [ 35%]
tests/test_crypto_utils.py::TestCryptoIntegration::test_large_data_encryption PASSED [ 35%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_export_data_workflow FAILED [ 35%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_backup_workflow FAILED [ 35%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_restore_workflow PASSED [ 35%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_storage_stats_workflow FAILED [ 35%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_bulk_delete_documents_workflow FAILED [ 35%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_bulk_delete_conversations_workflow FAILED [ 35%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_bulk_delete_prompts_workflow FAILED [ 36%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_data_management_permission_workflow FAILED [ 36%]
tests/test_data_management_integration.py::TestDataManagementIntegration::test_cross_api_data_consistency FAILED [ 36%]
tests/test_data_management_unit.py::TestDataManagementUnit::test_export_data_endpoint_exists FAILED [ 36%]
tests/test_data_management_unit.py::TestDataManagementUnit::test_create_backup_endpoint_exists FAILED [ 36%]
tests/test_data_management_unit.py::TestDataManagementUnit::test_list_backups_endpoint_exists FAILED [ 36%]
tests/test_data_management_unit.py::TestDataManagementUnit::test_restore_data_endpoint_exists FAILED [ 36%]
tests/test_data_management_unit.py::TestDataManagementUnit::test_get_storage_stats_endpoint_exists FAILED [ 36%]
tests/test_data_management_unit.py::TestDataManagementUnit::test_bulk_delete_documents_endpoint_exists FAILED [ 37%]
tests/test_data_management_unit.py::TestDataManagementUnit::test_bulk_delete_conversations_endpoint_exists FAILED [ 37%]
tests/test_data_management_unit.py::TestDataManagementUnit::test_bulk_delete_prompts_endpoint_exists FAILED [ 37%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_user_model_has_required_constraints PASSED [ 37%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_conversation_model_has_required_constraints PASSED [ 37%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_message_model_has_required_constraints PASSED [ 37%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_user_relationships_are_properly_defined PASSED [ 37%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_foreign_key_references_are_valid PASSED [ 38%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_model_fields_match_schema_requirements PASSED [ 38%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_model_indexes_are_properly_defined PASSED [ 38%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_model_enum_fields_are_properly_configured PASSED [ 38%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_json_fields_are_properly_defined PASSED [ 38%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_document_model_has_required_constraints PASSED [ 38%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_document_chunk_model_has_required_constraints PASSED [ 38%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_profile_model_has_required_constraints PASSED [ 38%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_prompt_model_has_required_constraints PASSED [ 39%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_provider_model_has_required_constraints PASSED [ 39%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_model_def_has_required_constraints PASSED [ 39%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_embedding_space_has_required_constraints PASSED [ 39%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_analytics_models_have_required_constraints PASSED [ 39%]
tests/test_database_model_integrity.py::TestDatabaseModelIntegrity::test_toolserver_models_have_required_constraints PASSED [ 39%]
tests/test_database_testing.py::TestDatabaseTesting::test_migration_script_validation SKIPPED [ 39%]
tests/test_database_testing.py::TestDatabaseTesting::test_connection_pooling_behavior SKIPPED [ 39%]
tests/test_database_testing.py::TestDatabaseTesting::test_connection_pooling_behavior ERROR [ 39%]
tests/test_database_testing.py::TestDatabaseTesting::test_transaction_rollback_testing PASSED [ 40%]
tests/test_database_testing.py::TestDatabaseTesting::test_index_performance_validation SKIPPED [ 40%]
tests/test_database_testing.py::TestDatabaseTesting::test_foreign_key_constraint_enforcement SKIPPED [ 40%]
tests/test_database_testing.py::TestDatabaseTesting::test_data_integrity_and_consistency SKIPPED [ 40%]
tests/test_database_testing.py::TestDatabaseTesting::test_bulk_operation_performance PASSED [ 40%]
tests/test_database_testing.py::TestDatabaseTesting::test_connection_security_and_encryption PASSED [ 40%]
tests/test_database_testing.py::TestDatabaseTesting::test_database_backup_and_recovery_readiness PASSED [ 40%]
tests/test_database_testing.py::TestDatabaseTesting::test_query_performance_optimization SKIPPED [ 40%]
tests/test_database_testing.py::TestDatabaseTesting::test_database_api_integration_consistency PASSED [ 41%]
tests/test_documents_integration.py::TestDocumentsIntegration::test_document_upload_workflow FAILED [ 41%]
tests/test_documents_integration.py::TestDocumentsIntegration::test_document_list_and_search_workflow FAILED [ 41%]
tests/test_documents_integration.py::TestDocumentsIntegration::test_document_crud_workflow FAILED [ 41%]
tests/test_documents_integration.py::TestDocumentsIntegration::test_document_chunks_workflow FAILED [ 41%]
tests/test_documents_integration.py::TestDocumentsIntegration::test_document_processing_workflow FAILED [ 41%]
tests/test_documents_integration.py::TestDocumentsIntegration::test_document_stats_workflow FAILED [ 41%]
tests/test_documents_integration.py::TestDocumentsIntegration::test_document_download_workflow FAILED [ 42%]
tests/test_documents_integration.py::TestDocumentsIntegration::test_document_permission_workflow FAILED [ 42%]
tests/test_documents_unit.py::TestDocumentsUnit::test_upload_document_endpoint_exists FAILED [ 42%]
tests/test_documents_unit.py::TestDocumentsUnit::test_list_documents_endpoint_exists FAILED [ 42%]
tests/test_documents_unit.py::TestDocumentsUnit::test_search_documents_endpoint_exists FAILED [ 42%]
tests/test_documents_unit.py::TestDocumentsUnit::test_get_document_endpoint_exists FAILED [ 42%]
tests/test_documents_unit.py::TestDocumentsUnit::test_delete_document_endpoint_exists FAILED [ 42%]
tests/test_documents_unit.py::TestDocumentsUnit::test_update_document_endpoint_exists FAILED [ 42%]
tests/test_documents_unit.py::TestDocumentsUnit::test_get_document_chunks_endpoint_exists FAILED [ 43%]
tests/test_documents_unit.py::TestDocumentsUnit::test_process_document_endpoint_exists FAILED [ 43%]
tests/test_documents_unit.py::TestDocumentsUnit::test_get_document_stats_endpoint_exists FAILED [ 43%]
tests/test_documents_unit.py::TestDocumentsUnit::test_download_document_endpoint_exists FAILED [ 43%]
tests/test_events_integration.py::TestEventsIntegration::test_events_stream_workflow FAILED [ 43%]
tests/test_events_integration.py::TestEventsIntegration::test_events_stats_real_service FAILED [ 43%]
tests/test_events_integration.py::TestEventsIntegration::test_test_event_end_to_end FAILED [ 43%]
tests/test_events_integration.py::TestEventsIntegration::test_broadcast_test_end_to_end FAILED [ 43%]
tests/test_events_integration.py::TestEventsIntegration::test_multiple_sse_connections FAILED [ 44%]
tests/test_events_integration.py::TestEventsIntegration::test_events_workflow_with_database FAILED [ 44%]
tests/test_events_integration.py::TestEventsIntegration::test_event_validation_integration FAILED [ 44%]
tests/test_events_integration.py::TestEventsIntegration::test_event_data_serialization FAILED [ 44%]
tests/test_events_integration.py::TestEventsIntegration::test_concurrent_event_operations FAILED [ 44%]
tests/test_events_integration.py::TestEventsIntegration::test_sse_connection_cleanup FAILED [ 44%]
tests/test_events_unit.py::TestEventsUnit::test_events_stream_requires_auth FAILED [ 44%]
tests/test_events_unit.py::TestEventsUnit::test_admin_stream_requires_auth FAILED [ 44%]
tests/test_events_unit.py::TestEventsUnit::test_events_stats_requires_auth FAILED [ 45%]
tests/test_events_unit.py::TestEventsUnit::test_test_event_requires_auth FAILED [ 45%]
tests/test_events_unit.py::TestEventsUnit::test_broadcast_test_requires_auth FAILED [ 45%]
tests/test_events_unit.py::TestEventsUnit::test_events_stats_success FAILED [ 45%]
tests/test_events_unit.py::TestEventsUnit::test_test_event_success FAILED [ 45%]
tests/test_events_unit.py::TestEventsUnit::test_broadcast_test_success FAILED [ 45%]
tests/test_events_unit.py::TestEventsUnit::test_test_event_invalid_data FAILED [ 45%]
tests/test_events_unit.py::TestEventsUnit::test_broadcast_test_invalid_data FAILED [ 46%]
tests/test_events_unit.py::TestEventsUnit::test_events_stream_rate_limit FAILED [ 46%]
tests/test_events_unit.py::TestEventsUnit::test_events_stream_connection_limit FAILED [ 46%]
tests/test_events_unit.py::TestEventsUnit::test_events_stream_connection_not_found FAILED [ 46%]
tests/test_events_unit.py::TestEventsUnit::test_admin_stream_requires_admin FAILED [ 46%]
tests/test_events_unit.py::TestEventsUnit::test_events_stats_sse_service_error FAILED [ 46%]
tests/test_events_unit.py::TestEventsUnit::test_test_event_sse_service_error FAILED [ 46%]
tests/test_events_unit.py::TestEventsUnit::test_broadcast_test_sse_service_error FAILED [ 46%]
tests/test_health_integration.py::TestHealthIntegration::test_readiness_check_with_database FAILED [ 47%]
tests/test_health_integration.py::TestHealthIntegration::test_readiness_check_database_timeout PASSED [ 47%]
tests/test_health_integration.py::TestHealthIntegration::test_readiness_check_database_error PASSED [ 47%]
tests/test_health_integration.py::TestHealthIntegration::test_health_endpoints_response_consistency PASSED [ 47%]
tests/test_health_integration.py::TestHealthIntegration::test_readiness_check_performance PASSED [ 47%]
tests/test_health_integration.py::TestHealthIntegration::test_correlation_trace_nonexistent_id PASSED [ 47%]
tests/test_health_integration.py::TestHealthIntegration::test_metrics_endpoint_structure PASSED [ 47%]
tests/test_health_integration.py::TestHealthIntegration::test_multiple_readiness_checks_isolation PASSED [ 47%]
tests/test_health_integration.py::TestHealthIntegration::test_health_endpoints_concurrent_access PASSED [ 48%]
tests/test_health_unit.py::TestHealthUnit::test_health_check_endpoint PASSED [ 48%]
tests/test_health_unit.py::TestHealthUnit::test_liveness_check_endpoint PASSED [ 48%]
tests/test_health_unit.py::TestHealthUnit::test_health_and_liveness_different_status PASSED [ 48%]
tests/test_health_unit.py::TestHealthUnit::test_metrics_endpoint_without_monitoring PASSED [ 48%]
tests/test_health_unit.py::TestHealthUnit::test_correlation_trace_without_monitoring PASSED [ 48%]
tests/test_health_unit.py::TestHealthUnit::test_metrics_endpoint_with_monitoring_success FAILED [ 48%]
tests/test_health_unit.py::TestHealthUnit::test_metrics_endpoint_with_monitoring_error PASSED [ 48%]
tests/test_health_unit.py::TestHealthUnit::test_correlation_trace_with_monitoring_success FAILED [ 49%]
tests/test_health_unit.py::TestHealthUnit::test_correlation_trace_with_monitoring_error FAILED [ 49%]
tests/test_health_unit.py::TestHealthUnit::test_metrics_timestamp_format PASSED [ 49%]
tests/test_infrastructure.py::TestInfrastructureValidation::test_pytest_is_working PASSED [ 49%]
tests/test_infrastructure.py::TestInfrastructureValidation::test_unit_marker_works PASSED [ 49%]
tests/test_infrastructure.py::TestInfrastructureValidation::test_integration_marker_works PASSED [ 49%]
tests/test_infrastructure.py::TestInfrastructureValidation::test_test_data_fixture PASSED [ 49%]
tests/test_infrastructure.py::TestInfrastructureValidation::test_test_login_data_fixture PASSED [ 50%]
tests/test_infrastructure.py::TestInfrastructureValidation::test_async_test_support PASSED [ 50%]
tests/test_infrastructure.py::TestDatabaseFixtures::test_db_session_fixture PASSED [ 50%]
tests/test_infrastructure.py::TestDatabaseFixtures::test_app_fixture PASSED [ 50%]
tests/test_infrastructure.py::TestDatabaseFixtures::test_client_fixture PASSED [ 50%]
tests/test_integration_workflows.py::TestIntegrationWorkflows::test_document_to_chat_workflow SKIPPED [ 50%]
tests/test_integration_workflows.py::TestIntegrationWorkflows::test_user_agent_interaction_workflows SKIPPED [ 50%]
tests/test_integration_workflows.py::TestIntegrationWorkflows::test_analytics_across_multiple_services SKIPPED [ 50%]
tests/test_integration_workflows.py::TestIntegrationWorkflows::test_external_service_integration ERROR [ 51%]
tests/test_integration_workflows.py::TestIntegrationWorkflows::test_cache_service_integration SKIPPED [ 51%]
tests/test_integration_workflows.py::TestIntegrationWorkflows::test_error_propagation_and_recovery SKIPPED [ 51%]
tests/test_integration_workflows.py::TestIntegrationWorkflows::test_service_dependencies_and_graceful_degradation PASSED [ 51%]
tests/test_jobs_integration.py::TestJobsIntegration::test_job_complete_lifecycle FAILED [ 51%]
tests/test_jobs_integration.py::TestJobsIntegration::test_job_listing_and_filtering FAILED [ 51%]
tests/test_jobs_integration.py::TestJobsIntegration::test_job_cancellation_workflow FAILED [ 51%]
tests/test_jobs_integration.py::TestJobsIntegration::test_job_error_scenarios FAILED [ 51%]
tests/test_jobs_integration.py::TestJobsIntegration::test_job_validation_scenarios FAILED [ 52%]
tests/test_jobs_integration.py::TestJobsIntegration::test_job_stats_accuracy FAILED [ 52%]
tests/test_jobs_integration.py::TestJobsIntegration::test_job_cleanup_functionality FAILED [ 52%]
tests/test_jobs_integration.py::TestJobsIntegration::test_concurrent_job_operations FAILED [ 52%]
tests/test_jobs_integration.py::TestJobsIntegration::test_job_data_persistence FAILED [ 52%]
tests/test_jobs_unit.py::TestJobsUnit::test_create_job_requires_auth FAILED [ 52%]
tests/test_jobs_unit.py::TestJobsUnit::test_list_jobs_requires_auth FAILED [ 52%]
tests/test_jobs_unit.py::TestJobsUnit::test_get_job_requires_auth FAILED [ 52%]
tests/test_jobs_unit.py::TestJobsUnit::test_cancel_job_requires_auth FAILED [ 53%]
tests/test_jobs_unit.py::TestJobsUnit::test_get_job_stats_requires_auth FAILED [ 53%]
tests/test_jobs_unit.py::TestJobsUnit::test_cleanup_jobs_requires_auth FAILED [ 53%]
tests/test_jobs_unit.py::TestJobsUnit::test_create_job_success FAILED    [ 53%]
tests/test_jobs_unit.py::TestJobsUnit::test_create_job_invalid_function FAILED [ 53%]
tests/test_jobs_unit.py::TestJobsUnit::test_create_job_invalid_data FAILED [ 53%]
tests/test_jobs_unit.py::TestJobsUnit::test_list_jobs_success FAILED     [ 53%]
tests/test_jobs_unit.py::TestJobsUnit::test_list_jobs_with_filters FAILED [ 53%]
tests/test_jobs_unit.py::TestJobsUnit::test_get_job_success FAILED       [ 54%]
tests/test_jobs_unit.py::TestJobsUnit::test_get_job_not_found FAILED     [ 54%]
tests/test_jobs_unit.py::TestJobsUnit::test_get_job_invalid_id_format FAILED [ 54%]
tests/test_jobs_unit.py::TestJobsUnit::test_cancel_job_success FAILED    [ 54%]
tests/test_jobs_unit.py::TestJobsUnit::test_cancel_job_not_found FAILED  [ 54%]
tests/test_jobs_unit.py::TestJobsUnit::test_cancel_job_invalid_id_format FAILED [ 54%]
tests/test_jobs_unit.py::TestJobsUnit::test_get_job_stats_success FAILED [ 54%]
tests/test_jobs_unit.py::TestJobsUnit::test_cleanup_jobs_success FAILED  [ 55%]
tests/test_jobs_unit.py::TestJobsUnit::test_job_queue_error_handling ERROR [ 55%]
tests/test_jobs_unit.py::TestJobsUnit::test_list_jobs_pagination FAILED  [ 55%]
tests/test_mcp_service.py::TestOAuthConfig::test_oauth_config_creation PASSED [ 55%]
tests/test_mcp_service.py::TestOAuthConfig::test_oauth_config_with_optional_fields PASSED [ 55%]
tests/test_mcp_service.py::TestRemoteMCPServer::test_remote_server_creation PASSED [ 55%]
tests/test_mcp_service.py::TestRemoteMCPServer::test_remote_server_with_oauth PASSED [ 55%]
tests/test_mcp_service.py::TestMCPToolService::test_service_initialization PASSED [ 55%]
tests/test_mcp_service.py::TestMCPToolService::test_get_client PASSED    [ 56%]
tests/test_mcp_service.py::TestMCPToolService::test_validate_server_config_valid PASSED [ 56%]
tests/test_mcp_service.py::TestMCPToolService::test_validate_server_config_empty_name PASSED [ 56%]
tests/test_mcp_service.py::TestMCPToolService::test_validate_server_config_invalid_transport PASSED [ 56%]
tests/test_mcp_service.py::TestMCPToolService::test_is_server_healthy PASSED [ 56%]
tests/test_mcp_service.py::TestMCPToolService::test_retry_with_backoff_success_first_try PASSED [ 56%]
tests/test_mcp_service.py::TestMCPToolService::test_retry_with_backoff_success_after_retries PASSED [ 56%]
tests/test_mcp_service.py::TestMCPToolService::test_retry_with_backoff_all_retries_fail PASSED [ 56%]
tests/test_mcp_service.py::TestMCPToolService::test_retry_with_backoff_circuit_breaker PASSED [ 57%]
tests/test_mcp_service.py::TestMCPToolService::test_add_server_success FAILED [ 57%]
tests/test_mcp_service.py::TestMCPToolService::test_add_server_disabled_service FAILED [ 57%]
tests/test_mcp_service.py::TestMCPToolService::test_add_server_validation_error FAILED [ 57%]
tests/test_mcp_service.py::TestMCPToolService::test_remove_server_success PASSED [ 57%]
tests/test_mcp_service.py::TestMCPToolService::test_remove_nonexistent_server PASSED [ 57%]
tests/test_mcp_service.py::TestMCPToolService::test_discover_tools_success PASSED [ 57%]
tests/test_mcp_service.py::TestMCPToolService::test_discover_tools_disabled_service PASSED [ 57%]
tests/test_mcp_service.py::TestMCPToolService::test_discover_tools_nonexistent_server PASSED [ 58%]
tests/test_mcp_service.py::TestMCPToolService::test_discover_tools_unhealthy_server PASSED [ 58%]
tests/test_mcp_service.py::TestMCPToolService::test_get_tools_all_servers PASSED [ 58%]
tests/test_mcp_service.py::TestMCPToolService::test_get_tools_specific_servers PASSED [ 58%]
tests/test_mcp_service.py::TestMCPToolService::test_get_tools_disabled_service PASSED [ 58%]
tests/test_mcp_service.py::TestMCPToolService::test_call_tool_success FAILED [ 58%]
tests/test_mcp_service.py::TestMCPToolService::test_call_tool_disabled_service FAILED [ 58%]
tests/test_mcp_service.py::TestMCPToolService::test_list_servers FAILED  [ 59%]
tests/test_mcp_service.py::TestMCPToolService::test_get_server_info FAILED [ 59%]
tests/test_mcp_service.py::TestMCPToolService::test_get_server_info_nonexistent FAILED [ 59%]
tests/test_mcp_service.py::TestMCPToolService::test_authenticate_oauth_not_implemented PASSED [ 59%]
tests/test_mcp_service.py::TestMCPToolService::test_convert_server_to_connection_http PASSED [ 59%]
tests/test_mcp_service.py::TestMCPServiceIntegration::test_server_lifecycle FAILED [ 59%]
tests/test_mcp_service.py::TestMCPServiceIntegration::test_multiple_servers_management FAILED [ 59%]
tests/test_mcp_service.py::TestMCPServiceIntegration::test_error_recovery_scenarios FAILED [ 59%]
tests/test_mcp_service.py::TestMCPServiceError::test_mcp_service_error_creation PASSED [ 60%]
tests/test_mcp_service.py::TestMCPServiceError::test_mcp_service_error_with_cause PASSED [ 60%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_security_headers_added FAILED [ 60%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_content_security_policy_header FAILED [ 60%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_x_frame_options_header FAILED [ 60%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_x_content_type_options_header FAILED [ 60%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_x_xss_protection_header FAILED [ 60%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_referrer_policy_header FAILED [ 60%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_permissions_policy_header FAILED [ 61%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_strict_transport_security_enabled FAILED [ 61%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_strict_transport_security_disabled FAILED [ 61%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_security_headers_on_different_response_types FAILED [ 61%]
tests/test_middleware.py::TestSecurityHeadersMiddleware::test_security_headers_dont_override_existing FAILED [ 61%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_middleware_initialization PASSED [ 61%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_rate_limit_configuration PASSED [ 61%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_login_endpoint_rate_limiting FAILED [ 61%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_register_endpoint_rate_limiting FAILED [ 62%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_password_reset_endpoint_rate_limiting FAILED [ 62%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_non_auth_endpoint_not_rate_limited PASSED [ 62%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_rate_limit_allowed_request PASSED [ 62%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_client_ip_identification FAILED [ 62%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_rate_limit_with_user_agent_tracking FAILED [ 62%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_rate_limit_error_handling PASSED [ 62%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_different_auth_endpoints_have_different_limits PASSED [ 63%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_get_client_ip_x_forwarded_for PASSED [ 63%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_get_client_ip_x_real_ip PASSED [ 63%]
tests/test_middleware.py::TestAuthRateLimitMiddleware::test_get_client_ip_fallback PASSED [ 63%]
tests/test_middleware.py::TestMiddlewareIntegration::test_both_middleware_applied FAILED [ 63%]
tests/test_middleware.py::TestMiddlewareIntegration::test_security_headers_on_rate_limited_response FAILED [ 63%]
tests/test_middleware.py::TestMiddlewareIntegration::test_non_auth_endpoints_only_security_headers FAILED [ 63%]
tests/test_middleware.py::TestMiddlewareIntegration::test_middleware_order_matters FAILED [ 63%]
tests/test_middleware.py::TestMiddlewareIntegration::test_middleware_performance FAILED [ 64%]
tests/test_middleware.py::TestMiddlewareEdgeCases::test_security_middleware_with_exception PASSED [ 64%]
tests/test_middleware.py::TestMiddlewareEdgeCases::test_empty_app_with_middleware FAILED [ 64%]
tests/test_middleware.py::TestMiddlewareEdgeCases::test_rate_limit_middleware_with_none_client PASSED [ 64%]
tests/test_model_registry_fixes.py::TestDefaultProviderLogic::test_set_default_provider_with_model_type PASSED [ 64%]
tests/test_model_registry_fixes.py::TestDefaultProviderLogic::test_set_default_provider_without_models_fails PASSED [ 64%]
tests/test_model_registry_fixes.py::TestDefaultProviderLogic::test_set_default_provider_nonexistent_fails PASSED [ 64%]
tests/test_model_registry_fixes.py::TestDefaultProviderLogic::test_get_default_provider_by_model_type FAILED [ 64%]
tests/test_model_registry_fixes.py::TestValidationImprovements::test_create_model_validates_provider_exists PASSED [ 65%]
tests/test_model_registry_fixes.py::TestValidationImprovements::test_create_model_validates_provider_active PASSED [ 65%]
tests/test_model_registry_fixes.py::TestValidationImprovements::test_create_embedding_space_validates_model_exists PASSED [ 65%]
tests/test_model_registry_fixes.py::TestValidationImprovements::test_create_embedding_space_validates_model_type PASSED [ 65%]
tests/test_model_registry_fixes.py::TestValidationImprovements::test_create_embedding_space_validates_model_active PASSED [ 65%]
tests/test_model_registry_fixes.py::TestValidationImprovements::test_create_embedding_space_validates_dimensions PASSED [ 65%]
tests/test_model_registry_fixes.py::TestBusinessLogicImprovements::test_set_default_provider_sets_model_default PASSED [ 65%]
tests/test_model_registry_fixes.py::TestBusinessLogicImprovements::test_multiple_providers_different_model_types FAILED [ 65%]
tests/test_model_registry_fixes.py::TestTransactionManagement::test_create_model_transaction_rollback_on_error FAILED [ 66%]
tests/test_model_registry_validation.py::TestModelValidation::test_validate_model_consistency_embedding_without_dimensions PASSED [ 66%]
tests/test_model_registry_validation.py::TestModelValidation::test_validate_model_consistency_llm_with_dimensions PASSED [ 66%]
tests/test_model_registry_validation.py::TestModelValidation::test_validate_model_consistency_negative_max_tokens PASSED [ 66%]
tests/test_model_registry_validation.py::TestModelValidation::test_validate_model_consistency_batch_settings_conflict PASSED [ 66%]
tests/test_model_registry_validation.py::TestModelValidation::test_validate_model_consistency_valid_embedding_model PASSED [ 66%]
tests/test_model_registry_validation.py::TestModelValidation::test_validate_model_consistency_valid_llm_model PASSED [ 66%]
tests/test_model_registry_validation.py::TestValidationErrorMessages::test_validation_error_contains_helpful_context PASSED [ 67%]
tests/test_model_registry_validation.py::TestValidationErrorMessages::test_validation_error_is_exception PASSED [ 67%]
tests/test_model_registry_validation.py::TestBusinessLogicValidation::test_dimension_mismatch_error_message PASSED [ 67%]
tests/test_model_registry_validation.py::TestBusinessLogicValidation::test_provider_model_type_mismatch_error PASSED [ 67%]
tests/test_performance.py::TestPerformance::test_authentication_endpoint_performance SKIPPED [ 67%]
tests/test_performance.py::TestPerformance::test_chat_message_processing_benchmarks SKIPPED [ 67%]
tests/test_performance.py::TestPerformance::test_document_upload_performance_validation SKIPPED [ 67%]
tests/test_performance.py::TestPerformance::test_concurrent_request_handling PASSED [ 67%]
tests/test_performance.py::TestPerformance::test_memory_usage_and_leak_detection SKIPPED [ 68%]
tests/test_performance.py::TestPerformance::test_database_query_optimization SKIPPED [ 68%]
tests/test_performance.py::TestPerformance::test_sustained_load_performance PASSED [ 68%]
tests/test_performance.py::TestPerformance::test_response_time_consistency PASSED [ 68%]
tests/test_plugins.py::TestBasePlugin::test_base_plugin_initialization FAILED [ 68%]
tests/test_plugins.py::TestBasePlugin::test_base_plugin_default_config FAILED [ 68%]
tests/test_plugins.py::TestBasePlugin::test_base_plugin_get_configuration_schema FAILED [ 68%]
tests/test_plugins.py::TestBasePlugin::test_validate_configuration_no_schema FAILED [ 68%]
tests/test_plugins.py::TestBasePlugin::test_validate_configuration_with_schema FAILED [ 69%]
tests/test_plugins.py::TestBasePlugin::test_validate_configuration_type_checking FAILED [ 69%]
tests/test_plugins.py::TestBasePlugin::test_validate_configuration_error_handling FAILED [ 69%]
tests/test_plugins.py::TestToolPlugin::test_tool_plugin_inheritance FAILED [ 69%]
tests/test_plugins.py::TestToolPlugin::test_get_tools_abstract_method PASSED [ 69%]
tests/test_plugins.py::TestToolPlugin::test_get_tools_implementation FAILED [ 69%]
tests/test_plugins.py::TestWorkflowPlugin::test_workflow_plugin_inheritance FAILED [ 69%]
tests/test_plugins.py::TestWorkflowPlugin::test_execute_workflow_abstract_method PASSED [ 69%]
tests/test_plugins.py::TestPluginManager::test_plugin_manager_initialization FAILED [ 70%]
tests/test_plugins.py::TestPluginManager::test_get_plugin_directory_default FAILED [ 70%]
tests/test_plugins.py::TestPluginManager::test_get_plugin_directory_custom FAILED [ 70%]
tests/test_plugins.py::TestPluginManager::test_load_plugin_from_file_success FAILED [ 70%]
tests/test_plugins.py::TestPluginManager::test_load_plugin_from_file_missing_file FAILED [ 70%]
tests/test_plugins.py::TestPluginManager::test_load_plugin_from_file_syntax_error FAILED [ 70%]
tests/test_plugins.py::TestPluginManager::test_unload_plugin_success FAILED [ 70%]
tests/test_plugins.py::TestPluginManager::test_unload_plugin_not_found FAILED [ 71%]
tests/test_plugins.py::TestPluginManager::test_unload_plugin_cleanup_error FAILED [ 71%]
tests/test_plugins.py::TestPluginManager::test_list_plugins FAILED       [ 71%]
tests/test_plugins.py::TestPluginManager::test_list_plugins_by_type FAILED [ 71%]
tests/test_plugins.py::TestPluginManager::test_list_plugins_by_status FAILED [ 71%]
tests/test_plugins.py::TestPluginManager::test_get_plugin_info_found FAILED [ 71%]
tests/test_plugins.py::TestPluginManager::test_get_plugin_info_not_found FAILED [ 71%]
tests/test_plugins.py::TestPluginManager::test_get_tools_from_plugins FAILED [ 71%]
tests/test_plugins.py::TestPluginManager::test_get_tools_from_plugins_inactive_ignored FAILED [ 72%]
tests/test_plugins.py::TestPluginManager::test_health_check_all_plugins FAILED [ 72%]
tests/test_plugins.py::TestPluginManager::test_health_check_plugin_error FAILED [ 72%]
tests/test_plugins.py::TestPluginIntegration::test_plugin_lifecycle FAILED [ 72%]
tests/test_plugins.py::TestPluginIntegration::test_multiple_plugins_management FAILED [ 72%]
tests/test_plugins.py::TestPluginError::test_plugin_error_creation PASSED [ 72%]
tests/test_plugins.py::TestPluginError::test_plugin_error_with_cause PASSED [ 72%]
tests/test_postgresql_functionality.py::TestPostgreSQLDatabase::test_postgresql_session_exists PASSED [ 72%]
tests/test_postgresql_functionality.py::TestPostgreSQLDatabase::test_postgresql_basic_query PASSED [ 73%]
tests/test_postgresql_functionality.py::TestPostgreSQLDatabase::test_postgresql_engine_info PASSED [ 73%]
tests/test_postgresql_functionality.py::TestPostgreSQLDatabase::test_postgresql_transaction_rollback PASSED [ 73%]
tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_complete_lifecycle FAILED [ 73%]
tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_list_and_filter FAILED [ 73%]
tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_stats_and_providers FAILED [ 73%]
tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_error_scenarios FAILED [ 73%]
tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_data_validation FAILED [ 73%]
tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_concurrent_operations FAILED [ 74%]
tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_complex_data_handling FAILED [ 74%]
tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_testing_functionality FAILED [ 74%]
tests/test_profiles_unit.py::TestProfilesUnit::test_create_profile_requires_auth FAILED [ 74%]
tests/test_profiles_unit.py::TestProfilesUnit::test_list_profiles_requires_auth FAILED [ 74%]
tests/test_profiles_unit.py::TestProfilesUnit::test_get_profile_requires_auth FAILED [ 74%]
tests/test_profiles_unit.py::TestProfilesUnit::test_update_profile_requires_auth FAILED [ 74%]
tests/test_profiles_unit.py::TestProfilesUnit::test_delete_profile_requires_auth FAILED [ 75%]
tests/test_profiles_unit.py::TestProfilesUnit::test_test_profile_requires_auth FAILED [ 75%]
tests/test_profiles_unit.py::TestProfilesUnit::test_clone_profile_requires_auth FAILED [ 75%]
tests/test_profiles_unit.py::TestProfilesUnit::test_get_profile_stats_requires_auth FAILED [ 75%]
tests/test_profiles_unit.py::TestProfilesUnit::test_get_available_providers_requires_auth FAILED [ 75%]
tests/test_profiles_unit.py::TestProfilesUnit::test_create_profile_success FAILED [ 75%]
tests/test_profiles_unit.py::TestProfilesUnit::test_create_profile_invalid_data FAILED [ 75%]
tests/test_profiles_unit.py::TestProfilesUnit::test_create_profile_rate_limit FAILED [ 75%]
tests/test_profiles_unit.py::TestProfilesUnit::test_list_profiles_success FAILED [ 76%]
tests/test_profiles_unit.py::TestProfilesUnit::test_get_profile_success FAILED [ 76%]
tests/test_profiles_unit.py::TestProfilesUnit::test_get_profile_not_found FAILED [ 76%]
tests/test_profiles_unit.py::TestProfilesUnit::test_update_profile_success FAILED [ 76%]
tests/test_profiles_unit.py::TestProfilesUnit::test_delete_profile_success FAILED [ 76%]
tests/test_profiles_unit.py::TestProfilesUnit::test_test_profile_success FAILED [ 76%]
tests/test_profiles_unit.py::TestProfilesUnit::test_clone_profile_success FAILED [ 76%]
tests/test_profiles_unit.py::TestProfilesUnit::test_get_profile_stats_success FAILED [ 76%]
tests/test_profiles_unit.py::TestProfilesUnit::test_get_available_providers_success FAILED [ 77%]
tests/test_profiles_unit.py::TestProfilesUnit::test_profile_service_error_handling FAILED [ 77%]
tests/test_profiles_unit.py::TestProfilesUnit::test_profile_validation_errors FAILED [ 77%]
tests/test_profiles_unit.py::TestProfilesUnit::test_list_profiles_filtering FAILED [ 77%]
tests/test_profiles_unit.py::TestProfilesUnit::test_test_profile_rate_limit FAILED [ 77%]
tests/test_schema_model_consistency.py::TestSchemaModelConsistency::test_user_registration_schema_matches_model_fields PASSED [ 77%]
tests/test_schema_model_consistency.py::TestSchemaModelConsistency::test_user_update_schema_matches_model_fields PASSED [ 77%]
tests/test_schema_model_consistency.py::TestSchemaModelConsistency::test_user_response_schema_matches_model_fields PASSED [ 77%]
tests/test_schema_model_consistency.py::TestSchemaModelConsistency::test_user_model_required_fields_in_schemas PASSED [ 78%]
tests/test_schema_model_consistency.py::TestSchemaModelConsistency::test_phone_number_field_exists_in_user_model PASSED [ 78%]
tests/test_schema_model_consistency.py::TestSchemaModelConsistency::test_user_schema_validation_with_phone_number PASSED [ 78%]
tests/test_schema_model_consistency.py::TestSchemaModelConsistency::test_user_model_can_store_phone_number PASSED [ 78%]
tests/test_security_testing.py::TestSecurityTesting::test_sql_injection_protection_validation SKIPPED [ 78%]
tests/test_security_testing.py::TestSecurityTesting::test_xss_prevention PASSED [ 78%]
tests/test_security_testing.py::TestSecurityTesting::test_authentication_security_brute_force_protection SKIPPED [ 78%]
tests/test_security_testing.py::TestSecurityTesting::test_authorization_checks_and_token_validation SKIPPED [ 78%]
tests/test_security_testing.py::TestSecurityTesting::test_file_upload_security_malicious_detection SKIPPED [ 79%]
tests/test_security_testing.py::TestSecurityTesting::test_input_validation_and_sanitization SKIPPED [ 79%]
tests/test_security_testing.py::TestSecurityTesting::test_security_headers_validation PASSED [ 79%]
tests/test_security_testing.py::TestSecurityTesting::test_information_disclosure_prevention PASSED [ 79%]
tests/test_security_testing.py::TestSecurityTesting::test_cors_configuration_security PASSED [ 79%]
tests/test_seeding_fixes.py::TestSeedingEnumFixes::test_prompt_category_enums_exist PASSED [ 79%]
tests/test_seeding_fixes.py::TestSeedingEnumFixes::test_profile_type_enums_exist PASSED [ 79%]
tests/test_seeding_fixes.py::TestDatabaseSeederBasics::test_seeder_initialization PASSED [ 80%]
tests/test_seeding_fixes.py::TestDatabaseSeederBasics::test_count_users_mock PASSED [ 80%]
tests/test_seeding_fixes.py::TestConfigurableSeederBasics::test_configurable_seeder_initialization PASSED [ 80%]
tests/test_seeding_fixes.py::TestConfigurableSeederBasics::test_yaml_config_loading_with_missing_file PASSED [ 80%]
tests/test_seeding_fixes.py::TestSeedingModes::test_seeding_modes_exist PASSED [ 80%]
tests/test_seeding_fixes.py::TestSeedingModes::test_seeding_mode_values PASSED [ 80%]
tests/test_seeding_fixes.py::TestMethodImplementations::test_demo_embedding_spaces_method_exists PASSED [ 80%]
tests/test_seeding_fixes.py::TestMethodImplementations::test_test_registry_data_method_exists PASSED [ 80%]
tests/test_seeding_fixes.py::TestMethodImplementations::test_test_conversations_method_exists PASSED [ 81%]
tests/test_seeding_fixes.py::TestMethodImplementations::test_test_documents_method_exists PASSED [ 81%]
tests/test_seeding_fixes.py::TestErrorHandling::test_seeding_handles_exceptions PASSED [ 81%]
tests/test_seeding_fixes.py::TestSkipExistingLogic::test_skip_existing_when_users_exist PASSED [ 81%]
tests/test_seeding_fixes.py::TestSkipExistingLogic::test_force_mode_bypasses_existing_check PASSED [ 81%]
tests/test_streaming.py::TestStreamingEventType::test_streaming_event_types PASSED [ 81%]
tests/test_streaming.py::TestStreamingEventType::test_streaming_event_type_string_values PASSED [ 81%]
tests/test_streaming.py::TestStreamingEvent::test_streaming_event_data_creation FAILED [ 81%]
tests/test_streaming.py::TestStreamingEvent::test_streaming_event_data_minimal FAILED [ 82%]
tests/test_streaming.py::TestStreamingEvent::test_streaming_event_data_auto_timestamp FAILED [ 82%]
tests/test_streaming.py::TestStreamingEvent::test_streaming_event_data_with_metadata FAILED [ 82%]
tests/test_streaming.py::TestStreamingError::test_streaming_error_basic PASSED [ 82%]
tests/test_streaming.py::TestStreamingError::test_streaming_error_with_event_type PASSED [ 82%]
tests/test_streaming.py::TestStreamingError::test_streaming_error_inheritance PASSED [ 82%]
tests/test_streaming.py::TestStreamingService::test_streaming_service_initialization PASSED [ 82%]
tests/test_streaming.py::TestStreamingService::test_create_stream PASSED [ 82%]
tests/test_streaming.py::TestStreamingService::test_create_stream_auto_correlation_id PASSED [ 83%]
tests/test_streaming.py::TestStreamingService::test_create_stream_metrics_initialization PASSED [ 83%]
tests/test_streaming.py::TestStreamingService::test_end_stream FAILED    [ 83%]
tests/test_streaming.py::TestStreamingService::test_end_nonexistent_stream PASSED [ 83%]
tests/test_streaming.py::TestStreamingService::test_stream_event_basic FAILED [ 83%]
tests/test_streaming.py::TestStreamingService::test_stream_token FAILED  [ 83%]
tests/test_streaming.py::TestStreamingService::test_stream_tool_call_lifecycle FAILED [ 83%]
tests/test_streaming.py::TestStreamingService::test_stream_thinking FAILED [ 84%]
tests/test_streaming.py::TestStreamingService::test_stream_source_found FAILED [ 84%]
tests/test_streaming.py::TestStreamingService::test_stream_error FAILED  [ 84%]
tests/test_streaming.py::TestStreamingService::test_stream_complete FAILED [ 84%]
tests/test_streaming.py::TestStreamingService::test_stream_metadata FAILED [ 84%]
tests/test_streaming.py::TestStreamingService::test_get_stream_metrics FAILED [ 84%]
tests/test_streaming.py::TestStreamingService::test_get_nonexistent_stream_metrics FAILED [ 84%]
tests/test_streaming.py::TestStreamingService::test_list_active_streams FAILED [ 84%]
tests/test_streaming.py::TestStreamingService::test_is_stream_active FAILED [ 85%]
tests/test_streaming.py::TestStreamingService::test_stream_activity_tracking FAILED [ 85%]
tests/test_streaming.py::TestStreamingService::test_stream_error_handling_invalid_stream FAILED [ 85%]
tests/test_streaming.py::TestStreamingService::test_concurrent_streams FAILED [ 85%]
tests/test_streaming.py::TestStreamingService::test_stream_cleanup_on_error FAILED [ 85%]
tests/test_streaming.py::TestStreamingServiceIntegration::test_complete_streaming_workflow FAILED [ 85%]
tests/test_streaming.py::TestStreamingServiceIntegration::test_error_recovery_workflow FAILED [ 85%]
tests/test_streaming.py::TestStreamingServiceIntegration::test_performance_with_high_volume_streaming FAILED [ 85%]
tests/test_streaming.py::TestStreamingServiceIntegration::test_stream_isolation FAILED [ 86%]
tests/test_toolserver_improvements.py::test_crypto_utility PASSED        [ 86%]
tests/test_toolserver_improvements.py::test_rate_limiter PASSED          [ 86%]
tests/test_toolserver_improvements.py::test_mcp_service_validation PASSED [ 86%]
tests/test_toolserver_improvements.py::test_schema_validation PASSED     [ 86%]
tests/test_unified_cache.py::TestCacheInterface::test_memory_cache_basic_operations PASSED [ 86%]
tests/test_unified_cache.py::TestCacheInterface::test_memory_cache_batch_operations PASSED [ 86%]
tests/test_unified_cache.py::TestCacheInterface::test_memory_cache_increment PASSED [ 86%]
tests/test_unified_cache.py::TestCacheInterface::test_memory_cache_ttl PASSED [ 87%]
tests/test_unified_cache.py::TestCacheInterface::test_memory_cache_key_generation PASSED [ 87%]
tests/test_unified_cache.py::TestCacheInterface::test_memory_cache_eviction PASSED [ 87%]
tests/test_unified_cache.py::TestCacheInterface::test_memory_cache_stats PASSED [ 87%]
tests/test_unified_cache.py::TestCacheInterface::test_memory_cache_health_check PASSED [ 87%]
tests/test_unified_cache.py::TestCacheFactory::test_create_different_cache_types PASSED [ 87%]
tests/test_unified_cache.py::TestCacheFactory::test_convenience_methods PASSED [ 87%]
tests/test_unified_cache.py::TestCacheFactory::test_health_check_all PASSED [ 88%]
tests/test_unified_cache.py::TestCacheFactory::test_get_stats_all PASSED [ 88%]
tests/test_unified_cache.py::TestUnifiedModelRegistryCache::test_default_provider_operations PASSED [ 88%]
tests/test_unified_cache.py::TestUnifiedModelRegistryCache::test_provider_data_operations PASSED [ 88%]
tests/test_unified_cache.py::TestUnifiedModelRegistryCache::test_list_operations PASSED [ 88%]
tests/test_unified_cache.py::TestUnifiedWorkflowCache::test_workflow_operations PASSED [ 88%]
tests/test_unified_cache.py::TestUnifiedWorkflowCache::test_workflow_stats PASSED [ 88%]
tests/test_unified_cache.py::TestUnifiedWorkflowCache::test_workflow_key_generation PASSED [ 88%]
tests/test_unified_cache.py::test_cache_integration PASSED               [ 89%]
tests/test_unified_events.py::TestUnifiedEvent::test_create_unified_event PASSED [ 89%]
tests/test_unified_events.py::TestUnifiedEvent::test_event_to_dict PASSED [ 89%]
tests/test_unified_events.py::TestUnifiedEvent::test_event_from_dict PASSED [ 89%]
tests/test_unified_events.py::TestEventCreationFunctions::test_create_realtime_event PASSED [ 89%]
tests/test_unified_events.py::TestEventCreationFunctions::test_create_security_event PASSED [ 89%]
tests/test_unified_events.py::TestEventCreationFunctions::test_create_audit_event PASSED [ 89%]
tests/test_unified_events.py::TestEventCreationFunctions::test_create_streaming_event PASSED [ 89%]
tests/test_unified_events.py::TestEventCreationFunctions::test_create_analytics_event PASSED [ 90%]
tests/test_unified_events.py::TestEventRouter::test_register_emitter PASSED [ 90%]
tests/test_unified_events.py::TestEventRouter::test_add_handlers PASSED  [ 90%]
tests/test_unified_events.py::TestEventRouter::test_route_event PASSED   [ 90%]
tests/test_unified_events.py::TestUnifiedEventManager::test_manager_initialization PASSED [ 90%]
tests/test_unified_events.py::TestUnifiedEventManager::test_emit_different_event_types PASSED [ 90%]
tests/test_unified_events.py::TestUnifiedEventManager::test_system_alert PASSED [ 90%]
tests/test_unified_events.py::TestEventIntegration::test_full_event_flow PASSED [ 90%]
tests/test_unified_events.py::TestEventIntegration::test_convenience_functions PASSED [ 91%]
tests/test_unified_events.py::TestMinimalIntegration::test_setup_functions PASSED [ 91%]
tests/test_unified_events.py::TestMinimalIntegration::test_convenience_without_manager PASSED [ 91%]
tests/test_unified_events.py::TestMinimalIntegration::test_get_stats_without_manager PASSED [ 91%]
tests/test_unified_validation.py::TestValidationEngine::test_validate_input_success PASSED [ 91%]
tests/test_unified_validation.py::TestValidationEngine::test_validate_input_failure PASSED [ 91%]
tests/test_unified_validation.py::TestValidationEngine::test_validate_security_success PASSED [ 91%]
tests/test_unified_validation.py::TestValidationEngine::test_validate_security_failure PASSED [ 92%]
tests/test_unified_validation.py::TestInputValidator::test_email_validation PASSED [ 92%]
tests/test_unified_validation.py::TestInputValidator::test_username_validation PASSED [ 92%]
tests/test_unified_validation.py::TestInputValidator::test_sanitization PASSED [ 92%]
tests/test_unified_validation.py::TestSecurityValidator::test_xss_detection PASSED [ 92%]
tests/test_unified_validation.py::TestSecurityValidator::test_sql_injection_detection PASSED [ 92%]
tests/test_unified_validation.py::TestSecurityValidator::test_path_traversal_detection PASSED [ 92%]
tests/test_unified_validation.py::TestBusinessValidator::test_model_consistency PASSED [ 92%]
tests/test_unified_validation.py::TestBusinessValidator::test_embedding_space_validation PASSED [ 93%]
tests/test_unified_validation.py::TestValidationContext::test_context_overrides PASSED [ 93%]
tests/test_unified_validation.py::TestValidationContext::test_context_modes PASSED [ 93%]
tests/test_unified_validation.py::TestValidationContext::test_validator_enablement PASSED [ 93%]
tests/test_unified_validation.py::TestBackwardsCompatibility::test_legacy_imports SKIPPED [ 93%]
tests/test_unified_validation.py::TestBackwardsCompatibility::test_legacy_validator_classes SKIPPED [ 93%]
tests/test_unified_validation.py::TestValidationResult::test_result_creation PASSED [ 93%]
tests/test_unified_validation.py::TestValidationResult::test_result_with_errors PASSED [ 93%]
tests/test_unified_validation.py::TestValidationResult::test_result_merging PASSED [ 94%]
tests/test_versioning.py::TestAPIVersion::test_api_version_values PASSED [ 94%]
tests/test_versioning.py::TestAPIVersion::test_api_version_string_representation FAILED [ 94%]
tests/test_versioning.py::TestVersionStatus::test_version_status_values FAILED [ 94%]
tests/test_versioning.py::TestVersionStatus::test_version_status_progression FAILED [ 94%]
tests/test_versioning.py::TestVersionInfo::test_version_info_creation PASSED [ 94%]
tests/test_versioning.py::TestVersionInfo::test_version_info_minimal PASSED [ 94%]
tests/test_versioning.py::TestEndpointVersioning::test_endpoint_versioning_creation FAILED [ 94%]
tests/test_versioning.py::TestEndpointVersioning::test_endpoint_versioning_lifecycle FAILED [ 95%]
tests/test_versioning.py::TestAPIVersionManager::test_manager_initialization PASSED [ 95%]
tests/test_versioning.py::TestAPIVersionManager::test_default_versions_loaded FAILED [ 95%]
tests/test_versioning.py::TestAPIVersionManager::test_add_version PASSED [ 95%]
tests/test_versioning.py::TestAPIVersionManager::test_get_version_info_existing PASSED [ 95%]
tests/test_versioning.py::TestAPIVersionManager::test_get_version_info_nonexistent PASSED [ 95%]
tests/test_versioning.py::TestAPIVersionManager::test_get_all_versions PASSED [ 95%]
tests/test_versioning.py::TestAPIVersionManager::test_get_active_versions PASSED [ 96%]
tests/test_versioning.py::TestAPIVersionManager::test_is_version_supported_active PASSED [ 96%]
tests/test_versioning.py::TestAPIVersionManager::test_is_version_supported_deprecated PASSED [ 96%]
tests/test_versioning.py::TestAPIVersionManager::test_is_version_supported_sunset PASSED [ 96%]
tests/test_versioning.py::TestAPIVersionManager::test_is_version_supported_nonexistent PASSED [ 96%]
tests/test_versioning.py::TestAPIVersionManager::test_register_endpoint PASSED [ 96%]
tests/test_versioning.py::TestAPIVersionManager::test_register_endpoint_method_normalization PASSED [ 96%]
tests/test_versioning.py::TestAPIVersionManager::test_is_endpoint_available_current_version PASSED [ 96%]
tests/test_versioning.py::TestAPIVersionManager::test_is_endpoint_available_future_version PASSED [ 97%]
tests/test_versioning.py::TestAPIVersionManager::test_is_endpoint_available_after_removal PASSED [ 97%]
tests/test_versioning.py::TestAPIVersionManager::test_is_endpoint_available_unregistered FAILED [ 97%]
tests/test_versioning.py::TestAPIVersionManager::test_deprecate_endpoint FAILED [ 97%]
tests/test_versioning.py::TestAPIVersionManager::test_deprecate_nonexistent_endpoint FAILED [ 97%]
tests/test_versioning.py::TestAPIVersionManager::test_get_endpoint_info FAILED [ 97%]
tests/test_versioning.py::TestAPIVersionManager::test_get_endpoint_info_nonexistent FAILED [ 97%]
tests/test_versioning.py::TestAPIVersionManager::test_get_endpoints_for_version FAILED [ 97%]
tests/test_versioning.py::TestAPIVersionManager::test_version_middleware_integration FAILED [ 98%]
tests/test_versioning.py::TestVersioningIntegration::test_complete_version_lifecycle FAILED [ 98%]
tests/test_versioning.py::TestVersioningIntegration::test_version_migration_scenario FAILED [ 98%]
tests/test_versioning.py::TestVersioningIntegration::test_backwards_compatibility_checking FAILED [ 98%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowLimitManager::test_get_default_limits PASSED [ 98%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowLimitManager::test_concurrent_limit_check PASSED [ 98%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowLimitManager::test_workflow_tracking_lifecycle PASSED [ 98%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowLimitManager::test_resource_limit_checking PASSED [ 98%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowLimitManager::test_timeout_context_manager PASSED [ 99%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowLimitManager::test_workflow_stats PASSED [ 99%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_execute_workflow_with_limits FAILED [ 99%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_execute_workflow_timeout FAILED [ 99%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_concurrent_workflow_limit FAILED [ 99%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_streaming_workflow_with_limits FAILED [ 99%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_streaming_workflow_timeout FAILED [ 99%]
tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_enhanced_token_streaming_all_workflows FAILED [100%]

==================================== ERRORS ====================================
______ ERROR at setup of TestAuthE2E.test_complete_registration_workflow _______

fixturedef = <FixtureDef argname='e2e_client' scope='function' baseid='tests/e2e'>
request = <SubRequest 'e2e_client' for <Coroutine test_complete_registration_workflow>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:272: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:268: in setup
    res = await gen_obj.__anext__()  # type: ignore[union-attr]
          ^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

app = <fastapi.applications.FastAPI object at 0x7f59ad6d1b20>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59ac4f0bf0>

    @pytest.fixture
    async def e2e_client(app, db_session: AsyncSession) -> AsyncClient:
        """
        Async HTTP client configured for E2E testing with real database.
        """
>       async with AsyncClient(
            app=app,
            base_url="http://testserver",
            timeout=30.0  # Longer timeout for E2E tests
        ) as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/e2e/conftest.py:17: TypeError
__________ ERROR at setup of TestAuthE2E.test_complete_login_workflow __________

fixturedef = <FixtureDef argname='e2e_client' scope='function' baseid='tests/e2e'>
request = <SubRequest 'e2e_client' for <Coroutine test_complete_login_workflow>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:272: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:268: in setup
    res = await gen_obj.__anext__()  # type: ignore[union-attr]
          ^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

app = <fastapi.applications.FastAPI object at 0x7f59ad0cbc20>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a759d9a0>

    @pytest.fixture
    async def e2e_client(app, db_session: AsyncSession) -> AsyncClient:
        """
        Async HTTP client configured for E2E testing with real database.
        """
>       async with AsyncClient(
            app=app,
            base_url="http://testserver",
            timeout=30.0  # Longer timeout for E2E tests
        ) as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/e2e/conftest.py:17: TypeError
__________ ERROR at setup of TestAuthE2E.test_profile_access_workflow __________

fixturedef = <FixtureDef argname='e2e_client' scope='function' baseid='tests/e2e'>
request = <SubRequest 'e2e_client' for <Coroutine test_profile_access_workflow>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:272: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:268: in setup
    res = await gen_obj.__anext__()  # type: ignore[union-attr]
          ^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

app = <fastapi.applications.FastAPI object at 0x7f59ac498470>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a74d1670>

    @pytest.fixture
    async def e2e_client(app, db_session: AsyncSession) -> AsyncClient:
        """
        Async HTTP client configured for E2E testing with real database.
        """
>       async with AsyncClient(
            app=app,
            base_url="http://testserver",
            timeout=30.0  # Longer timeout for E2E tests
        ) as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/e2e/conftest.py:17: TypeError
_ ERROR at setup of TestAuthE2E.test_registration_login_profile_complete_flow __

fixturedef = <FixtureDef argname='e2e_client' scope='function' baseid='tests/e2e'>
request = <SubRequest 'e2e_client' for <Coroutine test_registration_login_profile_complete_flow>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:272: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:268: in setup
    res = await gen_obj.__anext__()  # type: ignore[union-attr]
          ^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

app = <fastapi.applications.FastAPI object at 0x7f59a77fa480>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a70d5250>

    @pytest.fixture
    async def e2e_client(app, db_session: AsyncSession) -> AsyncClient:
        """
        Async HTTP client configured for E2E testing with real database.
        """
>       async with AsyncClient(
            app=app,
            base_url="http://testserver",
            timeout=30.0  # Longer timeout for E2E tests
        ) as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/e2e/conftest.py:17: TypeError
_______ ERROR at setup of TestAuthE2E.test_invalid_credentials_workflow ________

fixturedef = <FixtureDef argname='e2e_client' scope='function' baseid='tests/e2e'>
request = <SubRequest 'e2e_client' for <Coroutine test_invalid_credentials_workflow>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:272: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:268: in setup
    res = await gen_obj.__anext__()  # type: ignore[union-attr]
          ^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

app = <fastapi.applications.FastAPI object at 0x7f59a7070dd0>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a6d9ce60>

    @pytest.fixture
    async def e2e_client(app, db_session: AsyncSession) -> AsyncClient:
        """
        Async HTTP client configured for E2E testing with real database.
        """
>       async with AsyncClient(
            app=app,
            base_url="http://testserver",
            timeout=30.0  # Longer timeout for E2E tests
        ) as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/e2e/conftest.py:17: TypeError
____ ERROR at setup of TestChatE2E.test_complete_chat_conversation_workflow ____

fixturedef = <FixtureDef argname='e2e_client' scope='function' baseid='tests/e2e'>
request = <SubRequest 'e2e_client' for <Coroutine test_complete_chat_conversation_workflow>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:272: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:268: in setup
    res = await gen_obj.__anext__()  # type: ignore[union-attr]
          ^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

app = <fastapi.applications.FastAPI object at 0x7f59a77fb380>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a6a44da0>

    @pytest.fixture
    async def e2e_client(app, db_session: AsyncSession) -> AsyncClient:
        """
        Async HTTP client configured for E2E testing with real database.
        """
>       async with AsyncClient(
            app=app,
            base_url="http://testserver",
            timeout=30.0  # Longer timeout for E2E tests
        ) as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/e2e/conftest.py:17: TypeError
_____ ERROR at setup of TestChatE2E.test_chat_list_and_retrieval_workflow ______

fixturedef = <FixtureDef argname='e2e_client' scope='function' baseid='tests/e2e'>
request = <SubRequest 'e2e_client' for <Coroutine test_chat_list_and_retrieval_workflow>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:272: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:268: in setup
    res = await gen_obj.__anext__()  # type: ignore[union-attr]
          ^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

app = <fastapi.applications.FastAPI object at 0x7f59a6a44d70>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a68c0c50>

    @pytest.fixture
    async def e2e_client(app, db_session: AsyncSession) -> AsyncClient:
        """
        Async HTTP client configured for E2E testing with real database.
        """
>       async with AsyncClient(
            app=app,
            base_url="http://testserver",
            timeout=30.0  # Longer timeout for E2E tests
        ) as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/e2e/conftest.py:17: TypeError
______ ERROR at setup of TestChatE2E.test_chat_message_streaming_workflow ______

fixturedef = <FixtureDef argname='e2e_client' scope='function' baseid='tests/e2e'>
request = <SubRequest 'e2e_client' for <Coroutine test_chat_message_streaming_workflow>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:272: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:268: in setup
    res = await gen_obj.__anext__()  # type: ignore[union-attr]
          ^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

app = <fastapi.applications.FastAPI object at 0x7f59a6b4b4a0>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a66e8d70>

    @pytest.fixture
    async def e2e_client(app, db_session: AsyncSession) -> AsyncClient:
        """
        Async HTTP client configured for E2E testing with real database.
        """
>       async with AsyncClient(
            app=app,
            base_url="http://testserver",
            timeout=30.0  # Longer timeout for E2E tests
        ) as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/e2e/conftest.py:17: TypeError
__________ ERROR at setup of TestChatE2E.test_chat_deletion_workflow ___________

fixturedef = <FixtureDef argname='e2e_client' scope='function' baseid='tests/e2e'>
request = <SubRequest 'e2e_client' for <Coroutine test_chat_deletion_workflow>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:272: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:268: in setup
    res = await gen_obj.__anext__()  # type: ignore[union-attr]
          ^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

app = <fastapi.applications.FastAPI object at 0x7f59a66e8710>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a67a1730>

    @pytest.fixture
    async def e2e_client(app, db_session: AsyncSession) -> AsyncClient:
        """
        Async HTTP client configured for E2E testing with real database.
        """
>       async with AsyncClient(
            app=app,
            base_url="http://testserver",
            timeout=30.0  # Longer timeout for E2E tests
        ) as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/e2e/conftest.py:17: TypeError
_________ ERROR at setup of TestChatE2E.test_multi_user_chat_isolation _________

fixturedef = <FixtureDef argname='e2e_client' scope='function' baseid='tests/e2e'>
request = <SubRequest 'e2e_client' for <Coroutine test_multi_user_chat_isolation>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:272: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:268: in setup
    res = await gen_obj.__anext__()  # type: ignore[union-attr]
          ^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

app = <fastapi.applications.FastAPI object at 0x7f59a68e6b40>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a6accad0>

    @pytest.fixture
    async def e2e_client(app, db_session: AsyncSession) -> AsyncClient:
        """
        Async HTTP client configured for E2E testing with real database.
        """
>       async with AsyncClient(
            app=app,
            base_url="http://testserver",
            timeout=30.0  # Longer timeout for E2E tests
        ) as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/e2e/conftest.py:17: TypeError
__ ERROR at setup of TestDocumentsE2E.test_complete_document_upload_workflow ___

fixturedef = <FixtureDef argname='e2e_client' scope='function' baseid='tests/e2e'>
request = <SubRequest 'e2e_client' for <Coroutine test_complete_document_upload_workflow>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:272: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:268: in setup
    res = await gen_obj.__anext__()  # type: ignore[union-attr]
          ^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

app = <fastapi.applications.FastAPI object at 0x7f59a6acc0b0>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a6ee73b0>

    @pytest.fixture
    async def e2e_client(app, db_session: AsyncSession) -> AsyncClient:
        """
        Async HTTP client configured for E2E testing with real database.
        """
>       async with AsyncClient(
            app=app,
            base_url="http://testserver",
            timeout=30.0  # Longer timeout for E2E tests
        ) as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/e2e/conftest.py:17: TypeError
__ ERROR at setup of TestDocumentsE2E.test_document_list_and_search_workflow ___

fixturedef = <FixtureDef argname='e2e_client' scope='function' baseid='tests/e2e'>
request = <SubRequest 'e2e_client' for <Coroutine test_document_list_and_search_workflow>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:272: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:268: in setup
    res = await gen_obj.__anext__()  # type: ignore[union-attr]
          ^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

app = <fastapi.applications.FastAPI object at 0x7f59a6ee6b40>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a6f38260>

    @pytest.fixture
    async def e2e_client(app, db_session: AsyncSession) -> AsyncClient:
        """
        Async HTTP client configured for E2E testing with real database.
        """
>       async with AsyncClient(
            app=app,
            base_url="http://testserver",
            timeout=30.0  # Longer timeout for E2E tests
        ) as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/e2e/conftest.py:17: TypeError
_ ERROR at setup of TestDocumentsE2E.test_document_processing_status_workflow __

fixturedef = <FixtureDef argname='e2e_client' scope='function' baseid='tests/e2e'>
request = <SubRequest 'e2e_client' for <Coroutine test_document_processing_status_workflow>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:272: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:268: in setup
    res = await gen_obj.__anext__()  # type: ignore[union-attr]
          ^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

app = <fastapi.applications.FastAPI object at 0x7f59a6ffb4a0>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a75f7230>

    @pytest.fixture
    async def e2e_client(app, db_session: AsyncSession) -> AsyncClient:
        """
        Async HTTP client configured for E2E testing with real database.
        """
>       async with AsyncClient(
            app=app,
            base_url="http://testserver",
            timeout=30.0  # Longer timeout for E2E tests
        ) as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/e2e/conftest.py:17: TypeError
__ ERROR at setup of TestDocumentsE2E.test_document_chat_integration_workflow __

fixturedef = <FixtureDef argname='e2e_client' scope='function' baseid='tests/e2e'>
request = <SubRequest 'e2e_client' for <Coroutine test_document_chat_integration_workflow>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:272: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:268: in setup
    res = await gen_obj.__anext__()  # type: ignore[union-attr]
          ^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

app = <fastapi.applications.FastAPI object at 0x7f59a75f71d0>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a7778620>

    @pytest.fixture
    async def e2e_client(app, db_session: AsyncSession) -> AsyncClient:
        """
        Async HTTP client configured for E2E testing with real database.
        """
>       async with AsyncClient(
            app=app,
            base_url="http://testserver",
            timeout=30.0  # Longer timeout for E2E tests
        ) as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/e2e/conftest.py:17: TypeError
______ ERROR at setup of TestDocumentsE2E.test_document_deletion_workflow ______

fixturedef = <FixtureDef argname='e2e_client' scope='function' baseid='tests/e2e'>
request = <SubRequest 'e2e_client' for <Coroutine test_document_deletion_workflow>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:272: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:268: in setup
    res = await gen_obj.__anext__()  # type: ignore[union-attr]
          ^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

app = <fastapi.applications.FastAPI object at 0x7f59ac2734a0>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a72786e0>

    @pytest.fixture
    async def e2e_client(app, db_session: AsyncSession) -> AsyncClient:
        """
        Async HTTP client configured for E2E testing with real database.
        """
>       async with AsyncClient(
            app=app,
            base_url="http://testserver",
            timeout=30.0  # Longer timeout for E2E tests
        ) as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/e2e/conftest.py:17: TypeError
____ ERROR at setup of TestDocumentsE2E.test_large_document_upload_workflow ____

fixturedef = <FixtureDef argname='e2e_client' scope='function' baseid='tests/e2e'>
request = <SubRequest 'e2e_client' for <Coroutine test_large_document_upload_workflow>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:272: in _asyncgen_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:268: in setup
    res = await gen_obj.__anext__()  # type: ignore[union-attr]
          ^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

app = <fastapi.applications.FastAPI object at 0x7f59a72b9a30>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a72b9370>

    @pytest.fixture
    async def e2e_client(app, db_session: AsyncSession) -> AsyncClient:
        """
        Async HTTP client configured for E2E testing with real database.
        """
>       async with AsyncClient(
            app=app,
            base_url="http://testserver",
            timeout=30.0  # Longer timeout for E2E tests
        ) as client:
E       TypeError: AsyncClient.__init__() got an unexpected keyword argument 'app'

tests/e2e/conftest.py:17: TypeError
____ ERROR at setup of TestAgentsIntegration.test_agent_templates_workflow _____

fixturedef = <FixtureDef argname='auth_headers' scope='function' baseid='tests'>
request = <SubRequest 'auth_headers' for <Coroutine test_agent_templates_workflow>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:321: in _async_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:317: in setup
    res = await fixture_function(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <httpx.AsyncClient object at 0x7f599dc599d0>

    @pytest.fixture
    async def auth_headers(client) -> dict[str, str]:
        """
        Create authentication headers for testing protected endpoints.
    
        Args:
            client: The HTTP client for making requests
    
        Returns:
            Dictionary with Authorization header
        """
        import uuid
        import hashlib
        # Generate unique user data for each test to avoid conflicts
        # Create a hash-based suffix to avoid sequential patterns
        unique_base = str(uuid.uuid4())
        # Use first 8 chars of hash to avoid sequential patterns in UUIDs
        unique_id = hashlib.md5(unique_base.encode()).hexdigest()[:8]
        user_data = {
            "username": f"alice{unique_id}",
            "email": f"alice{unique_id}@example.com",
            "password": "SecureP@ssw0rd!",
            "full_name": f"Alice {unique_id}",
        }
    
        response = await client.post("/api/v1/auth/register", json=user_data)
>       assert response.status_code == 201
E       assert 400 == 201
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/conftest.py:344: AssertionError
------------------------------ Captured log setup ------------------------------
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:49:31.070016Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35maliced2f90129@exampl...[0m [36merror[0m=[35m400: Username format is invalid or contains prohibited patterns[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35maliced2f90129[0m
___ ERROR at setup of TestAnalyticsUnit.test_get_performance_metrics_success ___

fixturedef = <FixtureDef argname='auth_headers' scope='function' baseid='tests'>
request = <SubRequest 'auth_headers' for <Coroutine test_get_performance_metrics_success>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:321: in _async_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:317: in setup
    res = await fixture_function(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <httpx.AsyncClient object at 0x7f598b057ad0>

    @pytest.fixture
    async def auth_headers(client) -> dict[str, str]:
        """
        Create authentication headers for testing protected endpoints.
    
        Args:
            client: The HTTP client for making requests
    
        Returns:
            Dictionary with Authorization header
        """
        import uuid
        import hashlib
        # Generate unique user data for each test to avoid conflicts
        # Create a hash-based suffix to avoid sequential patterns
        unique_base = str(uuid.uuid4())
        # Use first 8 chars of hash to avoid sequential patterns in UUIDs
        unique_id = hashlib.md5(unique_base.encode()).hexdigest()[:8]
        user_data = {
            "username": f"alice{unique_id}",
            "email": f"alice{unique_id}@example.com",
            "password": "SecureP@ssw0rd!",
            "full_name": f"Alice {unique_id}",
        }
    
        response = await client.post("/api/v1/auth/register", json=user_data)
>       assert response.status_code == 201
E       assert 400 == 201
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/conftest.py:344: AssertionError
------------------------------ Captured log setup ------------------------------
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:16.366154Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malicee456b914@exampl...[0m [36merror[0m=[35m400: Username format is invalid or contains prohibited patterns[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malicee456b914[0m
_______ ERROR at setup of TestAnalyticsUnit.test_invalid_user_id_format ________

fixturedef = <FixtureDef argname='auth_headers' scope='function' baseid='tests'>
request = <SubRequest 'auth_headers' for <Coroutine test_invalid_user_id_format>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:321: in _async_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:317: in setup
    res = await fixture_function(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <httpx.AsyncClient object at 0x7f598b929ee0>

    @pytest.fixture
    async def auth_headers(client) -> dict[str, str]:
        """
        Create authentication headers for testing protected endpoints.
    
        Args:
            client: The HTTP client for making requests
    
        Returns:
            Dictionary with Authorization header
        """
        import uuid
        import hashlib
        # Generate unique user data for each test to avoid conflicts
        # Create a hash-based suffix to avoid sequential patterns
        unique_base = str(uuid.uuid4())
        # Use first 8 chars of hash to avoid sequential patterns in UUIDs
        unique_id = hashlib.md5(unique_base.encode()).hexdigest()[:8]
        user_data = {
            "username": f"alice{unique_id}",
            "email": f"alice{unique_id}@example.com",
            "password": "SecureP@ssw0rd!",
            "full_name": f"Alice {unique_id}",
        }
    
        response = await client.post("/api/v1/auth/register", json=user_data)
>       assert response.status_code == 201
E       assert 400 == 201
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/conftest.py:344: AssertionError
------------------------------ Captured log setup ------------------------------
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:22.850317Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malicef8908b49@exampl...[0m [36merror[0m=[35m400: Username format is invalid or contains prohibited patterns[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malicef8908b49[0m
____ ERROR at setup of TestContractTesting.test_error_response_consistency _____

fixturedef = <FixtureDef argname='auth_headers' scope='function' baseid='tests'>
request = <SubRequest 'auth_headers' for <Coroutine test_error_response_consistency>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:321: in _async_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:317: in setup
    res = await fixture_function(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <httpx.AsyncClient object at 0x7f597daa7c80>

    @pytest.fixture
    async def auth_headers(client) -> dict[str, str]:
        """
        Create authentication headers for testing protected endpoints.
    
        Args:
            client: The HTTP client for making requests
    
        Returns:
            Dictionary with Authorization header
        """
        import uuid
        import hashlib
        # Generate unique user data for each test to avoid conflicts
        # Create a hash-based suffix to avoid sequential patterns
        unique_base = str(uuid.uuid4())
        # Use first 8 chars of hash to avoid sequential patterns in UUIDs
        unique_id = hashlib.md5(unique_base.encode()).hexdigest()[:8]
        user_data = {
            "username": f"alice{unique_id}",
            "email": f"alice{unique_id}@example.com",
            "password": "SecureP@ssw0rd!",
            "full_name": f"Alice {unique_id}",
        }
    
        response = await client.post("/api/v1/auth/register", json=user_data)
>       assert response.status_code == 201
E       assert 400 == 201
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/conftest.py:344: AssertionError
------------------------------ Captured log setup ------------------------------
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:51:07.596423Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice492c4234@exampl...[0m [36merror[0m=[35m400: Username format is invalid or contains prohibited patterns[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice492c4234[0m
__ ERROR at teardown of TestDatabaseTesting.test_connection_pooling_behavior ___

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()  # type: ignore[union-attr]
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       runner.run(async_finalizer(), context=context)

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:289: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:281: in async_finalizer
    await gen_obj.__anext__()  # type: ignore[union-attr]
    ^^^^^^^^^^^^^^^^^^^^^^^^^
tests/conftest.py:292: in db_session
    await session.rollback()
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:1004: in rollback
    await greenlet_spawn(self.sync_session.rollback)
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:190: in greenlet_spawn
    result = context.switch(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1994: in rollback
    self._transaction.rollback(_to_root=True)
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:101: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f597aaeead0>
operation_name = 'rollback'
state = <SessionTransactionState.PROVISIONING_CONNECTION: 6>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
                raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
            else:
                raise sa_exc.InvalidRequestError(
                    "This session is in 'inactive' state, due to the "
                    "SQL transaction being rolled back; no further SQL "
                    "can be emitted within this transaction."
                )
        elif state is SessionTransactionState.CLOSED:
            raise sa_exc.ResourceClosedError("This transaction is closed")
        elif state is SessionTransactionState.PROVISIONING_CONNECTION:
>           raise sa_exc.InvalidRequestError(
                "This session is provisioning a new connection; concurrent "
                "operations are not permitted",
                code="isce",
            )
E           sqlalchemy.exc.InvalidRequestError: This session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)

../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:990: InvalidRequestError
_ ERROR at setup of TestIntegrationWorkflows.test_external_service_integration _

fixturedef = <FixtureDef argname='auth_headers' scope='function' baseid='tests'>
request = <SubRequest 'auth_headers' for <Coroutine test_external_service_integration>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:321: in _async_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:317: in setup
    res = await fixture_function(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <httpx.AsyncClient object at 0x7f595df6b5f0>

    @pytest.fixture
    async def auth_headers(client) -> dict[str, str]:
        """
        Create authentication headers for testing protected endpoints.
    
        Args:
            client: The HTTP client for making requests
    
        Returns:
            Dictionary with Authorization header
        """
        import uuid
        import hashlib
        # Generate unique user data for each test to avoid conflicts
        # Create a hash-based suffix to avoid sequential patterns
        unique_base = str(uuid.uuid4())
        # Use first 8 chars of hash to avoid sequential patterns in UUIDs
        unique_id = hashlib.md5(unique_base.encode()).hexdigest()[:8]
        user_data = {
            "username": f"alice{unique_id}",
            "email": f"alice{unique_id}@example.com",
            "password": "SecureP@ssw0rd!",
            "full_name": f"Alice {unique_id}",
        }
    
        response = await client.post("/api/v1/auth/register", json=user_data)
>       assert response.status_code == 201
E       assert 400 == 201
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/conftest.py:344: AssertionError
------------------------------ Captured log setup ------------------------------
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:52:04.173640Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35maliceca527897@exampl...[0m [36merror[0m=[35m400: Username format is invalid or contains prohibited patterns[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35maliceca527897[0m
_________ ERROR at setup of TestJobsUnit.test_job_queue_error_handling _________

fixturedef = <FixtureDef argname='auth_headers' scope='function' baseid='tests'>
request = <SubRequest 'auth_headers' for <Coroutine test_job_queue_error_handling>>

    @pytest.hookimpl(wrapper=True)
    def pytest_fixture_setup(fixturedef: FixtureDef, request) -> object | None:
        asyncio_mode = _get_asyncio_mode(request.config)
        if not _is_asyncio_fixture_function(fixturedef.func):
            if asyncio_mode == Mode.STRICT:
                # Ignore async fixtures without explicit asyncio mark in strict mode
                # This applies to pytest_trio fixtures, for example
                return (yield)
            if not _is_coroutine_or_asyncgen(fixturedef.func):
                return (yield)
        default_loop_scope = request.config.getini("asyncio_default_fixture_loop_scope")
        loop_scope = (
            getattr(fixturedef.func, "_loop_scope", None)
            or default_loop_scope
            or fixturedef.scope
        )
        runner_fixture_id = f"_{loop_scope}_scoped_runner"
        runner = request.getfixturevalue(runner_fixture_id)
        synchronizer = _fixture_synchronizer(fixturedef, runner, request)
        _make_asyncio_fixture_function(synchronizer, loop_scope)
        with MonkeyPatch.context() as c:
            c.setattr(fixturedef, "func", synchronizer)
>           hook_result = yield
                          ^^^^^

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:696: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:321: in _async_fixture_wrapper
    result = runner.run(setup(), context=context)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:317: in setup
    res = await fixture_function(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

client = <httpx.AsyncClient object at 0x7f595ec65850>

    @pytest.fixture
    async def auth_headers(client) -> dict[str, str]:
        """
        Create authentication headers for testing protected endpoints.
    
        Args:
            client: The HTTP client for making requests
    
        Returns:
            Dictionary with Authorization header
        """
        import uuid
        import hashlib
        # Generate unique user data for each test to avoid conflicts
        # Create a hash-based suffix to avoid sequential patterns
        unique_base = str(uuid.uuid4())
        # Use first 8 chars of hash to avoid sequential patterns in UUIDs
        unique_id = hashlib.md5(unique_base.encode()).hexdigest()[:8]
        user_data = {
            "username": f"alice{unique_id}",
            "email": f"alice{unique_id}@example.com",
            "password": "SecureP@ssw0rd!",
            "full_name": f"Alice {unique_id}",
        }
    
        response = await client.post("/api/v1/auth/register", json=user_data)
>       assert response.status_code == 201
E       assert 400 == 201
E        +  where 400 = <Response [400 Bad Request]>.status_code

tests/conftest.py:344: AssertionError
------------------------------ Captured log setup ------------------------------
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:52:30.921053Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35maliceeee35044@exampl...[0m [36merror[0m=[35m400: Username format is invalid or contains prohibited patterns[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35maliceeee35044[0m
=================================== FAILURES ===================================
___________ TestABTestingIntegration.test_ab_test_complete_lifecycle ___________

self = <tests.test_ab_testing_integration.TestABTestingIntegration object at 0x7f5b39a04230>
client = <httpx.AsyncClient object at 0x7f59a744df70>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lSVlRHRU5YTTJFQUFUMU01MDE0QiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM0OX0._xZlImK5R025jGt7dovmOeLBRolViCwH6MQQDDVAPiY'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a7727950>

    @pytest.mark.integration
    async def test_ab_test_complete_lifecycle(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complete AB test lifecycle from creation to completion."""
        # Create test
        test_data = {
            "name": "Integration Test AB Test",
            "description": "Complete lifecycle test",
            "test_type": "prompt",
            "allocation_strategy": "equal",
            "variants": [
                {
                    "name": "control",
                    "description": "Control variant",
                    "configuration": {"param_a": "value1"},
                    "weight": 1.0
                },
                {
                    "name": "variant_a",
                    "description": "Test variant A",
                    "configuration": {"param_a": "value2"},
                    "weight": 1.0
                }
            ],
            "metrics": ["response_time", "user_satisfaction"],
            "duration_days": 7,
            "min_sample_size": 100,
            "confidence_level": 0.95,
            "traffic_percentage": 100.0
        }
    
>       create_response = await client.post("/api/v1/ab-tests/", json=test_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_integration.py:42: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-200' coro=<TestABTestingIntegration.test_ab_test_complete_lifecycle() running at /home/yam/chatter/tests/test_ab_testing_integration.py:42> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestABTestingIntegration.test_ab_test_list_and_filter _____________

self = <tests.test_ab_testing_integration.TestABTestingIntegration object at 0x7f5b39beb5c0>
client = <httpx.AsyncClient object at 0x7f59a6cd9ee0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lSV1BLUjdUREIyQlpLNEZEVkcxWSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM1MH0.X5n3reePRjhgcDHduusoJ7Z6J8dB5g1rI2hCAoRaZYg'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a729e030>

    @pytest.mark.integration
    async def test_ab_test_list_and_filter(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test AB test listing and filtering functionality."""
        # Create multiple tests
        test_names = ["Test 1", "Test 2", "Test 3"]
        created_tests = []
    
        for name in test_names:
            test_data = {
                "name": name,
                "description": f"Description for {name}",
                "variants": [
                    {"name": "control", "allocation": 50},
                    {"name": "variant", "allocation": 50}
                ]
            }
    
>           response = await client.post("/api/v1/ab-tests/", json=test_data, headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_integration.py:95: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-214' coro=<TestABTestingIntegration.test_ab_test_list_and_filter() running at /home/yam/chatter/tests/test_ab_testing_integration.py:95> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestABTestingIntegration.test_ab_test_update_workflow _____________

self = <tests.test_ab_testing_integration.TestABTestingIntegration object at 0x7f5b39bea9c0>
client = <httpx.AsyncClient object at 0x7f59a6c9b440>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lSWFBUOU5SNFo2WlBUTkU4WlhWOSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM1MX0.Wef26CSObqLpLGO6boVcc-LDHWBJl_sK5Uk4hGoKk68'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a71004a0>

    @pytest.mark.integration
    async def test_ab_test_update_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test AB test update functionality."""
        # Create test
        original_data = {
            "name": "Original Test Name",
            "description": "Original description",
            "variants": [
                {"name": "control", "allocation": 50},
                {"name": "variant_a", "allocation": 50}
            ]
        }
    
>       create_response = await client.post("/api/v1/ab-tests/", json=original_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_integration.py:130: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-228' coro=<TestABTestingIntegration.test_ab_test_update_workflow() running at /home/yam/chatter/tests/test_ab_testing_integration.py:130> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
________ TestABTestingIntegration.test_ab_test_metrics_and_performance _________

self = <tests.test_ab_testing_integration.TestABTestingIntegration object at 0x7f5b39a04410>
client = <httpx.AsyncClient object at 0x7f59a66070e0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lSWUZDTTA3RzRQR0s2NFQ4U0tCWiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM1Mn0.qjcjyBWopxlx_gW-vxXwYRwmgPfNy_uNsGmamK7Sz0I'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a6d7c560>

    @pytest.mark.integration
    async def test_ab_test_metrics_and_performance(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test AB test metrics and performance tracking."""
        # Create and start test
        test_data = {
            "name": "Metrics Test",
            "description": "Test for metrics tracking",
            "variants": [
                {"name": "control", "allocation": 50},
                {"name": "variant_a", "allocation": 50}
            ],
            "target_metric": "click_through_rate"
        }
    
>       create_response = await client.post("/api/v1/ab-tests/", json=test_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_integration.py:174: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-242' coro=<TestABTestingIntegration.test_ab_test_metrics_and_performance() running at /home/yam/chatter/tests/test_ab_testing_integration.py:174> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestABTestingIntegration.test_ab_test_error_scenarios _____________

self = <tests.test_ab_testing_integration.TestABTestingIntegration object at 0x7f5b39a04500>
client = <httpx.AsyncClient object at 0x7f59a6a44ce0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lSWkVXTlFBMEMyUlJLNEhFNVlXNSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM1M30.yGPvCumeXq7zudE_9JKQ1VmIfK_csAUpsajnoPek_J0'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a70a4dd0>

    @pytest.mark.integration
    async def test_ab_test_error_scenarios(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test AB test error handling scenarios."""
        # Test non-existent test operations
        nonexistent_id = "nonexistent-test-id"
    
        operations = [
            ("GET", f"/api/v1/ab-tests/{nonexistent_id}"),
            ("PUT", f"/api/v1/ab-tests/{nonexistent_id}"),
            ("DELETE", f"/api/v1/ab-tests/{nonexistent_id}"),
            ("POST", f"/api/v1/ab-tests/{nonexistent_id}/start"),
            ("POST", f"/api/v1/ab-tests/{nonexistent_id}/pause"),
            ("POST", f"/api/v1/ab-tests/{nonexistent_id}/complete"),
            ("GET", f"/api/v1/ab-tests/{nonexistent_id}/results"),
            ("GET", f"/api/v1/ab-tests/{nonexistent_id}/metrics"),
        ]
    
        for method, url in operations:
            if method == "GET":
>               response = await client.get(url, headers=auth_headers)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_integration.py:226: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-256' coro=<TestABTestingIntegration.test_ab_test_error_scenarios() running at /home/yam/chatter/tests/test_ab_testing_integration.py:226> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestABTestingIntegration.test_ab_test_state_validation ____________

self = <tests.test_ab_testing_integration.TestABTestingIntegration object at 0x7f5b39a048c0>
client = <httpx.AsyncClient object at 0x7f59a4102fc0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTMDdUTlZSOU0xQlpTUkRSUTBBMyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM1M30.NqNgV2w96PZV2btZansZXbXm0pBrbw_PiZkNNZU4PCI'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a66eb260>

    @pytest.mark.integration
    async def test_ab_test_state_validation(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test AB test state transition validation."""
        # Create test
        test_data = {
            "name": "State Validation Test",
            "description": "Test state transitions",
            "variants": [
                {"name": "control", "allocation": 50},
                {"name": "variant_a", "allocation": 50}
            ]
        }
    
>       create_response = await client.post("/api/v1/ab-tests/", json=test_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_integration.py:249: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-270' coro=<TestABTestingIntegration.test_ab_test_state_validation() running at /home/yam/chatter/tests/test_ab_testing_integration.py:249> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_________ TestABTestingIntegration.test_ab_test_concurrent_operations __________

self = <tests.test_ab_testing_integration.TestABTestingIntegration object at 0x7f5b39a04c80>
client = <httpx.AsyncClient object at 0x7f599ff3a960>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTMTlNTllUVzQ4OVMwWUVZQkI5RyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM1NX0.mEvL0uWgvDOIq9NZxvttExl7wRszEqlZtp5lOHfq6L0'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a4150c80>

    @pytest.mark.integration
    async def test_ab_test_concurrent_operations(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test concurrent AB test operations."""
        # Create multiple tests concurrently
        test_data_list = [
            {
                "name": f"Concurrent Test {i}",
                "description": f"Concurrent test {i}",
                "variants": [
                    {"name": "control", "allocation": 50},
                    {"name": "variant", "allocation": 50}
                ]
            }
            for i in range(5)
        ]
    
        # Create tasks for concurrent test creation
        create_tasks = [
            asyncio.create_task(client.post("/api/v1/ab-tests/", json=test_data, headers=auth_headers))
            for test_data in test_data_list
        ]
    
        # Wait for all creations
>       create_responses = await asyncio.gather(*create_tasks)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_integration.py:301: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-285' coro=<AsyncClient.post() running at /home/yam/.local/lib/python3.12/site-packages/httpx/_client.py:1859> cb=[gather.<locals>._done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:767]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestABTestingIntegration.test_ab_test_data_persistence ____________

self = <tests.test_ab_testing_integration.TestABTestingIntegration object at 0x7f5b39a05040>
client = <httpx.AsyncClient object at 0x7f59a6323c20>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTMjMyWTcyUzgxMVE5RkFTQ0pBWSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM1NX0.TDpJHeZAXqbPRm8rFUrUFR9WpOEwIWJKly7UScQC__I'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a4d3dd90>

    @pytest.mark.integration
    async def test_ab_test_data_persistence(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test AB test data persistence across operations."""
        # Create test with specific data
        original_test_data = {
            "name": "Persistence Test",
            "description": "Testing data persistence",
            "variants": [
                {"name": "control", "allocation": 40},
                {"name": "variant_a", "allocation": 30},
                {"name": "variant_b", "allocation": 30}
            ],
            "target_metric": "conversion_rate",
            "success_criteria": {
                "min_improvement": 15.0,
                "confidence_level": 95.0
            },
            "metadata": {
                "experiment_type": "feature_flag",
                "team": "product",
                "priority": "high"
            }
        }
    
        # Create test
>       create_response = await client.post("/api/v1/ab-tests/", json=original_test_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_integration.py:359: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-303' coro=<TestABTestingIntegration.test_ab_test_data_persistence() running at /home/yam/chatter/tests/test_ab_testing_integration.py:359> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________ TestABTestingUnit.test_create_ab_test_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a4e60770>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a4e60770>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0410aa0>
client = <httpx.AsyncClient object at 0x7f59a4ea3aa0>

    @pytest.mark.unit
    async def test_create_ab_test_requires_auth(self, client: AsyncClient):
        """Test that creating AB test requires authentication."""
        test_data = {
            "name": "Test AB Test",
            "description": "Test description",
            "variants": [
                {"name": "control", "allocation": 50},
                {"name": "variant_a", "allocation": 50}
            ]
        }
    
>       response = await client.post("/api/v1/ab-tests/", json=test_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:25: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a4e60770>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:16.518957Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m47d905ce-891d-4a0f-a17a-80b4fbdd89fe[0m [36mstatus_code[0m=[35m401[0m
______________ TestABTestingUnit.test_list_ab_tests_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599eb9f560>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599eb9f560>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0410380>
client = <httpx.AsyncClient object at 0x7f599eb9e9f0>

    @pytest.mark.unit
    async def test_list_ab_tests_requires_auth(self, client: AsyncClient):
        """Test that listing AB tests requires authentication."""
>       response = await client.get("/api/v1/ab-tests/")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:31: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599eb9f560>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:17.183955Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m39aba257-dfde-46ff-b0b8-86618c9ce0c3[0m [36mstatus_code[0m=[35m401[0m
_______________ TestABTestingUnit.test_get_ab_test_requires_auth _______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a4bfa000>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a4bfa000>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0410710>
client = <httpx.AsyncClient object at 0x7f59a4bf93d0>

    @pytest.mark.unit
    async def test_get_ab_test_requires_auth(self, client: AsyncClient):
        """Test that getting specific AB test requires authentication."""
>       response = await client.get("/api/v1/ab-tests/test-id")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:37: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a4bfa000>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:17.564673Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m4df8a4dc-f2d1-496c-a95c-753b090f7070[0m [36mstatus_code[0m=[35m401[0m
_____________ TestABTestingUnit.test_update_ab_test_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a5400d40>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a5400d40>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0410b90>
client = <httpx.AsyncClient object at 0x7f59a5400050>

    @pytest.mark.unit
    async def test_update_ab_test_requires_auth(self, client: AsyncClient):
        """Test that updating AB test requires authentication."""
>       response = await client.put("/api/v1/ab-tests/test-id", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:43: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1896: in put
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a5400d40>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:17.931253Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m6b156be1-6d8f-4ce8-974f-7bd7c0e17dbf[0m [36mstatus_code[0m=[35m401[0m
_____________ TestABTestingUnit.test_delete_ab_test_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a5fcb9e0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a5fcb9e0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0410f80>
client = <httpx.AsyncClient object at 0x7f59a5fcad80>

    @pytest.mark.unit
    async def test_delete_ab_test_requires_auth(self, client: AsyncClient):
        """Test that deleting AB test requires authentication."""
>       response = await client.delete("/api/v1/ab-tests/test-id")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:49: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1966: in delete
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a5fcb9e0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:18.311151Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m2c69311b-8373-4f4d-9e91-0308e7921889[0m [36mstatus_code[0m=[35m401[0m
______________ TestABTestingUnit.test_start_ab_test_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a506e510>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a506e510>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0411370>
client = <httpx.AsyncClient object at 0x7f59a506d820>

    @pytest.mark.unit
    async def test_start_ab_test_requires_auth(self, client: AsyncClient):
        """Test that starting AB test requires authentication."""
>       response = await client.post("/api/v1/ab-tests/test-id/start")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:55: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a506e510>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:18.740992Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m6c1196eb-32df-454f-b331-9c174036826c[0m [36mstatus_code[0m=[35m401[0m
______________ TestABTestingUnit.test_pause_ab_test_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a56505c0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a56505c0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0411730>
client = <httpx.AsyncClient object at 0x7f59a4bdfef0>

    @pytest.mark.unit
    async def test_pause_ab_test_requires_auth(self, client: AsyncClient):
        """Test that pausing AB test requires authentication."""
>       response = await client.post("/api/v1/ab-tests/test-id/pause")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:61: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a56505c0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:19.459562Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m76fe7139-6b68-4475-9ed1-2d47b221c6cf[0m [36mstatus_code[0m=[35m401[0m
____________ TestABTestingUnit.test_complete_ab_test_requires_auth _____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a61acb90>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a61acb90>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0411af0>
client = <httpx.AsyncClient object at 0x7f59a61adb50>

    @pytest.mark.unit
    async def test_complete_ab_test_requires_auth(self, client: AsyncClient):
        """Test that completing AB test requires authentication."""
>       response = await client.post("/api/v1/ab-tests/test-id/complete")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:67: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a61acb90>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:19.864289Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mac99abc4-4954-4fc3-b23b-62dfca2936fc[0m [36mstatus_code[0m=[35m401[0m
_______________ TestABTestingUnit.test_get_results_requires_auth _______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a4498dd0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a4498dd0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0411eb0>
client = <httpx.AsyncClient object at 0x7f59a4498710>

    @pytest.mark.unit
    async def test_get_results_requires_auth(self, client: AsyncClient):
        """Test that getting results requires authentication."""
>       response = await client.get("/api/v1/ab-tests/test-id/results")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:73: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a4498dd0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:20.237287Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m58b58c85-0368-466f-a8df-c12980b8970e[0m [36mstatus_code[0m=[35m401[0m
_______________ TestABTestingUnit.test_get_metrics_requires_auth _______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599fcd0e60>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599fcd0e60>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0412270>
client = <httpx.AsyncClient object at 0x7f599fcd0290>

    @pytest.mark.unit
    async def test_get_metrics_requires_auth(self, client: AsyncClient):
        """Test that getting metrics requires authentication."""
>       response = await client.get("/api/v1/ab-tests/test-id/metrics")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:79: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599fcd0e60>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:20.619094Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mcba7a615-603e-473d-bab9-3439ac18970b[0m [36mstatus_code[0m=[35m401[0m
________________ TestABTestingUnit.test_create_ab_test_success _________________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0412630>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='140022995453520'>
client = <httpx.AsyncClient object at 0x7f599e9eac90>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTNzhIQllFODI3UUE0OVZWODExSiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM2MX0.NKlT2Uhhv2IHXSJ3KQQOvmWpHAPuiLYN9DCozmaRvwk'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_create_ab_test_success(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test successful AB test creation."""
        # Mock the manager
        mock_manager = AsyncMock()
    
        from chatter.schemas.ab_testing import TestVariant
        from chatter.services.ab_testing import TestType, VariantAllocation, MetricType
        from datetime import datetime, UTC
    
        # Create proper test variants
        test_variants = [
            TestVariant(
                name="control",
                description="Control variant",
                configuration={},
                weight=1.0
            ),
            TestVariant(
                name="variant_a",
                description="Variant A",
                configuration={},
                weight=1.0
            )
        ]
    
        mock_manager.create_test.return_value = ABTestResponse(
            id="test-123",
            name="Test AB Test",
            description="Test description",
            test_type=TestType.PROMPT,
            status=TestStatus.DRAFT,
            allocation_strategy=VariantAllocation.EQUAL,
            variants=test_variants,
            metrics=[MetricType.CUSTOM],
            duration_days=30,
            min_sample_size=100,
            confidence_level=0.95,
            traffic_percentage=100.0,
            tags=[],
            metadata={},
            created_by="testuser",
            created_at=datetime.now(UTC),
            updated_at=datetime.now(UTC)
        )
        mock_get_manager.return_value = mock_manager
    
        test_data = {
            "name": "Test AB Test",
            "description": "Test description",
            "variants": [
                {"name": "control", "allocation": 50},
                {"name": "variant_a", "allocation": 50}
            ]
        }
    
>       response = await client.post("/api/v1/ab-tests/", json=test_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:139: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-447' coro=<TestABTestingUnit.test_create_ab_test_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______________ TestABTestingUnit.test_create_ab_test_invalid_data ______________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0412a20>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='140023015309088'>
client = <httpx.AsyncClient object at 0x7f59a61667e0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTOERRRE1KRkhYNENBSEdUUzNFSiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM2Mn0.7DxLkjuxy2vAO5wyrZzepD3XNDQr9Ad4KR6oMg-2Rc0'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_create_ab_test_invalid_data(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test AB test creation with invalid data."""
        # Missing required fields
        test_data = {
            "name": "Test AB Test"
            # Missing description and variants
        }
    
>       response = await client.post("/api/v1/ab-tests/", json=test_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-461' coro=<TestABTestingUnit.test_create_ab_test_invalid_data() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
___________ TestABTestingUnit.test_create_ab_test_invalid_allocation ___________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0412de0>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='140023003776448'>
client = <httpx.AsyncClient object at 0x7f59a5668560>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTOTg5VDY3RlEwMlM3NzAyR1BZOCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM2M30.Qcq3S2Vdgo0L-gDOa_rJyw1Iyo595QaQHfGSLouSuv8'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_create_ab_test_invalid_allocation(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test AB test creation with invalid allocation percentages."""
        test_data = {
            "name": "Test AB Test",
            "description": "Test description",
            "variants": [
                {"name": "control", "allocation": 60},
                {"name": "variant_a", "allocation": 50}  # Total = 110%
            ]
        }
    
        # Mock manager to raise validation error
        mock_manager = AsyncMock()
        mock_manager.create_test.side_effect = ValueError("Invalid allocation percentages")
        mock_get_manager.return_value = mock_manager
    
>       response = await client.post("/api/v1/ab-tests/", json=test_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:178: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-475' coro=<TestABTestingUnit.test_create_ab_test_invalid_allocation() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_________________ TestABTestingUnit.test_list_ab_tests_success _________________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af04131a0>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='140022904372400'>
client = <httpx.AsyncClient object at 0x7f599f79a3f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTQUNKMlRNQkswWjBBMTAzNERITiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM2NH0.AH-u8I68BhDFIBDd2v23vyhjfr-VgjM_IFrSosLy5B0'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_list_ab_tests_success(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test successful AB test listing."""
        mock_manager = AsyncMock()
        mock_manager.list_tests.return_value = {
            "tests": [
                {
                    "id": "test-1",
                    "name": "Test 1",
                    "status": "running",
                    "created_at": "2024-01-01T12:00:00Z"
                },
                {
                    "id": "test-2",
                    "name": "Test 2",
                    "status": "draft",
                    "created_at": "2024-01-01T13:00:00Z"
                }
            ],
            "total": 2,
            "page": 1,
            "per_page": 10
        }
        mock_get_manager.return_value = mock_manager
    
>       response = await client.get("/api/v1/ab-tests/", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:207: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-489' coro=<TestABTestingUnit.test_list_ab_tests_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
__________________ TestABTestingUnit.test_get_ab_test_success __________________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0412990>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='140022984478736'>
client = <httpx.AsyncClient object at 0x7f59a44016d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTQjkzVEhTQ0FYSFZWQVoySk1CUyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM2NX0.U_lfc6V5QLflAk4XhNuqfYlgakI1bggIa4E3L6hsf1I'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_get_ab_test_success(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test successful AB test retrieval."""
        mock_manager = AsyncMock()
>       mock_test = ABTestResponse(
            id="test-123",
            name="Test AB Test",
            description="Test description",
            status=TestStatus.RUNNING,
            created_by="testuser",
            variants=[{"name": "control", "allocation": 50}],
            created_at="2024-01-01T12:00:00Z",
            updated_at="2024-01-01T12:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 11 validation errors for ABTestResponse
E       test_type
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       allocation_strategy
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.description
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.configuration
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metrics
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       duration_days
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       min_sample_size
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       confidence_level
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       traffic_percentage
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       tags
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metadata
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_ab_testing_unit.py:219: ValidationError
_________________ TestABTestingUnit.test_get_ab_test_not_found _________________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0411c70>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='140022997858736'>
client = <httpx.AsyncClient object at 0x7f59a50c26f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTQlBNVkhOQ0RaTlhaNlpKUUZQVyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM2NX0.4VVmlS1QGrnRPp5_ronEEB5mOZfBmvNWtdPibIeCk1k'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_get_ab_test_not_found(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test AB test retrieval for non-existent test."""
        mock_manager = AsyncMock()
        mock_manager.get_test.return_value = None
        mock_get_manager.return_value = mock_manager
    
>       response = await client.get("/api/v1/ab-tests/nonexistent", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_ab_testing_unit.py:248: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-517' coro=<TestABTestingUnit.test_get_ab_test_not_found() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_________________ TestABTestingUnit.test_start_ab_test_success _________________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0410ec0>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='140023001936864'>
client = <httpx.AsyncClient object at 0x7f59a56b5f70>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTQ1Y4M0NZNkgyTVhUREcxTjVERSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM2Nn0.333ea0YWjuzsN-WZ6W9xRkpuvKwdNKXXBW3YqFjrD44'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_start_ab_test_success(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test successful AB test start."""
        mock_manager = AsyncMock()
>       mock_test = ABTestResponse(
            id="test-123",
            name="Test AB Test",
            description="Test description",
            status=TestStatus.DRAFT,
            created_by="testuser",
            variants=[{"name": "control", "allocation": 50}],
            created_at="2024-01-01T12:00:00Z",
            updated_at="2024-01-01T12:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 11 validation errors for ABTestResponse
E       test_type
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       allocation_strategy
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.description
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.configuration
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metrics
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       duration_days
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       min_sample_size
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       confidence_level
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       traffic_percentage
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       tags
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metadata
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_ab_testing_unit.py:256: ValidationError
_____________ TestABTestingUnit.test_start_ab_test_invalid_status ______________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af04102f0>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='140022998574400'>
client = <httpx.AsyncClient object at 0x7f59a5171220>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTRDhCU0hQVlkxNDBNTVlBNFpNSyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM2N30.43RdcB4XCIlZtzznsFhYZ7qu7q9_Kr7s-UFG3WYgkjA'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_start_ab_test_invalid_status(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test starting AB test with invalid status."""
        mock_manager = AsyncMock()
>       mock_test = ABTestResponse(
            id="test-123",
            name="Test AB Test",
            description="Test description",
            status=TestStatus.RUNNING,  # Already running
            created_by="testuser",
            variants=[{"name": "control", "allocation": 50}],
            created_at="2024-01-01T12:00:00Z",
            updated_at="2024-01-01T12:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 11 validation errors for ABTestResponse
E       test_type
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       allocation_strategy
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.description
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.configuration
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metrics
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       duration_days
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       min_sample_size
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       confidence_level
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       traffic_percentage
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       tags
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metadata
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_ab_testing_unit.py:282: ValidationError
_____________ TestABTestingUnit.test_delete_running_test_forbidden _____________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af04135c0>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='140022877873808'>
client = <httpx.AsyncClient object at 0x7f599de553a0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTRE05U1g3VFpYV0JEOTI4UlcyViIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM2N30.sKFe71JjPfKJpo5fC_1kZ7F-r0bN5OCOr9oX9gf4XFU'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_delete_running_test_forbidden(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test that deleting running test is forbidden."""
        mock_manager = AsyncMock()
>       mock_test = ABTestResponse(
            id="test-123",
            name="Test AB Test",
            description="Test description",
            status=TestStatus.RUNNING,  # Running test
            created_by="testuser",
            variants=[{"name": "control", "allocation": 50}],
            created_at="2024-01-01T12:00:00Z",
            updated_at="2024-01-01T12:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 11 validation errors for ABTestResponse
E       test_type
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       allocation_strategy
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.description
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.configuration
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metrics
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       duration_days
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       min_sample_size
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       confidence_level
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       traffic_percentage
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       tags
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metadata
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_ab_testing_unit.py:303: ValidationError
___________ TestABTestingUnit.test_access_other_user_test_forbidden ____________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0413980>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='140022876105200'>
client = <httpx.AsyncClient object at 0x7f599dca56a0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTRTBEUUNKRFhYUFpDUDBIN0M0NCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM2OH0.MCdVjV7rVhTA89boMRGyQY9SatUshA9G2F33M0XDlYU'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_access_other_user_test_forbidden(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test that accessing other user's test is forbidden."""
        mock_manager = AsyncMock()
>       mock_test = ABTestResponse(
            id="test-123",
            name="Test AB Test",
            description="Test description",
            status=TestStatus.DRAFT,
            created_by="otheruser",  # Different user
            variants=[{"name": "control", "allocation": 50}],
            created_at="2024-01-01T12:00:00Z",
            updated_at="2024-01-01T12:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 11 validation errors for ABTestResponse
E       test_type
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       allocation_strategy
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.description
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.configuration
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metrics
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       duration_days
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       min_sample_size
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       confidence_level
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       traffic_percentage
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       tags
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metadata
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_ab_testing_unit.py:324: ValidationError
__________________ TestABTestingUnit.test_get_results_success __________________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0468080>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='140022876761184'>
client = <httpx.AsyncClient object at 0x7f599dd457f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTRUJZTjQ2VDk2SkE2UVJCNE5IMyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM2OH0.H031MIW8ZAFZSp-ZHwmgcYezXMbFnvdx3vyIZsPM_WY'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_get_results_success(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test successful results retrieval."""
        mock_manager = AsyncMock()
>       mock_test = ABTestResponse(
            id="test-123",
            name="Test AB Test",
            description="Test description",
            status=TestStatus.COMPLETED,
            created_by="testuser",
            variants=[{"name": "control", "allocation": 50}],
            created_at="2024-01-01T12:00:00Z",
            updated_at="2024-01-01T12:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 11 validation errors for ABTestResponse
E       test_type
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       allocation_strategy
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.description
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.configuration
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metrics
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       duration_days
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       min_sample_size
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       confidence_level
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       traffic_percentage
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       tags
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metadata
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_ab_testing_unit.py:345: ValidationError
__________________ TestABTestingUnit.test_get_metrics_success __________________

self = <tests.test_ab_testing_unit.TestABTestingUnit object at 0x7f5af0468140>
mock_get_manager = <AsyncMock name='get_ab_test_manager' id='140022867947600'>
client = <httpx.AsyncClient object at 0x7f599d4ddc70>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTRVIxOEZDTlYxV0JKNFdUOFk0NyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM2OH0.ExN30V3ClNFiH0fjlBxkBC_qKJHOO4OLvna7ysWLFIY'}

    @pytest.mark.unit
    @patch('chatter.api.ab_testing.get_ab_test_manager')
    async def test_get_metrics_success(self, mock_get_manager, client: AsyncClient, auth_headers: dict):
        """Test successful metrics retrieval."""
        mock_manager = AsyncMock()
>       mock_test = ABTestResponse(
            id="test-123",
            name="Test AB Test",
            description="Test description",
            status=TestStatus.RUNNING,
            created_by="testuser",
            variants=[{"name": "control", "allocation": 50}],
            created_at="2024-01-01T12:00:00Z",
            updated_at="2024-01-01T12:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 11 validation errors for ABTestResponse
E       test_type
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       allocation_strategy
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.description
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       variants.0.configuration
E         Field required [type=missing, input_value={'name': 'control', 'allocation': 50}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metrics
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       duration_days
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       min_sample_size
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       confidence_level
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       traffic_percentage
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       tags
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       metadata
E         Field required [type=missing, input_value={'id': 'test-123', 'name'... '2024-01-01T12:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_ab_testing_unit.py:382: ValidationError
_____________ TestAgentsIntegration.test_agent_complete_lifecycle ______________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x7f5af04691f0>
client = <httpx.AsyncClient object at 0x7f59a524dbe0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTRjNGQTYwMzdaM005MjQzNVE4RiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM2OX0.CJ_-5qvm7eQ09zfQ3e1_Q5kKacX62046szeP3u0Q1RE'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f599d42c980>

    @pytest.mark.integration
    async def test_agent_complete_lifecycle(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complete agent lifecycle from creation to deletion."""
        # Create agent
        agent_data = {
            "name": "Integration Test Agent",
            "description": "Agent for integration testing",
            "agent_type": "chat",
            "configuration": {
                "model": "gpt-3.5-turbo",
                "temperature": 0.7,
                "max_tokens": 1000,
                "system_prompt": "You are a helpful assistant for testing."
            },
            "capabilities": ["text_generation", "conversation"],
            "metadata": {
                "test_mode": True,
                "environment": "integration"
            }
        }
    
>       create_response = await client.post("/api/v1/agents/", json=agent_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:33: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-615' coro=<TestAgentsIntegration.test_agent_complete_lifecycle() running at /home/yam/chatter/tests/test_agents_integration.py:33> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______________ TestAgentsIntegration.test_agents_list_and_filter _______________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x7f5af0469520>
client = <httpx.AsyncClient object at 0x7f599e0996d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTRlhSQVIxWkpHTlMwRDFDQzREWSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM3MH0.-IQpjWg8eb5Vs17GKJ6Bg7QK8Q4EXX2gTUakh0l3QR8'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a5247860>

    @pytest.mark.integration
    async def test_agents_list_and_filter(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test agent listing and filtering functionality."""
        # Create agents with different types
        agents_to_create = [
            {
                "name": "Chat Agent",
                "description": "Agent for chat interactions",
                "agent_type": "chat",
                "configuration": {"model": "gpt-3.5-turbo"}
            },
            {
                "name": "Assistant Agent",
                "description": "General assistant agent",
                "agent_type": "assistant",
                "configuration": {"model": "gpt-4"}
            },
            {
                "name": "Code Agent",
                "description": "Agent for code assistance",
                "agent_type": "coding",
                "configuration": {"model": "gpt-4", "temperature": 0.2}
            }
        ]
    
        created_agent_ids = []
    
        for agent_data in agents_to_create:
>           response = await client.post("/api/v1/agents/", json=agent_data, headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:123: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-629' coro=<TestAgentsIntegration.test_agents_list_and_filter() running at /home/yam/chatter/tests/test_agents_integration.py:123> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_______________ TestAgentsIntegration.test_bulk_agent_operations _______________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x7f5af0413680>
client = <httpx.AsyncClient object at 0x7f599fb2e150>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTSEE5TllDWjY0UVlERTlSMVE5SCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM3MX0.d968S3i9sJcYQMaaVVucA7E3_QgnQ55Y9iqhTqnK9zQ'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f599dcc9190>

    @pytest.mark.integration
    async def test_bulk_agent_operations(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test bulk agent operations."""
        # Bulk create agents
        bulk_create_data = {
            "agents": [
                {
                    "name": "Bulk Agent 1",
                    "description": "First bulk created agent",
                    "agent_type": "chat",
                    "configuration": {"model": "gpt-3.5-turbo"}
                },
                {
                    "name": "Bulk Agent 2",
                    "description": "Second bulk created agent",
                    "agent_type": "assistant",
                    "configuration": {"model": "gpt-4"}
                },
                {
                    "name": "Bulk Agent 3",
                    "description": "Third bulk created agent",
                    "agent_type": "coding",
                    "configuration": {"model": "gpt-4", "temperature": 0.1}
                }
            ]
        }
    
>       bulk_create_response = await client.post("/api/v1/agents/bulk", json=bulk_create_data, headers=auth_headers)
                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:217: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-656' coro=<TestAgentsIntegration.test_bulk_agent_operations() running at /home/yam/chatter/tests/test_agents_integration.py:217> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestAgentsIntegration.test_agent_testing_functionality ____________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x7f5af0469160>
client = <httpx.AsyncClient object at 0x7f599de1a930>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTSjRYTjRSVldYU0dZRzhCTkE4SiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM3Mn0.SMz8cyGsFv-vgPqxsoCaE0EFait9d1GyB5JDeZjbUgw'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f599dfe18e0>

    @pytest.mark.integration
    async def test_agent_testing_functionality(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test agent testing functionality end-to-end."""
        # Create a test agent
        agent_data = {
            "name": "Testing Agent",
            "description": "Agent for testing functionality",
            "agent_type": "chat",
            "configuration": {
                "model": "gpt-3.5-turbo",
                "temperature": 0.7,
                "system_prompt": "You are a test assistant. Always respond helpfully."
            }
        }
    
>       create_response = await client.post("/api/v1/agents/", json=agent_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:256: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-670' coro=<TestAgentsIntegration.test_agent_testing_functionality() running at /home/yam/chatter/tests/test_agents_integration.py:256> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______________ TestAgentsIntegration.test_agent_health_monitoring ______________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x7f5af0469850>
client = <httpx.AsyncClient object at 0x7f599e891e80>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTS0ZFV1hCOTlOOFY4UkZYQUU0SiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM3M30.FLTAPcEf3nxW5JtJN8m1DjZI1VsJgvDEhREBk0RvqVM'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f599e253320>

    @pytest.mark.integration
    async def test_agent_health_monitoring(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test agent health monitoring functionality."""
        # Create agent for health testing
        agent_data = {
            "name": "Health Monitor Agent",
            "description": "Agent for health monitoring tests",
            "agent_type": "chat",
            "configuration": {"model": "gpt-3.5-turbo"}
        }
    
>       create_response = await client.post("/api/v1/agents/", json=agent_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:304: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-684' coro=<TestAgentsIntegration.test_agent_health_monitoring() running at /home/yam/chatter/tests/test_agents_integration.py:304> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_______________ TestAgentsIntegration.test_agent_error_scenarios _______________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x7f5af04680b0>
client = <httpx.AsyncClient object at 0x7f599fd8efc0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTTUNDNDBNQkVGUjZWRUpCWldDSyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM3NH0.EEeomx5fZ2Q1LB1gjMui7vVZAHqdPycRbJGyzS0G79A'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a545fbc0>

    @pytest.mark.integration
    async def test_agent_error_scenarios(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test agent error handling scenarios."""
        # Test non-existent agent operations
        nonexistent_id = "nonexistent-agent-id"
    
        operations = [
            ("GET", f"/api/v1/agents/{nonexistent_id}"),
            ("PUT", f"/api/v1/agents/{nonexistent_id}"),
            ("DELETE", f"/api/v1/agents/{nonexistent_id}"),
            ("POST", f"/api/v1/agents/{nonexistent_id}/test"),
            ("GET", f"/api/v1/agents/{nonexistent_id}/health"),
        ]
    
        for method, url in operations:
            if method == "GET":
>               response = await client.get(url, headers=auth_headers)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:347: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-698' coro=<TestAgentsIntegration.test_agent_error_scenarios() running at /home/yam/chatter/tests/test_agents_integration.py:347> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_______________ TestAgentsIntegration.test_agent_data_validation _______________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x7f5af046a000>
client = <httpx.AsyncClient object at 0x7f599f83ecc0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTTjcwRlQyRFJXM0VSVzFHN0M3MCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM3NX0.h1qr_GDkVlPQJsKmSldIQxowbYRUKdaJHAlkzozzP20'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f599d9bc4a0>

    @pytest.mark.integration
    async def test_agent_data_validation(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test agent data validation in integration environment."""
        # Test invalid agent type
        invalid_type_data = {
            "name": "Invalid Type Agent",
            "description": "Agent with invalid type",
            "agent_type": "invalid_type_xyz",
            "configuration": {"model": "gpt-3.5-turbo"}
        }
    
>       response = await client.post("/api/v1/agents/", json=invalid_type_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:369: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-712' coro=<TestAgentsIntegration.test_agent_data_validation() running at /home/yam/chatter/tests/test_agents_integration.py:369> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestAgentsIntegration.test_concurrent_agent_operations ____________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x7f5af046a3c0>
client = <httpx.AsyncClient object at 0x7f599e612840>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTUEQySjE1Tk1YQ0pEUkM1NjhZWSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM3Nn0.ansvgKk1QIpP5o9vc3OcuvlnwFWCVdQUIdHvpEeNSAU'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f599ed18560>

    @pytest.mark.integration
    async def test_concurrent_agent_operations(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test concurrent agent operations."""
        # Create multiple agents concurrently
        agent_data_list = [
            {
                "name": f"Concurrent Agent {i}",
                "description": f"Agent created concurrently {i}",
                "agent_type": "chat",
                "configuration": {
                    "model": "gpt-3.5-turbo",
                    "temperature": 0.5 + (i * 0.1)
                }
            }
            for i in range(5)
        ]
    
        # Create tasks for concurrent agent creation
        create_tasks = [
            asyncio.create_task(client.post("/api/v1/agents/", json=agent_data, headers=auth_headers))
            for agent_data in agent_data_list
        ]
    
        # Wait for all creations
>       create_responses = await asyncio.gather(*create_tasks)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:417: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-727' coro=<AsyncClient.post() running at /home/yam/.local/lib/python3.12/site-packages/httpx/_client.py:1859> cb=[gather.<locals>._done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:767]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestAgentsIntegration.test_agent_complex_configuration ____________

self = <tests.test_agents_integration.TestAgentsIntegration object at 0x7f5af046a780>
client = <httpx.AsyncClient object at 0x7f599ce9bda0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTUUFONUE2TlZEMU5WRThaUzZEWiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM3N30.kSE2DgaiSA87Dszre583pd_lfTL0gAHcyXLtyqnZaNE'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f599cc15eb0>

    @pytest.mark.integration
    async def test_agent_complex_configuration(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test agents with complex configurations."""
        # Create agent with complex configuration
        complex_agent_data = {
            "name": "Complex Configuration Agent",
            "description": "Agent with advanced configuration options",
            "agent_type": "assistant",
            "configuration": {
                "model": "gpt-4",
                "temperature": 0.8,
                "max_tokens": 2048,
                "top_p": 0.9,
                "frequency_penalty": 0.1,
                "presence_penalty": 0.2,
                "system_prompt": "You are an expert AI assistant with advanced capabilities. Provide detailed and accurate responses.",
                "custom_parameters": {
                    "response_format": "detailed",
                    "context_window": 4096,
                    "safety_level": "moderate"
                }
            },
            "capabilities": [
                "text_generation",
                "conversation",
                "analysis",
                "summarization"
            ],
            "metadata": {
                "version": "1.0",
                "created_for": "integration_testing",
                "features": {
                    "streaming": True,
                    "function_calling": False,
                    "multi_turn": True
                }
            }
        }
    
        # Create agent
>       create_response = await client.post("/api/v1/agents/", json=complex_agent_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_integration.py:497: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-745' coro=<TestAgentsIntegration.test_agent_complex_configuration() running at /home/yam/chatter/tests/test_agents_integration.py:497> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
________________ TestAgentsUnit.test_create_agent_requires_auth ________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599d068980>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599d068980>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_agents_unit.TestAgentsUnit object at 0x7f5af046a330>
client = <httpx.AsyncClient object at 0x7f599d047b90>

    @pytest.mark.unit
    async def test_create_agent_requires_auth(self, client: AsyncClient):
        """Test that creating agent requires authentication."""
        agent_data = {
            "name": "Test Agent",
            "description": "Test agent description",
            "agent_type": "chat"
        }
    
>       response = await client.post("/api/v1/agents/", json=agent_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:20: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599d068980>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:38.720341Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m36e47cca-e7b7-41b0-ae2f-5a23ff757a02[0m [36mstatus_code[0m=[35m401[0m
________________ TestAgentsUnit.test_list_agents_requires_auth _________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599c433470>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599c433470>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_agents_unit.TestAgentsUnit object at 0x7f5af044c410>
client = <httpx.AsyncClient object at 0x7f599c432930>

    @pytest.mark.unit
    async def test_list_agents_requires_auth(self, client: AsyncClient):
        """Test that listing agents requires authentication."""
>       response = await client.get("/api/v1/agents/")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:26: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599c433470>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:39.102501Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mb9357158-fc6c-488d-afb9-f801af142efa[0m [36mstatus_code[0m=[35m401[0m
____________ TestAgentsUnit.test_get_agent_templates_requires_auth _____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599ca9e150>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599ca9e150>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_agents_unit.TestAgentsUnit object at 0x7f5af044c470>
client = <httpx.AsyncClient object at 0x7f599ca9d520>

    @pytest.mark.unit
    async def test_get_agent_templates_requires_auth(self, client: AsyncClient):
        """Test that getting agent templates requires authentication."""
>       response = await client.get("/api/v1/agents/templates")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:32: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599ca9e150>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:39.518480Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35ma3d5b782-3f2e-425a-b151-5ea7769afacc[0m [36mstatus_code[0m=[35m401[0m
_________________ TestAgentsUnit.test_get_agent_requires_auth __________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599c930f80>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599c930f80>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_agents_unit.TestAgentsUnit object at 0x7f5af044c830>
client = <httpx.AsyncClient object at 0x7f599c930320>

    @pytest.mark.unit
    async def test_get_agent_requires_auth(self, client: AsyncClient):
        """Test that getting specific agent requires authentication."""
>       response = await client.get("/api/v1/agents/agent-id")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:38: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599c930f80>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:39.965549Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m7fb99b2e-13a2-49f9-b181-f6b76e23e09a[0m [36mstatus_code[0m=[35m401[0m
________________ TestAgentsUnit.test_update_agent_requires_auth ________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599e59fa40>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599e59fa40>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_agents_unit.TestAgentsUnit object at 0x7f5af044cbf0>
client = <httpx.AsyncClient object at 0x7f599e59ed20>

    @pytest.mark.unit
    async def test_update_agent_requires_auth(self, client: AsyncClient):
        """Test that updating agent requires authentication."""
>       response = await client.put("/api/v1/agents/agent-id", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:44: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1896: in put
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599e59fa40>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:40.427692Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mc6654c10-7dd6-4a08-b102-d8c56ce30c9d[0m [36mstatus_code[0m=[35m401[0m
________________ TestAgentsUnit.test_delete_agent_requires_auth ________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599d212570>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599d212570>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_agents_unit.TestAgentsUnit object at 0x7f5af044cfb0>
client = <httpx.AsyncClient object at 0x7f599d211a30>

    @pytest.mark.unit
    async def test_delete_agent_requires_auth(self, client: AsyncClient):
        """Test that deleting agent requires authentication."""
>       response = await client.delete("/api/v1/agents/agent-id")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:50: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1966: in delete
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599d212570>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:40.913553Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m30ac8563-b0db-49f4-bee6-8a6ceeba0ef8[0m [36mstatus_code[0m=[35m401[0m
_________________ TestAgentsUnit.test_test_agent_requires_auth _________________

self = <tests.test_agents_unit.TestAgentsUnit object at 0x7f5af044d370>
client = <httpx.AsyncClient object at 0x7f599c684380>

    @pytest.mark.unit
    async def test_test_agent_requires_auth(self, client: AsyncClient):
        """Test that testing agent requires authentication."""
        response = await client.post("/api/v1/agents/agent-id/test", json={})
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_agents_unit.py:57: AssertionError
______________ TestAgentsUnit.test_get_agent_health_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599d2e88c0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599d2e88c0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_agents_unit.TestAgentsUnit object at 0x7f5af044d730>
client = <httpx.AsyncClient object at 0x7f599da16f60>

    @pytest.mark.unit
    async def test_get_agent_health_requires_auth(self, client: AsyncClient):
        """Test that getting agent health requires authentication."""
>       response = await client.get("/api/v1/agents/agent-id/health")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:62: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599d2e88c0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:42.046818Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mf5441887-e31c-4a4f-813a-ef9c53360e98[0m [36mstatus_code[0m=[35m401[0m
_____________ TestAgentsUnit.test_bulk_create_agents_requires_auth _____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599e5b1640>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599e5b1640>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_agents_unit.TestAgentsUnit object at 0x7f5af044daf0>
client = <httpx.AsyncClient object at 0x7f599e5b03e0>

    @pytest.mark.unit
    async def test_bulk_create_agents_requires_auth(self, client: AsyncClient):
        """Test that bulk creating agents requires authentication."""
>       response = await client.post("/api/v1/agents/bulk", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:68: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599e5b1640>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:49:42.485262Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mc48863b9-8814-46ea-ae0f-974c4a9d2407[0m [36mstatus_code[0m=[35m401[0m
_____________ TestAgentsUnit.test_bulk_delete_agents_requires_auth _____________

self = <tests.test_agents_unit.TestAgentsUnit object at 0x7f5af044deb0>
client = <httpx.AsyncClient object at 0x7f599d869370>

    @pytest.mark.unit
    async def test_bulk_delete_agents_requires_auth(self, client: AsyncClient):
        """Test that bulk deleting agents requires authentication."""
        import json
>       response = await client.delete(
            "/api/v1/agents/bulk",
            content=json.dumps({"agent_ids": ["test-id"]}),
            headers={"Content-Type": "application/json"}
        )
E       TypeError: AsyncClient.delete() got an unexpected keyword argument 'content'

tests/test_agents_unit.py:75: TypeError
___________________ TestAgentsUnit.test_create_agent_success ___________________

self = <Coroutine test_create_agent_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7f5af046b410>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
________________ TestAgentsUnit.test_create_agent_invalid_data _________________

self = <tests.test_agents_unit.TestAgentsUnit object at 0x7f5af044e660>
client = <httpx.AsyncClient object at 0x7f599c2b1670>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lTWEYxNEs2WlNSUzhOUE0yRTVYWSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM4M30.y8tZ8TXlcbgaa6JHqL2L1ogb4y3UGGD2XBt2XGtXPVQ'}

    @pytest.mark.unit
    async def test_create_agent_invalid_data(self, client: AsyncClient, auth_headers: dict):
        """Test agent creation with invalid data."""
        # Missing required fields
        agent_data = {
            "description": "Test agent description"
            # Missing name and agent_type
        }
    
>       response = await client.post("/api/v1/agents/", json=agent_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_agents_unit.py:129: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-903' coro=<TestAgentsUnit.test_create_agent_invalid_data() running at /home/yam/chatter/tests/test_agents_unit.py:129> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
___________________ TestAgentsUnit.test_list_agents_success ____________________

self = <Coroutine test_list_agents_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7f5af046b560>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
_______________ TestAgentsUnit.test_get_agent_templates_success ________________

self = <Coroutine test_get_agent_templates_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7f5af046b650>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
____________________ TestAgentsUnit.test_get_agent_success _____________________

self = <Coroutine test_get_agent_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7f5af046b770>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
___________________ TestAgentsUnit.test_get_agent_not_found ____________________

self = <Coroutine test_get_agent_not_found>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7f5af046b890>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
___________________ TestAgentsUnit.test_update_agent_success ___________________

self = <Coroutine test_update_agent_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7f5af046b9b0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
___________________ TestAgentsUnit.test_delete_agent_success ___________________

self = <Coroutine test_delete_agent_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7f5af046bad0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
____________________ TestAgentsUnit.test_test_agent_success ____________________

self = <Coroutine test_test_agent_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7f5af046bbf0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
_________________ TestAgentsUnit.test_get_agent_health_success _________________

self = <Coroutine test_get_agent_health_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7f5af046bd10>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
________________ TestAgentsUnit.test_bulk_create_agents_success ________________

self = <Coroutine test_bulk_create_agents_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7f5af046be30>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
________________ TestAgentsUnit.test_bulk_delete_agents_success ________________

self = <Coroutine test_bulk_delete_agents_success>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7f5af046bf50>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
_______________ TestAgentsUnit.test_agent_service_error_handling _______________

self = <Coroutine test_agent_service_error_handling>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7f5af044c0b0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
_________________ TestAgentsUnit.test_list_agents_with_filters _________________

self = <Coroutine test_list_agents_with_filters>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7f5af044c1d0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
______________ TestAgentsUnit.test_agent_test_with_invalid_input _______________

self = <Coroutine test_agent_test_with_invalid_input>

    def runtest(self) -> None:
        synchronized_obj = wrap_in_sync(self.obj)
        with MonkeyPatch.context() as c:
            c.setattr(self, "obj", synchronized_obj)
>           super().runtest()

../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:426: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/pytest_asyncio/plugin.py:642: in inner
    _loop.run_until_complete(task)
/usr/lib64/python3.12/asyncio/base_events.py:691: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1410: in patched
    with self.decoration_helper(patched,
/usr/lib64/python3.12/contextlib.py:137: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1375: in decoration_helper
    arg = exit_stack.enter_context(patching)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:526: in enter_context
    result = _enter(cm)
             ^^^^^^^^^^
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7f5af044c2f0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.api.agents' from '/home/yam/chatter/chatter/api/agents.py'> does not have the attribute 'AgentService'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
__________ TestAnalyticsIntegration.test_analytics_dashboard_workflow __________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x7f5af044f380>
client = <httpx.AsyncClient object at 0x7f59a5721100>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUNVZLWUNIQzFHRTE0SzVDRDcxVyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM5Mn0.fSfU9rRPzpVMC61B9YrUXw9OvgT6EFkbfxuBR59HiSo'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f598a8777a0>

    @pytest.mark.integration
    async def test_analytics_dashboard_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complete analytics dashboard workflow."""
        # Get dashboard data
>       dashboard_response = await client.get("/api/v1/analytics/dashboard", headers=auth_headers)
                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:16: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1099' coro=<TestAnalyticsIntegration.test_analytics_dashboard_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:16> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
________ TestAnalyticsIntegration.test_conversation_analytics_workflow _________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x7f5af0469f40>
client = <httpx.AsyncClient object at 0x7f5989c10bc0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUNlI1S0pKWDRHSE1NMTk0VkU5TiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM5M30.mqylmO3BFirl8DQ3cqC2LJPVsxjuHtCEE1qeuGuYnIY'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a5786e40>

    @pytest.mark.integration
    async def test_conversation_analytics_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test conversation analytics workflow."""
        # Get conversation stats
>       stats_response = await client.get("/api/v1/analytics/conversations", headers=auth_headers)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:31: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1113' coro=<TestAnalyticsIntegration.test_conversation_analytics_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:31> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________ TestAnalyticsIntegration.test_usage_metrics_workflow _____________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x7f5af042ccb0>
client = <httpx.AsyncClient object at 0x7f599d7c6030>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUODVCMkZFM1g3VzkxMDVWNkI1VCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM5NH0.rPGPHhRJzO9B6QmJ6Ppr0RNlBQYWRkabfxg-FdpluX0'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a5c9ede0>

    @pytest.mark.integration
    async def test_usage_metrics_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test usage metrics workflow."""
        # Get usage metrics
>       usage_response = await client.get("/api/v1/analytics/usage", headers=auth_headers)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:54: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1127' coro=<TestAnalyticsIntegration.test_usage_metrics_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:54> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
__________ TestAnalyticsIntegration.test_performance_metrics_workflow __________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x7f5af042d5e0>
client = <httpx.AsyncClient object at 0x7f599d2e8f50>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUOTFYNUJNRTE2NEs0VFE3NVZFOSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM5NX0.OZ1ZmDwGV3QWxUTdZ7VTJ5ad9F-zIQflsfO1J2mkj-M'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f599d2c6cf0>

    @pytest.mark.integration
    async def test_performance_metrics_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test performance metrics workflow."""
        # Get performance metrics
>       perf_response = await client.get("/api/v1/analytics/performance", headers=auth_headers)
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:77: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1141' coro=<TestAnalyticsIntegration.test_performance_metrics_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:77> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
__________ TestAnalyticsIntegration.test_document_analytics_workflow ___________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x7f5af042d9a0>
client = <httpx.AsyncClient object at 0x7f599ce8c140>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUOVg4VEJZNkNNNU1XTlg0VzdLUSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM5Nn0.ofVWl8op2xWPD_yAMXAItIINPTMcXmr8u6NkL1IDzNI'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f599e525d60>

    @pytest.mark.integration
    async def test_document_analytics_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test document analytics workflow."""
        # Get document analytics
>       doc_response = await client.get("/api/v1/analytics/documents", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:100: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1155' coro=<TestAnalyticsIntegration.test_document_analytics_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:100> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
___________ TestAnalyticsIntegration.test_system_analytics_workflow ____________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x7f5af042dd60>
client = <httpx.AsyncClient object at 0x7f5989da9c10>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUQjZYQlZTQlNLM0ZIODJEWUoxNiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM5N30.PkZ5XA4177nMVwQC3b-Hc9qdUjNJb9XLfsDEC8jVgwc'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f599c91ae70>

    @pytest.mark.integration
    async def test_system_analytics_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test system analytics workflow."""
        # Get system analytics
>       system_response = await client.get("/api/v1/analytics/system", headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:122: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1169' coro=<TestAnalyticsIntegration.test_system_analytics_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:122> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestAnalyticsIntegration.test_user_analytics_workflow _____________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x7f5af042e120>
client = <httpx.AsyncClient object at 0x7f598bdf50d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUQzIzU1BGUkNORkVKSzNFOTNNRiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM5OH0.ZM7-4qqc2pbxP_Zipzx6RHH9WDXKk-nU203UvtElfPA'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a5c34f50>

    @pytest.mark.integration
    async def test_user_analytics_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test user analytics workflow."""
        # Test with a sample user ID
        user_id = "test-user-123"
    
        # Get user analytics
>       user_response = await client.get(f"/api/v1/analytics/users/{user_id}", headers=auth_headers)
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:147: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1183' coro=<TestAnalyticsIntegration.test_user_analytics_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:147> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
___________ TestAnalyticsIntegration.test_analytics_export_workflow ____________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x7f5af042e4e0>
client = <httpx.AsyncClient object at 0x7f599e3bc1a0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUQ1hEUVpaUFpCRFRBWlo2NkRQUyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODM5OX0.cYYWFKCmfOs8LxBYnJu3xmgvsjlUF--WZtTRhCFR81w'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a5d0c410>

    @pytest.mark.integration
    async def test_analytics_export_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test analytics export workflow."""
        # Request analytics export
        export_data = {
            "date_range": {
                "start": "2024-01-01",
                "end": "2024-01-31"
            },
            "format": "json",
            "include_types": ["conversations", "usage"]
        }
    
>       export_response = await client.post("/api/v1/analytics/export", json=export_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:179: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1197' coro=<TestAnalyticsIntegration.test_analytics_export_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:179> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________ TestAnalyticsIntegration.test_analytics_health_check _____________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x7f5af042e8a0>
client = <httpx.AsyncClient object at 0x7f598a0972f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lURFJaUlQ2TVlSWlNYQlZaUEU5RSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQwMH0.4lI1K22cpMAucoV731Xm_5cS4s30cTBTHXZMBUQ7ppk'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59a5846810>

    @pytest.mark.integration
    async def test_analytics_health_check(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test analytics health check."""
        # Get analytics health
>       health_response = await client.get("/api/v1/analytics/health", headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:197: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1211' coro=<TestAnalyticsIntegration.test_analytics_health_check() running at /home/yam/chatter/tests/test_analytics_integration.py:197> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestAnalyticsIntegration.test_metrics_summary_workflow ____________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x7f5af042ec60>
client = <httpx.AsyncClient object at 0x7f599d74ce30>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lURjRIVFNTNzlQSlA1QVJDS0Q2TSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQwMn0.XllMDb6ObcXnJmNPW5gUS0SF035rksLNHUzgSvIovYk'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f599f187ad0>

    @pytest.mark.integration
    async def test_metrics_summary_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test metrics summary workflow."""
        # Get metrics summary
>       summary_response = await client.get("/api/v1/analytics/metrics/summary", headers=auth_headers)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:211: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1225' coro=<TestAnalyticsIntegration.test_metrics_summary_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:211> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_________ TestAnalyticsIntegration.test_toolserver_analytics_workflow __________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x7f5af042f020>
client = <httpx.AsyncClient object at 0x7f59a5e8c710>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lURzEyQTBIR05OSDBFREg4V0FFUiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQwMn0.jApYJ8FT-0L8oETn8SCHRKnLQ4Doc2seMqjvQdiHZIw'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f599ce69280>

    @pytest.mark.integration
    async def test_toolserver_analytics_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test toolserver analytics workflow."""
        # Get toolserver analytics
>       toolserver_response = await client.get("/api/v1/analytics/toolservers", headers=auth_headers)
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:231: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1239' coro=<TestAnalyticsIntegration.test_toolserver_analytics_workflow() running at /home/yam/chatter/tests/test_analytics_integration.py:231> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_________ TestAnalyticsIntegration.test_concurrent_analytics_requests __________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x7f5af042f3e0>
client = <httpx.AsyncClient object at 0x7f5989e8c0b0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUSDA5MUpTREcyTkpUWDBEWE5BNyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQwM30.UwpexE4QaFpHsU8o5zc6LooBTIb9MxuVLvik1u52ZxA'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f599f276540>

    @pytest.mark.integration
    async def test_concurrent_analytics_requests(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test concurrent analytics requests."""
        # Create concurrent requests to different analytics endpoints
        endpoints = [
            "/api/v1/analytics/conversations",
            "/api/v1/analytics/usage",
            "/api/v1/analytics/performance",
            "/api/v1/analytics/system",
            "/api/v1/analytics/health"
        ]
    
        # Create tasks for concurrent requests
        tasks = [
            asyncio.create_task(client.get(endpoint, headers=auth_headers))
            for endpoint in endpoints
        ]
    
        # Wait for all requests
>       responses = await asyncio.gather(*tasks)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:261: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1254' coro=<AsyncClient.get() running at /home/yam/.local/lib/python3.12/site-packages/httpx/_client.py:1768> cb=[gather.<locals>._done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:767]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
___________ TestAnalyticsIntegration.test_analytics_data_consistency ___________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x7f5af044d670>
client = <httpx.AsyncClient object at 0x7f5988e34950>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUSFdQSjBKUjJGRkEwWURBSjUwNiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQwNH0.UbgcELAqfZfd8JcjdEHuregjHiy0uR-QJ-CveMYuPBM'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f598a2f2840>

    @pytest.mark.integration
    async def test_analytics_data_consistency(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test analytics data consistency across endpoints."""
        # Get data from multiple endpoints
>       dashboard_response = await client.get("/api/v1/analytics/dashboard", headers=auth_headers)
                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:271: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1272' coro=<TestAnalyticsIntegration.test_analytics_data_consistency() running at /home/yam/chatter/tests/test_analytics_integration.py:271> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestAnalyticsIntegration.test_analytics_error_handling ____________

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x7f5af042f860>
client = <httpx.AsyncClient object at 0x7f598927c7a0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUSzdTSkcxWTJDQzZYTTNFTkQzMiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQwNn0.sNUhdNzZdGQ7wR_Nvz3wg-IvxvB6zBEFpfrBgyMaY7U'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f5989596d50>

    @pytest.mark.integration
    async def test_analytics_error_handling(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test analytics error handling scenarios."""
        # Test with invalid parameters where applicable
    
        # Invalid user ID format
>       invalid_user_response = await client.get("/api/v1/analytics/users/invalid-user-format", headers=auth_headers)
                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:300: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1286' coro=<TestAnalyticsIntegration.test_analytics_error_handling() running at /home/yam/chatter/tests/test_analytics_integration.py:300> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_______ TestAnalyticsIntegration.test_analytics_pagination_and_filtering _______

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x7f5af042eba0>
client = <httpx.AsyncClient object at 0x7f598a1244d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUTTlKN1cxTVhBQlFDUUQ5TURDOCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQwN30.HAYF00ZiP4GQtMqvZMGJLfQ3EB-8woBA1aEY0pNEAK8'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f5989216630>

    @pytest.mark.integration
    async def test_analytics_pagination_and_filtering(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test analytics endpoints that support pagination and filtering."""
        # Test with query parameters where supported
    
        # Test date range filtering on usage metrics
>       usage_with_params = await client.get(
            "/api/v1/analytics/usage?start_date=2024-01-01&end_date=2024-01-31",
            headers=auth_headers
        )

tests/test_analytics_integration.py:321: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1300' coro=<TestAnalyticsIntegration.test_analytics_pagination_and_filtering() running at /home/yam/chatter/tests/test_analytics_integration.py:321> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______ TestAnalyticsIntegration.test_analytics_response_format_validation ______

self = <tests.test_analytics_integration.TestAnalyticsIntegration object at 0x7f5af042e090>
client = <httpx.AsyncClient object at 0x7f599f4dffe0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUTkJBTkY4NTJBU043V0NINTI3RCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQwOH0.m1ePr-lHeBBQZ2yKObpbj2kMvp8C1YlN1xvq8RBWUZQ'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f598a159910>

    @pytest.mark.integration
    async def test_analytics_response_format_validation(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test that analytics responses follow expected format."""
        endpoints_to_test = [
            "/api/v1/analytics/conversations",
            "/api/v1/analytics/usage",
            "/api/v1/analytics/dashboard"
        ]
    
        for endpoint in endpoints_to_test:
>           response = await client.get(endpoint, headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_integration.py:347: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1314' coro=<TestAnalyticsIntegration.test_analytics_response_format_validation() running at /home/yam/chatter/tests/test_analytics_integration.py:347> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_________ TestAnalyticsUnit.test_get_conversation_stats_requires_auth __________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599ef4c920>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599ef4c920>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af0198e60>
client = <httpx.AsyncClient object at 0x7f599ef43ce0>

    @pytest.mark.unit
    async def test_get_conversation_stats_requires_auth(self, client: AsyncClient):
        """Test that getting conversation stats requires authentication."""
>       response = await client.get("/api/v1/analytics/conversations")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:14: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f599ef4c920>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:50:09.137717Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mc129d199-b180-4525-8460-0ceca2ec5908[0m [36mstatus_code[0m=[35m401[0m
____________ TestAnalyticsUnit.test_get_usage_metrics_requires_auth ____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598b1033b0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598b1033b0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af0199160>
client = <httpx.AsyncClient object at 0x7f598b1027e0>

    @pytest.mark.unit
    async def test_get_usage_metrics_requires_auth(self, client: AsyncClient):
        """Test that getting usage metrics requires authentication."""
>       response = await client.get("/api/v1/analytics/usage")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:20: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598b1033b0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:50:09.577315Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35me4f1b27f-276a-43fe-93ba-cf7af3177b93[0m [36mstatus_code[0m=[35m401[0m
_________ TestAnalyticsUnit.test_get_performance_metrics_requires_auth _________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5988bf21b0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5988bf21b0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af0199580>
client = <httpx.AsyncClient object at 0x7f5988bf1640>

    @pytest.mark.unit
    async def test_get_performance_metrics_requires_auth(self, client: AsyncClient):
        """Test that getting performance metrics requires authentication."""
>       response = await client.get("/api/v1/analytics/performance")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:26: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5988bf21b0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:50:10.530332Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m3d856c83-b10b-4d10-aafc-d81c29570c05[0m [36mstatus_code[0m=[35m401[0m
_________ TestAnalyticsUnit.test_get_document_analytics_requires_auth __________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598912cbf0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598912cbf0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af042e7e0>
client = <httpx.AsyncClient object at 0x7f598912c080>

    @pytest.mark.unit
    async def test_get_document_analytics_requires_auth(self, client: AsyncClient):
        """Test that getting document analytics requires authentication."""
>       response = await client.get("/api/v1/analytics/documents")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:32: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598912cbf0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:50:10.974006Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mae5c757f-36f9-4878-9bfd-6f37a423ec72[0m [36mstatus_code[0m=[35m401[0m
__________ TestAnalyticsUnit.test_get_system_analytics_requires_auth ___________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598a7bb7d0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598a7bb7d0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af0198e30>
client = <httpx.AsyncClient object at 0x7f598a7bac30>

    @pytest.mark.unit
    async def test_get_system_analytics_requires_auth(self, client: AsyncClient):
        """Test that getting system analytics requires authentication."""
>       response = await client.get("/api/v1/analytics/system")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:38: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598a7bb7d0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:50:11.360944Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35ma1549d71-6ef3-4d46-8da2-fb95291f188a[0m [36mstatus_code[0m=[35m401[0m
______________ TestAnalyticsUnit.test_get_dashboard_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598ac02150>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598ac02150>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af01992e0>
client = <httpx.AsyncClient object at 0x7f598ac015e0>

    @pytest.mark.unit
    async def test_get_dashboard_requires_auth(self, client: AsyncClient):
        """Test that getting dashboard requires authentication."""
>       response = await client.get("/api/v1/analytics/dashboard")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:44: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598ac02150>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:50:11.775345Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m4d7dac9f-e7ca-4ad6-b541-ca7e60d395fb[0m [36mstatus_code[0m=[35m401[0m
________ TestAnalyticsUnit.test_get_toolserver_analytics_requires_auth _________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598b574cb0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598b574cb0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af0199d30>
client = <httpx.AsyncClient object at 0x7f598b5740e0>

    @pytest.mark.unit
    async def test_get_toolserver_analytics_requires_auth(self, client: AsyncClient):
        """Test that getting toolserver analytics requires authentication."""
>       response = await client.get("/api/v1/analytics/toolservers")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:50: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598b574cb0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:50:12.164214Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35ma50825cf-e6ee-42d8-a581-0627cdb76d68[0m [36mstatus_code[0m=[35m401[0m
___________ TestAnalyticsUnit.test_get_user_analytics_requires_auth ____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598af2f680>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598af2f680>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af019a0f0>
client = <httpx.AsyncClient object at 0x7f598af2eb40>

    @pytest.mark.unit
    async def test_get_user_analytics_requires_auth(self, client: AsyncClient):
        """Test that getting user analytics requires authentication."""
>       response = await client.get("/api/v1/analytics/users/user-123")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:56: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598af2f680>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:50:12.557379Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m218cc921-b551-4dc1-97aa-126bf26ce4ad[0m [36mstatus_code[0m=[35m401[0m
____________ TestAnalyticsUnit.test_export_analytics_requires_auth _____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598b2e6240>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598b2e6240>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af019a4b0>
client = <httpx.AsyncClient object at 0x7f598b2e55b0>

    @pytest.mark.unit
    async def test_export_analytics_requires_auth(self, client: AsyncClient):
        """Test that exporting analytics requires authentication."""
>       response = await client.post("/api/v1/analytics/export", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:62: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598b2e6240>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:50:12.949427Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m16a996fd-98aa-40d9-a5a9-bd35c1d7e035[0m [36mstatus_code[0m=[35m401[0m
_______________ TestAnalyticsUnit.test_get_health_requires_auth ________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598b344f20>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598b344f20>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af019a870>
client = <httpx.AsyncClient object at 0x7f598b344380>

    @pytest.mark.unit
    async def test_get_health_requires_auth(self, client: AsyncClient):
        """Test that getting analytics health requires authentication."""
>       response = await client.get("/api/v1/analytics/health")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:68: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598b344f20>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:50:13.330208Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m6f9fad8f-f4cb-494b-a692-fa4109dbffd0[0m [36mstatus_code[0m=[35m401[0m
___________ TestAnalyticsUnit.test_get_metrics_summary_requires_auth ___________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598aeaba10>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598aeaba10>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af019ac30>
client = <httpx.AsyncClient object at 0x7f598aeaae40>

    @pytest.mark.unit
    async def test_get_metrics_summary_requires_auth(self, client: AsyncClient):
        """Test that getting metrics summary requires authentication."""
>       response = await client.get("/api/v1/analytics/metrics/summary")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f598aeaba10>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:50:13.721470Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m6125ff24-d24e-428f-a873-848b22f07e7e[0m [36mstatus_code[0m=[35m401[0m
____________ TestAnalyticsUnit.test_get_conversation_stats_success _____________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af019aff0>
mock_analytics_service = <MagicMock name='AnalyticsService' id='140022565251904'>
client = <httpx.AsyncClient object at 0x7f598af46cf0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUVk5DTTQ4QThOSDc1UkFNWFBSUiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQxNH0.JpFIkLaGDLDUZTIXqsvrHHqG4N2TaKrtGkZ3We8f7Oo'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_get_conversation_stats_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful conversation stats retrieval."""
        # Mock analytics service
        mock_service = AsyncMock()
        mock_stats = {
            "total_conversations": 150,
            "active_conversations": 12,
            "conversations_today": 8,
            "average_messages_per_conversation": 4.5,
            "conversations_by_hour": [1, 2, 0, 3, 5, 2, 4, 1, 0, 2, 3, 6],
            "top_conversation_topics": [
                {"topic": "technical_support", "count": 45},
                {"topic": "general_inquiry", "count": 38}
            ]
        }
        mock_service.get_conversation_stats.return_value = mock_stats
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/conversations", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:97: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1471' coro=<TestAnalyticsUnit.test_get_conversation_stats_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_______________ TestAnalyticsUnit.test_get_usage_metrics_success _______________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af019b3e0>
mock_analytics_service = <MagicMock name='AnalyticsService' id='140022568490848'>
client = <httpx.AsyncClient object at 0x7f598b7482f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUV0c3MVM2VEZFOEZURldYV0NYQyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQxNX0.6V2cOxtAgio08sdqwDxlkV5x-99n2wex8UoEojFJAy4'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_get_usage_metrics_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful usage metrics retrieval."""
        mock_service = AsyncMock()
        mock_metrics = {
            "api_calls_today": 1250,
            "api_calls_this_week": 8500,
            "api_calls_this_month": 35000,
            "tokens_used_today": 125000,
            "tokens_used_this_week": 850000,
            "tokens_used_this_month": 3500000,
            "top_endpoints": [
                {"endpoint": "/chat/completions", "calls": 500},
                {"endpoint": "/documents/process", "calls": 300}
            ],
            "usage_by_hour": [10, 15, 8, 25, 35, 42, 38, 28, 20, 18, 25, 30]
        }
        mock_service.get_usage_metrics.return_value = mock_metrics
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/usage", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:127: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1485' coro=<TestAnalyticsUnit.test_get_usage_metrics_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestAnalyticsUnit.test_get_document_analytics_success _____________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af019bb60>
mock_analytics_service = <MagicMock name='AnalyticsService' id='140022561581888'>
client = <httpx.AsyncClient object at 0x7f59898b46e0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUWEpCWjZIUUUzN0VSUTYzTjBQWiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQxNn0.Uqa-ZK5GhYEdVkx0jxt_Y9Or_fYBHdo1XTrtjwRmjok'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_get_document_analytics_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful document analytics retrieval."""
        mock_service = AsyncMock()
        mock_analytics = {
            "total_documents": 450,
            "documents_processed_today": 25,
            "processing_success_rate": 0.95,
            "average_processing_time": 2.4,
            "documents_by_type": {
                "pdf": 200,
                "docx": 150,
                "txt": 100
            },
            "processing_status_breakdown": {
                "completed": 425,
                "processing": 15,
                "failed": 10
            }
        }
        mock_service.get_document_analytics.return_value = mock_analytics
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/documents", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:189: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1512' coro=<TestAnalyticsUnit.test_get_document_analytics_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________ TestAnalyticsUnit.test_get_system_analytics_success ______________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af01a4230>
mock_analytics_service = <MagicMock name='AnalyticsService' id='140022895687200'>
client = <httpx.AsyncClient object at 0x7f599ef51190>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUWUNXWFZETTJLTjNUQVM0MEU1MSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQxN30.LrGHIChdXVdNGO63GizWHB2h91FnZQFlqJj71fAvU3M'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_get_system_analytics_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful system analytics retrieval."""
        mock_service = AsyncMock()
        mock_analytics = {
            "uptime_seconds": 3600000,
            "memory_usage_mb": 1024,
            "cpu_usage_percent": 25.5,
            "disk_usage_percent": 45.2,
            "active_connections": 150,
            "database_connections": 25,
            "cache_hit_rate": 0.85,
            "system_health": "healthy"
        }
        mock_service.get_system_analytics.return_value = mock_analytics
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/system", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:215: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1526' coro=<TestAnalyticsUnit.test_get_system_analytics_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_________________ TestAnalyticsUnit.test_get_dashboard_success _________________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af01a4320>
mock_analytics_service = <MagicMock name='AnalyticsService' id='140022560110976'>
client = <httpx.AsyncClient object at 0x7f598af4a540>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lUWjdWMjFaVjlKWUhSSkdWRUJENCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQxOH0.a7cshx52UdbEbjCLXANrvfN-fANL_pUNtd9ClFv42zk'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_get_dashboard_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful dashboard data retrieval."""
        mock_service = AsyncMock()
        mock_dashboard = {
            "summary": {
                "total_users": 125,
                "active_users": 45,
                "total_conversations": 350,
                "api_calls_today": 1250
            },
            "recent_activity": [
                {"timestamp": "2024-01-01T12:00:00Z", "event": "User login", "user": "user1"},
                {"timestamp": "2024-01-01T11:55:00Z", "event": "Document processed", "user": "user2"}
            ],
            "alerts": [
                {"level": "warning", "message": "High API usage detected", "timestamp": "2024-01-01T12:05:00Z"}
            ]
        }
        mock_service.get_dashboard_data.return_value = mock_dashboard
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/dashboard", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:246: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1540' coro=<TestAnalyticsUnit.test_get_dashboard_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______________ TestAnalyticsUnit.test_get_user_analytics_success _______________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af019bef0>
mock_analytics_service = <MagicMock name='AnalyticsService' id='140022566071104'>
client = <httpx.AsyncClient object at 0x7f598b4b51f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lWME01MzU2Nlo5RFk2OTgyQzRYSCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQxOX0.iOtFa5iAwRcRLytacoIWp5HnZJJ_jM9KAN0t5cfEir8'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_get_user_analytics_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful user analytics retrieval."""
        mock_service = AsyncMock()
        mock_user_analytics = {
            "user_id": "user-123",
            "conversations_count": 25,
            "messages_sent": 150,
            "documents_uploaded": 8,
            "api_calls_made": 500,
            "tokens_used": 50000,
            "activity_by_day": {
                "2024-01-01": 10,
                "2024-01-02": 15,
                "2024-01-03": 8
            }
        }
        mock_service.get_user_analytics.return_value = mock_user_analytics
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/users/user-123", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:275: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1554' coro=<TestAnalyticsUnit.test_get_user_analytics_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_______________ TestAnalyticsUnit.test_export_analytics_success ________________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af019b890>
mock_analytics_service = <MagicMock name='AnalyticsService' id='140022557879104'>
client = <httpx.AsyncClient object at 0x7f598b8d4dd0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lWMUYwU1E2VlNTQURRMVhLS0JCRyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQyMH0.qlp6MAu8iDE4pGA06iS8kNpBFOl70bq3clist0HXotk'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_export_analytics_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful analytics export."""
        mock_service = AsyncMock()
        mock_export_result = {
            "export_id": "export-123",
            "status": "completed",
            "download_url": "https://example.com/download/export-123",
            "format": "csv",
            "records_count": 1000
        }
        mock_service.export_analytics.return_value = mock_export_result
        mock_analytics_service.return_value = mock_service
    
        export_data = {
            "date_range": {
                "start": "2024-01-01",
                "end": "2024-01-31"
            },
            "format": "csv",
            "include_types": ["conversations", "usage", "performance"]
        }
    
>       response = await client.post("/api/v1/analytics/export", json=export_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:307: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1568' coro=<TestAnalyticsUnit.test_export_analytics_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
___________ TestAnalyticsUnit.test_analytics_service_error_handling ____________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af019adb0>
mock_analytics_service = <MagicMock name='AnalyticsService' id='140022565812416'>
client = <httpx.AsyncClient object at 0x7f598b4bb890>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lWMjlIUEpZNzNBRFNSWEhEUjE1NSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQyMX0.1E7larTHb0NimVl6vfVfqiB38IgAjRi3N6sER67DKB4'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_analytics_service_error_handling(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test analytics service error handling."""
        mock_service = AsyncMock()
        mock_service.get_conversation_stats.side_effect = Exception("Analytics service error")
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/conversations", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:323: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1582' coro=<TestAnalyticsUnit.test_analytics_service_error_handling() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______________ TestAnalyticsUnit.test_get_metrics_summary_success ______________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af01a4260>
mock_analytics_service = <MagicMock name='AnalyticsService' id='140022422580032'>
client = <httpx.AsyncClient object at 0x7f598b6df4a0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lWM1dYVDQ5WFNRN1RYNzRIV1lQNCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQyM30.W37ImBGmQJ-G6UlyrhLjMpLRPuiaholtfm_MRfw6cY4'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_get_metrics_summary_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful metrics summary retrieval."""
        mock_service = AsyncMock()
        mock_summary = {
            "timestamp": "2024-01-01T12:00:00Z",
            "api_calls": 1250,
            "error_rate": 0.02,
            "avg_response_time": 245.6,
            "active_users": 45,
            "system_health": "healthy",
            "alerts_count": 2
        }
        mock_service.get_metrics_summary.return_value = mock_summary
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/metrics/summary", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:351: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1609' coro=<TestAnalyticsUnit.test_get_metrics_summary_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
__________________ TestAnalyticsUnit.test_get_health_success ___________________

self = <tests.test_analytics_unit.TestAnalyticsUnit object at 0x7f5af01a4a70>
mock_analytics_service = <MagicMock name='AnalyticsService' id='140022571659248'>
client = <httpx.AsyncClient object at 0x7f598ba4db20>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lWNFI2WllOVjFIUVdYUFYxWlFaMiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQyNH0.Qmy5drJgACK3bds97aGT6BcZ_Afmyyn39dMubE3gdtY'}

    @pytest.mark.unit
    @patch('chatter.api.analytics.AnalyticsService')
    async def test_get_health_success(self, mock_analytics_service, client: AsyncClient, auth_headers: dict):
        """Test successful analytics health check."""
        mock_service = AsyncMock()
        mock_health = {
            "status": "healthy",
            "services": {
                "database": "healthy",
                "cache": "healthy",
                "analytics_engine": "healthy"
            },
            "last_updated": "2024-01-01T12:00:00Z"
        }
        mock_service.get_health_status.return_value = mock_health
        mock_analytics_service.return_value = mock_service
    
>       response = await client.get("/api/v1/analytics/health", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_analytics_unit.py:376: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1623' coro=<TestAnalyticsUnit.test_get_health_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______ TestAuthIntegration.test_complete_user_registration_and_login_flow ______

self = <tests.test_auth_integration.TestAuthIntegration object at 0x7f59ad7fd610>
client = <httpx.AsyncClient object at 0x7f5981a407d0>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}

    @pytest.mark.integration
    async def test_complete_user_registration_and_login_flow(self, client: AsyncClient, test_user_data: dict):
        """Test complete user registration and login workflow."""
        # Step 1: Register user
>       register_response = await client.post("/api/v1/auth/register", json=test_user_data)
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_integration.py:18: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1658' coro=<TestAuthIntegration.test_complete_user_registration_and_login_flow() running at /home/yam/chatter/tests/test_auth_integration.py:18> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f598ba1d9a0>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1659' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:25.645200Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-1658' coro=<TestAuthIntegration.test_complete_user_registration_and_login_flow() running at /home/yam/chatter/tests/test_auth_integration.py:18> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
______________ TestAuthIntegration.test_login_with_email_workflow ______________

self = <tests.test_auth_integration.TestAuthIntegration object at 0x7f59ad7fd940>
client = <httpx.AsyncClient object at 0x7f5988516150>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}

    @pytest.mark.integration
    async def test_login_with_email_workflow(self, client: AsyncClient, test_user_data: dict):
        """Test login using email instead of username."""
        # Register user
>       await client.post("/api/v1/auth/register", json=test_user_data)

tests/test_auth_integration.py:53: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1673' coro=<TestAuthIntegration.test_login_with_email_workflow() running at /home/yam/chatter/tests/test_auth_integration.py:53> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f598ba1e030>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1674' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:26.387385Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-1673' coro=<TestAuthIntegration.test_login_with_email_workflow() running at /home/yam/chatter/tests/test_auth_integration.py:53> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
_______________ TestAuthIntegration.test_token_refresh_workflow ________________

self = <tests.test_auth_integration.TestAuthIntegration object at 0x7f59ad7fdd00>
client = <httpx.AsyncClient object at 0x7f5982e6f1d0>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}

    @pytest.mark.integration
    async def test_token_refresh_workflow(self, client: AsyncClient, test_user_data: dict):
        """Test token refresh workflow."""
        # Register user
>       register_response = await client.post("/api/v1/auth/register", json=test_user_data)
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_integration.py:71: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1688' coro=<TestAuthIntegration.test_token_refresh_workflow() running at /home/yam/chatter/tests/test_auth_integration.py:71> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f598ba1ee40>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1689' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:27.118825Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-1688' coro=<TestAuthIntegration.test_token_refresh_workflow() running at /home/yam/chatter/tests/test_auth_integration.py:71> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
_______________ TestAuthIntegration.test_profile_update_workflow _______________

self = <tests.test_auth_integration.TestAuthIntegration object at 0x7f59ad7fe0c0>
client = <httpx.AsyncClient object at 0x7f5981ee0350>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f5982f3e7e0>

    @pytest.mark.integration
    async def test_profile_update_workflow(self, client: AsyncClient, test_user_data: dict, db_session: AsyncSession):
        """Test complete profile update workflow."""
        # Register user
>       register_response = await client.post("/api/v1/auth/register", json=test_user_data)
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_integration.py:96: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1703' coro=<TestAuthIntegration.test_profile_update_workflow() running at /home/yam/chatter/tests/test_auth_integration.py:96> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f5982f4c7d0>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1704' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:28.373248Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-1703' coro=<TestAuthIntegration.test_profile_update_workflow() running at /home/yam/chatter/tests/test_auth_integration.py:96> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
______________ TestAuthIntegration.test_password_change_workflow _______________

self = <tests.test_auth_integration.TestAuthIntegration object at 0x7f59ad7fe480>
client = <httpx.AsyncClient object at 0x7f5982910f80>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}

    @pytest.mark.integration
    async def test_password_change_workflow(self, client: AsyncClient, test_user_data: dict):
        """Test password change workflow."""
        # Register user
>       register_response = await client.post("/api/v1/auth/register", json=test_user_data)
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_integration.py:128: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1718' coro=<TestAuthIntegration.test_password_change_workflow() running at /home/yam/chatter/tests/test_auth_integration.py:128> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f5982f4e210>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1719' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:29.036742Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-1718' coro=<TestAuthIntegration.test_password_change_workflow() running at /home/yam/chatter/tests/test_auth_integration.py:128> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
__________________ TestAuthIntegration.test_api_key_workflow ___________________

self = <tests.test_auth_integration.TestAuthIntegration object at 0x7f59ad7fe840>
client = <httpx.AsyncClient object at 0x7f5982509e50>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}

    @pytest.mark.integration
    async def test_api_key_workflow(self, client: AsyncClient, test_user_data: dict):
        """Test API key creation and usage workflow."""
        # Register user
>       register_response = await client.post("/api/v1/auth/register", json=test_user_data)
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_integration.py:170: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1733' coro=<TestAuthIntegration.test_api_key_workflow() running at /home/yam/chatter/tests/test_auth_integration.py:170> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f5982f4f3e0>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1734' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:29.704885Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-1733' coro=<TestAuthIntegration.test_api_key_workflow() running at /home/yam/chatter/tests/test_auth_integration.py:170> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
___________________ TestAuthIntegration.test_logout_workflow ___________________

self = <tests.test_auth_integration.TestAuthIntegration object at 0x7f59ad7fec00>
client = <httpx.AsyncClient object at 0x7f598193e4e0>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}

    @pytest.mark.integration
    async def test_logout_workflow(self, client: AsyncClient, test_user_data: dict):
        """Test logout workflow."""
        # Register user
>       register_response = await client.post("/api/v1/auth/register", json=test_user_data)
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_integration.py:212: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1748' coro=<TestAuthIntegration.test_logout_workflow() running at /home/yam/chatter/tests/test_auth_integration.py:212> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f59829ecaa0>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1749' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:30.376971Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-1748' coro=<TestAuthIntegration.test_logout_workflow() running at /home/yam/chatter/tests/test_auth_integration.py:212> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
____________ TestAuthIntegration.test_account_deactivation_workflow ____________

self = <tests.test_auth_integration.TestAuthIntegration object at 0x7f59ad7fefc0>
client = <httpx.AsyncClient object at 0x7f5981b7a960>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f598193bb00>

    @pytest.mark.integration
    async def test_account_deactivation_workflow(self, client: AsyncClient, test_user_data: dict, db_session: AsyncSession):
        """Test account deactivation workflow."""
        # Register user
>       register_response = await client.post("/api/v1/auth/register", json=test_user_data)
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_integration.py:237: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1763' coro=<TestAuthIntegration.test_account_deactivation_workflow() running at /home/yam/chatter/tests/test_auth_integration.py:237> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f59829ede50>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1764' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:31.034463Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-1763' coro=<TestAuthIntegration.test_account_deactivation_workflow() running at /home/yam/chatter/tests/test_auth_integration.py:237> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
______________ TestAuthIntegration.test_multiple_users_isolation _______________

self = <tests.test_auth_integration.TestAuthIntegration object at 0x7f59ad7ff380>
client = <httpx.AsyncClient object at 0x7f5981f719d0>

    @pytest.mark.integration
    async def test_multiple_users_isolation(self, client: AsyncClient):
        """Test that multiple users are properly isolated."""
        # Create first user
        user1_data = {
            "username": "user1",
            "email": "user1@example.com",
            "password": "Password123!",
            "full_name": "User One",
        }
    
>       user1_response = await client.post("/api/v1/auth/register", json=user1_data)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_integration.py:271: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1778' coro=<TestAuthIntegration.test_multiple_users_isolation() running at /home/yam/chatter/tests/test_auth_integration.py:271> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f59829ef3e0>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1779' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:32.347173Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35muser1@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-1778' coro=<TestAuthIntegration.test_multiple_users_isolation() running at /home/yam/chatter/tests/test_auth_integration.py:271> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35muser1[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
_______________ TestAuthIntegration.test_password_reset_workflow _______________

self = <tests.test_auth_integration.TestAuthIntegration object at 0x7f59ad7fd580>
client = <httpx.AsyncClient object at 0x7f59810a5d00>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}

    @pytest.mark.integration
    async def test_password_reset_workflow(self, client: AsyncClient, test_user_data: dict):
        """Test password reset workflow."""
        # Register user
>       await client.post("/api/v1/auth/register", json=test_user_data)

tests/test_auth_integration.py:312: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1793' coro=<TestAuthIntegration.test_password_reset_workflow() running at /home/yam/chatter/tests/test_auth_integration.py:312> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f5981b958b0>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1794' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:33.012571Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-1793' coro=<TestAuthIntegration.test_password_reset_workflow() running at /home/yam/chatter/tests/test_auth_integration.py:312> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
______________ TestAuthDatabaseIntegration.test_user_persistence _______________

self = <tests.test_auth_integration.TestAuthDatabaseIntegration object at 0x7f59ad7fe5d0>
client = <httpx.AsyncClient object at 0x7f598174a210>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f5981025520>

    @pytest.mark.integration
    async def test_user_persistence(self, client: AsyncClient, test_user_data: dict, db_session: AsyncSession):
        """Test that user data is properly persisted in database."""
        # Register user
>       response = await client.post("/api/v1/auth/register", json=test_user_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_integration.py:350: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1808' coro=<TestAuthDatabaseIntegration.test_user_persistence() running at /home/yam/chatter/tests/test_auth_integration.py:350> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f5981b956d0>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1809' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:33.691231Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-1808' coro=<TestAuthDatabaseIntegration.test_user_persistence() running at /home/yam/chatter/tests/test_auth_integration.py:350> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
_________ TestAuthDatabaseIntegration.test_user_uniqueness_constraints _________

self = <tests.test_auth_integration.TestAuthDatabaseIntegration object at 0x7f59ad7fda00>
client = <httpx.AsyncClient object at 0x7f5981166510>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f5980266ea0>

    @pytest.mark.integration
    async def test_user_uniqueness_constraints(self, client: AsyncClient, test_user_data: dict, db_session: AsyncSession):
        """Test database uniqueness constraints for username and email."""
        # Create first user
>       response1 = await client.post("/api/v1/auth/register", json=test_user_data)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_integration.py:373: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1823' coro=<TestAuthDatabaseIntegration.test_user_uniqueness_constraints() running at /home/yam/chatter/tests/test_auth_integration.py:373> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f5981b95e50>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1824' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:34.368651Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-1823' coro=<TestAuthDatabaseIntegration.test_user_uniqueness_constraints() running at /home/yam/chatter/tests/test_auth_integration.py:373> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
________ TestAuthDatabaseIntegration.test_transaction_rollback_on_error ________

self = <tests.test_auth_integration.TestAuthDatabaseIntegration object at 0x7f59ad7ff800>
client = <httpx.AsyncClient object at 0x7f59805614c0>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59823c7800>

    @pytest.mark.integration
    async def test_transaction_rollback_on_error(self, client: AsyncClient, db_session: AsyncSession):
        """Test that database transactions are properly rolled back on errors."""
        # Count users before
        stmt = select(User)
>       result = await db_session.execute(stmt)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_integration.py:401: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1838' coro=<TestAuthDatabaseIntegration.test_transaction_rollback_on_error() running at /home/yam/chatter/tests/test_auth_integration.py:401> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f5981195310>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1839' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
________ TestEnhancedPasswordSecurity.test_password_entropy_calculation ________

self = <tests.test_auth_security_comprehensive.TestEnhancedPasswordSecurity object at 0x7f59ad61d4f0>

    @pytest.mark.security
    def test_password_entropy_calculation(self):
        """Test password entropy calculation."""
        # Weak password
        weak_entropy = calculate_password_entropy("123456")
        assert weak_entropy < 30
    
        # Medium password
        medium_entropy = calculate_password_entropy("Password123")
>       assert 30 <= medium_entropy < 50
E       assert 56.66343593148202 < 50

tests/test_auth_security_comprehensive.py:40: AssertionError
_________ TestEnhancedPasswordSecurity.test_personal_info_in_password __________

self = <tests.test_auth_security_comprehensive.TestEnhancedPasswordSecurity object at 0x7f59ad61d6d0>

    @pytest.mark.security
    def test_personal_info_in_password(self):
        """Test personal information detection in passwords."""
        user_data = {
            "username": "johndoe",
            "email": "john.doe@example.com",
            "full_name": "John Doe"
        }
    
        assert contains_personal_info("johndoe123", user_data) is True
>       assert contains_personal_info("john123password", user_data) is True
E       AssertionError: assert False is True
E        +  where False = contains_personal_info('john123password', {'email': 'john.doe@example.com', 'full_name': 'John Doe', 'username': 'johndoe'})

tests/test_auth_security_comprehensive.py:81: AssertionError
________ TestAuthServiceSecurity.test_user_creation_security_validation ________

self = <tests.test_auth_security_comprehensive.TestAuthServiceSecurity object at 0x7f59ad61e900>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59805934a0>

    @pytest.mark.security
    async def test_user_creation_security_validation(self, db_session: AsyncSession):
        """Test user creation with enhanced security validation."""
        auth_service = AuthService(db_session)
    
        # Test disposable email rejection
        import uuid
        unique_id = str(uuid.uuid4())[:8]
        with pytest.raises(Exception) as exc_info:
            await auth_service.create_user(UserCreate(
                username=f"testuser_{unique_id}",
                email="test@10minutemail.com",
                password="ValidPass123!",
                full_name="Test User"
            ))
        assert "disposable email" in str(exc_info.value).lower()
    
        # Test prohibited username rejection
        unique_id = str(uuid.uuid4())[:8]
        with pytest.raises(Exception) as exc_info:
            await auth_service.create_user(UserCreate(
                username="admin",
                email=f"test_{unique_id}@example.com",
                password="ValidPass123!",
                full_name="Test User"
            ))
        assert "prohibited" in str(exc_info.value).lower()
    
        # Test weak password rejection
        unique_id = str(uuid.uuid4())[:8]
        with pytest.raises(Exception) as exc_info:
            await auth_service.create_user(UserCreate(
                username=f"testuser_{unique_id}",
                email=f"test_{unique_id}@example.com",
                password="123456",
                full_name="Test User"
            ))
>       assert "security requirements" in str(exc_info.value).lower()
E       assert 'security requirements' in "1 validation error for usercreate\npassword\n  string should have at least 8 characters [type=string_too_short, input_value='123456', input_type=str]\n    for further information visit https://errors.pydantic.dev/2.11/v/string_too_short"
E        +  where "1 validation error for usercreate\npassword\n  string should have at least 8 characters [type=string_too_short, input_value='123456', input_type=str]\n    for further information visit https://errors.pydantic.dev/2.11/v/string_too_short" = <built-in method lower of str object at 0x7f59a7352d30>()
E        +    where <built-in method lower of str object at 0x7f59a7352d30> = "1 validation error for UserCreate\npassword\n  String should have at least 8 characters [type=string_too_short, input_value='123456', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.11/v/string_too_short".lower
E        +      where "1 validation error for UserCreate\npassword\n  String should have at least 8 characters [type=string_too_short, input_value='123456', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.11/v/string_too_short" = str(1 validation error for UserCreate\npassword\n  String should have at least 8 characters [type=string_too_short, input_value='123456', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.11/v/string_too_short)
E        +        where 1 validation error for UserCreate\npassword\n  String should have at least 8 characters [type=string_too_short, input_value='123456', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.11/v/string_too_short = <ExceptionInfo 1 validation error for UserCreate\npassword\n  String should have at least 8 characters [type=string_too_short, input_value='123456', input_type=str]\n    For further information visit https://errors.pydantic.dev/2.11/v/string_too_short tblen=2>.value

tests/test_auth_security_comprehensive.py:258: AssertionError
____________ TestAuthServiceSecurity.test_password_change_security _____________

self = <tests.test_auth_security_comprehensive.TestAuthServiceSecurity object at 0x7f59ad61ebd0>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f5980581c10>

    @pytest.mark.security
    async def test_password_change_security(self, db_session: AsyncSession):
        """Test password change security validation."""
        auth_service = AuthService(db_session)
    
        # Create test user
        user_data = UserCreate(
            username="testuser",
            email="test@example.com",
            password="OldPass123!",
            full_name="Test User"
        )
>       user = await auth_service.create_user(user_data)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_security_comprehensive.py:282: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.core.auth.AuthService object at 0x7f5980591130>
user_data = UserCreate(email='test@example.com', username='testuser', full_name='Test User', bio=None, avatar_url=None, phone_number=None, password='OldPass123!')

    async def create_user(self, user_data: UserCreate) -> User:
        """Create a new user with enhanced security validation.
    
        Args:
            user_data: User creation data
    
        Returns:
            Created user
    
        Raises:
            UserAlreadyExistsError: If user already exists
            BadRequestProblem: If validation fails
        """
        # Enhanced email validation with security checks
        if not validate_email_advanced(user_data.email):
            raise BadRequestProblem(
                detail="Invalid email format or disposable email domain"
            ) from None
    
        # Enhanced username validation
        if not validate_username_secure(user_data.username):
            raise BadRequestProblem(
                detail="Username format is invalid or contains prohibited patterns"
            ) from None
    
        # Enhanced password validation with entropy and security checks
        password_validation = validate_password_advanced(user_data.password)
        if not password_validation["valid"]:
            raise BadRequestProblem(
                detail="Password does not meet security requirements",
                errors=password_validation["errors"],
            ) from None
    
        # Check if password contains personal information
        user_data_dict = {
            "username": user_data.username,
            "email": user_data.email,
            "full_name": user_data.full_name
        }
        if contains_personal_info(user_data.password, user_data_dict):
            raise BadRequestProblem(
                detail="Password should not contain personal information"
            ) from None
    
        # Check if user already exists
        existing_user = await self.get_user_by_email(user_data.email)
        if existing_user:
>           raise UserAlreadyExistsError(
                "User with this email already exists"
            ) from None
E           chatter.utils.problem.ConflictProblem: 409: User with this email already exists

chatter/core/auth.py:155: ConflictProblem
_____________ TestAuthServiceSecurity.test_secure_api_key_creation _____________

self = <tests.test_auth_security_comprehensive.TestAuthServiceSecurity object at 0x7f59ad61ef00>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f5980590470>

    @pytest.mark.security
    async def test_secure_api_key_creation(self, db_session: AsyncSession):
        """Test secure API key creation."""
        auth_service = AuthService(db_session)
    
        # Create test user
        user_data = UserCreate(
            username="testuser",
            email="test@example.com",
            password="ValidPass123!",
            full_name="Test User"
        )
>       user = await auth_service.create_user(user_data)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_security_comprehensive.py:322: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.core.auth.AuthService object at 0x7f59805911f0>
user_data = UserCreate(email='test@example.com', username='testuser', full_name='Test User', bio=None, avatar_url=None, phone_number=None, password='ValidPass123!')

    async def create_user(self, user_data: UserCreate) -> User:
        """Create a new user with enhanced security validation.
    
        Args:
            user_data: User creation data
    
        Returns:
            Created user
    
        Raises:
            UserAlreadyExistsError: If user already exists
            BadRequestProblem: If validation fails
        """
        # Enhanced email validation with security checks
        if not validate_email_advanced(user_data.email):
            raise BadRequestProblem(
                detail="Invalid email format or disposable email domain"
            ) from None
    
        # Enhanced username validation
        if not validate_username_secure(user_data.username):
            raise BadRequestProblem(
                detail="Username format is invalid or contains prohibited patterns"
            ) from None
    
        # Enhanced password validation with entropy and security checks
        password_validation = validate_password_advanced(user_data.password)
        if not password_validation["valid"]:
            raise BadRequestProblem(
                detail="Password does not meet security requirements",
                errors=password_validation["errors"],
            ) from None
    
        # Check if password contains personal information
        user_data_dict = {
            "username": user_data.username,
            "email": user_data.email,
            "full_name": user_data.full_name
        }
        if contains_personal_info(user_data.password, user_data_dict):
            raise BadRequestProblem(
                detail="Password should not contain personal information"
            ) from None
    
        # Check if user already exists
        existing_user = await self.get_user_by_email(user_data.email)
        if existing_user:
>           raise UserAlreadyExistsError(
                "User with this email already exists"
            ) from None
E           chatter.utils.problem.ConflictProblem: 409: User with this email already exists

chatter/core/auth.py:155: ConflictProblem
_________ TestAuthServiceSecurity.test_authentication_security_logging _________

self = <tests.test_auth_security_comprehensive.TestAuthServiceSecurity object at 0x7f59ad61f230>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59805a8860>

    @pytest.mark.security
    async def test_authentication_security_logging(self, db_session: AsyncSession):
        """Test security logging for authentication events."""
        auth_service = AuthService(db_session)
    
        # Create test user
        user_data = UserCreate(
            username="testuser",
            email="test@example.com",
            password="ValidPass123!",
            full_name="Test User"
        )
>       user = await auth_service.create_user(user_data)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_security_comprehensive.py:354: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.core.auth.AuthService object at 0x7f5980582ae0>
user_data = UserCreate(email='test@example.com', username='testuser', full_name='Test User', bio=None, avatar_url=None, phone_number=None, password='ValidPass123!')

    async def create_user(self, user_data: UserCreate) -> User:
        """Create a new user with enhanced security validation.
    
        Args:
            user_data: User creation data
    
        Returns:
            Created user
    
        Raises:
            UserAlreadyExistsError: If user already exists
            BadRequestProblem: If validation fails
        """
        # Enhanced email validation with security checks
        if not validate_email_advanced(user_data.email):
            raise BadRequestProblem(
                detail="Invalid email format or disposable email domain"
            ) from None
    
        # Enhanced username validation
        if not validate_username_secure(user_data.username):
            raise BadRequestProblem(
                detail="Username format is invalid or contains prohibited patterns"
            ) from None
    
        # Enhanced password validation with entropy and security checks
        password_validation = validate_password_advanced(user_data.password)
        if not password_validation["valid"]:
            raise BadRequestProblem(
                detail="Password does not meet security requirements",
                errors=password_validation["errors"],
            ) from None
    
        # Check if password contains personal information
        user_data_dict = {
            "username": user_data.username,
            "email": user_data.email,
            "full_name": user_data.full_name
        }
        if contains_personal_info(user_data.password, user_data_dict):
            raise BadRequestProblem(
                detail="Password should not contain personal information"
            ) from None
    
        # Check if user already exists
        existing_user = await self.get_user_by_email(user_data.email)
        if existing_user:
>           raise UserAlreadyExistsError(
                "User with this email already exists"
            ) from None
E           chatter.utils.problem.ConflictProblem: 409: User with this email already exists

chatter/core/auth.py:155: ConflictProblem
_______ TestTokenSecurityIntegration.test_token_creation_security_claims _______

self = <tests.test_auth_security_comprehensive.TestTokenSecurityIntegration object at 0x7f59ad61f680>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59805abbc0>

    @pytest.mark.security
    async def test_token_creation_security_claims(self, db_session: AsyncSession):
        """Test token creation includes proper security claims."""
        auth_service = AuthService(db_session)
    
        # Create test user
        user_data = UserCreate(
            username="testuser",
            email="test@example.com",
            password="ValidPass123!",
            full_name="Test User"
        )
>       user = await auth_service.create_user(user_data)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_security_comprehensive.py:383: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.core.auth.AuthService object at 0x7f59805905c0>
user_data = UserCreate(email='test@example.com', username='testuser', full_name='Test User', bio=None, avatar_url=None, phone_number=None, password='ValidPass123!')

    async def create_user(self, user_data: UserCreate) -> User:
        """Create a new user with enhanced security validation.
    
        Args:
            user_data: User creation data
    
        Returns:
            Created user
    
        Raises:
            UserAlreadyExistsError: If user already exists
            BadRequestProblem: If validation fails
        """
        # Enhanced email validation with security checks
        if not validate_email_advanced(user_data.email):
            raise BadRequestProblem(
                detail="Invalid email format or disposable email domain"
            ) from None
    
        # Enhanced username validation
        if not validate_username_secure(user_data.username):
            raise BadRequestProblem(
                detail="Username format is invalid or contains prohibited patterns"
            ) from None
    
        # Enhanced password validation with entropy and security checks
        password_validation = validate_password_advanced(user_data.password)
        if not password_validation["valid"]:
            raise BadRequestProblem(
                detail="Password does not meet security requirements",
                errors=password_validation["errors"],
            ) from None
    
        # Check if password contains personal information
        user_data_dict = {
            "username": user_data.username,
            "email": user_data.email,
            "full_name": user_data.full_name
        }
        if contains_personal_info(user_data.password, user_data_dict):
            raise BadRequestProblem(
                detail="Password should not contain personal information"
            ) from None
    
        # Check if user already exists
        existing_user = await self.get_user_by_email(user_data.email)
        if existing_user:
>           raise UserAlreadyExistsError(
                "User with this email already exists"
            ) from None
E           chatter.utils.problem.ConflictProblem: 409: User with this email already exists

chatter/core/auth.py:155: ConflictProblem
_____________ TestRateLimitingIntegration.test_login_rate_limiting _____________

self = <tests.test_auth_security_comprehensive.TestRateLimitingIntegration object at 0x7f59ad7ff680>
client = <httpx.AsyncClient object at 0x7f59803b7e30>

    @pytest.mark.security
    async def test_login_rate_limiting(self, client: AsyncClient):
        """Test login endpoint rate limiting."""
        login_data = {
            "username": "testuser",
            "password": "wrongpassword"
        }
    
        # Make multiple rapid requests
        responses = []
        for i in range(10):
>           response = await client.post("/api/v1/auth/login", json=login_data)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_security_comprehensive.py:461: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:214: in login
    user = await auth_service.authenticate_user(
chatter/core/auth.py:202: in authenticate_user
    user = await self.get_user_by_username(username)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:334: in get_user_by_username
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1919' coro=<TestRateLimitingIntegration.test_login_rate_limiting() running at /home/yam/chatter/tests/test_auth_security_comprehensive.py:461> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f5981195d60>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1920' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
_________ TestRateLimitingIntegration.test_registration_rate_limiting __________

self = <tests.test_auth_security_comprehensive.TestRateLimitingIntegration object at 0x7f59ad61fd40>
client = <httpx.AsyncClient object at 0x7f5982748950>

    @pytest.mark.security
    async def test_registration_rate_limiting(self, client: AsyncClient):
        """Test registration endpoint rate limiting."""
        # Make multiple rapid registration attempts
        responses = []
        for i in range(5):
            registration_data = {
                "username": f"testuser{i}",
                "email": f"test{i}@example.com",
                "password": "ValidPass123!",
                "full_name": f"Test User {i}"
            }
>           response = await client.post("/api/v1/auth/register", json=registration_data)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_security_comprehensive.py:481: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1934' coro=<TestRateLimitingIntegration.test_registration_rate_limiting() running at /home/yam/chatter/tests/test_auth_security_comprehensive.py:481> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f5981197890>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1935' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:41.131879Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mtest0@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-1934' coro=<TestRateLimitingIntegration.test_registration_rate_limiting() running at /home/yam/chatter/tests/test_auth_security_comprehensive.py:481> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mtestuser0[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
__ TestCompleteAuthSecurityIntegration.test_complete_secure_registration_flow __

self = <tests.test_auth_security_integration.TestCompleteAuthSecurityIntegration object at 0x7f59ad638b30>
client = <httpx.AsyncClient object at 0x7f5980ba4f20>

    @pytest.mark.integration
    @pytest.mark.security
    async def test_complete_secure_registration_flow(self, client: AsyncClient):
        """Test complete secure registration with all validations."""
        # Test 1: Try registration with disposable email (should fail)
        disposable_email_data = {
            "username": "testuser",
            "email": "test@10minutemail.com",
            "password": "ValidPass123!",
            "full_name": "Test User"
        }
    
        response = await client.post("/api/v1/auth/register", json=disposable_email_data)
        assert response.status_code == 400
        assert "disposable email" in response.json()["detail"].lower()
    
        # Test 2: Try registration with prohibited username (should fail)
        prohibited_username_data = {
            "username": "admin",
            "email": "test@example.com",
            "password": "ValidPass123!",
            "full_name": "Test User"
        }
    
        response = await client.post("/api/v1/auth/register", json=prohibited_username_data)
        assert response.status_code == 400
        assert "prohibited" in response.json()["detail"].lower()
    
        # Test 3: Try registration with weak password (should fail)
        weak_password_data = {
            "username": "testuser",
            "email": "test@example.com",
            "password": "123456",
            "full_name": "Test User"
        }
    
        response = await client.post("/api/v1/auth/register", json=weak_password_data)
>       assert response.status_code == 400
E       assert 422 == 400
E        +  where 422 = <Response [422 Unprocessable Entity]>.status_code

tests/test_auth_security_integration.py:57: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:45.314241Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mtest@10minutemail.co...[0m [36merror[0m=[35m400: Invalid email format or disposable email domain[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mtestuser[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:45.315406Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mtest@example.com[0m [36merror[0m=[35m400: Username format is invalid or contains prohibited patterns[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35madmin[0m
____ TestCompleteAuthSecurityIntegration.test_secure_login_with_monitoring _____

self = <tests.test_auth_security_integration.TestCompleteAuthSecurityIntegration object at 0x7f59ad638e30>
client = <httpx.AsyncClient object at 0x7f597fd5dc10>

    @pytest.mark.integration
    @pytest.mark.security
    async def test_secure_login_with_monitoring(self, client: AsyncClient):
        """Test secure login with security monitoring."""
        # First, register a user
        user_data = {
            "username": "testuser",
            "email": "test@example.com",
            "password": "ValidPass123!",
            "full_name": "Test User"
        }
    
>       register_response = await client.post("/api/v1/auth/register", json=user_data)
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_security_integration.py:102: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1962' coro=<TestCompleteAuthSecurityIntegration.test_secure_login_with_monitoring() running at /home/yam/chatter/tests/test_auth_security_integration.py:102> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f5982715a90>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1963' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:45.530853Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mtest@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-1962' coro=<TestCompleteAuthSecurityIntegration.test_secure_login_with_monitoring() running at /home/yam/chatter/tests/test_auth_security_integration.py:102> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mtestuser[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
______ TestCompleteAuthSecurityIntegration.test_secure_api_key_management ______

self = <tests.test_auth_security_integration.TestCompleteAuthSecurityIntegration object at 0x7f59ad6391c0>
client = <httpx.AsyncClient object at 0x7f59806bea80>

    @pytest.mark.integration
    @pytest.mark.security
    async def test_secure_api_key_management(self, client: AsyncClient):
        """Test secure API key management with enhanced security."""
        # Register and login
        user_data = {
            "username": "apiuser",
            "email": "api@example.com",
            "password": "ValidPass123!",
            "full_name": "API User"
        }
    
>       register_response = await client.post("/api/v1/auth/register", json=user_data)
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_security_integration.py:139: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-1977' coro=<TestCompleteAuthSecurityIntegration.test_secure_api_key_management() running at /home/yam/chatter/tests/test_auth_security_integration.py:139> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f5982714f50>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-1978' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:46.294973Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mapi@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-1977' coro=<TestCompleteAuthSecurityIntegration.test_secure_api_key_management() running at /home/yam/chatter/tests/test_auth_security_integration.py:139> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mapiuser[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
_____ TestCompleteAuthSecurityIntegration.test_secure_password_change_flow _____

self = <tests.test_auth_security_integration.TestCompleteAuthSecurityIntegration object at 0x7f59ad639550>
client = <httpx.AsyncClient object at 0x7f598047bbc0>

    @pytest.mark.integration
    @pytest.mark.security
    async def test_secure_password_change_flow(self, client: AsyncClient):
        """Test secure password change with enhanced validation."""
        # Register user
        user_data = {
            "username": "passuser",
            "email": "pass@example.com",
            "password": "OldPass123!",
            "full_name": "Password User"
        }
    
        register_response = await client.post("/api/v1/auth/register", json=user_data)
        tokens = register_response.json()
>       auth_headers = {"Authorization": f"Bearer {tokens['access_token']}"}
                                                   ^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'access_token'

tests/test_auth_security_integration.py:195: KeyError
------------------------------ Captured log call -------------------------------
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:46.999159Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mpass@example.com[0m [36merror[0m=[35m400: Password should not contain personal information[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mpassuser[0m
_______ TestCompleteAuthSecurityIntegration.test_token_security_features _______

self = <tests.test_auth_security_integration.TestCompleteAuthSecurityIntegration object at 0x7f59ad6398e0>
client = <httpx.AsyncClient object at 0x7f597ee4c9b0>

    @pytest.mark.integration
    @pytest.mark.security
    async def test_token_security_features(self, client: AsyncClient):
        """Test enhanced token security features."""
        # Register user
        user_data = {
            "username": "tokenuser",
            "email": "token@example.com",
            "password": "ValidPass123!",
            "full_name": "Token User"
        }
    
>       register_response = await client.post("/api/v1/auth/register", json=user_data)
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_security_integration.py:270: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2005' coro=<TestCompleteAuthSecurityIntegration.test_token_security_features() running at /home/yam/chatter/tests/test_auth_security_integration.py:270> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f5980624050>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-2006' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:47.193351Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mtoken@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-2005' coro=<TestCompleteAuthSecurityIntegration.test_token_security_features() running at /home/yam/chatter/tests/test_auth_security_integration.py:270> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mtokenuser[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
____ TestCompleteAuthSecurityIntegration.test_password_reset_security_flow _____

self = <tests.test_auth_security_integration.TestCompleteAuthSecurityIntegration object at 0x7f59ad7ff4d0>
client = <httpx.AsyncClient object at 0x7f59a66e8980>

    @pytest.mark.integration
    @pytest.mark.security
    async def test_password_reset_security_flow(self, client: AsyncClient):
        """Test secure password reset flow."""
        # Register user
        user_data = {
            "username": "resetuser",
            "email": "reset@example.com",
            "password": "OriginalPass123!",
            "full_name": "Reset User"
        }
    
>       register_response = await client.post("/api/v1/auth/register", json=user_data)
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_security_integration.py:349: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2020' coro=<TestCompleteAuthSecurityIntegration.test_password_reset_security_flow() running at /home/yam/chatter/tests/test_auth_security_integration.py:349> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f5981b97110>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-2021' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:48.552429Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mreset@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-2020' coro=<TestCompleteAuthSecurityIntegration.test_password_reset_security_flow() running at /home/yam/chatter/tests/test_auth_security_integration.py:349> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mresetuser[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
__ TestCompleteAuthSecurityIntegration.test_comprehensive_security_validation __

self = <tests.test_auth_security_integration.TestCompleteAuthSecurityIntegration object at 0x7f59ad639f10>
client = <httpx.AsyncClient object at 0x7f597edb63c0>

    @pytest.mark.integration
    @pytest.mark.security
    async def test_comprehensive_security_validation(self, client: AsyncClient):
        """Test comprehensive security validation across all endpoints."""
        # Test various security scenarios
        security_tests = [
            {
                "name": "XSS in full_name",
                "data": {
                    "username": "xssuser",
                    "email": "xss@example.com",
                    "password": "ValidPass123!",
                    "full_name": "<script>alert('xss')</script>"
                },
                "should_succeed": True,  # Should be sanitized, not rejected
            },
            {
                "name": "SQL injection in username",
                "data": {
                    "username": "'; DROP TABLE users; --",
                    "email": "sql@example.com",
                    "password": "ValidPass123!",
                    "full_name": "SQL User"
                },
                "should_succeed": False,  # Should be rejected
            },
            {
                "name": "Extremely long fields",
                "data": {
                    "username": "a" * 1000,
                    "email": "long@example.com",
                    "password": "ValidPass123!",
                    "full_name": "b" * 10000
                },
                "should_succeed": False,  # Should be rejected
            },
            {
                "name": "Unicode and special characters",
                "data": {
                    "username": "unicode_用户",
                    "email": "unicode@example.com",
                    "password": "ValidPass123!",
                    "full_name": "Unicode 用户 👤"
                },
                "should_succeed": False,  # Username should be rejected
            }
        ]
    
        for test in security_tests:
>           response = await client.post("/api/v1/auth/register", json=test["data"])
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_security_integration.py:425: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2035' coro=<TestCompleteAuthSecurityIntegration.test_comprehensive_security_validation() running at /home/yam/chatter/tests/test_auth_security_integration.py:425> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f5980624230>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-2036' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:49.239650Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mxss@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-2035' coro=<TestCompleteAuthSecurityIntegration.test_comprehensive_security_validation() running at /home/yam/chatter/tests/test_auth_security_integration.py:425> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mxssuser[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
______ TestSecurityPerformanceIntegration.test_auth_endpoint_performance _______

self = <tests.test_auth_security_integration.TestSecurityPerformanceIntegration object at 0x7f59ad638d70>
client = <httpx.AsyncClient object at 0x7f597fb031a0>

    @pytest.mark.integration
    @pytest.mark.performance
    async def test_auth_endpoint_performance(self, client: AsyncClient):
        """Test that security enhancements don't severely impact performance."""
        import time
    
        # Register user
        user_data = {
            "username": "perfuser",
            "email": "perf@example.com",
            "password": "ValidPass123!",
            "full_name": "Performance User"
        }
    
        # Time registration
        start_time = time.time()
>       response = await client.post("/api/v1/auth/register", json=user_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_security_integration.py:457: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2050' coro=<TestSecurityPerformanceIntegration.test_auth_endpoint_performance() running at /home/yam/chatter/tests/test_auth_security_integration.py:457> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f5980626f30>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-2051' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:49.909970Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mperf@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-2050' coro=<TestSecurityPerformanceIntegration.test_auth_endpoint_performance() running at /home/yam/chatter/tests/test_auth_security_integration.py:457> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mperfuser[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
_____ TestSecurityPerformanceIntegration.test_multiple_concurrent_requests _____

self = <tests.test_auth_security_integration.TestSecurityPerformanceIntegration object at 0x7f59ad63a150>
client = <httpx.AsyncClient object at 0x7f597e5580e0>

    @pytest.mark.integration
    @pytest.mark.performance
    async def test_multiple_concurrent_requests(self, client: AsyncClient):
        """Test system handles multiple concurrent auth requests."""
        # Create multiple registration tasks
        tasks = []
        for i in range(10):
            user_data = {
                "username": f"concurrentuser{i}",
                "email": f"concurrent{i}@example.com",
                "password": "ValidPass123!",
                "full_name": f"Concurrent User {i}"
            }
            task = client.post("/api/v1/auth/register", json=user_data)
            tasks.append(task)
    
        # Execute all tasks concurrently
        import time
        start_time = time.time()
        responses = await asyncio.gather(*tasks, return_exceptions=True)
        total_time = time.time() - start_time
    
        # Check results
        successful_registrations = 0
        for response in responses:
            if hasattr(response, 'status_code') and response.status_code == 201:
                successful_registrations += 1
    
        # Should handle concurrent requests reasonably well
>       assert successful_registrations >= 8  # At least 80% success rate
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       assert 0 >= 8

tests/test_auth_security_integration.py:516: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:50.569904Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent1@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser1[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:50.571719Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent2@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser2[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:50.572853Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent3@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser3[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:50.573989Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent4@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser4[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:50.575008Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent5@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser5[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:50.576034Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent6@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser6[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:50.577179Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent7@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser7[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:50.578193Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent8@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser8[0m
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:50.579385Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent9@example....[0m [36merror[0m=[35mThis session is provisioning a new connection; concurrent operations are not permitted (Background on this error at: https://sqlalche.me/e/20/isce)[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser9[0m
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f597ea848c0>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-2076' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:50.580563Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35mconcurrent0@example....[0m [36merror[0m=[35mTask <Task pending name='Task-2066' coro=<AsyncClient.post() running at /home/yam/.local/lib/python3.12/site-packages/httpx/_client.py:1859> cb=[gather.<locals>._done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:767]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35mconcurrentuser0[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
___________________ TestAuthUnitTests.test_user_registration ___________________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x7f59ad63b470>
client = <httpx.AsyncClient object at 0x7f597f429940>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}

    @pytest.mark.unit
    async def test_user_registration(self, client: AsyncClient, test_user_data: dict):
        """Test user registration endpoint."""
>       response = await client.post("/api/v1/auth/register", json=test_user_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:18: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2090' coro=<TestAuthUnitTests.test_user_registration() running at /home/yam/chatter/tests/test_auth_unit.py:18> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f597e576300>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-2091' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:50.788244Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-2090' coro=<TestAuthUnitTests.test_user_registration() running at /home/yam/chatter/tests/test_auth_unit.py:18> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
_________ TestAuthUnitTests.test_user_registration_duplicate_username __________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x7f59ad63b7a0>
client = <httpx.AsyncClient object at 0x7f597f1068a0>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}

    @pytest.mark.unit
    async def test_user_registration_duplicate_username(self, client: AsyncClient, test_user_data: dict):
        """Test that duplicate username registration fails."""
        # Register first user
>       response1 = await client.post("/api/v1/auth/register", json=test_user_data)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:41: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2105' coro=<TestAuthUnitTests.test_user_registration_duplicate_username() running at /home/yam/chatter/tests/test_auth_unit.py:41> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f597e575130>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-2106' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:51.468651Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-2105' coro=<TestAuthUnitTests.test_user_registration_duplicate_username() running at /home/yam/chatter/tests/test_auth_unit.py:41> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
___________ TestAuthUnitTests.test_user_registration_duplicate_email ___________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x7f59ad63bb60>
client = <httpx.AsyncClient object at 0x7f597e6521e0>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}

    @pytest.mark.unit
    async def test_user_registration_duplicate_email(self, client: AsyncClient, test_user_data: dict):
        """Test that duplicate email registration fails."""
        # Register first user
>       response1 = await client.post("/api/v1/auth/register", json=test_user_data)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:55: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2120' coro=<TestAuthUnitTests.test_user_registration_duplicate_email() running at /home/yam/chatter/tests/test_auth_unit.py:55> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f597e5763f0>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-2121' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:52.939901Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-2120' coro=<TestAuthUnitTests.test_user_registration_duplicate_email() running at /home/yam/chatter/tests/test_auth_unit.py:55> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
__________________ TestAuthUnitTests.test_user_login_success ___________________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x7f59ad65c2f0>
client = <httpx.AsyncClient object at 0x7f597df89370>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}

    @pytest.mark.unit
    async def test_user_login_success(self, client: AsyncClient, test_user_data: dict):
        """Test successful user login."""
        # First register a user
>       await client.post("/api/v1/auth/register", json=test_user_data)

tests/test_auth_unit.py:82: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2148' coro=<TestAuthUnitTests.test_user_login_success() running at /home/yam/chatter/tests/test_auth_unit.py:82> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f597de524e0>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-2149' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:53.899506Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-2148' coro=<TestAuthUnitTests.test_user_login_success() running at /home/yam/chatter/tests/test_auth_unit.py:82> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
_________________ TestAuthUnitTests.test_user_login_with_email _________________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x7f59ad63bef0>
client = <httpx.AsyncClient object at 0x7f597e41d7c0>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}

    @pytest.mark.unit
    async def test_user_login_with_email(self, client: AsyncClient, test_user_data: dict):
        """Test user login using email instead of username."""
        # First register a user
>       await client.post("/api/v1/auth/register", json=test_user_data)

tests/test_auth_unit.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2163' coro=<TestAuthUnitTests.test_user_login_with_email() running at /home/yam/chatter/tests/test_auth_unit.py:104> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f597de533e0>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-2164' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:54.654108Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-2163' coro=<TestAuthUnitTests.test_user_login_with_email() running at /home/yam/chatter/tests/test_auth_unit.py:104> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
____________ TestAuthUnitTests.test_user_login_invalid_credentials _____________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x7f59ad63a450>
client = <httpx.AsyncClient object at 0x7f597f98d880>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}

    @pytest.mark.unit
    async def test_user_login_invalid_credentials(self, client: AsyncClient, test_user_data: dict):
        """Test login with invalid credentials."""
        # First register a user
>       await client.post("/api/v1/auth/register", json=test_user_data)

tests/test_auth_unit.py:119: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2178' coro=<TestAuthUnitTests.test_user_login_invalid_credentials() running at /home/yam/chatter/tests/test_auth_unit.py:119> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f597e42d4f0>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-2179' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:55.414011Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-2178' coro=<TestAuthUnitTests.test_user_login_invalid_credentials() running at /home/yam/chatter/tests/test_auth_unit.py:119> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
______________ TestAuthUnitTests.test_user_login_nonexistent_user ______________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x7f59ad65c740>
client = <httpx.AsyncClient object at 0x7f597d8b6000>

    @pytest.mark.unit
    async def test_user_login_nonexistent_user(self, client: AsyncClient):
        """Test login with non-existent user."""
        login_data = {
            "username": "nonexistent",
            "password": "password123",
        }
    
>       response = await client.post("/api/v1/auth/login", json=login_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:138: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:214: in login
    user = await auth_service.authenticate_user(
chatter/core/auth.py:202: in authenticate_user
    user = await self.get_user_by_username(username)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:334: in get_user_by_username
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2193' coro=<TestAuthUnitTests.test_user_login_nonexistent_user() running at /home/yam/chatter/tests/test_auth_unit.py:138> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f597e42d400>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-2194' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
___________________ TestAuthUnitTests.test_get_current_user ____________________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x7f59ad65c830>
client = <httpx.AsyncClient object at 0x7f597d172360>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXNFlTTUFaU0pFMjg1SEpCUjdQRSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ1N30.VtMyIb8qvI7K35s4e6hA1npidnDcpQLORbmlIdP3SNU'}

    @pytest.mark.unit
    async def test_get_current_user(self, client: AsyncClient, auth_headers: dict):
        """Test getting current user information."""
>       response = await client.get("/api/v1/auth/me", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:144: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2209' coro=<TestAuthUnitTests.test_get_current_user() running at /home/yam/chatter/tests/test_auth_unit.py:144> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________ TestAuthUnitTests.test_get_current_user_without_auth _____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597daedbb0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597daedbb0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x7f59ad65cc20>
client = <httpx.AsyncClient object at 0x7f597daecf50>

    @pytest.mark.unit
    async def test_get_current_user_without_auth(self, client: AsyncClient):
        """Test getting current user without authentication."""
>       response = await client.get("/api/v1/auth/me")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:158: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597daedbb0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:50:57.852305Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mb8a59d47-1348-4e92-a915-2bea375547f0[0m [36mstatus_code[0m=[35m401[0m
_____________________ TestAuthUnitTests.test_token_refresh _____________________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x7f59ad65d370>
client = <httpx.AsyncClient object at 0x7f59839b97f0>
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}

    @pytest.mark.unit
    async def test_token_refresh(self, client: AsyncClient, test_user_data: dict):
        """Test refreshing access token."""
        # Register and login to get tokens
>       await client.post("/api/v1/auth/register", json=test_user_data)

tests/test_auth_unit.py:172: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:302: in app
    raw_response = await run_endpoint_function(
../.local/lib/python3.12/site-packages/fastapi/routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:152: in register
    user = await auth_service.create_user(user_data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:153: in create_user
    existing_user = await self.get_user_by_email(user_data.email)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:320: in get_user_by_email
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1189: in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3277: in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:143: in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:3301: in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:447: in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1363: in _checkout
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
../.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py:1301: in _checkout
    result = pool._dialect._do_ping_w_event(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:728: in _do_ping_w_event
    return self.do_ping(dbapi_connection)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:1169: in do_ping
    dbapi_connection.ping()
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:813: in ping
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:811: in ping
    _ = self.await_(self._async_ping())
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:820: in _async_ping
    await tr.start()
../.local/lib/python3.12/site-packages/asyncpg/transaction.py:146: in start
    await self._connection.execute(query)
../.local/lib/python3.12/site-packages/asyncpg/connection.py:349: in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2248' coro=<TestAuthUnitTests.test_token_refresh() running at /home/yam/chatter/tests/test_auth_unit.py:172> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:375: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f597d1eaa80>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-2249' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
WARNING  chatter.api.auth:auth.py:177 [2m2025-09-05T12:50:59.279739Z[0m [[33m[1mwarning  [0m] [1mRegistration failed           [0m [[34m[1mchatter.api.auth[0m] [36memail[0m=[35malice@example.com[0m [36merror[0m=[35mTask <Task pending name='Task-2248' coro=<TestAuthUnitTests.test_token_refresh() running at /home/yam/chatter/tests/test_auth_unit.py:172> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop[0m [36mip_address[0m=[35m127.0.0.1[0m [36musername[0m=[35malice[0m
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
____________________ TestAuthUnitTests.test_update_profile _____________________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x7f59ad65daf0>
client = <httpx.AsyncClient object at 0x7f5983dc9fa0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXODZDSDFaVktXVDgwODU5ME5OMSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ2MH0.ilTTTwOD6mdOwd7_O7BJBpjdF8OzCYMJuVuKv1ZY1Fo'}

    @pytest.mark.unit
    async def test_update_profile(self, client: AsyncClient, auth_headers: dict):
        """Test updating user profile."""
        update_data = {
            "full_name": "Updated Full Name",
            "email": "updated@example.com",
        }
    
>       response = await client.put("/api/v1/auth/me", json=update_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:212: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1896: in put
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2277' coro=<TestAuthUnitTests.test_update_profile() running at /home/yam/chatter/tests/test_auth_unit.py:212> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______________ TestAuthUnitTests.test_update_profile_without_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5983c35c40>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5983c35c40>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x7f59ad65dee0>
client = <httpx.AsyncClient object at 0x7f5983c34ef0>

    @pytest.mark.unit
    async def test_update_profile_without_auth(self, client: AsyncClient):
        """Test updating profile without authentication."""
        update_data = {
            "full_name": "Updated Full Name",
        }
    
>       response = await client.put("/api/v1/auth/me", json=update_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:226: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1896: in put
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5983c35c40>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:51:01.163667Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m2e25979c-8d86-4d9f-b44e-c39a1506c872[0m [36mstatus_code[0m=[35m401[0m
____________________ TestAuthUnitTests.test_change_password ____________________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x7f59ad65e270>
client = <httpx.AsyncClient object at 0x7f597c6b7a40>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXOUg4NzRQOTNEMEdGWjA0UUczQyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ2MX0.1ngMeElQfDSnxDAdZiPYrAggpKmEiVmruROerSGPfOQ'}
test_user_data = {'email': 'alice@example.com', 'full_name': 'Alice User', 'password': 'SecureP@ssw0rd!', 'username': 'alice'}

    @pytest.mark.unit
    async def test_change_password(self, client: AsyncClient, auth_headers: dict, test_user_data: dict):
        """Test changing user password."""
        password_data = {
            "current_password": test_user_data["password"],
            "new_password": "NewSecurePassword123!",
        }
    
>       response = await client.post("/api/v1/auth/change-password", json=password_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:237: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2304' coro=<TestAuthUnitTests.test_change_password() running at /home/yam/chatter/tests/test_auth_unit.py:237> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________ TestAuthUnitTests.test_change_password_wrong_current _____________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x7f59ad65e690>
client = <httpx.AsyncClient object at 0x7f597cfc6d20>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXQUVYUkVWVjZQQTU5Q01YR1ZDOSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ2Mn0.GTxedewBhE5bB9m9VoyIaTZZrhcvkBnuTwd_eVlusTc'}

    @pytest.mark.unit
    async def test_change_password_wrong_current(self, client: AsyncClient, auth_headers: dict):
        """Test changing password with wrong current password."""
        password_data = {
            "current_password": "wrong_current_password",
            "new_password": "NewSecurePassword123!",
        }
    
>       response = await client.post("/api/v1/auth/change-password", json=password_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:252: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2318' coro=<TestAuthUnitTests.test_change_password_wrong_current() running at /home/yam/chatter/tests/test_auth_unit.py:252> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
________________________ TestAuthUnitTests.test_logout _________________________

self = <tests.test_auth_unit.TestAuthUnitTests object at 0x7f59ad65ea50>
client = <httpx.AsyncClient object at 0x7f597cab5fa0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXQkNEOVc0WlZSRk5FNUNTU0hBMSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ2M30.7Q1mmDzpF_xZ_QOqsMxOwKj8tZ-0_sHxiwxRy7jeWP4'}

    @pytest.mark.unit
    async def test_logout(self, client: AsyncClient, auth_headers: dict):
        """Test user logout."""
>       response = await client.post("/api/v1/auth/logout", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:258: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2332' coro=<TestAuthUnitTests.test_logout() running at /home/yam/chatter/tests/test_auth_unit.py:258> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
__________________ TestAuthServiceUnit.test_authenticate_user __________________

self = <tests.test_auth_unit.TestAuthServiceUnit object at 0x7f59ad65f1a0>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f597c002d80>

    @pytest.mark.unit
    async def test_authenticate_user(self, db_session: AsyncSession):
        """Test user authentication through AuthService."""
        auth_service = AuthService(db_session)
    
        # Create a user first
        user_data = UserCreate(
            username="testuser",
            email="test@example.com",
            password="SecurePassword123!",
            full_name="Test User",
        )
    
>       created_user = await auth_service.create_user(user_data)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_auth_unit.py:304: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.core.auth.AuthService object at 0x7f597c2bc9b0>
user_data = UserCreate(email='test@example.com', username='testuser', full_name='Test User', bio=None, avatar_url=None, phone_number=None, password='SecurePassword123!')

    async def create_user(self, user_data: UserCreate) -> User:
        """Create a new user with enhanced security validation.
    
        Args:
            user_data: User creation data
    
        Returns:
            Created user
    
        Raises:
            UserAlreadyExistsError: If user already exists
            BadRequestProblem: If validation fails
        """
        # Enhanced email validation with security checks
        if not validate_email_advanced(user_data.email):
            raise BadRequestProblem(
                detail="Invalid email format or disposable email domain"
            ) from None
    
        # Enhanced username validation
        if not validate_username_secure(user_data.username):
            raise BadRequestProblem(
                detail="Username format is invalid or contains prohibited patterns"
            ) from None
    
        # Enhanced password validation with entropy and security checks
        password_validation = validate_password_advanced(user_data.password)
        if not password_validation["valid"]:
            raise BadRequestProblem(
                detail="Password does not meet security requirements",
                errors=password_validation["errors"],
            ) from None
    
        # Check if password contains personal information
        user_data_dict = {
            "username": user_data.username,
            "email": user_data.email,
            "full_name": user_data.full_name
        }
        if contains_personal_info(user_data.password, user_data_dict):
            raise BadRequestProblem(
                detail="Password should not contain personal information"
            ) from None
    
        # Check if user already exists
        existing_user = await self.get_user_by_email(user_data.email)
        if existing_user:
>           raise UserAlreadyExistsError(
                "User with this email already exists"
            ) from None
E           chatter.utils.problem.ConflictProblem: 409: User with this email already exists

chatter/core/auth.py:155: ConflictProblem
__________ TestAuthServiceUnit.test_authenticate_user_wrong_password ___________

self = <tests.test_auth_unit.TestAuthServiceUnit object at 0x7f59ad65ede0>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f597c099b20>

    @pytest.mark.unit
    async def test_authenticate_user_wrong_password(self, db_session: AsyncSession):
        """Test authentication with wrong password."""
        auth_service = AuthService(db_session)
    
        # Create a user first
        user_data = UserCreate(
            username="testuser",
            email="test@example.com",
            password="SecurePassword123!",
            full_name="Test User",
        )
    
>       await auth_service.create_user(user_data)

tests/test_auth_unit.py:328: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.core.auth.AuthService object at 0x7f597c04aed0>
user_data = UserCreate(email='test@example.com', username='testuser', full_name='Test User', bio=None, avatar_url=None, phone_number=None, password='SecurePassword123!')

    async def create_user(self, user_data: UserCreate) -> User:
        """Create a new user with enhanced security validation.
    
        Args:
            user_data: User creation data
    
        Returns:
            Created user
    
        Raises:
            UserAlreadyExistsError: If user already exists
            BadRequestProblem: If validation fails
        """
        # Enhanced email validation with security checks
        if not validate_email_advanced(user_data.email):
            raise BadRequestProblem(
                detail="Invalid email format or disposable email domain"
            ) from None
    
        # Enhanced username validation
        if not validate_username_secure(user_data.username):
            raise BadRequestProblem(
                detail="Username format is invalid or contains prohibited patterns"
            ) from None
    
        # Enhanced password validation with entropy and security checks
        password_validation = validate_password_advanced(user_data.password)
        if not password_validation["valid"]:
            raise BadRequestProblem(
                detail="Password does not meet security requirements",
                errors=password_validation["errors"],
            ) from None
    
        # Check if password contains personal information
        user_data_dict = {
            "username": user_data.username,
            "email": user_data.email,
            "full_name": user_data.full_name
        }
        if contains_personal_info(user_data.password, user_data_dict):
            raise BadRequestProblem(
                detail="Password should not contain personal information"
            ) from None
    
        # Check if user already exists
        existing_user = await self.get_user_by_email(user_data.email)
        if existing_user:
>           raise UserAlreadyExistsError(
                "User with this email already exists"
            ) from None
E           chatter.utils.problem.ConflictProblem: 409: User with this email already exists

chatter/core/auth.py:155: ConflictProblem
_____________________ TestCLICommands.test_health_command ______________________

self = <tests.test_cli.TestCLICommands object at 0x7f59ad12c830>
mock_asyncio_run = <MagicMock name='run' id='140022309460144'>

    @patch('chatter.cli.asyncio.run')
    def test_health_command(self, mock_asyncio_run):
        """Test health check command."""
        result = self.runner.invoke(app, ["health"])
>       assert result.exit_code == 0
E       assert 2 == 0
E        +  where 2 = <Result SystemExit(2)>.exit_code

tests/test_cli.py:283: AssertionError
__________________ TestHealthCheck.test_health_check_success ___________________

self = <tests.test_cli.TestHealthCheck object at 0x7f59ad12cd10>
mock_get_client = <MagicMock name='get_api_client' id='140022309894960'>

    @pytest.mark.asyncio
    @patch('chatter.cli.get_api_client')
    async def test_health_check_success(self, mock_get_client):
        """Test successful health check."""
        mock_client = MagicMock()
        mock_client.request = AsyncMock(return_value={
            "status": "ok",
            "version": "1.0.0",
            "timestamp": "2024-01-01T00:00:00Z"
        })
        mock_client.close = AsyncMock()
        mock_get_client.return_value = mock_client
    
        with patch('chatter.cli.console') as mock_console:
>           await health_check()
                  ^^^^^^^^^^^^^^

tests/test_cli.py:318: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/cli.py:988: in health_check
    asyncio.run(_check())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

main = <coroutine object health_check.<locals>._check at 0x7f597d28ca50>

    def run(main, *, debug=None, loop_factory=None):
        """Execute the coroutine and return the result.
    
        This function runs the passed coroutine, taking care of
        managing the asyncio event loop, finalizing asynchronous
        generators and closing the default executor.
    
        This function cannot be called when another asyncio event loop is
        running in the same thread.
    
        If debug is True, the event loop will be run in debug mode.
        If loop_factory is passed, it is used for new event loop creation.
    
        This function always creates a new event loop and closes it at the end.
        It should be used as a main entry point for asyncio programs, and should
        ideally only be called once.
    
        The executor is given a timeout duration of 5 minutes to shutdown.
        If the executor hasn't finished within that duration, a warning is
        emitted and the executor is closed.
    
        Example:
    
            async def main():
                await asyncio.sleep(1)
                print('hello')
    
            asyncio.run(main())
        """
        if events._get_running_loop() is not None:
            # fail fast with short traceback
>           raise RuntimeError(
                "asyncio.run() cannot be called from a running event loop")
E           RuntimeError: asyncio.run() cannot be called from a running event loop

/usr/lib64/python3.12/asyncio/runners.py:191: RuntimeError
__________________ TestHealthCheck.test_health_check_failure ___________________

self = <tests.test_cli.TestHealthCheck object at 0x7f59ad12ce30>
mock_get_client = <MagicMock name='get_api_client' id='140022309575072'>

    @pytest.mark.asyncio
    @patch('chatter.cli.get_api_client')
    async def test_health_check_failure(self, mock_get_client):
        """Test health check failure."""
        mock_client = MagicMock()
        mock_client.request = AsyncMock(side_effect=Exception("Connection failed"))
        mock_client.close = AsyncMock()
        mock_get_client.return_value = mock_client
    
        # Should not raise exception, but handle gracefully
>       await health_check()
              ^^^^^^^^^^^^^^

tests/test_cli.py:333: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/cli.py:988: in health_check
    asyncio.run(_check())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

main = <coroutine object health_check.<locals>._check at 0x7f5983d11180>

    def run(main, *, debug=None, loop_factory=None):
        """Execute the coroutine and return the result.
    
        This function runs the passed coroutine, taking care of
        managing the asyncio event loop, finalizing asynchronous
        generators and closing the default executor.
    
        This function cannot be called when another asyncio event loop is
        running in the same thread.
    
        If debug is True, the event loop will be run in debug mode.
        If loop_factory is passed, it is used for new event loop creation.
    
        This function always creates a new event loop and closes it at the end.
        It should be used as a main entry point for asyncio programs, and should
        ideally only be called once.
    
        The executor is given a timeout duration of 5 minutes to shutdown.
        If the executor hasn't finished within that duration, a warning is
        emitted and the executor is closed.
    
        Example:
    
            async def main():
                await asyncio.sleep(1)
                print('hello')
    
            asyncio.run(main())
        """
        if events._get_running_loop() is not None:
            # fail fast with short traceback
>           raise RuntimeError(
                "asyncio.run() cannot be called from a running event loop")
E           RuntimeError: asyncio.run() cannot be called from a running event loop

/usr/lib64/python3.12/asyncio/runners.py:191: RuntimeError
__________________ TestDatabaseCommands.test_db_init_success ___________________

self = <tests.test_cli.TestDatabaseCommands object at 0x7f59ad12cc80>
mock_check_db = <AsyncMock name='check_database_connection' id='140022440511584'>
mock_init_db = <MagicMock name='db_init' id='140022440513792'>

    @pytest.mark.asyncio
    @patch('chatter.cli.db_init')
    @patch('chatter.cli.check_database_connection')
    async def test_db_init_success(self, mock_check_db, mock_init_db):
        """Test successful database initialization."""
        mock_check_db.return_value = True
        mock_init_db.return_value = None
    
        with patch('chatter.cli.console') as mock_console:
>           await db_init()
                  ^^^^^^^^^

tests/test_cli.py:348: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/cli.py:677: in db_init
    asyncio.run(_init())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

main = <coroutine object db_init.<locals>._init at 0x7f597d20ab50>

    def run(main, *, debug=None, loop_factory=None):
        """Execute the coroutine and return the result.
    
        This function runs the passed coroutine, taking care of
        managing the asyncio event loop, finalizing asynchronous
        generators and closing the default executor.
    
        This function cannot be called when another asyncio event loop is
        running in the same thread.
    
        If debug is True, the event loop will be run in debug mode.
        If loop_factory is passed, it is used for new event loop creation.
    
        This function always creates a new event loop and closes it at the end.
        It should be used as a main entry point for asyncio programs, and should
        ideally only be called once.
    
        The executor is given a timeout duration of 5 minutes to shutdown.
        If the executor hasn't finished within that duration, a warning is
        emitted and the executor is closed.
    
        Example:
    
            async def main():
                await asyncio.sleep(1)
                print('hello')
    
            asyncio.run(main())
        """
        if events._get_running_loop() is not None:
            # fail fast with short traceback
>           raise RuntimeError(
                "asyncio.run() cannot be called from a running event loop")
E           RuntimeError: asyncio.run() cannot be called from a running event loop

/usr/lib64/python3.12/asyncio/runners.py:191: RuntimeError
_____________ TestDatabaseCommands.test_db_init_connection_failure _____________

self = <tests.test_cli.TestDatabaseCommands object at 0x7f59ad12d280>
mock_check_db = <AsyncMock name='check_database_connection' id='140022326999520'>
mock_init_db = <MagicMock name='db_init' id='140022326987904'>

    @pytest.mark.asyncio
    @patch('chatter.cli.db_init')
    @patch('chatter.cli.check_database_connection')
    async def test_db_init_connection_failure(self, mock_check_db, mock_init_db):
        """Test database initialization with connection failure."""
        mock_check_db.return_value = False
    
        with patch('chatter.cli.console') as mock_console:
>           await db_init()
                  ^^^^^^^^^

tests/test_cli.py:362: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/cli.py:677: in db_init
    asyncio.run(_init())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

main = <coroutine object db_init.<locals>._init at 0x7f597d20b030>

    def run(main, *, debug=None, loop_factory=None):
        """Execute the coroutine and return the result.
    
        This function runs the passed coroutine, taking care of
        managing the asyncio event loop, finalizing asynchronous
        generators and closing the default executor.
    
        This function cannot be called when another asyncio event loop is
        running in the same thread.
    
        If debug is True, the event loop will be run in debug mode.
        If loop_factory is passed, it is used for new event loop creation.
    
        This function always creates a new event loop and closes it at the end.
        It should be used as a main entry point for asyncio programs, and should
        ideally only be called once.
    
        The executor is given a timeout duration of 5 minutes to shutdown.
        If the executor hasn't finished within that duration, a warning is
        emitted and the executor is closed.
    
        Example:
    
            async def main():
                await asyncio.sleep(1)
                print('hello')
    
            asyncio.run(main())
        """
        if events._get_running_loop() is not None:
            # fail fast with short traceback
>           raise RuntimeError(
                "asyncio.run() cannot be called from a running event loop")
E           RuntimeError: asyncio.run() cannot be called from a running event loop

/usr/lib64/python3.12/asyncio/runners.py:191: RuntimeError
________________ TestDatabaseCommands.test_db_init_init_failure ________________

self = <tests.test_cli.TestDatabaseCommands object at 0x7f59ad12d4c0>
mock_check_db = <AsyncMock name='check_database_connection' id='140022326533376'>
mock_init_db = <MagicMock name='db_init' id='140022326528672'>

    @pytest.mark.asyncio
    @patch('chatter.cli.db_init')
    @patch('chatter.cli.check_database_connection')
    async def test_db_init_init_failure(self, mock_check_db, mock_init_db):
        """Test database initialization with init failure."""
        mock_check_db.return_value = True
        mock_init_db.side_effect = Exception("Init failed")
    
        with patch('chatter.cli.console') as mock_console:
>           await db_init()
                  ^^^^^^^^^

tests/test_cli.py:377: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/cli.py:677: in db_init
    asyncio.run(_init())
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

main = <coroutine object db_init.<locals>._init at 0x7f597d20b510>

    def run(main, *, debug=None, loop_factory=None):
        """Execute the coroutine and return the result.
    
        This function runs the passed coroutine, taking care of
        managing the asyncio event loop, finalizing asynchronous
        generators and closing the default executor.
    
        This function cannot be called when another asyncio event loop is
        running in the same thread.
    
        If debug is True, the event loop will be run in debug mode.
        If loop_factory is passed, it is used for new event loop creation.
    
        This function always creates a new event loop and closes it at the end.
        It should be used as a main entry point for asyncio programs, and should
        ideally only be called once.
    
        The executor is given a timeout duration of 5 minutes to shutdown.
        If the executor hasn't finished within that duration, a warning is
        emitted and the executor is closed.
    
        Example:
    
            async def main():
                await asyncio.sleep(1)
                print('hello')
    
            asyncio.run(main())
        """
        if events._get_running_loop() is not None:
            # fail fast with short traceback
>           raise RuntimeError(
                "asyncio.run() cannot be called from a running event loop")
E           RuntimeError: asyncio.run() cannot be called from a running event loop

/usr/lib64/python3.12/asyncio/runners.py:191: RuntimeError
________ TestInteractivePromptCreation.test_interactive_prompt_creation ________

self = <tests.test_cli.TestInteractivePromptCreation object at 0x7f59ad12d8b0>
mock_get_client = <MagicMock name='get_api_client' id='140022326994048'>
mock_confirm = <MagicMock name='ask' id='140022326990016'>
mock_prompt = <MagicMock name='ask' id='140022326985168'>

    @pytest.mark.asyncio
    @patch('chatter.cli.Prompt.ask')
    @patch('chatter.cli.Confirm.ask')
    @patch('chatter.cli.get_api_client')
    async def test_interactive_prompt_creation(self, mock_get_client, mock_confirm, mock_prompt):
        """Test interactive prompt creation flow."""
        # Mock interactive input
        mock_prompt.side_effect = [
            "Test Prompt",        # name
            "Hello {name}",       # content
            "Test description",   # description
            "greeting",           # category
            "template",           # prompt_type
            "f-string",          # template_format
            "hello,greeting"      # tags
        ]
        mock_confirm.return_value = True  # public
    
        # Mock API client
        mock_client = MagicMock()
        mock_client.request = AsyncMock(return_value={
            "id": "test_id",
            "name": "Test Prompt",
            "status": "created"
        })
        mock_client.close = AsyncMock()
        mock_get_client.return_value = mock_client
    
        # This would normally be called through the CLI command
        # We're testing the underlying async function logic
        from chatter.cli import create_prompt
    
        runner = CliRunner()
        result = runner.invoke(app, [
            "prompts", "create",
            "--name", "Test Prompt",
            "--content", "Hello {name}",
            "--interactive"
        ])
    
        # Should complete without error
>       assert result.exit_code == 0
E       AssertionError: assert 1 == 0
E        +  where 1 = <Result RuntimeError('asyncio.run() cannot be called from a running event loop')>.exit_code

tests/test_cli.py:428: AssertionError
________________ TestCLIIntegration.test_full_prompt_lifecycle _________________

self = <tests.test_cli.TestCLIIntegration object at 0x7f59ad10bad0>
mock_get_client = <MagicMock name='get_api_client' id='140022326986464'>

    @patch('chatter.cli.get_api_client')
    def test_full_prompt_lifecycle(self, mock_get_client):
        """Test complete prompt management lifecycle."""
        mock_client = MagicMock()
    
        # Mock different API responses for different commands
        def mock_request(method, endpoint, **kwargs):
            if endpoint == "/prompts" and method == "POST":
                return {"id": "new_prompt_id", "name": "Test Prompt"}
            elif endpoint == "/prompts" and method == "GET":
                return {
                    "prompts": [{
                        "id": "new_prompt_id",
                        "name": "Test Prompt",
                        "prompt_type": "template",
                        "category": "test"
                    }],
                    "total_count": 1
                }
            elif endpoint == "/prompts/new_prompt_id" and method == "DELETE":
                return {"status": "deleted"}
            return {}
    
        mock_client.request = AsyncMock(side_effect=mock_request)
        mock_client.close = AsyncMock()
        mock_get_client.return_value = mock_client
    
        # Create prompt
        result = self.runner.invoke(app, [
            "prompts", "create",
            "--name", "Test Prompt",
            "--content", "Hello {name}",
            "--category", "test"
        ])
>       assert result.exit_code == 0
E       assert 1 == 0
E        +  where 1 = <Result UnboundLocalError("cannot access local variable 'name' where it is not associated with a value")>.exit_code

tests/test_cli.py:532: AssertionError
_____________ TestCLIErrorScenarios.test_api_unavailable_scenarios _____________

self = <tests.test_cli.TestCLIErrorScenarios object at 0x7f59ad12c320>
mock_get_client = <MagicMock name='get_api_client' id='140022326684240'>

    @patch('chatter.cli.get_api_client')
    def test_api_unavailable_scenarios(self, mock_get_client):
        """Test CLI behavior when API is unavailable."""
        mock_client = MagicMock()
        mock_client.request = AsyncMock(side_effect=httpx.RequestError("Connection failed"))
        mock_client.close = AsyncMock()
        mock_get_client.return_value = mock_client
    
        result = self.runner.invoke(app, ["health"])
        # Should handle error gracefully
>       assert result.exit_code == 0  # Command should complete, even if API is down
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       assert 2 == 0
E        +  where 2 = <Result SystemExit(2)>.exit_code

tests/test_cli.py:601: AssertionError
_____ TestSecretManager.test_encrypt_with_different_managers_incompatible ______

self = <tests.test_crypto_utils.TestSecretManager object at 0x7f59ad155820>

    def test_encrypt_with_different_managers_incompatible(self):
        """Test that data encrypted with one manager can't be decrypted with another."""
        manager1 = SecretManager()
        manager2 = SecretManager()
    
        test_data = "secret data"
        encrypted = manager1.encrypt(test_data)
    
>       with pytest.raises(CryptoError, match="Failed to decrypt data"):
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       Failed: DID NOT RAISE <class 'chatter.utils.crypto.CryptoError'>

tests/test_crypto_utils.py:93: Failed
------------------------------ Captured log call -------------------------------
WARNING  chatter.utils.crypto:crypto.py:59 [2m2025-09-05T12:51:09.695857Z[0m [[33m[1mwarning  [0m] [1mUsing derived encryption key. Set CHATTER_ENCRYPTION_KEY in production.[0m [[34m[1mchatter.utils.crypto[0m] 
WARNING  chatter.utils.crypto:crypto.py:59 [2m2025-09-05T12:51:09.714736Z[0m [[33m[1mwarning  [0m] [1mUsing derived encryption key. Set CHATTER_ENCRYPTION_KEY in production.[0m [[34m[1mchatter.utils.crypto[0m]
___________ TestDataManagementIntegration.test_export_data_workflow ____________

self = <tests.test_data_management_integration.TestDataManagementIntegration object at 0x7f59ad1575f0>
client = <httpx.AsyncClient object at 0x7f597b015af0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXSFlCQlhTNEtFNTE4SzJOQk5RQiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ3MH0.6mzq8VGXwxpTYfQn4MTt3DK8IcW3bAR3N_STLH5XfDA'}

    @pytest.mark.integration
    async def test_export_data_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test complete data export workflow."""
        # Test export with valid data structure (even if service isn't fully configured)
        export_data = {
            "format": "json",
            "scope": "user",
            "include_documents": True,
            "include_conversations": True,
            "include_analytics": False,
            "date_range": {
                "start_date": "2024-01-01T00:00:00Z",
                "end_date": "2024-12-31T23:59:59Z"
            }
        }
    
        response = await client.post("/api/v1/data-management/export",
                                   headers=auth_headers, json=export_data)
    
        # Should start export successfully or handle gracefully
>       assert response.status_code in [202, 422, 500]  # 202 = Accepted, others = graceful failures
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       assert 404 in [202, 422, 500]
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_integration.py:30: AssertionError
______________ TestDataManagementIntegration.test_backup_workflow ______________

self = <tests.test_data_management_integration.TestDataManagementIntegration object at 0x7f59ad157920>
client = <httpx.AsyncClient object at 0x7f597c7e0560>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXSkJNTjEyVFdUNzRLSko4SEcwWiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ3MH0.D0CHXtSCMWTEvssykwpN5zEG1As_wUzdEOotP4trNKU'}

    @pytest.mark.integration
    async def test_backup_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test backup creation and listing workflow."""
        # Test backup creation
        backup_data = {
            "name": "Test Backup",
            "description": "Integration test backup",
            "backup_type": "full",
            "encrypt": False,
            "compress": True
        }
    
        response = await client.post("/api/v1/data-management/backup",
                                   headers=auth_headers, json=backup_data)
    
        # Should start backup or handle gracefully
>       assert response.status_code in [202, 422, 500]
E       assert 404 in [202, 422, 500]
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_integration.py:55: AssertionError
__________ TestDataManagementIntegration.test_storage_stats_workflow ___________

self = <tests.test_data_management_integration.TestDataManagementIntegration object at 0x7f59ad17c0e0>
client = <httpx.AsyncClient object at 0x7f597bb3f950>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXSzVORVZOR1YzWUtFR05DUU5QMSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ3MX0.sSD0GDDtJtsF3IbMKlGiAjsZVELOXeIcPDjhaHqgCT4'}

    @pytest.mark.integration
    async def test_storage_stats_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test storage statistics workflow."""
        response = await client.get("/api/v1/data-management/stats",
                                  headers=auth_headers)
    
>       assert response.status_code in [200, 500]  # Should work or fail gracefully
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       assert 404 in [200, 500]
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_integration.py:99: AssertionError
______ TestDataManagementIntegration.test_bulk_delete_documents_workflow _______

self = <tests.test_data_management_integration.TestDataManagementIntegration object at 0x7f59ad157dd0>
client = <httpx.AsyncClient object at 0x7f597bcf1f40>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXS0swQ1c5QUI3SEc5ODFSNEM5MCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ3Mn0.PCRBjnYbcIwiDmstuSoUcMplCXRh6kj-4miv52BoujU'}

    @pytest.mark.integration
    async def test_bulk_delete_documents_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test bulk document deletion workflow."""
        # Test with empty list
        delete_data = {"document_ids": []}
    
        response = await client.post("/api/v1/data-management/bulk/delete-documents",
                                   headers=auth_headers, json=delete_data)
    
>       assert response.status_code in [200, 422, 500]
E       assert 404 in [200, 422, 500]
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_integration.py:118: AssertionError
____ TestDataManagementIntegration.test_bulk_delete_conversations_workflow _____

self = <tests.test_data_management_integration.TestDataManagementIntegration object at 0x7f59ad156e70>
client = <httpx.AsyncClient object at 0x7f597aab8800>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXTTAwR0pRVFREU1BLNDk4UzI3SiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ3Mn0.ujEhu6bjGyEHtSSRYXWGsy3gRsr_XTclXRpkwsdfF6Q'}

    @pytest.mark.integration
    async def test_bulk_delete_conversations_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test bulk conversation deletion workflow."""
        # Test with empty list
        delete_data = {"conversation_ids": []}
    
        response = await client.post("/api/v1/data-management/bulk/delete-conversations",
                                   headers=auth_headers, json=delete_data)
    
>       assert response.status_code in [200, 422, 500]
E       assert 404 in [200, 422, 500]
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_integration.py:148: AssertionError
_______ TestDataManagementIntegration.test_bulk_delete_prompts_workflow ________

self = <tests.test_data_management_integration.TestDataManagementIntegration object at 0x7f59ad17c080>
client = <httpx.AsyncClient object at 0x7f597a772510>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXTUREVDFEREZLSEJLVkRFUlExQSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ3Mn0.h3vwXErfz4STxC3Xz2FHscyD5WVRReg23msh6VuMFk8'}

    @pytest.mark.integration
    async def test_bulk_delete_prompts_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test bulk prompt deletion workflow."""
        # Test with empty list
        delete_data = {"prompt_ids": []}
    
        response = await client.post("/api/v1/data-management/bulk/delete-prompts",
                                   headers=auth_headers, json=delete_data)
    
>       assert response.status_code in [200, 422, 500]
E       assert 404 in [200, 422, 500]
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_integration.py:164: AssertionError
____ TestDataManagementIntegration.test_data_management_permission_workflow ____

self = <tests.test_data_management_integration.TestDataManagementIntegration object at 0x7f59ad17c5c0>
client = <httpx.AsyncClient object at 0x7f597a43c2c0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXTVRBMEtSTVM0WkJHWVFZVkdDSyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ3M30.ynb8NT4TlNhmY6QAKcgaRu-b_P4wSxLkv-kZEdcMRCQ'}

    @pytest.mark.integration
    async def test_data_management_permission_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test data management permission and access control workflow."""
        # Test without authentication - all should return 401
        response = await client.get("/api/v1/data-management/stats")
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_integration.py:176: AssertionError
________ TestDataManagementIntegration.test_cross_api_data_consistency _________

self = <tests.test_data_management_integration.TestDataManagementIntegration object at 0x7f59ad17c980>
client = <httpx.AsyncClient object at 0x7f597a2f9eb0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXTjdQOThOQzc2MVozQ1I4MVdRSCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ3M30._W04HWxVXC3x8McJ0PF3lo1Ot1Ulou9ueOW6jF5PrRM'}

    @pytest.mark.integration
    async def test_cross_api_data_consistency(self, client: AsyncClient, auth_headers: dict):
        """Test data consistency between documents and data management APIs."""
        # Get document stats
>       doc_response = await client.get("/api/v1/documents/stats/overview",
                                      headers=auth_headers)

tests/test_data_management_integration.py:201: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2649' coro=<TestDataManagementIntegration.test_cross_api_data_consistency() running at /home/yam/chatter/tests/test_data_management_integration.py:201> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
___________ TestDataManagementUnit.test_export_data_endpoint_exists ____________

self = <tests.test_data_management_unit.TestDataManagementUnit object at 0x7f59ad17d250>
client = <httpx.AsyncClient object at 0x7f5978dd8ce0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXUDNFUE40TU5YUFo5WjkxOEhIUyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ3NH0.pRH_PugmkfS1VkuWihJI-AYYbxLti8rht2g9cg_B-Hg'}

    @pytest.mark.unit
    async def test_export_data_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that export data endpoint exists and validates authentication."""
        # Test with missing auth header - should get 401
        response = await client.post("/api/v1/data-management/export", json={})
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_unit.py:15: AssertionError
__________ TestDataManagementUnit.test_create_backup_endpoint_exists ___________

self = <tests.test_data_management_unit.TestDataManagementUnit object at 0x7f59ad17d580>
client = <httpx.AsyncClient object at 0x7f5979512ba0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXUEVaRDdSUkZaM0NGRERLSlNGNyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ3NX0.gK2YBLOaMOpy51hJ8VQxQTaOHYQFm3gabIQYTC8a0UY'}

    @pytest.mark.unit
    async def test_create_backup_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that create backup endpoint exists."""
        # Test without auth - should get 401
        response = await client.post("/api/v1/data-management/backup", json={})
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_unit.py:27: AssertionError
___________ TestDataManagementUnit.test_list_backups_endpoint_exists ___________

self = <tests.test_data_management_unit.TestDataManagementUnit object at 0x7f59ad17d940>
client = <httpx.AsyncClient object at 0x7f5979294950>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXUFREQjdON1lWWlRQWUtCUEg0MyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ3NX0.AAxlOA63KVZgZuP8whQPsLDO4huxo5SMqt9mrfRNBc4'}

    @pytest.mark.unit
    async def test_list_backups_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that list backups endpoint exists."""
        # Test without auth
        response = await client.get("/api/v1/data-management/backups")
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_unit.py:39: AssertionError
___________ TestDataManagementUnit.test_restore_data_endpoint_exists ___________

self = <tests.test_data_management_unit.TestDataManagementUnit object at 0x7f59ad17dd00>
client = <httpx.AsyncClient object at 0x7f5963efe510>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXUTZFQzdUOU42SlE3REtZNE4xSCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ3NX0.o-NpEw66y3h_vzrZe486QclKOB8kHW6x5kGZ74cPe6Y'}

    @pytest.mark.unit
    async def test_restore_data_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that restore data endpoint exists."""
        # Test without auth
        response = await client.post("/api/v1/data-management/restore", json={})
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_unit.py:52: AssertionError
________ TestDataManagementUnit.test_get_storage_stats_endpoint_exists _________

self = <tests.test_data_management_unit.TestDataManagementUnit object at 0x7f59ad17e0c0>
client = <httpx.AsyncClient object at 0x7f5978f3cad0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXUUozMThRNFJUSk01QzZTVDhDWiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ3Nn0.7gTLTJeWiu2l_mMSEVbHZUkuX8iCZ7nJnnGNjNAL6E8'}

    @pytest.mark.unit
    async def test_get_storage_stats_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that get storage stats endpoint exists."""
        # Test without auth
        response = await client.get("/api/v1/data-management/stats")
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_unit.py:64: AssertionError
______ TestDataManagementUnit.test_bulk_delete_documents_endpoint_exists _______

self = <tests.test_data_management_unit.TestDataManagementUnit object at 0x7f59ad17e480>
client = <httpx.AsyncClient object at 0x7f597857e660>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXUVhaWjhWVDJSMjRZNFg5UzA1VyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ3Nn0.jlP0UqyWtyZT4RPJ2UySW-J43Z6VOPkaXFnF6bhEs_Q'}

    @pytest.mark.unit
    async def test_bulk_delete_documents_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that bulk delete documents endpoint exists."""
        # Test without auth
        response = await client.post("/api/v1/data-management/bulk/delete-documents", json={})
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_unit.py:77: AssertionError
____ TestDataManagementUnit.test_bulk_delete_conversations_endpoint_exists _____

self = <tests.test_data_management_unit.TestDataManagementUnit object at 0x7f59ad17e840>
client = <httpx.AsyncClient object at 0x7f597922a6c0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXUzdIR0FWTlFIM005V0pKNkg2MiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ3N30.Z4-zigq_2ejc5YM28OCbTRGCNP--To-2aekl8cI2dCU'}

    @pytest.mark.unit
    async def test_bulk_delete_conversations_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that bulk delete conversations endpoint exists."""
        # Test without auth
        response = await client.post("/api/v1/data-management/bulk/delete-conversations", json={})
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_unit.py:89: AssertionError
_______ TestDataManagementUnit.test_bulk_delete_prompts_endpoint_exists ________

self = <tests.test_data_management_unit.TestDataManagementUnit object at 0x7f59ad17d1c0>
client = <httpx.AsyncClient object at 0x7f5963b29880>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXU0pWUEE5VFpEOFRUOFpHM1Q0RiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ3OH0.6rmkxGFSw2T7dJhJoNTgJPqM6WF5AbSRZDy4B1rqshY'}

    @pytest.mark.unit
    async def test_bulk_delete_prompts_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that bulk delete prompts endpoint exists."""
        # Test without auth
        response = await client.post("/api/v1/data-management/bulk/delete-prompts", json={})
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

tests/test_data_management_unit.py:101: AssertionError
____________ TestDocumentsIntegration.test_document_upload_workflow ____________

self = <tests.test_documents_integration.TestDocumentsIntegration object at 0x7f59ad1a6ea0>
client = <httpx.AsyncClient object at 0x7f597a62cfe0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXVFdDQldXTlZHVlM0OE5RTUQ1UiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ3OX0.n2m2UIKnfmbiELZM-DJPc456hY3d4TBFhCA0xCu3Afw'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f5963cd99a0>

    @pytest.mark.integration
    async def test_document_upload_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complete document upload workflow."""
        # Create a test file
        test_content = b"This is a test document for testing purposes. It contains some text that can be chunked and processed."
        test_file = io.BytesIO(test_content)
    
        # Upload document
        files = {"file": ("test.txt", test_file, "text/plain")}
        data = {
            "title": "Test Document",
            "description": "A test document for integration testing",
            "tags": '["test", "integration"]',
            "chunk_size": 100,
            "chunk_overlap": 20,
            "is_public": False
        }
    
>       response = await client.post("/api/v1/documents/upload",
                                   headers=auth_headers, files=files, data=data)

tests/test_documents_integration.py:34: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2911' coro=<TestDocumentsIntegration.test_document_upload_workflow() running at /home/yam/chatter/tests/test_documents_integration.py:34> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_______ TestDocumentsIntegration.test_document_list_and_search_workflow ________

self = <tests.test_documents_integration.TestDocumentsIntegration object at 0x7f59ad1a71d0>
client = <httpx.AsyncClient object at 0x7f597a9eb710>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXVlFXNkVBQTZBSDQ4MjI0REVCNCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ4MH0.DL8qxVUBHq1KR2ezhWgca8EMahWqbGqa3pFttv3vVVk'}

    @pytest.mark.integration
    async def test_document_list_and_search_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test document listing and search workflow."""
        # Get initial document list
>       response = await client.get("/api/v1/documents", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_integration.py:63: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2925' coro=<TestDocumentsIntegration.test_document_list_and_search_workflow() running at /home/yam/chatter/tests/test_documents_integration.py:63> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________ TestDocumentsIntegration.test_document_crud_workflow _____________

self = <tests.test_documents_integration.TestDocumentsIntegration object at 0x7f59ad1a7590>
client = <httpx.AsyncClient object at 0x7f597aaa4a70>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXV0pSNTYwU0JYWDYySkMyTUtESCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ4MX0.VdtG157B3H1KegKFl-8GJ2IKMda8pnsdRqCz0NBgICk'}

    @pytest.mark.integration
    async def test_document_crud_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test document CRUD operations workflow."""
        # Since we might not have actual documents, test the endpoints respond appropriately
        test_document_id = "nonexistent-document-id"
    
        # Test GET document
>       response = await client.get(f"/api/v1/documents/{test_document_id}",
                                  headers=auth_headers)

tests/test_documents_integration.py:88: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2939' coro=<TestDocumentsIntegration.test_document_crud_workflow() running at /home/yam/chatter/tests/test_documents_integration.py:88> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestDocumentsIntegration.test_document_chunks_workflow ____________

self = <tests.test_documents_integration.TestDocumentsIntegration object at 0x7f59ad1a7950>
client = <httpx.AsyncClient object at 0x7f597c85a540>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXWERRSlhaU0VXQlo0UUZRMDIyWiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ4Mn0.sjLPUunYKChRpRGGx-yQGRM8FCornkKMzyOzVoH84cY'}

    @pytest.mark.integration
    async def test_document_chunks_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test document chunks retrieval workflow."""
        test_document_id = "nonexistent-document-id"
    
        # Test get document chunks
>       response = await client.get(f"/api/v1/documents/{test_document_id}/chunks",
                                  headers=auth_headers)

tests/test_documents_integration.py:109: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2953' coro=<TestDocumentsIntegration.test_document_chunks_workflow() running at /home/yam/chatter/tests/test_documents_integration.py:109> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
__________ TestDocumentsIntegration.test_document_processing_workflow __________

self = <tests.test_documents_integration.TestDocumentsIntegration object at 0x7f59ad1c0050>
client = <httpx.AsyncClient object at 0x7f597beabda0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lXWThZNlFFRTVTTlZDUkIxQVpHTSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ4M30.POCc51ad2_hScGGlo7A_3toZzkkgaWxeRPqhRBKESKc'}

    @pytest.mark.integration
    async def test_document_processing_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test document processing workflow."""
        test_document_id = "nonexistent-document-id"
    
        # Test process document
        process_data = {"force_reprocess": False}
>       response = await client.post(f"/api/v1/documents/{test_document_id}/process",
                                   headers=auth_headers, json=process_data)

tests/test_documents_integration.py:125: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2967' coro=<TestDocumentsIntegration.test_document_processing_workflow() running at /home/yam/chatter/tests/test_documents_integration.py:125> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestDocumentsIntegration.test_document_stats_workflow _____________

self = <tests.test_documents_integration.TestDocumentsIntegration object at 0x7f59ad1c0110>
client = <httpx.AsyncClient object at 0x7f5978e93fb0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYMDAxU1dZRzZFWjExVkVOREtDWCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ4NH0.FuSzp0WQpWTDSB6CTUW2dIY7-ULzh7JzA9pL-Gp51-E'}

    @pytest.mark.integration
    async def test_document_stats_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test document statistics workflow."""
        # Test get document stats
>       response = await client.get("/api/v1/documents/stats/overview",
                                  headers=auth_headers)

tests/test_documents_integration.py:138: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2981' coro=<TestDocumentsIntegration.test_document_stats_workflow() running at /home/yam/chatter/tests/test_documents_integration.py:138> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
___________ TestDocumentsIntegration.test_document_download_workflow ___________

self = <tests.test_documents_integration.TestDocumentsIntegration object at 0x7f59ad1c04d0>
client = <httpx.AsyncClient object at 0x7f59786327b0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYMFY1NFhNVlpLRjUzSEZQOE1IUCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ4NX0.8A488FZV0Y7j3CYGzHpcXPUI2sIXjWvyZd0urt6b3uo'}

    @pytest.mark.integration
    async def test_document_download_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test document download workflow."""
        test_document_id = "nonexistent-document-id"
    
        # Test download document
>       response = await client.get(f"/api/v1/documents/{test_document_id}/download",
                                  headers=auth_headers)

tests/test_documents_integration.py:156: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-2995' coro=<TestDocumentsIntegration.test_document_download_workflow() running at /home/yam/chatter/tests/test_documents_integration.py:156> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
__________ TestDocumentsIntegration.test_document_permission_workflow __________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5979295580>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5979295580>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_integration.TestDocumentsIntegration object at 0x7f59ad1c0890>
client = <httpx.AsyncClient object at 0x7f5979295520>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYMU5OTkU4WERKQjhXWkVXRkFYTSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ4Nn0.zabQBEHZkesgFc16Mh0d_wPyvPnESMfPbR2sO8sxGmo'}

    @pytest.mark.integration
    async def test_document_permission_workflow(self, client: AsyncClient, auth_headers: dict):
        """Test document permission and access control workflow."""
        # This test verifies that authenticated requests work and unauthenticated don't
    
        # Test without authentication
>       response = await client.get("/api/v1/documents")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_integration.py:166: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5979295580>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:51:26.527695Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m5ae564c0-f7fa-4cb2-83de-a6347fec3d35[0m [36mstatus_code[0m=[35m401[0m
____________ TestDocumentsUnit.test_upload_document_endpoint_exists ____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597b3ab410>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597b3ab410>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7f59ad1a7ce0>
client = <httpx.AsyncClient object at 0x7f597b3aafc0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYMjc3V0czN004WVA4MlExUERFWiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ4N30.HbGFvtnVmAPS4SYOL-i4O5G2eGYUnIMkQmYv-HNOmFc'}

    @pytest.mark.unit
    async def test_upload_document_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that upload document endpoint exists and validates authentication."""
        # Test with missing auth header - should get 401
>       response = await client.post("/api/v1/documents/upload")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:15: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597b3ab410>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:51:27.091288Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mfced3be5-54f3-46c1-b948-f51b56ef4b7f[0m [36mstatus_code[0m=[35m401[0m
____________ TestDocumentsUnit.test_list_documents_endpoint_exists _____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597b014bc0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597b014bc0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7f59ad1a7500>
client = <httpx.AsyncClient object at 0x7f597b017200>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYMlJSUlM2WVZWMTBNQ1ZHVkdaUCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ4N30.pMnd1lsZ70XKFftCZx0caYv9y-YieP3bNz46Vo5E6r8'}

    @pytest.mark.unit
    async def test_list_documents_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that list documents endpoint exists."""
        # Test without auth - should get 401
>       response = await client.get("/api/v1/documents")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:26: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597b014bc0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:51:27.651338Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m0679a978-de07-4a63-b82a-8ace50459d2c[0m [36mstatus_code[0m=[35m401[0m
___________ TestDocumentsUnit.test_search_documents_endpoint_exists ____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597b112ea0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597b112ea0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7f59ad1c1190>
client = <httpx.AsyncClient object at 0x7f597b111940>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYM0FBVko5UzJOMDZTTVcyRlQ4TiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ4OH0.IRNFsl0JTjUO4IqWRyQBy6U29NB1crvk83oCrvbGuWY'}

    @pytest.mark.unit
    async def test_search_documents_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that search documents endpoint exists."""
        # Test without auth
>       response = await client.post("/api/v1/documents/search", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:38: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597b112ea0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:51:28.213487Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mb96bb93b-2986-4ab9-b54d-9a2e64759ab0[0m [36mstatus_code[0m=[35m401[0m
_____________ TestDocumentsUnit.test_get_document_endpoint_exists ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597c9afe00>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597c9afe00>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7f59ad1c01d0>
client = <httpx.AsyncClient object at 0x7f597c9ae000>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYM1ZHNUIwVEYxSEYxNVlaNkhNVyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ4OH0.8d8p18KtQ93MkJVwYnBn3Co0AvAfdAAamGLaifMSlLo'}

    @pytest.mark.unit
    async def test_get_document_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that get document endpoint exists."""
        # Test without auth
>       response = await client.get("/api/v1/documents/nonexistent-id")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:50: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597c9afe00>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:51:28.762244Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35medb62598-0952-4565-80bc-7f679708ae49[0m [36mstatus_code[0m=[35m401[0m
____________ TestDocumentsUnit.test_delete_document_endpoint_exists ____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5983d06270>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5983d06270>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7f59ad1c16a0>
client = <httpx.AsyncClient object at 0x7f5983d07200>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYNEQyMUEwUE1RMDNaS1lGUkpWUiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ4OX0.mAMu8ng9lAkphlKDNsh9eqlATkArXSFtJTo6PWhq2cw'}

    @pytest.mark.unit
    async def test_delete_document_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that delete document endpoint exists."""
        # Test without auth
>       response = await client.delete("/api/v1/documents/nonexistent-id")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:62: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1966: in delete
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5983d06270>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:51:29.326579Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m3e1749b3-0bbe-40d8-ac7a-16b052c012f2[0m [36mstatus_code[0m=[35m401[0m
____________ TestDocumentsUnit.test_update_document_endpoint_exists ____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597858a6f0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597858a6f0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7f59ad1c1a60>
client = <httpx.AsyncClient object at 0x7f59838abc50>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYNFlQTkFaRjJUNjFRMDNRUzVTMSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ4OX0.DUMCEHSwnmDJc3xsVfjaLr0zZxbcoNhzomG5CrSvRB8'}

    @pytest.mark.unit
    async def test_update_document_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that update document endpoint exists."""
        # Test without auth
>       response = await client.put("/api/v1/documents/nonexistent-id", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1896: in put
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597858a6f0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:51:29.890251Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35md7adf559-5fe4-44bf-91ec-cd29a65b59f3[0m [36mstatus_code[0m=[35m401[0m
__________ TestDocumentsUnit.test_get_document_chunks_endpoint_exists __________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597a9a95e0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597a9a95e0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7f59ad1c1e20>
client = <httpx.AsyncClient object at 0x7f597a9a85f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYNUdIMTlHNlpKVjhIM1NUWTRDSiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ5MH0.6PttCU4dyWm12EDY76GPcE05NiWF1eorrNZ_gUkMd30'}

    @pytest.mark.unit
    async def test_get_document_chunks_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that get document chunks endpoint exists."""
        # Test without auth
>       response = await client.get("/api/v1/documents/nonexistent-id/chunks")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:86: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597a9a95e0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:51:30.458405Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m4f0cfc14-e053-42a4-a6a7-9473b433a674[0m [36mstatus_code[0m=[35m401[0m
___________ TestDocumentsUnit.test_process_document_endpoint_exists ____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597a865400>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597a865400>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7f59ad1c21e0>
client = <httpx.AsyncClient object at 0x7f597a864290>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYNjFXSDNZVkpYRUU0U0U4SFcwWSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ5MX0.9ksYckfN4OF03atG_BsJrgCkj2mA9L0RUTlZsXN-v4w'}

    @pytest.mark.unit
    async def test_process_document_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that process document endpoint exists."""
        # Test without auth
>       response = await client.post("/api/v1/documents/nonexistent-id/process", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:98: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597a865400>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:51:31.015901Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m8175bd2d-88f0-4a6f-91fe-c337f2a7d91f[0m [36mstatus_code[0m=[35m401[0m
__________ TestDocumentsUnit.test_get_document_stats_endpoint_exists ___________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597ad08d10>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597ad08d10>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7f59ad1c25a0>
client = <httpx.AsyncClient object at 0x7f597add7f20>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYNktOMFk4WTgxVDdSREtTNE1WNSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ5MX0.dSEeyGcbaXiNb1Pn0rJID3sS-iSkJe7AzyAOeAK9JkQ'}

    @pytest.mark.unit
    async def test_get_document_stats_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that get document stats endpoint exists."""
        # Test without auth
>       response = await client.get("/api/v1/documents/stats/overview")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:110: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597ad08d10>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:51:31.584040Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m4b23374e-a891-47fa-a33b-f4c24668f684[0m [36mstatus_code[0m=[35m401[0m
___________ TestDocumentsUnit.test_download_document_endpoint_exists ___________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5978848980>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5978848980>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_documents_unit.TestDocumentsUnit object at 0x7f59ad1c2960>
client = <httpx.AsyncClient object at 0x7f5978ea7b30>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYNzUyNlo4VkRTQUU3VDVSRFdHUCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ5Mn0.ihRMCfQ_vRMl8hYBMhuFd0eeiKn43k57aTPhcx1f3lc'}

    @pytest.mark.unit
    async def test_download_document_endpoint_exists(self, client: AsyncClient, auth_headers: dict):
        """Test that download document endpoint exists."""
        # Test without auth
>       response = await client.get("/api/v1/documents/nonexistent-id/download")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_documents_unit.py:123: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5978848980>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:51:32.142433Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m9ce99556-79b0-4009-ac54-1e3f5f3842cd[0m [36mstatus_code[0m=[35m401[0m
______________ TestEventsIntegration.test_events_stream_workflow _______________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7f59ad1c3470>
client = <httpx.AsyncClient object at 0x7f597bd672c0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYOE1RVjdQRjNURlNDWE1DQTlTRCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ5M30.WdeftnP9ghAcy9HF7_vg5fNc3OGC8b9eJqGBRHTNZsA'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f597ad09b20>

    @pytest.mark.integration
    async def test_events_stream_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complete events stream workflow."""
        # Test SSE stream connection
>       response = await client.get("/api/v1/events/stream", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_integration.py:18: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3163' coro=<TestEventsIntegration.test_events_stream_workflow() running at /home/yam/chatter/tests/test_events_integration.py:18> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________ TestEventsIntegration.test_events_stats_real_service _____________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7f59ad1c37a0>
client = <httpx.AsyncClient object at 0x7f597ab58140>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYOUZLSzMzQUJHMEsxNkM3SlRLQyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ5NH0.gXasSMrJdGgEv2TxCqGAFweMNKyaRQE-rA4WwQ4jKlU'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f597bdd3f50>

    @pytest.mark.integration
    async def test_events_stats_real_service(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test events stats with real SSE service."""
>       response = await client.get("/api/v1/events/stats", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_integration.py:29: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3177' coro=<TestEventsIntegration.test_events_stats_real_service() running at /home/yam/chatter/tests/test_events_integration.py:29> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_______________ TestEventsIntegration.test_test_event_end_to_end _______________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7f59ad1c3710>
client = <httpx.AsyncClient object at 0x7f597d925610>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYQUE5UTNaUkdaMzEwV1ZHSk5GNyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ5NX0.azPH6Q9RwaDM87HuI_QMUGdJcMKmqbejo1rU17K1aws'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f597978c950>

    @pytest.mark.integration
    async def test_test_event_end_to_end(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test sending test event end-to-end."""
        test_data = {
            "event_type": "integration.test",
            "data": {
                "message": "Integration test message",
                "test_id": "test-123",
                "timestamp": "2024-01-01T12:00:00Z"
            },
            "user_id": "integration-test-user"
        }
    
>       response = await client.post(
            "/api/v1/events/test-event",
            json=test_data,
            headers=auth_headers
        )

tests/test_events_integration.py:54: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3191' coro=<TestEventsIntegration.test_test_event_end_to_end() running at /home/yam/chatter/tests/test_events_integration.py:54> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________ TestEventsIntegration.test_broadcast_test_end_to_end _____________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7f59ad1c2cf0>
client = <httpx.AsyncClient object at 0x7f597b911100>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYQjRZNUtEUk5EQkdDQjEwSlM4WSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ5Nn0.J9KnpaoD5rj5hxbkUZtT-nwq1dH_C46rmckSg5bp_-o'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f597d089cd0>

    @pytest.mark.integration
    async def test_broadcast_test_end_to_end(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test broadcast test event end-to-end."""
        test_data = {
            "event_type": "integration.broadcast",
            "data": {
                "message": "Integration broadcast message",
                "test_id": "broadcast-123"
            }
        }
    
>       response = await client.post(
            "/api/v1/events/broadcast-test",
            json=test_data,
            headers=auth_headers
        )

tests/test_events_integration.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3205' coro=<TestEventsIntegration.test_broadcast_test_end_to_end() running at /home/yam/chatter/tests/test_events_integration.py:78> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________ TestEventsIntegration.test_multiple_sse_connections ______________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7f59ad1c1ee0>
client = <httpx.AsyncClient object at 0x7f597d70fef0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYQzA2N1FWOVE3Q0NGWlBUNjlaVyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ5N30.CsTraI28j517bdfTe6Tg8ZNoZiO5zbVu8fOpIGCv1lw'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f597d9e4200>

    @pytest.mark.integration
    async def test_multiple_sse_connections(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test multiple SSE connections from same user."""
        # Create multiple concurrent SSE connection attempts
        tasks = []
        for i in range(3):
            task = asyncio.create_task(
                client.get("/api/v1/events/stream", headers=auth_headers)
            )
            tasks.append(task)
    
        # Wait for all connections with timeout
        try:
>           responses = await asyncio.wait_for(asyncio.gather(*tasks), timeout=10.0)
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_integration.py:103: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib64/python3.12/asyncio/tasks.py:520: in wait_for
    return await fut
           ^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3220' coro=<AsyncClient.get() running at /home/yam/.local/lib/python3.12/site-packages/httpx/_client.py:1768> cb=[gather.<locals>._done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:767]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
___________ TestEventsIntegration.test_events_workflow_with_database ___________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7f59ad1c0080>
client = <httpx.AsyncClient object at 0x7f5963bba6f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYQ1ZDSllZMTZQWk1COVFCRDJNWCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ5N30.jpUopNlGPnk3ejPlU61Ysj5QxPN8L1hvPE-eHvVwLqI'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f597c728dd0>

    @pytest.mark.integration
    async def test_events_workflow_with_database(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test events workflow with database persistence."""
        # First, get initial stats
>       stats_response = await client.get("/api/v1/events/stats", headers=auth_headers)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_integration.py:120: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3236' coro=<TestEventsIntegration.test_events_workflow_with_database() running at /home/yam/chatter/tests/test_events_integration.py:120> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
___________ TestEventsIntegration.test_event_validation_integration ____________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7f59ad1d8110>
client = <httpx.AsyncClient object at 0x7f597bd36630>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYRFA4VlZIOE1OR1FXQUdQWEg3TSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ5OH0.xBoM2x28gxlPKQabf0jd29xDygRB1w-9ufwNvcTmGLo'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f597857f050>

    @pytest.mark.integration
    async def test_event_validation_integration(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test event data validation in integration environment."""
        # Test valid event types
        valid_event_types = [
            "user.login",
            "user.logout",
            "message.sent",
            "system.alert",
            "custom.event"
        ]
    
        for event_type in valid_event_types:
            test_data = {
                "event_type": event_type,
                "data": {"valid": True, "type": event_type},
                "user_id": "validation-test-user"
            }
    
>           response = await client.post(
                "/api/v1/events/test-event",
                json=test_data,
                headers=auth_headers
            )

tests/test_events_integration.py:169: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3250' coro=<TestEventsIntegration.test_event_validation_integration() running at /home/yam/chatter/tests/test_events_integration.py:169> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________ TestEventsIntegration.test_event_data_serialization ______________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7f59ad1d8200>
client = <httpx.AsyncClient object at 0x7f597923d4f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYRUtRU0o1TVcxUkVGWE1YRjdEUSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODQ5OX0.SkASyxHGkNDX158nQGwR1R7VnyAgYyokP1ZIkCGXYIc'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f597978a0c0>

    @pytest.mark.integration
    async def test_event_data_serialization(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complex event data serialization."""
        complex_data = {
            "event_type": "complex.data.test",
            "data": {
                "nested_object": {
                    "level1": {
                        "level2": {"value": 42}
                    }
                },
                "array_data": [1, 2, 3, "string", {"nested": True}],
                "unicode_text": "Hello 世界 🌍",
                "numbers": {
                    "integer": 123,
                    "float": 45.67,
                    "negative": -89
                },
                "boolean_values": {
                    "true_val": True,
                    "false_val": False
                },
                "null_value": None
            },
            "user_id": "serialization-test-user"
        }
    
>       response = await client.post(
            "/api/v1/events/test-event",
            json=complex_data,
            headers=auth_headers
        )

tests/test_events_integration.py:203: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3264' coro=<TestEventsIntegration.test_event_data_serialization() running at /home/yam/chatter/tests/test_events_integration.py:203> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestEventsIntegration.test_concurrent_event_operations ____________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7f59ad1d85c0>
client = <httpx.AsyncClient object at 0x7f59891d11f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYR0g5OTVSUTBFWjY2RzE5Qjc3SiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUwMX0.NztHd7iUSjMSnlAv5MpH-km76jh4POm63TgiDwpabRE'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f597b4cb410>

    @pytest.mark.integration
    async def test_concurrent_event_operations(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test concurrent event operations."""
        # Create concurrent tasks for different operations
        tasks = []
    
        # Add stats requests
        for i in range(2):
            task = asyncio.create_task(
                client.get("/api/v1/events/stats", headers=auth_headers)
            )
            tasks.append(task)
    
        # Add test events
        for i in range(3):
            test_data = {
                "event_type": f"concurrent.test.{i}",
                "data": {"concurrent_id": i, "test": "concurrent"},
                "user_id": f"concurrent-user-{i}"
            }
            task = asyncio.create_task(
                client.post("/api/v1/events/test-event", json=test_data, headers=auth_headers)
            )
            tasks.append(task)
    
        # Add broadcast tests
        for i in range(2):
            broadcast_data = {
                "event_type": f"concurrent.broadcast.{i}",
                "data": {"broadcast_id": i, "test": "concurrent"}
            }
            task = asyncio.create_task(
                client.post("/api/v1/events/broadcast-test", json=broadcast_data, headers=auth_headers)
            )
            tasks.append(task)
    
        # Wait for all operations to complete
>       responses = await asyncio.gather(*tasks)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_integration.py:251: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3279' coro=<AsyncClient.get() running at /home/yam/.local/lib/python3.12/site-packages/httpx/_client.py:1768> cb=[gather.<locals>._done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:767]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______________ TestEventsIntegration.test_sse_connection_cleanup _______________

self = <tests.test_events_integration.TestEventsIntegration object at 0x7f59ad1d8980>
client = <httpx.AsyncClient object at 0x7f597b9ba8a0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYSEVGMThIUTAxN0Q0UTNUSkIyUyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUwMn0.Q-hqOPuSGyrzGXg33Qm9COeaACumIN1LTWXRLVP9ELM'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f5978698bc0>

    @pytest.mark.integration
    async def test_sse_connection_cleanup(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test SSE connection cleanup behavior."""
        # Get initial connection count
>       stats_response = await client.get("/api/v1/events/stats", headers=auth_headers)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_integration.py:261: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3299' coro=<TestEventsIntegration.test_sse_connection_cleanup() running at /home/yam/chatter/tests/test_events_integration.py:261> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_______________ TestEventsUnit.test_events_stream_requires_auth ________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597812f8f0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597812f8f0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_events_unit.TestEventsUnit object at 0x7f59ad1c1430>
client = <httpx.AsyncClient object at 0x7f597812ed20>

    @pytest.mark.unit
    async def test_events_stream_requires_auth(self, client: AsyncClient):
        """Test that events stream requires authentication."""
>       response = await client.get("/api/v1/events/stream")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:18: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f597812f8f0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:51:43.333462Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m8f7bb7b2-75e8-4934-887c-3be70dcbe7ff[0m [36mstatus_code[0m=[35m401[0m
________________ TestEventsUnit.test_admin_stream_requires_auth ________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5979132330>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5979132330>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_events_unit.TestEventsUnit object at 0x7f59ad1d8d10>
client = <httpx.AsyncClient object at 0x7f59791316d0>

    @pytest.mark.unit
    async def test_admin_stream_requires_auth(self, client: AsyncClient):
        """Test that admin events stream requires authentication."""
>       response = await client.get("/api/v1/events/admin/stream")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:24: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5979132330>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:51:43.733747Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35ma6b53923-b538-4535-ae38-5f30c083a3fb[0m [36mstatus_code[0m=[35m401[0m
________________ TestEventsUnit.test_events_stats_requires_auth ________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5978c8d400>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5978c8d400>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_events_unit.TestEventsUnit object at 0x7f59ad1d88c0>
client = <httpx.AsyncClient object at 0x7f5978c8c770>

    @pytest.mark.unit
    async def test_events_stats_requires_auth(self, client: AsyncClient):
        """Test that events stats endpoint requires authentication."""
>       response = await client.get("/api/v1/events/stats")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:30: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5978c8d400>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:51:44.123361Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m78ac5b93-b6fa-41b3-964f-0743c0696552[0m [36mstatus_code[0m=[35m401[0m
_________________ TestEventsUnit.test_test_event_requires_auth _________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59639240b0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59639240b0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_events_unit.TestEventsUnit object at 0x7f59ad1da1b0>
client = <httpx.AsyncClient object at 0x7f596390f3e0>

    @pytest.mark.unit
    async def test_test_event_requires_auth(self, client: AsyncClient):
        """Test that test event endpoint requires authentication."""
>       response = await client.post("/api/v1/events/test-event")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:36: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59639240b0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:51:44.520338Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mb9ec8971-b415-42f1-9dbc-2715108ba5ef[0m [36mstatus_code[0m=[35m401[0m
_______________ TestEventsUnit.test_broadcast_test_requires_auth _______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5978ab6ba0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5978ab6ba0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_events_unit.TestEventsUnit object at 0x7f59ad1da570>
client = <httpx.AsyncClient object at 0x7f5978ab5eb0>

    @pytest.mark.unit
    async def test_broadcast_test_requires_auth(self, client: AsyncClient):
        """Test that broadcast test endpoint requires authentication."""
>       response = await client.post("/api/v1/events/broadcast-test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:42: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5978ab6ba0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:51:44.910325Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m4635507b-bed5-4a57-aa54-b4a437efe055[0m [36mstatus_code[0m=[35m401[0m
___________________ TestEventsUnit.test_events_stats_success ___________________

self = <tests.test_events_unit.TestEventsUnit object at 0x7f59ad1da930>
mock_sse_service = <MagicMock name='sse_service' id='140023043116976'>
client = <httpx.AsyncClient object at 0x7f5963194bf0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYTTVOVENRSzA4NDJSMDdCMVJORSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUwNX0.wrf2kodjMxQhsMGTPzsAJcQ0tvpZeTRzGNPkuEaA0y4'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_events_stats_success(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test events stats endpoint with mocked SSE service."""
        # Mock SSE service stats
        mock_sse_service.get_stats.return_value = {
            "active_connections": 5,
            "total_events_sent": 100,
            "events_per_second": 2.5,
            "connections_by_user": {
                "user1": 2,
                "user2": 3
            }
        }
    
>       response = await client.get("/api/v1/events/stats", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:60: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3378' coro=<TestEventsUnit.test_events_stats_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________________ TestEventsUnit.test_test_event_success ____________________

self = <tests.test_events_unit.TestEventsUnit object at 0x7f59ad1dad20>
mock_sse_service = <MagicMock name='sse_service' id='140022245274496'>
client = <httpx.AsyncClient object at 0x7f5978309ac0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYTjNXRjNQMVk5UlA2MVBUUU5IUCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUwNn0.kimi1JrjK-89IPWg6xAVUeROzuTvrqpOIv7l8B5mEmA'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_test_event_success(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test test event endpoint success."""
        mock_sse_service.broadcast_to_user.return_value = True
    
        test_data = {
            "event_type": "test.message",
            "data": {"message": "Hello World"},
            "user_id": "test-user-123"
        }
    
>       response = await client.post(
            "/api/v1/events/test-event",
            json=test_data,
            headers=auth_headers
        )

tests/test_events_unit.py:81: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3392' coro=<TestEventsUnit.test_test_event_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
__________________ TestEventsUnit.test_broadcast_test_success __________________

self = <tests.test_events_unit.TestEventsUnit object at 0x7f59ad1db0e0>
mock_sse_service = <MagicMock name='sse_service' id='140023047368544'>
client = <httpx.AsyncClient object at 0x7f596341bdd0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYTlpURFEyUVRXTjQ0WlpDN1MxTiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUwN30.xfu27YWKqflMTUfB_eHWGNa66nvUvZydYpP7RuYAVfA'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_broadcast_test_success(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test broadcast test endpoint success."""
        mock_sse_service.broadcast.return_value = True
    
        test_data = {
            "event_type": "broadcast.test",
            "data": {"message": "Broadcast message"}
        }
    
>       response = await client.post(
            "/api/v1/events/broadcast-test",
            json=test_data,
            headers=auth_headers
        )

tests/test_events_unit.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3406' coro=<TestEventsUnit.test_broadcast_test_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_________________ TestEventsUnit.test_test_event_invalid_data __________________

self = <tests.test_events_unit.TestEventsUnit object at 0x7f59ad1db4a0>
client = <httpx.AsyncClient object at 0x7f59a7bed250>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYUVpBUlg4UjM0UFJUWjRBQ1pFTiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUwOX0.eaxpVQSKGdEbI-4YSh8DkDoq_FYT20mv2NnzQ9-94iw'}

    @pytest.mark.unit
    async def test_test_event_invalid_data(self, client: AsyncClient, auth_headers: dict):
        """Test test event endpoint with invalid data."""
        # Missing required fields
        test_data = {
            "data": {"message": "Hello World"}
            # Missing event_type
        }
    
>       response = await client.post(
            "/api/v1/events/test-event",
            json=test_data,
            headers=auth_headers
        )

tests/test_events_unit.py:125: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3420' coro=<TestEventsUnit.test_test_event_invalid_data() running at /home/yam/chatter/tests/test_events_unit.py:125> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_______________ TestEventsUnit.test_broadcast_test_invalid_data ________________

self = <tests.test_events_unit.TestEventsUnit object at 0x7f59ad1db860>
client = <httpx.AsyncClient object at 0x7f5963d36a80>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYUldGWTVCOUFYSkM2WkpSR1EySyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUxMH0.AkUyOGU1-VgT96-P3IC9qcZ2pEgm3ORmdg625sb8q2I'}

    @pytest.mark.unit
    async def test_broadcast_test_invalid_data(self, client: AsyncClient, auth_headers: dict):
        """Test broadcast test endpoint with invalid data."""
        # Missing required fields
        test_data = {
            "data": {"message": "Broadcast message"}
            # Missing event_type
        }
    
>       response = await client.post(
            "/api/v1/events/broadcast-test",
            json=test_data,
            headers=auth_headers
        )

tests/test_events_unit.py:141: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3434' coro=<TestEventsUnit.test_broadcast_test_invalid_data() running at /home/yam/chatter/tests/test_events_unit.py:141> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_________________ TestEventsUnit.test_events_stream_rate_limit _________________

self = <tests.test_events_unit.TestEventsUnit object at 0x7f59ad1dbc20>
mock_get_rate_limiter = <MagicMock name='get_unified_rate_limiter' id='140022258956000'>
client = <httpx.AsyncClient object at 0x7f59790164b0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYU1NTUU5YWldKMk5OMk05NDhEUSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUxMX0.6DROLSwFIsfYoJIESyHEKgKZLpvWpjjCC-nBftzXmSE'}

    @pytest.mark.unit
    @patch('chatter.api.events.get_unified_rate_limiter')
    async def test_events_stream_rate_limit(self, mock_get_rate_limiter, client: AsyncClient, auth_headers: dict):
        """Test events stream rate limiting."""
        from chatter.utils.unified_rate_limiter import RateLimitExceeded
    
        # Mock rate limiter to raise exception
        mock_rate_limiter = AsyncMock()
>       mock_rate_limiter.check_rate_limit.side_effect = RateLimitExceeded(
            key="test_key",
            limit=50,
            window=3600,
            current_count=51
        )
E       TypeError: RateLimitExceeded.__init__() got an unexpected keyword argument 'key'

tests/test_events_unit.py:156: TypeError
______________ TestEventsUnit.test_events_stream_connection_limit ______________

self = <tests.test_events_unit.TestEventsUnit object at 0x7f59ad0042f0>
mock_sse_service = <MagicMock name='sse_service' id='140021905951920'>
client = <httpx.AsyncClient object at 0x7f5963f73e90>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYVDVOQjlOV1A5R0M5VFpKRTFXWiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUxMX0.S6eWC1Hq5IzRx6-sQShhI_85syGz08jOE__NHoAJE7o'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_events_stream_connection_limit(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test events stream connection limit."""
        # Mock SSE service to raise connection limit error
        mock_sse_service.create_connection.side_effect = ValueError("Too many connections")
    
>       response = await client.get("/api/v1/events/stream", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:174: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3462' coro=<TestEventsUnit.test_events_stream_connection_limit() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestEventsUnit.test_events_stream_connection_not_found ____________

self = <tests.test_events_unit.TestEventsUnit object at 0x7f59ad0043e0>
mock_sse_service = <MagicMock name='sse_service' id='140021897113008'>
client = <httpx.AsyncClient object at 0x7f59637019a0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYVFpRRE5GNjhORVhDSlBOODA3TSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUxMn0.b7Ybm4qgf7xJH_jYL0n8mab6Sf_AO1ofLb5qjXtzK2g'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_events_stream_connection_not_found(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test events stream when connection cannot be retrieved."""
        # Mock SSE service to return connection ID but fail on get_connection
        mock_sse_service.create_connection.return_value = "connection-123"
        mock_sse_service.get_connection.return_value = None
    
>       response = await client.get("/api/v1/events/stream", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:185: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3476' coro=<TestEventsUnit.test_events_stream_connection_not_found() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_______________ TestEventsUnit.test_admin_stream_requires_admin ________________

self = <tests.test_events_unit.TestEventsUnit object at 0x7f59ad0047a0>
mock_sse_service = <MagicMock name='sse_service' id='140023046231616'>
client = <httpx.AsyncClient object at 0x7f59a7ee4170>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYVlZGWTJCUkRTSDBEVjNQNjVWWSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUxM30.-dUChPNqCRYuJw_70lRIhpvyi6aZ_WgisepjibiafjE'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_admin_stream_requires_admin(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test that admin stream requires admin privileges."""
        # Regular user should get forbidden
>       response = await client.get("/api/v1/events/admin/stream", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:196: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3490' coro=<TestEventsUnit.test_admin_stream_requires_admin() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______________ TestEventsUnit.test_events_stats_sse_service_error ______________

self = <tests.test_events_unit.TestEventsUnit object at 0x7f59ad004b60>
mock_sse_service = <MagicMock name='sse_service' id='140022262492496'>
client = <httpx.AsyncClient object at 0x7f59793749e0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYWFE4N0JSVlpIUkdYM0gyRDU3WiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUxNX0.eTWm8Fd5xLwHhV5wgmIARjK8VNt6rDHUqG8iwqsLBws'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_events_stats_sse_service_error(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test events stats when SSE service has an error."""
        mock_sse_service.get_stats.side_effect = Exception("SSE service error")
    
>       response = await client.get("/api/v1/events/stats", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_events_unit.py:205: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3504' coro=<TestEventsUnit.test_events_stats_sse_service_error() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_______________ TestEventsUnit.test_test_event_sse_service_error _______________

self = <tests.test_events_unit.TestEventsUnit object at 0x7f59ad1dbd10>
mock_sse_service = <MagicMock name='sse_service' id='140021866765664'>
client = <httpx.AsyncClient object at 0x7f5961a10830>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYWVJNNDRLWDNOU1hYSEI5RjBFTiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUxNn0.tiCqOMJEsjzQNGvd3Vvgau_hUnb8reNi2S4_97gP8CY'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_test_event_sse_service_error(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test test event when SSE service has an error."""
        mock_sse_service.broadcast_to_user.side_effect = Exception("SSE service error")
    
        test_data = {
            "event_type": "test.message",
            "data": {"message": "Hello World"},
            "user_id": "test-user-123"
        }
    
>       response = await client.post(
            "/api/v1/events/test-event",
            json=test_data,
            headers=auth_headers
        )

tests/test_events_unit.py:220: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3518' coro=<TestEventsUnit.test_test_event_sse_service_error() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________ TestEventsUnit.test_broadcast_test_sse_service_error _____________

self = <tests.test_events_unit.TestEventsUnit object at 0x7f59ad1db230>
mock_sse_service = <MagicMock name='sse_service' id='140021868345536'>
client = <httpx.AsyncClient object at 0x7f5961b92540>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lYWlJYM1JDVE5BWkdFR0E2TkQ1TiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUxN30.lCBxfsIc_3bRIXEfqtmZJgUmLZIrjgTemFTIPqm1H1o'}

    @pytest.mark.unit
    @patch('chatter.api.events.sse_service')
    async def test_broadcast_test_sse_service_error(self, mock_sse_service, client: AsyncClient, auth_headers: dict):
        """Test broadcast test when SSE service has an error."""
        mock_sse_service.broadcast.side_effect = Exception("SSE service error")
    
        test_data = {
            "event_type": "broadcast.test",
            "data": {"message": "Broadcast message"}
        }
    
>       response = await client.post(
            "/api/v1/events/broadcast-test",
            json=test_data,
            headers=auth_headers
        )

tests/test_events_unit.py:238: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3532' coro=<TestEventsUnit.test_broadcast_test_sse_service_error() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
___________ TestHealthIntegration.test_readiness_check_with_database ___________

self = <tests.test_health_integration.TestHealthIntegration object at 0x7f59ad0040e0>
client = <httpx.AsyncClient object at 0x7f5961307fb0>
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f5961b26840>

    @pytest.mark.integration
    async def test_readiness_check_with_database(self, client: AsyncClient, db_session: AsyncSession):
        """Test readiness check endpoint with real database connection."""
        response = await client.get("/readyz")
    
        # Should return 200 when database is available
>       assert response.status_code == 200
E       assert 503 == 200
E        +  where 503 = <Response [503 Service Unavailable]>.status_code

tests/test_health_integration.py:19: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:376 Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x7f5961a7e3f0>>
Traceback (most recent call last):
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py", line 1504, in close
    await self._protocol.close(timeout)
  File "asyncpg/protocol/protocol.pyx", line 628, in close
RuntimeError: Task <Task pending name='Task-3546' coro=<Connection.close() running at /home/yam/.local/lib/python3.12/site-packages/asyncpg/connection.py:1504> cb=[shield.<locals>._inner_done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:905]> got Future <Future pending> attached to a different loop
---------------------------- Captured log teardown -----------------------------
ERROR    asyncio:base_events.py:1833 Future exception was never retrieved
future: <Future finished exception=InternalClientError('got result for unknown protocol state 3')>
Traceback (most recent call last):
  File "asyncpg/protocol/protocol.pyx", line 903, in asyncpg.protocol.protocol.BaseProtocol._dispatch_result
asyncpg.exceptions._base.InternalClientError: got result for unknown protocol state 3
_________ TestHealthUnit.test_metrics_endpoint_with_monitoring_success _________

self = <tests.test_health_unit.TestHealthUnit object at 0x7f59ad00c140>
mock_get_monitoring = <AsyncMock name='get_monitoring_service' id='140021855908016'>
client = <httpx.AsyncClient object at 0x7f5960a238f0>

    @pytest.mark.unit
    @patch('chatter.core.monitoring.get_monitoring_service')
    async def test_metrics_endpoint_with_monitoring_success(self, mock_get_monitoring, client: AsyncClient):
        """Test metrics endpoint when monitoring service is available."""
        # Mock the monitoring service
        mock_service = AsyncMock()
        mock_service.get_system_health.return_value = {
            "status": "healthy",
            "checks_available": True,
            "cpu_usage": 15.2,
            "memory_usage": 45.8
        }
        mock_service.stats_by_endpoint = {
            "/healthz": {"requests": 100, "avg_response_time": 10.5},
            "/readyz": {"requests": 50, "avg_response_time": 25.3}
        }
        # Make get_monitoring_service async and return the mock service
        async def return_mock_service(*args, **kwargs):
            return mock_service
        mock_get_monitoring.side_effect = return_mock_service
    
        response = await client.get("/metrics")
        assert response.status_code == 200
    
        data = response.json()
>       assert data["health"]["status"] == "healthy"
E       AssertionError: assert 'unknown' == 'healthy'
E         
E         - healthy
E         + unknown

tests/test_health_unit.py:110: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  chatter.api.health:health.py:157 [2m2025-09-05T12:52:01.477636Z[0m [[33m[1mwarning  [0m] [1mFailed to get endpoint stats: 'coroutine' object is not iterable[0m [[34m[1mchatter.api.health[0m]
________ TestHealthUnit.test_correlation_trace_with_monitoring_success _________

self = <tests.test_health_unit.TestHealthUnit object at 0x7f59ad00c5f0>
mock_get_monitoring = <AsyncMock name='get_monitoring_service' id='140021848682288'>
client = <httpx.AsyncClient object at 0x7f595fd769c0>

    @pytest.mark.unit
    @patch('chatter.core.monitoring.get_monitoring_service')
    async def test_correlation_trace_with_monitoring_success(self, mock_get_monitoring, client: AsyncClient):
        """Test correlation trace endpoint when monitoring service is available."""
        correlation_id = "test-correlation-123"
        mock_requests = [
            {"timestamp": "2024-01-01T12:00:00Z", "method": "GET", "path": "/healthz"},
            {"timestamp": "2024-01-01T12:00:01Z", "method": "GET", "path": "/readyz"}
        ]
    
        mock_service = AsyncMock()
        mock_service.get_correlation_trace.return_value = mock_requests
        mock_get_monitoring.return_value = mock_service
    
        response = await client.get(f"/trace/{correlation_id}")
>       assert response.status_code == 200
E       assert 500 == 200
E        +  where 500 = <Response [500 Internal Server Error]>.status_code

tests/test_health_unit.py:146: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    chatter.api.health:health.py:223 [2m2025-09-05T12:52:01.964127Z[0m [[31m[1merror    [0m] [1mFailed to get correlation trace for test-correlation-123: object of type 'coroutine' has no len()[0m [[34m[1mchatter.api.health[0m]
_________ TestHealthUnit.test_correlation_trace_with_monitoring_error __________

self = <tests.test_health_unit.TestHealthUnit object at 0x7f59ad00c9b0>
mock_get_monitoring = <AsyncMock name='get_monitoring_service' id='140021833309584'>
client = <httpx.AsyncClient object at 0x7f595fa29f40>

    @pytest.mark.unit
    @patch('chatter.core.monitoring.get_monitoring_service')
    async def test_correlation_trace_with_monitoring_error(self, mock_get_monitoring, client: AsyncClient):
        """Test correlation trace endpoint when monitoring service raises an exception."""
        correlation_id = "test-correlation-123"
        mock_get_monitoring.side_effect = Exception("Monitoring service error")
    
        response = await client.get(f"/trace/{correlation_id}")
        assert response.status_code == 500  # Internal server error
    
        data = response.json()
        # InternalServerProblem sets type_suffix="internal-server-error"
>       assert "internal-server-error" in data["type"]
                                          ^^^^^^^^^^^^
E       KeyError: 'type'

tests/test_health_unit.py:165: KeyError
------------------------------ Captured log call -------------------------------
ERROR    chatter.api.health:health.py:223 [2m2025-09-05T12:52:02.164239Z[0m [[31m[1merror    [0m] [1mFailed to get correlation trace for test-correlation-123: Monitoring service error[0m [[34m[1mchatter.api.health[0m]
_______________ TestJobsIntegration.test_job_complete_lifecycle ________________

self = <tests.test_jobs_integration.TestJobsIntegration object at 0x7f59ad028590>
client = <httpx.AsyncClient object at 0x7f595d8aa5a0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZOTY4Ulk2Qkg4R1BHODdZRkZTUCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUyNn0.pNFNShVP7KLCbIs0grwWtXoTZ5c5FuYl2hnJLDbQzxw'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f595d607710>

    @pytest.mark.integration
    async def test_job_complete_lifecycle(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complete job lifecycle from creation to completion."""
        # Create a job
        job_data = {
            "name": "Integration Test Job",
            "function_name": "test_function",
            "args": ["test_arg"],
            "kwargs": {"test_key": "test_value"},
            "priority": "normal"
        }
    
>       create_response = await client.post("/api/v1/jobs/", json=job_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_integration.py:24: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3948' coro=<TestJobsIntegration.test_job_complete_lifecycle() running at /home/yam/chatter/tests/test_jobs_integration.py:24> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______________ TestJobsIntegration.test_job_listing_and_filtering ______________

self = <tests.test_jobs_integration.TestJobsIntegration object at 0x7f59ad0288c0>
client = <httpx.AsyncClient object at 0x7f595f3491c0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZQTE5NUQ3NUNSUkIyRTcyWVRKRCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUyN30.PMWduNxP6OSFAt0qU-NwTvy_s66J-Nh501sz6Dn223s'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f595d85c4a0>

    @pytest.mark.integration
    async def test_job_listing_and_filtering(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test job listing and filtering functionality."""
        # Create multiple jobs with different statuses
        job_names = ["Job 1", "Job 2", "Job 3"]
        created_jobs = []
    
        for name in job_names:
            job_data = {
                "name": name,
                "function_name": "test_function",
                "args": [],
                "kwargs": {},
                "priority": "normal"
            }
    
>           response = await client.post("/api/v1/jobs/", json=job_data, headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_integration.py:64: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3962' coro=<TestJobsIntegration.test_job_listing_and_filtering() running at /home/yam/chatter/tests/test_jobs_integration.py:64> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______________ TestJobsIntegration.test_job_cancellation_workflow ______________

self = <tests.test_jobs_integration.TestJobsIntegration object at 0x7f59ad028cb0>
client = <httpx.AsyncClient object at 0x7f595f66d700>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZQVc1REUzQVBYME5aNlZIOFJBRCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUyOH0.GexKWUkF_SE0GQNg19ySQi8M08g2J_nwcSPY8UyxzFA'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f595f3639e0>

    @pytest.mark.integration
    async def test_job_cancellation_workflow(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test job cancellation workflow."""
        # Create a job
        job_data = {
            "name": "Cancellation Test Job",
            "function_name": "slow_test_function",  # Hypothetical slow function
            "args": [],
            "kwargs": {},
            "priority": "low"
        }
    
>       create_response = await client.post("/api/v1/jobs/", json=job_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_integration.py:103: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3976' coro=<TestJobsIntegration.test_job_cancellation_workflow() running at /home/yam/chatter/tests/test_jobs_integration.py:103> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_________________ TestJobsIntegration.test_job_error_scenarios _________________

self = <tests.test_jobs_integration.TestJobsIntegration object at 0x7f59ad029070>
client = <httpx.AsyncClient object at 0x7f595f850590>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZQlBTQVZFUTg0RVJHUTBUVFdYUyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUyOX0.5vrgsmgddciwZCymxReKEzFfrz1fTAU_OY0F2peaLQs'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f595f516fc0>

    @pytest.mark.integration
    async def test_job_error_scenarios(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test job error handling scenarios."""
        # Test non-existent job operations
        nonexistent_id = "550e8400-e29b-41d4-a716-446655440000"
    
        # Get non-existent job
>       get_response = await client.get(f"/api/v1/jobs/{nonexistent_id}", headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_integration.py:127: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-3990' coro=<TestJobsIntegration.test_job_error_scenarios() running at /home/yam/chatter/tests/test_jobs_integration.py:127> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______________ TestJobsIntegration.test_job_validation_scenarios _______________

self = <tests.test_jobs_integration.TestJobsIntegration object at 0x7f59ad029430>
client = <httpx.AsyncClient object at 0x7f595fdb8da0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZQ0ozWFZFRTFITjRHTkFRQ0dBViIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUzMH0.2Nu2aaxlkIISCQd-V0KaM7sb6T1F4vvFsGIAqZXso2c'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f595f8aab10>

    @pytest.mark.integration
    async def test_job_validation_scenarios(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test job creation validation scenarios."""
        # Test invalid function name
        invalid_function_data = {
            "name": "Invalid Function Job",
            "function_name": "nonexistent_function_12345",
            "args": [],
            "kwargs": {}
        }
    
>       response = await client.post("/api/v1/jobs/", json=invalid_function_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_integration.py:156: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4004' coro=<TestJobsIntegration.test_job_validation_scenarios() running at /home/yam/chatter/tests/test_jobs_integration.py:156> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_________________ TestJobsIntegration.test_job_stats_accuracy __________________

self = <tests.test_jobs_integration.TestJobsIntegration object at 0x7f59ad0297f0>
client = <httpx.AsyncClient object at 0x7f595ff0e000>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZRERFMldCUjZITkdDNFEwWUUxWSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUzMX0.8xibvAxUIUD9DM6uWJLhdmQRzbUeHhLy6ky_TJfDfxI'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f595fa08e30>

    @pytest.mark.integration
    async def test_job_stats_accuracy(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test job statistics accuracy."""
        # Get initial stats
>       initial_response = await client.get("/api/v1/jobs/stats/overview", headers=auth_headers)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_integration.py:184: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4018' coro=<TestJobsIntegration.test_job_stats_accuracy() running at /home/yam/chatter/tests/test_jobs_integration.py:184> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______________ TestJobsIntegration.test_job_cleanup_functionality ______________

self = <tests.test_jobs_integration.TestJobsIntegration object at 0x7f59ad029bb0>
client = <httpx.AsyncClient object at 0x7f5960b23b30>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZRThCSEdBU1NFSEM1WUM1VkdKVCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUzMn0.scX_3VUt5mN2Y1YSlU6KTbzouOgWexP1xFd7K11dIzg'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59609b8cb0>

    @pytest.mark.integration
    async def test_job_cleanup_functionality(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test job cleanup functionality."""
        # Get initial stats
>       initial_response = await client.get("/api/v1/jobs/stats/overview", headers=auth_headers)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_integration.py:226: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4032' coro=<TestJobsIntegration.test_job_cleanup_functionality() running at /home/yam/chatter/tests/test_jobs_integration.py:226> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______________ TestJobsIntegration.test_concurrent_job_operations ______________

self = <tests.test_jobs_integration.TestJobsIntegration object at 0x7f59ad029f70>
client = <httpx.AsyncClient object at 0x7f5960f77710>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZRjNLMUFGUEo0Mk1XWkU1M0ExWSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUzM30.aA7GgsBH68J4XEsnX2pZAl9umali0zGEmg1AhHZmkRM'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f5960c093a0>

    @pytest.mark.integration
    async def test_concurrent_job_operations(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test concurrent job operations."""
        # Create multiple jobs concurrently
        job_data_list = [
            {
                "name": f"Concurrent Job {i}",
                "function_name": "test_function",
                "args": [i],
                "kwargs": {"concurrent": True}
            }
            for i in range(5)
        ]
    
        # Create tasks for concurrent job creation
        create_tasks = [
            asyncio.create_task(client.post("/api/v1/jobs/", json=job_data, headers=auth_headers))
            for job_data in job_data_list
        ]
    
        # Wait for all creations
>       create_responses = await asyncio.gather(*create_tasks)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_integration.py:276: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4047' coro=<AsyncClient.post() running at /home/yam/.local/lib/python3.12/site-packages/httpx/_client.py:1859> cb=[gather.<locals>._done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:767]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
________________ TestJobsIntegration.test_job_data_persistence _________________

self = <tests.test_jobs_integration.TestJobsIntegration object at 0x7f59ad02a330>
client = <httpx.AsyncClient object at 0x7f5962e33d40>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZRllUUTVGNTZWWk1FNDdIQ0JaNSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUzM30.NS80NSfm14aEV7beEH17tsFB1RK9RQ4cT9GHD_fCJ5U'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59799478f0>

    @pytest.mark.integration
    async def test_job_data_persistence(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test job data persistence and retrieval accuracy."""
        # Create job with complex data
        complex_job_data = {
            "name": "Complex Data Job",
            "function_name": "test_function",
            "args": [
                "string_arg",
                42,
                3.14,
                True,
                ["nested", "array"],
                {"nested": "object", "number": 123}
            ],
            "kwargs": {
                "string_param": "test_string",
                "number_param": 456,
                "float_param": 78.9,
                "boolean_param": False,
                "array_param": [1, 2, 3],
                "object_param": {
                    "nested_string": "nested_value",
                    "nested_number": 789
                }
            },
            "priority": "high"
        }
    
        # Create job
>       create_response = await client.post("/api/v1/jobs/", json=complex_job_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_integration.py:336: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4065' coro=<TestJobsIntegration.test_job_data_persistence() running at /home/yam/chatter/tests/test_jobs_integration.py:336> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
__________________ TestJobsUnit.test_create_job_requires_auth __________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5961295130>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5961295130>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad02b1a0>
client = <httpx.AsyncClient object at 0x7f5962e47920>

    @pytest.mark.unit
    async def test_create_job_requires_auth(self, client: AsyncClient):
        """Test that creating job requires authentication."""
        job_data = {
            "name": "Test Job",
            "function_name": "test_function",
            "args": [],
            "kwargs": {}
        }
    
>       response = await client.post("/api/v1/jobs/", json=job_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:23: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5961295130>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:52:15.787789Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mef0c5c1d-2d12-4ee3-958e-dc8ba066cf43[0m [36mstatus_code[0m=[35m401[0m
__________________ TestJobsUnit.test_list_jobs_requires_auth ___________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5962737f50>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5962737f50>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad02b4a0>
client = <httpx.AsyncClient object at 0x7f5962736f30>

    @pytest.mark.unit
    async def test_list_jobs_requires_auth(self, client: AsyncClient):
        """Test that listing jobs requires authentication."""
>       response = await client.get("/api/v1/jobs/")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:29: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5962737f50>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:52:16.177464Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m6abee54a-fbfa-4f66-b5bc-383063dff2bb[0m [36mstatus_code[0m=[35m401[0m
___________________ TestJobsUnit.test_get_job_requires_auth ____________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a7a6b740>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a7a6b740>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad02b8c0>
client = <httpx.AsyncClient object at 0x7f59a7a69af0>

    @pytest.mark.unit
    async def test_get_job_requires_auth(self, client: AsyncClient):
        """Test that getting specific job requires authentication."""
        job_id = "550e8400-e29b-41d4-a716-446655440000"
>       response = await client.get(f"/api/v1/jobs/{job_id}")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:36: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59a7a6b740>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:52:16.553868Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mfa0bc264-52aa-4790-ada4-cd00d4d8e985[0m [36mstatus_code[0m=[35m401[0m
__________________ TestJobsUnit.test_cancel_job_requires_auth __________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59622bf950>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59622bf950>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad02bc80>
client = <httpx.AsyncClient object at 0x7f59622be7e0>

    @pytest.mark.unit
    async def test_cancel_job_requires_auth(self, client: AsyncClient):
        """Test that canceling job requires authentication."""
        job_id = "550e8400-e29b-41d4-a716-446655440000"
>       response = await client.post(f"/api/v1/jobs/{job_id}/cancel")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:43: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59622bf950>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:52:16.947054Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mbea3c0a7-bfc7-431b-82e8-6b6f33da8e6b[0m [36mstatus_code[0m=[35m401[0m
________________ TestJobsUnit.test_get_job_stats_requires_auth _________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59610486e0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59610486e0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad044080>
client = <httpx.AsyncClient object at 0x7f5960d1f140>

    @pytest.mark.unit
    async def test_get_job_stats_requires_auth(self, client: AsyncClient):
        """Test that getting job stats requires authentication."""
>       response = await client.get("/api/v1/jobs/stats/overview")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:49: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59610486e0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:52:17.331269Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m6085068e-6519-4379-8eaa-b20ce9b2de27[0m [36mstatus_code[0m=[35m401[0m
_________________ TestJobsUnit.test_cleanup_jobs_requires_auth _________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5962b51e80>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5962b51e80>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad044440>
client = <httpx.AsyncClient object at 0x7f5962b51280>

    @pytest.mark.unit
    async def test_cleanup_jobs_requires_auth(self, client: AsyncClient):
        """Test that cleanup jobs requires authentication."""
>       response = await client.post("/api/v1/jobs/cleanup")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:55: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5962b51e80>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:52:17.719304Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m80936ef5-18c0-4bd9-b5d4-4d69bcf6f87d[0m [36mstatus_code[0m=[35m401[0m
_____________________ TestJobsUnit.test_create_job_success _____________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad02bd70>
mock_job_queue = <MagicMock name='job_queue' id='140022382137744'>
client = <httpx.AsyncClient object at 0x7f59609a60f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZTTc5VkNSSEFWREEyVllBNjZGQyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUzOH0._--RSnR5Swa2cgdiIsyKTidGmPN0pmIP_z1UDzAV5ZY'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_create_job_success(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test successful job creation."""
        # Mock job queue
        mock_job = MagicMock()
        mock_job.id = "job-123"
        mock_job.name = "Test Job"
        mock_job.function_name = "test_function"
        mock_job.status = JobStatus.PENDING
        mock_job.priority = JobPriority.NORMAL
        mock_job.created_at = "2024-01-01T12:00:00Z"
        mock_job.created_by = "testuser"
    
        mock_job_queue.has_handler.return_value = True
        mock_job_queue.submit.return_value = mock_job
    
        job_data = {
            "name": "Test Job",
            "function_name": "test_function",
            "args": ["arg1", "arg2"],
            "kwargs": {"key1": "value1"},
            "priority": "normal"
        }
    
>       response = await client.post("/api/v1/jobs/", json=job_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:83: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4157' coro=<TestJobsUnit.test_create_job_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
________________ TestJobsUnit.test_create_job_invalid_function _________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad02bc50>
mock_job_queue = <MagicMock name='job_queue' id='140021888683136'>
client = <httpx.AsyncClient object at 0x7f5962ef87d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZTjJDUThWV0U2UjZENzUyUE5GQyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODUzOX0.aFJ_hRgDElib6CfaDCPSI9ICDMaQEzU5LV2n3T3i8T8'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_create_job_invalid_function(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test job creation with invalid function name."""
        mock_job_queue.has_handler.return_value = False
    
        job_data = {
            "name": "Test Job",
            "function_name": "nonexistent_function",
            "args": [],
            "kwargs": {}
        }
    
>       response = await client.post("/api/v1/jobs/", json=job_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4171' coro=<TestJobsUnit.test_create_job_invalid_function() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
__________________ TestJobsUnit.test_create_job_invalid_data ___________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad044b60>
client = <httpx.AsyncClient object at 0x7f5961119a60>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZTlg3MTVLRVYxQUtRMDg4MVlIRCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODU0MH0.IkJe9qGhe07h7K-wTljiDKjiVxL-HIqKYEiIUOASyj4'}

    @pytest.mark.unit
    async def test_create_job_invalid_data(self, client: AsyncClient, auth_headers: dict):
        """Test job creation with invalid data."""
        # Missing required fields
        job_data = {
            "name": "Test Job"
            # Missing function_name
        }
    
>       response = await client.post("/api/v1/jobs/", json=job_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:116: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4185' coro=<TestJobsUnit.test_create_job_invalid_data() running at /home/yam/chatter/tests/test_jobs_unit.py:116> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________________ TestJobsUnit.test_list_jobs_success ______________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad044cb0>
mock_job_queue = <MagicMock name='job_queue' id='140021901074864'>
client = <httpx.AsyncClient object at 0x7f5963ac8e30>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZUFJOOThURFM3M1YzMFZITURSMSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODU0MH0.CtFSFGEyrA6nOLf4m4M6u8OSh-gQmg0ITmWqGt85EzM'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_list_jobs_success(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test successful job listing."""
        mock_jobs = [
            {
                "id": "job-1",
                "name": "Job 1",
                "status": "completed",
                "created_at": "2024-01-01T12:00:00Z"
            },
            {
                "id": "job-2",
                "name": "Job 2",
                "status": "pending",
                "created_at": "2024-01-01T13:00:00Z"
            }
        ]
    
        mock_job_queue.list_jobs.return_value = {
            "jobs": mock_jobs,
            "total": 2,
            "page": 1,
            "per_page": 10
        }
    
>       response = await client.get("/api/v1/jobs/", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:145: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4199' coro=<TestJobsUnit.test_list_jobs_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
___________________ TestJobsUnit.test_list_jobs_with_filters ___________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad045070>
mock_job_queue = <MagicMock name='job_queue' id='140022275029232'>
client = <httpx.AsyncClient object at 0x7f5979f6a660>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZUUs4WFE1WldXQTdLV01WRU5UTiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODU0MX0.hgeKiHsDVE6cejZEtEbp1aUSqJ4frKeWinrFpdd_WO8'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_list_jobs_with_filters(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test job listing with filters."""
        mock_job_queue.list_jobs.return_value = {
            "jobs": [],
            "total": 0,
            "page": 1,
            "per_page": 10
        }
    
        # Test with status filter
>       response = await client.get("/api/v1/jobs/?status=completed", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:164: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4213' coro=<TestJobsUnit.test_list_jobs_with_filters() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______________________ TestJobsUnit.test_get_job_success _______________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad045430>
mock_job_queue = <MagicMock name='job_queue' id='140021818185568'>
client = <httpx.AsyncClient object at 0x7f595ebbc350>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZUkU3V0IwQ0s2VjY2MFkzRkM1NCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODU0Mn0.vRWp1r254kajv2HlK9JV5tlO5vqX0qpBGBAK06pZ2m0'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_get_job_success(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test successful job retrieval."""
        job_id = "550e8400-e29b-41d4-a716-446655440000"
    
        mock_job = {
            "id": job_id,
            "name": "Test Job",
            "status": "completed",
            "result": "Job completed successfully",
            "created_at": "2024-01-01T12:00:00Z",
            "completed_at": "2024-01-01T12:05:00Z"
        }
    
        mock_job_queue.get_job.return_value = mock_job
    
>       response = await client.get(f"/api/v1/jobs/{job_id}", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:189: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4227' coro=<TestJobsUnit.test_get_job_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________________ TestJobsUnit.test_get_job_not_found ______________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad0457f0>
mock_job_queue = <MagicMock name='job_queue' id='140021880169984'>
client = <httpx.AsyncClient object at 0x7f59626d9130>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZVEcyMkMxRTdUVjY4MjhZOTczQSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODU0NH0.7nWzqQLelqSsOUSJvn2577gCwYc9txr0404uPWYF1Io'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_get_job_not_found(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test job retrieval for non-existent job."""
        job_id = "550e8400-e29b-41d4-a716-446655440000"
        mock_job_queue.get_job.return_value = None
    
>       response = await client.get(f"/api/v1/jobs/{job_id}", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:204: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4241' coro=<TestJobsUnit.test_get_job_not_found() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_________________ TestJobsUnit.test_get_job_invalid_id_format __________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad045bb0>
client = <httpx.AsyncClient object at 0x7f59622691f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZVkJENDY2VDNURks2WUZXRlFQSCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODU0NX0.Il0DrSjHKop11s9RD5AQhnfK42N3xTYRrFwgw6rG8Vw'}

    @pytest.mark.unit
    async def test_get_job_invalid_id_format(self, client: AsyncClient, auth_headers: dict):
        """Test job retrieval with invalid job ID format."""
        invalid_job_id = "not-a-uuid"
    
>       response = await client.get(f"/api/v1/jobs/{invalid_job_id}", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:212: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4255' coro=<TestJobsUnit.test_get_job_invalid_id_format() running at /home/yam/chatter/tests/test_jobs_unit.py:212> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________________ TestJobsUnit.test_cancel_job_success _____________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad045f70>
mock_job_queue = <MagicMock name='job_queue' id='140021862248672'>
client = <httpx.AsyncClient object at 0x7f59615c0ce0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZVzdXNzlBVDNQNEtSRlNGNENZOSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODU0Nn0.Bzp97ZDHUMw4ytgfnMIIpQFl3T_utgdnAZp6zbHGAB8'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_cancel_job_success(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test successful job cancellation."""
        job_id = "550e8400-e29b-41d4-a716-446655440000"
    
        mock_job_queue.cancel_job.return_value = True
    
>       response = await client.post(f"/api/v1/jobs/{job_id}/cancel", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:223: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4269' coro=<TestJobsUnit.test_cancel_job_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________________ TestJobsUnit.test_cancel_job_not_found ____________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad046330>
mock_job_queue = <MagicMock name='job_queue' id='140021862197312'>
client = <httpx.AsyncClient object at 0x7f597a008440>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZWDZHWkJOSFhRM1BXR1NBMlIxUiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODU0N30.2iEn1dCFbiAHm7ulXQcs7hY4KrhuJXbjV_OQKXX7uTw'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_cancel_job_not_found(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test cancellation of non-existent job."""
        job_id = "550e8400-e29b-41d4-a716-446655440000"
        mock_job_queue.cancel_job.return_value = False
    
>       response = await client.post(f"/api/v1/jobs/{job_id}/cancel", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:238: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4283' coro=<TestJobsUnit.test_cancel_job_not_found() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
________________ TestJobsUnit.test_cancel_job_invalid_id_format ________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad0466f0>
client = <httpx.AsyncClient object at 0x7f5960b40710>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZWTNZUVowNUtXQTNCWTJGOTJBNiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODU0OH0.Ly8IRV2rtfj219Z9LfRSuK4WfyQc7tMopo2xEEn-dpY'}

    @pytest.mark.unit
    async def test_cancel_job_invalid_id_format(self, client: AsyncClient, auth_headers: dict):
        """Test job cancellation with invalid job ID format."""
        invalid_job_id = "not-a-uuid"
    
>       response = await client.post(f"/api/v1/jobs/{invalid_job_id}/cancel", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:246: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4297' coro=<TestJobsUnit.test_cancel_job_invalid_id_format() running at /home/yam/chatter/tests/test_jobs_unit.py:246> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
___________________ TestJobsUnit.test_get_job_stats_success ____________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad046ab0>
mock_job_queue = <MagicMock name='job_queue' id='140021822340992'>
client = <httpx.AsyncClient object at 0x7f595efb3c50>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZWjE4NDVCUFZBQlFNV0E5WUc5SiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODU0OX0.u-sJVQa_V3n-f1E09MsbS-UFB9Q6g-zSTFHexeqoTqU'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_get_job_stats_success(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test successful job stats retrieval."""
        mock_stats = {
            "total_jobs": 100,
            "pending_jobs": 5,
            "running_jobs": 3,
            "completed_jobs": 85,
            "failed_jobs": 7,
            "cancelled_jobs": 0,
            "queue_size": 8,
            "worker_count": 4,
            "average_processing_time": 45.5
        }
    
        mock_job_queue.get_stats.return_value = mock_stats
    
>       response = await client.get("/api/v1/jobs/stats/overview", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:267: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4311' coro=<TestJobsUnit.test_get_job_stats_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________________ TestJobsUnit.test_cleanup_jobs_success ____________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad046e70>
mock_job_queue = <MagicMock name='job_queue' id='140021765495056'>
client = <httpx.AsyncClient object at 0x7f595b97c7d0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1lZWldSWTg4RTNYN1kyUVJES1dEVCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODU1MH0.aumKj5qvtduLmRJXJvWOuG3ke5cxCSYCYiazyPSbOsM'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_cleanup_jobs_success(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test successful job cleanup."""
        mock_job_queue.cleanup_completed_jobs.return_value = {
            "cleaned_count": 25,
            "remaining_count": 75
        }
    
>       response = await client.post("/api/v1/jobs/cleanup", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:285: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4325' coro=<TestJobsUnit.test_cleanup_jobs_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________________ TestJobsUnit.test_list_jobs_pagination ____________________

self = <tests.test_jobs_unit.TestJobsUnit object at 0x7f59ad02b800>
mock_job_queue = <MagicMock name='job_queue' id='140021818615872'>
client = <httpx.AsyncClient object at 0x7f595eaf5f40>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1laMFlYSjhBMU43MzBZOTU0VlZQMCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODU1MX0.WWcI8T8ADHpoWaSXzhiNq4bbThg4Nzm8iuNq56gYoZw'}

    @pytest.mark.unit
    @patch('chatter.api.jobs.job_queue')
    async def test_list_jobs_pagination(self, mock_job_queue, client: AsyncClient, auth_headers: dict):
        """Test job listing pagination."""
        mock_job_queue.list_jobs.return_value = {
            "jobs": [],
            "total": 50,
            "page": 2,
            "per_page": 20
        }
    
>       response = await client.get("/api/v1/jobs/?page=2&per_page=20", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_jobs_unit.py:319: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-4352' coro=<TestJobsUnit.test_list_jobs_pagination() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
__________________ TestMCPToolService.test_add_server_success __________________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7f59ad06a300>

    @pytest.mark.asyncio
    async def test_add_server_success(self):
        """Test successfully adding a server."""
        server_config = RemoteMCPServer(
            name="test_server",
            base_url=HttpUrl("https://mcp.example.com"),
            transport_type="http"
        )
    
        with patch.object(self.service, '_convert_server_to_connection') as mock_convert:
            with patch.object(self.service, '_update_client') as mock_update:
                mock_convert.return_value = MagicMock(spec=Connection)
    
>               result = await self.service.add_server(server_config)
                               ^^^^^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:255: AttributeError
_____________ TestMCPToolService.test_add_server_disabled_service ______________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7f59ad06a5a0>

    @pytest.mark.asyncio
    async def test_add_server_disabled_service(self):
        """Test adding server when service is disabled."""
        self.service.enabled = False
    
        server_config = RemoteMCPServer(
            name="test_server",
            base_url=HttpUrl("https://mcp.example.com"),
            transport_type="http"
        )
    
>       result = await self.service.add_server(server_config)
                       ^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:275: AttributeError
_____________ TestMCPToolService.test_add_server_validation_error ______________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7f59ad06a840>

    @pytest.mark.asyncio
    async def test_add_server_validation_error(self):
        """Test adding server with invalid configuration."""
        server_config = RemoteMCPServer(
            name="",  # Invalid: empty name
            base_url=HttpUrl("https://mcp.example.com"),
            transport_type="http"
        )
    
>       result = await self.service.add_server(server_config)
                       ^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:289: AttributeError
__________________ TestMCPToolService.test_call_tool_success ___________________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7f59ad06a9f0>

    @pytest.mark.asyncio
    async def test_call_tool_success(self):
        """Test successfully calling a tool."""
        # Add server and cached tools
        self.service.servers["test_server"] = MagicMock()
        mock_tool = MagicMock(spec=BaseTool)
        mock_tool.name = "test_tool"
        self.service.tools_cache["test_server"] = [mock_tool]
    
        mock_client = MagicMock()
        mock_client.call_tool = AsyncMock(return_value={"result": "success"})
    
        with patch.object(self.service, '_get_client', return_value=mock_client):
            result = await self.service.call_tool(
                "test_tool",
                {"param": "value"}
            )
    
>       assert result == {"result": "success"}
E       AssertionError: assert {'error': 'To...': False, ...} == {'result': 'success'}
E         
E         Left contains 5 more items:
E         {'error': 'Tool not found: test_tool',
E          'response_time_ms': 0.3886222839355469,
E          'server': 'unknown',
E          'success': False,
E          'tool': 'test_tool'}...
E         
E         ...Full output truncated (12 lines hidden), use '-vv' to show

tests/test_mcp_service.py:451: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    chatter.services.mcp:mcp.py:356 [2m2025-09-05T12:52:31.917265Z[0m [[31m[1merror    [0m] [1mFailed to get tools from MCP servers[0m [[34m[1mchatter.services.mcp[0m] [36merror[0m=[35mobject MagicMock can't be used in 'await' expression[0m
ERROR    chatter.services.mcp:mcp.py:492 [2m2025-09-05T12:52:31.917373Z[0m [[31m[1merror    [0m] [1mMCP tool call failed          [0m [[34m[1mchatter.services.mcp[0m] [36merror[0m=[35mTool not found: test_tool[0m [36mserver[0m=[35mNone[0m [36mtool[0m=[35mtest_tool[0m
______________ TestMCPToolService.test_call_tool_disabled_service ______________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7f59ad06a330>

    @pytest.mark.asyncio
    async def test_call_tool_disabled_service(self):
        """Test calling tool when service is disabled."""
        self.service.enabled = False
    
        result = await self.service.call_tool("test_tool", {})
    
>       assert result is None
E       AssertionError: assert {'error': 'Tool not found: test_tool', 'response_time_ms': 0.029087066650390625, 'server': 'unknown', 'success': False, ...} is None

tests/test_mcp_service.py:464: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    chatter.services.mcp:mcp.py:492 [2m2025-09-05T12:52:31.932274Z[0m [[31m[1merror    [0m] [1mMCP tool call failed          [0m [[34m[1mchatter.services.mcp[0m] [36merror[0m=[35mTool not found: test_tool[0m [36mserver[0m=[35mNone[0m [36mtool[0m=[35mtest_tool[0m
_____________________ TestMCPToolService.test_list_servers _____________________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7f59ad069e20>

    @pytest.mark.asyncio
    async def test_list_servers(self):
        """Test listing servers."""
        server1 = RemoteMCPServer(
            name="server1",
            base_url=HttpUrl("https://mcp1.example.com"),
            transport_type="http"
        )
        server2 = RemoteMCPServer(
            name="server2",
            base_url=HttpUrl("https://mcp2.example.com"),
            transport_type="sse",
            enabled=False
        )
    
        self.service.servers["server1"] = server1
        self.service.servers["server2"] = server2
    
>       servers = self.service.list_servers()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MCPToolService' object has no attribute 'list_servers'

tests/test_mcp_service.py:484: AttributeError
___________________ TestMCPToolService.test_get_server_info ____________________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7f59ad068ce0>

    @pytest.mark.asyncio
    async def test_get_server_info(self):
        """Test getting server information."""
        server_config = RemoteMCPServer(
            name="test_server",
            base_url=HttpUrl("https://mcp.example.com"),
            transport_type="http",
            timeout=60
        )
        self.service.servers["test_server"] = server_config
        self.service.tools_cache["test_server"] = [MagicMock(), MagicMock()]
    
>       info = await self.service.get_server_info("test_server")
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MCPToolService' object has no attribute 'get_server_info'

tests/test_mcp_service.py:504: AttributeError
_____________ TestMCPToolService.test_get_server_info_nonexistent ______________

self = <tests.test_mcp_service.TestMCPToolService object at 0x7f59ad088080>

    @pytest.mark.asyncio
    async def test_get_server_info_nonexistent(self):
        """Test getting info for nonexistent server."""
>       info = await self.service.get_server_info("nonexistent")
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MCPToolService' object has no attribute 'get_server_info'

tests/test_mcp_service.py:520: AttributeError
_______________ TestMCPServiceIntegration.test_server_lifecycle ________________

self = <tests.test_mcp_service.TestMCPServiceIntegration object at 0x7f59ad0887d0>

    @pytest.mark.asyncio
    async def test_server_lifecycle(self):
        """Test complete server lifecycle: add, discover, call, remove."""
        server_config = RemoteMCPServer(
            name="test_server",
            base_url=HttpUrl("https://mcp.example.com"),
            transport_type="http"
        )
    
        # Mock the MCP client interactions
        mock_tool = StructuredTool.from_function(
            func=lambda x: f"Result: {x}",
            name="test_tool",
            description="Test tool"
        )
    
        mock_client = MagicMock()
        mock_client.get_tools = AsyncMock(return_value=[mock_tool])
        mock_client.call_tool = AsyncMock(return_value={"result": "success"})
    
        with patch.object(self.service, '_get_client', return_value=mock_client):
            with patch.object(self.service, '_convert_server_to_connection') as mock_convert:
                with patch.object(self.service, '_update_client'):
                    mock_convert.return_value = MagicMock(spec=Connection)
    
                    # Add server
>                   assert await self.service.add_server(server_config) is True
                                 ^^^^^^^^^^^^^^^^^^^^^^^
E                   AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:585: AttributeError
__________ TestMCPServiceIntegration.test_multiple_servers_management __________

self = <tests.test_mcp_service.TestMCPServiceIntegration object at 0x7f59ad088950>

    @pytest.mark.asyncio
    async def test_multiple_servers_management(self):
        """Test managing multiple MCP servers."""
        server1 = RemoteMCPServer(
            name="server1",
            base_url=HttpUrl("https://mcp1.example.com"),
            transport_type="http"
        )
        server2 = RemoteMCPServer(
            name="server2",
            base_url=HttpUrl("https://mcp2.example.com"),
            transport_type="sse"
        )
    
        with patch.object(self.service, '_convert_server_to_connection') as mock_convert:
            with patch.object(self.service, '_update_client'):
                mock_convert.return_value = MagicMock(spec=Connection)
    
                # Add both servers
>               assert await self.service.add_server(server1) is True
                             ^^^^^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:625: AttributeError
___________ TestMCPServiceIntegration.test_error_recovery_scenarios ____________

self = <tests.test_mcp_service.TestMCPServiceIntegration object at 0x7f59ad088bf0>

    @pytest.mark.asyncio
    async def test_error_recovery_scenarios(self):
        """Test error recovery and circuit breaker functionality."""
        server_config = RemoteMCPServer(
            name="unreliable_server",
            base_url=HttpUrl("https://unreliable.example.com"),
            transport_type="http"
        )
    
        with patch.object(self.service, '_convert_server_to_connection'):
            with patch.object(self.service, '_update_client'):
                # Add server successfully
>               assert await self.service.add_server(server_config) is True
                             ^^^^^^^^^^^^^^^^^^^^^^^
E               AttributeError: 'MCPToolService' object has no attribute 'add_server'

tests/test_mcp_service.py:654: AttributeError
__________ TestSecurityHeadersMiddleware.test_security_headers_added ___________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 32, in test_security_headers_added
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 32, in test_security_headers_added
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7f59ad08bc50>

    def test_security_headers_added(self):
        """Test that security headers are added to responses."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:32: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7f595c10d670>
request = <starlette.middleware.base._CachedRequest object at 0x7f5979eaa450>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f595c1320c0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
______ TestSecurityHeadersMiddleware.test_content_security_policy_header _______
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 52, in test_content_security_policy_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 52, in test_content_security_policy_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7f59ad0c80b0>

    def test_content_security_policy_header(self):
        """Test Content Security Policy header configuration."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:52: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7f595c1d2690>
request = <starlette.middleware.base._CachedRequest object at 0x7f595c1d2d50>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f595c12a160>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
__________ TestSecurityHeadersMiddleware.test_x_frame_options_header ___________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 65, in test_x_frame_options_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 65, in test_x_frame_options_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7f59ad0c8230>

    def test_x_frame_options_header(self):
        """Test X-Frame-Options header."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:65: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7f595c169dc0>
request = <starlette.middleware.base._CachedRequest object at 0x7f595c1689b0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f595c12b4c0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
_______ TestSecurityHeadersMiddleware.test_x_content_type_options_header _______
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 71, in test_x_content_type_options_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 71, in test_x_content_type_options_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7f59ad0c8440>

    def test_x_content_type_options_header(self):
        """Test X-Content-Type-Options header."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:71: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7f595c11ec90>
request = <starlette.middleware.base._CachedRequest object at 0x7f595c11d7c0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f595e894860>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
__________ TestSecurityHeadersMiddleware.test_x_xss_protection_header __________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 77, in test_x_xss_protection_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 77, in test_x_xss_protection_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7f59ad0c8650>

    def test_x_xss_protection_header(self):
        """Test X-XSS-Protection header."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:77: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7f595c1d0c80>
request = <starlette.middleware.base._CachedRequest object at 0x7f595c1d0260>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f595c133600>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
__________ TestSecurityHeadersMiddleware.test_referrer_policy_header ___________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 83, in test_referrer_policy_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 83, in test_referrer_policy_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7f59ad0c8860>

    def test_referrer_policy_header(self):
        """Test Referrer-Policy header."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:83: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7f595c157170>
request = <starlette.middleware.base._CachedRequest object at 0x7f595c157c20>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f597c7b8720>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
_________ TestSecurityHeadersMiddleware.test_permissions_policy_header _________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 89, in test_permissions_policy_header
    |     response = self.client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 89, in test_permissions_policy_header
    response = self.client.get("/test")
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7f59ad0c8a70>

    def test_permissions_policy_header(self):
        """Test Permissions-Policy header."""
>       response = self.client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:89: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7f595c17aed0>
request = <starlette.middleware.base._CachedRequest object at 0x7f595c17b560>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f597c90aac0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
_____ TestSecurityHeadersMiddleware.test_strict_transport_security_enabled _____
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 110, in test_strict_transport_security_enabled
    |     response = client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 110, in test_strict_transport_security_enabled
    response = client.get("/test")
               ^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7f59ad0c8c80>

    def test_strict_transport_security_enabled(self):
        """Test HSTS header when enabled."""
        app = FastAPI()
    
        @app.get("/test")
        async def test_endpoint():
            return {"message": "test"}
    
        app.add_middleware(SecurityHeadersMiddleware, strict_transport_security=True)
        client = TestClient(app)
    
>       response = client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:110: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7f595e807fe0>
request = <starlette.middleware.base._CachedRequest object at 0x7f595e8051c0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f595e894c20>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
____ TestSecurityHeadersMiddleware.test_strict_transport_security_disabled _____
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 128, in test_strict_transport_security_disabled
    |     response = client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 128, in test_strict_transport_security_disabled
    response = client.get("/test")
               ^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7f59ad0c8e90>

    def test_strict_transport_security_disabled(self):
        """Test HSTS header when disabled."""
        app = FastAPI()
    
        @app.get("/test")
        async def test_endpoint():
            return {"message": "test"}
    
        app.add_middleware(SecurityHeadersMiddleware, strict_transport_security=False)
        client = TestClient(app)
    
>       response = client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:128: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7f595e8cf410>
request = <starlette.middleware.base._CachedRequest object at 0x7f595e8cf650>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f595e8944a0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
_ TestSecurityHeadersMiddleware.test_security_headers_on_different_response_types _
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 152, in test_security_headers_on_different_response_types
    |     response = client.get("/json")
    |                ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 152, in test_security_headers_on_different_response_types
    response = client.get("/json")
               ^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7f59ad0c90a0>

    def test_security_headers_on_different_response_types(self):
        """Test security headers added to different response types."""
        app = FastAPI()
    
        @app.get("/json")
        async def json_endpoint():
            return {"message": "json"}
    
        @app.get("/html")
        async def html_endpoint():
            return Response(content="<html><body>test</body></html>", media_type="text/html")
    
        @app.get("/error")
        async def error_endpoint():
            return JSONResponse(content={"error": "test"}, status_code=400)
    
        app.add_middleware(SecurityHeadersMiddleware)
        client = TestClient(app)
    
        # Test JSON response
>       response = client.get("/json")
                   ^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:152: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7f595e848e90>
request = <starlette.middleware.base._CachedRequest object at 0x7f595e849040>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f595e844d60>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
__ TestSecurityHeadersMiddleware.test_security_headers_dont_override_existing __
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 176, in test_security_headers_dont_override_existing
    |     response = client.get("/test")
    |                ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 176, in test_security_headers_dont_override_existing
    response = client.get("/test")
               ^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestSecurityHeadersMiddleware object at 0x7f59ad0c92b0>

    def test_security_headers_dont_override_existing(self):
        """Test that security headers don't override existing ones."""
        app = FastAPI()
    
        @app.get("/test")
        async def test_endpoint():
            response = JSONResponse(content={"message": "test"})
            response.headers["X-Frame-Options"] = "SAMEORIGIN"
            return response
    
        app.add_middleware(SecurityHeadersMiddleware)
        client = TestClient(app)
    
>       response = client.get("/test")
                   ^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:176: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7f595e875e50>
request = <starlette.middleware.base._CachedRequest object at 0x7f595e877e60>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f595e846700>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
________ TestAuthRateLimitMiddleware.test_login_endpoint_rate_limiting _________

self = <tests.test_middleware.TestAuthRateLimitMiddleware object at 0x7f59ad0c97f0>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='140021814465536'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    async def test_login_endpoint_rate_limiting(self, mock_get_limiter):
        """Test rate limiting on login endpoint."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(False, {"retry_after": 60}))
        mock_get_limiter.return_value = mock_limiter
    
        self.app.add_middleware(AuthRateLimitMiddleware)
        client = TestClient(self.app)
    
        response = client.post("/auth/login")
    
>       assert response.status_code == status.HTTP_429_TOO_MANY_REQUESTS
E       assert 200 == 429
E        +  where 200 = <Response [200 OK]>.status_code
E        +  and   429 = status.HTTP_429_TOO_MANY_REQUESTS

tests/test_middleware.py:261: AssertionError
_______ TestAuthRateLimitMiddleware.test_register_endpoint_rate_limiting _______

self = <tests.test_middleware.TestAuthRateLimitMiddleware object at 0x7f59ad0c9ac0>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='140021814811232'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    async def test_register_endpoint_rate_limiting(self, mock_get_limiter):
        """Test rate limiting on register endpoint."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(False, {"retry_after": 120}))
        mock_get_limiter.return_value = mock_limiter
    
        self.app.add_middleware(AuthRateLimitMiddleware)
        client = TestClient(self.app)
    
        response = client.post("/auth/register")
    
>       assert response.status_code == status.HTTP_429_TOO_MANY_REQUESTS
E       assert 200 == 429
E        +  where 200 = <Response [200 OK]>.status_code
E        +  and   429 = status.HTTP_429_TOO_MANY_REQUESTS

tests/test_middleware.py:276: AssertionError
____ TestAuthRateLimitMiddleware.test_password_reset_endpoint_rate_limiting ____

self = <tests.test_middleware.TestAuthRateLimitMiddleware object at 0x7f59ad0c9d90>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='140021814918368'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    async def test_password_reset_endpoint_rate_limiting(self, mock_get_limiter):
        """Test rate limiting on password reset endpoint."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(False, {"retry_after": 300}))
        mock_get_limiter.return_value = mock_limiter
    
        self.app.add_middleware(AuthRateLimitMiddleware)
        client = TestClient(self.app)
    
        response = client.post("/auth/password-reset")
    
>       assert response.status_code == status.HTTP_429_TOO_MANY_REQUESTS
E       assert 200 == 429
E        +  where 200 = <Response [200 OK]>.status_code
E        +  and   429 = status.HTTP_429_TOO_MANY_REQUESTS

tests/test_middleware.py:292: AssertionError
__________ TestAuthRateLimitMiddleware.test_client_ip_identification ___________

self = <AsyncMock name='get_unified_rate_limiter().is_allowed' id='140021814948496'>

    def assert_called_once(self):
        """assert that the mock was called only once.
        """
        if not self.call_count == 1:
            msg = ("Expected '%s' to have been called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected 'is_allowed' to have been called once. Called 0 times.

/usr/lib64/python3.12/unittest/mock.py:928: AssertionError

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestAuthRateLimitMiddleware object at 0x7f59ad0ca1b0>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='140021814426464'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    async def test_client_ip_identification(self, mock_get_limiter):
        """Test client IP identification for rate limiting."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(True, {}))
        mock_get_limiter.return_value = mock_limiter
    
        self.app.add_middleware(AuthRateLimitMiddleware)
        client = TestClient(self.app)
    
        # Test with X-Forwarded-For header
        response = client.post(
            "/auth/login",
            headers={"X-Forwarded-For": "192.168.1.100, 10.0.0.1"}
        )
    
        assert response.status_code == 200
        # Verify that rate limiter was called with client IP
>       mock_limiter.is_allowed.assert_called_once()
E       AssertionError: Expected 'is_allowed' to have been called once. Called 0 times.

tests/test_middleware.py:342: AssertionError
_____ TestAuthRateLimitMiddleware.test_rate_limit_with_user_agent_tracking _____

self = <AsyncMock name='get_unified_rate_limiter().is_allowed' id='140021755577312'>

    def assert_called_once(self):
        """assert that the mock was called only once.
        """
        if not self.call_count == 1:
            msg = ("Expected '%s' to have been called once. Called %s times.%s"
                   % (self._mock_name or 'mock',
                      self.call_count,
                      self._calls_repr()))
>           raise AssertionError(msg)
E           AssertionError: Expected 'is_allowed' to have been called once. Called 0 times.

/usr/lib64/python3.12/unittest/mock.py:928: AssertionError

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestAuthRateLimitMiddleware object at 0x7f59ad0c9a90>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='140021814531120'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    async def test_rate_limit_with_user_agent_tracking(self, mock_get_limiter):
        """Test rate limiting considers user agent."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(True, {}))
        mock_get_limiter.return_value = mock_limiter
    
        self.app.add_middleware(AuthRateLimitMiddleware)
        client = TestClient(self.app)
    
        response = client.post(
            "/auth/login",
            headers={"User-Agent": "TestBot/1.0"}
        )
    
        assert response.status_code == 200
        # Verify rate limiter was called
>       mock_limiter.is_allowed.assert_called_once()
E       AssertionError: Expected 'is_allowed' to have been called once. Called 0 times.

tests/test_middleware.py:361: AssertionError
____________ TestMiddlewareIntegration.test_both_middleware_applied ____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/unittest/mock.py", line 1396, in patched
    |     return func(*newargs, **newkeywargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 470, in test_both_middleware_applied
    |     response = self.client.post("/auth/login")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 470, in test_both_middleware_applied
    response = self.client.post("/auth/login")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareIntegration object at 0x7f59ad0cae40>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='140021815092448'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    def test_both_middleware_applied(self, mock_get_limiter):
        """Test that both security and rate limiting middleware are applied."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(True, {}))
        mock_get_limiter.return_value = mock_limiter
    
>       response = self.client.post("/auth/login")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:470: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
../.local/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/middleware/auth_security.py:61: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7f595b093050>
request = <starlette.middleware.base._CachedRequest object at 0x7f595b093710>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f595b055b20>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
___ TestMiddlewareIntegration.test_security_headers_on_rate_limited_response ___
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/unittest/mock.py", line 1396, in patched
    |     return func(*newargs, **newkeywargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 488, in test_security_headers_on_rate_limited_response
    |     response = self.client.post("/auth/login")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 488, in test_security_headers_on_rate_limited_response
    response = self.client.post("/auth/login")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareIntegration object at 0x7f59ad0caf90>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='140021756200432'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    def test_security_headers_on_rate_limited_response(self, mock_get_limiter):
        """Test that security headers are added even on rate limited responses."""
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(False, {"retry_after": 60}))
        mock_get_limiter.return_value = mock_limiter
    
>       response = self.client.post("/auth/login")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:488: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
../.local/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/middleware/auth_security.py:61: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7f595b0885c0>
request = <starlette.middleware.base._CachedRequest object at 0x7f595b088f80>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f595b057420>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
___ TestMiddlewareIntegration.test_non_auth_endpoints_only_security_headers ____
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 498, in test_non_auth_endpoints_only_security_headers
    |     response = self.client.get("/api/data")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 498, in test_non_auth_endpoints_only_security_headers
    response = self.client.get("/api/data")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareIntegration object at 0x7f59ad0cb170>

    def test_non_auth_endpoints_only_security_headers(self):
        """Test that non-auth endpoints only get security headers."""
>       response = self.client.get("/api/data")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:498: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/middleware/auth_security.py:61: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7f595b031ac0>
request = <starlette.middleware.base._CachedRequest object at 0x7f595b0326c0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f595b0b0fe0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
___________ TestMiddlewareIntegration.test_middleware_order_matters ____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/unittest/mock.py", line 1396, in patched
    |     return func(*newargs, **newkeywargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 516, in test_middleware_order_matters
    |     response = self.client.post("/auth/login")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 516, in test_middleware_order_matters
    response = self.client.post("/auth/login")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareIntegration object at 0x7f59ad0cb380>
mock_get_limiter = <MagicMock name='get_unified_rate_limiter' id='140021756395488'>

    @patch('chatter.middleware.auth_security.get_unified_rate_limiter')
    def test_middleware_order_matters(self, mock_get_limiter):
        """Test that middleware order affects behavior."""
        # This test verifies that security headers are applied
        # even when rate limiting middleware intervenes
    
        mock_limiter = MagicMock()
        mock_limiter.is_allowed = AsyncMock(return_value=(False, {"retry_after": 60}))
        mock_get_limiter.return_value = mock_limiter
    
>       response = self.client.post("/auth/login")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:516: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:552: in post
    return super().post(
../.local/lib/python3.12/site-packages/httpx/_client.py:1144: in post
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/middleware/auth_security.py:61: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7f595b0ca570>
request = <starlette.middleware.base._CachedRequest object at 0x7f595b0cac00>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f595b057ba0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
____________ TestMiddlewareIntegration.test_middleware_performance _____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 530, in test_middleware_performance
    |     response = self.client.get("/api/data")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    |     raise app_exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 530, in test_middleware_performance
    response = self.client.get("/api/data")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/auth_security.py", line 61, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 159, in call_next
    raise app_exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareIntegration object at 0x7f59ad0cb560>

    def test_middleware_performance(self):
        """Test middleware performance with multiple requests."""
        import time
    
        start_time = time.time()
    
        # Make multiple requests
        for _ in range(10):
>           response = self.client.get("/api/data")
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:530: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/middleware/auth_security.py:61: in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:159: in call_next
    raise app_exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7f59606f6ea0>
request = <starlette.middleware.base._CachedRequest object at 0x7f59606f78c0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f59604e8220>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
____________ TestMiddlewareEdgeCases.test_empty_app_with_middleware ____________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_middleware.py", line 566, in test_empty_app_with_middleware
    |     response = client.get("/nonexistent")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    |     response.headers.pop("Server", None)
    |     ^^^^^^^^^^^^^^^^^^^^
    | AttributeError: 'MutableHeaders' object has no attribute 'pop'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_middleware.py", line 566, in test_empty_app_with_middleware
    response = client.get("/nonexistent")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/chatter/middleware/security.py", line 75, in dispatch
    response.headers.pop("Server", None)
    ^^^^^^^^^^^^^^^^^^^^
AttributeError: 'MutableHeaders' object has no attribute 'pop'

During handling of the above exception, another exception occurred:

self = <tests.test_middleware.TestMiddlewareEdgeCases object at 0x7f59ad0cbb30>

    def test_empty_app_with_middleware(self):
        """Test middleware with empty app (no routes)."""
        self.app.add_middleware(SecurityHeadersMiddleware)
    
        client = TestClient(self.app)
    
        # Should return 404 with security headers
>       response = client.get("/nonexistent")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_middleware.py:566: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.middleware.security.SecurityHeadersMiddleware object at 0x7f59604cb860>
request = <starlette.middleware.base._CachedRequest object at 0x7f59604cbce0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f59604e93a0>

    async def dispatch(self, request: Request, call_next: Callable) -> Response:
        """Add security headers to response."""
        response = await call_next(request)
    
        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' 'unsafe-eval'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self' data:; "
            "connect-src 'self' ws: wss:; "
            "frame-ancestors 'none'"
        )
    
        # X-Frame-Options
        response.headers["X-Frame-Options"] = "DENY"
    
        # X-Content-Type-Options
        response.headers["X-Content-Type-Options"] = "nosniff"
    
        # X-XSS-Protection
        response.headers["X-XSS-Protection"] = "1; mode=block"
    
        # Referrer Policy
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
        # Permissions Policy
        response.headers["Permissions-Policy"] = (
            "camera=(), microphone=(), geolocation=(), "
            "payment=(), usb=(), magnetometer=(), gyroscope=(), "
            "accelerometer=(), ambient-light-sensor=()"
        )
    
        # Cross-Origin-Embedder-Policy
        response.headers["Cross-Origin-Embedder-Policy"] = "require-corp"
    
        # Cross-Origin-Opener-Policy
        response.headers["Cross-Origin-Opener-Policy"] = "same-origin"
    
        # Cross-Origin-Resource-Policy
        response.headers["Cross-Origin-Resource-Policy"] = "same-origin"
    
        # Strict-Transport-Security (HTTPS only)
        if self.strict_transport_security and request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains; preload"
            )
    
        # Remove server information
>       response.headers.pop("Server", None)
        ^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'MutableHeaders' object has no attribute 'pop'

chatter/middleware/security.py:75: AttributeError
_______ TestDefaultProviderLogic.test_get_default_provider_by_model_type _______

self = <tests.test_model_registry_fixes.TestDefaultProviderLogic object at 0x7f59ad0e0770>
service = <chatter.core.model_registry.ModelRegistryService object at 0x7f5960648830>
sample_provider = '01K4CYZ684WQQEN7WHS76EFY2G'
sample_llm_model = '01K4CYZ68CGQ65J9H6D6P1G9GK'
sample_embedding_model = '01K4CYZ68M9XBPK54M27GE0AN7'

    async def test_get_default_provider_by_model_type(
        self,
        service: ModelRegistryService,
        sample_provider: str,
        sample_llm_model: str,
        sample_embedding_model: str,
    ):
        """Test getting default provider filtered by model type."""
        # Set as default for LLM
        await service.set_default_provider(sample_provider, ModelType.LLM)
    
        # Should find default for LLM
        llm_default = await service.get_default_provider(ModelType.LLM)
        assert llm_default is not None
>       assert llm_default.id == sample_provider
E       AssertionError: assert '01K4CYZ62A2ATWGDXMEW6R7PAS' == '01K4CYZ684WQQEN7WHS76EFY2G'
E         
E         - 01K4CYZ684WQQEN7WHS76EFY2G
E         + 01K4CYZ62A2ATWGDXMEW6R7PAS

tests/test_model_registry_fixes.py:124: AssertionError
_ TestBusinessLogicImprovements.test_multiple_providers_different_model_types __

self = <tests.test_model_registry_fixes.TestBusinessLogicImprovements object at 0x7f59ad0e2660>
service = <chatter.core.model_registry.ModelRegistryService object at 0x7f595bd97020>

    async def test_multiple_providers_different_model_types(
        self, service: ModelRegistryService
    ):
        """Test that different providers can be default for different model types."""
        import uuid
        unique_id = str(uuid.uuid4())[:8]
    
        # Create two providers
        provider1_data = ProviderCreate(
            name=f"provider1_{unique_id}",
            provider_type=ProviderType.OPENAI,
            display_name="Provider 1",
        )
        provider1 = await service.create_provider(provider1_data)
    
        provider2_data = ProviderCreate(
            name=f"provider2_{unique_id}",
            provider_type=ProviderType.ANTHROPIC,
            display_name="Provider 2",
        )
        provider2 = await service.create_provider(provider2_data)
    
        # Create LLM model for provider1
        llm_data = ModelDefCreate(
            provider_id=provider1.id,
            name=f"llm1_{unique_id}",
            model_type=ModelType.LLM,
            display_name="LLM 1",
            model_name="gpt-4",
        )
        await service.create_model(llm_data)
    
        # Create embedding model for provider2
        embedding_data = ModelDefCreate(
            provider_id=provider2.id,
            name=f"embedding1_{unique_id}",
            model_type=ModelType.EMBEDDING,
            display_name="Embedding 1",
            model_name="text-embedding-ada-002",
            dimensions=1536,
        )
        await service.create_model(embedding_data)
    
        # Set provider1 as default for LLM
        await service.set_default_provider(provider1.id, ModelType.LLM)
    
        # Set provider2 as default for EMBEDDING
        await service.set_default_provider(provider2.id, ModelType.EMBEDDING)
    
        # Verify both defaults are set correctly
        llm_default = await service.get_default_provider(ModelType.LLM)
>       assert llm_default.id == provider1.id
E       AssertionError: assert '01K4CYZ62A2ATWGDXMEW6R7PAS' == '01K4CYZ6RA13QC581JF3KMQTBZ'
E         
E         - 01K4CYZ6RA13QC581JF3KMQTBZ
E         + 01K4CYZ62A2ATWGDXMEW6R7PAS

tests/test_model_registry_fixes.py:331: AssertionError
__ TestTransactionManagement.test_create_model_transaction_rollback_on_error ___

self = <tests.test_model_registry_fixes.TestTransactionManagement object at 0x7f59ad0ca6c0>
service = <chatter.core.model_registry.ModelRegistryService object at 0x7f59605c0ec0>
sample_provider = '01K4CYZ6VE443M0WJ8A2HP6BHG'

    async def test_create_model_transaction_rollback_on_error(
        self, service: ModelRegistryService, sample_provider: str
    ):
        """Test that model creation rolls back properly on error."""
        import uuid
        unique_id = str(uuid.uuid4())[:8]
        # Create a model with invalid data to trigger an error
        model_data = ModelDefCreate(
            provider_id=sample_provider,
            name=f"test_model_{unique_id}",
            model_type=ModelType.LLM,
            display_name="Test Model",
            model_name="gpt-4",
        )
    
        # First create should succeed
        model = await service.create_model(model_data)
        assert model is not None
    
        # Second create with same name should fail and not leave partial data
        with pytest.raises(Exception):  # Could be IntegrityError or ValidationError
            await service.create_model(model_data)
    
        # Verify no partial data was left
>       models = await service.list_models(provider_id=sample_provider)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_model_registry_fixes.py:364: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/core/model_registry.py:332: in list_models
    total = await self.session.scalar(count_query)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:519: in scalar
    return await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:190: in greenlet_spawn
    result = context.switch(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2413: in scalar
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2241: in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2110: in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<string>:2: in _connection_for_bind
    ???
../.local/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:101: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f595a6c7550>
operation_name = '_connection_for_bind'
state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "uq_provider_model_name"
E               DETAIL:  Key (provider_id, name)=(01K4CYZ6VE443M0WJ8A2HP6BHG, test_model_ea05900b) already exists.
E               [SQL: INSERT INTO model_defs (provider_id, name, model_type, display_name, description, model_name, max_tokens, context_length, dimensions, chunk_size, supports_batch, max_batch_size, default_config, is_active, is_default, id) VALUES ($1::VARCHAR, $2::VARCHAR, $3::VARCHAR, $4::VARCHAR, $5::VARCHAR, $6::VARCHAR, $7::INTEGER, $8::INTEGER, $9::INTEGER, $10::INTEGER, $11::BOOLEAN, $12::INTEGER, $13::JSON, $14::BOOLEAN, $15::BOOLEAN, $16::VARCHAR) RETURNING model_defs.created_at, model_defs.updated_at]
E               [parameters: ('01K4CYZ6VE443M0WJ8A2HP6BHG', 'test_model_ea05900b', <ModelType.LLM: 'llm'>, 'Test Model', None, 'gpt-4', None, None, None, None, False, None, '{}', True, False, '01K4CYZ6W1RE61FGZGB6684JQF')]
E               (Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)

../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
________________ TestBasePlugin.test_base_plugin_initialization ________________

self = <tests.test_plugins.TestBasePlugin object at 0x7f59acf06390>

    def test_base_plugin_initialization(self):
        """Test BasePlugin initialization."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
        config = {"param1": "value1", "param2": 123}
>       plugin = TestPlugin(config)
                 ^^^^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:53: TypeError
________________ TestBasePlugin.test_base_plugin_default_config ________________

self = <tests.test_plugins.TestBasePlugin object at 0x7f59acf05d60>

    def test_base_plugin_default_config(self):
        """Test BasePlugin with default empty config."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:72: TypeError
___________ TestBasePlugin.test_base_plugin_get_configuration_schema ___________

self = <tests.test_plugins.TestBasePlugin object at 0x7f59acf242c0>

    @pytest.mark.asyncio
    async def test_base_plugin_get_configuration_schema(self):
        """Test default configuration schema."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:91: TypeError
_____________ TestBasePlugin.test_validate_configuration_no_schema _____________

self = <tests.test_plugins.TestBasePlugin object at 0x7f59acf254c0>

    @pytest.mark.asyncio
    async def test_validate_configuration_no_schema(self):
        """Test configuration validation with no schema."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:115: TypeError
____________ TestBasePlugin.test_validate_configuration_with_schema ____________

self = <tests.test_plugins.TestBasePlugin object at 0x7f59acf25730>

    @pytest.mark.asyncio
    async def test_validate_configuration_with_schema(self):
        """Test configuration validation with custom schema."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            async def get_configuration_schema(self):
                return {
                    "type": "object",
                    "properties": {
                        "required_param": {"type": "string"},
                        "optional_param": {"type": "number"}
                    },
                    "required": ["required_param"]
                }
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:145: TypeError
___________ TestBasePlugin.test_validate_configuration_type_checking ___________

self = <tests.test_plugins.TestBasePlugin object at 0x7f59acf259a0>

    @pytest.mark.asyncio
    async def test_validate_configuration_type_checking(self):
        """Test configuration validation with type checking."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            async def get_configuration_schema(self):
                return {
                    "type": "object",
                    "properties": {
                        "string_param": {"type": "string"},
                        "number_param": {"type": "number"},
                        "boolean_param": {"type": "boolean"},
                        "object_param": {"type": "object"},
                        "array_param": {"type": "array"}
                    }
                }
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:183: TypeError
__________ TestBasePlugin.test_validate_configuration_error_handling ___________

self = <tests.test_plugins.TestBasePlugin object at 0x7f59acf25c10>

    @pytest.mark.asyncio
    async def test_validate_configuration_error_handling(self):
        """Test configuration validation error handling."""
    
        class TestPlugin(BasePlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            async def get_configuration_schema(self):
                raise Exception("Schema generation error")
    
>       plugin = TestPlugin()
                 ^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:218: TypeError
_________________ TestToolPlugin.test_tool_plugin_inheritance __________________

self = <tests.test_plugins.TestToolPlugin object at 0x7f59acf25d60>

    def test_tool_plugin_inheritance(self):
        """Test ToolPlugin inherits from BasePlugin."""
    
        class TestToolPlugin(ToolPlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            def get_tools(self):
                return [MockBaseTool("test_tool", "Test tool description")]
    
>       plugin = TestToolPlugin()
                 ^^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestToolPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:243: TypeError
_________________ TestToolPlugin.test_get_tools_implementation _________________

self = <tests.test_plugins.TestToolPlugin object at 0x7f59acf26090>

    def test_get_tools_implementation(self):
        """Test get_tools implementation."""
    
        class TestToolPlugin(ToolPlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            def get_tools(self):
                return [
                    MockBaseTool("tool1", "First tool"),
                    MockBaseTool("tool2", "Second tool")
                ]
    
>       plugin = TestToolPlugin()
                 ^^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestToolPlugin without an implementation for abstract methods 'get_capabilities', 'shutdown'

tests/test_plugins.py:282: TypeError
_____________ TestWorkflowPlugin.test_workflow_plugin_inheritance ______________

self = <tests.test_plugins.TestWorkflowPlugin object at 0x7f59acf26360>

    def test_workflow_plugin_inheritance(self):
        """Test WorkflowPlugin inherits from BasePlugin."""
    
        class TestWorkflowPlugin(WorkflowPlugin):
            async def initialize(self):
                pass
    
            async def cleanup(self):
                pass
    
            async def health_check(self):
                return {"status": "healthy"}
    
            async def execute_workflow(self, workflow_id: str, params: dict):
                return {"result": "workflow executed"}
    
>       plugin = TestWorkflowPlugin()
                 ^^^^^^^^^^^^^^^^^^^^
E       TypeError: Can't instantiate abstract class TestWorkflowPlugin without an implementation for abstract methods 'create_workflow', 'get_capabilities', 'shutdown'

tests/test_plugins.py:309: TypeError
_____________ TestPluginManager.test_plugin_manager_initialization _____________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf26870>

    def test_plugin_manager_initialization(self):
        """Test PluginManager initialization."""
        assert isinstance(self.plugin_manager.plugins, dict)
>       assert isinstance(self.plugin_manager.plugin_instances, dict)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'PluginManager' object has no attribute 'plugin_instances'

tests/test_plugins.py:340: AttributeError
_____________ TestPluginManager.test_get_plugin_directory_default ______________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf267e0>

    def test_get_plugin_directory_default(self):
        """Test getting default plugin directory."""
>       plugins_dir = self.plugin_manager._get_plugin_directory()
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'PluginManager' object has no attribute '_get_plugin_directory'. Did you mean: 'plugins_directory'?

tests/test_plugins.py:345: AttributeError
______________ TestPluginManager.test_get_plugin_directory_custom ______________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf26810>

    def test_get_plugin_directory_custom(self):
        """Test getting custom plugin directory."""
        with patch('chatter.services.plugins.settings') as mock_settings:
            mock_settings.plugins_directory = "/custom/plugins"
    
>           plugins_dir = self.plugin_manager._get_plugin_directory()
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           AttributeError: 'PluginManager' object has no attribute '_get_plugin_directory'. Did you mean: 'plugins_directory'?

tests/test_plugins.py:353: AttributeError
_____________ TestPluginManager.test_load_plugin_from_file_success _____________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf26120>

        @pytest.mark.asyncio
        async def test_load_plugin_from_file_success(self):
            """Test successfully loading plugin from file."""
    
            # Create a temporary plugin file
            plugin_code = '''
    from chatter.services.plugins import ToolPlugin
    
    class TestFilePlugin(ToolPlugin):
        async def initialize(self):
            pass
    
        async def cleanup(self):
            pass
    
        async def health_check(self):
            return {"status": "healthy"}
    
        def get_tools(self):
            from tests.test_plugins import MockBaseTool
            return [MockBaseTool("file_tool", "Tool from file")]
    
    # Plugin entry point
    plugin_class = TestFilePlugin
    '''
    
            with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
                f.write(plugin_code)
                plugin_file = Path(f.name)
    
            try:
>               plugin_instance = await self.plugin_manager.load_plugin_from_file(
                                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                    plugin_file, "test_file_plugin", {}
                )
E               AttributeError: 'PluginManager' object has no attribute 'load_plugin_from_file'

tests/test_plugins.py:387: AttributeError
__________ TestPluginManager.test_load_plugin_from_file_missing_file ___________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf25c70>

    @pytest.mark.asyncio
    async def test_load_plugin_from_file_missing_file(self):
        """Test loading plugin from non-existent file."""
        non_existent_file = Path("/non/existent/plugin.py")
    
        with pytest.raises(PluginError, match="Plugin file not found"):
>           await self.plugin_manager.load_plugin_from_file(
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                non_existent_file, "missing_plugin", {}
            )
E           AttributeError: 'PluginManager' object has no attribute 'load_plugin_from_file'

tests/test_plugins.py:404: AttributeError
__________ TestPluginManager.test_load_plugin_from_file_syntax_error ___________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf25670>

        @pytest.mark.asyncio
        async def test_load_plugin_from_file_syntax_error(self):
            """Test loading plugin with syntax error."""
    
            # Create plugin file with syntax error
            plugin_code = '''
    from chatter.services.plugins import ToolPlugin
    
    class TestFilePlugin(ToolPlugin):
        async def initialize(self)
            # Missing colon - syntax error
            pass
    '''
    
            with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
                f.write(plugin_code)
                plugin_file = Path(f.name)
    
            try:
                with pytest.raises(PluginError, match="Failed to load plugin"):
>                   await self.plugin_manager.load_plugin_from_file(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                        plugin_file, "syntax_error_plugin", {}
                    )
E                   AttributeError: 'PluginManager' object has no attribute 'load_plugin_from_file'

tests/test_plugins.py:428: AttributeError
_________________ TestPluginManager.test_unload_plugin_success _________________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf26b40>

    @pytest.mark.asyncio
    async def test_unload_plugin_success(self):
        """Test successfully unloading a plugin."""
    
        # Create a mock plugin instance
        mock_plugin = MagicMock()
        mock_plugin.cleanup = AsyncMock()
    
>       plugin_instance = PluginInstance(
            plugin_id="test_plugin",
            name="Test Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=mock_plugin,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:442: ValidationError
________________ TestPluginManager.test_unload_plugin_not_found ________________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf26de0>

    @pytest.mark.asyncio
    async def test_unload_plugin_not_found(self):
        """Test unloading non-existent plugin."""
>       result = await self.plugin_manager.unload_plugin("non_existent_plugin")
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'PluginManager' object has no attribute 'unload_plugin'. Did you mean: 'install_plugin'?

tests/test_plugins.py:464: AttributeError
______________ TestPluginManager.test_unload_plugin_cleanup_error ______________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf27080>

    @pytest.mark.asyncio
    async def test_unload_plugin_cleanup_error(self):
        """Test unloading plugin when cleanup fails."""
    
        mock_plugin = MagicMock()
        mock_plugin.cleanup = AsyncMock(side_effect=Exception("Cleanup failed"))
    
>       plugin_instance = PluginInstance(
            plugin_id="test_plugin",
            name="Test Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=mock_plugin,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:475: ValidationError
_____________________ TestPluginManager.test_list_plugins ______________________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf27320>

    def test_list_plugins(self):
        """Test listing plugins."""
    
        # Add some mock plugin instances
>       plugin1 = PluginInstance(
            plugin_id="plugin1",
            name="Plugin 1",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=MagicMock(),
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'plugin1', ... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'plugin1', ... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:498: ValidationError
_________________ TestPluginManager.test_list_plugins_by_type __________________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf275c0>

    def test_list_plugins_by_type(self):
        """Test listing plugins filtered by type."""
    
>       tool_plugin = PluginInstance(
            plugin_id="tool_plugin",
            name="Tool Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=MagicMock(),
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'tool_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'tool_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:532: ValidationError
________________ TestPluginManager.test_list_plugins_by_status _________________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf277d0>

    def test_list_plugins_by_status(self):
        """Test listing plugins filtered by status."""
    
>       active_plugin = PluginInstance(
            plugin_id="active_plugin",
            name="Active Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=MagicMock(),
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'active_plu... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'active_plu... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:566: ValidationError
_________________ TestPluginManager.test_get_plugin_info_found _________________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf279e0>

    def test_get_plugin_info_found(self):
        """Test getting plugin info for existing plugin."""
    
>       plugin = PluginInstance(
            plugin_id="test_plugin",
            name="Test Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=MagicMock(),
            config={"param": "value"},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T01:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T01:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'test_plugi... '2024-01-01T01:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:600: ValidationError
_______________ TestPluginManager.test_get_plugin_info_not_found _______________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf27bf0>

    def test_get_plugin_info_not_found(self):
        """Test getting plugin info for non-existent plugin."""
>       info = self.plugin_manager.get_plugin_info("non_existent")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'PluginManager' object has no attribute 'get_plugin_info'. Did you mean: '_get_plugin_lock'?

tests/test_plugins.py:619: AttributeError
________________ TestPluginManager.test_get_tools_from_plugins _________________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf4c050>

    def test_get_tools_from_plugins(self):
        """Test getting tools from tool plugins."""
    
        # Create mock tool plugin
        mock_tool_plugin = MagicMock()
        mock_tool_plugin.get_tools.return_value = [
            MockBaseTool("tool1", "Tool 1"),
            MockBaseTool("tool2", "Tool 2")
        ]
    
>       tool_plugin = PluginInstance(
            plugin_id="tool_plugin",
            name="Tool Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=mock_tool_plugin,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'tool_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'tool_plugi... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:633: ValidationError
________ TestPluginManager.test_get_tools_from_plugins_inactive_ignored ________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf4c260>

    def test_get_tools_from_plugins_inactive_ignored(self):
        """Test that inactive plugins are ignored when getting tools."""
    
        # Create inactive tool plugin
        mock_tool_plugin = MagicMock()
        mock_tool_plugin.get_tools.return_value = [MockBaseTool("tool1", "Tool 1")]
    
>       inactive_plugin = PluginInstance(
            plugin_id="inactive_plugin",
            name="Inactive Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ERROR,  # Inactive status
            plugin_object=mock_tool_plugin,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'inactive_p... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'inactive_p... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:674: ValidationError
_______________ TestPluginManager.test_health_check_all_plugins ________________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf4c470>

    @pytest.mark.asyncio
    async def test_health_check_all_plugins(self):
        """Test health check for all plugins."""
    
        # Create mock plugins with health checks
        mock_plugin1 = MagicMock()
        mock_plugin1.health_check = AsyncMock(return_value={"status": "healthy"})
    
        mock_plugin2 = MagicMock()
        mock_plugin2.health_check = AsyncMock(return_value={"status": "degraded", "issues": ["slow response"]})
    
>       plugin1 = PluginInstance(
            plugin_id="plugin1",
            name="Plugin 1",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=mock_plugin1,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'plugin1', ... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'plugin1', ... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:703: ValidationError
_______________ TestPluginManager.test_health_check_plugin_error _______________

self = <tests.test_plugins.TestPluginManager object at 0x7f59acf4c710>

    @pytest.mark.asyncio
    async def test_health_check_plugin_error(self):
        """Test health check when plugin health check fails."""
    
        mock_plugin = MagicMock()
        mock_plugin.health_check = AsyncMock(side_effect=Exception("Health check failed"))
    
>       plugin = PluginInstance(
            plugin_id="error_plugin",
            name="Error Plugin",
            plugin_type=PluginType.TOOL,
            status=PluginStatus.ACTIVE,
            plugin_object=mock_plugin,
            config={},
            created_at="2024-01-01T00:00:00Z",
            updated_at="2024-01-01T00:00:00Z"
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for PluginInstance
E       manifest
E         Field required [type=missing, input_value={'plugin_id': 'error_plug... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       installation_path
E         Field required [type=missing, input_value={'plugin_id': 'error_plug... '2024-01-01T00:00:00Z'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests/test_plugins.py:743: ValidationError
_________________ TestPluginIntegration.test_plugin_lifecycle __________________

self = <tests.test_plugins.TestPluginIntegration object at 0x7f59acf4c9b0>

        @pytest.mark.asyncio
        async def test_plugin_lifecycle(self):
            """Test complete plugin lifecycle: load, activate, health check, unload."""
    
            # Create a temporary plugin file
            plugin_code = '''
    from chatter.services.plugins import ToolPlugin
    
    class LifecycleTestPlugin(ToolPlugin):
        def __init__(self, config=None):
            super().__init__(config)
            self.initialized = False
            self.cleaned_up = False
    
        async def initialize(self):
            self.initialized = True
    
        async def cleanup(self):
            self.cleaned_up = True
    
        async def health_check(self):
            return {
                "status": "healthy" if self.initialized and not self.cleaned_up else "error",
                "initialized": self.initialized,
                "cleaned_up": self.cleaned_up
            }
    
        def get_tools(self):
            from tests.test_plugins import MockBaseTool
            return [MockBaseTool("lifecycle_tool", "Test tool for lifecycle")]
    
    plugin_class = LifecycleTestPlugin
    '''
    
            with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
                f.write(plugin_code)
                plugin_file = Path(f.name)
    
            try:
                # Load plugin
>               plugin_instance = await self.plugin_manager.load_plugin_from_file(
                                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                    plugin_file, "lifecycle_plugin", {}
                )
E               AttributeError: 'PluginManager' object has no attribute 'load_plugin_from_file'

tests/test_plugins.py:811: AttributeError
____________ TestPluginIntegration.test_multiple_plugins_management ____________

self = <tests.test_plugins.TestPluginIntegration object at 0x7f59acf27d10>

        @pytest.mark.asyncio
        async def test_multiple_plugins_management(self):
            """Test managing multiple plugins simultaneously."""
    
            # Create multiple plugin files
            plugin_codes = {
                "plugin1": '''
    from chatter.services.plugins import ToolPlugin
    
    class Plugin1(ToolPlugin):
        async def initialize(self):
            pass
    
        async def cleanup(self):
            pass
    
        async def health_check(self):
            return {"status": "healthy", "plugin": "plugin1"}
    
        def get_tools(self):
            from tests.test_plugins import MockBaseTool
            return [MockBaseTool("plugin1_tool", "Tool from plugin 1")]
    
    plugin_class = Plugin1
    ''',
                "plugin2": '''
    from chatter.services.plugins import ToolPlugin
    
    class Plugin2(ToolPlugin):
        async def initialize(self):
            pass
    
        async def cleanup(self):
            pass
    
        async def health_check(self):
            return {"status": "healthy", "plugin": "plugin2"}
    
        def get_tools(self):
            from tests.test_plugins import MockBaseTool
            return [MockBaseTool("plugin2_tool", "Tool from plugin 2")]
    
    plugin_class = Plugin2
    '''
            }
    
            plugin_files = []
            try:
                # Create and load plugins
                for plugin_name, plugin_code in plugin_codes.items():
                    with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
                        f.write(plugin_code)
                        plugin_file = Path(f.name)
                        plugin_files.append(plugin_file)
    
>                   plugin_instance = await self.plugin_manager.load_plugin_from_file(
                                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                        plugin_file, plugin_name, {}
                    )
E                   AttributeError: 'PluginManager' object has no attribute 'load_plugin_from_file'

tests/test_plugins.py:897: AttributeError
___________ TestProfilesIntegration.test_profile_complete_lifecycle ____________

self = <tests.test_profiles_integration.TestProfilesIntegration object at 0x7f59acf4d940>
client = <httpx.AsyncClient object at 0x7f595a225790>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxNTVBTllZUlZEUjNWQVJLOTlGUCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODYyMX0.5QNWE-p0DE4_08WtOlR6QYjBDCaNhT7ilmWThk0rtPs'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f595a7d8320>

    @pytest.mark.integration
    async def test_profile_complete_lifecycle(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complete profile lifecycle from creation to deletion."""
        # Create profile
        profile_data = {
            "name": "Integration Test Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-3.5-turbo",
            "description": "Profile for integration testing",
            "temperature": 0.7,
            "max_tokens": 1500,
            "system_message": "You are a helpful assistant.",
            "profile_type": "chat"
        }
    
>       create_response = await client.post("/api/v1/profiles/", json=profile_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_integration.py:27: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5110' coro=<TestProfilesIntegration.test_profile_complete_lifecycle() running at /home/yam/chatter/tests/test_profiles_integration.py:27> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________ TestProfilesIntegration.test_profile_list_and_filter _____________

self = <tests.test_profiles_integration.TestProfilesIntegration object at 0x7f59acf4dc70>
client = <httpx.AsyncClient object at 0x7f595a165430>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxNVpaTVM1VDdZS0hYTUtIRjFWWiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODYyMn0.wrbvHjPLe76bFYXBUmLVnJGSoe6EP7xpGrUXbEOMl-Q'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f595a2871a0>

    @pytest.mark.integration
    async def test_profile_list_and_filter(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test profile listing and filtering functionality."""
        # Create profiles with different providers
        profiles_to_create = [
            {
                "name": "OpenAI Profile",
                "llm_provider": "openai",
                "llm_model": "gpt-3.5-turbo",
                "temperature": 0.7
            },
            {
                "name": "Anthropic Profile",
                "llm_provider": "anthropic",
                "llm_model": "claude-3-sonnet",
                "temperature": 0.5
            },
            {
                "name": "Another OpenAI Profile",
                "llm_provider": "openai",
                "llm_model": "gpt-4",
                "temperature": 0.9
            }
        ]
    
        created_profile_ids = []
    
        for profile_data in profiles_to_create:
>           response = await client.post("/api/v1/profiles/", json=profile_data, headers=auth_headers)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_integration.py:126: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5124' coro=<TestProfilesIntegration.test_profile_list_and_filter() running at /home/yam/chatter/tests/test_profiles_integration.py:126> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
___________ TestProfilesIntegration.test_profile_stats_and_providers ___________

self = <tests.test_profiles_integration.TestProfilesIntegration object at 0x7f59acf4e030>
client = <httpx.AsyncClient object at 0x7f5959fad220>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxNlQxTjlaWU0xVjZEWTQ2NDEyTiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODYyMn0.-AFkbhPoM2ofXh6FbhqcXHxnZUf6PptVgjX4nkqYylo'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f59596c7cb0>

    @pytest.mark.integration
    async def test_profile_stats_and_providers(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test profile statistics and provider information."""
        # Get initial stats
>       stats_response = await client.get("/api/v1/profiles/stats/overview", headers=auth_headers)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_integration.py:160: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5138' coro=<TestProfilesIntegration.test_profile_stats_and_providers() running at /home/yam/chatter/tests/test_profiles_integration.py:160> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________ TestProfilesIntegration.test_profile_error_scenarios _____________

self = <tests.test_profiles_integration.TestProfilesIntegration object at 0x7f59acf4e3f0>
client = <httpx.AsyncClient object at 0x7f595a9866f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxOFpTUzdROERRTlpNMk1IV0tZTSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODYyNX0.Tk7uwfYqIVPNkTPUddW0KMxnvWg69Y_RqMRfqQ_9J2g'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f5959fcbb60>

    @pytest.mark.integration
    async def test_profile_error_scenarios(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test profile error handling scenarios."""
        # Test non-existent profile operations
        nonexistent_id = "nonexistent-profile-id"
    
        operations = [
            ("GET", f"/api/v1/profiles/{nonexistent_id}"),
            ("PUT", f"/api/v1/profiles/{nonexistent_id}"),
            ("DELETE", f"/api/v1/profiles/{nonexistent_id}"),
            ("POST", f"/api/v1/profiles/{nonexistent_id}/test"),
            ("POST", f"/api/v1/profiles/{nonexistent_id}/clone"),
        ]
    
        for method, url in operations:
            if method == "GET":
>               response = await client.get(url, headers=auth_headers)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_integration.py:225: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5152' coro=<TestProfilesIntegration.test_profile_error_scenarios() running at /home/yam/chatter/tests/test_profiles_integration.py:225> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________ TestProfilesIntegration.test_profile_data_validation _____________

self = <tests.test_profiles_integration.TestProfilesIntegration object at 0x7f59acf4e7b0>
client = <httpx.AsyncClient object at 0x7f595b20fa40>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxOVNWN0IxRlJFUENXSzBFM0pQWSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODYyNX0.ATtYb6nubcNdyIXqHa4uHhL7QTujfeJ-ocT0XGzI5YY'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f595a9cea20>

    @pytest.mark.integration
    async def test_profile_data_validation(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test profile data validation in integration environment."""
        # Test invalid provider
        invalid_provider_data = {
            "name": "Invalid Provider Profile",
            "llm_provider": "nonexistent_provider_xyz",
            "llm_model": "some-model"
        }
    
>       response = await client.post("/api/v1/profiles/", json=invalid_provider_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_integration.py:246: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5166' coro=<TestProfilesIntegration.test_profile_data_validation() running at /home/yam/chatter/tests/test_profiles_integration.py:246> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
__________ TestProfilesIntegration.test_profile_concurrent_operations __________

self = <tests.test_profiles_integration.TestProfilesIntegration object at 0x7f59acf4e510>
client = <httpx.AsyncClient object at 0x7f595aeb5460>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxQUtQUjlEMjgzUVM0VzZDWktSUCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODYyNn0.m6_b-WXxWP5q2rYl-Y_PuFS93ghKVyfGxh4GW1EghYY'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f595b2dacf0>

    @pytest.mark.integration
    async def test_profile_concurrent_operations(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test concurrent profile operations."""
        # Create multiple profiles concurrently
        profile_data_list = [
            {
                "name": f"Concurrent Profile {i}",
                "llm_provider": "openai",
                "llm_model": "gpt-3.5-turbo",
                "temperature": 0.5 + (i * 0.1)
            }
            for i in range(5)
        ]
    
        # Create tasks for concurrent profile creation
        create_tasks = [
            asyncio.create_task(client.post("/api/v1/profiles/", json=profile_data, headers=auth_headers))
            for profile_data in profile_data_list
        ]
    
        # Wait for all creations
>       create_responses = await asyncio.gather(*create_tasks)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_integration.py:290: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5181' coro=<AsyncClient.post() running at /home/yam/.local/lib/python3.12/site-packages/httpx/_client.py:1859> cb=[gather.<locals>._done_callback() at /usr/lib64/python3.12/asyncio/tasks.py:767]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
__________ TestProfilesIntegration.test_profile_complex_data_handling __________

self = <tests.test_profiles_integration.TestProfilesIntegration object at 0x7f59acf4d2e0>
client = <httpx.AsyncClient object at 0x7f59604cbcb0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxQkVEVzdZTjhWTTg1VzBIVkgwWSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODYyN30.a0D4HKVCJwmzNdE-HFmQ5kqO2KIu_gUQ3LIAbR7YyWI'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f595a675160>

    @pytest.mark.integration
    async def test_profile_complex_data_handling(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test complex profile data handling."""
        # Create profile with complex configuration
        complex_profile_data = {
            "name": "Complex Configuration Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-4",
            "description": "A profile with complex configuration for testing data integrity",
            "temperature": 0.75,
            "max_tokens": 2048,
            "top_p": 0.9,
            "frequency_penalty": 0.1,
            "presence_penalty": 0.2,
            "system_message": "You are an expert assistant with deep knowledge in multiple domains. Provide detailed, accurate, and helpful responses.",
            "profile_type": "chat",
            "custom_parameters": {
                "context_window": 4096,
                "response_format": "json",
                "safety_level": "moderate",
                "custom_instructions": [
                    "Always be helpful and accurate",
                    "Provide sources when possible",
                    "Be concise but complete"
                ]
            }
        }
    
        # Create profile
>       create_response = await client.post("/api/v1/profiles/", json=complex_profile_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_integration.py:360: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5199' coro=<TestProfilesIntegration.test_profile_complex_data_handling() running at /home/yam/chatter/tests/test_profiles_integration.py:360> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
__________ TestProfilesIntegration.test_profile_testing_functionality __________

self = <tests.test_profiles_integration.TestProfilesIntegration object at 0x7f59acf4cbf0>
client = <httpx.AsyncClient object at 0x7f595aafa360>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxQzhNQkFEUEs1VldKSFdUSkZaSCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODYyOH0.03ZlnFtttVpEd0gRHqmiRoLj55JZRHyVUw-gP_BniOs'}
db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x7f595b088f80>

    @pytest.mark.integration
    async def test_profile_testing_functionality(self, client: AsyncClient, auth_headers: dict, db_session: AsyncSession):
        """Test profile testing functionality end-to-end."""
        # Create a test profile
        profile_data = {
            "name": "Testing Functionality Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-3.5-turbo",
            "temperature": 0.7,
            "system_message": "You are a test assistant."
        }
    
>       create_response = await client.post("/api/v1/profiles/", json=profile_data, headers=auth_headers)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_integration.py:416: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5213' coro=<TestProfilesIntegration.test_profile_testing_functionality() running at /home/yam/chatter/tests/test_profiles_integration.py:416> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______________ TestProfilesUnit.test_create_profile_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f595a0e2450>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f595a0e2450>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf74590>
client = <httpx.AsyncClient object at 0x7f595a0e1850>

    @pytest.mark.unit
    async def test_create_profile_requires_auth(self, client: AsyncClient):
        """Test that creating profile requires authentication."""
        profile_data = {
            "name": "Test Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-4"
        }
    
>       response = await client.post("/api/v1/profiles/", json=profile_data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:22: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f595a0e2450>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:53:49.099522Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m2301bf7a-e669-45cc-8e3c-a5e586f6c982[0m [36mstatus_code[0m=[35m401[0m
______________ TestProfilesUnit.test_list_profiles_requires_auth _______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5959a34710>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5959a34710>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf74890>
client = <httpx.AsyncClient object at 0x7f59599fbb00>

    @pytest.mark.unit
    async def test_list_profiles_requires_auth(self, client: AsyncClient):
        """Test that listing profiles requires authentication."""
>       response = await client.get("/api/v1/profiles")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:28: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5959a34710>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:53:49.471931Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35me71124f1-9b60-4c20-af42-205254e9629e[0m [36mstatus_code[0m=[35m401[0m
_______________ TestProfilesUnit.test_get_profile_requires_auth ________________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59595325d0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59595325d0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf4cfb0>
client = <httpx.AsyncClient object at 0x7f5959531ac0>

    @pytest.mark.unit
    async def test_get_profile_requires_auth(self, client: AsyncClient):
        """Test that getting specific profile requires authentication."""
>       response = await client.get("/api/v1/profiles/profile-id")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:34: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59595325d0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:53:49.843637Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mef28a79c-685f-4238-902d-f0543ee8ab59[0m [36mstatus_code[0m=[35m401[0m
______________ TestProfilesUnit.test_update_profile_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59582491f0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59582491f0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf74560>
client = <httpx.AsyncClient object at 0x7f5958248410>

    @pytest.mark.unit
    async def test_update_profile_requires_auth(self, client: AsyncClient):
        """Test that updating profile requires authentication."""
>       response = await client.put("/api/v1/profiles/profile-id", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:40: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1896: in put
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59582491f0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:53:50.223417Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mf650e51b-49f3-4f5f-baff-0e3dbc9b1080[0m [36mstatus_code[0m=[35m401[0m
______________ TestProfilesUnit.test_delete_profile_requires_auth ______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5958d2f410>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5958d2f410>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf74dd0>
client = <httpx.AsyncClient object at 0x7f5958d2e810>

    @pytest.mark.unit
    async def test_delete_profile_requires_auth(self, client: AsyncClient):
        """Test that deleting profile requires authentication."""
>       response = await client.delete("/api/v1/profiles/profile-id")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:46: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1966: in delete
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f5958d2f410>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:53:50.605002Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m4b02a4c6-13e4-4b39-b47e-10b9aeb4a1c8[0m [36mstatus_code[0m=[35m401[0m
_______________ TestProfilesUnit.test_test_profile_requires_auth _______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59586bd3d0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59586bd3d0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf75190>
client = <httpx.AsyncClient object at 0x7f59586bc740>

    @pytest.mark.unit
    async def test_test_profile_requires_auth(self, client: AsyncClient):
        """Test that testing profile requires authentication."""
>       response = await client.post("/api/v1/profiles/profile-id/test", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:52: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59586bd3d0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:53:50.978096Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35mce1ab946-9722-4f09-97e0-7485b15263f5[0m [36mstatus_code[0m=[35m401[0m
______________ TestProfilesUnit.test_clone_profile_requires_auth _______________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f595908b440>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f595908b440>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf75550>
client = <httpx.AsyncClient object at 0x7f595908a6c0>

    @pytest.mark.unit
    async def test_clone_profile_requires_auth(self, client: AsyncClient):
        """Test that cloning profile requires authentication."""
>       response = await client.post("/api/v1/profiles/profile-id/clone", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:58: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f595908b440>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:53:51.360184Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m80c7b413-fb11-452f-b07b-24817166800a[0m [36mstatus_code[0m=[35m401[0m
____________ TestProfilesUnit.test_get_profile_stats_requires_auth _____________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59599714c0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59599714c0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf75910>
client = <httpx.AsyncClient object at 0x7f5959970830>

    @pytest.mark.unit
    async def test_get_profile_stats_requires_auth(self, client: AsyncClient):
        """Test that getting profile stats requires authentication."""
>       response = await client.get("/api/v1/profiles/stats/overview")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:64: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59599714c0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:53:51.729163Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m7f494fa5-bbfb-4063-9794-329a403bfe4c[0m [36mstatus_code[0m=[35m401[0m
_________ TestProfilesUnit.test_get_available_providers_requires_auth __________

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59592874d0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
>           return await super().__call__(request)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

chatter/api/auth.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59592874d0>

    async def __call__(
        self, request: Request
    ) -> Optional[HTTPAuthorizationCredentials]:
        authorization = request.headers.get("Authorization")
        scheme, credentials = get_authorization_scheme_param(authorization)
        if not (authorization and scheme and credentials):
            if self.auto_error:
>               raise HTTPException(
                    status_code=HTTP_403_FORBIDDEN, detail="Not authenticated"
                )
E               fastapi.exceptions.HTTPException: 403: Not authenticated

../.local/lib/python3.12/site-packages/fastapi/security/http.py:308: HTTPException

The above exception was the direct cause of the following exception:

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf75cd0>
client = <httpx.AsyncClient object at 0x7f59592868a0>

    @pytest.mark.unit
    async def test_get_available_providers_requires_auth(self, client: AsyncClient):
        """Test that getting available providers requires authentication."""
>       response = await client.get("/api/v1/profiles/providers/available")
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:70: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:615: in solve_dependencies
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.api.auth.CustomHTTPBearer object at 0x7f5af02bc110>
request = <starlette.requests.Request object at 0x7f59592874d0>

    async def __call__(self, request: Request) -> HTTPAuthorizationCredentials:
        """Extract credentials and raise 401 for missing/invalid auth."""
        try:
            return await super().__call__(request)
        except Exception as e:
            # Convert any authentication failure to 401
>           raise AuthenticationError("Authentication credentials required") from e
E           chatter.core.exceptions.AuthenticationError: Authentication credentials required

chatter/api/auth.py:51: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    chatter.core.exceptions:exceptions.py:97 [2m2025-09-05T12:53:52.105710Z[0m [[31m[1merror    [0m] [1mAuthenticationError: Authentication credentials required[0m [[34m[1mchatter.core.exceptions[0m] [36mdetails[0m=[35mNone[0m [36merror_code[0m=[35mAUTHENTICATION_ERROR[0m [36merror_id[0m=[35m71a9da7e-8497-4b63-9ade-99de49eea378[0m [36mstatus_code[0m=[35m401[0m
_________________ TestProfilesUnit.test_create_profile_success _________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf76090>
mock_get_service = <AsyncMock name='get_profile_service' id='140021723785280'>
client = <httpx.AsyncClient object at 0x7f59597ed4c0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxR0NCVlMwUzJGQ0hNWVNQSDhLNyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODYzMn0.3Hz_iyUe1Fsb7DQLxyK6ZN3h1z_IFousUZIchv6Ztv0'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_create_profile_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful profile creation."""
        # Mock the profile service
        mock_service = AsyncMock()
        mock_profile = {
            "id": "profile-123",
            "name": "Test Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-4",
            "created_by": "testuser",
            "created_at": "2024-01-01T12:00:00Z",
            "updated_at": "2024-01-01T12:00:00Z"
        }
        mock_service.create_profile.return_value = mock_profile
        mock_get_service.return_value = mock_service
    
        profile_data = {
            "name": "Test Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-4",
            "description": "Test profile description",
            "temperature": 0.7,
            "max_tokens": 1000
        }
    
>       response = await client.post("/api/v1/profiles/", json=profile_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:100: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5344' coro=<TestProfilesUnit.test_create_profile_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
______________ TestProfilesUnit.test_create_profile_invalid_data _______________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf76480>
client = <httpx.AsyncClient object at 0x7f595cd097c0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxSk1FWEZIUTgxVjVCRUVBWlQ4VCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODYzNH0.x81IB8H5MHFvy0lb_qbcaaFGFZQlVU3uGiClW4i1omI'}

    @pytest.mark.unit
    async def test_create_profile_invalid_data(self, client: AsyncClient, auth_headers: dict):
        """Test profile creation with invalid data."""
        # Missing required fields
        profile_data = {
            "name": "Test Profile"
            # Missing llm_provider and llm_model
        }
    
>       response = await client.post("/api/v1/profiles/", json=profile_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:117: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5358' coro=<TestProfilesUnit.test_create_profile_invalid_data() running at /home/yam/chatter/tests/test_profiles_unit.py:117> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_______________ TestProfilesUnit.test_create_profile_rate_limit ________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf76840>
mock_get_rate_limiter = <MagicMock name='get_unified_rate_limiter' id='140021722709504'>
client = <httpx.AsyncClient object at 0x7f59590afda0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxS0YzQ1BSNFI2QTNGRzlQQkgySiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODYzNX0.2ZqrXQ6jypMUAkyTEQIw6OQWrKDuwkzsNoG2COqwMPg'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_unified_rate_limiter')
    async def test_create_profile_rate_limit(self, mock_get_rate_limiter, client: AsyncClient, auth_headers: dict):
        """Test profile creation rate limiting."""
        from chatter.utils.unified_rate_limiter import RateLimitExceeded
    
        # Mock rate limiter to raise exception
        mock_rate_limiter = AsyncMock()
>       mock_rate_limiter.check_rate_limit.side_effect = RateLimitExceeded(
            key="test_key",
            limit=5,
            window=300,
            current_count=6
        )
E       TypeError: RateLimitExceeded.__init__() got an unexpected keyword argument 'key'

tests/test_profiles_unit.py:128: TypeError
_________________ TestProfilesUnit.test_list_profiles_success __________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf76c00>
mock_get_service = <AsyncMock name='get_profile_service' id='140021719200160'>
client = <httpx.AsyncClient object at 0x7f5958d8a7b0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxS1RKRVdaVFRUSEo0RTA0RTZEQiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODYzNn0.657cbnaqUlcX3V_tnEYCJJ3Y-yC2BLajgmHUpa6AlVU'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_list_profiles_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful profile listing."""
        mock_service = AsyncMock()
        mock_profiles = [
            {
                "id": "profile-1",
                "name": "Profile 1",
                "llm_provider": "openai",
                "llm_model": "gpt-4",
                "created_at": "2024-01-01T12:00:00Z"
            },
            {
                "id": "profile-2",
                "name": "Profile 2",
                "llm_provider": "anthropic",
                "llm_model": "claude-3-opus",
                "created_at": "2024-01-01T13:00:00Z"
            }
        ]
    
        mock_service.list_profiles.return_value = {
            "profiles": mock_profiles,
            "total": 2,
            "page": 1,
            "per_page": 10
        }
        mock_get_service.return_value = mock_service
    
>       response = await client.get("/api/v1/profiles", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:175: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5386' coro=<TestProfilesUnit.test_list_profiles_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
__________________ TestProfilesUnit.test_get_profile_success ___________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf76fc0>
mock_get_service = <AsyncMock name='get_profile_service' id='140021730371648'>
client = <httpx.AsyncClient object at 0x7f5959ab78c0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxTU1TSEdOWjZZOTVHTlcwR01DTiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODYzN30.BCkmpFWn8gjzGW3oad4ltU_I9JvxPM8xuCNQV_KP6u4'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_get_profile_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful profile retrieval."""
        mock_service = AsyncMock()
        mock_profile = {
            "id": "profile-123",
            "name": "Test Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-4",
            "temperature": 0.7,
            "max_tokens": 1000,
            "created_at": "2024-01-01T12:00:00Z"
        }
    
        mock_service.get_profile.return_value = mock_profile
        mock_get_service.return_value = mock_service
    
>       response = await client.get("/api/v1/profiles/profile-123", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:200: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5400' coro=<TestProfilesUnit.test_get_profile_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_________________ TestProfilesUnit.test_get_profile_not_found __________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf77380>
mock_get_service = <AsyncMock name='get_profile_service' id='140021704022960'>
client = <httpx.AsyncClient object at 0x7f5957edc530>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxTkY4MzBON0FHSlg0MEU0MUU2SyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODYzN30.GvtGM4pRhHTCYHVrSIqNRZDMBCbr9BhudyrjRnkXBRY'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_get_profile_not_found(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test profile retrieval for non-existent profile."""
        mock_service = AsyncMock()
        mock_service.get_profile.side_effect = ProfileError("Profile not found")
        mock_get_service.return_value = mock_service
    
>       response = await client.get("/api/v1/profiles/nonexistent", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:216: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5414' coro=<TestProfilesUnit.test_get_profile_not_found() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_________________ TestProfilesUnit.test_update_profile_success _________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf77740>
mock_get_service = <AsyncMock name='get_profile_service' id='140021734626064'>
client = <httpx.AsyncClient object at 0x7f5959c0de80>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxUDlWR0NROUg5TUVaMlFWREs3SyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODYzOH0.7qhCrpz66FdtpPV42ITqz8DeNKbwsuvpLl3VN_Gd5to'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_update_profile_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful profile update."""
        mock_service = AsyncMock()
        mock_updated_profile = {
            "id": "profile-123",
            "name": "Updated Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-4",
            "temperature": 0.8,
            "updated_at": "2024-01-01T13:00:00Z"
        }
    
        mock_service.update_profile.return_value = mock_updated_profile
        mock_get_service.return_value = mock_service
    
        update_data = {
            "name": "Updated Profile",
            "temperature": 0.8
        }
    
>       response = await client.put("/api/v1/profiles/profile-123", json=update_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:241: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1896: in put
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5428' coro=<TestProfilesUnit.test_update_profile_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_________________ TestProfilesUnit.test_delete_profile_success _________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf77b00>
mock_get_service = <AsyncMock name='get_profile_service' id='140021725167392'>
client = <httpx.AsyncClient object at 0x7f59593078f0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxUTRNS01XUTNURzlCSkcxQ1dONSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODYzOX0.ZATvG0Q24653Tp0AXShW0qR-9SBaRZ4EXE6Xr8T3C1I'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_delete_profile_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful profile deletion."""
        mock_service = AsyncMock()
        mock_service.delete_profile.return_value = True
        mock_get_service.return_value = mock_service
    
>       response = await client.delete("/api/v1/profiles/profile-123", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:256: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1966: in delete
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5442' coro=<TestProfilesUnit.test_delete_profile_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
__________________ TestProfilesUnit.test_test_profile_success __________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf774d0>
mock_get_service = <AsyncMock name='get_profile_service' id='140021720005088'>
client = <httpx.AsyncClient object at 0x7f5958e1a5a0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxUVpYQVNCUzZEOEpLWE5COFNHUCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODY0MH0.XEPUu_FOQh2sAHVB4cUbVO0D4v-I41bu6PLz8GyzcDM'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_test_profile_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful profile testing."""
        mock_service = AsyncMock()
        mock_test_result = {
            "profile_id": "profile-123",
            "test_message": "Hello, World!",
            "response": "Hello! How can I assist you today?",
            "response_time": 1.25,
            "success": True
        }
    
        mock_service.test_profile.return_value = mock_test_result
        mock_get_service.return_value = mock_service
    
        test_data = {
            "message": "Hello, World!",
            "include_metrics": True
        }
    
>       response = await client.post("/api/v1/profiles/profile-123/test", json=test_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:284: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5456' coro=<TestProfilesUnit.test_test_profile_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_________________ TestProfilesUnit.test_clone_profile_success __________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf76780>
mock_get_service = <AsyncMock name='get_profile_service' id='140021736826608'>
client = <httpx.AsyncClient object at 0x7f5959e25280>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxUlQzNUQ4REs2OUVBM0dFQkpZMCIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODY0MX0.Q1CQELGjr_XIoP6c-6ls8zts4bWJ1bckYqVqf5LJ1Uw'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_clone_profile_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful profile cloning."""
        mock_service = AsyncMock()
        mock_cloned_profile = {
            "id": "cloned-profile-456",
            "name": "Cloned Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-4",
            "created_at": "2024-01-01T14:00:00Z"
        }
    
        mock_service.clone_profile.return_value = mock_cloned_profile
        mock_get_service.return_value = mock_service
    
        clone_data = {
            "name": "Cloned Profile",
            "include_settings": True
        }
    
>       response = await client.post("/api/v1/profiles/profile-123/clone", json=clone_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:312: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5470' coro=<TestProfilesUnit.test_clone_profile_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_______________ TestProfilesUnit.test_get_profile_stats_success ________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf75c40>
mock_get_service = <AsyncMock name='get_profile_service' id='140021672751280'>
client = <httpx.AsyncClient object at 0x7f595610b170>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxU01BMkVRUVAxRjQ0OVM4MTNSSyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODY0Mn0.sd26kcwEKEXEiGPW8e5dY3fFS4_yt0DSGb3RhU_4JFQ'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_get_profile_stats_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful profile stats retrieval."""
        mock_service = AsyncMock()
        mock_stats = {
            "total_profiles": 25,
            "profiles_by_provider": {
                "openai": 15,
                "anthropic": 8,
                "google": 2
            },
            "active_profiles": 20,
            "average_usage_per_profile": 45.5
        }
    
        mock_service.get_profile_stats.return_value = mock_stats
        mock_get_service.return_value = mock_service
    
>       response = await client.get("/api/v1/profiles/stats/overview", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:338: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5484' coro=<TestProfilesUnit.test_get_profile_stats_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestProfilesUnit.test_get_available_providers_success _____________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf74f50>
mock_get_service = <AsyncMock name='get_profile_service' id='140021697487712'>
client = <httpx.AsyncClient object at 0x7f59578a12b0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxVEVUN1pUSlMwS05BODZNR1hCRSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODY0Mn0.KEQIP6qwn_EFRLE3m0U0xmxvoIDT7Wylet5YVPR7b08'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_get_available_providers_success(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test successful available providers retrieval."""
        mock_service = AsyncMock()
        mock_providers = {
            "openai": {
                "models": ["gpt-4", "gpt-3.5-turbo", "gpt-4-turbo"],
                "supports_streaming": True,
                "max_tokens": 4096
            },
            "anthropic": {
                "models": ["claude-3-opus", "claude-3-sonnet", "claude-3-haiku"],
                "supports_streaming": True,
                "max_tokens": 8192
            }
        }
    
        mock_service.get_available_providers.return_value = mock_providers
        mock_get_service.return_value = mock_service
    
>       response = await client.get("/api/v1/profiles/providers/available", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:367: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5498' coro=<TestProfilesUnit.test_get_available_providers_success() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_____________ TestProfilesUnit.test_profile_service_error_handling _____________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf8c1a0>
mock_get_service = <AsyncMock name='get_profile_service' id='140021712397152'>
client = <httpx.AsyncClient object at 0x7f59586d8e00>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxV1E1NjZGM0MwTlFYMlI5RUtZTSIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODY0NX0.dExYa4ucA7gTA6u9VKW5jrsA-GO-tnNE9qUipjUMjkw'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_profile_service_error_handling(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test profile service error handling."""
        mock_service = AsyncMock()
        mock_service.create_profile.side_effect = Exception("Database error")
        mock_get_service.return_value = mock_service
    
        profile_data = {
            "name": "Test Profile",
            "llm_provider": "openai",
            "llm_model": "gpt-4"
        }
    
>       response = await client.post("/api/v1/profiles/", json=profile_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:389: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5512' coro=<TestProfilesUnit.test_profile_service_error_handling() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
_______________ TestProfilesUnit.test_profile_validation_errors ________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf8c290>
mock_get_service = <AsyncMock name='get_profile_service' id='140021685348416'>
client = <httpx.AsyncClient object at 0x7f5956bad100>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxWEhRNlQzOEhZMVo4V1lIQTRZQiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODY0Nn0.fQZzScTLGCxViChohtTz5cCulYvGH3skCHchjVY159Q'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_profile_validation_errors(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test profile data validation errors."""
        # Test invalid provider
        invalid_profile_data = {
            "name": "Test Profile",
            "llm_provider": "invalid_provider",
            "llm_model": "gpt-4"
        }
    
>       response = await client.post("/api/v1/profiles/", json=invalid_profile_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:403: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5526' coro=<TestProfilesUnit.test_profile_validation_errors() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
________________ TestProfilesUnit.test_list_profiles_filtering _________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf8c650>
mock_get_service = <AsyncMock name='get_profile_service' id='140021715789168'>
client = <httpx.AsyncClient object at 0x7f5958a152b0>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxWUNCVjUzTktRQlhYM0VRUEdONyIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODY0Nn0.jXU4QDFalAjWh5jrF2cvYETSEJ2CEP0wdk27_q1vnLU'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_list_profiles_filtering(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test profile listing with filters."""
        mock_service = AsyncMock()
        mock_service.list_profiles.return_value = {
            "profiles": [],
            "total": 0,
            "page": 1,
            "per_page": 10
        }
        mock_get_service.return_value = mock_service
    
        # Test with provider filter
>       response = await client.get("/api/v1/profiles?provider=openai", headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:430: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1768: in get
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5540' coro=<TestProfilesUnit.test_list_profiles_filtering() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
________________ TestProfilesUnit.test_test_profile_rate_limit _________________

self = <tests.test_profiles_unit.TestProfilesUnit object at 0x7f59acf8ca40>
mock_get_service = <AsyncMock name='get_profile_service' id='140021684206960'>
client = <httpx.AsyncClient object at 0x7f5956bf7e00>
auth_headers = {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwMUs0Q1oxWjZYVkoxVzhUS1BBQ1BDR1c0TiIsImVtYWl...9ucyI6WyJyZWFkOnByb2ZpbGUiLCJ3cml0ZTpwcm9maWxlIl0sImV4cCI6MTc1NzA3ODY0N30.pBPAMJCR-1ng4loGN0AUNFzhB0rIg1DSRRFrk4_2Qnk'}

    @pytest.mark.unit
    @patch('chatter.api.profiles.get_profile_service')
    async def test_test_profile_rate_limit(self, mock_get_service, client: AsyncClient, auth_headers: dict):
        """Test profile testing rate limiting."""
        # This would test rate limiting on profile testing if implemented
        mock_service = AsyncMock()
        mock_service.test_profile.return_value = {
            "success": True,
            "response": "Test response"
        }
        mock_get_service.return_value = mock_service
    
        test_data = {"message": "Test message"}
    
>       response = await client.post("/api/v1/profiles/profile-123/test", json=test_data, headers=auth_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_profiles_unit.py:452: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/httpx/_client.py:1859: in post
    return await self.request(
../.local/lib/python3.12/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:736: in app
    await route.handle(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:290: in handle
    await self.app(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
../.local/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
../.local/lib/python3.12/site-packages/starlette/routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/routing.py:292: in app
    solved_result = await solve_dependencies(
../.local/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/api/auth.py:99: in get_current_user
    return await auth_service.get_current_user(credentials.credentials)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:683: in get_current_user
    user = await self.get_user_by_id(user_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
chatter/core/auth.py:281: in get_user_by_id
    result = await self.session.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
../.local/lib/python3.12/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
../.local/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2358: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
../.local/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
../.local/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:580: in execute
    self._adapt_connection.await_(
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:558: in _prepare_and_execute
    self._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:508: in _handle_exception
    self._adapt_connection._handle_exception(error)
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:794: in _handle_exception
    raise error
../.local/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py:545: in _prepare_and_execute
    self._rows = deque(await prepared_stmt.fetch(*parameters))
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:176: in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:267: in __bind_execute
    data, status, _ = await self.__do_execute(
../.local/lib/python3.12/site-packages/asyncpg/prepared_stmt.py:256: in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

>   ???
E   RuntimeError: Task <Task pending name='Task-5554' coro=<TestProfilesUnit.test_test_profile_rate_limit() running at /usr/lib64/python3.12/unittest/mock.py:1413> cb=[_run_until_complete_cb() at /usr/lib64/python3.12/asyncio/base_events.py:181, WorkerThread.stop()]> got Future <Future pending cb=[BaseProtocol._on_waiter_completed()]> attached to a different loop

asyncpg/protocol/protocol.pyx:206: RuntimeError
____________ TestStreamingEvent.test_streaming_event_data_creation _____________

self = <tests.test_streaming.TestStreamingEvent object at 0x7f59acef8440>

    def test_streaming_event_data_creation(self):
        """Test creating StreamingEvent."""
>       event_data = StreamingEvent(
            event_type=StreamingEventType.TOKEN,
            content="Hello",
            metadata={"token_id": 123},
            timestamp=1234567890.0
        )
E       TypeError: StreamingEvent.__init__() got an unexpected keyword argument 'event_type'

tests/test_streaming.py:45: TypeError
_____________ TestStreamingEvent.test_streaming_event_data_minimal _____________

self = <tests.test_streaming.TestStreamingEvent object at 0x7f59acef85c0>

    def test_streaming_event_data_minimal(self):
        """Test creating StreamingEvent with minimal fields."""
>       event_data = StreamingEvent(
            event_type=StreamingEventType.START
        )
E       TypeError: StreamingEvent.__init__() got an unexpected keyword argument 'event_type'

tests/test_streaming.py:59: TypeError
_________ TestStreamingEvent.test_streaming_event_data_auto_timestamp __________

self = <tests.test_streaming.TestStreamingEvent object at 0x7f59acef87a0>

    def test_streaming_event_data_auto_timestamp(self):
        """Test that timestamp is automatically set if not provided."""
        before = time.time()
>       event_data = StreamingEvent(
            event_type=StreamingEventType.COMPLETE
        )
E       TypeError: StreamingEvent.__init__() got an unexpected keyword argument 'event_type'

tests/test_streaming.py:71: TypeError
__________ TestStreamingEvent.test_streaming_event_data_with_metadata __________

self = <tests.test_streaming.TestStreamingEvent object at 0x7f59acef8980>

    def test_streaming_event_data_with_metadata(self):
        """Test StreamingEvent with complex metadata."""
        metadata = {
            "tool_name": "calculator",
            "input": {"a": 1, "b": 2},
            "result": {"sum": 3},
            "execution_time": 0.5
        }
    
>       event_data = StreamingEvent(
            event_type=StreamingEventType.TOOL_CALL_END,
            content="Tool execution completed",
            metadata=metadata
        )
E       TypeError: StreamingEvent.__init__() got an unexpected keyword argument 'event_type'

tests/test_streaming.py:87: TypeError
_____________________ TestStreamingService.test_end_stream _____________________

self = <tests.test_streaming.TestStreamingService object at 0x7f59acef9bb0>
mock_record_metrics = <MagicMock name='record_workflow_metrics' id='140021669202784'>

    @pytest.mark.asyncio
    @patch('chatter.services.streaming.record_workflow_metrics')
    async def test_end_stream(self, mock_record_metrics):
        """Test ending a stream and getting metrics."""
        stream_id = "end_test_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        # Simulate some activity
        self.service.active_streams[stream_id]["token_count"] = 100
        self.service.active_streams[stream_id]["event_count"] = 10
    
        # Wait a bit to have measurable duration
        await asyncio.sleep(0.01)
    
        # End stream
        metrics = await self.service.end_stream(stream_id)
    
        assert metrics["total_duration"] > 0
        assert metrics["tokens_per_second"] > 0
        assert metrics["events_per_second"] > 0
        assert stream_id not in self.service.active_streams
>       assert stream_id not in self.stream_metrics
                                ^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'TestStreamingService' object has no attribute 'stream_metrics'

tests/test_streaming.py:223: AttributeError
_________________ TestStreamingService.test_stream_event_basic _________________

self = <tests.test_streaming.TestStreamingService object at 0x7f59acef9700>

    @pytest.mark.asyncio
    async def test_stream_event_basic(self):
        """Test streaming a basic event."""
        stream_id = "event_test_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        # Create async generator for streaming
        async def stream_events():
            event_data = StreamingEvent(
                event_type=StreamingEventType.TOKEN,
                content="Hello",
                metadata={"token_id": 1}
            )
    
            async for chunk in self.service.stream_event(stream_id, event_data):
                yield chunk
    
        # Collect streamed events
        events = []
>       async for event in stream_events():

tests/test_streaming.py:259: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    async def stream_events():
>       event_data = StreamingEvent(
            event_type=StreamingEventType.TOKEN,
            content="Hello",
            metadata={"token_id": 1}
        )
E       TypeError: StreamingEvent.__init__() got an unexpected keyword argument 'event_type'

tests/test_streaming.py:248: TypeError
____________________ TestStreamingService.test_stream_token ____________________

self = <tests.test_streaming.TestStreamingService object at 0x7f59acef8ce0>

    @pytest.mark.asyncio
    async def test_stream_token(self):
        """Test streaming a token event."""
        stream_id = "token_test_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="chat_completion"
        )
    
        token_content = "world"
    
        # Stream token
        events = []
>       async for chunk in self.service.stream_token(stream_id, token_content):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:283: AttributeError
_____________ TestStreamingService.test_stream_tool_call_lifecycle _____________

self = <tests.test_streaming.TestStreamingService object at 0x7f59acef82f0>

    @pytest.mark.asyncio
    async def test_stream_tool_call_lifecycle(self):
        """Test complete tool call streaming lifecycle."""
        stream_id = "tool_call_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="tool_execution"
        )
    
        tool_name = "calculator"
        tool_input = {"operation": "add", "a": 5, "b": 3}
        tool_result = {"result": 8}
    
        # Stream tool call start
        start_events = []
>       async for chunk in self.service.stream_tool_call_start(stream_id, tool_name, tool_input):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_tool_call_start'

tests/test_streaming.py:313: AttributeError
__________________ TestStreamingService.test_stream_thinking ___________________

self = <tests.test_streaming.TestStreamingService object at 0x7f59acef9fa0>

    @pytest.mark.asyncio
    async def test_stream_thinking(self):
        """Test streaming thinking event."""
        stream_id = "thinking_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="reasoning"
        )
    
        thinking_content = "Let me analyze this problem..."
    
        # Stream thinking
        events = []
>       async for chunk in self.service.stream_thinking(stream_id, thinking_content):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_thinking'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:344: AttributeError
________________ TestStreamingService.test_stream_source_found _________________

self = <tests.test_streaming.TestStreamingService object at 0x7f59acefa240>

    @pytest.mark.asyncio
    async def test_stream_source_found(self):
        """Test streaming source found event."""
        stream_id = "source_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="document_search"
        )
    
        source_info = {
            "title": "Test Document",
            "url": "https://example.com/doc",
            "relevance": 0.95
        }
    
        # Stream source found
        events = []
>       async for chunk in self.service.stream_source_found(stream_id, source_info):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_source_found'

tests/test_streaming.py:368: AttributeError
____________________ TestStreamingService.test_stream_error ____________________

self = <tests.test_streaming.TestStreamingService object at 0x7f59acefa4e0>

    @pytest.mark.asyncio
    async def test_stream_error(self):
        """Test streaming error event."""
        stream_id = "error_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        error_message = "Test error occurred"
        error_details = {"error_code": "TEST_001", "retry": False}
    
        # Stream error
        events = []
>       async for chunk in self.service.stream_error(stream_id, error_message, error_details):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_error'

tests/test_streaming.py:389: AttributeError
__________________ TestStreamingService.test_stream_complete ___________________

self = <tests.test_streaming.TestStreamingService object at 0x7f59acefa780>

    @pytest.mark.asyncio
    async def test_stream_complete(self):
        """Test streaming completion event."""
        stream_id = "complete_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        final_result = {"status": "success", "total_tokens": 150}
    
        # Stream completion
        events = []
>       async for chunk in self.service.stream_complete(stream_id, final_result):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_complete'

tests/test_streaming.py:413: AttributeError
__________________ TestStreamingService.test_stream_metadata ___________________

self = <tests.test_streaming.TestStreamingService object at 0x7f59acefaa20>

    @pytest.mark.asyncio
    async def test_stream_metadata(self):
        """Test streaming metadata event."""
        stream_id = "metadata_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        metadata = {
            "model": "gpt-4",
            "temperature": 0.7,
            "max_tokens": 500
        }
    
        # Stream metadata
        events = []
>       async for chunk in self.service.stream_metadata(stream_id, metadata):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_metadata'. Did you mean: 'stream_metrics'?

tests/test_streaming.py:437: AttributeError
_________________ TestStreamingService.test_get_stream_metrics _________________

self = <tests.test_streaming.TestStreamingService object at 0x7f59acefacc0>

    @pytest.mark.asyncio
    async def test_get_stream_metrics(self):
        """Test getting stream metrics."""
        stream_id = "metrics_stream"
    
        # Create stream
        await self.service.create_stream(
            stream_id=stream_id,
            workflow_type="test_workflow"
        )
    
        # Simulate some activity
        self.service.active_streams[stream_id]["token_count"] = 50
        self.service.active_streams[stream_id]["event_count"] = 5
    
        # Get metrics
>       metrics = self.service.get_stream_metrics(stream_id)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'get_stream_metrics'. Did you mean: 'stream_metrics'?

tests/test_streaming.py:458: AttributeError
___________ TestStreamingService.test_get_nonexistent_stream_metrics ___________

self = <tests.test_streaming.TestStreamingService object at 0x7f59acefaf60>

    @pytest.mark.asyncio
    async def test_get_nonexistent_stream_metrics(self):
        """Test getting metrics for nonexistent stream."""
>       metrics = self.service.get_stream_metrics("nonexistent")
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'get_stream_metrics'. Did you mean: 'stream_metrics'?

tests/test_streaming.py:468: AttributeError
________________ TestStreamingService.test_list_active_streams _________________

self = <tests.test_streaming.TestStreamingService object at 0x7f59acefb200>

    @pytest.mark.asyncio
    async def test_list_active_streams(self):
        """Test listing active streams."""
        # Initially no streams
>       streams = self.service.list_active_streams()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'list_active_streams'. Did you mean: 'active_streams'?

tests/test_streaming.py:476: AttributeError
__________________ TestStreamingService.test_is_stream_active __________________

self = <tests.test_streaming.TestStreamingService object at 0x7f59acefb4a0>

    @pytest.mark.asyncio
    async def test_is_stream_active(self):
        """Test checking if stream is active."""
        stream_id = "active_check_stream"
    
        # Stream doesn't exist
>       assert self.service.is_stream_active(stream_id) is False
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'is_stream_active'

tests/test_streaming.py:494: AttributeError
______________ TestStreamingService.test_stream_activity_tracking ______________

self = <tests.test_streaming.TestStreamingService object at 0x7f59acefb740>

    @pytest.mark.asyncio
    async def test_stream_activity_tracking(self):
        """Test that stream activity is properly tracked."""
        stream_id = "activity_stream"
    
        # Create stream
        await self.service.create_stream(stream_id, "test_workflow")
    
        initial_activity = self.service.active_streams[stream_id]["last_activity"]
    
        # Wait a bit
        await asyncio.sleep(0.01)
    
        # Stream a token (should update last_activity)
>       async for _ in self.service.stream_token(stream_id, "test"):
                       ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:522: AttributeError
________ TestStreamingService.test_stream_error_handling_invalid_stream ________

self = <tests.test_streaming.TestStreamingService object at 0x7f59acefb9e0>

    @pytest.mark.asyncio
    async def test_stream_error_handling_invalid_stream(self):
        """Test error handling when streaming to invalid stream."""
        with pytest.raises(StreamingError):
>           async for _ in self.service.stream_token("invalid_stream", "test"):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^
E           AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:533: AttributeError
_________________ TestStreamingService.test_concurrent_streams _________________

self = <tests.test_streaming.TestStreamingService object at 0x7f59acefbc80>

    @pytest.mark.asyncio
    async def test_concurrent_streams(self):
        """Test handling multiple concurrent streams."""
        stream_ids = ["concurrent1", "concurrent2", "concurrent3"]
    
        # Create multiple streams concurrently
        create_tasks = [
            self.service.create_stream(stream_id, f"workflow_{i}")
            for i, stream_id in enumerate(stream_ids)
        ]
        await asyncio.gather(*create_tasks)
    
        # Verify all streams are active
        for stream_id in stream_ids:
>           assert self.service.is_stream_active(stream_id)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           AttributeError: 'StreamingService' object has no attribute 'is_stream_active'

tests/test_streaming.py:550: AttributeError
______________ TestStreamingService.test_stream_cleanup_on_error _______________

self = <tests.test_streaming.TestStreamingService object at 0x7f59acefbf20>

    @pytest.mark.asyncio
    async def test_stream_cleanup_on_error(self):
        """Test stream cleanup when errors occur."""
        stream_id = "cleanup_stream"
    
        # Create stream
        await self.service.create_stream(stream_id, "test_workflow")
    
        # Simulate an error during streaming
>       with patch.object(self.service, 'stream_event', side_effect=StreamingError("Test error")):
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_streaming.py:574: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7f5955da9040>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <chatter.services.streaming.StreamingService object at 0x7f5955da8bc0> does not have the attribute 'stream_event'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
_______ TestStreamingServiceIntegration.test_complete_streaming_workflow _______

self = <tests.test_streaming.TestStreamingServiceIntegration object at 0x7f59acefb500>

    @pytest.mark.asyncio
    async def test_complete_streaming_workflow(self):
        """Test complete streaming workflow from start to finish."""
        stream_id = "complete_workflow_stream"
        workflow_type = "chat_completion"
    
        # 1. Create stream
        await self.service.create_stream(stream_id, workflow_type)
>       assert self.service.is_stream_active(stream_id)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'is_stream_active'

tests/test_streaming.py:599: AttributeError
_________ TestStreamingServiceIntegration.test_error_recovery_workflow _________

self = <tests.test_streaming.TestStreamingServiceIntegration object at 0x7f59acefb110>

    @pytest.mark.asyncio
    async def test_error_recovery_workflow(self):
        """Test streaming workflow with error recovery."""
        stream_id = "error_recovery_stream"
    
        # Create stream
        await self.service.create_stream(stream_id, "error_recovery_test")
    
        # Stream some successful events
>       async for _ in self.service.stream_token(stream_id, "Success"):
                       ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:659: AttributeError
_ TestStreamingServiceIntegration.test_performance_with_high_volume_streaming __

self = <tests.test_streaming.TestStreamingServiceIntegration object at 0x7f59acefaa50>

    @pytest.mark.asyncio
    async def test_performance_with_high_volume_streaming(self):
        """Test streaming performance with high volume of events."""
        stream_id = "high_volume_stream"
    
        # Create stream
        await self.service.create_stream(stream_id, "performance_test")
    
        # Stream many tokens quickly
        start_time = time.time()
    
        for i in range(100):  # Stream 100 tokens
>           async for _ in self.service.stream_token(stream_id, f"token_{i}"):
                           ^^^^^^^^^^^^^^^^^^^^^^^^^
E           AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:697: AttributeError
____________ TestStreamingServiceIntegration.test_stream_isolation _____________

self = <tests.test_streaming.TestStreamingServiceIntegration object at 0x7f59acefa540>

    @pytest.mark.asyncio
    async def test_stream_isolation(self):
        """Test that streams are properly isolated from each other."""
        stream1_id = "isolation_stream_1"
        stream2_id = "isolation_stream_2"
    
        # Create two streams
        await self.service.create_stream(stream1_id, "workflow1")
        await self.service.create_stream(stream2_id, "workflow2")
    
        # Stream different content to each
>       async for _ in self.service.stream_token(stream1_id, "stream1_content"):
                       ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'StreamingService' object has no attribute 'stream_token'. Did you mean: 'stream_tokens'?

tests/test_streaming.py:722: AttributeError
____________ TestAPIVersion.test_api_version_string_representation _____________

self = <tests.test_versioning.TestAPIVersion object at 0x7f59acd93530>

    def test_api_version_string_representation(self):
        """Test API version string representation."""
>       assert str(APIVersion.V1) == "v1"
E       AssertionError: assert 'APIVersion.V1' == 'v1'
E         
E         - v1
E         + APIVersion.V1

tests/test_versioning.py:27: AssertionError
_________________ TestVersionStatus.test_version_status_values _________________

self = <tests.test_versioning.TestVersionStatus object at 0x7f59acd91af0>

    def test_version_status_values(self):
        """Test version status enum values."""
        assert VersionStatus.ACTIVE == "active"
>       assert VersionStatus.DEPRECATED == "deprecated"
               ^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: type object 'VersionStatus' has no attribute 'DEPRECATED'

tests/test_versioning.py:37: AttributeError
______________ TestVersionStatus.test_version_status_progression _______________

self = <tests.test_versioning.TestVersionStatus object at 0x7f59acd91250>

    def test_version_status_progression(self):
        """Test logical version status progression."""
>       statuses = [VersionStatus.ACTIVE, VersionStatus.DEPRECATED, VersionStatus.SUNSET]
                                          ^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: type object 'VersionStatus' has no attribute 'DEPRECATED'

tests/test_versioning.py:42: AttributeError
___________ TestEndpointVersioning.test_endpoint_versioning_creation ___________

self = <tests.test_versioning.TestEndpointVersioning object at 0x7f59acd93aa0>

    def test_endpoint_versioning_creation(self):
        """Test creating EndpointVersioning."""
        endpoint = EndpointVersioning(
            path="/api/users",
            method="GET",
            introduced_in=APIVersion.V1,
            deprecated_in=APIVersion.V2,
            removed_in=None
        )
    
        assert endpoint.path == "/api/users"
        assert endpoint.method == "GET"
        assert endpoint.introduced_in == APIVersion.V1
>       assert endpoint.deprecated_in == APIVersion.V2
               ^^^^^^^^^^^^^^^^^^^^^^

tests/test_versioning.py:101: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = EndpointVersioning(path='/api/users', method='GET', introduced_in=<APIVersion.V1: 'v1'>, removed_in=None, changes={})
item = 'deprecated_in'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'EndpointVersioning' object has no attribute 'deprecated_in'

../.local/lib/python3.12/site-packages/pydantic/main.py:991: AttributeError
__________ TestEndpointVersioning.test_endpoint_versioning_lifecycle ___________

self = <tests.test_versioning.TestEndpointVersioning object at 0x7f59acd93bf0>

    def test_endpoint_versioning_lifecycle(self):
        """Test endpoint lifecycle through versions."""
        # Endpoint introduced in V1, deprecated in V2, removed in hypothetical V3
        endpoint = EndpointVersioning(
            path="/api/legacy",
            method="POST",
            introduced_in=APIVersion.V1,
            deprecated_in=APIVersion.V2,
            removed_in=APIVersion.V2  # Removed in V2 (immediately deprecated and removed)
        )
    
        assert endpoint.introduced_in == APIVersion.V1
>       assert endpoint.deprecated_in == APIVersion.V2
               ^^^^^^^^^^^^^^^^^^^^^^

tests/test_versioning.py:116: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = EndpointVersioning(path='/api/legacy', method='POST', introduced_in=<APIVersion.V1: 'v1'>, removed_in=<APIVersion.V2: 'v2'>, changes={})
item = 'deprecated_in'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra:
                try:
                    return pydantic_extra[item]
                except KeyError as exc:
                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'EndpointVersioning' object has no attribute 'deprecated_in'

../.local/lib/python3.12/site-packages/pydantic/main.py:991: AttributeError
______________ TestAPIVersionManager.test_default_versions_loaded ______________

self = <tests.test_versioning.TestAPIVersionManager object at 0x7f59acdb0350>

    def test_default_versions_loaded(self):
        """Test that default versions are properly loaded."""
        # V1 should exist
        v1_info = self.manager.get_version_info(APIVersion.V1)
        assert v1_info is not None
        assert v1_info.version == APIVersion.V1
>       assert v1_info.status == VersionStatus.DEPRECATED
                                 ^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: type object 'VersionStatus' has no attribute 'DEPRECATED'

tests/test_versioning.py:142: AttributeError
________ TestAPIVersionManager.test_is_endpoint_available_unregistered _________

self = <tests.test_versioning.TestAPIVersionManager object at 0x7f59acdb03e0>

    def test_is_endpoint_available_unregistered(self):
        """Test endpoint availability for unregistered endpoint."""
        is_available = self.manager.is_endpoint_available(
            "/api/nonexistent", "GET", APIVersion.V1
        )
        # Unregistered endpoints should be considered available
>       assert is_available is True
E       assert False is True

tests/test_versioning.py:335: AssertionError
________________ TestAPIVersionManager.test_deprecate_endpoint _________________

self = <tests.test_versioning.TestAPIVersionManager object at 0x7f59acdb19a0>

    def test_deprecate_endpoint(self):
        """Test deprecating an endpoint."""
        # Register endpoint
        self.manager.register_endpoint(
            path="/api/to-deprecate",
            method="GET",
            introduced_in=APIVersion.V1
        )
    
        # Deprecate endpoint
>       self.manager.deprecate_endpoint(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            "/api/to-deprecate", "GET", APIVersion.V2
        )
E       AttributeError: 'APIVersionManager' object has no attribute 'deprecate_endpoint'

tests/test_versioning.py:347: AttributeError
__________ TestAPIVersionManager.test_deprecate_nonexistent_endpoint ___________

self = <tests.test_versioning.TestAPIVersionManager object at 0x7f59acdb1bb0>

    def test_deprecate_nonexistent_endpoint(self):
        """Test deprecating a non-existent endpoint."""
        # Should not raise error
>       self.manager.deprecate_endpoint(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            "/api/nonexistent", "GET", APIVersion.V2
        )
E       AttributeError: 'APIVersionManager' object has no attribute 'deprecate_endpoint'

tests/test_versioning.py:358: AttributeError
_________________ TestAPIVersionManager.test_get_endpoint_info _________________

self = <tests.test_versioning.TestAPIVersionManager object at 0x7f59acdb1dc0>

    def test_get_endpoint_info(self):
        """Test getting endpoint information."""
        # Register endpoint
        self.manager.register_endpoint(
            path="/api/info-test",
            method="POST",
            introduced_in=APIVersion.V1,
            removed_in=APIVersion.V2
        )
    
>       endpoint_info = self.manager.get_endpoint_info(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            "/api/info-test", "POST"
        )
E       AttributeError: 'APIVersionManager' object has no attribute 'get_endpoint_info'. Did you mean: 'get_endpoint_status'?

tests/test_versioning.py:376: AttributeError
___________ TestAPIVersionManager.test_get_endpoint_info_nonexistent ___________

self = <tests.test_versioning.TestAPIVersionManager object at 0x7f59acdb1fd0>

    def test_get_endpoint_info_nonexistent(self):
        """Test getting info for non-existent endpoint."""
>       endpoint_info = self.manager.get_endpoint_info(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            "/api/nonexistent", "GET"
        )
E       AttributeError: 'APIVersionManager' object has no attribute 'get_endpoint_info'. Did you mean: 'get_endpoint_status'?

tests/test_versioning.py:388: AttributeError
_____________ TestAPIVersionManager.test_get_endpoints_for_version _____________

self = <tests.test_versioning.TestAPIVersionManager object at 0x7f59acdb21e0>

    def test_get_endpoints_for_version(self):
        """Test getting all endpoints available for a version."""
        # Register multiple endpoints
        endpoints_to_register = [
            ("/api/v1-only", "GET", APIVersion.V1, APIVersion.V2),
            ("/api/v1-v2", "GET", APIVersion.V1, None),
            ("/api/v2-only", "GET", APIVersion.V2, None),
        ]
    
        for path, method, introduced, removed in endpoints_to_register:
            self.manager.register_endpoint(
                path=path,
                method=method,
                introduced_in=introduced,
                removed_in=removed
            )
    
        # Get endpoints for V1
>       v1_endpoints = self.manager.get_endpoints_for_version(APIVersion.V1)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'APIVersionManager' object has no attribute 'get_endpoints_for_version'

tests/test_versioning.py:412: AttributeError
__________ TestAPIVersionManager.test_version_middleware_integration ___________
  + Exception Group Traceback (most recent call last):
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     raise exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/pluggy/_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/_pytest/python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_versioning.py", line 470, in test_version_middleware_integration
    |     response = client.get("/api/test", headers={"API-Version": "v1"})
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/yam/chatter/tests/test_versioning.py", line 446, in version_middleware
    |     raise HTTPException(
    | fastapi.exceptions.HTTPException: 400: API version v1 is not supported
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/yam/chatter/tests/test_versioning.py", line 470, in test_version_middleware_integration
    response = client.get("/api/test", headers={"API-Version": "v1"})
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 479, in get
    return super().get(
           ^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1053, in get
    return self.request(
           ^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/httpx/_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 354, in handle_request
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/yam/.local/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/.local/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib64/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/_utils.py", line 83, in collapse_excgroups
    raise exc
  File "/home/yam/.local/lib/python3.12/site-packages/starlette/middleware/base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/yam/chatter/tests/test_versioning.py", line 446, in version_middleware
    raise HTTPException(
fastapi.exceptions.HTTPException: 400: API version v1 is not supported

During handling of the above exception, another exception occurred:

self = <tests.test_versioning.TestAPIVersionManager object at 0x7f59acdb23f0>

    def test_version_middleware_integration(self):
        """Test integration with versioning middleware."""
        app = FastAPI()
    
        @app.get("/api/test")
        async def test_endpoint():
            return {"message": "test"}
    
        # Add versioning middleware
        @app.middleware("http")
        async def version_middleware(request: Request, call_next):
            # Extract version from header
            api_version = request.headers.get("API-Version", "v1")
    
            # Validate version
            version_enum = APIVersion.V1 if api_version == "v1" else APIVersion.V2
    
            if not self.manager.is_version_supported(version_enum):
                from fastapi import HTTPException
                raise HTTPException(
                    status_code=400,
                    detail=f"API version {api_version} is not supported"
                )
    
            response = await call_next(request)
            response.headers["API-Version"] = api_version
            return response
    
        client = TestClient(app)
    
        # Test with supported version
        response = client.get("/api/test", headers={"API-Version": "v2"})
        assert response.status_code == 200
        assert response.headers["API-Version"] == "v2"
    
        # Test with unsupported version (after making V1 sunset)
        sunset_v1 = VersionInfo(
            version=APIVersion.V1,
            status=VersionStatus.SUNSET,
            release_date="2023-01-01"
        )
        self.manager.add_version(sunset_v1)
    
>       response = client.get("/api/test", headers={"API-Version": "v1"})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_versioning.py:470: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../.local/lib/python3.12/site-packages/starlette/testclient.py:479: in get
    return super().get(
../.local/lib/python3.12/site-packages/httpx/_client.py:1053: in get
    return self.request(
../.local/lib/python3.12/site-packages/starlette/testclient.py:451: in request
    return super().request(
../.local/lib/python3.12/site-packages/httpx/_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
../.local/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
../.local/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
    raise exc
../.local/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
../.local/lib/python3.12/site-packages/anyio/from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
../.local/lib/python3.12/site-packages/anyio/from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
../.local/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.12/contextlib.py:158: in __exit__
    self.gen.throw(value)
../.local/lib/python3.12/site-packages/starlette/_utils.py:83: in collapse_excgroups
    raise exc
../.local/lib/python3.12/site-packages/starlette/middleware/base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

request = <starlette.middleware.base._CachedRequest object at 0x7f5955db8200>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7f5955d28720>

    @app.middleware("http")
    async def version_middleware(request: Request, call_next):
        # Extract version from header
        api_version = request.headers.get("API-Version", "v1")
    
        # Validate version
        version_enum = APIVersion.V1 if api_version == "v1" else APIVersion.V2
    
        if not self.manager.is_version_supported(version_enum):
            from fastapi import HTTPException
>           raise HTTPException(
                status_code=400,
                detail=f"API version {api_version} is not supported"
            )
E           fastapi.exceptions.HTTPException: 400: API version v1 is not supported

tests/test_versioning.py:446: HTTPException
__________ TestVersioningIntegration.test_complete_version_lifecycle ___________

self = <tests.test_versioning.TestVersioningIntegration object at 0x7f59acdb2600>

    def test_complete_version_lifecycle(self):
        """Test complete version lifecycle management."""
        # 1. Add a new version
        v3_info = VersionInfo(
            version=APIVersion.V2,  # Override V2 for testing
            status=VersionStatus.ACTIVE,
            release_date="2024-12-01",
            documentation_url="https://api.example.com/docs/v3",
            breaking_changes=["Restructured response format"],
            new_features=["Real-time streaming", "Enhanced security"]
        )
        self.manager.add_version(v3_info)
    
        # 2. Register endpoints for different versions
        self.manager.register_endpoint("/api/legacy", "GET", APIVersion.V1, APIVersion.V2)
        self.manager.register_endpoint("/api/stable", "GET", APIVersion.V1)
        self.manager.register_endpoint("/api/new", "GET", APIVersion.V2)
    
        # 3. Deprecate an endpoint
>       self.manager.deprecate_endpoint("/api/stable", "GET", APIVersion.V2)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'APIVersionManager' object has no attribute 'deprecate_endpoint'

tests/test_versioning.py:501: AttributeError
__________ TestVersioningIntegration.test_version_migration_scenario ___________

self = <tests.test_versioning.TestVersioningIntegration object at 0x7f59acdb2780>

    def test_version_migration_scenario(self):
        """Test a realistic version migration scenario."""
        # Scenario: Migrating from V1 to V2 with gradual deprecation
    
        # 1. Start with V1 as active, V2 as new
        v1_info = VersionInfo(
            version=APIVersion.V1,
            status=VersionStatus.ACTIVE,
            release_date="2023-01-01",
            documentation_url="https://api.example.com/docs/v1"
        )
        self.manager.add_version(v1_info)
    
        # 2. Register endpoints that exist in V1
        legacy_endpoints = [
            "/api/users",
            "/api/posts",
            "/api/comments"
        ]
    
        for endpoint in legacy_endpoints:
            self.manager.register_endpoint(endpoint, "GET", APIVersion.V1)
            self.manager.register_endpoint(endpoint, "POST", APIVersion.V1)
    
        # 3. Add V2 with some endpoints deprecated/changed
        v2_info = VersionInfo(
            version=APIVersion.V2,
            status=VersionStatus.ACTIVE,
            release_date="2024-06-01",
            documentation_url="https://api.example.com/docs/v2",
            breaking_changes=[
                "Removed /api/comments endpoint",
                "Changed /api/posts response format"
            ],
            new_features=[
                "Added /api/threads endpoint",
                "Enhanced /api/users with filtering"
            ]
        )
        self.manager.add_version(v2_info)
    
        # 4. Register V2 changes
        self.manager.register_endpoint("/api/comments", "GET", APIVersion.V1, APIVersion.V2)  # Removed in V2
        self.manager.register_endpoint("/api/threads", "GET", APIVersion.V2)  # New in V2
>       self.manager.deprecate_endpoint("/api/posts", "POST", APIVersion.V2)  # Deprecated in V2
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'APIVersionManager' object has no attribute 'deprecate_endpoint'

tests/test_versioning.py:559: AttributeError
_______ TestVersioningIntegration.test_backwards_compatibility_checking ________

self = <tests.test_versioning.TestVersioningIntegration object at 0x7f59acdb2990>

    def test_backwards_compatibility_checking(self):
        """Test backwards compatibility validation."""
        # Register endpoints in V1
        self.manager.register_endpoint("/api/stable", "GET", APIVersion.V1)
        self.manager.register_endpoint("/api/changing", "GET", APIVersion.V1, APIVersion.V2)
    
        # Get compatibility report
>       v1_endpoints = self.manager.get_endpoints_for_version(APIVersion.V1)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'APIVersionManager' object has no attribute 'get_endpoints_for_version'

tests/test_versioning.py:597: AttributeError
________ TestWorkflowExecutionService.test_execute_workflow_with_limits ________

self = <chatter.core.workflow_executors.PlainWorkflowExecutor object at 0x7f5954f26600>
conversation = <MagicMock spec='Conversation' id='140021661581040'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='plain', provider=No...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> tuple[Message, dict[str, Any]]:
        """Execute plain workflow."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Create and execute plain workflow
            workflow = await self.llm_service.create_langgraph_workflow(
                provider_name=chat_request.provider,
                workflow_type=self.workflow_type,
                enable_memory=True,
                memory_window=20,
                system_message=chat_request.system_prompt_override,
            )
    
            # Prepare conversation context
            messages = []
            recent_messages = await self.message_service.get_recent_messages(
                conversation.id, limit=20
            )
    
            for msg in recent_messages:
                if msg.role == MessageRole.USER:
                    messages.append({"role": "human", "content": msg.content})
                elif msg.role == MessageRole.ASSISTANT:
                    messages.append({"role": "ai", "content": msg.content})
    
            # Add current message
            messages.append({"role": "human", "content": chat_request.message})
    
            # Execute workflow
            state = ConversationState(messages=messages)
            result = await workflow.ainvoke(state, {"configurable": {"thread_id": conversation.id}})
    
            # Extract response
            if isinstance(result["messages"][-1], AIMessage):
                response_content = result["messages"][-1].content
            else:
                response_content = str(result["messages"][-1])
    
            # Create response message
>           assistant_message = await self.message_service.create_message(
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                conversation_id=conversation.id,
                role=MessageRole.ASSISTANT,
                content=response_content,
            )

chatter/core/workflow_executors.py:205: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <AsyncMock spec='MessageService' id='140021682324688'>
name = 'create_message'

    def __getattr__(self, name):
        if name in {'_mock_methods', '_mock_unsafe'}:
            raise AttributeError(name)
        elif self._mock_methods is not None:
            if name not in self._mock_methods or name in _all_magics:
>               raise AttributeError("Mock object has no attribute %r" % name)
E               AttributeError: Mock object has no attribute 'create_message'. Did you mean: 'delete_message'?

/usr/lib64/python3.12/unittest/mock.py:660: AttributeError

The above exception was the direct cause of the following exception:

self = <chatter.core.workflow_executors.PlainWorkflowExecutor object at 0x7f5954f26600>
conversation = <MagicMock spec='Conversation' id='140021661581040'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='plain', provider=No...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> tuple[Message, dict[str, Any]]:
        """Execute plain workflow."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Create and execute plain workflow
            workflow = await self.llm_service.create_langgraph_workflow(
                provider_name=chat_request.provider,
                workflow_type=self.workflow_type,
                enable_memory=True,
                memory_window=20,
                system_message=chat_request.system_prompt_override,
            )
    
            # Prepare conversation context
            messages = []
            recent_messages = await self.message_service.get_recent_messages(
                conversation.id, limit=20
            )
    
            for msg in recent_messages:
                if msg.role == MessageRole.USER:
                    messages.append({"role": "human", "content": msg.content})
                elif msg.role == MessageRole.ASSISTANT:
                    messages.append({"role": "ai", "content": msg.content})
    
            # Add current message
            messages.append({"role": "human", "content": chat_request.message})
    
            # Execute workflow
            state = ConversationState(messages=messages)
            result = await workflow.ainvoke(state, {"configurable": {"thread_id": conversation.id}})
    
            # Extract response
            if isinstance(result["messages"][-1], AIMessage):
                response_content = result["messages"][-1].content
            else:
                response_content = str(result["messages"][-1])
    
            # Create response message
            assistant_message = await self.message_service.create_message(
                conversation_id=conversation.id,
                role=MessageRole.ASSISTANT,
                content=response_content,
            )
    
            # Record success metrics
            await self._record_metrics(
                workflow_id, "execute", start_time, True, correlation_id=correlation_id
            )
    
            return assistant_message, {"usage": result.get("usage", {})}
    
        except Exception as e:
            # Record error metrics
            await self._record_metrics(
                workflow_id, "execute", start_time, False,
                error_type=type(e).__name__, correlation_id=correlation_id
            )
>           raise WorkflowExecutionError(f"Plain workflow execution failed: {str(e)}") from e
E           chatter.core.workflow_executors.WorkflowExecutionError: Plain workflow execution failed: Mock object has no attribute 'create_message'

chatter/core/workflow_executors.py:224: WorkflowExecutionError

During handling of the above exception, another exception occurred:

self = <tests.test_workflow_limits_and_streaming.TestWorkflowExecutionService object at 0x7f59acdb3800>

    @pytest.mark.asyncio
    async def test_execute_workflow_with_limits(self):
        """Test workflow execution with resource limits."""
        # Mock LLM response
        mock_response = MagicMock()
        mock_response.content = "Test response"
    
        mock_provider = AsyncMock()
        mock_provider.ainvoke.return_value = mock_response
        mock_provider.__class__.__name__ = "TestProvider"
    
        self.llm_service.get_default_provider.return_value = mock_provider
        self.llm_service.convert_conversation_to_messages.return_value = []
    
        # Mock message service
        self.workflow_service._get_conversation_messages = AsyncMock(return_value=[])
    
        # Define custom limits
        limits = WorkflowLimits(
            execution_timeout=60,
            step_timeout=30,
            streaming_timeout=120,
            max_tokens=1000,
            max_memory_mb=512,
            max_concurrent=5,
        )
    
        # Execute workflow
>       result_message, usage_info = await self.workflow_service.execute_workflow(
            self.conversation,
            self.chat_request,
            self.correlation_id,
            user_id="user_123",
            limits=limits,
        )

tests/test_workflow_limits_and_streaming.py:202: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/services/workflow_execution.py:86: in execute_workflow
    return await executor.execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.core.workflow_executors.PlainWorkflowExecutor object at 0x7f5954f26600>
conversation = <MagicMock spec='Conversation' id='140021661581040'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='plain', provider=No...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> tuple[Message, dict[str, Any]]:
        """Execute plain workflow."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Create and execute plain workflow
            workflow = await self.llm_service.create_langgraph_workflow(
                provider_name=chat_request.provider,
                workflow_type=self.workflow_type,
                enable_memory=True,
                memory_window=20,
                system_message=chat_request.system_prompt_override,
            )
    
            # Prepare conversation context
            messages = []
            recent_messages = await self.message_service.get_recent_messages(
                conversation.id, limit=20
            )
    
            for msg in recent_messages:
                if msg.role == MessageRole.USER:
                    messages.append({"role": "human", "content": msg.content})
                elif msg.role == MessageRole.ASSISTANT:
                    messages.append({"role": "ai", "content": msg.content})
    
            # Add current message
            messages.append({"role": "human", "content": chat_request.message})
    
            # Execute workflow
            state = ConversationState(messages=messages)
            result = await workflow.ainvoke(state, {"configurable": {"thread_id": conversation.id}})
    
            # Extract response
            if isinstance(result["messages"][-1], AIMessage):
                response_content = result["messages"][-1].content
            else:
                response_content = str(result["messages"][-1])
    
            # Create response message
            assistant_message = await self.message_service.create_message(
                conversation_id=conversation.id,
                role=MessageRole.ASSISTANT,
                content=response_content,
            )
    
            # Record success metrics
            await self._record_metrics(
                workflow_id, "execute", start_time, True, correlation_id=correlation_id
            )
    
            return assistant_message, {"usage": result.get("usage", {})}
    
        except Exception as e:
            # Record error metrics
            await self._record_metrics(
                workflow_id, "execute", start_time, False,
                error_type=type(e).__name__, correlation_id=correlation_id
            )
            raise WorkflowExecutionError(f"Plain workflow execution failed: {str(e)}") from e
        finally:
            # Clean up resource tracking
            if user_id:
>               self.limit_manager.end_workflow_tracking(workflow_id)
E               TypeError: WorkflowLimitManager.end_workflow_tracking() missing 1 required positional argument: 'user_id'

chatter/core/workflow_executors.py:228: TypeError
__________ TestWorkflowExecutionService.test_execute_workflow_timeout __________

self = <chatter.core.workflow_executors.PlainWorkflowExecutor object at 0x7f5954fe4f80>
conversation = <MagicMock spec='Conversation' id='140021669275616'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='plain', provider=No...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=1, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> tuple[Message, dict[str, Any]]:
        """Execute plain workflow."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Create and execute plain workflow
            workflow = await self.llm_service.create_langgraph_workflow(
                provider_name=chat_request.provider,
                workflow_type=self.workflow_type,
                enable_memory=True,
                memory_window=20,
                system_message=chat_request.system_prompt_override,
            )
    
            # Prepare conversation context
            messages = []
            recent_messages = await self.message_service.get_recent_messages(
                conversation.id, limit=20
            )
    
            for msg in recent_messages:
                if msg.role == MessageRole.USER:
                    messages.append({"role": "human", "content": msg.content})
                elif msg.role == MessageRole.ASSISTANT:
                    messages.append({"role": "ai", "content": msg.content})
    
            # Add current message
            messages.append({"role": "human", "content": chat_request.message})
    
            # Execute workflow
            state = ConversationState(messages=messages)
            result = await workflow.ainvoke(state, {"configurable": {"thread_id": conversation.id}})
    
            # Extract response
            if isinstance(result["messages"][-1], AIMessage):
                response_content = result["messages"][-1].content
            else:
                response_content = str(result["messages"][-1])
    
            # Create response message
>           assistant_message = await self.message_service.create_message(
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                conversation_id=conversation.id,
                role=MessageRole.ASSISTANT,
                content=response_content,
            )

chatter/core/workflow_executors.py:205: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <AsyncMock spec='MessageService' id='140023128861120'>
name = 'create_message'

    def __getattr__(self, name):
        if name in {'_mock_methods', '_mock_unsafe'}:
            raise AttributeError(name)
        elif self._mock_methods is not None:
            if name not in self._mock_methods or name in _all_magics:
>               raise AttributeError("Mock object has no attribute %r" % name)
E               AttributeError: Mock object has no attribute 'create_message'. Did you mean: 'delete_message'?

/usr/lib64/python3.12/unittest/mock.py:660: AttributeError

The above exception was the direct cause of the following exception:

self = <chatter.core.workflow_executors.PlainWorkflowExecutor object at 0x7f5954fe4f80>
conversation = <MagicMock spec='Conversation' id='140021669275616'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='plain', provider=No...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=1, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> tuple[Message, dict[str, Any]]:
        """Execute plain workflow."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Create and execute plain workflow
            workflow = await self.llm_service.create_langgraph_workflow(
                provider_name=chat_request.provider,
                workflow_type=self.workflow_type,
                enable_memory=True,
                memory_window=20,
                system_message=chat_request.system_prompt_override,
            )
    
            # Prepare conversation context
            messages = []
            recent_messages = await self.message_service.get_recent_messages(
                conversation.id, limit=20
            )
    
            for msg in recent_messages:
                if msg.role == MessageRole.USER:
                    messages.append({"role": "human", "content": msg.content})
                elif msg.role == MessageRole.ASSISTANT:
                    messages.append({"role": "ai", "content": msg.content})
    
            # Add current message
            messages.append({"role": "human", "content": chat_request.message})
    
            # Execute workflow
            state = ConversationState(messages=messages)
            result = await workflow.ainvoke(state, {"configurable": {"thread_id": conversation.id}})
    
            # Extract response
            if isinstance(result["messages"][-1], AIMessage):
                response_content = result["messages"][-1].content
            else:
                response_content = str(result["messages"][-1])
    
            # Create response message
            assistant_message = await self.message_service.create_message(
                conversation_id=conversation.id,
                role=MessageRole.ASSISTANT,
                content=response_content,
            )
    
            # Record success metrics
            await self._record_metrics(
                workflow_id, "execute", start_time, True, correlation_id=correlation_id
            )
    
            return assistant_message, {"usage": result.get("usage", {})}
    
        except Exception as e:
            # Record error metrics
            await self._record_metrics(
                workflow_id, "execute", start_time, False,
                error_type=type(e).__name__, correlation_id=correlation_id
            )
>           raise WorkflowExecutionError(f"Plain workflow execution failed: {str(e)}") from e
E           chatter.core.workflow_executors.WorkflowExecutionError: Plain workflow execution failed: Mock object has no attribute 'create_message'

chatter/core/workflow_executors.py:224: WorkflowExecutionError

During handling of the above exception, another exception occurred:

self = <tests.test_workflow_limits_and_streaming.TestWorkflowExecutionService object at 0x7f59acdb3bf0>

    @pytest.mark.asyncio
    async def test_execute_workflow_timeout(self):
        """Test workflow execution timeout."""
        # Mock slow LLM response
        async def slow_invoke(*args, **kwargs):
            await asyncio.sleep(2)  # Simulate slow response
            mock_response = MagicMock()
            mock_response.content = "Test response"
            return mock_response
    
        mock_provider = AsyncMock()
        mock_provider.ainvoke = slow_invoke
        mock_provider.__class__.__name__ = "TestProvider"
    
        self.llm_service.get_default_provider.return_value = mock_provider
        self.llm_service.convert_conversation_to_messages.return_value = []
        self.workflow_service._get_conversation_messages = AsyncMock(return_value=[])
    
        # Define short timeout
        limits = WorkflowLimits(
            execution_timeout=1,  # 1 second timeout
            step_timeout=30,
            streaming_timeout=120,
            max_tokens=1000,
            max_memory_mb=512,
            max_concurrent=5,
        )
    
        # Should timeout
        with pytest.raises(WorkflowTimeoutError) as exc_info:
>           await self.workflow_service.execute_workflow(
                self.conversation,
                self.chat_request,
                self.correlation_id,
                user_id="user_123",
                limits=limits,
            )

tests/test_workflow_limits_and_streaming.py:245: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/services/workflow_execution.py:86: in execute_workflow
    return await executor.execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.core.workflow_executors.PlainWorkflowExecutor object at 0x7f5954fe4f80>
conversation = <MagicMock spec='Conversation' id='140021669275616'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='plain', provider=No...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=1, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> tuple[Message, dict[str, Any]]:
        """Execute plain workflow."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Create and execute plain workflow
            workflow = await self.llm_service.create_langgraph_workflow(
                provider_name=chat_request.provider,
                workflow_type=self.workflow_type,
                enable_memory=True,
                memory_window=20,
                system_message=chat_request.system_prompt_override,
            )
    
            # Prepare conversation context
            messages = []
            recent_messages = await self.message_service.get_recent_messages(
                conversation.id, limit=20
            )
    
            for msg in recent_messages:
                if msg.role == MessageRole.USER:
                    messages.append({"role": "human", "content": msg.content})
                elif msg.role == MessageRole.ASSISTANT:
                    messages.append({"role": "ai", "content": msg.content})
    
            # Add current message
            messages.append({"role": "human", "content": chat_request.message})
    
            # Execute workflow
            state = ConversationState(messages=messages)
            result = await workflow.ainvoke(state, {"configurable": {"thread_id": conversation.id}})
    
            # Extract response
            if isinstance(result["messages"][-1], AIMessage):
                response_content = result["messages"][-1].content
            else:
                response_content = str(result["messages"][-1])
    
            # Create response message
            assistant_message = await self.message_service.create_message(
                conversation_id=conversation.id,
                role=MessageRole.ASSISTANT,
                content=response_content,
            )
    
            # Record success metrics
            await self._record_metrics(
                workflow_id, "execute", start_time, True, correlation_id=correlation_id
            )
    
            return assistant_message, {"usage": result.get("usage", {})}
    
        except Exception as e:
            # Record error metrics
            await self._record_metrics(
                workflow_id, "execute", start_time, False,
                error_type=type(e).__name__, correlation_id=correlation_id
            )
            raise WorkflowExecutionError(f"Plain workflow execution failed: {str(e)}") from e
        finally:
            # Clean up resource tracking
            if user_id:
>               self.limit_manager.end_workflow_tracking(workflow_id)
E               TypeError: WorkflowLimitManager.end_workflow_tracking() missing 1 required positional argument: 'user_id'

chatter/core/workflow_executors.py:228: TypeError
_________ TestWorkflowExecutionService.test_concurrent_workflow_limit __________

self = <chatter.core.workflow_executors.PlainWorkflowExecutor object at 0x7f59551cbce0>
conversation = <MagicMock spec='Conversation' id='140021654692752'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='plain', provider=No...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_1', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=1)

    async def _setup_execution(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> tuple[str, WorkflowLimits]:
        """Common setup for workflow execution."""
        workflow_id = f"{correlation_id}_{self.workflow_type}"
    
        # Use provided limits or get defaults
        if limits is None:
            limits = self.limit_manager.get_default_limits()
    
        # Start resource tracking if user_id provided
        if user_id:
            try:
>               self.limit_manager.start_workflow_tracking(workflow_id, user_id, limits)

chatter/core/workflow_executors.py:113: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/core/workflow_limits.py:94: in start_workflow_tracking
    self.check_concurrent_limit(user_id, limits)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.core.workflow_limits.WorkflowLimitManager object at 0x7f5af0dc37d0>
user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=1)

    def check_concurrent_limit(self, user_id: str, limits: WorkflowLimits) -> None:
        """Check if user has reached concurrent workflow limit."""
        current_count = self.user_workflow_counts.get(user_id, 0)
        if current_count >= limits.max_concurrent:
>           raise WorkflowResourceLimitError(
                f"User {user_id} has reached maximum concurrent workflows limit",
                "concurrent_workflows",
                current_count,
                limits.max_concurrent,
            )
E           chatter.core.workflow_limits.WorkflowResourceLimitError: User user_123 has reached maximum concurrent workflows limit

chatter/core/workflow_limits.py:83: WorkflowResourceLimitError

The above exception was the direct cause of the following exception:

self = <tests.test_workflow_limits_and_streaming.TestWorkflowExecutionService object at 0x7f59acddc170>

    @pytest.mark.asyncio
    async def test_concurrent_workflow_limit(self):
        """Test concurrent workflow limit enforcement."""
        # Mock successful workflow
        mock_response = MagicMock()
        mock_response.content = "Test response"
    
        mock_provider = AsyncMock()
        mock_provider.ainvoke.return_value = mock_response
        mock_provider.__class__.__name__ = "TestProvider"
    
        self.llm_service.get_default_provider.return_value = mock_provider
        self.llm_service.convert_conversation_to_messages.return_value = []
        self.workflow_service._get_conversation_messages = AsyncMock(return_value=[])
    
        # Set very low concurrent limit
        limits = WorkflowLimits(
            execution_timeout=60,
            step_timeout=30,
            streaming_timeout=120,
            max_tokens=1000,
            max_memory_mb=512,
            max_concurrent=1,
        )
    
        user_id = "user_123"
    
        # First workflow should succeed
>       result1 = await self.workflow_service.execute_workflow(
            self.conversation,
            self.chat_request,
            "corr_1",
            user_id=user_id,
            limits=limits,
        )

tests/test_workflow_limits_and_streaming.py:282: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/services/workflow_execution.py:86: in execute_workflow
    return await executor.execute(
chatter/core/workflow_executors.py:162: in execute
    workflow_id, limits = await self._setup_execution(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.core.workflow_executors.PlainWorkflowExecutor object at 0x7f59551cbce0>
conversation = <MagicMock spec='Conversation' id='140021654692752'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='plain', provider=No...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_1', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=1)

    async def _setup_execution(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> tuple[str, WorkflowLimits]:
        """Common setup for workflow execution."""
        workflow_id = f"{correlation_id}_{self.workflow_type}"
    
        # Use provided limits or get defaults
        if limits is None:
            limits = self.limit_manager.get_default_limits()
    
        # Start resource tracking if user_id provided
        if user_id:
            try:
                self.limit_manager.start_workflow_tracking(workflow_id, user_id, limits)
            except WorkflowResourceLimitError as e:
                logger.warning(
                    "Workflow rejected due to resource limits",
                    extra={"user_id": user_id, "error": str(e), "correlation_id": correlation_id}
                )
>               raise WorkflowExecutionError(f"Resource limit exceeded: {e}") from e
E               chatter.core.workflow_executors.WorkflowExecutionError: Resource limit exceeded: User user_123 has reached maximum concurrent workflows limit

chatter/core/workflow_executors.py:119: WorkflowExecutionError
------------------------------ Captured log call -------------------------------
WARNING  chatter.core.workflow_executors:workflow_executors.py:115 Workflow rejected due to resource limits
_______ TestWorkflowExecutionService.test_streaming_workflow_with_limits _______

self = <tests.test_workflow_limits_and_streaming.TestWorkflowExecutionService object at 0x7f59acddc410>

    @pytest.mark.asyncio
    async def test_streaming_workflow_with_limits(self):
        """Test streaming workflow execution with resource limits."""
        # Mock streaming response
        mock_provider = AsyncMock()
        mock_provider.__class__.__name__ = "TestProvider"
    
        # Mock astream method for native streaming
        async def mock_astream(messages):
            chunks = [
                MagicMock(content="Hello"),
                MagicMock(content=" "),
                MagicMock(content="world"),
            ]
            for chunk in chunks:
                yield chunk
    
        mock_provider.astream = mock_astream
    
        self.llm_service.get_default_provider.return_value = mock_provider
        self.llm_service.convert_conversation_to_messages.return_value = []
        self.workflow_service._get_conversation_messages = AsyncMock(return_value=[])
    
        # Mock the workflow manager to avoid the 'str' object astream issue
>       with patch('chatter.services.workflow_execution.get_workflow_manager') as mock_get_manager:
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_workflow_limits_and_streaming.py:330: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7f595515c1a0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.services.workflow_execution' from '/home/yam/chatter/chatter/services/workflow_execution.py'> does not have the attribute 'get_workflow_manager'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
_________ TestWorkflowExecutionService.test_streaming_workflow_timeout _________

self = <tests.test_workflow_limits_and_streaming.TestWorkflowExecutionService object at 0x7f59acddc6b0>

    @pytest.mark.asyncio
    async def test_streaming_workflow_timeout(self):
        """Test streaming workflow timeout."""
        # Mock workflow manager to avoid the 'str' object astream issue
>       with patch('chatter.services.workflow_execution.get_workflow_manager') as mock_get_manager:
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_workflow_limits_and_streaming.py:381: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib64/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0x7f5955114e00>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'chatter.services.workflow_execution' from '/home/yam/chatter/chatter/services/workflow_execution.py'> does not have the attribute 'get_workflow_manager'

/usr/lib64/python3.12/unittest/mock.py:1437: AttributeError
___ TestWorkflowExecutionService.test_enhanced_token_streaming_all_workflows ___

self = <chatter.core.workflow_executors.RAGWorkflowExecutor object at 0x7f5955109760>
conversation = <MagicMock spec='Conversation' id='140021656315632'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='rag', provider=None...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute_streaming(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> AsyncGenerator[StreamingChatChunk, None]:
        """Execute RAG workflow with streaming."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Get retriever from workflow manager
            workflow_manager = get_workflow_manager()
>           retriever = workflow_manager.get_retriever(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                conversation.workspace_id if conversation.workspace_id else "default"
            )
E           AttributeError: 'LangGraphWorkflowManager' object has no attribute 'get_retriever'

chatter/core/workflow_executors.py:430: AttributeError

The above exception was the direct cause of the following exception:

self = <chatter.core.workflow_executors.RAGWorkflowExecutor object at 0x7f5955109760>
conversation = <MagicMock spec='Conversation' id='140021656315632'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='rag', provider=None...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute_streaming(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> AsyncGenerator[StreamingChatChunk, None]:
        """Execute RAG workflow with streaming."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Get retriever from workflow manager
            workflow_manager = get_workflow_manager()
            retriever = workflow_manager.get_retriever(
                conversation.workspace_id if conversation.workspace_id else "default"
            )
    
            # Create streaming RAG workflow
            workflow = await self.llm_service.create_langgraph_workflow(
                provider_name=chat_request.provider,
                workflow_type=self.workflow_type,
                retriever=retriever,
                enable_memory=True,
                memory_window=30,
                max_documents=10,
                system_message=chat_request.system_prompt_override,
            )
    
            # Prepare conversation state
            messages = []
            recent_messages = await self.message_service.get_recent_messages(
                conversation.id, limit=30
            )
    
            for msg in recent_messages:
                if msg.role == MessageRole.USER:
                    messages.append({"role": "human", "content": msg.content})
                elif msg.role == MessageRole.ASSISTANT:
                    messages.append({"role": "ai", "content": msg.content})
    
            messages.append({"role": "human", "content": chat_request.message})
            state = ConversationState(messages=messages)
    
            # Stream workflow execution
            content_buffer = ""
            async for event in workflow.astream(
                state, {"configurable": {"thread_id": conversation.id}}
            ):
                if "messages" in event:
                    message = event["messages"][-1]
                    if hasattr(message, "content") and message.content:
                        # Extract new content since last chunk
                        if len(message.content) > len(content_buffer):
                            new_content = message.content[len(content_buffer):]
                            content_buffer = message.content
    
                            yield StreamingChatChunk(
                                id=correlation_id,
                                content=new_content,
                                role="assistant",
                                conversation_id=conversation.id,
                            )
    
            # Create final message
            if content_buffer:
                await self.message_service.create_message(
                    conversation_id=conversation.id,
                    role=MessageRole.ASSISTANT,
                    content=content_buffer,
                )
    
            # Record success metrics
            await self._record_metrics(
                workflow_id, "stream", start_time, True, correlation_id=correlation_id
            )
    
        except Exception as e:
            # Record error metrics
            await self._record_metrics(
                workflow_id, "stream", start_time, False,
                error_type=type(e).__name__, correlation_id=correlation_id
            )
>           raise WorkflowExecutionError(f"RAG workflow streaming failed: {str(e)}") from e
E           chatter.core.workflow_executors.WorkflowExecutionError: RAG workflow streaming failed: 'LangGraphWorkflowManager' object has no attribute 'get_retriever'

chatter/core/workflow_executors.py:499: WorkflowExecutionError

During handling of the above exception, another exception occurred:

self = <tests.test_workflow_limits_and_streaming.TestWorkflowExecutionService object at 0x7f59acddc950>

    @pytest.mark.asyncio
    async def test_enhanced_token_streaming_all_workflows(self):
        """Test enhanced token streaming for all workflow types."""
        # Mock workflow manager
        with patch('chatter.core.dependencies.get_workflow_manager') as mock_get_manager:
            mock_workflow_manager = MagicMock()
            mock_get_manager.return_value = mock_workflow_manager
    
            # Mock streaming workflow response
            async def mock_stream_workflow(workflow_type, state):
                events = [
                    {"type": "thinking", "thought": "Processing..."},
                    {"type": "token", "content": "Test"},
                    {"type": "token", "content": " response"},
                    {"type": "complete", "usage": {"tokens": 2}},
                ]
                for event in events:
                    yield event
    
            mock_workflow_manager.stream_workflow = mock_stream_workflow
    
            self.workflow_service._get_conversation_messages = AsyncMock(return_value=[])
    
            limits = WorkflowLimits(
                execution_timeout=60,
                step_timeout=30,
                streaming_timeout=120,
                max_tokens=1000,
                max_memory_mb=512,
                max_concurrent=5,
            )
    
            # Test different workflow types
            for workflow_type in ["rag", "tools", "full"]:
                self.chat_request.workflow = workflow_type
    
                chunks = []
>               async for chunk in self.workflow_service.execute_workflow_streaming(
                    self.conversation,
                    self.chat_request,
                    self.correlation_id,
                    user_id="user_123",
                    limits=limits,
                ):

tests/test_workflow_limits_and_streaming.py:462: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
chatter/services/workflow_execution.py:121: in execute_workflow_streaming
    async for chunk in executor.execute_streaming(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <chatter.core.workflow_executors.RAGWorkflowExecutor object at 0x7f5955109760>
conversation = <MagicMock spec='Conversation' id='140021656315632'>
chat_request = ChatRequest(message='Test message', conversation_id=None, profile_id=None, stream=False, workflow='rag', provider=None...ns=None, context_limit=None, enable_retrieval=None, document_ids=None, system_prompt_override=None, workflow_type=None)
correlation_id = 'corr_123', user_id = 'user_123'
limits = WorkflowLimits(execution_timeout=60, step_timeout=30, streaming_timeout=120, max_tokens=1000, max_memory_mb=512, max_concurrent=5)

    async def execute_streaming(
        self,
        conversation: Conversation,
        chat_request: ChatRequest,
        correlation_id: str,
        user_id: str | None = None,
        limits: WorkflowLimits | None = None,
    ) -> AsyncGenerator[StreamingChatChunk, None]:
        """Execute RAG workflow with streaming."""
        start_time = time.time()
        workflow_id, limits = await self._setup_execution(
            conversation, chat_request, correlation_id, user_id, limits
        )
    
        try:
            # Start performance monitoring
            performance_monitor.start_workflow(workflow_id, self.workflow_type)
    
            # Get retriever from workflow manager
            workflow_manager = get_workflow_manager()
            retriever = workflow_manager.get_retriever(
                conversation.workspace_id if conversation.workspace_id else "default"
            )
    
            # Create streaming RAG workflow
            workflow = await self.llm_service.create_langgraph_workflow(
                provider_name=chat_request.provider,
                workflow_type=self.workflow_type,
                retriever=retriever,
                enable_memory=True,
                memory_window=30,
                max_documents=10,
                system_message=chat_request.system_prompt_override,
            )
    
            # Prepare conversation state
            messages = []
            recent_messages = await self.message_service.get_recent_messages(
                conversation.id, limit=30
            )
    
            for msg in recent_messages:
                if msg.role == MessageRole.USER:
                    messages.append({"role": "human", "content": msg.content})
                elif msg.role == MessageRole.ASSISTANT:
                    messages.append({"role": "ai", "content": msg.content})
    
            messages.append({"role": "human", "content": chat_request.message})
            state = ConversationState(messages=messages)
    
            # Stream workflow execution
            content_buffer = ""
            async for event in workflow.astream(
                state, {"configurable": {"thread_id": conversation.id}}
            ):
                if "messages" in event:
                    message = event["messages"][-1]
                    if hasattr(message, "content") and message.content:
                        # Extract new content since last chunk
                        if len(message.content) > len(content_buffer):
                            new_content = message.content[len(content_buffer):]
                            content_buffer = message.content
    
                            yield StreamingChatChunk(
                                id=correlation_id,
                                content=new_content,
                                role="assistant",
                                conversation_id=conversation.id,
                            )
    
            # Create final message
            if content_buffer:
                await self.message_service.create_message(
                    conversation_id=conversation.id,
                    role=MessageRole.ASSISTANT,
                    content=content_buffer,
                )
    
            # Record success metrics
            await self._record_metrics(
                workflow_id, "stream", start_time, True, correlation_id=correlation_id
            )
    
        except Exception as e:
            # Record error metrics
            await self._record_metrics(
                workflow_id, "stream", start_time, False,
                error_type=type(e).__name__, correlation_id=correlation_id
            )
            raise WorkflowExecutionError(f"RAG workflow streaming failed: {str(e)}") from e
        finally:
            # Clean up resource tracking
            if user_id:
>               self.limit_manager.end_workflow_tracking(workflow_id)
E               TypeError: WorkflowLimitManager.end_workflow_tracking() missing 1 required positional argument: 'user_id'

chatter/core/workflow_executors.py:503: TypeError
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.11-final-0 _______________

Name                                           Stmts   Miss  Cover   Missing
----------------------------------------------------------------------------
chatter/__init__.py                                6      0   100%
chatter/__main__.py                                3      3     0%   3-6
chatter/api/__init__.py                            2      0   100%
chatter/api/ab_testing.py                        289    249    14%   50-59, 75-94, 104-106, 129-268, 289-359, 380-442, 465-541, 562-581, 602-625, 646-669, 690-713, 734-845, 866-903, 926-949, 970-990, 1011-1060
chatter/api/agents.py                            342    307    10%   56-58, 88-198, 224-282, 306-312, 335-358, 379-415, 436-469, 502-605, 626-672, 691-820, 839-926
chatter/api/analytics.py                         149    105    30%   36, 68-112, 145-185, 216-267, 298-349, 371-404, 436-474, 505-523, 558-589, 631-694, 709-713, 731-735
chatter/api/auth.py                              152     78    49%   62, 66, 118-126, 153-171, 209-210, 218-230, 259-277, 300, 319-322, 343-354, 377-386, 409-425, 442-443, 462-479, 501-519, 545-561, 582-598
chatter/api/chat.py                              169    110    35%   60-61, 136-142, 180-184, 207-227, 244-252, 270-280, 306-312, 329-340, 358-369, 401-453, 461-496, 506-520, 533-560, 571-577, 587-593
chatter/api/data_management.py                    82     55    33%   34, 48-69, 85-118, 130-165, 181-202, 213-237, 251-264, 278-293, 305-318
chatter/api/documents.py                         154    118    23%   53, 88-139, 198-230, 264-288, 311-333, 356-380, 401-429, 460-481, 506-533, 552-568, 589-627, 651-678
chatter/api/events.py                             93     71    24%   48-148, 186-258, 284-287, 307-317, 335-345
chatter/api/health.py                             68      7    90%   169-183, 215-216
chatter/api/jobs.py                              122     98    20%   44-48, 69-130, 149-256, 273-304, 321-343, 360-387, 409-422
chatter/api/model_registry.py                    237    183    23%   53-60, 75-84, 99-152, 166-189, 204-225, 243-285, 309-318, 330-339, 353-403, 417-449, 462-483, 499-512, 532-541, 556-565, 579-641, 658-683, 696-711, 726-741, 754-763, 775-784, 795-804
chatter/api/plugins.py                           164    130    21%   36-38, 61-97, 118-169, 190-224, 247-300, 321-342, 363-390, 413-438, 459-479, 498-504, 525-531, 552-566, 587-601
chatter/api/profiles.py                          128     95    26%   46, 69-111, 158-190, 211-231, 254-281, 304-328, 351-397, 420-442, 461-481, 503-515
chatter/api/prompts.py                           100     71    29%   39, 62-72, 91-111, 162-195, 217-237, 260-282, 305-327, 350-363, 386-403
chatter/api/toolserver.py                        289    222    23%   61, 75, 101-107, 128-135, 156-161, 182-198, 221-239, 266-284, 308-326, 350-368, 392-410, 434-452, 480-501, 524-538, 561-575, 601-616, 639-651, 675-742, 763-769, 794-812, 838-844, 872-878, 901-913, 939-943, 966-972, 995-1002, 1025-1029, 1050-1091
chatter/cli.py                                  1203   1026    15%   34-58, 128-129, 183-246, 286-299, 323-357, 371-461, 474-495, 512-571, 589-606, 630-649, 670-675, 685-694, 702-728, 741-769, 785-834, 840-879, 894-986, 1011-1099, 1120-1229, 1242-1276, 1316-1539, 1545-1559, 1590-1656, 1665-1737, 1770-1828, 1840-1864, 1883-1937, 1954-2029, 2043-2072, 2089-2159, 2181-2244, 2262-2318, 2327-2368, 2383-2428, 2442-2471, 2496-2551, 2558-2586, 2592-2605, 2617-2679, 2690-2729, 2736-2777, 2781
chatter/config.py                                188     15    92%   531, 537-547, 558, 569, 606, 611-613, 645, 659-661
chatter/core/__init__.py                          17      8    53%   6-7, 11-12, 16-17, 21-22
chatter/core/agents.py                           320    252    21%   40-46, 71, 80, 88-91, 104-112, 120-125, 149-167, 181-182, 196-217, 230-278, 294-305, 322-377, 381, 397-472, 476-485, 537-578, 590-612, 624-642, 664-681, 693-726, 737-750, 770-777, 800-820, 830-847, 883, 891, 899, 917-938, 949, 962-966, 984-1033, 1048-1055, 1063-1085
chatter/core/analytics.py                        696    646     7%   33, 47-221, 235-446, 460-646, 660-830, 838-906, 922-1300, 1318-1343, 1357-1398, 1414-1444, 1457-1476, 1489-1498, 1510-1533, 1542-1605, 1619-1686, 1694-1731, 1735-1782, 1790-1848, 1856-1905, 1974, 1988-2041, 2059, 2070-2071, 2092-2173, 2186-2222, 2237, 2251-2362, 2378, 2389, 2403, 2418
chatter/core/audit_adapter.py                     99     60    39%   48-55, 59-61, 65-68, 86-121, 136-168, 174-191, 222-249, 261, 279-287, 308-310, 330-334
chatter/core/auth.py                             330    210    36%   46-61, 73-81, 94, 136, 161, 199, 213-217, 247-248, 272-275, 284-309, 349-362, 379-392, 412-465, 481-510, 524-534, 548-557, 634, 642, 675-677, 681, 684-692, 713-741, 745-775, 786-796, 808-855, 873-939
chatter/core/cache_factory.py                    140     41    71%   155-175, 197-199, 208, 220-224, 268, 293-294, 307, 309, 337-338, 381-394, 398-399, 424
chatter/core/cache_interface.py                  105     26    75%   59, 73, 85, 94, 106, 118, 130, 143, 156, 169, 181, 190, 199, 259-272, 284, 295, 301-302
chatter/core/dependencies.py                     171     98    43%   35-37, 48-50, 76-89, 104, 115-119, 125-129, 134, 168-170, 175-177, 182-184, 189-191, 208, 213, 218, 223, 236, 245-247, 255-278, 286-287, 296, 307-313, 324, 332-333, 342-343, 351-355, 363-367, 379-381, 392-394, 402, 417, 435-437, 445-446, 454, 465-467
chatter/core/documents.py                        351    300    15%   49-54, 75-215, 231-266, 280-339, 357-393, 407-450, 464-568, 586-643, 659-697, 708-769, 780-803, 813-834, 853-854, 865-877, 890-903, 911, 922, 935-941, 953, 965-967, 978-987, 1001-1022, 1030, 1038, 1049, 1062-1093, 1104-1105
chatter/core/dynamic_embeddings.py               173    142    18%   12-15, 30-45, 60-80, 101-134, 167-184, 198-206, 216, 222, 230, 239-258, 264-275, 285-330, 338, 344-357, 363-381, 387-431, 437-449, 455-472, 478-495
chatter/core/enhanced_memory_cache.py            224     67    70%   39, 58-59, 69-71, 94-95, 125-128, 140, 148-151, 168-171, 183, 191-192, 205-216, 256-259, 272, 287-288, 296, 318, 322, 338, 342, 348-349, 418-420, 437, 465-468, 483-496, 500-506, 521, 524
chatter/core/enhanced_redis_cache.py             280    240    14%   60-101, 105-111, 119-125, 136-159, 172-195, 206-223, 231-253, 264-275, 286-308, 319-352, 364-389, 401-415, 427-438, 449-467, 475-507, 520-561, 579-581, 589-592
chatter/core/events.py                           134     23    83%   100-101, 123, 132, 137, 142, 162-165, 197-199, 206-208, 215-217, 225-228
chatter/core/exceptions.py                       253    133    47%   48, 59, 115, 131, 144, 156-172, 176-178, 189-195, 207, 215, 218, 225, 246-252, 266-281, 300, 307, 319, 324-331, 345-351, 360, 373-377, 382, 385, 392, 401-402, 411, 420-421, 432-435, 448-451, 458, 465, 468, 471, 483, 491, 494, 508-514, 519, 522, 543-553, 565-572, 587-591, 606-612, 624, 636, 648, 651, 654, 663-667, 670, 673, 682-686, 701-707
chatter/core/langchain.py                         86     64    26%   33-48, 60-73, 82-112, 121-180, 189-215, 221-236, 243
chatter/core/langgraph.py                        300    255    15%   33-36, 72-108, 150-485, 494-511, 520-536, 542-557, 577-620, 638-673, 693-751
chatter/core/model_registry.py                   318    173    46%   39-42, 77-144, 155-158, 174-190, 195-218, 310, 327, 335-341, 356-364, 395-430, 435-446, 450-471, 480-516, 536-537, 541-542, 550-566, 574-583, 589-598, 604-609, 637-664, 671-689, 701-711, 715-719, 724-737, 752, 784-810, 816-825
chatter/core/monitoring.py                       546    300    45%   176-179, 208, 327-335, 348-361, 374-377, 391-395, 419-439, 451-474, 480-506, 530, 535-536, 540, 548-552, 556-569, 573-575, 598-627, 649-680, 691-735, 739-752, 758-777, 781, 785-794, 798-824, 831, 834, 839-843, 847-855, 868-876, 893-897, 910-918, 937-968, 1003-1025, 1030-1031, 1052-1053, 1090-1151, 1156-1186, 1191-1238, 1247-1255, 1260-1268, 1273-1280, 1285-1293, 1298-1306
chatter/core/multi_tier_cache.py                 151    116    23%   81-84, 88, 99-123, 136-158, 169-189, 197-212, 223-231, 243-248, 259-278, 291-303, 315-330, 342-348, 359-368, 376-393, 401-411, 431-451, 464
chatter/core/profiles.py                         223    194    13%   38-39, 56-139, 155-175, 189-261, 276-332, 348-383, 401-498, 520-618, 631-700, 705-707, 717-754
chatter/core/prompts.py                          225    203    10%   31, 48-121, 137-193, 207-270, 285-345, 359-388, 406-532, 543-552, 577-662, 675-749
chatter/core/security_adapter.py                  77     33    57%   42, 53-60, 64-66, 70-73, 184-209, 232-235, 254, 272-276, 294-300
chatter/core/security_compliance.py              188    188     0%   3-601
chatter/core/token_manager.py                    149    108    28%   32-67, 88-89, 107-109, 121-138, 152-153, 158-161, 172-202, 214-260, 277-295, 305-324, 333-349, 360-369, 385-387
chatter/core/unified_events.py                   139     16    88%   43-44, 78-80, 86, 107-108, 148-149, 227, 271-273, 530, 535
chatter/core/unified_model_registry_cache.py     132     73    45%   73-74, 86-87, 98-114, 166-167, 179-180, 191-192, 274-282, 308-316, 333-351, 359-360, 376, 384, 396, 404-420, 428-484, 492-493, 515-517
chatter/core/unified_template_manager.py         195    136    30%   179-190, 203-206, 214-240, 255-299, 315-343, 353-360, 375-384, 396-435, 458-489, 524-560, 572-583, 597-607, 619-631, 639, 647, 655
chatter/core/unified_workflow_cache.py           158     87    45%   134, 149-157, 191, 211-222, 240-241, 249, 261-280, 309-343, 352-400, 412-417, 425-439, 447-453, 461-464
chatter/core/validation/__init__.py               12      3    75%   36, 40, 44
chatter/core/validation/context.py                40      6    85%   50, 63-84
chatter/core/validation/engine.py                134     75    44%   31-32, 36, 77-78, 94, 98, 111, 115, 126-135, 143-152, 160-169, 177-186, 194-207, 217-230, 243-267, 271-283
chatter/core/validation/exceptions.py             38     12    68%   25-27, 67-69, 76-78, 81-82, 86
chatter/core/validation/validators.py            320    146    54%   31, 35, 145, 154-159, 165, 173, 196, 204, 263, 345-350, 366-369, 394, 401, 428, 441-443, 455-464, 468-483, 491-503, 511-519, 535-544, 548-566, 574-585, 593-609, 625-636, 640-652, 659-671, 678-700, 704-718
chatter/core/vector_store.py                     180    126    30%   11-24, 40-44, 65, 76, 87, 92, 99, 114, 121, 130, 140, 154-171, 175-190, 202-230, 242-252, 264-276, 282-286, 292-299, 313-370, 378-393, 401-413, 424-456, 462, 480-497, 503-504, 511
chatter/core/workflow_executors.py               329    220    33%   69, 81, 93, 108, 186-189, 200, 212-216, 239-315, 334-408, 435-489, 511, 522-596, 607-691, 699, 710-789, 800-889, 911, 919
chatter/core/workflow_limits.py                  128     32    75%   114-115, 143, 154, 162, 202-205, 209-219, 225-253, 273-275
chatter/core/workflow_performance.py             137    105    23%   67-81, 89-105, 126-129, 133, 137-142, 146-148, 152-158, 166-169, 175-223, 232-267, 273-311, 317-336
chatter/core/workflow_security.py                155    111    28%   45-51, 55-57, 68-81, 89-103, 115-119, 127-130, 146-156, 171-179, 193-197, 222-228, 232, 279-282, 303-316, 341-353, 377-433, 444-451, 472-486, 511-521, 532-579
chatter/main.py                                  252    167    34%   29-34, 45-159, 165-296, 326-336, 376-377, 440-449, 456-464, 471-483, 490-506, 619-657, 669-670, 678-687, 700-702
chatter/middleware/__init__.py                     0      0   100%
chatter/middleware/auth_security.py               82     52    37%   53-59, 77-99, 104-123, 132-145, 149-158, 163-173, 177, 198
chatter/middleware/security.py                    36     10    72%   70, 76-78, 98-113
chatter/models/__init__.py                         9      0   100%
chatter/models/agent.py                            1      1     0%   4
chatter/models/analytics.py                      112      9    92%   14-18, 184, 292, 394, 495
chatter/models/base.py                            45      4    91%   53, 55, 57, 59
chatter/models/conversation.py                    76      6    92%   27, 176, 180, 341-346, 350
chatter/models/document.py                       113     24    79%   26, 204, 209-210, 215-222, 226, 365-370, 375, 388-395, 403-411, 419
chatter/models/profile.py                         83     21    75%   26-27, 231, 236, 240-261, 265
chatter/models/prompt.py                         153     78    49%   30, 270-273, 277, 291-312, 323-431, 442-446, 450
chatter/models/registry.py                        82      2    98%   194, 286
chatter/models/toolserver.py                     115      0   100%
chatter/models/user.py                            42      7    83%   19-22, 144, 149, 153
chatter/schemas/__init__.py                       13      0   100%
chatter/schemas/ab_testing.py                     94      0   100%
chatter/schemas/agents.py                        190      0   100%
chatter/schemas/analytics.py                     192     22    89%   361-366, 371-381, 464-477, 483-488
chatter/schemas/auth.py                          116      8    93%   119, 217-233, 240-242
chatter/schemas/chat.py                          140      0   100%
chatter/schemas/common.py                         60      2    97%   88, 93
chatter/schemas/data_management.py               129      0   100%
chatter/schemas/document.py                      131      0   100%
chatter/schemas/events.py                        157     11    93%   346-361
chatter/schemas/health.py                         41      0   100%
chatter/schemas/jobs.py                          102      0   100%
chatter/schemas/model_registry.py                142      0   100%
chatter/schemas/plugins.py                       101      0   100%
chatter/schemas/profile.py                       227     56    75%   16, 146-152, 158-167, 173-181, 187-195, 201-209, 215-217, 223-225, 239-241, 479-483
chatter/schemas/prompt.py                        221     73    67%   111-167, 260-304, 506-514
chatter/schemas/toolserver.py                    240      4    98%   83-84, 88, 97
chatter/schemas/utilities.py                      44      0   100%
chatter/services/__init__.py                      42     21    50%   6-7, 11-12, 16-17, 21-22, 29-31, 35-36, 40-41, 45-46, 50-51, 55-56
chatter/services/ab_testing.py                   535    400    25%   198-239, 276-330, 341-362, 373-384, 395-410, 430-477, 502-531, 542-545, 563-577, 591-599, 613-621, 632-666, 681-695, 713-754, 769-770, 778-981, 990-1026, 1050-1083, 1094-1198, 1202, 1208-1219, 1223-1254, 1258-1264, 1268-1269, 1275-1286, 1292-1325, 1350, 1395
chatter/services/chat.py                         117     83    29%   55-61, 71, 80-89, 98, 109, 117, 131-134, 145, 153, 174-281, 298-395, 408-419, 440, 453, 468-477, 483-506
chatter/services/conversation.py                 183    155    15%   40-41, 66-125, 146-160, 182-205, 231-306, 320-344, 364-389, 406-455, 470-515, 526-538, 552-563, 577-588, 602-616, 630-641, 655-662
chatter/services/data_management.py              302    263    13%   52-86, 92-123, 129-159, 163-181, 198-221, 244-248, 267-377, 381-431, 439-479, 489-529, 539-579, 593-664, 669-794, 799-823
chatter/services/document_processing.py          422    364    14%   24-25, 31-32, 59-63, 72-232, 238-287, 292-296, 299-302, 306-336, 339-348, 351-360, 365-374, 380-434, 442-452, 458-464, 468-474, 480-487, 493-500, 506-539, 545-553, 559-577, 583-627, 633-711, 717-746, 757-803, 807-859, 881-896, 910-923, 941-963, 977-994, 1014-1044
chatter/services/dynamic_vector_store.py         240    216    10%   40-49, 61-123, 136-193, 203-227, 244-319, 330-377, 388-438, 457-530, 534-605, 618-628, 632-641
chatter/services/embeddings.py                   237    188    21%   16, 25-27, 33-35, 41-42, 73-102, 106-131, 135-136, 143-144, 152-153, 158-161, 167-240, 247, 263-317, 325-336, 344-350, 363-376, 404-410, 427-477, 500-563, 569-584, 588-595
chatter/services/job_queue.py                    358    289    19%   97, 140-233, 248-284, 295-296, 307, 318-341, 361-380, 392-395, 407-411, 419-432, 449-462, 476-493, 497-507, 515-520, 526-535, 539-549, 555-646, 654-784, 795-851, 861-907, 925-946, 957-974, 988-1036, 1048-1051, 1060-1063, 1074-1079
chatter/services/llm.py                          294    255    13%   25-26, 51-52, 57-60, 66-106, 121-172, 183-191, 198, 217-320, 336-357, 382-474, 483-499, 522-571, 591-632, 640-646, 659-674, 700-701, 714-715, 729-787, 802-819, 849-866, 892-896, 918-926
chatter/services/mcp.py                          337    145    57%   141, 149, 152, 156-158, 162, 168-195, 201-246, 266-272, 316-322, 350-351, 366-367, 374, 390, 395, 400-403, 410-420, 454-480, 549-570, 575, 586, 595-613, 617-667, 678-682, 686-695, 699-717, 722-726, 735, 751-762, 767-769
chatter/services/message.py                      158    140    11%   27, 52-104, 138-200, 216-265, 288-334, 357-404, 421-498, 516-566
chatter/services/plugins.py                      546    456    16%   15-20, 52-53, 62, 71, 80, 88, 101, 118-136, 148-181, 194, 210, 223, 232, 266-269, 288-384, 395-418, 429-515, 526-612, 628-643, 654, 667, 675-689, 703-725, 736-777, 788-832, 843-850, 861-868, 883-931, 943-958, 970-982, 999-1114, 1127-1143, 1151-1165, 1184-1185, 1189-1190, 1194, 1205, 1213-1214, 1218-1219, 1223, 1234, 1239, 1252-1267, 1284
chatter/services/scheduler.py                    123    123     0%   3-247
chatter/services/sse_events.py                   183    118    36%   19-21, 28-35, 39-61, 69-88, 92-93, 115-116, 122-134, 139-177, 183, 187-201, 224-233, 243-248, 256, 308-337, 343, 362, 376, 391, 409, 425, 443, 459, 475, 489, 506, 522, 537, 552
chatter/services/streaming.py                    182    111    39%   46-47, 178-235, 251-364, 386-421, 425, 438-447, 475-505, 513-528, 559-567, 587-607
chatter/services/tool_access.py                  251    216    14%   49, 68-117, 133-160, 171-181, 194-201, 222-245, 258-265, 283-323, 346-360, 368-378, 384-389, 393-396, 402-438, 447-472, 478-492, 496-501, 507-543, 558-580, 593-603, 609-693, 703-782
chatter/services/toolserver.py                   442    396    10%   57-60, 76-150, 163-172, 190-194, 212-232, 249-284, 295-329, 342-375, 386-410, 421-434, 445-472, 483-513, 528-533, 543-548, 591-612, 623-644, 664-732, 747-820, 845-924, 944-1086, 1097-1137, 1145-1218, 1227-1297, 1301-1340, 1348
chatter/services/workflow_execution.py            45     12    73%   124, 132, 160-171, 189-226
chatter/utils/__init__.py                          4      0   100%
chatter/utils/audit_logging.py                   114     45    61%   95, 106-125, 162-214, 238, 271, 306, 340, 365-369, 388-410, 429, 447, 465
chatter/utils/config_validator.py                 33     33     0%   3-65
chatter/utils/configurable_seeding.py            320    283    12%   40-41, 54-56, 60-101, 105-155, 159-208, 212-261, 265-315, 319-372, 376-395, 399-448, 452-498, 502-553, 557-598, 609-610
chatter/utils/correlation.py                      26     13    50%   23, 41, 63-81
chatter/utils/crypto.py                           72      3    96%   76-77, 138
chatter/utils/database.py                        225    169    25%   53-73, 102-176, 203-306, 315-339, 348-355, 362-367, 375-378, 382-384, 388-393, 397-399, 408-410, 414-420, 424, 431-445, 449-458, 471-473, 492-509, 530-536, 545-551
chatter/utils/database_optimization.py           213    180    15%   44-65, 83-93, 111-118, 136-143, 154-182, 193-224, 235-278, 289-317, 328-359, 373-403, 416, 435-474, 494-556, 572-602, 625-647, 667-668
chatter/utils/documentation.py                    77     39    49%   59-168, 173-254, 549-553
chatter/utils/error_recovery.py                  145    145     0%   3-309
chatter/utils/logging.py                          54     21    61%   22-25, 65, 75, 80, 84-86, 113-114, 125-126, 130, 134, 138, 142, 146, 150, 163-164
chatter/utils/performance.py                     144     97    33%   27, 50-82, 103-131, 145-164, 177-207, 241, 245, 257-271, 283, 299-312, 328-340, 354-371, 397, 443-455
chatter/utils/problem.py                         100     47    53%   53, 63-81, 87-88, 125, 160, 180-186, 231-244, 267, 287, 305, 323-327, 358-365, 389-404, 431-446
chatter/utils/prompt_audit.py                     35     35     0%   3-210
chatter/utils/response.py                         29     29     0%   3-106
chatter/utils/security_enhanced.py               278     59    79%   99-101, 139-141, 154, 189, 261-262, 279-280, 282, 288-289, 295-296, 302-303, 323, 357, 397, 422, 461, 473, 479-482, 491, 497-507, 517, 532, 554, 581-597, 602-603, 608, 635-638, 649-652, 656-659, 663-666
chatter/utils/seeding.py                         346    257    26%   57-60, 64-65, 108, 111-116, 137-154, 158-173, 177-193, 197-208, 212-215, 219-253, 257-310, 314-357, 362-373, 377-445, 449-548, 552-605, 609-713, 719, 724, 740-785, 803-859, 866-923, 933-934, 946-986
chatter/utils/template_security.py               107     84    21%   43-58, 78-112, 132-149, 168-186, 199-216, 233-244, 259-311
chatter/utils/unified_rate_limiter.py            229    131    43%   83-93, 99-109, 135-138, 167, 178-192, 202-210, 309-320, 328-334, 340, 367-373, 385-390, 395-405, 410-425, 430-498, 540-588
chatter/utils/versioning.py                      118     56    53%   196-205, 218-247, 264-300, 309-318, 355-356, 375-386, 399, 410, 416
----------------------------------------------------------------------------
TOTAL                                          22800  14205    38%
Coverage HTML written to dir htmlcov
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_complete_lifecycle
FAILED tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_list_and_filter
FAILED tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_update_workflow
FAILED tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_metrics_and_performance
FAILED tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_error_scenarios
FAILED tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_state_validation
FAILED tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_concurrent_operations
FAILED tests/test_ab_testing_integration.py::TestABTestingIntegration::test_ab_test_data_persistence
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_create_ab_test_requires_auth
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_list_ab_tests_requires_auth
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_ab_test_requires_auth
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_update_ab_test_requires_auth
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_delete_ab_test_requires_auth
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_start_ab_test_requires_auth
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_pause_ab_test_requires_auth
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_complete_ab_test_requires_auth
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_results_requires_auth
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_metrics_requires_auth
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_create_ab_test_success
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_create_ab_test_invalid_data
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_create_ab_test_invalid_allocation
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_list_ab_tests_success
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_ab_test_success
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_ab_test_not_found
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_start_ab_test_success
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_start_ab_test_invalid_status
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_delete_running_test_forbidden
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_access_other_user_test_forbidden
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_results_success
FAILED tests/test_ab_testing_unit.py::TestABTestingUnit::test_get_metrics_success
FAILED tests/test_agents_integration.py::TestAgentsIntegration::test_agent_complete_lifecycle
FAILED tests/test_agents_integration.py::TestAgentsIntegration::test_agents_list_and_filter
FAILED tests/test_agents_integration.py::TestAgentsIntegration::test_bulk_agent_operations
FAILED tests/test_agents_integration.py::TestAgentsIntegration::test_agent_testing_functionality
FAILED tests/test_agents_integration.py::TestAgentsIntegration::test_agent_health_monitoring
FAILED tests/test_agents_integration.py::TestAgentsIntegration::test_agent_error_scenarios
FAILED tests/test_agents_integration.py::TestAgentsIntegration::test_agent_data_validation
FAILED tests/test_agents_integration.py::TestAgentsIntegration::test_concurrent_agent_operations
FAILED tests/test_agents_integration.py::TestAgentsIntegration::test_agent_complex_configuration
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_create_agent_requires_auth
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_list_agents_requires_auth
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_templates_requires_auth
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_requires_auth
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_update_agent_requires_auth
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_delete_agent_requires_auth
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_test_agent_requires_auth
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_health_requires_auth
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_bulk_create_agents_requires_auth
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_bulk_delete_agents_requires_auth
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_create_agent_success
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_create_agent_invalid_data
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_list_agents_success - ...
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_templates_success
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_success - At...
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_not_found - ...
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_update_agent_success
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_delete_agent_success
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_test_agent_success - A...
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_get_agent_health_success
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_bulk_create_agents_success
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_bulk_delete_agents_success
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_agent_service_error_handling
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_list_agents_with_filters
FAILED tests/test_agents_unit.py::TestAgentsUnit::test_agent_test_with_invalid_input
FAILED tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_dashboard_workflow
FAILED tests/test_analytics_integration.py::TestAnalyticsIntegration::test_conversation_analytics_workflow
FAILED tests/test_analytics_integration.py::TestAnalyticsIntegration::test_usage_metrics_workflow
FAILED tests/test_analytics_integration.py::TestAnalyticsIntegration::test_performance_metrics_workflow
FAILED tests/test_analytics_integration.py::TestAnalyticsIntegration::test_document_analytics_workflow
FAILED tests/test_analytics_integration.py::TestAnalyticsIntegration::test_system_analytics_workflow
FAILED tests/test_analytics_integration.py::TestAnalyticsIntegration::test_user_analytics_workflow
FAILED tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_export_workflow
FAILED tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_health_check
FAILED tests/test_analytics_integration.py::TestAnalyticsIntegration::test_metrics_summary_workflow
FAILED tests/test_analytics_integration.py::TestAnalyticsIntegration::test_toolserver_analytics_workflow
FAILED tests/test_analytics_integration.py::TestAnalyticsIntegration::test_concurrent_analytics_requests
FAILED tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_data_consistency
FAILED tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_error_handling
FAILED tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_pagination_and_filtering
FAILED tests/test_analytics_integration.py::TestAnalyticsIntegration::test_analytics_response_format_validation
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_conversation_stats_requires_auth
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_usage_metrics_requires_auth
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_performance_metrics_requires_auth
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_document_analytics_requires_auth
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_system_analytics_requires_auth
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_dashboard_requires_auth
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_toolserver_analytics_requires_auth
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_user_analytics_requires_auth
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_export_analytics_requires_auth
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_health_requires_auth
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_metrics_summary_requires_auth
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_conversation_stats_success
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_usage_metrics_success
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_document_analytics_success
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_system_analytics_success
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_dashboard_success
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_user_analytics_success
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_export_analytics_success
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_analytics_service_error_handling
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_metrics_summary_success
FAILED tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_health_success
FAILED tests/test_auth_integration.py::TestAuthIntegration::test_complete_user_registration_and_login_flow
FAILED tests/test_auth_integration.py::TestAuthIntegration::test_login_with_email_workflow
FAILED tests/test_auth_integration.py::TestAuthIntegration::test_token_refresh_workflow
FAILED tests/test_auth_integration.py::TestAuthIntegration::test_profile_update_workflow
FAILED tests/test_auth_integration.py::TestAuthIntegration::test_password_change_workflow
FAILED tests/test_auth_integration.py::TestAuthIntegration::test_api_key_workflow
FAILED tests/test_auth_integration.py::TestAuthIntegration::test_logout_workflow
FAILED tests/test_auth_integration.py::TestAuthIntegration::test_account_deactivation_workflow
FAILED tests/test_auth_integration.py::TestAuthIntegration::test_multiple_users_isolation
FAILED tests/test_auth_integration.py::TestAuthIntegration::test_password_reset_workflow
FAILED tests/test_auth_integration.py::TestAuthDatabaseIntegration::test_user_persistence
FAILED tests/test_auth_integration.py::TestAuthDatabaseIntegration::test_user_uniqueness_constraints
FAILED tests/test_auth_integration.py::TestAuthDatabaseIntegration::test_transaction_rollback_on_error
FAILED tests/test_auth_security_comprehensive.py::TestEnhancedPasswordSecurity::test_password_entropy_calculation
FAILED tests/test_auth_security_comprehensive.py::TestEnhancedPasswordSecurity::test_personal_info_in_password
FAILED tests/test_auth_security_comprehensive.py::TestAuthServiceSecurity::test_user_creation_security_validation
FAILED tests/test_auth_security_comprehensive.py::TestAuthServiceSecurity::test_password_change_security
FAILED tests/test_auth_security_comprehensive.py::TestAuthServiceSecurity::test_secure_api_key_creation
FAILED tests/test_auth_security_comprehensive.py::TestAuthServiceSecurity::test_authentication_security_logging
FAILED tests/test_auth_security_comprehensive.py::TestTokenSecurityIntegration::test_token_creation_security_claims
FAILED tests/test_auth_security_comprehensive.py::TestRateLimitingIntegration::test_login_rate_limiting
FAILED tests/test_auth_security_comprehensive.py::TestRateLimitingIntegration::test_registration_rate_limiting
FAILED tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_complete_secure_registration_flow
FAILED tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_secure_login_with_monitoring
FAILED tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_secure_api_key_management
FAILED tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_secure_password_change_flow
FAILED tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_token_security_features
FAILED tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_password_reset_security_flow
FAILED tests/test_auth_security_integration.py::TestCompleteAuthSecurityIntegration::test_comprehensive_security_validation
FAILED tests/test_auth_security_integration.py::TestSecurityPerformanceIntegration::test_auth_endpoint_performance
FAILED tests/test_auth_security_integration.py::TestSecurityPerformanceIntegration::test_multiple_concurrent_requests
FAILED tests/test_auth_unit.py::TestAuthUnitTests::test_user_registration - R...
FAILED tests/test_auth_unit.py::TestAuthUnitTests::test_user_registration_duplicate_username
FAILED tests/test_auth_unit.py::TestAuthUnitTests::test_user_registration_duplicate_email
FAILED tests/test_auth_unit.py::TestAuthUnitTests::test_user_login_success - ...
FAILED tests/test_auth_unit.py::TestAuthUnitTests::test_user_login_with_email
FAILED tests/test_auth_unit.py::TestAuthUnitTests::test_user_login_invalid_credentials
FAILED tests/test_auth_unit.py::TestAuthUnitTests::test_user_login_nonexistent_user
FAILED tests/test_auth_unit.py::TestAuthUnitTests::test_get_current_user - Ru...
FAILED tests/test_auth_unit.py::TestAuthUnitTests::test_get_current_user_without_auth
FAILED tests/test_auth_unit.py::TestAuthUnitTests::test_token_refresh - Runti...
FAILED tests/test_auth_unit.py::TestAuthUnitTests::test_update_profile - Runt...
FAILED tests/test_auth_unit.py::TestAuthUnitTests::test_update_profile_without_auth
FAILED tests/test_auth_unit.py::TestAuthUnitTests::test_change_password - Run...
FAILED tests/test_auth_unit.py::TestAuthUnitTests::test_change_password_wrong_current
FAILED tests/test_auth_unit.py::TestAuthUnitTests::test_logout - RuntimeError...
FAILED tests/test_auth_unit.py::TestAuthServiceUnit::test_authenticate_user
FAILED tests/test_auth_unit.py::TestAuthServiceUnit::test_authenticate_user_wrong_password
FAILED tests/test_cli.py::TestCLICommands::test_health_command - assert 2 == 0
FAILED tests/test_cli.py::TestHealthCheck::test_health_check_success - Runtim...
FAILED tests/test_cli.py::TestHealthCheck::test_health_check_failure - Runtim...
FAILED tests/test_cli.py::TestDatabaseCommands::test_db_init_success - Runtim...
FAILED tests/test_cli.py::TestDatabaseCommands::test_db_init_connection_failure
FAILED tests/test_cli.py::TestDatabaseCommands::test_db_init_init_failure - R...
FAILED tests/test_cli.py::TestInteractivePromptCreation::test_interactive_prompt_creation
FAILED tests/test_cli.py::TestCLIIntegration::test_full_prompt_lifecycle - as...
FAILED tests/test_cli.py::TestCLIErrorScenarios::test_api_unavailable_scenarios
FAILED tests/test_crypto_utils.py::TestSecretManager::test_encrypt_with_different_managers_incompatible
FAILED tests/test_data_management_integration.py::TestDataManagementIntegration::test_export_data_workflow
FAILED tests/test_data_management_integration.py::TestDataManagementIntegration::test_backup_workflow
FAILED tests/test_data_management_integration.py::TestDataManagementIntegration::test_storage_stats_workflow
FAILED tests/test_data_management_integration.py::TestDataManagementIntegration::test_bulk_delete_documents_workflow
FAILED tests/test_data_management_integration.py::TestDataManagementIntegration::test_bulk_delete_conversations_workflow
FAILED tests/test_data_management_integration.py::TestDataManagementIntegration::test_bulk_delete_prompts_workflow
FAILED tests/test_data_management_integration.py::TestDataManagementIntegration::test_data_management_permission_workflow
FAILED tests/test_data_management_integration.py::TestDataManagementIntegration::test_cross_api_data_consistency
FAILED tests/test_data_management_unit.py::TestDataManagementUnit::test_export_data_endpoint_exists
FAILED tests/test_data_management_unit.py::TestDataManagementUnit::test_create_backup_endpoint_exists
FAILED tests/test_data_management_unit.py::TestDataManagementUnit::test_list_backups_endpoint_exists
FAILED tests/test_data_management_unit.py::TestDataManagementUnit::test_restore_data_endpoint_exists
FAILED tests/test_data_management_unit.py::TestDataManagementUnit::test_get_storage_stats_endpoint_exists
FAILED tests/test_data_management_unit.py::TestDataManagementUnit::test_bulk_delete_documents_endpoint_exists
FAILED tests/test_data_management_unit.py::TestDataManagementUnit::test_bulk_delete_conversations_endpoint_exists
FAILED tests/test_data_management_unit.py::TestDataManagementUnit::test_bulk_delete_prompts_endpoint_exists
FAILED tests/test_documents_integration.py::TestDocumentsIntegration::test_document_upload_workflow
FAILED tests/test_documents_integration.py::TestDocumentsIntegration::test_document_list_and_search_workflow
FAILED tests/test_documents_integration.py::TestDocumentsIntegration::test_document_crud_workflow
FAILED tests/test_documents_integration.py::TestDocumentsIntegration::test_document_chunks_workflow
FAILED tests/test_documents_integration.py::TestDocumentsIntegration::test_document_processing_workflow
FAILED tests/test_documents_integration.py::TestDocumentsIntegration::test_document_stats_workflow
FAILED tests/test_documents_integration.py::TestDocumentsIntegration::test_document_download_workflow
FAILED tests/test_documents_integration.py::TestDocumentsIntegration::test_document_permission_workflow
FAILED tests/test_documents_unit.py::TestDocumentsUnit::test_upload_document_endpoint_exists
FAILED tests/test_documents_unit.py::TestDocumentsUnit::test_list_documents_endpoint_exists
FAILED tests/test_documents_unit.py::TestDocumentsUnit::test_search_documents_endpoint_exists
FAILED tests/test_documents_unit.py::TestDocumentsUnit::test_get_document_endpoint_exists
FAILED tests/test_documents_unit.py::TestDocumentsUnit::test_delete_document_endpoint_exists
FAILED tests/test_documents_unit.py::TestDocumentsUnit::test_update_document_endpoint_exists
FAILED tests/test_documents_unit.py::TestDocumentsUnit::test_get_document_chunks_endpoint_exists
FAILED tests/test_documents_unit.py::TestDocumentsUnit::test_process_document_endpoint_exists
FAILED tests/test_documents_unit.py::TestDocumentsUnit::test_get_document_stats_endpoint_exists
FAILED tests/test_documents_unit.py::TestDocumentsUnit::test_download_document_endpoint_exists
FAILED tests/test_events_integration.py::TestEventsIntegration::test_events_stream_workflow
FAILED tests/test_events_integration.py::TestEventsIntegration::test_events_stats_real_service
FAILED tests/test_events_integration.py::TestEventsIntegration::test_test_event_end_to_end
FAILED tests/test_events_integration.py::TestEventsIntegration::test_broadcast_test_end_to_end
FAILED tests/test_events_integration.py::TestEventsIntegration::test_multiple_sse_connections
FAILED tests/test_events_integration.py::TestEventsIntegration::test_events_workflow_with_database
FAILED tests/test_events_integration.py::TestEventsIntegration::test_event_validation_integration
FAILED tests/test_events_integration.py::TestEventsIntegration::test_event_data_serialization
FAILED tests/test_events_integration.py::TestEventsIntegration::test_concurrent_event_operations
FAILED tests/test_events_integration.py::TestEventsIntegration::test_sse_connection_cleanup
FAILED tests/test_events_unit.py::TestEventsUnit::test_events_stream_requires_auth
FAILED tests/test_events_unit.py::TestEventsUnit::test_admin_stream_requires_auth
FAILED tests/test_events_unit.py::TestEventsUnit::test_events_stats_requires_auth
FAILED tests/test_events_unit.py::TestEventsUnit::test_test_event_requires_auth
FAILED tests/test_events_unit.py::TestEventsUnit::test_broadcast_test_requires_auth
FAILED tests/test_events_unit.py::TestEventsUnit::test_events_stats_success
FAILED tests/test_events_unit.py::TestEventsUnit::test_test_event_success - R...
FAILED tests/test_events_unit.py::TestEventsUnit::test_broadcast_test_success
FAILED tests/test_events_unit.py::TestEventsUnit::test_test_event_invalid_data
FAILED tests/test_events_unit.py::TestEventsUnit::test_broadcast_test_invalid_data
FAILED tests/test_events_unit.py::TestEventsUnit::test_events_stream_rate_limit
FAILED tests/test_events_unit.py::TestEventsUnit::test_events_stream_connection_limit
FAILED tests/test_events_unit.py::TestEventsUnit::test_events_stream_connection_not_found
FAILED tests/test_events_unit.py::TestEventsUnit::test_admin_stream_requires_admin
FAILED tests/test_events_unit.py::TestEventsUnit::test_events_stats_sse_service_error
FAILED tests/test_events_unit.py::TestEventsUnit::test_test_event_sse_service_error
FAILED tests/test_events_unit.py::TestEventsUnit::test_broadcast_test_sse_service_error
FAILED tests/test_health_integration.py::TestHealthIntegration::test_readiness_check_with_database
FAILED tests/test_health_unit.py::TestHealthUnit::test_metrics_endpoint_with_monitoring_success
FAILED tests/test_health_unit.py::TestHealthUnit::test_correlation_trace_with_monitoring_success
FAILED tests/test_health_unit.py::TestHealthUnit::test_correlation_trace_with_monitoring_error
FAILED tests/test_jobs_integration.py::TestJobsIntegration::test_job_complete_lifecycle
FAILED tests/test_jobs_integration.py::TestJobsIntegration::test_job_listing_and_filtering
FAILED tests/test_jobs_integration.py::TestJobsIntegration::test_job_cancellation_workflow
FAILED tests/test_jobs_integration.py::TestJobsIntegration::test_job_error_scenarios
FAILED tests/test_jobs_integration.py::TestJobsIntegration::test_job_validation_scenarios
FAILED tests/test_jobs_integration.py::TestJobsIntegration::test_job_stats_accuracy
FAILED tests/test_jobs_integration.py::TestJobsIntegration::test_job_cleanup_functionality
FAILED tests/test_jobs_integration.py::TestJobsIntegration::test_concurrent_job_operations
FAILED tests/test_jobs_integration.py::TestJobsIntegration::test_job_data_persistence
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_create_job_requires_auth
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_list_jobs_requires_auth - ...
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_get_job_requires_auth - ch...
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_cancel_job_requires_auth
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_get_job_stats_requires_auth
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_cleanup_jobs_requires_auth
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_create_job_success - Runti...
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_create_job_invalid_function
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_create_job_invalid_data - ...
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_list_jobs_success - Runtim...
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_list_jobs_with_filters - R...
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_get_job_success - RuntimeE...
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_get_job_not_found - Runtim...
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_get_job_invalid_id_format
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_cancel_job_success - Runti...
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_cancel_job_not_found - Run...
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_cancel_job_invalid_id_format
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_get_job_stats_success - Ru...
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_cleanup_jobs_success - Run...
FAILED tests/test_jobs_unit.py::TestJobsUnit::test_list_jobs_pagination - Run...
FAILED tests/test_mcp_service.py::TestMCPToolService::test_add_server_success
FAILED tests/test_mcp_service.py::TestMCPToolService::test_add_server_disabled_service
FAILED tests/test_mcp_service.py::TestMCPToolService::test_add_server_validation_error
FAILED tests/test_mcp_service.py::TestMCPToolService::test_call_tool_success
FAILED tests/test_mcp_service.py::TestMCPToolService::test_call_tool_disabled_service
FAILED tests/test_mcp_service.py::TestMCPToolService::test_list_servers - Att...
FAILED tests/test_mcp_service.py::TestMCPToolService::test_get_server_info - ...
FAILED tests/test_mcp_service.py::TestMCPToolService::test_get_server_info_nonexistent
FAILED tests/test_mcp_service.py::TestMCPServiceIntegration::test_server_lifecycle
FAILED tests/test_mcp_service.py::TestMCPServiceIntegration::test_multiple_servers_management
FAILED tests/test_mcp_service.py::TestMCPServiceIntegration::test_error_recovery_scenarios
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_security_headers_added
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_content_security_policy_header
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_x_frame_options_header
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_x_content_type_options_header
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_x_xss_protection_header
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_referrer_policy_header
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_permissions_policy_header
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_strict_transport_security_enabled
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_strict_transport_security_disabled
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_security_headers_on_different_response_types
FAILED tests/test_middleware.py::TestSecurityHeadersMiddleware::test_security_headers_dont_override_existing
FAILED tests/test_middleware.py::TestAuthRateLimitMiddleware::test_login_endpoint_rate_limiting
FAILED tests/test_middleware.py::TestAuthRateLimitMiddleware::test_register_endpoint_rate_limiting
FAILED tests/test_middleware.py::TestAuthRateLimitMiddleware::test_password_reset_endpoint_rate_limiting
FAILED tests/test_middleware.py::TestAuthRateLimitMiddleware::test_client_ip_identification
FAILED tests/test_middleware.py::TestAuthRateLimitMiddleware::test_rate_limit_with_user_agent_tracking
FAILED tests/test_middleware.py::TestMiddlewareIntegration::test_both_middleware_applied
FAILED tests/test_middleware.py::TestMiddlewareIntegration::test_security_headers_on_rate_limited_response
FAILED tests/test_middleware.py::TestMiddlewareIntegration::test_non_auth_endpoints_only_security_headers
FAILED tests/test_middleware.py::TestMiddlewareIntegration::test_middleware_order_matters
FAILED tests/test_middleware.py::TestMiddlewareIntegration::test_middleware_performance
FAILED tests/test_middleware.py::TestMiddlewareEdgeCases::test_empty_app_with_middleware
FAILED tests/test_model_registry_fixes.py::TestDefaultProviderLogic::test_get_default_provider_by_model_type
FAILED tests/test_model_registry_fixes.py::TestBusinessLogicImprovements::test_multiple_providers_different_model_types
FAILED tests/test_model_registry_fixes.py::TestTransactionManagement::test_create_model_transaction_rollback_on_error
FAILED tests/test_plugins.py::TestBasePlugin::test_base_plugin_initialization
FAILED tests/test_plugins.py::TestBasePlugin::test_base_plugin_default_config
FAILED tests/test_plugins.py::TestBasePlugin::test_base_plugin_get_configuration_schema
FAILED tests/test_plugins.py::TestBasePlugin::test_validate_configuration_no_schema
FAILED tests/test_plugins.py::TestBasePlugin::test_validate_configuration_with_schema
FAILED tests/test_plugins.py::TestBasePlugin::test_validate_configuration_type_checking
FAILED tests/test_plugins.py::TestBasePlugin::test_validate_configuration_error_handling
FAILED tests/test_plugins.py::TestToolPlugin::test_tool_plugin_inheritance - ...
FAILED tests/test_plugins.py::TestToolPlugin::test_get_tools_implementation
FAILED tests/test_plugins.py::TestWorkflowPlugin::test_workflow_plugin_inheritance
FAILED tests/test_plugins.py::TestPluginManager::test_plugin_manager_initialization
FAILED tests/test_plugins.py::TestPluginManager::test_get_plugin_directory_default
FAILED tests/test_plugins.py::TestPluginManager::test_get_plugin_directory_custom
FAILED tests/test_plugins.py::TestPluginManager::test_load_plugin_from_file_success
FAILED tests/test_plugins.py::TestPluginManager::test_load_plugin_from_file_missing_file
FAILED tests/test_plugins.py::TestPluginManager::test_load_plugin_from_file_syntax_error
FAILED tests/test_plugins.py::TestPluginManager::test_unload_plugin_success
FAILED tests/test_plugins.py::TestPluginManager::test_unload_plugin_not_found
FAILED tests/test_plugins.py::TestPluginManager::test_unload_plugin_cleanup_error
FAILED tests/test_plugins.py::TestPluginManager::test_list_plugins - pydantic...
FAILED tests/test_plugins.py::TestPluginManager::test_list_plugins_by_type - ...
FAILED tests/test_plugins.py::TestPluginManager::test_list_plugins_by_status
FAILED tests/test_plugins.py::TestPluginManager::test_get_plugin_info_found
FAILED tests/test_plugins.py::TestPluginManager::test_get_plugin_info_not_found
FAILED tests/test_plugins.py::TestPluginManager::test_get_tools_from_plugins
FAILED tests/test_plugins.py::TestPluginManager::test_get_tools_from_plugins_inactive_ignored
FAILED tests/test_plugins.py::TestPluginManager::test_health_check_all_plugins
FAILED tests/test_plugins.py::TestPluginManager::test_health_check_plugin_error
FAILED tests/test_plugins.py::TestPluginIntegration::test_plugin_lifecycle - ...
FAILED tests/test_plugins.py::TestPluginIntegration::test_multiple_plugins_management
FAILED tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_complete_lifecycle
FAILED tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_list_and_filter
FAILED tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_stats_and_providers
FAILED tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_error_scenarios
FAILED tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_data_validation
FAILED tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_concurrent_operations
FAILED tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_complex_data_handling
FAILED tests/test_profiles_integration.py::TestProfilesIntegration::test_profile_testing_functionality
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_create_profile_requires_auth
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_list_profiles_requires_auth
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_get_profile_requires_auth
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_update_profile_requires_auth
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_delete_profile_requires_auth
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_test_profile_requires_auth
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_clone_profile_requires_auth
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_get_profile_stats_requires_auth
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_get_available_providers_requires_auth
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_create_profile_success
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_create_profile_invalid_data
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_create_profile_rate_limit
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_list_profiles_success
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_get_profile_success
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_get_profile_not_found
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_update_profile_success
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_delete_profile_success
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_test_profile_success
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_clone_profile_success
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_get_profile_stats_success
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_get_available_providers_success
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_profile_service_error_handling
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_profile_validation_errors
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_list_profiles_filtering
FAILED tests/test_profiles_unit.py::TestProfilesUnit::test_test_profile_rate_limit
FAILED tests/test_streaming.py::TestStreamingEvent::test_streaming_event_data_creation
FAILED tests/test_streaming.py::TestStreamingEvent::test_streaming_event_data_minimal
FAILED tests/test_streaming.py::TestStreamingEvent::test_streaming_event_data_auto_timestamp
FAILED tests/test_streaming.py::TestStreamingEvent::test_streaming_event_data_with_metadata
FAILED tests/test_streaming.py::TestStreamingService::test_end_stream - Attri...
FAILED tests/test_streaming.py::TestStreamingService::test_stream_event_basic
FAILED tests/test_streaming.py::TestStreamingService::test_stream_token - Att...
FAILED tests/test_streaming.py::TestStreamingService::test_stream_tool_call_lifecycle
FAILED tests/test_streaming.py::TestStreamingService::test_stream_thinking - ...
FAILED tests/test_streaming.py::TestStreamingService::test_stream_source_found
FAILED tests/test_streaming.py::TestStreamingService::test_stream_error - Att...
FAILED tests/test_streaming.py::TestStreamingService::test_stream_complete - ...
FAILED tests/test_streaming.py::TestStreamingService::test_stream_metadata - ...
FAILED tests/test_streaming.py::TestStreamingService::test_get_stream_metrics
FAILED tests/test_streaming.py::TestStreamingService::test_get_nonexistent_stream_metrics
FAILED tests/test_streaming.py::TestStreamingService::test_list_active_streams
FAILED tests/test_streaming.py::TestStreamingService::test_is_stream_active
FAILED tests/test_streaming.py::TestStreamingService::test_stream_activity_tracking
FAILED tests/test_streaming.py::TestStreamingService::test_stream_error_handling_invalid_stream
FAILED tests/test_streaming.py::TestStreamingService::test_concurrent_streams
FAILED tests/test_streaming.py::TestStreamingService::test_stream_cleanup_on_error
FAILED tests/test_streaming.py::TestStreamingServiceIntegration::test_complete_streaming_workflow
FAILED tests/test_streaming.py::TestStreamingServiceIntegration::test_error_recovery_workflow
FAILED tests/test_streaming.py::TestStreamingServiceIntegration::test_performance_with_high_volume_streaming
FAILED tests/test_streaming.py::TestStreamingServiceIntegration::test_stream_isolation
FAILED tests/test_versioning.py::TestAPIVersion::test_api_version_string_representation
FAILED tests/test_versioning.py::TestVersionStatus::test_version_status_values
FAILED tests/test_versioning.py::TestVersionStatus::test_version_status_progression
FAILED tests/test_versioning.py::TestEndpointVersioning::test_endpoint_versioning_creation
FAILED tests/test_versioning.py::TestEndpointVersioning::test_endpoint_versioning_lifecycle
FAILED tests/test_versioning.py::TestAPIVersionManager::test_default_versions_loaded
FAILED tests/test_versioning.py::TestAPIVersionManager::test_is_endpoint_available_unregistered
FAILED tests/test_versioning.py::TestAPIVersionManager::test_deprecate_endpoint
FAILED tests/test_versioning.py::TestAPIVersionManager::test_deprecate_nonexistent_endpoint
FAILED tests/test_versioning.py::TestAPIVersionManager::test_get_endpoint_info
FAILED tests/test_versioning.py::TestAPIVersionManager::test_get_endpoint_info_nonexistent
FAILED tests/test_versioning.py::TestAPIVersionManager::test_get_endpoints_for_version
FAILED tests/test_versioning.py::TestAPIVersionManager::test_version_middleware_integration
FAILED tests/test_versioning.py::TestVersioningIntegration::test_complete_version_lifecycle
FAILED tests/test_versioning.py::TestVersioningIntegration::test_version_migration_scenario
FAILED tests/test_versioning.py::TestVersioningIntegration::test_backwards_compatibility_checking
FAILED tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_execute_workflow_with_limits
FAILED tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_execute_workflow_timeout
FAILED tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_concurrent_workflow_limit
FAILED tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_streaming_workflow_with_limits
FAILED tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_streaming_workflow_timeout
FAILED tests/test_workflow_limits_and_streaming.py::TestWorkflowExecutionService::test_enhanced_token_streaming_all_workflows
ERROR tests/e2e/test_auth_e2e.py::TestAuthE2E::test_complete_registration_workflow
ERROR tests/e2e/test_auth_e2e.py::TestAuthE2E::test_complete_login_workflow
ERROR tests/e2e/test_auth_e2e.py::TestAuthE2E::test_profile_access_workflow
ERROR tests/e2e/test_auth_e2e.py::TestAuthE2E::test_registration_login_profile_complete_flow
ERROR tests/e2e/test_auth_e2e.py::TestAuthE2E::test_invalid_credentials_workflow
ERROR tests/e2e/test_chat_e2e.py::TestChatE2E::test_complete_chat_conversation_workflow
ERROR tests/e2e/test_chat_e2e.py::TestChatE2E::test_chat_list_and_retrieval_workflow
ERROR tests/e2e/test_chat_e2e.py::TestChatE2E::test_chat_message_streaming_workflow
ERROR tests/e2e/test_chat_e2e.py::TestChatE2E::test_chat_deletion_workflow - ...
ERROR tests/e2e/test_chat_e2e.py::TestChatE2E::test_multi_user_chat_isolation
ERROR tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_complete_document_upload_workflow
ERROR tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_document_list_and_search_workflow
ERROR tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_document_processing_status_workflow
ERROR tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_document_chat_integration_workflow
ERROR tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_document_deletion_workflow
ERROR tests/e2e/test_documents_e2e.py::TestDocumentsE2E::test_large_document_upload_workflow
ERROR tests/test_agents_integration.py::TestAgentsIntegration::test_agent_templates_workflow
ERROR tests/test_analytics_unit.py::TestAnalyticsUnit::test_get_performance_metrics_success
ERROR tests/test_analytics_unit.py::TestAnalyticsUnit::test_invalid_user_id_format
ERROR tests/test_contract_testing.py::TestContractTesting::test_error_response_consistency
ERROR tests/test_database_testing.py::TestDatabaseTesting::test_connection_pooling_behavior
ERROR tests/test_integration_workflows.py::TestIntegrationWorkflows::test_external_service_integration
ERROR tests/test_jobs_unit.py::TestJobsUnit::test_job_queue_error_handling - ...
====== 399 failed, 328 passed, 28 skipped, 23 errors in 327.69s (0:05:27) ======
